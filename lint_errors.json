[{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\_actions\\admin-verification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\_actions\\upload-proof.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\_actions\\verification.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'verificationSchema' is assigned a value but never used.","line":8,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { z } from \"zod\";\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { uploadListingProof } from \"./upload-proof\";\n\nconst verificationSchema = z.object({\n  propertyId: z.string().min(1, \"ID du bien requis\"),\n  proofDocumentUrl: z.string().min(1, \"URL du document requise\"),\n});\n\nexport type VerificationSubmitResult = {\n  success: boolean;\n  error?: string;\n  data?: {\n    propertyId: string;\n    verificationStatus: string;\n  };\n};\n\n/**\n * Soumet une demande de vérification pour un bien immobilier\n * @param propertyId - ID du bien à vérifier\n * @param proofFile - Fichier de preuve (document PDF, image, etc.)\n */\nexport async function submitListingVerification(\n  propertyId: string,\n  proofFile: File\n): Promise<VerificationSubmitResult> {\n  try {\n    const supabase = await createClient();\n\n    // Vérifier que l'utilisateur est connecté\n    const {\n      data: { user },\n      error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return {\n        success: false,\n        error: \"Vous devez être connecté pour soumettre une vérification.\",\n      };\n    }\n\n    // Vérifier que le bien appartient à l'utilisateur (ownership)\n    const { data: property, error: propertyError } = await supabase\n      .from(\"properties\")\n      .select(\"owner_id\")\n      .eq(\"id\", propertyId)\n      .single();\n\n    if (propertyError || !property) {\n      return {\n        success: false,\n        error: \"Bien introuvable.\",\n      };\n    }\n\n    if (property.owner_id !== user.id) {\n      return {\n        success: false,\n        error: \"Vous n'êtes pas propriétaire de ce bien.\",\n      };\n    }\n\n    // Upload du document de preuve\n    const formData = new FormData();\n    formData.append(\"proof\", proofFile);\n    const uploadResult = await uploadListingProof(formData);\n\n    if (!uploadResult.success || !uploadResult.data?.url) {\n      return {\n        success: false,\n        error: uploadResult.error || \"Échec de l'upload du document.\",\n      };\n    }\n\n    // Mettre à jour le bien avec le statut de vérification et l'URL du document\n    const { error: updateError } = await supabase\n      .from(\"properties\")\n      .update({\n        verification_status: \"pending\",\n        proof_document_url: uploadResult.data.url,\n        verification_requested_at: new Date().toISOString(),\n      })\n      .eq(\"id\", propertyId);\n\n    if (updateError) {\n      console.error(\"❌ Error updating property verification:\", updateError);\n      return {\n        success: false,\n        error: \"Erreur lors de la mise à jour du bien.\",\n      };\n    }\n\n    // Revalidation des chemins\n    revalidatePath(`/compte/biens/${propertyId}`);\n    revalidatePath(\"/admin\");\n\n    return {\n      success: true,\n      data: {\n        propertyId,\n        verificationStatus: \"pending\",\n      },\n    };\n  } catch (error) {\n    console.error(\"❌ Error in submitListingVerification:\", error);\n    return {\n      success: false,\n      error: \"Une erreur inattendue s'est produite.\",\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\a-propos\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\actions\\check-hibp-server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\actions\\check-hibp.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\actions\\reminders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'monthKey' is assigned a value but never used.","line":298,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":298,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport { requireAnyRole } from \"@/lib/permissions\";\n\nexport type DashboardStats = {\n  propertiesApproved: number;\n  propertiesPending: number;\n  leadsLast30Days: number;\n  totalUsers: number;\n};\n\nexport type RecentActivity = {\n  id: string;\n  type: \"property\" | \"lead\" | \"user\";\n  message: string;\n  date: Date;\n};\n\nexport type RecentProperty = {\n  id: string;\n  title: string;\n  price: number;\n  status: string;\n  image: string | null;\n  createdAt: Date;\n  validationStatus: string;\n};\n\nexport type ChartDataPoint = {\n  month: string;\n  visites: number;\n  leads: number;\n};\n\nexport async function getDashboardStats(): Promise<DashboardStats> {\n  await requireAnyRole();\n  const supabase = await createClient();\n\n  try {\n    // Biens approuvés\n    const { count: approvedCount } = await supabase\n      .from(\"properties\")\n      .select(\"*\", { count: \"exact\", head: true })\n      .eq(\"validation_status\", \"approved\");\n\n    // Biens en attente\n    const { count: pendingCount } = await supabase\n      .from(\"properties\")\n      .select(\"*\", { count: \"exact\", head: true })\n      .eq(\"validation_status\", \"pending\");\n\n    // Leads des 30 derniers jours\n    const thirtyDaysAgo = new Date();\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n    const { count: leadsCount } = await supabase\n      .from(\"visit_requests\")\n      .select(\"*\", { count: \"exact\", head: true })\n      .gte(\"created_at\", thirtyDaysAgo.toISOString());\n\n    // Total utilisateurs - Utiliser la fonction RPC si disponible, sinon fallback\n    let usersCount = 0;\n    try {\n      // Méthode 1: Essayer d'utiliser la fonction RPC get_total_users (recommandé)\n      const { data: rpcCount, error: rpcError } = await supabase.rpc(\"get_total_users\");\n\n      if (!rpcError && typeof rpcCount === \"number\") {\n        usersCount = rpcCount;\n      } else {\n        // Méthode 2: Compter depuis la table users si elle existe\n        const { count: usersTableCount, error: usersTableError } = await supabase\n          .from(\"users\")\n          .select(\"*\", { count: \"exact\", head: true });\n\n        if (!usersTableError && usersTableCount !== null) {\n          usersCount = usersTableCount;\n        } else {\n          // Méthode 3: Compter les utilisateurs uniques qui ont créé des propriétés ou des leads\n          // Récupérer tous les user_id distincts depuis properties\n          const { data: propertyUsers } = await supabase\n            .from(\"properties\")\n            .select(\"user_id\");\n\n          // Récupérer tous les user_id distincts depuis user_roles\n          const { data: roleUsers } = await supabase\n            .from(\"user_roles\")\n            .select(\"user_id\");\n\n          // Combiner tous les user_id et compter les uniques\n          const allUserIds = new Set<string>();\n          \n          if (propertyUsers) {\n            propertyUsers.forEach((p: { user_id?: string }) => {\n              if (p.user_id) allUserIds.add(p.user_id);\n            });\n          }\n\n          if (roleUsers) {\n            roleUsers.forEach((r: { user_id?: string }) => {\n              if (r.user_id) allUserIds.add(r.user_id);\n            });\n          }\n\n          usersCount = allUserIds.size;\n        }\n      }\n    } catch (error) {\n      console.error(\"Error counting users:\", error);\n      // Fallback: Compter uniquement depuis user_roles\n      try {\n        const { data: userRoles } = await supabase\n          .from(\"user_roles\")\n          .select(\"user_id\");\n        \n        if (userRoles) {\n          const uniqueUserIds = new Set(userRoles.map((ur: { user_id: string }) => ur.user_id));\n          usersCount = uniqueUserIds.size;\n        }\n      } catch (fallbackError) {\n        console.error(\"Error in fallback user count:\", fallbackError);\n        usersCount = 0;\n      }\n    }\n\n    return {\n      propertiesApproved: approvedCount ?? 0,\n      propertiesPending: pendingCount ?? 0,\n      leadsLast30Days: leadsCount ?? 0,\n      totalUsers: usersCount,\n    };\n  } catch (error) {\n    console.error(\"Error fetching dashboard stats:\", error);\n    return {\n      propertiesApproved: 0,\n      propertiesPending: 0,\n      leadsLast30Days: 0,\n      totalUsers: 0,\n    };\n  }\n}\n\nexport async function getRecentProperties(limit: number = 5) {\n  await requireAnyRole();\n  const supabase = await createClient();\n\n  try {\n    const { data, error } = await supabase\n      .from(\"properties\")\n      .select(\"id, title, price, status, images, created_at, validation_status\")\n      .order(\"created_at\", { ascending: false })\n      .limit(limit);\n\n    if (error) {\n      console.error(\"❌ Error in getRecentProperties:\", {\n        message: error.message,\n        code: error.code,\n        details: error.details,\n        hint: error.hint,\n        fullError: JSON.stringify(error, null, 2)\n      });\n      throw error;\n    }\n\n    return (\n      data?.map((p) => ({\n        id: p.id,\n        title: p.title,\n        price: p.price,\n        status: p.status ?? \"disponible\",\n        image: Array.isArray(p.images) && p.images.length > 0 ? p.images[0] : null,\n        createdAt: new Date(p.created_at),\n        validationStatus: p.validation_status,\n      })) ?? []\n    );\n  } catch (error) {\n    console.error(\"❌ Unexpected error in getRecentProperties:\", {\n      error,\n      message: error instanceof Error ? error.message : String(error),\n      code: (error as { code?: string })?.code,\n      details: (error as { details?: string })?.details,\n      hint: (error as { hint?: string })?.hint,\n      fullError: error ? JSON.stringify(error, null, 2) : null\n    });\n    return [];\n  }\n}\n\nexport async function getRecentActivity(limit: number = 5): Promise<RecentActivity[]> {\n  await requireAnyRole();\n  const supabase = await createClient();\n\n  try {\n    const activities: RecentActivity[] = [];\n\n    // Récupérer les biens récents\n    const { data: recentProperties } = await supabase\n      .from(\"properties\")\n      .select(\"id, title, created_at, validation_status\")\n      .order(\"created_at\", { ascending: false })\n      .limit(3);\n\n    if (recentProperties) {\n      recentProperties.forEach((p) => {\n        activities.push({\n          id: p.id,\n          type: \"property\",\n          message:\n            p.validation_status === \"pending\"\n              ? `Nouveau bien en attente: ${p.title}`\n              : `Bien approuvé: ${p.title}`,\n          date: new Date(p.created_at),\n        });\n      });\n    }\n\n    // Récupérer les leads récents\n    const { data: recentLeads } = await supabase\n      .from(\"visit_requests\")\n      .select(\"id, full_name, created_at\")\n      .order(\"created_at\", { ascending: false })\n      .limit(2);\n\n    if (recentLeads) {\n      recentLeads.forEach((lead) => {\n        activities.push({\n          id: lead.id,\n          type: \"lead\",\n          message: `Nouveau message de ${lead.full_name}`,\n          date: new Date(lead.created_at),\n        });\n      });\n    }\n\n    // Trier par date et limiter\n    return activities\n      .sort((a, b) => b.date.getTime() - a.date.getTime())\n      .slice(0, limit);\n  } catch (error) {\n    console.error(\"Error fetching recent activity:\", error);\n    return [];\n  }\n}\n\n/**\n * Récupère les données pour le graphique (leads par mois sur les 6 derniers mois)\n */\nexport async function getChartData(): Promise<ChartDataPoint[]> {\n  await requireAnyRole();\n  const supabase = await createClient();\n\n  try {\n    // Récupérer les leads des 6 derniers mois\n    const sixMonthsAgo = new Date();\n    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);\n    \n    const { data: leads, error: leadsError } = await supabase\n      .from(\"visit_requests\")\n      .select(\"created_at\")\n      .gte(\"created_at\", sixMonthsAgo.toISOString());\n\n    if (leadsError) {\n      console.error(\"❌ Error fetching leads for chart:\", {\n        error: leadsError,\n        message: leadsError.message,\n        code: leadsError.code,\n        details: leadsError.details,\n        hint: leadsError.hint,\n        fullError: JSON.stringify(leadsError, null, 2)\n      });\n      return getDefaultChartData();\n    }\n\n    // Récupérer les propriétés approuvées des 6 derniers mois (pour les \"visites\")\n    const { data: properties, error: propertiesError } = await supabase\n      .from(\"properties\")\n      .select(\"created_at\")\n      .eq(\"validation_status\", \"approved\")\n      .gte(\"created_at\", sixMonthsAgo.toISOString());\n\n    if (propertiesError) {\n      console.error(\"Error fetching properties for chart:\", {\n        error: propertiesError,\n        message: propertiesError.message,\n        code: propertiesError.code,\n        details: propertiesError.details,\n        hint: propertiesError.hint,\n      });\n    }\n\n    // Grouper par mois\n    const monthNames = [\"Jan\", \"Fév\", \"Mar\", \"Avr\", \"Mai\", \"Juin\", \"Juil\", \"Aoû\", \"Sep\", \"Oct\", \"Nov\", \"Déc\"];\n    const chartData: ChartDataPoint[] = [];\n    \n    // Créer un objet pour chaque mois des 6 derniers mois\n    for (let i = 5; i >= 0; i--) {\n      const date = new Date();\n      date.setMonth(date.getMonth() - i);\n      const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, \"0\")}`;\n      const monthName = monthNames[date.getMonth()];\n      \n      // Compter les leads de ce mois\n      const leadsCount = (leads || []).filter((lead) => {\n        const leadDate = new Date(lead.created_at);\n        return leadDate.getFullYear() === date.getFullYear() && \n               leadDate.getMonth() === date.getMonth();\n      }).length;\n\n      // Compter les propriétés approuvées de ce mois (utilisé comme proxy pour les visites)\n      const propertiesCount = (properties || []).filter((prop) => {\n        const propDate = new Date(prop.created_at);\n        return propDate.getFullYear() === date.getFullYear() && \n               propDate.getMonth() === date.getMonth();\n      }).length;\n\n      // Multiplier les propriétés par un facteur pour simuler les visites\n      // (car on n'a pas de table de visites réelle)\n      const visitesCount = propertiesCount * 10; // Approximation\n\n      chartData.push({\n        month: monthName,\n        visites: visitesCount,\n        leads: leadsCount,\n      });\n    }\n\n    return chartData;\n  } catch (error) {\n    console.error(\"Error in getChartData:\", {\n      error,\n      message: error instanceof Error ? error.message : String(error),\n      code: (error as { code?: string })?.code,\n      details: (error as { details?: string })?.details,\n      hint: (error as { hint?: string })?.hint,\n    });\n    return getDefaultChartData();\n  }\n}\n\n/**\n * Retourne des données par défaut si la récupération échoue\n */\nfunction getDefaultChartData(): ChartDataPoint[] {\n  return [\n    { month: \"Jan\", visites: 0, leads: 0 },\n    { month: \"Fév\", visites: 0, leads: 0 },\n    { month: \"Mar\", visites: 0, leads: 0 },\n    { month: \"Avr\", visites: 0, leads: 0 },\n    { month: \"Mai\", visites: 0, leads: 0 },\n    { month: \"Juin\", visites: 0, leads: 0 },\n  ];\n}\n\nexport type PerformanceStats = {\n  totals: {\n    views: number;\n    clicks: number;\n    whatsappCount: number;\n    phoneCount: number;\n  };\n  chart: {\n    date: string;\n    views: number;\n    clicks: number;\n    whatsapp: number;\n    phone: number;\n  }[];\n  topProperties: {\n    id: string;\n    title: string;\n    image: string | null;\n    price: number;\n    views: number;\n    clicks: number;\n  }[];\n};\n\nexport type DashboardChartDataPoint = {\n  date: string;\n  views: number;\n  clicks: number;\n};\n\n/**\n * Récupère les statistiques de performance\n * @param days - Nombre de jours à récupérer (par défaut 30)\n */\nexport async function getPerformanceStats(days: number = 30): Promise<PerformanceStats | null> {\n  await requireAnyRole();\n  const supabase = await createClient();\n\n  try {\n    // 1. Calculer les vues totales depuis la colonne view_count (optimisé)\n    const { data: properties, error: propertiesError } = await supabase\n      .from(\"properties\")\n      .select(\"view_count\")\n      .eq(\"validation_status\", \"approved\");\n\n    if (propertiesError) {\n      console.error(\"Error fetching properties view_count:\", propertiesError);\n      return null;\n    }\n\n    const totalViews = properties.reduce((sum, p) => sum + (p.view_count || 0), 0);\n\n    // 2. Récupérer les clics selon la période demandée (historique complet conservé)\n    const clicksPeriodStart = new Date();\n    clicksPeriodStart.setDate(clicksPeriodStart.getDate() - days);\n\n    const { data: stats, error: statsError } = await supabase\n      .from(\"property_stats\")\n      .select(\"property_id, action_type, created_at\")\n      .in(\"action_type\", [\"whatsapp_click\", \"phone_click\"])\n      .gte(\"created_at\", clicksPeriodStart.toISOString());\n\n    if (statsError) {\n      console.error(\"Error fetching performance stats:\", statsError);\n      return null;\n    }\n\n    // 3. Calculer les totaux de clics avec détail par type\n    const whatsappCount = stats.filter((s) => s.action_type === \"whatsapp_click\").length;\n    const phoneCount = stats.filter((s) => s.action_type === \"phone_click\").length;\n    const totalClicks = stats.length;\n\n    // 4. Récupérer les données réelles du graphique groupées par jour\n    // Récupérer directement depuis property_stats pour avoir les vraies données\n    const periodStart = new Date();\n    periodStart.setDate(periodStart.getDate() - days);\n    periodStart.setHours(0, 0, 0, 0);\n\n    const { data: allStats, error: allStatsError } = await supabase\n      .from(\"property_stats\")\n      .select(\"action_type, created_at\")\n      .gte(\"created_at\", periodStart.toISOString())\n      .order(\"created_at\", { ascending: true });\n\n    if (allStatsError) {\n      console.error(\"Error fetching all stats for chart:\", allStatsError);\n    }\n\n    // Grouper par jour (ou par semaine si days > 30)\n    const isWeekly = days > 30;\n    const groupedStats = new Map<\n      string,\n      { views: number; whatsapp: number; phone: number }\n    >();\n\n    // Initialiser tous les jours/semaines de la période\n    if (isWeekly) {\n      const weeks = Math.ceil(days / 7);\n      for (let i = weeks - 1; i >= 0; i--) {\n        const date = new Date();\n        date.setDate(date.getDate() - (i * 7));\n        date.setHours(0, 0, 0, 0);\n        // Calculer le début de la semaine (lundi)\n        const dayOfWeek = date.getDay();\n        const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);\n        date.setDate(diff);\n        const weekKey = date.toISOString().split(\"T\")[0];\n        groupedStats.set(weekKey, { views: 0, whatsapp: 0, phone: 0 });\n      }\n    } else {\n      for (let i = days - 1; i >= 0; i--) {\n        const date = new Date();\n        date.setDate(date.getDate() - i);\n        date.setHours(0, 0, 0, 0);\n        const dateKey = date.toISOString().split(\"T\")[0];\n        groupedStats.set(dateKey, { views: 0, whatsapp: 0, phone: 0 });\n      }\n    }\n\n    // Compter les vues et clics\n    if (allStats) {\n      allStats.forEach((stat) => {\n        const statDate = new Date(stat.created_at);\n        statDate.setHours(0, 0, 0, 0);\n        \n        let groupKey: string;\n        if (isWeekly) {\n          // Calculer le début de la semaine\n          const dayOfWeek = statDate.getDay();\n          const diff = statDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);\n          const weekStart = new Date(statDate);\n          weekStart.setDate(diff);\n          groupKey = weekStart.toISOString().split(\"T\")[0];\n        } else {\n          groupKey = statDate.toISOString().split(\"T\")[0];\n        }\n\n        if (groupedStats.has(groupKey)) {\n          const groupData = groupedStats.get(groupKey)!;\n          if (stat.action_type === \"view\") {\n            groupData.views += 1;\n          } else if (stat.action_type === \"whatsapp_click\") {\n            groupData.whatsapp += 1;\n          } else if (stat.action_type === \"phone_click\") {\n            groupData.phone += 1;\n          }\n          groupedStats.set(groupKey, groupData);\n        }\n      });\n    }\n\n    // Convertir en tableau et formater\n    const chartData: {\n      date: string;\n      views: number;\n      clicks: number;\n      whatsapp: number;\n      phone: number;\n    }[] = Array.from(groupedStats.entries())\n      .sort(([dateA], [dateB]) => dateA.localeCompare(dateB))\n      .map(([dateKey, data]) => {\n        const date = new Date(dateKey + \"T00:00:00\");\n        let formattedDate: string;\n\n        if (isWeekly) {\n          const weekEnd = new Date(date);\n          weekEnd.setDate(weekEnd.getDate() + 6);\n          formattedDate = `${date.toLocaleDateString(\"fr-FR\", {\n            day: \"numeric\",\n            month: \"short\",\n          })} - ${weekEnd.toLocaleDateString(\"fr-FR\", {\n            day: \"numeric\",\n            month: \"short\",\n          })}`;\n        } else {\n          formattedDate = date.toLocaleDateString(\"fr-FR\", {\n            day: \"numeric\",\n            month: \"short\",\n          });\n        }\n\n        return {\n          date: formattedDate,\n          views: data.views,\n          clicks: data.whatsapp + data.phone,\n          whatsapp: data.whatsapp,\n          phone: data.phone,\n        };\n      });\n\n    // 5. Top Propriétés (utilise view_count pour les vues, property_stats pour les clics)\n    const propertyClicks = new Map<string, number>();\n\n    // Compter les clics par propriété\n    stats.forEach((s) => {\n      const current = propertyClicks.get(s.property_id) || 0;\n      propertyClicks.set(s.property_id, current + 1);\n    });\n\n    // Récupérer toutes les propriétés approuvées avec leur view_count\n    const { data: allProperties, error: allPropertiesError } = await supabase\n      .from(\"properties\")\n      .select(\"id, title, images, price, view_count\")\n      .eq(\"validation_status\", \"approved\")\n      .gt(\"view_count\", 0) // Seulement celles qui ont des vues\n      .order(\"view_count\", { ascending: false })\n      .limit(20); // Prendre un peu plus pour filtrer ensuite\n\n    if (allPropertiesError) {\n      console.error(\"Error fetching properties for top list:\", allPropertiesError);\n    }\n\n    // Combiner les vues (depuis view_count) et les clics (depuis property_stats)\n    const combinedStats = (allProperties || []).map((prop) => {\n      const clicks = propertyClicks.get(prop.id) || 0;\n      const views = prop.view_count || 0;\n      return {\n        id: prop.id,\n        views,\n        clicks,\n        total: views + clicks,\n        title: prop.title || \"Propriété inconnue\",\n        image:\n          Array.isArray(prop.images) && prop.images.length > 0\n            ? prop.images[0]\n            : null,\n        price: prop.price || 0,\n      };\n    });\n\n    // Trier par total (vues + clics) et prendre le top 5\n    const topPropertiesWithDetails = combinedStats\n      .sort((a, b) => b.total - a.total)\n      .slice(0, 5);\n\n    return {\n      totals: {\n        views: totalViews,\n        clicks: totalClicks,\n        whatsappCount,\n        phoneCount,\n      },\n      chart: chartData,\n      topProperties: topPropertiesWithDetails,\n    };\n  } catch (error) {\n    console.error(\"Error in getPerformanceStats:\", error);\n    return null;\n  }\n}\n\n/**\n * Récupère les données réelles du graphique groupées par jour\n * @param days - Nombre de jours à récupérer (par défaut 30)\n * @returns Tableau de données groupées par jour avec vues et contacts\n */\nexport async function getDashboardChartData(\n  days: number = 30\n): Promise<DashboardChartDataPoint[]> {\n  await requireAnyRole();\n  const supabase = await createClient();\n\n  try {\n    // Calculer la date de début de la période\n    const periodStart = new Date();\n    periodStart.setDate(periodStart.getDate() - days);\n    periodStart.setHours(0, 0, 0, 0); // Début de la journée\n\n    // Récupérer toutes les entrées de property_stats des 30 derniers jours\n    const { data: stats, error: statsError } = await supabase\n      .from(\"property_stats\")\n      .select(\"action_type, created_at\")\n      .gte(\"created_at\", periodStart.toISOString())\n      .order(\"created_at\", { ascending: true });\n\n    if (statsError) {\n      console.error(\"Error fetching dashboard chart data:\", statsError);\n      return [];\n    }\n\n    // Créer un Map pour grouper par jour\n    // Clé : date au format YYYY-MM-DD, Valeur : { views: number, clicks: number }\n    const dailyStats = new Map<string, { views: number; clicks: number }>();\n\n    // Initialiser tous les jours de la période avec 0\n    for (let i = days - 1; i >= 0; i--) {\n      const date = new Date();\n      date.setDate(date.getDate() - i);\n      date.setHours(0, 0, 0, 0);\n      const dateKey = date.toISOString().split(\"T\")[0]; // Format YYYY-MM-DD\n      dailyStats.set(dateKey, { views: 0, clicks: 0 });\n    }\n\n    // Compter les vues et contacts par jour\n    if (stats) {\n      stats.forEach((stat) => {\n        const statDate = new Date(stat.created_at);\n        statDate.setHours(0, 0, 0, 0);\n        const dateKey = statDate.toISOString().split(\"T\")[0];\n\n        // Si la date est dans notre période, incrémenter les compteurs\n        if (dailyStats.has(dateKey)) {\n          const dayData = dailyStats.get(dateKey)!;\n\n          if (stat.action_type === \"view\") {\n            dayData.views += 1;\n          } else if (\n            stat.action_type === \"whatsapp_click\" ||\n            stat.action_type === \"phone_click\"\n          ) {\n            dayData.clicks += 1;\n          }\n\n          dailyStats.set(dateKey, dayData);\n        }\n      });\n    }\n\n    // Convertir le Map en tableau et formater les dates pour Recharts\n    const chartData: DashboardChartDataPoint[] = Array.from(dailyStats.entries())\n      .sort(([dateA], [dateB]) => dateA.localeCompare(dateB)) // Trier par date croissante\n      .map(([dateKey, data]) => {\n        const date = new Date(dateKey + \"T00:00:00\"); // Ajouter l'heure pour éviter les problèmes de timezone\n        const formattedDate = date.toLocaleDateString(\"fr-FR\", {\n          day: \"numeric\",\n          month: \"short\",\n        });\n\n        return {\n          date: formattedDate,\n          views: data.views,\n          clicks: data.clicks,\n        };\n      });\n\n    return chartData;\n  } catch (error) {\n    console.error(\"Error in getDashboardChartData:\", error);\n    return [];\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\biens\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setValue' is assigned a value but never used.","line":58,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":58,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Image from \"next/image\";\nimport { useState, DragEvent, useEffect } from \"react\";\nimport { useRouter, useParams } from \"next/navigation\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { toast } from \"sonner\";\nimport Link from \"next/link\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { supabase } from \"@/lib/supabase\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { propertySchema, type PropertyFormValues } from \"@/lib/schemas/propertySchema\";\nimport { getPropertyById } from \"@/services/propertyService\";\n\nconst AUTHORIZED_ADMIN_EMAIL = \"barrymohamadou98@gmail.com\";\n\nconst quartiers = [\n  \"Almadies\",\n  \"Plateau\",\n  \"Mermoz\",\n  \"Yoff\",\n  \"Ngor\",\n  \"Ouakam\",\n  \"Sacré-Cœur\",\n  \"Les Mamelles\",\n];\n\nconst typesBien = [\n  { value: \"villa\", label: \"Villa\" },\n  { value: \"appartement\", label: \"Appartement\" },\n  { value: \"terrain\", label: \"Terrain\" },\n  { value: \"immeuble\", label: \"Immeuble / Commercial\" },\n];\n\nconst situationsJuridiques = [\n  { value: \"titre-foncier\", label: \"Titre Foncier\" },\n  { value: \"bail\", label: \"Bail\" },\n  { value: \"deliberation\", label: \"Délibération\" },\n  { value: \"nicad\", label: \"Nicad\" },\n];\n\nexport default function EditPropertyPage() {\n  const router = useRouter();\n  const params = useParams();\n  const propertyId = params.id as string;\n  const { user, loading: authLoading } = useAuth();\n  const [imageUrls, setImageUrls] = useState<string[]>([]);\n  const [uploading, setUploading] = useState(false);\n  const [loading, setLoading] = useState(true);\n  const {\n    register,\n    handleSubmit,\n    setValue,\n    watch,\n    reset,\n    formState: { errors },\n  } = useForm<PropertyFormValues>({\n    resolver: zodResolver(propertySchema),\n  });\n\n  // Watch pour réagir aux changements\n  const type = watch(\"type\");\n  const category = watch(\"category\");\n  const isTerrain = type === \"terrain\";\n\n  // Check admin access\n  useEffect(() => {\n    if (!authLoading && user) {\n      if (user.email?.toLowerCase() !== AUTHORIZED_ADMIN_EMAIL.toLowerCase()) {\n        toast.error(\"Accès non autorisé\");\n        router.push(\"/compte\");\n      }\n    } else if (!authLoading && !user) {\n      router.push(`/login?redirect=/admin/biens/${propertyId}`);\n    }\n  }, [user, authLoading, router, propertyId]);\n\n  // Load property data\n  useEffect(() => {\n    const loadProperty = async () => {\n      if (!propertyId || authLoading) return;\n      \n      try {\n        const property = await getPropertyById(propertyId);\n        if (!property) {\n          toast.error(\"Bien introuvable\");\n          router.push(\"/admin/dashboard\");\n          return;\n        }\n\n        // Pré-remplir le formulaire\n        reset({\n          title: property.title,\n          description: property.description,\n          price: property.price,\n          category: property.transaction,\n          type: property.details.type.toLowerCase() as \"villa\" | \"appartement\" | \"terrain\" | \"immeuble\",\n          city: property.location.city,\n          district: property.location.address,\n          address: property.location.address,\n          landmark: property.location.landmark,\n          surface: property.specs.surface,\n          surfaceTotale: property.specs.surface,\n          rooms: property.specs.rooms,\n          bedrooms: property.specs.bedrooms,\n          bathrooms: property.specs.bathrooms,\n          hasGenerator: property.details.hasBackupGenerator ?? false,\n          hasWaterTank: property.details.hasWaterTank ?? false,\n          security: property.details.security ?? false,\n          pool: false,\n          juridique: undefined,\n        });\n\n        setImageUrls(property.images ?? []);\n        setLoading(false);\n      } catch (error) {\n        console.error(\"Error loading property:\", error);\n        toast.error(\"Erreur lors du chargement du bien\");\n        router.push(\"/admin/dashboard\");\n      }\n    };\n\n    if (user && propertyId) {\n      loadProperty();\n    }\n  }, [propertyId, user, authLoading, reset, router]);\n\n  if (authLoading || loading) {\n    return (\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\n        <div className=\"text-white/70\">Chargement...</div>\n      </div>\n    );\n  }\n\n  if (!user || user.email?.toLowerCase() !== AUTHORIZED_ADMIN_EMAIL.toLowerCase()) {\n    return null;\n  }\n\n  const onDrop = async (event: DragEvent<HTMLDivElement>) => {\n    event.preventDefault();\n    const files = Array.from(event.dataTransfer.files);\n    await handleUpload(files);\n  };\n\n  const handleUpload = async (files: FileList | File[]) => {\n    const fileArray = Array.from(files);\n    if (fileArray.length === 0) return;\n\n    setUploading(true);\n    try {\n      const uploadPromises = fileArray.map(async (file) => {\n        const fileExt = file.name.split(\".\").pop();\n        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;\n        const filePath = `properties/${fileName}`;\n\n        const { error: uploadError } = await supabase.storage\n          .from(\"properties\")\n          .upload(filePath, file);\n\n        if (uploadError) throw uploadError;\n\n        const {\n          data: { publicUrl },\n        } = supabase.storage.from(\"properties\").getPublicUrl(filePath);\n\n        return publicUrl;\n      });\n\n      const urls = await Promise.all(uploadPromises);\n      setImageUrls((prev) => [...prev, ...urls]);\n      toast.success(`${urls.length} image(s) uploadée(s)`);\n    } catch (error) {\n      console.error(\"Upload error:\", error);\n      toast.error(\"Erreur lors de l'upload\");\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  const onSubmit = async (values: PropertyFormValues) => {\n    try {\n      // Préparer les specs selon le type\n      const specs = isTerrain\n        ? {\n            surface: values.surfaceTotale ?? 0,\n            rooms: 0,\n            bedrooms: 0,\n            bathrooms: 0,\n            dpe: \"B\" as const,\n          }\n        : {\n            surface: values.surface ?? 0,\n            rooms: values.rooms ?? 0,\n            bedrooms: values.bedrooms ?? 0,\n            bathrooms: values.bathrooms ?? 0,\n            dpe: \"B\" as const,\n          };\n\n      // Préparer les features (masqués pour les terrains)\n      const features = isTerrain\n        ? {}\n        : {\n            hasGenerator: values.hasGenerator ?? false,\n            hasWaterTank: values.hasWaterTank ?? false,\n            security: values.security ?? false,\n            pool: values.pool ?? false,\n          };\n\n      // Mapper le type pour details\n      const typeMap: Record<string, \"Appartement\" | \"Maison\" | \"Studio\"> = {\n        villa: \"Maison\",\n        appartement: \"Appartement\",\n        immeuble: \"Appartement\",\n        terrain: \"Appartement\",\n      };\n\n      const payload = {\n        title: values.title,\n        description: values.description,\n        price: values.price,\n        category: values.category,\n        location: {\n          city: values.city,\n          district: values.district,\n          address: values.address,\n          landmark: values.landmark,\n          coords: { lat: 0, lng: 0 }, // TODO: Géocodage\n        },\n        specs,\n        features,\n        details: isTerrain\n          ? {\n              type: \"Appartement\" as const,\n              year: new Date().getFullYear(),\n              heating: \"\",\n              juridique: values.juridique,\n            }\n          : {\n              type: typeMap[values.type] ?? \"Appartement\",\n              year: new Date().getFullYear(),\n              heating: \"Climatisation\",\n            },\n        images: imageUrls,\n      };\n\n      const { error } = await supabase\n        .from(\"properties\")\n        .update(payload)\n        .eq(\"id\", propertyId);\n\n      if (error) throw error;\n      toast.success(\"Bien mis à jour !\");\n      router.push(\"/admin/dashboard\");\n      router.refresh();\n    } catch (error) {\n      console.error(error);\n      toast.error(\"Impossible de mettre à jour ce bien\");\n    }\n  };\n\n  // Label dynamique pour le prix\n  const priceLabel =\n    category === \"location\"\n      ? \"Loyer Mensuel (FCFA)\"\n      : \"Prix de Vente (FCFA)\";\n\n  return (\n    <div className=\"space-y-6 py-6 text-white\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/40\">\n            Admin\n          </p>\n          <h1 className=\"text-3xl font-semibold\">Éditer le bien</h1>\n        </div>\n        <Button variant=\"secondary\" className=\"rounded-full\" asChild>\n          <Link href=\"/admin/dashboard\">Retour</Link>\n        </Button>\n      </div>\n      <div\n        className=\"space-y-6 sm:space-y-8 rounded-[32px] border border-white/10 bg-white/5 p-4 sm:p-6\"\n      >\n        <section className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">Informations principales</h2>\n          <div className=\"grid gap-4 sm:grid-cols-2\">\n            {/* Catégorie en premier */}\n            <div>\n              <label className=\"text-sm text-white/70\">Catégorie</label>\n              <select\n                {...register(\"category\")}\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                style={{\n                  colorScheme: \"dark\",\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                  backgroundPosition: \"right 0.75rem center\",\n                  backgroundSize: \"1.5em 1.5em\"\n                }}\n              >\n                <option value=\"vente\" className=\"bg-[#121212] text-white py-2\">\n                  Vente\n                </option>\n                <option value=\"location\" className=\"bg-[#121212] text-white py-2\">\n                  Location\n                </option>\n              </select>\n            </div>\n            <div>\n              <label className=\"text-sm text-white/70\">Type de bien</label>\n              <select\n                {...register(\"type\")}\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                style={{\n                  colorScheme: \"dark\",\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                  backgroundPosition: \"right 0.75rem center\",\n                  backgroundSize: \"1.5em 1.5em\"\n                }}\n              >\n                {typesBien.map((t) => (\n                  <option\n                    key={t.value}\n                    value={t.value}\n                    className=\"bg-[#121212] text-white py-2\"\n                  >\n                    {t.label}\n                  </option>\n                ))}\n              </select>\n              {errors.type && (\n                <p className=\"text-sm text-amber-300\">{errors.type.message}</p>\n              )}\n            </div>\n            <div className=\"sm:col-span-2\">\n              <label className=\"text-sm text-white/70\">Titre</label>\n              <Input {...register(\"title\")} className=\"mt-2\" />\n              {errors.title && (\n                <p className=\"text-sm text-amber-300\">{errors.title.message}</p>\n              )}\n            </div>\n            <div className=\"sm:col-span-2\">\n              <label className=\"text-sm text-white/70\">{priceLabel}</label>\n              <Input\n                type=\"number\"\n                {...register(\"price\", { valueAsNumber: true })}\n                className=\"mt-2\"\n              />\n              {errors.price && (\n                <p className=\"text-sm text-amber-300\">{errors.price.message}</p>\n              )}\n            </div>\n            <div className=\"sm:col-span-2\">\n              <label className=\"text-sm text-white/70\">Description</label>\n              <Textarea\n                {...register(\"description\")}\n                className=\"mt-2 min-h-[120px]\"\n                rows={5}\n              />\n              {errors.description && (\n                <p className=\"text-sm text-amber-300\">\n                  {errors.description.message}\n                </p>\n              )}\n            </div>\n          </div>\n        </section>\n\n        <section className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">Localisation</h2>\n          <div className=\"grid gap-4 sm:grid-cols-2\">\n            <div>\n              <label className=\"text-sm text-white/70\">Ville</label>\n              <Input {...register(\"city\")} className=\"mt-2\" />\n              {errors.city && (\n                <p className=\"text-sm text-amber-300\">{errors.city.message}</p>\n              )}\n            </div>\n            <div>\n              <label className=\"text-sm text-white/70\">Quartier</label>\n              <select\n                {...register(\"district\")}\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                style={{\n                  colorScheme: \"dark\",\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                  backgroundPosition: \"right 0.75rem center\",\n                  backgroundSize: \"1.5em 1.5em\"\n                }}\n              >\n                <option value=\"\" className=\"bg-[#121212] text-white py-2\">\n                  Sélectionner\n                </option>\n                {quartiers.map((q) => (\n                  <option key={q} value={q} className=\"bg-[#121212] text-white py-2\">\n                    {q}\n                  </option>\n                ))}\n              </select>\n            </div>\n            <div className=\"sm:col-span-2\">\n              <label className=\"text-sm text-white/70\">Adresse</label>\n              <Input {...register(\"address\")} className=\"mt-2\" />\n            </div>\n            <div className=\"sm:col-span-2\">\n              <label className=\"text-sm text-white/70\">Point de repère</label>\n              <Input {...register(\"landmark\")} className=\"mt-2\" />\n            </div>\n          </div>\n        </section>\n\n        {!isTerrain && (\n          <section className=\"space-y-4\">\n            <h2 className=\"text-xl font-semibold\">Caractéristiques</h2>\n            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n              <div>\n                <label className=\"text-sm text-white/70\">Surface (m²)</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"surface\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.surface && (\n                  <p className=\"text-sm text-amber-300\">\n                    {errors.surface.message}\n                  </p>\n                )}\n              </div>\n              <div>\n                <label className=\"text-sm text-white/70\">Pièces</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"rooms\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.rooms && (\n                  <p className=\"text-sm text-amber-300\">\n                    {errors.rooms.message}\n                  </p>\n                )}\n              </div>\n              <div>\n                <label className=\"text-sm text-white/70\">Chambres</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"bedrooms\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.bedrooms && (\n                  <p className=\"text-sm text-amber-300\">\n                    {errors.bedrooms.message}\n                  </p>\n                )}\n              </div>\n              <div>\n                <label className=\"text-sm text-white/70\">Salles de bain</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"bathrooms\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.bathrooms && (\n                  <p className=\"text-sm text-amber-300\">\n                    {errors.bathrooms.message}\n                  </p>\n                )}\n              </div>\n            </div>\n          </section>\n        )}\n\n        {isTerrain && (\n          <section className=\"space-y-4\">\n            <h2 className=\"text-xl font-semibold\">Caractéristiques du terrain</h2>\n            <div className=\"grid gap-4 sm:grid-cols-2\">\n              <div>\n                <label className=\"text-sm text-white/70\">Surface totale (m²)</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"surfaceTotale\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.surfaceTotale && (\n                  <p className=\"text-sm text-amber-300\">\n                    {errors.surfaceTotale.message}\n                  </p>\n                )}\n              </div>\n              <div>\n                <label className=\"text-sm text-white/70\">Situation juridique</label>\n                <select\n                  {...register(\"juridique\")}\n                  className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                  style={{\n                    colorScheme: \"dark\",\n                    backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                    backgroundPosition: \"right 0.75rem center\",\n                    backgroundSize: \"1.5em 1.5em\"\n                  }}\n                >\n                  <option value=\"\" className=\"bg-[#121212] text-white py-2\">\n                    Sélectionner\n                  </option>\n                  {situationsJuridiques.map((s) => (\n                    <option\n                      key={s.value}\n                      value={s.value}\n                      className=\"bg-[#121212] text-white py-2\"\n                    >\n                      {s.label}\n                    </option>\n                  ))}\n                </select>\n                {errors.juridique && (\n                  <p className=\"text-sm text-amber-300\">\n                    {errors.juridique.message}\n                  </p>\n                )}\n              </div>\n            </div>\n          </section>\n        )}\n\n        {!isTerrain && (\n          <section className=\"space-y-4\">\n            <h2 className=\"text-xl font-semibold\">Équipements Dakar</h2>\n            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n              <div className=\"flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 p-4\">\n                <label className=\"text-sm text-white/70\">Groupe électrogène</label>\n                <Switch {...register(\"hasGenerator\")} />\n              </div>\n              <div className=\"flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 p-4\">\n                <label className=\"text-sm text-white/70\">Réservoir d&apos;eau</label>\n                <Switch {...register(\"hasWaterTank\")} />\n              </div>\n              <div className=\"flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 p-4\">\n                <label className=\"text-sm text-white/70\">Sécurité</label>\n                <Switch {...register(\"security\")} />\n              </div>\n              <div className=\"flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 p-4\">\n                <label className=\"text-sm text-white/70\">Piscine</label>\n                <Switch {...register(\"pool\")} />\n              </div>\n            </div>\n          </section>\n        )}\n\n        <section className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">Photos</h2>\n          <div\n            onDrop={onDrop}\n            onDragOver={(e) => e.preventDefault()}\n            className=\"rounded-2xl border-2 border-dashed border-white/20 bg-white/5 p-8 text-center\"\n          >\n            <input\n              type=\"file\"\n              multiple\n              accept=\"image/*\"\n              onChange={(e) => e.target.files && handleUpload(e.target.files)}\n              className=\"hidden\"\n              id=\"image-upload\"\n              disabled={uploading}\n            />\n            <label\n              htmlFor=\"image-upload\"\n              className=\"cursor-pointer text-white/70 hover:text-white\"\n            >\n              {uploading ? (\n                \"Upload en cours...\"\n              ) : (\n                <>\n                  Glissez-déposez des images ou cliquez pour sélectionner\n                  <br />\n                  <span className=\"text-xs text-white/50\">\n                    {imageUrls.length} image(s) sélectionnée(s)\n                  </span>\n                </>\n              )}\n            </label>\n          </div>\n          {imageUrls.length > 0 && (\n            <div className=\"grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4\">\n              {imageUrls.map((url, index) => (\n                <div key={url} className=\"relative aspect-square\">\n                  <Image\n                    src={url}\n                    alt={`Photo ${index + 1}`}\n                    fill\n                    className=\"rounded-xl object-cover\"\n                    sizes=\"(max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw\"\n                  />\n                  <button\n                    type=\"button\"\n                    onClick={() =>\n                      setImageUrls((prev) => prev.filter((_, i) => i !== index))\n                    }\n                    className=\"absolute right-2 top-2 rounded-full bg-red-500 p-1.5 text-white hover:bg-red-600\"\n                  >\n                    ×\n                  </button>\n                </div>\n              ))}\n            </div>\n          )}\n        </section>\n\n        <Button\n          type=\"button\"\n          onClick={handleSubmit(onSubmit)}\n          className=\"w-full rounded-full bg-background text-foreground\"\n          disabled={uploading}\n        >\n          Mettre à jour le bien\n        </Button>\n      </div>\n    </div>\n  );\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\biens\\nouveau\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleSubmit' is assigned a value but never used.","line":74,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":74,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Image from \"next/image\";\r\nimport { useState, DragEvent, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useForm } from \"react-hook-form\";\r\nimport { zodResolver } from \"@hookform/resolvers/zod\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { useAuth } from \"@/hooks/use-auth\";\r\nimport { propertySchema, type PropertyFormValues } from \"@/lib/schemas/propertySchema\";\r\n\r\nconst AUTHORIZED_ADMIN_EMAIL = \"barrymohamadou98@gmail.com\";\r\n\r\nconst defaultValues: Partial<PropertyFormValues> = {\r\n  title: \"\",\r\n  description: \"\",\r\n  price: 0,\r\n  category: \"vente\",\r\n  type: \"appartement\",\r\n  city: \"\",\r\n  district: \"\",\r\n  address: \"\",\r\n  landmark: \"\",\r\n  surface: 120,\r\n  surfaceTotale: undefined,\r\n  rooms: 4,\r\n  bedrooms: 3,\r\n  bathrooms: 2,\r\n  hasGenerator: false,\r\n  hasWaterTank: false,\r\n  security: true,\r\n  pool: false,\r\n  juridique: undefined,\r\n};\r\n\r\nconst quartiers = [\r\n  \"Almadies\",\r\n  \"Plateau\",\r\n  \"Mermoz\",\r\n  \"Yoff\",\r\n  \"Ngor\",\r\n  \"Ouakam\",\r\n  \"Sacré-Cœur\",\r\n  \"Les Mamelles\",\r\n];\r\n\r\nconst typesBien = [\r\n  { value: \"villa\", label: \"Villa\" },\r\n  { value: \"appartement\", label: \"Appartement\" },\r\n  { value: \"terrain\", label: \"Terrain\" },\r\n  { value: \"immeuble\", label: \"Immeuble / Commercial\" },\r\n];\r\n\r\nconst situationsJuridiques = [\r\n  { value: \"titre-foncier\", label: \"Titre Foncier\" },\r\n  { value: \"bail\", label: \"Bail\" },\r\n  { value: \"deliberation\", label: \"Délibération\" },\r\n  { value: \"nicad\", label: \"Nicad\" },\r\n];\r\n\r\nexport default function NewPropertyPage() {\r\n  const router = useRouter();\r\n  const { user, loading } = useAuth();\r\n  const [imageUrls, setImageUrls] = useState<string[]>([]);\r\n  const [uploading, setUploading] = useState(false);\r\n  const {\r\n    register,\r\n    handleSubmit,\r\n    setValue,\r\n    watch,\r\n    getValues,\r\n    formState: { errors },\r\n    trigger,\r\n  } = useForm<PropertyFormValues>({\r\n    resolver: zodResolver(propertySchema),\r\n    defaultValues,\r\n  });\r\n\r\n  // Watch pour réagir aux changements\r\n  const type = watch(\"type\");\r\n  const category = watch(\"category\");\r\n  const isTerrain = type === \"terrain\";\r\n\r\n  // Check admin access\r\n  useEffect(() => {\r\n    if (!loading && user) {\r\n      if (user.email?.toLowerCase() !== AUTHORIZED_ADMIN_EMAIL.toLowerCase()) {\r\n        toast.error(\"Accès non autorisé\");\r\n        router.push(\"/compte\");\r\n      }\r\n    } else if (!loading && !user) {\r\n      router.push(\"/login?redirect=/admin/biens/nouveau\");\r\n    }\r\n  }, [user, loading, router]);\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\r\n        <div className=\"text-white/70\">Chargement...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user || user.email?.toLowerCase() !== AUTHORIZED_ADMIN_EMAIL.toLowerCase()) {\r\n    return null;\r\n  }\r\n\r\n  const onDrop = async (event: DragEvent<HTMLDivElement>) => {\r\n    event.preventDefault();\r\n    const files = Array.from(event.dataTransfer.files);\r\n    await handleUpload(files);\r\n  };\r\n\r\n  const handleUpload = async (files: FileList | File[]) => {\r\n    const arr = Array.from(files);\r\n    if (!arr.length) return;\r\n    setUploading(true);\r\n    try {\r\n      const uploadedUrls: string[] = [];\r\n      for (const file of arr) {\r\n        const filePath = `${Date.now()}-${file.name}`;\r\n        const { error } = await supabase.storage\r\n          .from(\"properties\")\r\n          .upload(filePath, file, { upsert: true });\r\n        if (error) throw error;\r\n        const {\r\n          data: { publicUrl },\r\n        } = supabase.storage.from(\"properties\").getPublicUrl(filePath);\r\n        uploadedUrls.push(publicUrl);\r\n      }\r\n      setImageUrls((prev) => [...prev, ...uploadedUrls]);\r\n    } catch (error) {\r\n      console.error(error);\r\n      toast.error(\"Upload impossible\");\r\n    } finally {\r\n      setUploading(false);\r\n    }\r\n  };\r\n\r\n  const onSubmit = async (values: PropertyFormValues) => {\r\n    try {\r\n      // Préparer les specs selon le type\r\n      const specs = isTerrain\r\n        ? {\r\n            surface: values.surfaceTotale ?? 0,\r\n            rooms: 0,\r\n            bedrooms: 0,\r\n            bathrooms: 0,\r\n            dpe: \"B\" as const,\r\n          }\r\n        : {\r\n            surface: values.surface ?? 0,\r\n            rooms: values.rooms ?? 0,\r\n            bedrooms: values.bedrooms ?? 0,\r\n            bathrooms: values.bathrooms ?? 0,\r\n            dpe: \"B\" as const,\r\n          };\r\n\r\n      // Préparer les features (masqués pour les terrains)\r\n      const features = isTerrain\r\n        ? {}\r\n        : {\r\n            hasGenerator: values.hasGenerator ?? false,\r\n            hasWaterTank: values.hasWaterTank ?? false,\r\n            security: values.security ?? false,\r\n            pool: values.pool ?? false,\r\n          };\r\n\r\n      // Mapper le type pour details\r\n      const typeMap: Record<string, \"Appartement\" | \"Maison\" | \"Studio\"> = {\r\n        villa: \"Maison\",\r\n        appartement: \"Appartement\",\r\n        immeuble: \"Appartement\",\r\n        terrain: \"Appartement\", // Valeur par défaut, non utilisée pour terrain\r\n      };\r\n\r\n      const payload = {\r\n        title: values.title,\r\n        description: values.description,\r\n        price: values.price,\r\n        category: values.category,\r\n        status: \"disponible\",\r\n        location: {\r\n          city: values.city,\r\n          district: values.district,\r\n          address: values.address,\r\n          landmark: values.landmark,\r\n          coords: { lat: 0, lng: 0 }, // À améliorer avec géolocalisation\r\n        },\r\n        specs,\r\n        features,\r\n        details: isTerrain\r\n          ? {\r\n              type: \"Appartement\" as const, // Non utilisé pour terrain\r\n              year: new Date().getFullYear(),\r\n              heating: \"\",\r\n              juridique: values.juridique,\r\n            }\r\n          : {\r\n              type: typeMap[values.type] ?? \"Appartement\",\r\n              year: new Date().getFullYear(),\r\n              heating: \"Climatisation\",\r\n            },\r\n        images: imageUrls,\r\n      };\r\n\r\n      const { error } = await supabase.from(\"properties\").insert([payload]);\r\n      if (error) throw error;\r\n      toast.success(\"Bien publié !\");\r\n      router.push(\"/admin/dashboard\");\r\n      router.refresh();\r\n    } catch (error) {\r\n      console.error(error);\r\n      toast.error(\"Impossible d'enregistrer ce bien\");\r\n    }\r\n  };\r\n\r\n  // Label dynamique pour le prix\r\n  const priceLabel =\r\n    category === \"location\"\r\n      ? \"Loyer Mensuel (FCFA)\"\r\n      : \"Prix de Vente (FCFA)\";\r\n\r\n  return (\r\n    <div className=\"space-y-6 py-6 text-white\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/40\">\r\n            Admin\r\n          </p>\r\n          <h1 className=\"text-3xl font-semibold\">Nouveau bien</h1>\r\n        </div>\r\n      </div>\r\n      <div\r\n        className=\"space-y-6 sm:space-y-8 rounded-[32px] border border-white/10 bg-white/5 p-4 sm:p-6\"\r\n      >\r\n        <section className=\"space-y-4\">\r\n          <h2 className=\"text-xl font-semibold\">Informations principales</h2>\r\n          <div className=\"grid gap-4 sm:grid-cols-2\">\r\n            {/* Catégorie en premier */}\r\n            <div>\r\n              <label className=\"text-sm text-white/70\">Catégorie</label>\r\n              <select\r\n                {...register(\"category\")}\r\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\r\n                style={{\r\n                  colorScheme: \"dark\",\r\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\r\n                  backgroundPosition: \"right 0.75rem center\",\r\n                  backgroundSize: \"1.5em 1.5em\"\r\n                }}\r\n              >\r\n                <option value=\"vente\" className=\"bg-[#121212] text-white py-2\">\r\n                  Vente\r\n                </option>\r\n                <option value=\"location\" className=\"bg-[#121212] text-white py-2\">\r\n                  Location\r\n                </option>\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <label className=\"text-sm text-white/70\">Type de bien</label>\r\n              <select\r\n                {...register(\"type\")}\r\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\r\n                style={{\r\n                  colorScheme: \"dark\",\r\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\r\n                  backgroundPosition: \"right 0.75rem center\",\r\n                  backgroundSize: \"1.5em 1.5em\"\r\n                }}\r\n              >\r\n                {typesBien.map((t) => (\r\n                  <option\r\n                    key={t.value}\r\n                    value={t.value}\r\n                    className=\"bg-[#121212] text-white py-2\"\r\n                  >\r\n                    {t.label}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n              {errors.type && (\r\n                <p className=\"text-sm text-primary\">{errors.type.message}</p>\r\n              )}\r\n            </div>\r\n            <div className=\"sm:col-span-2\">\r\n              <label className=\"text-sm text-white/70\">Titre</label>\r\n              <Input {...register(\"title\")} className=\"mt-2\" />\r\n              {errors.title && (\r\n                <p className=\"text-sm text-primary\">{errors.title.message}</p>\r\n              )}\r\n            </div>\r\n            <div className=\"sm:col-span-2\">\r\n              <label className=\"text-sm text-white/70\">{priceLabel}</label>\r\n              <Input\r\n                type=\"number\"\r\n                {...register(\"price\", { valueAsNumber: true })}\r\n                className=\"mt-2\"\r\n              />\r\n              {errors.price && (\r\n                <p className=\"text-sm text-primary\">{errors.price.message}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n          <div>\r\n            <label className=\"text-sm text-white/70\">Description</label>\r\n            <Textarea {...register(\"description\")} className=\"mt-2\" />\r\n            {errors.description && (\r\n              <p className=\"text-sm text-primary\">\r\n                {errors.description.message}\r\n              </p>\r\n            )}\r\n          </div>\r\n        </section>\r\n\r\n        <section className=\"space-y-4\">\r\n          <h2 className=\"text-xl font-semibold\">Localisation</h2>\r\n          <div className=\"grid gap-4 sm:grid-cols-2\">\r\n            <div>\r\n              <label className=\"text-sm text-white/70\">Ville</label>\r\n              <Input {...register(\"city\")} className=\"mt-2\" />\r\n              {errors.city && (\r\n                <p className=\"text-sm text-primary\">{errors.city.message}</p>\r\n              )}\r\n            </div>\r\n            <div>\r\n              <label className=\"text-sm text-white/70\">Quartier</label>\r\n              <select\r\n                {...register(\"district\")}\r\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\r\n                style={{\r\n                  colorScheme: \"dark\",\r\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\r\n                  backgroundPosition: \"right 0.75rem center\",\r\n                  backgroundSize: \"1.5em 1.5em\"\r\n                }}\r\n              >\r\n                  <option value=\"\" className=\"bg-[#121212] text-white py-2\">\r\n                    Sélectionnez\r\n                  </option>\r\n                  {quartiers.map((q) => (\r\n                    <option\r\n                      key={q}\r\n                      value={q}\r\n                      className=\"bg-[#121212] text-white py-2\"\r\n                    >\r\n                      {q}\r\n                    </option>\r\n                  ))}\r\n              </select>\r\n              {errors.district && (\r\n                <p className=\"text-sm text-primary\">\r\n                  {errors.district.message}\r\n                </p>\r\n              )}\r\n            </div>\r\n            <div>\r\n              <label className=\"text-sm text-white/70\">Adresse</label>\r\n              <Input {...register(\"address\")} className=\"mt-2\" />\r\n              {errors.address && (\r\n                <p className=\"text-sm text-primary\">\r\n                  {errors.address.message}\r\n                </p>\r\n              )}\r\n            </div>\r\n            <div>\r\n              <label className=\"text-sm text-white/70\">Point de repère</label>\r\n              <Input {...register(\"landmark\")} className=\"mt-2\" />\r\n              {errors.landmark && (\r\n                <p className=\"text-sm text-primary\">\r\n                  {errors.landmark.message}\r\n                </p>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Section Caractéristiques - Conditionnelle selon le type */}\r\n        {!isTerrain ? (\r\n          <section className=\"space-y-4 transition-all duration-300\">\r\n            <h2 className=\"text-xl font-semibold\">Caractéristiques</h2>\r\n            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n              <div>\r\n                <label className=\"text-sm text-white/70\">Surface habitable (m²)</label>\r\n                <Input\r\n                  type=\"number\"\r\n                  {...register(\"surface\", { valueAsNumber: true })}\r\n                  className=\"mt-2\"\r\n                />\r\n                {errors.surface && (\r\n                  <p className=\"text-sm text-primary\">\r\n                    {errors.surface.message}\r\n                  </p>\r\n                )}\r\n              </div>\r\n              <div>\r\n                <label className=\"text-sm text-white/70\">Pièces</label>\r\n                <Input\r\n                  type=\"number\"\r\n                  {...register(\"rooms\", { valueAsNumber: true })}\r\n                  className=\"mt-2\"\r\n                />\r\n                {errors.rooms && (\r\n                  <p className=\"text-sm text-primary\">\r\n                    {errors.rooms.message}\r\n                  </p>\r\n                )}\r\n              </div>\r\n              <div>\r\n                <label className=\"text-sm text-white/70\">Chambres</label>\r\n                <Input\r\n                  type=\"number\"\r\n                  {...register(\"bedrooms\", { valueAsNumber: true })}\r\n                  className=\"mt-2\"\r\n                />\r\n                {errors.bedrooms && (\r\n                  <p className=\"text-sm text-primary\">\r\n                    {errors.bedrooms.message}\r\n                  </p>\r\n                )}\r\n              </div>\r\n              <div>\r\n                <label className=\"text-sm text-white/70\">Salles de bain</label>\r\n                <Input\r\n                  type=\"number\"\r\n                  {...register(\"bathrooms\", { valueAsNumber: true })}\r\n                  className=\"mt-2\"\r\n                />\r\n                {errors.bathrooms && (\r\n                  <p className=\"text-sm text-primary\">\r\n                    {errors.bathrooms.message}\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </div>\r\n            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n              {[\r\n                { label: \"Groupe électrogène\", key: \"hasGenerator\" },\r\n                { label: \"Réservoir eau\", key: \"hasWaterTank\" },\r\n                { label: \"Gardiennage 24/7\", key: \"security\" },\r\n                { label: \"Piscine\", key: \"pool\" },\r\n              ].map((feature) => (\r\n                <label\r\n                  key={feature.key}\r\n                  className=\"flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white/80\"\r\n                >\r\n                  {feature.label}\r\n                  <Switch\r\n                    checked={(watch(feature.key as keyof PropertyFormValues) as boolean) ?? false}\r\n                    onCheckedChange={(checked) =>\r\n                      setValue(feature.key as keyof PropertyFormValues, checked)\r\n                    }\r\n                  />\r\n                </label>\r\n              ))}\r\n            </div>\r\n          </section>\r\n        ) : (\r\n          <section className=\"space-y-4 transition-all duration-300\">\r\n            <h2 className=\"text-xl font-semibold\">Caractéristiques du terrain</h2>\r\n            <div className=\"grid gap-4 sm:grid-cols-2\">\r\n              <div>\r\n                <label className=\"text-sm text-white/70\">Surface totale (m²)</label>\r\n                <Input\r\n                  type=\"number\"\r\n                  {...register(\"surfaceTotale\", { valueAsNumber: true })}\r\n                  className=\"mt-2\"\r\n                />\r\n                {errors.surfaceTotale && (\r\n                  <p className=\"text-sm text-primary\">\r\n                    {errors.surfaceTotale.message}\r\n                  </p>\r\n                )}\r\n              </div>\r\n              <div>\r\n                <label className=\"text-sm text-white/70\">Situation juridique</label>\r\n                <select\r\n                  {...register(\"juridique\")}\r\n                  className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\r\n                  style={{\r\n                    colorScheme: \"dark\",\r\n                    backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\r\n                    backgroundPosition: \"right 0.75rem center\",\r\n                    backgroundSize: \"1.5em 1.5em\"\r\n                  }}\r\n                >\r\n                  <option value=\"\" className=\"bg-[#121212] text-white py-2\">\r\n                    Sélectionnez\r\n                  </option>\r\n                  {situationsJuridiques.map((sj) => (\r\n                    <option\r\n                      key={sj.value}\r\n                      value={sj.value}\r\n                      className=\"bg-[#121212] text-white py-2\"\r\n                    >\r\n                      {sj.label}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n                {errors.juridique && (\r\n                  <p className=\"text-sm text-primary\">\r\n                    {errors.juridique.message}\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </section>\r\n        )}\r\n\r\n        <section className=\"space-y-4\">\r\n          <h2 className=\"text-xl font-semibold\">\r\n            {isTerrain ? \"Photos du site\" : \"Photos\"}\r\n          </h2>\r\n          <div\r\n            className=\"rounded-3xl border border-dashed border-white/20 bg-white/5 p-6 text-center text-white/70\"\r\n            onDragOver={(event) => event.preventDefault()}\r\n            onDrop={onDrop}\r\n          >\r\n            <p>Glisse-dépose tes images ici ou</p>\r\n            <div className=\"mt-3\">\r\n              <label className=\"inline-flex cursor-pointer items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-sm text-white\">\r\n                <input\r\n                  type=\"file\"\r\n                  multiple\r\n                  accept=\"image/*\"\r\n                  className=\"hidden\"\r\n                  onChange={(event) =>\r\n                    event.target.files && handleUpload(event.target.files)\r\n                  }\r\n                />\r\n                Choisir des fichiers\r\n              </label>\r\n            </div>\r\n            {uploading && <p className=\"mt-2 text-sm\">Upload en cours...</p>}\r\n            {imageUrls.length > 0 && (\r\n              <div className=\"mt-4 flex flex-wrap gap-3\">\r\n                {imageUrls.map((url) => (\r\n                  <div\r\n                    key={url}\r\n                    className=\"relative h-24 w-24 overflow-hidden rounded-xl\"\r\n                  >\r\n                    <Image\r\n                      src={url}\r\n                      alt=\"preview\"\r\n                      fill\r\n                      className=\"object-cover\"\r\n                    />\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </section>\r\n\r\n        <Button\r\n          type=\"button\"\r\n          onClick={async () => {\r\n            const isValid = await trigger();\r\n            if (!isValid) {\r\n              return;\r\n            }\r\n            const values = getValues();\r\n            await onSubmit(values);\r\n          }}\r\n          className=\"w-full rounded-full bg-background text-foreground\"\r\n          disabled={uploading}\r\n        >\r\n          Publier le bien\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\dashboard\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\dashboard\\delete-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\leads\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\leads\\lead-message-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\leads\\lead-status-select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\leads\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateLeadStatus' is defined but never used.","line":6,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Lead' is defined but never used.","line":6,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":47},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'statusLabels' is assigned a value but never used.","line":14,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'statusColors' is assigned a value but never used.","line":20,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\nimport { MessageCircle } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\n\nimport { requireAnyRole } from \"@/lib/permissions\";\nimport { getLeads, updateLeadStatus, type Lead, type LeadStatus } from \"./actions\";\nimport { Button } from \"@/components/ui/button\";\nimport { LeadStatusSelect } from \"./lead-status-select\";\nimport { LeadMessageDialog } from \"./lead-message-dialog\";\n\n// Force dynamic rendering\nexport const dynamic = \"force-dynamic\";\n\nconst statusLabels: Record<LeadStatus, string> = {\n  nouveau: \"Nouveau\",\n  contacté: \"Contacté\",\n  clos: \"Clos\",\n};\n\nconst statusColors: Record<LeadStatus, string> = {\n  nouveau: \"bg-red-500/20 text-red-300 border-red-500/30\",\n  contacté: \"bg-amber-500/20 text-amber-300 border-amber-500/30\",\n  clos: \"bg-emerald-500/20 text-emerald-300 border-emerald-500/30\",\n};\n\nconst availabilityLabels: Record<string, string> = {\n  \"semaine-matin\": \"Semaine (Matin)\",\n  \"semaine-apres-midi\": \"Semaine (Après-midi)\",\n  weekend: \"Week-end\",\n};\n\nfunction formatPhoneNumber(phone: string): string {\n  // Nettoyer le numéro\n  const cleaned = phone.replace(/\\D/g, \"\");\n  // Si commence par 221, retirer\n  const withoutCountry = cleaned.startsWith(\"221\") ? cleaned.slice(3) : cleaned;\n  // Formater comme 77 000 00 00\n  if (withoutCountry.length === 9) {\n    return `${withoutCountry.slice(0, 2)} ${withoutCountry.slice(2, 5)} ${withoutCountry.slice(5, 7)} ${withoutCountry.slice(7)}`;\n  }\n  return phone;\n}\n\nfunction getWhatsAppUrl(phone: string): string {\n  const cleaned = phone.replace(/\\D/g, \"\");\n  const number = cleaned.startsWith(\"221\") ? cleaned : `221${cleaned}`;\n  return `https://wa.me/${number}`;\n}\n\nfunction isNewLead(createdAt: string): boolean {\n  const now = new Date();\n  const created = new Date(createdAt);\n  const diffHours = (now.getTime() - created.getTime()) / (1000 * 60 * 60);\n  return diffHours < 24;\n}\n\nexport default async function AdminLeadsPage() {\n  await requireAnyRole([\"admin\", \"moderateur\", \"agent\", \"superadmin\"]);\n  const leads = await getLeads();\n\n  return (\n    <div className=\"space-y-6 py-6\">\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/40\">\n            Admin\n          </p>\n          <h1 className=\"text-3xl font-semibold text-white\">\n            Gestion des Leads\n          </h1>\n          <p className=\"mt-2 text-sm text-white/60\">\n            {leads.length} demande{leads.length > 1 ? \"s\" : \"\"} de contact\n          </p>\n        </div>\n        <div className=\"flex gap-3\">\n          <Button variant=\"secondary\" className=\"rounded-full\" asChild>\n            <Link href=\"/admin/dashboard\">Retour</Link>\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"overflow-hidden rounded-3xl border border-white/10 bg-white/5\">\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full text-left text-sm text-white/80\">\n            <thead className=\"bg-white/10 text-xs uppercase tracking-[0.3em] text-white/40\">\n              <tr>\n                <th className=\"px-4 py-3\">Date</th>\n                <th className=\"px-4 py-3\">Nom</th>\n                <th className=\"px-4 py-3\">Téléphone</th>\n                <th className=\"px-4 py-3\">Projet</th>\n                <th className=\"px-4 py-3\">Message</th>\n                <th className=\"px-4 py-3\">Statut</th>\n                <th className=\"px-4 py-3\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {leads.map((lead) => {\n                const isNew = isNewLead(lead.created_at);\n                return (\n                  <tr\n                    key={lead.id}\n                    className=\"border-t border-white/5 bg-transparent transition hover:bg-white/5\"\n                  >\n                    <td className=\"px-4 py-4\">\n                      <div className=\"flex flex-col\">\n                        <span className=\"text-xs text-white/60\">\n                          {formatDistanceToNow(new Date(lead.created_at), {\n                            addSuffix: true,\n                          })}\n                        </span>\n                        <span className=\"text-xs text-white/40\">\n                          {new Date(lead.created_at).toLocaleDateString(\"fr-FR\", {\n                            day: \"2-digit\",\n                            month: \"2-digit\",\n                            year: \"numeric\",\n                            hour: \"2-digit\",\n                            minute: \"2-digit\",\n                          })}\n                        </span>\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"font-semibold text-white\">\n                          {lead.full_name}\n                        </span>\n                        {isNew && (\n                          <span className=\"rounded-full bg-red-500 px-2 py-0.5 text-[10px] font-bold text-white\">\n                            Nouveau\n                          </span>\n                        )}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <a\n                        href={`tel:${lead.phone}`}\n                        className=\"text-white/80 hover:text-white transition\"\n                      >\n                        {formatPhoneNumber(lead.phone)}\n                      </a>\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <div className=\"flex flex-col gap-1\">\n                        <span className=\"text-xs text-white/60 capitalize\">\n                          {lead.project_type}\n                        </span>\n                        {lead.availability && (\n                          <span className=\"text-xs text-white/40\">\n                            {availabilityLabels[lead.availability] || lead.availability}\n                          </span>\n                        )}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-4 w-[140px] max-w-[140px]\">\n                      <LeadMessageDialog\n                        fullName={lead.full_name}\n                        message={lead.message}\n                        projectType={lead.project_type}\n                        availability={availabilityLabels[lead.availability] || lead.availability}\n                      />\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <LeadStatusSelect\n                        leadId={lead.id}\n                        currentStatus={lead.status}\n                      />\n                    </td>\n                    <td className=\"px-4 py-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          size=\"sm\"\n                          className=\"rounded-full bg-emerald-500 text-white hover:bg-emerald-600\"\n                          asChild\n                        >\n                          <a\n                            href={getWhatsAppUrl(lead.phone)}\n                            target=\"_blank\"\n                            rel=\"noopener noreferrer\"\n                            className=\"inline-flex items-center gap-1.5\"\n                          >\n                            <MessageCircle className=\"h-4 w-4\" />\n                            WhatsApp\n                          </a>\n                        </Button>\n                      </div>\n                    </td>\n                  </tr>\n                );\n              })}\n              {leads.length === 0 && (\n                <tr>\n                  <td\n                    colSpan={7}\n                    className=\"px-4 py-8 text-center text-white/60\"\n                  >\n                    Aucune demande de contact pour le moment.\n                  </td>\n                </tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\moderation\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\moderation\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\moderation\\notification.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\moderation\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'motion' is defined but never used.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setRejectingIds' is assigned a value but never used.","line":90,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":90,"endColumn":39}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperties'. Either include it or remove the dependency array.","line":151,"column":6,"nodeType":"ArrayExpression","endLine":151,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [user, authLoading, loadingRoles, canModerate, loadProperties]","fix":{"range":[5473,5519],"text":"[user, authLoading, loadingRoles, canModerate, loadProperties]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState, useCallback, useMemo } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { toast } from \"sonner\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport {\n  Filter,\n  SortAsc,\n  SortDesc,\n  Search,\n  Clock,\n  CheckCircle2,\n  XCircle,\n} from \"lucide-react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { moderateProperty, certifyAdAndDocument } from \"./actions\";\nimport { ModerationNotification } from \"@/app/admin/moderation/notification\";\nimport { RejectDialog } from \"./reject-dialog\";\nimport { PropertyModerationCard } from \"./property-card\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { useUserRoles } from \"@/hooks/use-user-roles\";\n\ntype PropertyToModerate = {\n  id: string;\n  title: string;\n  price: number;\n  images: string[];\n  location: { city: string; district: string };\n  validation_status: string;\n  service_type: string;\n  payment_ref: string | null;\n  owner_id: string;\n  created_at?: string;\n  proof_document_url?: string | null;\n};\n\ntype SortOption = \"date_asc\" | \"date_desc\" | \"price_asc\" | \"price_desc\";\ntype FilterStatus = \"all\" | \"pending\" | \"payment_pending\";\ntype FilterService = \"all\" | \"mandat_confort\" | \"boost_visibilite\";\n\nexport default function ModerationPage() {\n  const { user, loading: authLoading } = useAuth();\n  const router = useRouter();\n  const { roles: userRoles, loading: loadingRoles } = useUserRoles(user?.id || null);\n  const [properties, setProperties] = useState<PropertyToModerate[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [rejectDialogOpen, setRejectDialogOpen] = useState(false);\n  const [selectedPropertyId, setSelectedPropertyId] = useState<string | null>(null);\n\n  // Vérifier que l'utilisateur a le droit d'accéder à la modération\n  const isMainAdmin = user?.email?.toLowerCase() === \"barrymohamadou98@gmail.com\".toLowerCase();\n  const canModerate = isMainAdmin || userRoles.some((role) => [\"admin\", \"moderateur\", \"superadmin\"].includes(role));\n\n  // Le layout admin vérifie déjà l'accès côté serveur avec requireAnyRole()\n  // On ne fait qu'une vérification côté client pour l'UX (afficher un message si pas de droits)\n  // mais on ne redirige pas car le serveur a déjà autorisé l'accès\n  useEffect(() => {\n    // Attendre que les rôles soient chargés\n    if (authLoading || loadingRoles) {\n      return;\n    }\n\n    if (!user) {\n      return; // Le layout gère déjà la redirection\n    }\n\n    // Vérifier l'accès pour l'UX (affichage conditionnel)\n    const currentCanModerate = isMainAdmin || userRoles.some((role) => [\"admin\", \"moderateur\", \"superadmin\"].includes(role));\n\n    if (currentCanModerate) {\n      // Accès autorisé\n    } else {\n      // Si le serveur a autorisé mais que côté client on n'a pas de rôles,\n      // c'est probablement un problème de timing. On attend un peu.\n      console.warn(\"⚠️ Modération - Rôles non chargés côté client, mais serveur a autorisé\", {\n        email: user.email,\n        roles: userRoles,\n        loadingRoles,\n      });\n    }\n  }, [user, authLoading, loadingRoles, userRoles, isMainAdmin]);\n\n  // États pour les actions en cours\n  const [approvingIds, setApprovingIds] = useState<Set<string>>(new Set());\n  const [rejectingIds, setRejectingIds] = useState<Set<string>>(new Set());\n\n  // États pour filtres et tri\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterStatus, setFilterStatus] = useState<FilterStatus>(\"all\");\n  const [filterService, setFilterService] = useState<FilterService>(\"all\");\n  const [sortBy, setSortBy] = useState<SortOption>(\"date_asc\");\n\n  const loadProperties = useCallback(async () => {\n    if (!user) return;\n\n    setLoading(true);\n    try {\n      const supabase = createClient();\n\n      const { data, error } = await supabase\n        .from(\"properties\")\n        .select(\"*\")\n        .eq(\"is_agency_listing\", false)\n        .in(\"validation_status\", [\"pending\", \"payment_pending\"])\n        .order(\"created_at\", { ascending: true });\n\n      if (error) {\n        console.error(\"❌ Error loading properties for moderation:\", {\n          errorObject: error,\n          message: error.message,\n          code: error.code,\n          details: error.details,\n          hint: error.hint,\n          stringified: JSON.stringify(error, null, 2)\n        });\n        toast.error(`Erreur: ${error.message || \"Impossible de charger les annonces\"}`);\n        setLoading(false);\n        return;\n      }\n\n      const propertiesWithLocation = (data || []).map((p) => ({\n        ...p,\n        location: p.location as { city: string; district: string },\n        images: (p.images as string[]) || [],\n      }));\n\n      setProperties(propertiesWithLocation);\n      setLoading(false);\n    } catch (err) {\n      console.error(\"❌ Unexpected error loading properties:\", {\n        error: err,\n        message: err instanceof Error ? err.message : String(err),\n        stack: err instanceof Error ? err.stack : undefined\n      });\n      toast.error(\"Erreur inattendue lors du chargement\");\n      setLoading(false);\n    }\n  }, [user]);\n\n  useEffect(() => {\n    // Attendre que l'authentification et les rôles soient chargés avant de charger les propriétés\n    if (user && !authLoading && !loadingRoles && canModerate) {\n      loadProperties();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [user, authLoading, loadingRoles, canModerate]);\n\n  useEffect(() => {\n    if (!authLoading && !user) {\n      router.push(\"/login?redirect=/admin/moderation\");\n    }\n  }, [user, authLoading, router]);\n\n  // Filtrage et tri des propriétés\n  const filteredAndSortedProperties = useMemo(() => {\n    let filtered = [...properties];\n\n    // Filtre par recherche\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      filtered = filtered.filter(\n        (p) =>\n          p.title.toLowerCase().includes(query) ||\n          p.location.city.toLowerCase().includes(query) ||\n          p.location.district?.toLowerCase().includes(query) ||\n          p.payment_ref?.toLowerCase().includes(query)\n      );\n    }\n\n    // Filtre par statut\n    if (filterStatus !== \"all\") {\n      filtered = filtered.filter(\n        (p) => p.validation_status === filterStatus\n      );\n    }\n\n    // Filtre par service\n    if (filterService !== \"all\") {\n      filtered = filtered.filter((p) => p.service_type === filterService);\n    }\n\n    // Tri\n    filtered.sort((a, b) => {\n      switch (sortBy) {\n        case \"date_asc\":\n          return new Date(a.created_at || 0).getTime() - new Date(b.created_at || 0).getTime();\n        case \"date_desc\":\n          return new Date(b.created_at || 0).getTime() - new Date(a.created_at || 0).getTime();\n        case \"price_asc\":\n          return a.price - b.price;\n        case \"price_desc\":\n          return b.price - a.price;\n        default:\n          return 0;\n      }\n    });\n\n    return filtered;\n  }, [properties, searchQuery, filterStatus, filterService, sortBy]);\n\n  const handleApprove = async (propertyId: string) => {\n    if (!confirm(\"Confirmez-vous la validation de cette annonce ?\")) {\n      return;\n    }\n\n    setApprovingIds((prev) => new Set(prev).add(propertyId));\n    try {\n      // Find the property to get its document ID\n      const property = properties.find(p => p.id === propertyId);\n      const documentId = property?.proof_document_url || null;\n\n      // Use certifyAdAndDocument if there's a document, otherwise use moderateProperty\n      const result = documentId\n        ? await certifyAdAndDocument(propertyId, documentId)\n        : await moderateProperty(propertyId, \"approved\");\n\n      if (result.error) {\n        toast.error(\"Erreur\", { description: result.error });\n      } else {\n        toast.success(\"Annonce validée !\", {\n          description: documentId\n            ? \"L'annonce et le document ont été certifiés ✅\"\n            : \"L'annonce est maintenant en ligne.\",\n        });\n        await loadProperties();\n      }\n    } catch (error) {\n      console.error(error);\n      toast.error(\"Erreur lors de la validation\");\n    } finally {\n      setApprovingIds((prev) => {\n        const next = new Set(prev);\n        next.delete(propertyId);\n        return next;\n      });\n    }\n  };\n\n  const handleRejectClick = (propertyId: string) => {\n    setSelectedPropertyId(propertyId);\n    setRejectDialogOpen(true);\n  };\n\n  const handleRejectSuccess = () => {\n    loadProperties();\n    setRejectDialogOpen(false);\n    setSelectedPropertyId(null);\n  };\n\n  // Statistiques\n  const stats = useMemo(() => {\n    const total = properties.length;\n    const pending = properties.filter((p) => p.validation_status === \"pending\").length;\n    const paymentPending = properties.filter(\n      (p) => p.validation_status === \"payment_pending\"\n    ).length;\n    return { total, pending, paymentPending };\n  }, [properties]);\n\n  // Le layout admin vérifie déjà l'accès côté serveur avec requireAnyRole()\n  // On affiche le contenu même si les rôles ne sont pas encore chargés côté client\n  // pour éviter un flash de contenu vide\n  if (authLoading || loadingRoles || loading) {\n    return (\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\n        <div className=\"text-white/70\">Chargement...</div>\n      </div>\n    );\n  }\n\n  // Si l'utilisateur n'est pas connecté, le layout gère déjà la redirection\n  if (!user) {\n    return null;\n  }\n\n  // Si les rôles sont chargés et que l'utilisateur n'a pas les droits,\n  // on affiche un message (mais normalement le serveur aurait déjà bloqué)\n  if (!loadingRoles && !canModerate) {\n    return (\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\n        <div className=\"text-center\">\n          <p className=\"text-lg text-white/70\">Accès non autorisé</p>\n          <p className=\"mt-2 text-sm text-white/50\">\n            Vous n&apos;avez pas les permissions nécessaires pour accéder à cette page.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 py-6\">\n      <ModerationNotification />\n\n      {/* Header avec statistiques */}\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/40\">\n            Admin · Modération\n          </p>\n          <h1 className=\"text-3xl font-semibold text-white\">\n            Modération des annonces\n          </h1>\n        </div>\n        <Button variant=\"secondary\" className=\"rounded-full\" asChild>\n          <Link href=\"/admin/dashboard\">Retour au dashboard</Link>\n        </Button>\n      </div>\n\n      {/* Statistiques */}\n      <div className=\"grid gap-4 sm:grid-cols-3\">\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 p-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"rounded-full bg-primary/20 p-2\">\n              <Clock className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <p className=\"text-xs text-white/60\">Total en attente</p>\n              <p className=\"text-2xl font-bold text-white\">{stats.total}</p>\n            </div>\n          </div>\n        </div>\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 p-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"rounded-full bg-blue-500/20 p-2\">\n              <CheckCircle2 className=\"h-5 w-5 text-blue-400\" />\n            </div>\n            <div>\n              <p className=\"text-xs text-white/60\">En attente</p>\n              <p className=\"text-2xl font-bold text-white\">{stats.pending}</p>\n            </div>\n          </div>\n        </div>\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 p-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"rounded-full bg-emerald-500/20 p-2\">\n              <XCircle className=\"h-5 w-5 text-emerald-400\" />\n            </div>\n            <div>\n              <p className=\"text-xs text-white/60\">Paiement en attente</p>\n              <p className=\"text-2xl font-bold text-white\">{stats.paymentPending}</p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Filtres et recherche */}\n      <div className=\"space-y-4 rounded-2xl border border-white/10 bg-white/5 p-4\">\n        {/* Recherche */}\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-white/40\" />\n          <Input\n            placeholder=\"Rechercher par titre, ville, quartier ou référence...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10 bg-white/5 border-white/10 text-white placeholder:text-white/40\"\n          />\n        </div>\n\n        {/* Filtres et tri */}\n        <div className=\"flex flex-wrap gap-2\">\n          {/* Filtre statut */}\n          <div className=\"flex items-center gap-2\">\n            <Filter className=\"h-4 w-4 text-white/40\" />\n            <span className=\"text-sm text-white/60\">Statut:</span>\n            <div className=\"flex gap-1\">\n              {([\"all\", \"pending\", \"payment_pending\"] as FilterStatus[]).map((status) => (\n                <Button\n                  key={status}\n                  variant={filterStatus === status ? \"secondary\" : \"ghost\"}\n                  size=\"sm\"\n                  onClick={() => setFilterStatus(status)}\n                  className={`rounded-full text-xs ${filterStatus === status\n                    ? \"bg-primary text-black\"\n                    : \"text-white/70 hover:text-white\"\n                    }`}\n                >\n                  {status === \"all\"\n                    ? \"Tous\"\n                    : status === \"pending\"\n                      ? \"En attente\"\n                      : \"Paiement\"}\n                </Button>\n              ))}\n            </div>\n          </div>\n\n          {/* Filtre service */}\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-sm text-white/60\">Service:</span>\n            <div className=\"flex gap-1\">\n              {([\"all\", \"mandat_confort\", \"boost_visibilite\"] as FilterService[]).map(\n                (service) => (\n                  <Button\n                    key={service}\n                    variant={filterService === service ? \"secondary\" : \"ghost\"}\n                    size=\"sm\"\n                    onClick={() => setFilterService(service)}\n                    className={`rounded-full text-xs ${filterService === service\n                      ? \"bg-primary text-black\"\n                      : \"text-white/70 hover:text-white\"\n                      }`}\n                  >\n                    {service === \"all\"\n                      ? \"Tous\"\n                      : service === \"mandat_confort\"\n                        ? \"Mandat\"\n                        : \"Diffusion\"}\n                  </Button>\n                )\n              )}\n            </div>\n          </div>\n\n          {/* Tri */}\n          <div className=\"flex items-center gap-2 ml-auto\">\n            <span className=\"text-sm text-white/60\">Trier:</span>\n            <div className=\"flex gap-1\">\n              {([\"date_asc\", \"date_desc\", \"price_asc\", \"price_desc\"] as SortOption[]).map(\n                (sort) => (\n                  <Button\n                    key={sort}\n                    variant={sortBy === sort ? \"secondary\" : \"ghost\"}\n                    size=\"sm\"\n                    onClick={() => setSortBy(sort)}\n                    className={`rounded-full text-xs ${sortBy === sort\n                      ? \"bg-primary text-black\"\n                      : \"text-white/70 hover:text-white\"\n                      }`}\n                  >\n                    {sort === \"date_asc\" ? (\n                      <SortAsc className=\"h-3 w-3\" />\n                    ) : sort === \"date_desc\" ? (\n                      <SortDesc className=\"h-3 w-3\" />\n                    ) : sort === \"price_asc\" ? (\n                      \"Prix ↑\"\n                    ) : (\n                      \"Prix ↓\"\n                    )}\n                  </Button>\n                )\n              )}\n            </div>\n          </div>\n        </div>\n\n        {/* Résultats */}\n        <p className=\"text-sm text-white/60\">\n          {filteredAndSortedProperties.length} annonce\n          {filteredAndSortedProperties.length > 1 ? \"s\" : \"\"} trouvée\n          {filteredAndSortedProperties.length > 1 ? \"s\" : \"\"}\n        </p>\n      </div>\n\n      {/* Liste des annonces */}\n      {filteredAndSortedProperties.length === 0 ? (\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 p-12 text-center\">\n          <p className=\"text-lg text-white/70\">\n            {properties.length === 0\n              ? \"Aucune annonce en attente de modération\"\n              : \"Aucune annonce ne correspond aux filtres\"}\n          </p>\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n          <AnimatePresence mode=\"popLayout\">\n            {filteredAndSortedProperties.map((property) => (\n              <PropertyModerationCard\n                key={property.id}\n                property={property}\n                onApprove={handleApprove}\n                onReject={handleRejectClick}\n                isApproving={approvingIds.has(property.id)}\n                isRejecting={rejectingIds.has(property.id)}\n              />\n            ))}\n          </AnimatePresence>\n        </div>\n      )}\n\n      {/* Dialog de refus */}\n      {selectedPropertyId && (\n        <RejectDialog\n          propertyId={selectedPropertyId}\n          open={rejectDialogOpen}\n          onOpenChange={setRejectDialogOpen}\n          onSuccess={handleRejectSuccess}\n        />\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\moderation\\property-card.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":233,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":233,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\nimport { motion } from \"framer-motion\";\nimport { toast } from \"sonner\";\nimport {\n  CheckCircle2,\n  XCircle,\n  Eye,\n  Calendar,\n  CreditCard,\n  Loader2,\n  ExternalLink,\n  FileText,\n  Shield,\n} from \"lucide-react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { formatCurrency } from \"@/lib/utils\";\n\ntype PropertyModerationCardProps = {\n  property: {\n    id: string;\n    title: string;\n    price: number;\n    images: string[];\n    location: { city: string; district: string };\n    validation_status: string;\n    service_type: string;\n    payment_ref: string | null;\n    owner_id: string;\n    created_at?: string;\n    proof_document_url?: string | null;\n  };\n  onApprove: (id: string) => Promise<void>;\n  onReject: (id: string) => void;\n  isApproving?: boolean;\n  isRejecting?: boolean;\n};\n\nexport function PropertyModerationCard({\n  property,\n  onApprove,\n  onReject,\n  isApproving = false,\n  isRejecting = false,\n}: PropertyModerationCardProps) {\n  const [imageError, setImageError] = useState(false);\n\n  const formatDate = (dateString?: string) => {\n    if (!dateString) return \"Date inconnue\";\n    try {\n      return new Date(dateString).toLocaleDateString(\"fr-FR\", {\n        day: \"numeric\",\n        month: \"short\",\n        year: \"numeric\",\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n      });\n    } catch {\n      return \"Date invalide\";\n    }\n  };\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      className=\"group overflow-hidden rounded-2xl border border-white/10 bg-white/5 transition-all hover:border-white/20 hover:bg-white/10\"\n    >\n      <div className=\"grid gap-4 p-6 md:grid-cols-[180px_1fr_auto] lg:grid-cols-[200px_1fr_auto]\">\n        {/* Image */}\n        <div className=\"relative h-40 w-full overflow-hidden rounded-xl md:h-full md:min-h-[180px]\">\n          {property.images?.[0] && !imageError ? (\n            <Image\n              src={property.images[0]}\n              alt={property.title}\n              fill\n              sizes=\"(max-width: 768px) 100vw, 180px\"\n              className=\"object-cover transition-transform group-hover:scale-105\"\n              onError={() => setImageError(true)}\n            />\n          ) : (\n            <div className=\"flex h-full w-full items-center justify-center bg-white/5\">\n              <Eye className=\"h-8 w-8 text-white/20\" />\n            </div>\n          )}\n          {property.images && property.images.length > 1 && (\n            <div className=\"absolute right-2 top-2 rounded-full bg-black/60 px-2 py-1 text-xs text-white\">\n              +{property.images.length - 1}\n            </div>\n          )}\n        </div>\n\n        {/* Informations principales */}\n        <div className=\"space-y-3\">\n          <div className=\"flex items-start justify-between gap-4\">\n            <div className=\"flex-1 min-w-0\">\n              <h3 className=\"text-lg font-semibold text-white line-clamp-2 group-hover:text-amber-400 transition-colors\">\n                {property.title}\n              </h3>\n              <p className=\"mt-1 text-sm text-white/60 flex items-center gap-1\">\n                <span>{property.location.city}</span>\n                {property.location.district && (\n                  <>\n                    <span>•</span>\n                    <span>{property.location.district}</span>\n                  </>\n                )}\n              </p>\n              <p className=\"mt-2 text-xl font-bold text-amber-400\">\n                {formatCurrency(property.price)} FCFA\n              </p>\n            </div>\n            <span\n              className={`shrink-0 rounded-full px-3 py-1 text-xs font-semibold ${property.validation_status === \"payment_pending\"\n                  ? \"bg-blue-500/20 text-blue-300 border border-blue-500/30\"\n                  : \"bg-amber-500/20 text-amber-300 border border-amber-500/30\"\n                }`}\n            >\n              {property.validation_status === \"payment_pending\"\n                ? \"Paiement en attente\"\n                : \"En attente\"}\n            </span>\n          </div>\n\n          {/* Métadonnées */}\n          <div className=\"flex flex-wrap gap-4 text-sm text-white/70\">\n            <div className=\"flex items-center gap-1.5\">\n              <Calendar className=\"h-4 w-4 text-white/40\" />\n              <span>{formatDate(property.created_at)}</span>\n            </div>\n            <div className=\"flex items-center gap-1.5\">\n              <CreditCard className=\"h-4 w-4 text-white/40\" />\n              <span>\n                {property.service_type === \"mandat_confort\"\n                  ? \"Mandat Agence\"\n                  : \"Diffusion Simple\"}\n              </span>\n            </div>\n            {property.payment_ref && (\n              <div className=\"flex items-center gap-1.5 text-emerald-300\">\n                <CheckCircle2 className=\"h-4 w-4\" />\n                <span className=\"font-mono text-xs\">{property.payment_ref}</span>\n              </div>\n            )}\n          </div>\n\n          {/* Actions rapides */}\n          <div className=\"flex flex-wrap gap-2 pt-2\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-8 rounded-full text-xs\"\n              asChild\n            >\n              <Link\n                href={`/biens/${property.id}`}\n                target=\"_blank\"\n                className=\"flex items-center gap-1\"\n              >\n                <ExternalLink className=\"h-3 w-3\" />\n                Voir l&apos;annonce\n              </Link>\n            </Button>\n\n            {/* Document preview button */}\n            {property.proof_document_url && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"h-8 rounded-full text-xs text-blue-400 hover:bg-blue-500/10\"\n                onClick={() => window.open(property.proof_document_url!, '_blank')}\n              >\n                <FileText className=\"h-3 w-3 mr-1\" />\n                <Shield className=\"h-3 w-3 mr-1\" />\n                Voir document\n              </Button>\n            )}\n          </div>\n        </div>\n\n        {/* Actions de modération */}\n        <div className=\"flex flex-col gap-2 min-w-[140px]\">\n          <Button\n            onClick={() => onApprove(property.id)}\n            disabled={isApproving || isRejecting}\n            className=\"w-full rounded-full bg-emerald-500 text-white hover:bg-emerald-600 disabled:opacity-50\"\n          >\n            {isApproving ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Validation...\n              </>\n            ) : (\n              <>\n                <CheckCircle2 className=\"mr-2 h-4 w-4\" />\n                Valider\n              </>\n            )}\n          </Button>\n          <Button\n            onClick={() => onReject(property.id)}\n            disabled={isApproving || isRejecting}\n            variant=\"secondary\"\n            className=\"w-full rounded-full border-red-500/20 text-red-300 hover:bg-red-500/10 disabled:opacity-50\"\n          >\n            {isRejecting ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Traitement...\n              </>\n            ) : (\n              <>\n                <XCircle className=\"mr-2 h-4 w-4\" />\n                Refuser\n              </>\n            )}\n          </Button>\n          {property.payment_ref && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"w-full rounded-full text-xs\"\n              onClick={async () => {\n                try {\n                  await navigator.clipboard.writeText(property.payment_ref || \"\");\n                  toast.success(\"Référence copiée\", {\n                    description: property.payment_ref,\n                  });\n                } catch (error) {\n                  toast.error(\"Erreur lors de la copie\");\n                }\n              }}\n            >\n              Copier réf. paiement\n            </Button>\n          )}\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\moderation\\reject-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport { X } from \"lucide-react\";\nimport { toast } from \"sonner\";\n\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { moderatePropertyWithReason } from \"./actions\";\n\ntype RejectDialogProps = {\n  propertyId: string;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onSuccess: () => void;\n};\n\nconst rejectionReasons = [\n  \"Photos floues ou insuffisantes\",\n  \"Prix irréaliste\",\n  \"Preuve de paiement invalide\",\n  \"Informations manquantes ou incorrectes\",\n  \"Contenu inapproprié\",\n  \"Doublon d'annonce\",\n  \"Autre\",\n];\n\nexport function RejectDialog({\n  propertyId,\n  open,\n  onOpenChange,\n  onSuccess,\n}: RejectDialogProps) {\n  const [selectedReason, setSelectedReason] = useState<string>(\"\");\n  const [customReason, setCustomReason] = useState<string>(\"\");\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const handleSubmit = async () => {\n    if (!selectedReason) {\n      toast.error(\"Veuillez sélectionner un motif de refus\");\n      return;\n    }\n\n    const reason = selectedReason === \"Autre\" ? customReason : selectedReason;\n\n    if (!reason || reason.trim().length < 5) {\n      toast.error(\"Veuillez fournir un motif de refus détaillé\");\n      return;\n    }\n\n    setIsSubmitting(true);\n    try {\n      const result = await moderatePropertyWithReason(propertyId, reason);\n      if (result.error) {\n        toast.error(\"Erreur\", { description: result.error });\n      } else {\n        toast.success(\"Annonce refusée\", {\n          description: \"Le propriétaire a été notifié du motif de refus.\",\n        });\n        onOpenChange(false);\n        onSuccess();\n      }\n    } catch (error) {\n      console.error(error);\n      toast.error(\"Erreur lors du refus de l'annonce\");\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"bg-background border-white/10 text-white sm:max-w-[500px]\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl font-semibold\">\n            Refuser l&apos;annonce\n          </DialogTitle>\n          <DialogDescription className=\"text-white/60\">\n            Veuillez indiquer le motif de refus. Cette information sera visible\n            par le propriétaire.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm text-white/80\">Motif de refus</Label>\n            <div className=\"space-y-2\">\n              {rejectionReasons.map((reason) => (\n                <label\n                  key={reason}\n                  className=\"flex items-center gap-2 rounded-lg border border-white/10 bg-white/5 p-3 cursor-pointer hover:bg-white/10 transition-colors\"\n                >\n                  <input\n                    type=\"radio\"\n                    name=\"rejection-reason\"\n                    value={reason}\n                    checked={selectedReason === reason}\n                    onChange={(e) => setSelectedReason(e.target.value)}\n                    className=\"h-4 w-4 text-primary focus:ring-primary focus:ring-offset-0\"\n                  />\n                  <span className=\"text-sm text-white/80\">{reason}</span>\n                </label>\n              ))}\n            </div>\n          </div>\n\n          {selectedReason === \"Autre\" && (\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm text-white/80\">\n                Précisez le motif\n              </Label>\n              <Textarea\n                value={customReason}\n                onChange={(e) => setCustomReason(e.target.value)}\n                placeholder=\"Décrivez le motif de refus...\"\n                className=\"min-h-[100px] bg-white/5 border-white/10 text-white placeholder:text-white/40\"\n                rows={4}\n              />\n            </div>\n          )}\n        </div>\n\n        <DialogFooter className=\"gap-2\">\n          <Button\n            variant=\"secondary\"\n            onClick={() => onOpenChange(false)}\n            disabled={isSubmitting}\n            className=\"rounded-full\"\n          >\n            Annuler\n          </Button>\n          <Button\n            onClick={handleSubmit}\n            disabled={isSubmitting || !selectedReason}\n            className=\"rounded-full bg-red-500 text-white hover:bg-red-600\"\n          >\n            {isSubmitting ? \"Traitement...\" : \"Confirmer le refus\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\roles\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabase' is defined but never used.","line":14,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport { requireAdmin } from \"@/lib/admin-auth\";\nimport { revalidatePath } from \"next/cache\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * Créer une notification quand un rôle est accordé\n */\nasync function createRoleNotification(\n  userId: string,\n  role: UserRole,\n  supabase: SupabaseClient\n) {\n  try {\n    const roleLabels: Record<UserRole, string> = {\n      admin: \"Administrateur\",\n      moderateur: \"Modérateur\",\n      agent: \"Agent\",\n      superadmin: \"Super Administrateur\",\n    };\n\n    // Utiliser notifyUser pour bénéficier du service role client\n    const { notifyUser } = await import(\"@/lib/notifications\");\n    await notifyUser({\n      userId,\n      type: \"success\",\n      title: \"Nouveau rôle accordé\",\n      message: `Le rôle \"${roleLabels[role]}\" vous a été accordé. Vous pouvez maintenant accéder au panel admin.`,\n      resourcePath: \"/admin\",\n    });\n  } catch (notificationError) {\n    console.error(\"Error creating role notification:\", notificationError);\n    // Ne pas bloquer si la notification échoue\n  }\n}\n\n/**\n * Créer une notification quand un rôle est retiré\n */\nasync function createRoleRevokedNotification(\n  userId: string,\n  role: UserRole\n) {\n  try {\n    const roleLabels: Record<UserRole, string> = {\n      admin: \"Administrateur\",\n      moderateur: \"Modérateur\",\n      agent: \"Agent\",\n      superadmin: \"Super Administrateur\",\n    };\n\n    // Utiliser notifyUser pour bénéficier du service role client\n    const { notifyUser } = await import(\"@/lib/notifications\");\n    await notifyUser({\n      userId,\n      type: \"warning\",\n      title: \"Rôle retiré\",\n      message: `Votre rôle \"${roleLabels[role]}\" a été retiré.`,\n      resourcePath: \"/compte\",\n    });\n  } catch (notificationError) {\n    console.error(\"Error creating role revoked notification:\", notificationError);\n    // Ne pas bloquer si la notification échoue\n  }\n}\n\nexport type UserRole = \"admin\" | \"moderateur\" | \"agent\" | \"superadmin\";\n\nexport interface UserWithRole {\n  id: string;\n  email: string;\n  full_name: string | null;\n  phone: string | null;\n  roles: UserRole[];\n  created_at: string;\n}\n\nexport interface UserRoleRecord {\n  id: string;\n  user_id: string;\n  role: UserRole;\n  granted_by: string | null;\n  created_at: string;\n}\n\n/**\n * Récupère tous les utilisateurs avec leurs rôles\n */\nexport async function getUsersWithRoles(): Promise<UserWithRole[]> {\n  await requireAdmin();\n  const supabase = await createClient();\n\n  try {\n    // Essayer d'abord d'utiliser la fonction SQL (si elle existe)\n    const { data: rpcData, error: rpcError } = await supabase.rpc(\"get_users_with_roles\");\n\n    // Si la fonction SQL fonctionne et retourne des données, les utiliser\n    if (!rpcError && rpcData && Array.isArray(rpcData)) {\n      // Mapper les résultats de la fonction SQL (même si le tableau est vide)\n      const mappedData = rpcData.map((row: { id: string; email?: string; full_name?: string; phone?: string; roles?: UserRole[]; created_at?: string }) => ({\n        id: row.id,\n        email: row.email || \"\",\n        full_name: row.full_name || null,\n        phone: row.phone || null,\n        roles: (row.roles || []) as UserRole[],\n        created_at: row.created_at || new Date().toISOString(),\n      }));\n      \n      // Si on a des données, les retourner\n      if (mappedData.length > 0) {\n        return mappedData;\n      }\n      // Si le tableau est vide mais pas d'erreur, la fonction SQL fonctionne mais il n'y a pas d'utilisateurs\n      // On continue avec le fallback pour être sûr\n      console.log(\"Function get_users_with_roles returned empty array, trying fallback...\");\n    }\n    \n    // Si erreur sur la fonction SQL, logger mais continuer avec le fallback\n    if (rpcError) {\n      console.warn(\"Error calling get_users_with_roles function:\", rpcError);\n      console.log(\"Falling back to direct table queries...\");\n    }\n\n    // Fallback: Récupérer tous les user_roles\n    const { data: userRoles, error: rolesError } = await supabase\n      .from(\"user_roles\")\n      .select(\"user_id, role, created_at\")\n      .order(\"created_at\", { ascending: false });\n\n    // Gérer les erreurs (y compris les objets vides)\n    if (rolesError) {\n      const errorCode = rolesError.code || \"\";\n      const errorMessage = rolesError.message || \"\";\n      const errorDetails = rolesError.details || \"\";\n      const errorKeys = Object.keys(rolesError);\n      \n      // Si l'objet d'erreur est vide ou contient des codes d'erreur spécifiques\n      if (\n        errorKeys.length === 0 || // Objet vide = probablement RLS ou table inexistante\n        errorCode === \"42P01\" || // Table n'existe pas\n        errorCode === \"PGRST301\" || // RLS bloque l'accès\n        errorMessage.includes(\"does not exist\") ||\n        errorMessage.includes(\"relation\") ||\n        errorMessage.includes(\"permission denied\") ||\n        errorMessage.includes(\"row-level security\") ||\n        errorDetails.includes(\"does not exist\")\n      ) {\n        console.warn(\"Table user_roles may not exist or RLS is blocking access. Returning empty array.\");\n        return [];\n      }\n      \n      // Autre erreur\n      console.error(\"Error fetching user roles:\", rolesError);\n      return [];\n    }\n\n    // Si pas de user_roles, retourner tableau vide\n    if (!userRoles || userRoles.length === 0) {\n      return [];\n    }\n\n    // Grouper les rôles par user_id\n    const rolesByUserId = new Map<string, UserRole[]>();\n    const userCreatedAt = new Map<string, string>();\n    \n    userRoles.forEach((ur: { user_id?: string; role: string; created_at?: string }) => {\n      if (!ur.user_id) return; // Ignorer les entrées invalides\n\n      if (!rolesByUserId.has(ur.user_id)) {\n        rolesByUserId.set(ur.user_id, []);\n      }\n      rolesByUserId.get(ur.user_id)!.push(ur.role as UserRole);\n      if (ur.created_at && !userCreatedAt.has(ur.user_id)) {\n        userCreatedAt.set(ur.user_id, ur.created_at);\n      }\n    });\n\n    // Récupérer les userIds uniques\n    const userIds = Array.from(rolesByUserId.keys());\n    \n    if (userIds.length === 0) {\n      return [];\n    }\n\n    // Essayer de récupérer depuis une table users publique si elle existe\n    let usersData: { id: string; email?: string; full_name?: string; phone?: string; created_at?: string }[] = [];\n    const { data: usersTableData, error: usersError } = await supabase\n      .from(\"users\")\n      .select(\"id, email, full_name, phone, created_at\")\n      .in(\"id\", userIds);\n\n    if (!usersError && usersTableData) {\n      usersData = usersTableData;\n    }\n\n    // Mapper les résultats\n    const result: UserWithRole[] = [];\n    \n    // Pour chaque userId, créer un objet UserWithRole\n    userIds.forEach((userId) => {\n      const userFromTable = usersData.find((u) => u.id === userId);\n      \n      result.push({\n        id: userId,\n        email: userFromTable?.email || \"\",\n        full_name: userFromTable?.full_name || null,\n        phone: userFromTable?.phone || null,\n        roles: rolesByUserId.get(userId) || [],\n        created_at: userFromTable?.created_at || userCreatedAt.get(userId) || new Date().toISOString(),\n      });\n    });\n\n    // Si on a des utilisateurs dans la table users qui n'ont pas de rôles, les ajouter aussi\n    if (usersData.length > 0) {\n      usersData.forEach((user) => {\n        if (!userIds.includes(user.id)) {\n          result.push({\n            id: user.id,\n            email: user.email || \"\",\n            full_name: user.full_name || null,\n            phone: user.phone || null,\n            roles: [],\n            created_at: user.created_at || new Date().toISOString(),\n          });\n        }\n      });\n    }\n\n    // Si on n'a toujours pas d'utilisateurs, essayer de récupérer TOUS les utilisateurs depuis la table users\n    if (result.length === 0) {\n      console.log(\"No users found with roles, trying to fetch all users from users table...\");\n      const { data: allUsers, error: allUsersError } = await supabase\n        .from(\"users\")\n        .select(\"id, email, full_name, phone, created_at\")\n        .order(\"created_at\", { ascending: false });\n\n      if (allUsersError) {\n        console.warn(\"Error fetching all users:\", allUsersError);\n      } else if (allUsers && allUsers.length > 0) {\n        console.log(`Found ${allUsers.length} users in users table`);\n        // Récupérer les rôles pour ces utilisateurs\n        const allUserIds = allUsers.map((u: { id: string }) => u.id);\n        const { data: allUserRoles } = await supabase\n          .from(\"user_roles\")\n          .select(\"user_id, role\")\n          .in(\"user_id\", allUserIds);\n\n        const rolesMap = new Map<string, UserRole[]>();\n        (allUserRoles || []).forEach((ur: { user_id: string; role: string }) => {\n          if (!rolesMap.has(ur.user_id)) {\n            rolesMap.set(ur.user_id, []);\n          }\n          rolesMap.get(ur.user_id)!.push(ur.role as UserRole);\n        });\n\n        return allUsers.map((user: { id: string; email?: string; full_name?: string; phone?: string; created_at?: string }) => ({\n          id: user.id,\n          email: user.email || \"\",\n          full_name: user.full_name || null,\n          phone: user.phone || null,\n          roles: rolesMap.get(user.id) || [],\n          created_at: user.created_at || new Date().toISOString(),\n        }));\n      } else {\n        console.warn(\"⚠️ IMPORTANT: No users found. The get_users_with_roles() SQL function must be created in Supabase to access auth.users.\");\n        console.warn(\"📝 Please run the SQL script in docs/create-users-function.sql in Supabase SQL Editor.\");\n        console.warn(\"🔗 Or execute the full script in docs/user-roles-table-schema.sql which includes this function.\");\n      }\n    }\n\n    // Trier par date de création (plus récent en premier)\n    return result.sort((a, b) => \n      new Date(b.created_at).getTime() - new Date(a.created_at).getTime()\n    );\n  } catch (error) {\n    console.error(\"Error in getUsersWithRoles:\", error);\n    return [];\n  }\n}\n\n/**\n * Accorde un rôle à un utilisateur\n */\nexport async function grantRole(\n  userId: string,\n  role: UserRole\n): Promise<{ success: boolean; error?: string }> {\n  await requireAdmin();\n  const supabase = await createClient();\n\n  // Récupérer l'utilisateur actuel\n  const {\n    data: { user: currentUser },\n  } = await supabase.auth.getUser();\n\n  if (!currentUser) {\n    return {\n      success: false,\n      error: \"Utilisateur non authentifié\",\n    };\n  }\n\n  // Vérifier que l'utilisateur cible existe\n  const { data: targetUser, error: targetUserError } = await supabase.auth.admin.getUserById(userId);\n  if (targetUserError || !targetUser) {\n    console.error(\"Error fetching target user:\", targetUserError);\n    // Si on ne peut pas récupérer via admin, on continue quand même (peut-être que l'utilisateur existe)\n  }\n\n  // Essayer d'abord via la fonction SQL grant_role (bypass RLS)\n  // La fonction utilise p_role comme paramètre\n  const { error: functionError } = await supabase.rpc(\"grant_role\", {\n    target_user: userId,\n    p_role: role,\n  });\n\n  if (!functionError) {\n    // Créer une notification pour l'utilisateur\n    await createRoleNotification(userId, role, supabase);\n    revalidatePath(\"/admin/roles\");\n    revalidatePath(\"/admin/users\");\n    return { success: true };\n  }\n\n  // Logger l'erreur pour debug\n  console.error(\"Error calling grant_role:\", functionError);\n\n  // Si la fonction n'existe pas, essayer l'ancienne fonction\n  const { data: functionResult, error: oldFunctionError } = await supabase.rpc(\"grant_user_role\", {\n    target_user_id: userId,\n    role_to_grant: role,\n  });\n\n  if (!oldFunctionError && functionResult) {\n    // Créer une notification pour l'utilisateur\n    await createRoleNotification(userId, role, supabase);\n    revalidatePath(\"/admin/roles\");\n    revalidatePath(\"/admin/users\");\n    return { success: true };\n  }\n\n  // Fallback: Insertion directe si la fonction n'existe pas\n  const { error } = await supabase.from(\"user_roles\").insert({\n    user_id: userId,\n    role,\n    granted_by: currentUser.id,\n  });\n\n  if (!error) {\n    // Créer une notification pour l'utilisateur\n    await createRoleNotification(userId, role, supabase);\n    revalidatePath(\"/admin/roles\");\n    revalidatePath(\"/admin/users\");\n    return { success: true };\n  }\n\n  if (error) {\n    console.error(\"Error granting role:\", error);\n    console.error(\"Error details:\", {\n      code: error.code,\n      message: error.message,\n      details: error.details,\n      hint: error.hint,\n    });\n\n    // Si le rôle existe déjà, ce n'est pas une erreur critique\n    if (error.code === \"23505\" || error.message?.includes(\"duplicate\") || error.message?.includes(\"unique\")) {\n      revalidatePath(\"/admin/roles\");\n      revalidatePath(\"/admin/users\");\n      return { success: true };\n    }\n\n    // Erreur RLS (permission denied)\n    if (\n      error.code === \"42501\" ||\n      error.code === \"PGRST301\" ||\n      error.message?.includes(\"permission denied\") ||\n      error.message?.includes(\"row-level security\") ||\n      error.message?.includes(\"policy\")\n    ) {\n      return {\n        success: false,\n        error: \"Permission refusée. Exécutez le script docs/create-grant-role-function.sql pour créer la fonction SQL qui bypass RLS.\",\n      };\n    }\n\n    // Erreur de contrainte de clé étrangère\n    if (error.code === \"23503\" || error.message?.includes(\"foreign key\")) {\n      return {\n        success: false,\n        error: \"L'utilisateur n'existe pas dans auth.users.\",\n      };\n    }\n\n    // Autre erreur\n    return {\n      success: false,\n      error: `Impossible d'accorder le rôle: ${error.message || \"Erreur inconnue\"}`,\n    };\n  }\n\n  revalidatePath(\"/admin/roles\");\n  revalidatePath(\"/admin/users\");\n  return { success: true };\n}\n\n/**\n * Retire un rôle à un utilisateur\n */\nexport async function revokeRole(\n  userId: string,\n  role: UserRole\n): Promise<{ success: boolean; error?: string }> {\n  await requireAdmin();\n  const supabase = await createClient();\n\n  // Essayer d'abord via la fonction SQL revoke_role (bypass RLS)\n  // La fonction utilise p_role comme paramètre\n  const { error: functionError } = await supabase.rpc(\"revoke_role\", {\n    target_user: userId,\n    p_role: role,\n  });\n\n  if (!functionError) {\n    // Créer une notification pour l'utilisateur\n    await createRoleRevokedNotification(userId, role);\n    revalidatePath(\"/admin/roles\");\n    revalidatePath(\"/admin/users\");\n    return { success: true };\n  }\n\n  // Logger l'erreur pour debug\n  console.error(\"Error calling revoke_role:\", functionError);\n\n  // Si la fonction n'existe pas, essayer l'ancienne fonction\n  const { data: functionResult, error: oldFunctionError } = await supabase.rpc(\"revoke_user_role\", {\n    target_user_id: userId,\n    role_to_revoke: role,\n  });\n\n  if (!oldFunctionError && functionResult) {\n    // Créer une notification pour l'utilisateur\n    await createRoleRevokedNotification(userId, role);\n    revalidatePath(\"/admin/roles\");\n    revalidatePath(\"/admin/users\");\n    return { success: true };\n  }\n\n  // Fallback: Suppression directe si la fonction n'existe pas\n  const { error } = await supabase\n    .from(\"user_roles\")\n    .delete()\n    .eq(\"user_id\", userId)\n    .eq(\"role\", role);\n\n  if (!error) {\n    // Créer une notification pour l'utilisateur\n    await createRoleRevokedNotification(userId, role);\n    revalidatePath(\"/admin/roles\");\n    revalidatePath(\"/admin/users\");\n    return { success: true };\n  }\n\n  if (error) {\n    console.error(\"Error revoking role:\", error);\n    console.error(\"Error details:\", {\n      code: error.code,\n      message: error.message,\n      details: error.details,\n      hint: error.hint,\n    });\n\n    // Erreur RLS (permission denied)\n    if (\n      error.code === \"42501\" ||\n      error.code === \"PGRST301\" ||\n      error.message?.includes(\"permission denied\") ||\n      error.message?.includes(\"row-level security\") ||\n      error.message?.includes(\"policy\")\n    ) {\n      return {\n        success: false,\n        error: \"Permission refusée. Exécutez le script docs/create-grant-role-function.sql pour créer la fonction SQL qui bypass RLS.\",\n      };\n    }\n\n    return {\n      success: false,\n      error: `Impossible de retirer le rôle: ${error.message || \"Erreur inconnue\"}`,\n    };\n  }\n\n  revalidatePath(\"/admin/roles\");\n  revalidatePath(\"/admin/users\");\n  return { success: true };\n}\n\n/**\n * Vérifie si un utilisateur a un rôle spécifique\n */\nexport async function hasRole(\n  userId: string,\n  role: UserRole\n): Promise<boolean> {\n  const supabase = await createClient();\n\n  const { data, error } = await supabase\n    .from(\"user_roles\")\n    .select(\"id\")\n    .eq(\"user_id\", userId)\n    .eq(\"role\", role)\n    .single();\n\n  if (error || !data) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Récupère les rôles d'un utilisateur\n */\nexport async function getUserRoles(userId: string): Promise<UserRole[]> {\n  const supabase = await createClient();\n\n  const { data, error } = await supabase\n    .from(\"user_roles\")\n    .select(\"role\")\n    .eq(\"user_id\", userId);\n\n  if (error || !data) {\n    return [];\n  }\n\n  return data.map((r) => r.role as UserRole);\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\roles\\grant-role-action.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":21,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport { requireAdmin } from \"@/lib/admin-auth\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nexport type UserRole = \"admin\" | \"moderateur\" | \"agent\";\r\n\r\n/**\r\n * Accorde un rôle via une fonction SQL (bypass RLS)\r\n */\r\nexport async function grantRoleViaFunction(\r\n  userId: string,\r\n  role: UserRole\r\n): Promise<{ success: boolean; error?: string }> {\r\n  await requireAdmin();\r\n  const supabase = await createClient();\r\n\r\n  try {\r\n    // Utiliser une fonction SQL pour bypass RLS\r\n    const { data, error } = await supabase.rpc(\"grant_user_role\", {\r\n      target_user_id: userId,\r\n      role_to_grant: role,\r\n    });\r\n\r\n    if (error) {\r\n      console.error(\"Error granting role via function:\", error);\r\n      return {\r\n        success: false,\r\n        error: `Erreur: ${error.message || \"Impossible d'accorder le rôle\"}`,\r\n      };\r\n    }\r\n\r\n    revalidatePath(\"/admin/roles\");\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"Error in grantRoleViaFunction:\", error);\r\n    return {\r\n      success: false,\r\n      error: `Erreur: ${error instanceof Error ? error.message : \"Erreur inconnue\"}`,\r\n    };\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\roles\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserPlus' is defined but never used.","line":2,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\nimport { Shield, UserPlus } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\n\nimport { requireAdmin } from \"@/lib/admin-auth\";\nimport { getUsersWithRoles, type UserRole } from \"./actions\";\nimport { Button } from \"@/components/ui/button\";\nimport { RoleManager } from \"./role-manager\";\n\n// Force dynamic rendering\nexport const dynamic = \"force-dynamic\";\n\nconst roleLabels: Record<UserRole, string> = {\n  admin: \"Admin\",\n  moderateur: \"Modérateur\",\n  agent: \"Agent\",\n  superadmin: \"Super Admin\",\n};\n\nconst roleColors: Record<UserRole, string> = {\n  admin: \"bg-red-500/20 text-red-300 border-red-500/30\",\n  moderateur: \"bg-amber-500/20 text-amber-300 border-amber-500/30\",\n  agent: \"bg-blue-500/20 text-blue-300 border-blue-500/30\",\n  superadmin: \"bg-purple-500/20 text-purple-300 border-purple-500/30\",\n};\n\nexport default async function AdminRolesPage() {\n  await requireAdmin();\n  const users = await getUsersWithRoles();\n\n  return (\n    <div className=\"space-y-6 py-6\">\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/40\">\n            Admin\n          </p>\n          <h1 className=\"text-3xl font-semibold text-white\">\n            Gestion des Rôles\n          </h1>\n          <p className=\"mt-2 text-sm text-white/60\">\n            {users.length} utilisateur{users.length > 1 ? \"s\" : \"\"} enregistré{users.length > 1 ? \"s\" : \"\"}\n          </p>\n        </div>\n        <div className=\"flex gap-3\">\n          <Button variant=\"secondary\" className=\"rounded-full\" asChild>\n            <Link href=\"/admin/dashboard\">Retour</Link>\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"overflow-hidden rounded-3xl border border-white/10 bg-white/5\">\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full text-left text-sm text-white/80\">\n            <thead className=\"bg-white/10 text-xs uppercase tracking-[0.3em] text-white/40\">\n              <tr>\n                <th className=\"px-4 py-3\">Utilisateur</th>\n                <th className=\"px-4 py-3\">Email</th>\n                <th className=\"px-4 py-3\">Rôles</th>\n                <th className=\"px-4 py-3\">Inscription</th>\n                <th className=\"px-4 py-3\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {users.map((user) => (\n                <tr\n                  key={user.id}\n                  className=\"border-t border-white/5 bg-transparent transition hover:bg-white/5\"\n                >\n                  <td className=\"px-4 py-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-white/10\">\n                        <Shield className=\"h-5 w-5 text-white/60\" />\n                      </div>\n                      <div>\n                        <p className=\"font-semibold text-white\">\n                          {user.full_name || \"Utilisateur\"}\n                        </p>\n                        {user.phone && (\n                          <p className=\"text-xs text-white/50\">{user.phone}</p>\n                        )}\n                      </div>\n                    </div>\n                  </td>\n                  <td className=\"px-4 py-4\">\n                    <span className=\"text-white/80\">{user.email}</span>\n                  </td>\n                  <td className=\"px-4 py-4\">\n                    <div className=\"flex flex-wrap gap-2\">\n                      {user.roles.length > 0 ? (\n                        user.roles.map((role) => (\n                          <span\n                            key={role}\n                            className={`rounded-full border px-3 py-1 text-xs font-semibold ${\n                              roleColors[role]\n                            }`}\n                          >\n                            {roleLabels[role]}\n                          </span>\n                        ))\n                      ) : (\n                        <span className=\"text-xs text-white/40\">Aucun rôle</span>\n                      )}\n                    </div>\n                  </td>\n                  <td className=\"px-4 py-4\">\n                    <span className=\"text-xs text-white/60\">\n                      {formatDistanceToNow(new Date(user.created_at), {\n                        addSuffix: true,\n                      })}\n                    </span>\n                  </td>\n                  <td className=\"px-4 py-4\">\n                    <RoleManager userId={user.id} currentRoles={user.roles} />\n                  </td>\n                </tr>\n              ))}\n              {users.length === 0 && (\n                <tr>\n                  <td\n                    colSpan={5}\n                    className=\"px-4 py-8 text-center text-white/60\"\n                  >\n                    Aucun utilisateur enregistré.\n                  </td>\n                </tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\roles\\role-manager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\biens\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profilesError' is assigned a value but never used.","line":218,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":218,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { requireAnyRole } from \"@/lib/permissions\";\r\n\r\n/**\r\n * Check if a string is a valid UUID\r\n */\r\nfunction isUUID(str: string): boolean {\r\n    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    return uuidRegex.test(str);\r\n}\r\n\r\n/**\r\n * Approve a property document and verify the specific property\r\n */\r\nexport async function approveProperty(propertyId: string, docId: string) {\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Check permissions\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        // 1. Update property: set verification_status\r\n        const { error: propertyError } = await supabase\r\n            .from(\"properties\")\r\n            .update({\r\n                verification_status: \"verified\"\r\n            })\r\n            .eq(\"id\", propertyId);\r\n\r\n        if (propertyError) {\r\n            console.error(\"❌ Error updating property:\", propertyError);\r\n            return {\r\n                success: false,\r\n                error: `Erreur lors de la mise à jour du bien: ${propertyError.message}`\r\n            };\r\n        }\r\n\r\n        // 2. Update document: mark as certified (if it exists in user_documents)\r\n        const { error: docError } = await supabase\r\n            .from(\"user_documents\")\r\n            .update({\r\n                is_certified: true,\r\n                source: \"verification\"\r\n            })\r\n            .eq(\"id\", docId);\r\n\r\n        if (docError) {\r\n            console.log(\"⚠️ Could not update document (may not exist in user_documents):\", docError);\r\n        }\r\n\r\n        // 3. Revalidate paths\r\n        revalidatePath(\"/admin/verifications/biens\");\r\n        revalidatePath(\"/admin/moderation\");\r\n        revalidatePath(`/biens/${propertyId}`);\r\n\r\n        console.log(`✅ Property verified: ${propertyId}`);\r\n\r\n        return {\r\n            success: true,\r\n            message: \"Bien vérifié avec succès\"\r\n        };\r\n    } catch (error) {\r\n        console.error(\"❌ approveProperty error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Une erreur est survenue\"\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Reject a property document with reason\r\n */\r\nexport async function rejectProperty(propertyId: string, docId: string, reason: string) {\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Check permissions\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        // Update document with rejection info (if it exists)\r\n        await supabase\r\n            .from(\"user_documents\")\r\n            .update({\r\n                is_certified: false,\r\n                rejection_reason: reason\r\n            })\r\n            .eq(\"id\", docId);\r\n\r\n        // Update property verification_status to indicate rejection\r\n        await supabase\r\n            .from(\"properties\")\r\n            .update({ verification_status: \"rejected\" })\r\n            .eq(\"id\", propertyId);\r\n\r\n        revalidatePath(\"/admin/verifications/biens\");\r\n\r\n        console.log(`⚠️ Property document rejected: ${propertyId}. Reason: ${reason}`);\r\n\r\n        return {\r\n            success: true,\r\n            message: \"Document rejeté\"\r\n        };\r\n    } catch (error) {\r\n        console.error(\"❌ rejectProperty error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Une erreur est survenue\"\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Revoke property certification\r\n */\r\nexport async function revokePropertyCertification(propertyId: string, reason: string) {\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Check permissions\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        console.log(\"🔄 Revoking certification for property:\", propertyId);\r\n\r\n        // 1. Update property: remove verification\r\n        const { error: propertyError } = await supabase\r\n            .from(\"properties\")\r\n            .update({ verification_status: null })\r\n            .eq(\"id\", propertyId);\r\n\r\n        if (propertyError) {\r\n            console.error(\"❌ Error revoking property certification:\", propertyError);\r\n            return {\r\n                success: false,\r\n                error: `Erreur lors de la révocation: ${propertyError.message}`\r\n            };\r\n        }\r\n\r\n        console.log(\"✅ Property certification revoked\");\r\n\r\n        // 2. Find and uncertify the associated document\r\n        const { data: property } = await supabase\r\n            .from(\"properties\")\r\n            .select(\"proof_document_url\")\r\n            .eq(\"id\", propertyId)\r\n            .single();\r\n\r\n        if (property?.proof_document_url) {\r\n            // Try to find document by ID if it's a UUID\r\n            if (isUUID(property.proof_document_url)) {\r\n                await supabase\r\n                    .from(\"user_documents\")\r\n                    .update({\r\n                        is_certified: false,\r\n                        rejection_reason: reason\r\n                    })\r\n                    .eq(\"id\", property.proof_document_url);\r\n                console.log(\"✅ Document uncertified with reason\");\r\n            }\r\n        }\r\n\r\n        revalidatePath(\"/admin/verifications/biens\");\r\n        revalidatePath(\"/\");\r\n\r\n        console.log(`⚠️ Property certification revoked for ${propertyId}. Reason: ${reason}`);\r\n\r\n        return {\r\n            success: true,\r\n            message: \"Certification révoquée avec succès\"\r\n        };\r\n    } catch (error) {\r\n        console.error(\"❌ revokePropertyCertification error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Une erreur est survenue\"\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get ALL property documents for verification (pending, verified, rejected)\r\n */\r\nexport async function getPendingPropertyDocuments() {\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Check permissions\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        // Fetch ALL properties with documents (not just pending)\r\n        const { data: properties, error: propsError } = await supabase\r\n            .from(\"properties\")\r\n            .select(\"id, title, price, location, images, verification_status, created_at, proof_document_url, owner_id\")\r\n            .not(\"proof_document_url\", \"is\", null)\r\n            .order(\"created_at\", { ascending: false });\r\n\r\n        if (propsError) {\r\n            console.error(\"❌ Error fetching properties:\", propsError);\r\n            return {\r\n                success: false,\r\n                error: propsError.message,\r\n                data: []\r\n            };\r\n        }\r\n\r\n        if (!properties || properties.length === 0) {\r\n            return {\r\n                success: true,\r\n                data: []\r\n            };\r\n        }\r\n\r\n        // Fetch profiles for owners\r\n        const uniqueOwnerIds = [...new Set(properties.map(p => p.owner_id).filter(Boolean))];\r\n        const { data: profiles, error: profilesError } = await supabase\r\n            .from(\"profiles\")\r\n            .select(\"id, full_name, phone, is_identity_verified\")\r\n            .in(\"id\", uniqueOwnerIds);\r\n\r\n        const profilesMap = new Map(profiles?.map(p => [p.id, p]) || []);\r\n\r\n        // For each property, try to find the document\r\n        const propertiesWithDocs = await Promise.all(\r\n            properties.map(async (property) => {\r\n                if (!property.proof_document_url) return null;\r\n\r\n                let docData = null;\r\n                const docId = property.proof_document_url;\r\n\r\n                // Case 1: proof_document_url is a UUID (new system)\r\n                if (isUUID(docId)) {\r\n                    const { data } = await supabase\r\n                        .from(\"user_documents\")\r\n                        .select(\"id, file_name, file_path, file_type, created_at\")\r\n                        .eq(\"id\", docId)\r\n                        .single();\r\n                    docData = data;\r\n                }\r\n                // Case 2: proof_document_url is a file path/URL (legacy system)\r\n                else {\r\n                    // Try to find document by file_path\r\n                    const { data } = await supabase\r\n                        .from(\"user_documents\")\r\n                        .select(\"id, file_name, file_path, file_type, created_at\")\r\n                        .eq(\"file_path\", docId)\r\n                        .single();\r\n\r\n                    docData = data;\r\n\r\n                    // If still not found, create a pseudo-document from the URL\r\n                    if (!docData) {\r\n                        // Extract filename from URL/path\r\n                        const parts = docId.split('/');\r\n                        const fileName = parts[parts.length - 1] || 'document';\r\n\r\n                        docData = {\r\n                            id: property.id, // Use property ID as doc ID for approval/rejection\r\n                            file_name: fileName,\r\n                            file_path: docId,\r\n                            file_type: 'titre_propriete',\r\n                            created_at: property.created_at\r\n                        };\r\n                    }\r\n                }\r\n\r\n                // TypeScript guard: docData should never be null at this point\r\n                if (!docData) {\r\n                    console.error(`❌ No document data found for property ${property.id}`);\r\n                    return null;\r\n                }\r\n\r\n                return {\r\n                    id: property.id,\r\n                    title: property.title,\r\n                    price: property.price,\r\n                    location: property.location,\r\n                    images: property.images,\r\n                    verification_status: property.verification_status,\r\n                    created_at: property.created_at,\r\n                    proof_document_url: property.proof_document_url,\r\n                    owner_id: property.owner_id,\r\n                    profiles: profilesMap.get(property.owner_id) || {\r\n                        id: property.owner_id,\r\n                        full_name: \"Propriétaire inconnu\",\r\n                        phone: undefined\r\n                    },\r\n                    document: {\r\n                        id: docData.id,\r\n                        file_name: docData.file_name,\r\n                        file_type: docData.file_type,\r\n                        file_url: docData.file_path,\r\n                        uploaded_at: docData.created_at\r\n                    }\r\n                };\r\n            })\r\n        );\r\n\r\n        // Filter out nulls\r\n        const validProperties = propertiesWithDocs.filter(p => p !== null);\r\n\r\n        console.log(`✅ Found ${validProperties.length} properties with documents to verify`);\r\n\r\n        return {\r\n            success: true,\r\n            data: validProperties\r\n        };\r\n    } catch (error) {\r\n        console.error(\"❌ getPendingPropertyDocuments error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Une erreur est survenue\",\r\n            data: []\r\n        };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\biens\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\biens\\property-verification-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Phone' is defined but never used.","line":13,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used.","line":24,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport Image from \"next/image\";\r\nimport Link from \"next/link\";\r\nimport { format } from \"date-fns\";\r\nimport { fr } from \"date-fns/locale\";\r\nimport {\r\n    CheckCircle,\r\n    XCircle,\r\n    Eye,\r\n    User,\r\n    Phone,\r\n    MapPin,\r\n    ExternalLink,\r\n    FileText,\r\n    BadgeCheck,\r\n    Home,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { approveProperty, rejectProperty } from \"./actions\";\r\nimport { formatCurrency } from \"@/lib/utils\";\r\n\r\ntype PropertyWithDocument = {\r\n    id: string;\r\n    title: string;\r\n    price: number;\r\n    location: { city?: string; [key: string]: unknown };\r\n    images: string[];\r\n    verification_status: string | null;\r\n    created_at: string;\r\n    proof_document_url: string;\r\n    owner_id: string;\r\n    profiles: {\r\n        id: string;\r\n        full_name: string;\r\n        phone?: string;\r\n        email?: string;\r\n    };\r\n    document: {\r\n        id: string;\r\n        file_name: string;\r\n        file_type: string;\r\n        file_url: string;\r\n        uploaded_at: string;\r\n    };\r\n};\r\n\r\ntype Props = {\r\n    initialProperties: PropertyWithDocument[];\r\n};\r\n\r\nexport function PropertyVerificationList({ initialProperties }: Props) {\r\n    const [properties, setProperties] = useState(initialProperties);\r\n    const [selectedProperty, setSelectedProperty] = useState<PropertyWithDocument | null>(null);\r\n    const [rejectDialogOpen, setRejectDialogOpen] = useState(false);\r\n    const [rejectReason, setRejectReason] = useState(\"\");\r\n    const [processing, setProcessing] = useState(false);\r\n\r\n    const handleApprove = async (property: PropertyWithDocument) => {\r\n        if (!confirm(`Êtes-vous sûr de vouloir vérifier le bien \"${property.title}\" ?`)) {\r\n            return;\r\n        }\r\n\r\n        setProcessing(true);\r\n        try {\r\n            const result = await approveProperty(property.id, property.document.id);\r\n\r\n            if (result.success) {\r\n                toast.success(\"Bien vérifié avec succès\");\r\n                // Remove from list\r\n                setProperties(prev => prev.filter(p => p.id !== property.id));\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors de la vérification\");\r\n            }\r\n        } catch (error) {\r\n            toast.error(\"Une erreur est survenue\");\r\n            console.error(error);\r\n        } finally {\r\n            setProcessing(false);\r\n        }\r\n    };\r\n\r\n    const handleReject = async () => {\r\n        if (!selectedProperty || !rejectReason.trim()) {\r\n            toast.error(\"Veuillez indiquer une raison\");\r\n            return;\r\n        }\r\n\r\n        setProcessing(true);\r\n        try {\r\n            const result = await rejectProperty(selectedProperty.id, selectedProperty.document.id, rejectReason);\r\n\r\n            if (result.success) {\r\n                toast.success(\"Document rejeté\");\r\n                // Remove from list\r\n                setProperties(prev => prev.filter(p => p.id !== selectedProperty.id));\r\n                setRejectDialogOpen(false);\r\n                setRejectReason(\"\");\r\n                setSelectedProperty(null);\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors du rejet\");\r\n            }\r\n        } catch (error) {\r\n            toast.error(\"Une erreur est survenue\");\r\n            console.error(error);\r\n        } finally {\r\n            setProcessing(false);\r\n        }\r\n    };\r\n\r\n    const openRejectDialog = (property: PropertyWithDocument) => {\r\n        setSelectedProperty(property);\r\n        setRejectDialogOpen(true);\r\n    };\r\n\r\n    if (properties.length === 0) {\r\n        return (\r\n            <Card className=\"border-white/10 bg-white/5 p-12 text-center\">\r\n                <BadgeCheck className=\"h-16 w-16 mx-auto mb-4 text-white/20\" />\r\n                <h3 className=\"text-xl font-semibold text-white mb-2\">\r\n                    Aucun bien en attente\r\n                </h3>\r\n                <p className=\"text-white/60\">\r\n                    Tous les documents de propriété ont été traités\r\n                </p>\r\n            </Card>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <div className=\"grid gap-4 md:grid-cols-2\">\r\n                {properties.map((property) => (\r\n                    <Card key={property.id} className=\"border-white/10 bg-white/5 p-6\">\r\n                        {/* Property Image */}\r\n                        <div className=\"relative h-48 rounded-lg overflow-hidden mb-4\">\r\n                            {property.images && property.images.length > 0 ? (\r\n                                <Image\r\n                                    src={property.images[0]}\r\n                                    alt={property.title}\r\n                                    fill\r\n                                    className=\"object-cover\"\r\n                                />\r\n                            ) : (\r\n                                <div className=\"w-full h-full bg-white/10 flex items-center justify-center\">\r\n                                    <Home className=\"h-12 w-12 text-white/20\" />\r\n                                </div>\r\n                            )}\r\n                            <div className=\"absolute top-2 right-2\">\r\n                                <Link\r\n                                    href={`/biens/${property.id}`}\r\n                                    target=\"_blank\"\r\n                                    className=\"flex items-center gap-1 px-2 py-1 rounded bg-black/60 text-white text-xs backdrop-blur-sm hover:bg-black/80\"\r\n                                >\r\n                                    <ExternalLink className=\"h-3 w-3\" />\r\n                                    Voir\r\n                                </Link>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Property Info */}\r\n                        <div className=\"mb-4\">\r\n                            <h3 className=\"font-semibold text-white text-lg mb-2 line-clamp-2\">\r\n                                {property.title}\r\n                            </h3>\r\n                            <div className=\"flex items-center gap-2 text-sm text-white/60 mb-2\">\r\n                                <MapPin className=\"h-4 w-4\" />\r\n                                <span>{property.location?.city || \"Localisation non spécifiée\"}</span>\r\n                            </div>\r\n                            <p className=\"text-xl font-bold text-emerald-400\">\r\n                                {formatCurrency(property.price)}\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Owner Info */}\r\n                        <div className=\"flex items-center gap-2 mb-4 p-3 rounded-lg bg-white/5\">\r\n                            <User className=\"h-4 w-4 text-white/40\" />\r\n                            <div className=\"flex-1 min-w-0\">\r\n                                <p className=\"text-sm font-medium text-white truncate\">\r\n                                    {property.profiles.full_name}\r\n                                </p>\r\n                                {property.profiles.phone && (\r\n                                    <p className=\"text-xs text-white/40\">{property.profiles.phone}</p>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Document Info */}\r\n                        <div className=\"mb-4 p-3 rounded-lg bg-blue-500/10 border border-blue-500/20\">\r\n                            <div className=\"flex items-center gap-2 mb-2\">\r\n                                <FileText className=\"h-4 w-4 text-blue-400\" />\r\n                                <span className=\"text-sm font-medium text-white\">{property.document.file_name}</span>\r\n                            </div>\r\n                            <div className=\"text-xs text-white/40\">\r\n                                Type: {property.document.file_type} • Uploadé le{\" \"}\r\n                                {format(new Date(property.document.uploaded_at), \"dd MMM yyyy\", { locale: fr })}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Actions */}\r\n                        <div className=\"flex gap-2\">\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                className=\"flex-1 border-white/10 text-white hover:bg-white/10\"\r\n                                onClick={() => window.open(property.document.file_url, \"_blank\")}\r\n                            >\r\n                                <Eye className=\"h-4 w-4 mr-1\" />\r\n                                Document\r\n                            </Button>\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                className=\"flex-1 border-emerald-500/20 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20\"\r\n                                onClick={() => handleApprove(property)}\r\n                                disabled={processing}\r\n                            >\r\n                                <CheckCircle className=\"h-4 w-4 mr-1\" />\r\n                                Approuver\r\n                            </Button>\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                className=\"border-red-500/20 bg-red-500/10 text-red-400 hover:bg-red-500/20\"\r\n                                onClick={() => openRejectDialog(property)}\r\n                                disabled={processing}\r\n                            >\r\n                                <XCircle className=\"h-4 w-4\" />\r\n                            </Button>\r\n                        </div>\r\n                    </Card>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Reject Dialog */}\r\n            <Dialog open={rejectDialogOpen} onOpenChange={setRejectDialogOpen}>\r\n                <DialogContent className=\"bg-[#0b0f18] border-white/10\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"text-white\">Rejeter le document</DialogTitle>\r\n                        <DialogDescription className=\"text-white/60\">\r\n                            Veuillez indiquer la raison du rejet pour &quot;{selectedProperty?.title}&quot;\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <Textarea\r\n                        placeholder=\"Raison du rejet...\"\r\n                        value={rejectReason}\r\n                        onChange={(e) => setRejectReason(e.target.value)}\r\n                        className=\"bg-white/5 border-white/10 text-white\"\r\n                        rows={4}\r\n                    />\r\n                    <div className=\"flex gap-2 justify-end\">\r\n                        <Button\r\n                            variant=\"outline\"\r\n                            onClick={() => setRejectDialogOpen(false)}\r\n                            disabled={processing}\r\n                        >\r\n                            Annuler\r\n                        </Button>\r\n                        <Button\r\n                            variant=\"secondary\"\r\n                            onClick={handleReject}\r\n                            disabled={processing || !rejectReason.trim()}\r\n                            className=\"bg-red-600 hover:bg-red-700 text-white\"\r\n                        >\r\n                            Rejeter\r\n                        </Button>\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\identites\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profilesError' is assigned a value but never used.","line":312,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":312,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { requireAnyRole } from \"@/lib/permissions\";\r\nimport { notifyUser } from \"@/lib/notifications\";\r\n\r\n/**\r\n * DEBUG: Get ALL identity documents to see what's in the database\r\n */\r\nexport async function debugGetAllIdentityDocuments() {\r\n    try {\r\n        const supabase = await createClient();\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        const { data, error } = await supabase\r\n            .from(\"user_documents\")\r\n            .select(\"*\")\r\n            .order(\"created_at\", { ascending: false });\r\n\r\n        console.log(\"📋 ALL user_documents:\", data);\r\n        console.log(\"❌ Error if any:\", error);\r\n\r\n        return { data, error };\r\n    } catch (error) {\r\n        console.error(\"Debug error:\", error);\r\n        return { data: null, error };\r\n    }\r\n}\r\n\r\n/**\r\n * Approve an identity document and verify user profile globally\r\n */\r\nexport async function approveIdentity(userId: string, docId: string) {\r\n    const timestamp = new Date().toISOString();\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Check permissions\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        // 1. Update user profile: set is_identity_verified = true\r\n        const { error: profileError } = await supabase\r\n            .from(\"profiles\")\r\n            .update({ is_identity_verified: true })\r\n            .eq(\"id\", userId);\r\n\r\n        if (profileError) {\r\n            console.error(\"❌ Error updating profile:\", profileError);\r\n            return {\r\n                success: false,\r\n                error: `Erreur lors de la mise à jour du profil: ${profileError.message}`\r\n            };\r\n        }\r\n\r\n        // 2. Update document: mark as certified and ensure certification_scope is global\r\n        const { error: docError } = await supabase\r\n            .from(\"user_documents\")\r\n            .update({\r\n                is_certified: true,\r\n                source: \"verification\",\r\n                certification_scope: \"global\"\r\n            })\r\n            .eq(\"id\", docId);\r\n\r\n        if (docError) {\r\n            console.error(\"❌ Error updating document:\", docError);\r\n            return {\r\n                success: false,\r\n                error: `Erreur lors de la mise à jour du document: ${docError.message}`\r\n            };\r\n        }\r\n\r\n        // 2.5. Auto-certify all properties owned by this user\r\n        const { data: updatedProperties, error: propertiesError } = await supabase\r\n            .from(\"properties\")\r\n            .update({ verification_status: \"verified\" })\r\n            .eq(\"owner_id\", userId)\r\n            .select(\"id, title\");\r\n\r\n        if (propertiesError) {\r\n            console.error(\"⚠️ Error auto-certifying properties:\", propertiesError);\r\n        }\r\n\r\n        // 3. Créer une notification pour l'utilisateur\r\n        try {\r\n            await notifyUser({\r\n                userId,\r\n                type: \"success\",\r\n                title: \"Identité vérifiée\",\r\n                message: `Votre pièce d'identité a été vérifiée avec succès. ${updatedProperties && updatedProperties.length > 0 ? `${updatedProperties.length} bien(s) ont été automatiquement certifié(s).` : \"\"}`,\r\n                resourcePath: \"/compte/profil\"\r\n            });\r\n        } catch (notifError) {\r\n            console.error(\"⚠️ Erreur lors de la création de la notification:\", notifError);\r\n            // Ne pas bloquer l'opération si la notification échoue\r\n        }\r\n\r\n        // 4. Revalidate cache - Force aggressive cache invalidation\r\n        revalidatePath(\"/admin/verifications/identites\", \"page\");\r\n        revalidatePath(\"/admin/verifications\", \"layout\");\r\n        revalidatePath(\"/compte/mes-documents\", \"page\");\r\n        revalidatePath(\"/compte/profil\", \"page\");\r\n        revalidatePath(`/profil/${userId}`, \"page\");\r\n\r\n        return {\r\n            success: true,\r\n            message: \"Identité vérifiée avec succès\",\r\n            timestamp, // Add timestamp to verify freshness\r\n            serverExecuted: true\r\n        };\r\n    } catch (error) {\r\n        console.error(\"❌ approveIdentity error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Une erreur est survenue\"\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Reject an identity document with reason\r\n */\r\nexport async function rejectIdentity(userId: string, docId: string, reason: string) {\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Check permissions\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        // Update document with rejection info\r\n        const { error: docError } = await supabase\r\n            .from(\"user_documents\")\r\n            .update({\r\n                is_certified: false\r\n            })\r\n            .eq(\"id\", docId);\r\n\r\n        if (docError) {\r\n            console.error(\"❌ Error rejecting document:\", docError);\r\n            return {\r\n                success: false,\r\n                error: `Erreur lors du rejet du document: ${docError.message}`\r\n            };\r\n        }\r\n\r\n        // Créer une notification pour l'utilisateur\r\n        try {\r\n            await notifyUser({\r\n                userId,\r\n                type: \"warning\",\r\n                title: \"Document rejeté\",\r\n                message: `Votre pièce d'identité a été rejetée. Motif : ${reason}. Veuillez soumettre un nouveau document conforme.`,\r\n                resourcePath: \"/compte/mes-documents\"\r\n            });\r\n        } catch (notifError) {\r\n            console.error(\"⚠️ Erreur lors de la création de la notification:\", notifError);\r\n        }\r\n\r\n        revalidatePath(\"/admin/verifications/identites\");\r\n\r\n        console.log(`⚠️ Identity rejected for user ${userId}, document ${docId}. Reason: ${reason}`);\r\n\r\n        return {\r\n            success: true,\r\n            message: \"Document rejeté\"\r\n        };\r\n    } catch (error) {\r\n        console.error(\"❌ rejectIdentity error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Une erreur est survenue\"\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Revoke identity verification for a user (e.g., if document becomes obsolete)\r\n */\r\nexport async function revokeIdentityVerification(userId: string, reason: string) {\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Check permissions\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        console.log(\"🔄 Revoking identity verification for user:\", userId);\r\n\r\n        // 1. Update user profile: set is_identity_verified = false\r\n        const { error: profileError } = await supabase\r\n            .from(\"profiles\")\r\n            .update({ is_identity_verified: false })\r\n            .eq(\"id\", userId);\r\n\r\n        if (profileError) {\r\n            console.error(\"❌ Error revoking profile verification:\", profileError);\r\n            return {\r\n                success: false,\r\n                error: `Erreur lors de la révocation du profil: ${profileError.message}`\r\n            };\r\n        }\r\n\r\n        console.log(\"✅ Profile verification revoked - is_identity_verified = false\");\r\n\r\n        // 2. Mark all identity documents as uncertified\r\n        const { error: docError } = await supabase\r\n            .from(\"user_documents\")\r\n            .update({ is_certified: false })\r\n            .eq(\"user_id\", userId)\r\n            .eq(\"certification_scope\", \"global\");\r\n\r\n        if (docError) {\r\n            console.error(\"❌ Error uncertifying documents:\", docError);\r\n        } else {\r\n            console.log(\"✅ Identity documents uncertified\");\r\n        }\r\n\r\n        // 3. Remove verification from all user properties\r\n        console.log(\"🔄 Removing verification from all user properties...\");\r\n        const { data: updatedProperties, error: propertiesError } = await supabase\r\n            .from(\"properties\")\r\n            .update({ verification_status: null })\r\n            .eq(\"owner_id\", userId)\r\n            .eq(\"verification_status\", \"verified\")\r\n            .select(\"id, title\");\r\n\r\n        if (propertiesError) {\r\n            console.error(\"⚠️ Error removing property verifications:\", propertiesError);\r\n        } else {\r\n            console.log(`✅ Removed verification from ${updatedProperties?.length || 0} properties:`,\r\n                updatedProperties?.map(p => p.title).join(\", \"));\r\n        }\r\n\r\n        // 4. Créer une notification pour l'utilisateur\r\n        try {\r\n            await notifyUser({\r\n                userId,\r\n                type: \"error\",\r\n                title: \"Vérification d'identité révoquée\",\r\n                message: `Votre vérification d'identité a été révoquée. Motif : ${reason}. ${updatedProperties && updatedProperties.length > 0 ? `${updatedProperties.length} bien(s) ont été décertifié(s).` : \"\"} Veuillez soumettre un nouveau document conforme.`,\r\n                resourcePath: \"/compte/mes-documents\"\r\n            });\r\n        } catch (notifError) {\r\n            console.error(\"⚠️ Erreur lors de la création de la notification:\", notifError);\r\n        }\r\n\r\n        // 5. Revalidate paths\r\n        revalidatePath(\"/admin/verifications/identites\");\r\n        revalidatePath(\"/compte/mes-documents\");\r\n        revalidatePath(\"/compte/profil\");\r\n        revalidatePath(`/profil/${userId}`);\r\n\r\n        console.log(`⚠️ Identity verification revoked for user ${userId}. Reason: ${reason}`);\r\n\r\n        return {\r\n            success: true,\r\n            message: \"Vérification d'identité révoquée avec succès\"\r\n        };\r\n    } catch (error) {\r\n        console.error(\"❌ revokeIdentityVerification error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Une erreur est survenue\"\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get ALL identity documents for verification (pending, verified, rejected)\r\n */\r\nexport async function getPendingIdentityDocuments() {\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Check permissions\r\n        await requireAnyRole([\"admin\", \"superadmin\"]);\r\n\r\n        // Fetch ALL identity documents (not just uncertified)\r\n        const { data: documents, error: docsError } = await supabase\r\n            .from(\"user_documents\")\r\n            .select(\"id, user_id, file_name, file_path, file_type, file_size, mime_type, created_at, source, certification_scope, is_certified\")\r\n            .eq(\"certification_scope\", \"global\")\r\n            .order(\"created_at\", { ascending: false });\r\n\r\n        if (docsError) {\r\n            console.error(\"❌ Error fetching pending documents:\", docsError);\r\n            return {\r\n                success: false,\r\n                error: docsError.message,\r\n                data: []\r\n            };\r\n        }\r\n\r\n        if (!documents || documents.length === 0) {\r\n            return {\r\n                success: true,\r\n                data: []\r\n            };\r\n        }\r\n\r\n        // Fetch profiles for each document\r\n        const userIds = [...new Set(documents.map(d => d.user_id))];\r\n\r\n        if (userIds.length === 0) {\r\n            console.log(\"📋 No user IDs to fetch profiles for\");\r\n            return {\r\n                success: true,\r\n                data: []\r\n            };\r\n        }\r\n\r\n        const { data: profiles, error: profilesError } = await supabase\r\n            .from(\"profiles\")\r\n            .select(\"id, full_name, phone, is_identity_verified, created_at\")\r\n            .in(\"id\", userIds);\r\n\r\n        // Note: Supabase sometimes returns {} as error even when successful, ignore it\r\n\r\n        // Map profiles to documents and generate signed URLs\r\n        const profilesMap = new Map(profiles?.map(p => [p.id, p]) || []);\r\n\r\n        const documentsWithProfiles = await Promise.all(\r\n            documents.map(async (doc) => {\r\n                // Generate signed URL for the document (2 hours for moderation)\r\n                const { data: urlData } = await supabase.storage\r\n                    .from(\"verification-docs\")\r\n                    .createSignedUrl(doc.file_path, 7200); // 2 hours\r\n\r\n                return {\r\n                    id: doc.id,\r\n                    file_name: doc.file_name,\r\n                    file_type: doc.file_type,\r\n                    file_url: urlData?.signedUrl || \"\",\r\n                    file_size: doc.file_size,\r\n                    uploaded_at: doc.created_at,\r\n                    user_id: doc.user_id,\r\n                    is_certified: doc.is_certified || false,\r\n                    profiles: profilesMap.get(doc.user_id) || {\r\n                        id: doc.user_id,\r\n                        full_name: \"Utilisateur inconnu\",\r\n                        phone: null,\r\n                        is_identity_verified: false,\r\n                        created_at: doc.created_at\r\n                    }\r\n                };\r\n            })\r\n        );\r\n\r\n        return {\r\n            success: true,\r\n            data: documentsWithProfiles\r\n        };\r\n    } catch (error) {\r\n        console.error(\"❌ getPendingIdentityDocuments error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Une erreur est survenue\",\r\n            data: []\r\n        };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\identites\\identity-verification-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Image' is defined but never used.","line":4,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport Image from \"next/image\";\r\nimport { format } from \"date-fns\";\r\nimport { fr } from \"date-fns/locale\";\r\nimport {\r\n    CheckCircle,\r\n    XCircle,\r\n    Eye,\r\n    User,\r\n    Mail,\r\n    Phone,\r\n    Calendar,\r\n    FileText,\r\n    BadgeCheck,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { approveIdentity, rejectIdentity } from \"./actions\";\r\n\r\ntype IdentityDocument = {\r\n    id: string;\r\n    file_name: string;\r\n    file_type: string;\r\n    file_url: string;\r\n    file_size: number;\r\n    uploaded_at: string;\r\n    user_id: string;\r\n    is_certified: boolean;\r\n    profiles: {\r\n        id: string;\r\n        full_name: string;\r\n        phone?: string;\r\n        email?: string;\r\n        is_identity_verified: boolean;\r\n        created_at: string;\r\n    };\r\n};\r\n\r\ntype Props = {\r\n    initialDocuments: IdentityDocument[];\r\n    onDocumentUpdate?: (updatedDocs: IdentityDocument[]) => void;\r\n};\r\n\r\nexport function IdentityVerificationList({ initialDocuments, onDocumentUpdate }: Props) {\r\n    const [documents, setDocuments] = useState(initialDocuments);\r\n    const [selectedDoc, setSelectedDoc] = useState<IdentityDocument | null>(null);\r\n    const [rejectDialogOpen, setRejectDialogOpen] = useState(false);\r\n    const [rejectReason, setRejectReason] = useState(\"\");\r\n    const [processing, setProcessing] = useState(false);\r\n\r\n    const handleApprove = async (doc: IdentityDocument) => {\r\n        if (!confirm(`Êtes-vous sûr de vouloir vérifier l'identité de ${doc.profiles.full_name} ?`)) {\r\n            return;\r\n        }\r\n\r\n        setProcessing(true);\r\n        try {\r\n            const result = await approveIdentity(doc.user_id, doc.id);\r\n\r\n            if (result.success) {\r\n                toast.success(\"Identité vérifiée avec succès\");\r\n                // Remove from list\r\n                const updatedDocs = documents.filter(d => d.id !== doc.id);\r\n                setDocuments(updatedDocs);\r\n                onDocumentUpdate?.(updatedDocs);\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors de la vérification\");\r\n            }\r\n        } catch (error) {\r\n            toast.error(\"Une erreur est survenue\");\r\n            console.error(error);\r\n        } finally {\r\n            setProcessing(false);\r\n        }\r\n    };\r\n\r\n    const handleReject = async () => {\r\n        if (!selectedDoc || !rejectReason.trim()) {\r\n            toast.error(\"Veuillez indiquer une raison\");\r\n            return;\r\n        }\r\n\r\n        setProcessing(true);\r\n        try {\r\n            const result = await rejectIdentity(selectedDoc.user_id, selectedDoc.id, rejectReason);\r\n\r\n            if (result.success) {\r\n                toast.success(\"Document rejeté\");\r\n                // Remove from list\r\n                const updatedDocs = documents.filter(d => d.id !== selectedDoc.id);\r\n                setDocuments(updatedDocs);\r\n                onDocumentUpdate?.(updatedDocs);\r\n                setRejectDialogOpen(false);\r\n                setRejectReason(\"\");\r\n                setSelectedDoc(null);\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors du rejet\");\r\n            }\r\n        } catch (error) {\r\n            toast.error(\"Une erreur est survenue\");\r\n            console.error(error);\r\n        } finally {\r\n            setProcessing(false);\r\n        }\r\n    };\r\n\r\n    const openRejectDialog = (doc: IdentityDocument) => {\r\n        setSelectedDoc(doc);\r\n        setRejectDialogOpen(true);\r\n    };\r\n\r\n    if (documents.length === 0) {\r\n        return (\r\n            <Card className=\"border-white/10 bg-white/5 p-12 text-center\">\r\n                <BadgeCheck className=\"h-16 w-16 mx-auto mb-4 text-white/20\" />\r\n                <h3 className=\"text-xl font-semibold text-white mb-2\">\r\n                    Aucun document en attente\r\n                </h3>\r\n                <p className=\"text-white/60\">\r\n                    Tous les documents d&apos;identité ont été traités\r\n                </p>\r\n            </Card>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\r\n                {documents.map((doc) => (\r\n                    <Card key={doc.id} className=\"border-white/10 bg-white/5 p-6\">\r\n                        {/* User Info */}\r\n                        <div className=\"flex items-start gap-3 mb-4 pb-4 border-b border-white/10\">\r\n                            <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-blue-500/20 text-blue-400\">\r\n                                <User className=\"h-6 w-6\" />\r\n                            </div>\r\n                            <div className=\"flex-1 min-w-0\">\r\n                                <h3 className=\"font-semibold text-white truncate\">\r\n                                    {doc.profiles.full_name}\r\n                                </h3>\r\n                                {doc.profiles.is_identity_verified && (\r\n                                    <Badge className=\"mt-1 bg-emerald-500/10 text-emerald-400 border-emerald-500/20\">\r\n                                        Déjà vérifié\r\n                                    </Badge>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Contact Info */}\r\n                        <div className=\"space-y-2 mb-4 text-sm text-white/60\">\r\n                            {doc.profiles.email && (\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <Mail className=\"h-4 w-4\" />\r\n                                    <span className=\"truncate\">{doc.profiles.email}</span>\r\n                                </div>\r\n                            )}\r\n                            {doc.profiles.phone && (\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <Phone className=\"h-4 w-4\" />\r\n                                    <span>{doc.profiles.phone}</span>\r\n                                </div>\r\n                            )}\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <Calendar className=\"h-4 w-4\" />\r\n                                <span>\r\n                                    Membre depuis {format(new Date(doc.profiles.created_at), \"MMMM yyyy\", { locale: fr })}\r\n                                </span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Document Info */}\r\n                        <div className=\"mb-4 p-3 rounded-lg bg-white/5\">\r\n                            <div className=\"flex items-center gap-2 mb-2\">\r\n                                <FileText className=\"h-4 w-4 text-white/40\" />\r\n                                <span className=\"text-sm font-medium text-white\">{doc.file_name}</span>\r\n                            </div>\r\n                            <div className=\"text-xs text-white/40\">\r\n                                Type: {doc.file_type} • Uploadé le{\" \"}\r\n                                {format(new Date(doc.uploaded_at), \"dd MMM yyyy\", { locale: fr })}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Actions */}\r\n                        <div className=\"flex gap-2\">\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                className=\"flex-1 border-white/10 text-white hover:bg-white/10\"\r\n                                onClick={() => window.open(doc.file_url, \"_blank\")}\r\n                            >\r\n                                <Eye className=\"h-4 w-4 mr-1\" />\r\n                                Voir\r\n                            </Button>\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                className=\"flex-1 border-emerald-500/20 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20\"\r\n                                onClick={() => handleApprove(doc)}\r\n                                disabled={processing}\r\n                            >\r\n                                <CheckCircle className=\"h-4 w-4 mr-1\" />\r\n                                Approuver\r\n                            </Button>\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                className=\"border-red-500/20 bg-red-500/10 text-red-400 hover:bg-red-500/20\"\r\n                                onClick={() => openRejectDialog(doc)}\r\n                                disabled={processing}\r\n                            >\r\n                                <XCircle className=\"h-4 w-4\" />\r\n                            </Button>\r\n                        </div>\r\n                    </Card>\r\n                ))}\r\n            </div>\r\n\r\n            {/* Reject Dialog */}\r\n            <Dialog open={rejectDialogOpen} onOpenChange={setRejectDialogOpen}>\r\n                <DialogContent className=\"bg-[#0b0f18] border-white/10\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"text-white\">Rejeter le document</DialogTitle>\r\n                        <DialogDescription className=\"text-white/60\">\r\n                            Veuillez indiquer la raison du rejet pour {selectedDoc?.profiles.full_name}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <Textarea\r\n                        placeholder=\"Raison du rejet...\"\r\n                        value={rejectReason}\r\n                        onChange={(e) => setRejectReason(e.target.value)}\r\n                        className=\"bg-white/5 border-white/10 text-white\"\r\n                        rows={4}\r\n                    />\r\n                    <div className=\"flex gap-2 justify-end\">\r\n                        <Button\r\n                            variant=\"outline\"\r\n                            onClick={() => setRejectDialogOpen(false)}\r\n                            disabled={processing}\r\n                        >\r\n                            Annuler\r\n                        </Button>\r\n                        <Button\r\n                            variant=\"secondary\"\r\n                            onClick={handleReject}\r\n                            disabled={processing || !rejectReason.trim()}\r\n                            className=\"bg-red-600 hover:bg-red-700 text-white\"\r\n                        >\r\n                            Rejeter\r\n                        </Button>\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\identites\\identity-verification-tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\identites\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\identites\\verified-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used.","line":12,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { format } from \"date-fns\";\r\nimport { fr } from \"date-fns/locale\";\r\nimport {\r\n    BadgeCheck,\r\n    User,\r\n    Phone,\r\n    Mail,\r\n    Calendar,\r\n    Shield,\r\n    ShieldOff,\r\n    AlertTriangle,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { revokeIdentityVerification } from \"./actions\";\r\n\r\ntype VerifiedUser = {\r\n    id: string;\r\n    full_name: string;\r\n    phone?: string;\r\n    email?: string;\r\n    is_identity_verified: boolean;\r\n    created_at: string;\r\n    updated_at: string;\r\n    properties_count?: number;\r\n};\r\n\r\ntype Props = {\r\n    initialUsers: VerifiedUser[];\r\n};\r\n\r\nexport function VerifiedIdentitiesList({ initialUsers }: Props) {\r\n    const [users, setUsers] = useState(initialUsers);\r\n    const [selectedUser, setSelectedUser] = useState<VerifiedUser | null>(null);\r\n    const [revokeDialogOpen, setRevokeDialogOpen] = useState(false);\r\n    const [revokeReason, setRevokeReason] = useState(\"\");\r\n    const [processing, setProcessing] = useState(false);\r\n\r\n    const handleRevoke = async () => {\r\n        if (!selectedUser || !revokeReason.trim()) {\r\n            toast.error(\"Veuillez indiquer une raison\");\r\n            return;\r\n        }\r\n\r\n        if (!confirm(`⚠️ ATTENTION: Révoquer la vérification de ${selectedUser.full_name} va également décertifier toutes ses annonces (${selectedUser.properties_count || 0}). Confirmer ?`)) {\r\n            return;\r\n        }\r\n\r\n        setProcessing(true);\r\n        try {\r\n            const result = await revokeIdentityVerification(selectedUser.id, revokeReason);\r\n\r\n            if (result.success) {\r\n                toast.success(\"🔓 Vérification révoquée avec succès\");\r\n                setUsers(prev => prev.filter(u => u.id !== selectedUser.id));\r\n                setRevokeDialogOpen(false);\r\n                setRevokeReason(\"\");\r\n                setSelectedUser(null);\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors de la révocation\");\r\n            }\r\n        } catch (error) {\r\n            toast.error(\"Une erreur est survenue\");\r\n            console.error(error);\r\n        } finally {\r\n            setProcessing(false);\r\n        }\r\n    };\r\n\r\n    const openRevokeDialog = (user: VerifiedUser) => {\r\n        setSelectedUser(user);\r\n        setRevokeDialogOpen(true);\r\n    };\r\n\r\n    if (users.length === 0) {\r\n        return (\r\n            <Card className=\"border-white/10 bg-white/5 p-12 text-center\">\r\n                <ShieldOff className=\"h-16 w-16 mx-auto mb-4 text-white/20\" />\r\n                <h3 className=\"text-xl font-semibold text-white mb-2\">\r\n                    Aucune identité vérifiée\r\n                </h3>\r\n                <p className=\"text-white/60\">\r\n                    Les utilisateurs avec identité vérifiée apparaîtront ici\r\n                </p>\r\n            </Card>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <>\r\n            {/* En-tête */}\r\n            <div className=\"mb-4\">\r\n                <p className=\"text-sm text-white/60\">\r\n                    {users.length} identité{users.length > 1 ? 's' : ''} vérifiée{users.length > 1 ? 's' : ''}\r\n                </p>\r\n            </div>\r\n\r\n            {/* Tableau */}\r\n            <Card className=\"border-white/10 bg-white/5 overflow-hidden\">\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full\">\r\n                        <thead>\r\n                            <tr className=\"border-b border-white/10 bg-white/5\">\r\n                                <th className=\"px-6 py-4 text-left text-xs font-semibold text-white/60 uppercase tracking-wider\">\r\n                                    Utilisateur\r\n                                </th>\r\n                                <th className=\"px-6 py-4 text-left text-xs font-semibold text-white/60 uppercase tracking-wider\">\r\n                                    Contact\r\n                                </th>\r\n                                <th className=\"px-6 py-4 text-left text-xs font-semibold text-white/60 uppercase tracking-wider\">\r\n                                    Vérifié le\r\n                                </th>\r\n                                <th className=\"px-6 py-4 text-left text-xs font-semibold text-white/60 uppercase tracking-wider\">\r\n                                    Annonces\r\n                                </th>\r\n                                <th className=\"px-6 py-4 text-right text-xs font-semibold text-white/60 uppercase tracking-wider\">\r\n                                    Actions\r\n                                </th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-white/5\">\r\n                            {users.map((user) => (\r\n                                <tr key={user.id} className=\"hover:bg-white/5 transition-colors\">\r\n                                    {/* Utilisateur */}\r\n                                    <td className=\"px-6 py-4\">\r\n                                        <div className=\"flex items-center gap-3\">\r\n                                            <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20\">\r\n                                                <User className=\"h-5 w-5 text-emerald-400\" />\r\n                                            </div>\r\n                                            <div>\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <p className=\"text-sm font-medium text-white\">\r\n                                                        {user.full_name}\r\n                                                    </p>\r\n                                                    <BadgeCheck className=\"h-4 w-4 text-amber-400\" />\r\n                                                </div>\r\n                                                <p className=\"text-xs text-white/40\">\r\n                                                    Membre depuis {format(new Date(user.created_at), \"MMM yyyy\", { locale: fr })}\r\n                                                </p>\r\n                                            </div>\r\n                                        </div>\r\n                                    </td>\r\n\r\n                                    {/* Contact */}\r\n                                    <td className=\"px-6 py-4\">\r\n                                        <div className=\"space-y-1\">\r\n                                            {user.email && (\r\n                                                <div className=\"flex items-center gap-2 text-xs text-white/60\">\r\n                                                    <Mail className=\"h-3 w-3\" />\r\n                                                    <span className=\"truncate max-w-[200px]\">{user.email}</span>\r\n                                                </div>\r\n                                            )}\r\n                                            {user.phone && (\r\n                                                <div className=\"flex items-center gap-2 text-xs text-white/60\">\r\n                                                    <Phone className=\"h-3 w-3\" />\r\n                                                    <span>{user.phone}</span>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </td>\r\n\r\n                                    {/* Date de vérification */}\r\n                                    <td className=\"px-6 py-4\">\r\n                                        <div className=\"flex items-center gap-2 text-xs text-white/60\">\r\n                                            <Calendar className=\"h-3 w-3\" />\r\n                                            <span>{format(new Date(user.updated_at), \"dd/MM/yyyy\", { locale: fr })}</span>\r\n                                        </div>\r\n                                    </td>\r\n\r\n                                    {/* Annonces */}\r\n                                    <td className=\"px-6 py-4\">\r\n                                        <Badge variant=\"outline\" className=\"border-emerald-500/30 text-emerald-400\">\r\n                                            {user.properties_count || 0} annonce{(user.properties_count || 0) > 1 ? 's' : ''}\r\n                                        </Badge>\r\n                                    </td>\r\n\r\n                                    {/* Actions */}\r\n                                    <td className=\"px-6 py-4\">\r\n                                        <div className=\"flex items-center justify-end gap-2\">\r\n                                            <Button\r\n                                                size=\"sm\"\r\n                                                variant=\"outline\"\r\n                                                className=\"border-red-500/30 bg-red-500/10 text-red-400 hover:bg-red-500/20\"\r\n                                                onClick={() => openRevokeDialog(user)}\r\n                                                disabled={processing}\r\n                                            >\r\n                                                <ShieldOff className=\"h-3.5 w-3.5 mr-1.5\" />\r\n                                                Révoquer\r\n                                            </Button>\r\n                                        </div>\r\n                                    </td>\r\n                                </tr>\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </Card>\r\n\r\n            {/* Dialog de révocation */}\r\n            <Dialog open={revokeDialogOpen} onOpenChange={setRevokeDialogOpen}>\r\n                <DialogContent className=\"bg-[#0b0f18] border-white/10\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"text-white flex items-center gap-2\">\r\n                            <AlertTriangle className=\"h-5 w-5 text-red-400\" />\r\n                            Révoquer la vérification d&apos;identité\r\n                        </DialogTitle>\r\n                        <DialogDescription className=\"text-white/60\">\r\n                            ⚠️ Action critique pour {selectedUser?.full_name}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"p-4 rounded-lg bg-red-500/10 border border-red-500/20\">\r\n                            <p className=\"text-sm text-red-400 font-semibold mb-2\">\r\n                                Cette action va :\r\n                            </p>\r\n                            <ul className=\"text-xs text-red-300 space-y-1 list-disc list-inside\">\r\n                                <li>Retirer le badge &quot;Vérifié&quot; du profil</li>\r\n                                <li>Décertifier tous les documents d&apos;identité</li>\r\n                                <li>Décertifier toutes les annonces ({selectedUser?.properties_count || 0})</li>\r\n                            </ul>\r\n                        </div>\r\n\r\n                        <div>\r\n                            <label className=\"text-sm text-white/80 font-medium mb-2 block\">\r\n                                Raison de la révocation\r\n                            </label>\r\n                            <Textarea\r\n                                placeholder=\"Ex: Document expiré, informations incorrectes, fraude détectée...\"\r\n                                value={revokeReason}\r\n                                onChange={(e) => setRevokeReason(e.target.value)}\r\n                                className=\"bg-white/5 border-white/10 text-white min-h-[100px]\"\r\n                                rows={4}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-2 justify-end\">\r\n                        <Button\r\n                            variant=\"outline\"\r\n                            onClick={() => {\r\n                                setRevokeDialogOpen(false);\r\n                                setRevokeReason(\"\");\r\n                            }}\r\n                            disabled={processing}\r\n                        >\r\n                            Annuler\r\n                        </Button>\r\n                        <Button\r\n                            className=\"bg-red-600 hover:bg-red-700 text-white\"\r\n                            onClick={handleRevoke}\r\n                            disabled={processing || !revokeReason.trim()}\r\n                        >\r\n                            <ShieldOff className=\"w-4 h-4 mr-2\" />\r\n                            Confirmer la révocation\r\n                        </Button>\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\admin\\verifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\agence\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\admin\\performance\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\auth\\check-verification\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\auth\\verify-email\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\branding\\upload\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'uploadData' is assigned a value but never used.","line":41,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@/utils/supabase/server';\r\nimport { NextRequest, NextResponse } from 'next/server';\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const supabase = await createClient();\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n\r\n        if (!user) {\r\n            return NextResponse.json({ success: false, error: 'Non autorisé' }, { status: 401 });\r\n        }\r\n\r\n        const formData = await request.formData();\r\n        const file = formData.get('file') as File;\r\n        const type = formData.get('type') as string; // 'logo' ou 'signature'\r\n\r\n        if (!file || !type) {\r\n            return NextResponse.json({ success: false, error: 'Fichier ou type manquant' }, { status: 400 });\r\n        }\r\n\r\n        // Vérifier le type de fichier\r\n        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'];\r\n        if (!allowedTypes.includes(file.type)) {\r\n            return NextResponse.json({ success: false, error: 'Type de fichier non autorisé' }, { status: 400 });\r\n        }\r\n\r\n        // Vérifier la taille (max 2MB)\r\n        if (file.size > 2 * 1024 * 1024) {\r\n            return NextResponse.json({ success: false, error: 'Fichier trop volumineux (max 2MB)' }, { status: 400 });\r\n        }\r\n\r\n        // Générer le nom du fichier\r\n        const fileExt = file.name.split('.').pop();\r\n        const fileName = `${user.id}/${type}_${Date.now()}.${fileExt}`;\r\n\r\n        // Convertir le fichier en ArrayBuffer puis en Uint8Array\r\n        const arrayBuffer = await file.arrayBuffer();\r\n        const uint8Array = new Uint8Array(arrayBuffer);\r\n\r\n        // Upload vers le bucket 'branding'\r\n        const { data: uploadData, error: uploadError } = await supabase.storage\r\n            .from('branding')\r\n            .upload(fileName, uint8Array, {\r\n                contentType: file.type,\r\n                upsert: true\r\n            });\r\n\r\n        if (uploadError) {\r\n            console.error('Erreur upload:', uploadError);\r\n            return NextResponse.json({ success: false, error: uploadError.message }, { status: 500 });\r\n        }\r\n\r\n        // Obtenir l'URL publique\r\n        const { data: { publicUrl } } = supabase.storage\r\n            .from('branding')\r\n            .getPublicUrl(fileName);\r\n\r\n        // Mettre à jour le profil avec l'URL\r\n        const updateField = type === 'logo' ? 'logo_url' : 'signature_url';\r\n        const { error: updateError } = await supabase\r\n            .from('profiles')\r\n            .update({ [updateField]: publicUrl })\r\n            .eq('id', user.id);\r\n\r\n        if (updateError) {\r\n            console.error('Erreur mise à jour profil:', updateError);\r\n            return NextResponse.json({ success: false, error: updateError.message }, { status: 500 });\r\n        }\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            url: publicUrl,\r\n            message: `${type === 'logo' ? 'Logo' : 'Signature'} enregistré avec succès`\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Erreur API upload branding:', error);\r\n        return NextResponse.json({ success: false, error: 'Erreur serveur' }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\cron\\generate-monthly-rentals\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\cron\\lease-expirations\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\cron\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\debug\\documents\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\paydunya\\confirm\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\paydunya\\create-invoice\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\paydunya\\webhook\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\property-stats\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\reset-reminders\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\send-notice\\route.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'title' is assigned a value but never used.","line":61,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":61,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport nodemailer from 'nodemailer';\r\nimport ReactPDF from '@react-pdf/renderer';\r\nimport { createPreavisDocument } from '@/components/pdf/PreavisPDF';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // 1. Récupérer les données de la requête\r\n    const data = await request.json();\r\n\r\n    console.log('📧 Génération du préavis pour:', data.tenantEmail);\r\n\r\n    // 2. Validation basique\r\n    if (!data.tenantEmail) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Email du locataire manquant' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!data.tenantName || !data.noticeType || !data.endDate) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Données incomplètes' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // 3. Générer le PDF en mémoire\r\n    console.log('📄 Génération du PDF préavis...');\r\n    const pdfDocument = createPreavisDocument(data);\r\n\r\n    // Utiliser renderToStream\r\n    const stream = await ReactPDF.renderToStream(pdfDocument);\r\n\r\n    // Convertir le stream en buffer\r\n    const chunks: Uint8Array[] = [];\r\n    const pdfBuffer = await new Promise<Buffer>((resolve, reject) => {\r\n      stream.on('data', (chunk) => chunks.push(chunk));\r\n      stream.on('end', () => resolve(Buffer.concat(chunks)));\r\n      stream.on('error', reject);\r\n    });\r\n\r\n    console.log('✅ PDF préavis généré:', pdfBuffer.length, 'bytes');\r\n\r\n    // 4. Configuration de Nodemailer (Gmail)\r\n    const transporter = nodemailer.createTransport({\r\n      service: 'gmail',\r\n      auth: {\r\n        user: process.env.GMAIL_USER,\r\n        pass: process.env.GMAIL_APP_PASSWORD,\r\n      },\r\n    });\r\n\r\n    // 5. Déterminer le sujet et le contenu selon le type\r\n    const isJ180 = data.noticeType === 'J-180';\r\n\r\n    const subject = isJ180\r\n      ? `⚠️ Préavis de Congé - Échéance ${new Date(data.endDate).toLocaleDateString('fr-FR')}`\r\n      : `📅 Notification de Reconduction Tacite - ${new Date(data.endDate).toLocaleDateString('fr-FR')}`;\r\n\r\n    const title = isJ180\r\n      ? 'Préavis de Congé pour Reprise'\r\n      : 'Notification de Reconduction Tacite';\r\n\r\n    const urgency = isJ180\r\n      ? \"Il vous reste environ 6 mois avant l'échéance du bail.\"\r\n      : \"Il vous reste environ 3 mois avant l'échéance du bail.\";\r\n\r\n    const action = isJ180\r\n      ? \"Vous devrez libérer les lieux à la date d'échéance mentionnée dans le document ci-joint.\"\r\n      : \"En l'absence de congé, le bail sera reconduit tacitement aux mêmes conditions.\";\r\n\r\n    // 6. Email du propriétaire pour la copie (CC)\r\n    const ownerEmailForCC = data.ownerEmail || data.ownerAccountEmail;\r\n\r\n    // Log pour vérifier les destinataires\r\n    console.log('📧 Destinataires email:');\r\n    console.log('   → TO (Locataire):', data.tenantEmail);\r\n    console.log('   → CC (Propriétaire):', ownerEmailForCC);\r\n\r\n    // 7. Préparer l'email (format simple)\r\n    const mailOptions = {\r\n      from: `${data.ownerName} <${process.env.GMAIL_USER}>`,\r\n      to: data.tenantEmail,\r\n      cc: ownerEmailForCC,\r\n      subject: subject,\r\n      text: `Bonjour ${data.tenantName},\r\n\r\nVeuillez trouver ci-joint un préavis juridique ${data.noticeType} concernant votre bail de location.\r\n\r\nINFORMATION IMPORTANTE\r\n${urgency}\r\n\r\nDétails du préavis :\r\n- N° Préavis : ${data.noticeNumber}\r\n- Type : ${isJ180 ? 'Congé pour reprise (6 mois)' : 'Reconduction tacite (3 mois)'}\r\n- Bien concerné : ${data.propertyAddress}\r\n- Date d'échéance : ${new Date(data.endDate).toLocaleDateString('fr-FR')}\r\n\r\nAction requise :\r\n${action}\r\n\r\nCordialement,\r\n${data.ownerName}\r\n${data.ownerAddress}\r\n\r\n---\r\nCadre Juridique Sénégalais\r\nLoi n° 2014-22 du 24 février 2014 & Code des Obligations Civiles et Commerciales (COCC)\r\n\r\nEmail généré automatiquement par Dousell Immo`,\r\n      attachments: [\r\n        {\r\n          filename: `Preavis_${data.noticeType}_${data.noticeNumber}.pdf`,\r\n          content: pdfBuffer,\r\n          contentType: 'application/pdf',\r\n        },\r\n      ],\r\n    };\r\n\r\n    // 8. Envoyer l'email\r\n    console.log(\"📤 Envoi de l'email...\");\r\n    await transporter.sendMail(mailOptions);\r\n\r\n    console.log(\"✅ Email envoyé avec succès à:\", data.tenantEmail);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: `Préavis ${data.noticeType} envoyé avec succès à ${data.tenantName}`,\r\n      pdfSize: pdfBuffer.length,\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(\"❌ Erreur lors de l'envoi du préavis:\", error);\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : \"Erreur lors de l'envoi du préavis\",\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\send-receipt\\route.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\test-reminders\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\user\\roles\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":127,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":127,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport { verifyTurnstileToken } from \"@/lib/turnstile\";\r\nimport { checkPasswordHIBPServer } from \"@/app/actions/check-hibp\";\r\nimport { getBaseUrl } from \"@/lib/utils\";\r\n\r\nexport async function signup(formData: FormData) {\r\n  const supabase = await createClient();\r\n\r\n  const email = formData.get(\"email\") as string;\r\n  const password = formData.get(\"password\") as string;\r\n  const fullName = formData.get(\"fullName\") as string;\r\n  const phone = formData.get(\"phone\") as string;\r\n  const turnstileToken = formData.get(\"turnstileToken\") as string;\r\n\r\n  // Validation des champs\r\n  if (!email || !password || !fullName || !phone) {\r\n    return {\r\n      error: \"Tous les champs sont requis\",\r\n    };\r\n  }\r\n\r\n  // Validation de l'email\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  if (!emailRegex.test(email.trim())) {\r\n    return {\r\n      error: \"Adresse email invalide\",\r\n    };\r\n  }\r\n\r\n  // Validation du mot de passe\r\n  if (password.length < 6) {\r\n    return {\r\n      error: \"Le mot de passe doit contenir au moins 6 caractères\",\r\n    };\r\n  }\r\n\r\n  // Vérification HIBP (côté serveur, pas de CORS)\r\n  const hibpResult = await checkPasswordHIBPServer(password);\r\n  if (!hibpResult.success) {\r\n    // Soft-fail : log l'erreur mais continue l'inscription\r\n    console.warn(\"HIBP check failed:\", hibpResult.error);\r\n    // On continue quand même l'inscription pour ne pas bloquer l'utilisateur\r\n  } else if (hibpResult.breached) {\r\n    // Hard-fail : mot de passe compromis, bloquer l'inscription\r\n    return {\r\n      error: hibpResult.error || \"Ce mot de passe a été compromis. Choisissez-en un autre plus sécurisé.\",\r\n    };\r\n  }\r\n\r\n  // Validation du téléphone (format international accepté)\r\n  const phoneDigits = phone.replace(/\\D/g, \"\");\r\n  // Accepter les numéros internationaux (au moins 8 chiffres, max 15 selon E.164)\r\n  if (phoneDigits.length < 8 || phoneDigits.length > 15) {\r\n    return {\r\n      error: \"Numéro de téléphone invalide\",\r\n    };\r\n  }\r\n\r\n  // Validation du nom complet\r\n  if (fullName.trim().length < 2) {\r\n    return {\r\n      error: \"Le nom complet doit contenir au moins 2 caractères\",\r\n    };\r\n  }\r\n\r\n  // Vérification Turnstile\r\n  if (!turnstileToken) {\r\n    return {\r\n      error: \"Vérification anti-robot requise. Veuillez réessayer.\",\r\n    };\r\n  }\r\n\r\n  const verification = await verifyTurnstileToken(turnstileToken);\r\n  if (!verification.success) {\r\n    return {\r\n      error: verification.error || \"Vérification anti-robot échouée. Veuillez réessayer.\",\r\n    };\r\n  }\r\n\r\n  const appUrl = getBaseUrl();\r\n  // Utiliser /auth/confirm au lieu de /auth/callback pour éviter les erreurs PKCE\r\n  const emailRedirectTo = `${appUrl}/auth/confirm?next=/`;\r\n\r\n  try {\r\n    // Normaliser le numéro de téléphone\r\n    // Si le numéro commence par +, c'est déjà au format international\r\n    // Sinon, on ajoute +221 (Sénégal par défaut)\r\n    let normalizedPhone = phone.trim();\r\n    if (!normalizedPhone.startsWith('+')) {\r\n      normalizedPhone = `+221${phoneDigits}`;\r\n    }\r\n\r\n    // IMPORTANT: Pour utiliser Nodemailer au lieu de l'email Supabase :\r\n    // 1. Allez dans Dashboard Supabase → Authentication → Providers → Email\r\n    // 2. Décochez \"Confirm email\" pour désactiver l'auto-confirmation\r\n    // 3. L'email sera envoyé via Nodemailer (voir plus bas)\r\n    const { data, error } = await supabase.auth.signUp({\r\n      email: email.trim().toLowerCase(),\r\n      password,\r\n      options: {\r\n        data: {\r\n          full_name: fullName.trim(),\r\n          phone: normalizedPhone,\r\n        },\r\n        emailRedirectTo,\r\n      },\r\n    });\r\n\r\n    if (error) {\r\n      // 🚨 LOG COMPLET DE L'ERREUR SUPABASE POUR DEBUGGING\r\n      console.error(\"🚨 ERREUR SUPABASE SIGNUP :\", error);\r\n      console.error(\"🚨 ERREUR SUPABASE SIGNUP (détails):\", {\r\n        message: error.message,\r\n        code: error.code,\r\n        status: error.status,\r\n        name: error.name,\r\n        cause: error.cause,\r\n        stack: error.stack,\r\n      });\r\n      // Log JSON complet\r\n      try {\r\n        console.error(\"🚨 ERREUR SUPABASE SIGNUP (JSON):\", JSON.stringify(error, null, 2));\r\n      } catch (e) {\r\n        console.error(\"🚨 Impossible de sérialiser l'erreur en JSON\");\r\n      }\r\n\r\n      let errorMessage = error.message;\r\n\r\n      // Messages d'erreur plus explicites et en français\r\n      if (error.message.includes(\"already registered\") ||\r\n        error.message.includes(\"User already registered\") ||\r\n        error.message.includes(\"already exists\")) {\r\n        // Vérifier si l'utilisateur existe via un provider OAuth (Google, Apple, etc.)\r\n        try {\r\n          const { createClient } = await import(\"@supabase/supabase-js\");\r\n          const supabaseAdmin = createClient(\r\n            process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n            process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n            {\r\n              auth: {\r\n                autoRefreshToken: false,\r\n                persistSession: false,\r\n              },\r\n            }\r\n          );\r\n\r\n          // Utiliser listUsers avec pagination limitée (max 1000 users)\r\n          const { data: usersData } = await supabaseAdmin.auth.admin.listUsers({\r\n            page: 1,\r\n            perPage: 1000,\r\n          });\r\n\r\n          const existingUser = usersData?.users?.find(\r\n            u => u.email?.toLowerCase() === email.trim().toLowerCase()\r\n          );\r\n\r\n          if (existingUser?.app_metadata) {\r\n            const providers = existingUser.app_metadata.providers as string[] | undefined;\r\n            const provider = existingUser.app_metadata.provider as string | undefined;\r\n\r\n            if (providers?.includes(\"google\") || provider === \"google\") {\r\n              errorMessage = \"Cet email est déjà associé à un compte Google. Veuillez vous connecter avec Google ou réinitialisez votre mot de passe pour ajouter une connexion par email.\";\r\n            } else if (providers?.includes(\"apple\") || provider === \"apple\") {\r\n              errorMessage = \"Cet email est déjà associé à un compte Apple. Veuillez vous connecter avec Apple ou réinitialisez votre mot de passe pour ajouter une connexion par email.\";\r\n            } else {\r\n              errorMessage = \"Cet email est déjà enregistré. Essayez de vous connecter ou réinitialisez votre mot de passe.\";\r\n            }\r\n          } else {\r\n            errorMessage = \"Cet email est déjà enregistré. Essayez de vous connecter ou réinitialisez votre mot de passe.\";\r\n          }\r\n        } catch (adminError) {\r\n          console.error(\"Erreur lors de la vérification du provider:\", adminError);\r\n          // Fallback au message générique si la vérification échoue\r\n          errorMessage = \"Cet email est déjà enregistré. Essayez de vous connecter ou réinitialisez votre mot de passe.\";\r\n        }\r\n      } else if (error.message.includes(\"Password\") || error.message.includes(\"password\")) {\r\n        errorMessage = \"Le mot de passe doit contenir au moins 6 caractères\";\r\n      } else if (error.message.includes(\"Invalid email\") || error.message.includes(\"invalid\")) {\r\n        errorMessage = \"Adresse email invalide\";\r\n      } else if (\r\n        error.message.includes(\"rate limit\") ||\r\n        error.message.includes(\"too many\") ||\r\n        error.message.includes(\"rate_limit_exceeded\") ||\r\n        error.code === \"429\"\r\n      ) {\r\n        errorMessage = \"Trop de tentatives de connexion. Pour votre sécurité, veuillez attendre 5 minutes avant de réessayer.\";\r\n      } else if (error.message.includes(\"signup_disabled\") || error.message.includes(\"signup disabled\")) {\r\n        errorMessage = \"Les inscriptions sont temporairement désactivées. Veuillez réessayer plus tard.\";\r\n      } else if (error.message.includes(\"Email rate limit exceeded\")) {\r\n        errorMessage = \"Trop d'emails envoyés. Veuillez attendre quelques minutes avant de réessayer.\";\r\n      } else if (error.message.includes(\"Failed to send\")) {\r\n        errorMessage = \"Erreur d'envoi d'email. Veuillez vérifier votre adresse email ou réessayer plus tard.\";\r\n      } else if (error.message.includes(\"Error sending confirmation email\")) {\r\n        // C'est souvent une erreur SMTP\r\n        errorMessage = \"Erreur technique lors de l'envoi de l'email. Contactez le support ou réessayez.\";\r\n        // Log spécifique pour aider le développeur\r\n        console.error(\"⚠️ ERREUR SMTP PROBABLE : Vérifiez la configuration SMTP dans le Dashboard Supabase (Authentication > SMTP Settings). Assurez-vous que le mot de passe d'application est correct.\");\r\n      } else {\r\n        // En développement, afficher le message d'erreur complet pour le debugging\r\n        if (process.env.NODE_ENV === \"development\") {\r\n          errorMessage = `Erreur: ${error.message} (Code: ${error.code || \"N/A\"})`;\r\n        } else {\r\n          errorMessage = \"Erreur lors de la création du compte. Veuillez réessayer ou contactez le support.\";\r\n        }\r\n      }\r\n\r\n      return {\r\n        error: errorMessage,\r\n      };\r\n    }\r\n\r\n    // Gestion des différents cas de création de compte\r\n    if (!data.user) {\r\n      console.error(\"No user returned from signup\");\r\n      return {\r\n        error: \"Erreur lors de la création du compte. Veuillez réessayer.\",\r\n      };\r\n    }\r\n\r\n    // Détecter si l'email de confirmation est requis\r\n    // Si data.session existe, l'utilisateur est automatiquement connecté (auto-confirm activé)\r\n    // Si data.session est null mais data.user existe, l'email de confirmation est requis\r\n    const isAutoConfirmed = !!data.session;\r\n    const emailConfirmationRequired = !isAutoConfirmed && !data.user.email_confirmed_at;\r\n\r\n    revalidatePath(\"/\", \"layout\");\r\n\r\n    // Si l'utilisateur est automatiquement confirmé, on peut le rediriger directement\r\n    if (isAutoConfirmed && data.session) {\r\n      return {\r\n        success: true,\r\n        message: \"Compte créé avec succès ! Vous êtes maintenant connecté.\",\r\n        emailSent: false,\r\n        autoConfirmed: true,\r\n        session: data.session,\r\n      };\r\n    }\r\n\r\n    // Si l'email de confirmation est requis\r\n    // Supabase envoie automatiquement un email avec un lien magique\r\n    // Quand l'utilisateur clique, il sera automatiquement connecté (comme Firebase)\r\n    if (emailConfirmationRequired && data.user) {\r\n      console.log(\"📧 Email de confirmation envoyé automatiquement par Supabase\");\r\n      console.log(\"🔗 L'utilisateur sera connecté automatiquement après avoir cliqué sur le lien\");\r\n\r\n      return {\r\n        success: true,\r\n        message: \"Compte créé ! Un email de vérification a été envoyé à votre adresse. Cliquez sur le lien dans l'email pour activer votre compte et vous connecter automatiquement.\",\r\n        emailSent: true,\r\n        autoConfirmed: false,\r\n        userId: data.user.id,\r\n      };\r\n    }\r\n\r\n    // Cas par défaut\r\n    return {\r\n      success: true,\r\n      message: \"Compte créé avec succès !\",\r\n      emailSent: false,\r\n      autoConfirmed: false,\r\n    };\r\n  } catch (err) {\r\n    // 🚨 LOG COMPLET DE L'ERREUR INATTENDUE\r\n    console.error(\"🚨 ERREUR INATTENDUE SIGNUP :\", err);\r\n    if (err instanceof Error) {\r\n      console.error(\"🚨 ERREUR INATTENDUE (détails):\", {\r\n        message: err.message,\r\n        name: err.name,\r\n        stack: err.stack,\r\n        cause: err.cause,\r\n      });\r\n    }\r\n    return {\r\n      error: \"Une erreur inattendue s'est produite. Veuillez réessayer.\",\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Renvoyer l'email de confirmation\r\n * Utilise la méthode native de Supabase Auth avec SMTP configuré\r\n */\r\nexport async function resendConfirmationEmail(email: string) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const appUrl = getBaseUrl();\r\n    const emailRedirectTo = `${appUrl}/auth/callback?next=/`;\r\n\r\n    const { error } = await supabase.auth.resend({\r\n      type: \"signup\",\r\n      email: email.trim().toLowerCase(),\r\n      options: {\r\n        emailRedirectTo,\r\n      },\r\n    });\r\n\r\n    if (error) {\r\n      console.error(\"Erreur lors du renvoi de l'email de confirmation:\", error);\r\n      return {\r\n        success: false,\r\n        error: error.message || \"Erreur lors de l'envoi de l'email de confirmation\",\r\n      };\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      message: \"Email de confirmation renvoyé ! Vérifiez votre boîte de réception.\",\r\n    };\r\n  } catch (error) {\r\n    console.error(\"Erreur inattendue lors du renvoi de l'email:\", error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : \"Erreur inattendue\",\r\n    };\r\n  }\r\n}\r\n\r\nexport async function login(formData: FormData) {\r\n  const supabase = await createClient();\r\n\r\n  const email = formData.get(\"email\") as string;\r\n  const password = formData.get(\"password\") as string;\r\n  const turnstileToken = formData.get(\"turnstileToken\") as string;\r\n\r\n  if (!email || !password) {\r\n    return {\r\n      error: \"Email et mot de passe requis\",\r\n    };\r\n  }\r\n\r\n  // Vérification Turnstile\r\n  if (!turnstileToken) {\r\n    return {\r\n      error: \"Vérification anti-robot requise. Veuillez réessayer.\",\r\n    };\r\n  }\r\n\r\n  const verification = await verifyTurnstileToken(turnstileToken);\r\n  if (!verification.success) {\r\n    return {\r\n      error: verification.error || \"Vérification anti-robot échouée. Veuillez réessayer.\",\r\n    };\r\n  }\r\n\r\n  const { error } = await supabase.auth.signInWithPassword({\r\n    email: email.trim().toLowerCase(),\r\n    password,\r\n  });\r\n\r\n  if (error) {\r\n    console.error(\"Login error:\", error);\r\n    let errorMessage = \"Email ou mot de passe incorrect\";\r\n\r\n    if (error.message.includes(\"Email not confirmed\")) {\r\n      errorMessage = \"Veuillez confirmer votre email avant de vous connecter\";\r\n    } else if (error.message.includes(\"Invalid login credentials\")) {\r\n      errorMessage = \"Email ou mot de passe incorrect\";\r\n    } else if (\r\n      error.message.includes(\"rate limit\") ||\r\n      error.message.includes(\"too many\") ||\r\n      error.message.includes(\"rate_limit_exceeded\") ||\r\n      error.code === \"429\"\r\n    ) {\r\n      errorMessage = \"Trop de tentatives. Pour votre sécurité, veuillez attendre 5 minutes avant de réessayer.\";\r\n    }\r\n\r\n    return {\r\n      error: errorMessage,\r\n    };\r\n  }\r\n\r\n  revalidatePath(\"/\", \"layout\");\r\n  redirect(\"/\");\r\n}\r\n\r\nexport async function signInWithGoogle() {\r\n  const supabase = await createClient();\r\n\r\n  // Détection automatique de l'URL (pour Vercel et localhost)\r\n  const appUrl = getBaseUrl();\r\n  const redirectTo = `${appUrl}/auth/callback?next=/`;\r\n\r\n  const { data, error } = await supabase.auth.signInWithOAuth({\r\n    provider: \"google\",\r\n    options: {\r\n      redirectTo,\r\n    },\r\n  });\r\n\r\n  if (error) {\r\n    console.error(\"❌ Google OAuth error:\", error);\r\n    return {\r\n      error: error.message,\r\n    };\r\n  }\r\n\r\n  if (data.url) {\r\n    redirect(data.url);\r\n  } else {\r\n    console.error(\"❌ No OAuth URL returned\");\r\n    return {\r\n      error: \"Impossible de générer l'URL OAuth. Vérifiez la configuration Supabase.\",\r\n    };\r\n  }\r\n}\r\n\r\nexport async function signOut() {\r\n  const supabase = await createClient();\r\n  await supabase.auth.signOut();\r\n  revalidatePath(\"/\", \"layout\");\r\n  redirect(\"/login\");\r\n}\r\n\r\nexport async function resetPassword(email: string) {\r\n  const supabase = await createClient();\r\n\r\n  const { error } = await supabase.auth.resetPasswordForEmail(email, {\r\n    redirectTo: `${getBaseUrl()}/auth/callback?next=/compte/reset-password`,\r\n  });\r\n\r\n  if (error) {\r\n    console.error(\"Reset password error:\", error);\r\n    return {\r\n      error: error.message,\r\n    };\r\n  }\r\n\r\n  return {\r\n    success: true,\r\n    message: \"Email de réinitialisation envoyé\",\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\auth-code-error\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\callback\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1825,1828],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1825,1828],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\r\nimport { NextResponse } from \"next/server\";\r\n\r\nexport async function GET(request: Request) {\r\n  // 1. On récupère l'URL actuelle (que ce soit localhost ou vercel)\r\n  const { searchParams, origin } = new URL(request.url);\r\n  const code = searchParams.get(\"code\");\r\n  const token_hash = searchParams.get(\"token_hash\");\r\n  const type = searchParams.get(\"type\"); // email, signup, recovery, etc.\r\n  const error = searchParams.get(\"error\");\r\n  const errorDescription = searchParams.get(\"error_description\");\r\n  const next = searchParams.get(\"next\") ?? \"/\";\r\n\r\n  // Log pour débugger\r\n  console.log(\"🔍 Auth Callback Debug:\", {\r\n    code: code ? \"✓ présent\" : \"✗ manquant\",\r\n    token_hash: token_hash ? \"✓ présent\" : \"✗ manquant\",\r\n    type,\r\n    error,\r\n    errorDescription,\r\n    next,\r\n    origin,\r\n  });\r\n\r\n  // Si Google renvoie une erreur dans les query params\r\n  if (error) {\r\n    console.error(\"❌ OAuth Error from Google:\", {\r\n      error,\r\n      errorDescription,\r\n    });\r\n    // Rediriger vers la page d'erreur avec un message spécifique\r\n    const errorUrl = new URL(`${origin}/auth/auth-code-error`);\r\n    if (errorDescription) {\r\n      errorUrl.searchParams.set(\"reason\", decodeURIComponent(errorDescription));\r\n    }\r\n    return NextResponse.redirect(errorUrl.toString());\r\n  }\r\n\r\n  const supabase = await createClient();\r\n\r\n  // FLUX 1 : Vérification Email via Token Hash (Email Confirmation)\r\n  // 💡 C'est ce flux qui permet le cross-browser (clic sur mobile, ouverture sur PC)\r\n  if (token_hash && type) {\r\n    console.log(\"🔐 Email confirmation flow (token_hash) - Cross-browser compatible\");\r\n    try {\r\n      const { data, error: verifyError } = await supabase.auth.verifyOtp({\r\n        type: type === 'email' || type === 'signup' ? 'email' : type as any,\r\n        token_hash,\r\n      });\r\n\r\n      if (verifyError) {\r\n        console.error(\"❌ Error verifying OTP:\", verifyError);\r\n        const errorUrl = new URL(`${origin}/auth/auth-code-error`);\r\n        errorUrl.searchParams.set(\"reason\", verifyError.message);\r\n        return NextResponse.redirect(errorUrl.toString());\r\n      }\r\n\r\n      if (data.session) {\r\n        console.log(\"✅ Email verified, session created\");\r\n        return NextResponse.redirect(`${origin}/?verified=true`);\r\n      }\r\n\r\n      console.error(\"❌ No session after OTP verification\");\r\n      return NextResponse.redirect(`${origin}/auth/auth-code-error`);\r\n    } catch (err) {\r\n      console.error(\"❌ Unexpected error in OTP verification:\", err);\r\n      return NextResponse.redirect(`${origin}/auth/auth-code-error`);\r\n    }\r\n  }\r\n\r\n  // FLUX 2 : OAuth/PKCE Flow (Google, Magic Link avec Code)\r\n  if (!code) {\r\n    console.error(\"❌ No authorization code or token_hash received\");\r\n    return NextResponse.redirect(`${origin}/auth/auth-code-error`);\r\n  }\r\n\r\n  // Échanger le code pour une session\r\n  try {\r\n    const { data, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);\r\n\r\n    if (exchangeError) {\r\n      console.error(\"❌ Error exchanging code for session:\", exchangeError);\r\n      // Rediriger vers la page d'erreur avec le détail de l'erreur\r\n      const errorUrl = new URL(`${origin}/auth/auth-code-error`);\r\n      errorUrl.searchParams.set(\"reason\", exchangeError.message);\r\n      return NextResponse.redirect(errorUrl.toString());\r\n    }\r\n\r\n    if (data.session) {\r\n      console.log(\"✅ Session créée avec succès\");\r\n      console.log(\"👤 Utilisateur connecté:\", data.user?.email);\r\n\r\n      // Si c'est une vérification d'email (type=signup), rediriger vers la home avec un message de succès\r\n      const isEmailVerification = searchParams.get(\"type\") === \"signup\" ||\r\n        searchParams.get(\"type\") === \"email\";\r\n\r\n      if (isEmailVerification) {\r\n        console.log(\"✅ Email vérifié - redirection vers la home\");\r\n        return NextResponse.redirect(`${origin}/?verified=true`);\r\n      }\r\n\r\n      // Sinon, rediriger vers la page demandée\r\n      return NextResponse.redirect(`${origin}${next}`);\r\n    }\r\n\r\n    // Si pas de session après échange réussi, erreur\r\n    console.error(\"❌ No session after successful exchange\");\r\n    return NextResponse.redirect(`${origin}/auth/auth-code-error`);\r\n  } catch (err) {\r\n    console.error(\"❌ Unexpected error in callback:\", err);\r\n    return NextResponse.redirect(`${origin}/auth/auth-code-error`);\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\check-email\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\check-email\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":8,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":17,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":90,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":90,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":136,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":136,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useSearchParams } from 'next/navigation'\nimport Link from 'next/link'\nimport { Suspense } from 'react'\nimport { Mail, ArrowRight, RefreshCw } from 'lucide-react'\nimport { Button } from '@/components/ui/button'\nimport { useState, useEffect } from 'react'\nimport { toast } from 'sonner'\nimport { createClient } from '@/utils/supabase/client'\nimport { useRouter } from 'next/navigation'\n\n\n\nfunction CheckEmailContent() {\n  const searchParams = useSearchParams()\n  const router = useRouter()\n  const email = searchParams.get('email') || ''\n  const [isResending, setIsResending] = useState(false)\n  const [isVerifying, setIsVerifying] = useState(false)\n\n  // Fonction pour gérer la soumission du code\n  const handleVerify = async (token: string) => {\n    // Supabase envoie parfois 6 ou 8 chiffres selon la config\n    if (token.length < 6) return\n\n    setIsVerifying(true)\n    try {\n      const supabase = createClient()\n      const { data, error } = await supabase.auth.verifyOtp({\n        email,\n        token,\n        type: 'signup'\n      })\n\n      console.log('🔐 verifyOtp result:', { data, error })\n\n      if (!error && data.session) {\n        // Confirmer que la session est bien établie\n        const { data: sessionData } = await supabase.auth.getSession()\n        console.log('🔑 Session confirmée:', sessionData?.session?.user?.email)\n\n        if (sessionData?.session) {\n          toast.success(\"Email vérifié avec succès !\", {\n            description: \"Redirection vers votre compte...\",\n          })\n\n          // Attendre un peu pour que les cookies soient bien persistés\n          await new Promise(resolve => setTimeout(resolve, 500))\n\n          // Forcer un rechargement complet\n          window.location.href = '/'\n        } else {\n          console.error('❌ Session non trouvée après verifyOtp')\n          toast.error(\"Erreur de session\", {\n            description: \"La session n'a pas pu être créée. Veuillez réessayer.\"\n          })\n        }\n      } else {\n        toast.error(\"Code invalide\", {\n          description: error?.message || \"Le code saisi est incorrect ou expiré\"\n        })\n      }\n    } catch (error) {\n      console.error('❌ Erreur verifyOtp:', error)\n      toast.error(\"Une erreur s'est produite lors de la vérification\")\n    } finally {\n      setIsVerifying(false)\n    }\n  }\n\n  const handleResendEmail = async () => {\n    setIsResending(true)\n    try {\n      const supabase = createClient()\n      const { error } = await supabase.auth.resend({\n        type: 'signup',\n        email: email,\n      })\n\n      if (error) {\n        toast.error(\"Erreur\", {\n          description: \"Impossible de renvoyer l'email. Veuillez réessayer dans quelques minutes.\",\n        })\n      } else {\n        toast.success(\"Code renvoyé !\", {\n          description: \"Vérifiez votre boîte de réception pour le nouveau code.\",\n        })\n      }\n    } catch (err) {\n      toast.error(\"Une erreur s'est produite\")\n    } finally {\n      setIsResending(false)\n    }\n  }\n\n  return (\n    <div className=\"flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-background via-background to-black px-4 py-12\">\n      <div className=\"w-full max-w-md\">\n        {/* Card */}\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 p-8 backdrop-blur-xl text-center\">\n          {/* Icon */}\n          <div className=\"mx-auto mb-6 flex h-20 w-20 items-center justify-center rounded-full bg-primary/10\">\n            <Mail className=\"h-10 w-10 text-primary\" />\n          </div>\n\n          {/* Title */}\n          <h1 className=\"mb-4 text-2xl font-bold text-white\">\n            Vérifiez votre email\n          </h1>\n\n          {/* Description */}\n          <div className=\"mb-8 space-y-3 text-white/70\">\n            <p>\n              Un code de confirmation a été envoyé à :\n            </p>\n            <p className=\"font-semibold text-primary\">\n              {email}\n            </p>\n            <p>\n              Saisissez le code reçu (6 ou 8 chiffres) ci-dessous.\n            </p>\n          </div>\n\n          {/* Standard Input for OTP */}\n          <div className=\"mb-6\">\n            <input\n              type=\"text\"\n              name=\"otp\"\n              id=\"otp\"\n              className=\"flex h-12 w-full rounded-xl border border-white/10 bg-white/5 text-center text-2xl tracking-[1em] text-white placeholder:text-white/20 focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500\"\n              placeholder=\"123456\"\n              maxLength={8}\n              autoComplete=\"one-time-code\"\n              disabled={isVerifying}\n              onChange={(e) => {\n                // Auto-verify if 6 or 8 digits could be nice, but explicit button is safer for user experience with variable length\n              }}\n              onKeyDown={(e) => {\n                if (e.key === 'Enter') {\n                  const val = (e.target as HTMLInputElement).value\n                  if (val.length >= 6) handleVerify(val)\n                }\n              }}\n            />\n          </div>\n\n          {isVerifying && (\n            <p className=\"mb-6 text-sm text-primary animate-pulse\">Vérification du code...</p>\n          )}\n\n          {/* Validate Button */}\n          <Button\n            className=\"mb-4 w-full rounded-xl bg-primary text-primary-foreground hover:bg-primary/90\"\n            onClick={() => {\n              const input = document.getElementById('otp') as HTMLInputElement\n              if (input && input.value.length >= 6) {\n                handleVerify(input.value)\n              } else {\n                toast.error(\"Code trop court (minimum 6 chiffres)\")\n              }\n            }}\n            disabled={isVerifying}\n          >\n            {isVerifying ? (\n              <>\n                <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />\n                Vérification...\n              </>\n            ) : (\n              \"Valider\"\n            )}\n          </Button>\n\n          {/* Info Box */}\n          <div className=\"mb-6 rounded-xl bg-primary/10 p-4 text-left\">\n            <p className=\"text-sm text-white/70\">\n              <strong className=\"text-white\">💡 Astuce :</strong> Vérifiez aussi votre dossier spam si vous ne voyez pas l&apos;email.\n            </p>\n          </div>\n\n          {/* Actions */}\n          <div className=\"space-y-3\">\n            {/* Resend Email Button */}\n            <Button\n              variant=\"outline\"\n              className=\"w-full rounded-xl border-white/20 text-white hover:bg-white/10\"\n              onClick={handleResendEmail}\n              disabled={isResending || isVerifying}\n            >\n              {isResending ? (\n                <>\n                  <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Envoi en cours...\n                </>\n              ) : (\n                <>\n                  <RefreshCw className=\"mr-2 h-4 w-4\" />\n                  Renvoyer le code\n                </>\n              )}\n            </Button>\n\n            {/* Back to Login */}\n            <Button\n              variant=\"ghost\"\n              className=\"w-full rounded-xl text-white/70 hover:bg-white/5 hover:text-white\"\n              asChild\n            >\n              <Link href=\"/login\">\n                Retour à la connexion\n                <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Link>\n            </Button>\n          </div>\n\n          {/* Help Text */}\n          <p className=\"mt-6 text-xs text-white/50\">\n            Vous avez des problèmes ?{' '}\n            <Link href=\"/contact\" className=\"text-primary hover:underline\">\n              Contactez le support\n            </Link>\n          </p>\n        </div>\n      </div>\n    </div>\n  )\n}\n\nexport default function CheckEmailPage() {\n  return (\n    <Suspense fallback={\n      <div className=\"flex min-h-screen items-center justify-center\">\n        <div className=\"text-white\">Chargement...</div>\n      </div>\n    }>\n      <CheckEmailContent />\n    </Suspense>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\confirm\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1784,1787],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1784,1787],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\r\nimport { NextResponse } from \"next/server\";\r\n\r\n/**\r\n * Route pour confirmer un email via token\r\n * Alternative au PKCE pour éviter les erreurs \"code verifier not found\"\r\n */\r\nexport async function GET(request: Request) {\r\n  const { searchParams, origin } = new URL(request.url);\r\n\r\n  // Supabase peut envoyer soit token_hash (nouveau) soit code (ancien)\r\n  const token_hash = searchParams.get(\"token_hash\");\r\n  const code = searchParams.get(\"code\");\r\n  const type = searchParams.get(\"type\");\r\n  const next = searchParams.get(\"next\") ?? \"/\";\r\n\r\n  console.log(\"🔍 Auth Confirm Debug:\", {\r\n    token_hash: token_hash ? \"✓ présent\" : \"✗ manquant\",\r\n    code: code ? \"✓ présent\" : \"✗ manquant\",\r\n    type,\r\n    next,\r\n    origin,\r\n  });\r\n\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Si on a un code (ancien format), utiliser exchangeCodeForSession\r\n    if (code) {\r\n      console.log(\"📝 Utilisation de exchangeCodeForSession avec code\");\r\n      const { data, error } = await supabase.auth.exchangeCodeForSession(code);\r\n\r\n      if (error) {\r\n        console.error(\"❌ Error exchanging code:\", error);\r\n        return NextResponse.redirect(\r\n          `${origin}/auth/auth-code-error?reason=${encodeURIComponent(error.message)}`\r\n        );\r\n      }\r\n\r\n      if (data.session) {\r\n        console.log(\"✅ Session créée avec succès via code\");\r\n        return NextResponse.redirect(`${origin}/?verified=true`);\r\n      }\r\n    }\r\n\r\n    // Si on a un token_hash (nouveau format), utiliser verifyOtp\r\n    if (token_hash && type) {\r\n      console.log(\"📝 Utilisation de verifyOtp avec token_hash\");\r\n      const { error } = await supabase.auth.verifyOtp({\r\n        token_hash: token_hash as string,\r\n        type: type as any,\r\n      });\r\n\r\n      if (error) {\r\n        console.error(\"❌ Error verifying token:\", error);\r\n        return NextResponse.redirect(\r\n          `${origin}/auth/auth-code-error?reason=${encodeURIComponent(error.message)}`\r\n        );\r\n      }\r\n\r\n      // Important: Rafraîchir la session pour s'assurer que les cookies sont bien définis\r\n      const { data: { session }, error: sessionError } = await supabase.auth.getSession();\r\n\r\n      if (sessionError || !session) {\r\n        console.error(\"❌ Session non établie après vérification:\", sessionError);\r\n        return NextResponse.redirect(\r\n          `${origin}/auth/auth-code-error?reason=Echec de creation de session`\r\n        );\r\n      }\r\n\r\n      console.log(\"✅ Email vérifié avec succès via token_hash - Session active:\", session.user.email);\r\n      // Redirection vers l'accueil\r\n      return NextResponse.redirect(`${origin}/`);\r\n    }\r\n\r\n    // Si aucun token valide\r\n    console.error(\"❌ No valid token provided\");\r\n    return NextResponse.redirect(\r\n      `${origin}/auth/auth-code-error?reason=Token manquant ou invalide`\r\n    );\r\n  } catch (err) {\r\n    console.error(\"❌ Unexpected error in confirm:\", err);\r\n    return NextResponse.redirect(\r\n      `${origin}/auth/auth-code-error?reason=Erreur inattendue`\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\google\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\verified\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\verify-email\\page.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\verify-email\\page.tsx:21:13\n  19 |     useEffect(() => {\n  20 |         if (!token) {\n> 21 |             setStatus(\"error\");\n     |             ^^^^^^^^^ Avoid calling setState() directly within an effect\n  22 |             setErrorMessage(\"Lien de vérification invalide. Le token est manquant.\");\n  23 |         }\n  24 |     }, [token]);","line":21,"column":13,"nodeType":null,"endLine":21,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, Suspense } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Mail, CheckCircle, XCircle, Loader2, ArrowLeft } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nfunction VerifyEmailContent() {\r\n    const router = useRouter();\r\n    const searchParams = useSearchParams();\r\n    const token = searchParams.get(\"token\");\r\n\r\n    const [status, setStatus] = useState<\"idle\" | \"loading\" | \"success\" | \"error\">(\"idle\");\r\n    const [errorMessage, setErrorMessage] = useState<string>(\"\");\r\n\r\n    // Si pas de token, afficher une erreur\r\n    useEffect(() => {\r\n        if (!token) {\r\n            setStatus(\"error\");\r\n            setErrorMessage(\"Lien de vérification invalide. Le token est manquant.\");\r\n        }\r\n    }, [token]);\r\n\r\n    const handleVerify = async () => {\r\n        if (!token) return;\r\n\r\n        setStatus(\"loading\");\r\n\r\n        try {\r\n            const response = await fetch(\"/api/auth/verify-email\", {\r\n                method: \"POST\",\r\n                headers: {\r\n                    \"Content-Type\": \"application/json\",\r\n                },\r\n                body: JSON.stringify({ token }),\r\n            });\r\n\r\n            const data = await response.json();\r\n\r\n            if (!response.ok || !data.success) {\r\n                setStatus(\"error\");\r\n                setErrorMessage(data.error || \"Erreur lors de la vérification\");\r\n                return;\r\n            }\r\n\r\n            setStatus(\"success\");\r\n        } catch (error) {\r\n            console.error(\"Erreur:\", error);\r\n            setStatus(\"error\");\r\n            setErrorMessage(\"Erreur de connexion. Veuillez réessayer.\");\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-background via-background to-black px-4 py-12\">\r\n            <motion.div\r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                transition={{ duration: 0.5 }}\r\n                className=\"w-full max-w-md\"\r\n            >\r\n                {/* Back Button */}\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    className=\"mb-6 -ml-2 text-white/70 hover:text-white\"\r\n                    asChild\r\n                >\r\n                    <Link href=\"/\">\r\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n                        Retour\r\n                    </Link>\r\n                </Button>\r\n\r\n                {/* Card */}\r\n                <div className=\"rounded-2xl border border-white/10 bg-white/5 p-8 backdrop-blur-xl md:bg-white/10\">\r\n                    {/* Icon */}\r\n                    <div className=\"mb-6 flex justify-center\">\r\n                        <div className={`flex h-20 w-20 items-center justify-center rounded-full ${status === \"success\"\r\n                                ? \"bg-green-500/20\"\r\n                                : status === \"error\"\r\n                                    ? \"bg-red-500/20\"\r\n                                    : \"bg-amber-500/20\"\r\n                            }`}>\r\n                            {status === \"success\" ? (\r\n                                <motion.div\r\n                                    initial={{ scale: 0 }}\r\n                                    animate={{ scale: 1 }}\r\n                                    transition={{ type: \"spring\", duration: 0.5 }}\r\n                                >\r\n                                    <CheckCircle className=\"h-10 w-10 text-green-500\" />\r\n                                </motion.div>\r\n                            ) : status === \"error\" ? (\r\n                                <XCircle className=\"h-10 w-10 text-red-500\" />\r\n                            ) : status === \"loading\" ? (\r\n                                <Loader2 className=\"h-10 w-10 text-amber-500 animate-spin\" />\r\n                            ) : (\r\n                                <Mail className=\"h-10 w-10 text-amber-500\" />\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Content */}\r\n                    <div className=\"text-center space-y-4\">\r\n                        <h1 className=\"text-2xl font-bold text-white\">\r\n                            {status === \"success\"\r\n                                ? \"✅ Email vérifié !\"\r\n                                : status === \"error\"\r\n                                    ? \"❌ Erreur de vérification\"\r\n                                    : status === \"loading\"\r\n                                        ? \"⏳ Vérification en cours...\"\r\n                                        : \"📧 Vérification de votre email\"}\r\n                        </h1>\r\n\r\n                        <p className=\"text-white/70\">\r\n                            {status === \"success\" ? (\r\n                                \"Votre compte a été activé avec succès ! Vous pouvez maintenant vous connecter.\"\r\n                            ) : status === \"error\" ? (\r\n                                errorMessage\r\n                            ) : status === \"loading\" ? (\r\n                                \"Veuillez patienter pendant que nous vérifions votre compte...\"\r\n                            ) : (\r\n                                \"Cliquez sur le bouton ci-dessous pour confirmer votre adresse email et activer votre compte.\"\r\n                            )}\r\n                        </p>\r\n\r\n                        {/* Action Button */}\r\n                        <div className=\"pt-4\">\r\n                            {status === \"idle\" && token && (\r\n                                <Button\r\n                                    onClick={handleVerify}\r\n                                    className=\"w-full h-12 rounded-xl bg-primary text-black hover:bg-primary/90\"\r\n                                >\r\n                                    ✅ Vérifier mon email\r\n                                </Button>\r\n                            )}\r\n\r\n                            {status === \"success\" && (\r\n                                <Button\r\n                                    onClick={() => router.push(\"/login\")}\r\n                                    className=\"w-full h-12 rounded-xl bg-green-500 text-white hover:bg-green-600\"\r\n                                >\r\n                                    🚀 Se connecter\r\n                                </Button>\r\n                            )}\r\n\r\n                            {status === \"error\" && (\r\n                                <div className=\"space-y-3\">\r\n                                    <Button\r\n                                        onClick={() => router.push(\"/register\")}\r\n                                        className=\"w-full h-12 rounded-xl bg-primary text-black hover:bg-primary/90\"\r\n                                    >\r\n                                        Créer un nouveau compte\r\n                                    </Button>\r\n                                    <Button\r\n                                        variant=\"outline\"\r\n                                        onClick={() => router.push(\"/login\")}\r\n                                        className=\"w-full h-12 rounded-xl border-white/20 text-white hover:bg-white/10\"\r\n                                    >\r\n                                        Se connecter\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n\r\n                            {status === \"loading\" && (\r\n                                <Button\r\n                                    disabled\r\n                                    className=\"w-full h-12 rounded-xl bg-gray-600 text-gray-400\"\r\n                                >\r\n                                    <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\r\n                                    Vérification...\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </motion.div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default function VerifyEmailPage() {\r\n    return (\r\n        <Suspense fallback={\r\n            <div className=\"flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-background via-background to-black px-4 py-12\">\r\n                <div className=\"flex flex-col items-center gap-4\">\r\n                    <Loader2 className=\"h-10 w-10 text-amber-500 animate-spin\" />\r\n                    <p className=\"text-white/70\">Chargement...</p>\r\n                </div>\r\n            </div>\r\n        }>\r\n            <VerifyEmailContent />\r\n        </Suspense>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\biens\\[id]\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\biens\\[id]\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\biens\\[id]\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\biens\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\cgu\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profileError' is assigned a value but never used.","line":142,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":142,"endColumn":51},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'parseError' is defined but never used.","line":958,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":958,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { validateTenantCreation } from '@/lib/finance';\r\nimport { sendEmail } from '@/lib/mail';\r\n\r\n/**\r\n * Calcule les statistiques financières en temps réel\r\n */\r\nexport async function getRentalStats() {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) return { collected: \"0\", pending: \"0\", overdue: \"0\" };\r\n\r\n    const today = new Date();\r\n    const currentDay = today.getDate();\r\n    const currentMonth = today.getMonth() + 1;\r\n    const currentYear = today.getFullYear();\r\n\r\n    // 1. Récupérer tous les baux actifs (revenus attendus)\r\n    const { data: activeLeases } = await supabase\r\n        .from('leases')\r\n        .select('id, monthly_amount, billing_day')\r\n        .eq('owner_id', user.id)\r\n        .eq('status', 'active');\r\n\r\n    // 2. Récupérer les transactions de ce mois\r\n    const { data: paidTrans } = await supabase\r\n        .from('rental_transactions')\r\n        .select('lease_id, amount_due, status')\r\n        .eq('period_month', currentMonth)\r\n        .eq('period_year', currentYear)\r\n        // On filtre sur les leases du user via le join implicite ou une requête séparée.\r\n        // Ici on suppose que rental_transactions est fiable, mais pour sécu on peut join.\r\n        // Cependant pour perf on va filtrer en JS avec la liste des activeLeases\r\n        .in('lease_id', (activeLeases || []).map(l => l.id));\r\n\r\n    let collected = 0;\r\n    let pending = 0;\r\n    let overdue = 0;\r\n\r\n    const paidLeaseIds = new Set();\r\n\r\n    // Traiter les paiements existants\r\n    paidTrans?.forEach(t => {\r\n        if (t.status === 'paid') {\r\n            collected += Number(t.amount_due);\r\n            paidLeaseIds.add(t.lease_id);\r\n        }\r\n    });\r\n\r\n    // 3. Pour chaque bail actif, vérifier le statut\r\n    activeLeases?.forEach(lease => {\r\n        // Si le bail a déjà été payé (transaction 'paid' trouvée), on ne compte plus en pending/overdue\r\n        if (paidLeaseIds.has(lease.id)) return;\r\n\r\n        const amount = Number(lease.monthly_amount);\r\n\r\n        // Si pas payé, c'est soit pending, soit overdue selon la date\r\n        if (currentDay > (lease.billing_day || 5)) {\r\n            overdue += amount;\r\n        } else {\r\n            pending += amount;\r\n        }\r\n    });\r\n\r\n    return {\r\n        collected: collected.toLocaleString('fr-FR'),\r\n        pending: pending.toLocaleString('fr-FR'),\r\n        overdue: overdue.toLocaleString('fr-FR')\r\n    };\r\n}\r\n\r\n\r\n/**\r\n * Fonction utilitaire pour envoyer les données à n8n\r\n * Les webhooks n8n doivent être configurés pour recevoir ces événements\r\n */\r\nasync function triggerN8N(webhookPath: string, payload: Record<string, unknown>) {\r\n    const N8N_URL = process.env.N8N_WEBHOOK_URL; // URL de l'instance n8n\r\n    if (!N8N_URL) {\r\n        console.warn('N8N_WEBHOOK_URL non configuré - webhook ignoré');\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const response = await fetch(`${N8N_URL}/${webhookPath}`, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                ...payload,\r\n                timestamp: new Date().toISOString(),\r\n                source: 'dousell-immo'\r\n            }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            console.error(`Webhook n8n (${webhookPath}) - Erreur HTTP:`, response.status);\r\n        }\r\n    } catch (err) {\r\n        console.error(`Erreur Webhook n8n (${webhookPath}):`, err);\r\n    }\r\n}\r\n\r\n/**\r\n * Enregistre un nouveau locataire et son bail\r\n * Déclenche la génération automatique du contrat PDF via n8n\r\n */\r\nexport async function createNewLease(formData: Record<string, unknown>) {\r\n    const supabase = await createClient();\r\n\r\n    // Récupérer l'utilisateur courant\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        console.error(\"Création bail: utilisateur non authentifié\");\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    // IMPORTANT: On force l'owner_id de l'utilisateur connecté (sécurité)\r\n    const finalData = {\r\n        ...formData,\r\n        owner_id: user.id  // Toujours forcer l'ID du propriétaire connecté\r\n    };\r\n\r\n    // 1. Vérification STRICTE d'unicité via FinanceGuard (Pilier 2)\r\n    const emailToCheck = (finalData as Record<string, unknown>).tenant_email as string | undefined;\r\n    if (emailToCheck) {\r\n        const validation = await validateTenantCreation(emailToCheck, supabase, user.id);\r\n\r\n        if (!validation.valid) {\r\n            return {\r\n                success: false,\r\n                error: validation.error || \"Erreur de validation\"\r\n            };\r\n        }\r\n    }\r\n\r\n    // 1.5 Vérifier que le profil utilisateur existe (Contrainte FK leases_owner_id_fkey)\r\n    const { data: userProfile, error: profileError } = await supabase\r\n        .from('profiles')\r\n        .select('id')\r\n        .eq('id', user.id)\r\n        .maybeSingle();\r\n\r\n    if (!userProfile) {\r\n        // Fallback: Créer le profil s'il n'existe pas (Mode résilient)\r\n        const { error: insertProfileError } = await supabase\r\n            .from('profiles')\r\n            .insert([{\r\n                id: user.id,\r\n                email: user.email,\r\n                full_name: user.user_metadata?.full_name || user.email?.split('@')[0] || 'Propriétaire',\r\n                created_at: new Date().toISOString(),\r\n                updated_at: new Date().toISOString()\r\n            }]);\r\n\r\n        if (insertProfileError) {\r\n            console.error(\"Erreur auto-création profil:\", insertProfileError);\r\n            return { success: false, error: \"Impossible de créer le bail : Votre profil propriétaire est introuvable.\" };\r\n        }\r\n    }\r\n\r\n    const { data: lease, error } = await supabase\r\n        .from('leases')\r\n        .insert([finalData])\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error(\"Erreur création bail:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    // 2. Créer automatiquement la transaction pour le mois en cours\r\n    const today = new Date();\r\n    const currentMonth = today.getMonth() + 1;\r\n    const currentYear = today.getFullYear();\r\n\r\n    const { error: transError } = await supabase\r\n        .from('rental_transactions')\r\n        .insert([{\r\n            lease_id: lease.id,\r\n            period_month: currentMonth,\r\n            period_year: currentYear,\r\n            amount_due: lease.monthly_amount,\r\n            status: 'pending',\r\n            period_start: new Date(currentYear, currentMonth - 1, 1).toISOString().split('T')[0],\r\n            period_end: new Date(currentYear, currentMonth, 0).toISOString().split('T')[0],\r\n            reminder_sent: false\r\n        }]);\r\n\r\n    if (transError) {\r\n        console.error(\"Erreur création transaction:\", transError.message);\r\n        // On ne bloque pas la création du bail, mais on log l'erreur\r\n    }\r\n\r\n    // DÉCLENCHEUR N8N : Génération du contrat de bail PDF (email)\r\n    await triggerN8N('generate-lease-pdf', {\r\n        leaseId: lease.id,\r\n        tenantName: lease.tenant_name,\r\n        tenantEmail: lease.tenant_email,\r\n        tenantPhone: lease.tenant_phone,\r\n        amount: lease.monthly_amount,\r\n        currency: 'FCFA',\r\n        startDate: lease.start_date,\r\n        billingDay: lease.billing_day,\r\n        ownerEmail: user.email,\r\n        ownerId: user.id\r\n    });\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return { success: true, id: lease.id };\r\n}\r\n\r\n/**\r\n * Marque un loyer comme payé\r\n * Déclenche l'envoi automatique de la quittance par EMAIL via n8n\r\n */\r\n/**\r\n * Marque un loyer comme payé\r\n * Déclenche l'envoi automatique de la quittance par EMAIL via n8n\r\n * Si pas d'ID de transaction, en crée une pour le mois courant\r\n */\r\nexport async function confirmPayment(leaseId: string, transactionId?: string) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) return { success: false, error: \"Non autorisé\" };\r\n\r\n    let targetId = transactionId;\r\n\r\n    // 1. Si pas de transactionID, on en crée une pour le mois actuel\r\n    if (!targetId) {\r\n        // Récupérer le montant du bail\r\n        const { data: lease } = await supabase\r\n            .from('leases')\r\n            .select('monthly_amount')\r\n            .eq('id', leaseId)\r\n            .single();\r\n\r\n        if (!lease) return { success: false, error: \"Bail introuvable\" };\r\n\r\n        const { data: newTrans, error: insertError } = await supabase\r\n            .from('rental_transactions')\r\n            .insert([{\r\n                lease_id: leaseId,\r\n                period_month: new Date().getMonth() + 1,\r\n                period_year: new Date().getFullYear(),\r\n                amount_due: lease.monthly_amount,\r\n                status: 'pending'\r\n            }])\r\n            .select()\r\n            .single();\r\n\r\n        if (insertError) {\r\n            console.error(\"Erreur création transaction:\", insertError.message);\r\n            return { success: false, error: insertError.message };\r\n        }\r\n        targetId = newTrans.id;\r\n    }\r\n\r\n    // 2. Mise à jour de la transaction en 'paid' avec récupération des données pour email\r\n    const { data: trans, error } = await supabase\r\n        .from('rental_transactions')\r\n        .update({\r\n            status: 'paid',\r\n            paid_at: new Date().toISOString()\r\n        })\r\n        .eq('id', targetId)\r\n        .select('*, leases(tenant_name, tenant_email, monthly_amount, owner_id, property_address)')\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error(\"Erreur confirmation paiement:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    // 4. Récupérer le profil du propriétaire pour les infos de l'agence\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('company_name, company_address, company_email, company_ninea, signature_url, logo_url, full_name')\r\n        .eq('id', user.id)\r\n        .maybeSingle();\r\n\r\n    // 5. Envoi automatique de la quittance par email (Gmail direct)\r\n    let emailSent = false;\r\n\r\n    if (trans && trans.leases && trans.leases.tenant_email) {\r\n        try {\r\n            // Préparer les données pour la quittance\r\n            const receiptData = {\r\n                // Locataire\r\n                tenantName: trans.leases.tenant_name || 'Locataire',\r\n                tenantEmail: trans.leases.tenant_email,\r\n                tenantAddress: trans.leases.property_address || '',\r\n\r\n                // Montants\r\n                amount: trans.amount_due || 0,\r\n\r\n                // Période\r\n                periodMonth: new Date(trans.period_year, trans.period_month - 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }),\r\n                periodStart: `01/${String(trans.period_month).padStart(2, '0')}/${trans.period_year}`,\r\n                periodEnd: `${new Date(trans.period_year, trans.period_month, 0).getDate()}/${String(trans.period_month).padStart(2, '0')}/${trans.period_year}`,\r\n\r\n                // Référence\r\n                receiptNumber: `QUITT-${Date.now().toString().slice(-8)}`,\r\n\r\n                // Propriétaire / Agence\r\n                ownerName: profile?.company_name || profile?.full_name || 'Propriétaire',\r\n                ownerAddress: profile?.company_address || '',\r\n                ownerNinea: profile?.company_ninea || '',\r\n                ownerLogo: profile?.logo_url || undefined,\r\n                ownerSignature: profile?.signature_url || undefined,\r\n                ownerEmail: profile?.company_email || undefined, // Email de l'agence (priorité)\r\n                ownerAccountEmail: user.email, // Email du compte (fallback)\r\n\r\n                // Propriété\r\n                propertyAddress: trans.leases.property_address || 'Adresse non renseignée',\r\n            };\r\n\r\n            // Appel à l'API /api/send-receipt (pas d'await pour ne pas bloquer)\r\n            fetch('/api/send-receipt', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(receiptData),\r\n            })\r\n                .then(res => res.json())\r\n                .then(result => {\r\n                    if (result.success) {\r\n                        console.log('✅ Quittance envoyée:', result.messageId);\r\n                    } else {\r\n                        console.error('❌ Erreur envoi quittance:', result.error);\r\n                    }\r\n                })\r\n                .catch(err => console.error('❌ Erreur appel API quittance:', err));\r\n\r\n            emailSent = true;\r\n        } catch (err) {\r\n            console.error('❌ Erreur préparation quittance:', err);\r\n        }\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n\r\n    // Message personnalisé selon si l'email a été déclenché\r\n    const message = emailSent\r\n        ? `Paiement validé ! La quittance sera envoyée par email au locataire (${trans.leases?.tenant_email}) avec copie au propriétaire.`\r\n        : \"Paiement validé ! Vous pouvez générer la quittance manuellement.\";\r\n\r\n    return { success: true, message };\r\n}\r\n\r\n/**\r\n * Met à jour les informations d'un locataire/bail\r\n */\r\nexport async function updateLease(leaseId: string, data: {\r\n    tenant_name?: string;\r\n    tenant_phone?: string;\r\n    tenant_email?: string;\r\n    property_address?: string;\r\n    monthly_amount?: number;\r\n    billing_day?: number;\r\n    start_date?: string;\r\n    end_date?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    // Vérifier que le bail appartient à l'utilisateur\r\n    const { data: lease } = await supabase\r\n        .from('leases')\r\n        .select('owner_id')\r\n        .eq('id', leaseId)\r\n        .single();\r\n\r\n    if (!lease || lease.owner_id !== user.id) {\r\n        return { success: false, error: \"Bail non trouvé ou non autorisé\" };\r\n    }\r\n\r\n    // Ne mettre à jour que les colonnes qui existent\r\n    const updateData: Record<string, string | number | undefined> = {};\r\n    if (data.tenant_name !== undefined) updateData.tenant_name = data.tenant_name;\r\n    if (data.tenant_phone !== undefined) updateData.tenant_phone = data.tenant_phone;\r\n    if (data.tenant_email !== undefined) updateData.tenant_email = data.tenant_email;\r\n    if (data.property_address !== undefined) updateData.property_address = data.property_address;\r\n    if (data.monthly_amount !== undefined) updateData.monthly_amount = data.monthly_amount;\r\n    if (data.billing_day !== undefined) updateData.billing_day = data.billing_day;\r\n    if (data.start_date !== undefined) updateData.start_date = data.start_date;\r\n    if (data.end_date !== undefined) updateData.end_date = data.end_date;\r\n\r\n    const { error } = await supabase\r\n        .from('leases')\r\n        .update(updateData)\r\n        .eq('id', leaseId);\r\n\r\n    if (error) {\r\n        console.error(\"Erreur mise à jour bail:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return { success: true };\r\n}\r\n\r\n/**\r\n * Résilier un bail (Suppression logique - conserve l'historique)\r\n * Change le statut à 'terminated' et enregistre la date de fin\r\n */\r\nexport async function terminateLease(leaseId: string) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    // Vérifier que le bail appartient à l'utilisateur\r\n    const { data: lease } = await supabase\r\n        .from('leases')\r\n        .select('owner_id, tenant_name')\r\n        .eq('id', leaseId)\r\n        .single();\r\n\r\n    if (!lease) {\r\n        return { success: false, error: \"Bail introuvable\" };\r\n    }\r\n\r\n    if (lease.owner_id !== user.id) {\r\n        return { success: false, error: \"Action non autorisée\" };\r\n    }\r\n\r\n    // Marquer le bail comme résilié\r\n    const { error } = await supabase\r\n        .from('leases')\r\n        .update({\r\n            status: 'terminated'\r\n            // Note: end_date sera ajouté plus tard via migration\r\n        })\r\n        .eq('id', leaseId);\r\n\r\n    if (error) {\r\n        console.error(\"Erreur résiliation bail:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return {\r\n        success: true,\r\n        message: `Le bail de ${lease.tenant_name} a été résilié. L'historique reste accessible.`\r\n    };\r\n}\r\n\r\n/**\r\n * Réactiver un bail résilié\r\n * Change le statut de 'terminated' à 'active'\r\n */\r\nexport async function reactivateLease(leaseId: string) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    // Vérifier que le bail appartient à l'utilisateur\r\n    const { data: lease } = await supabase\r\n        .from('leases')\r\n        .select('owner_id, tenant_name, status')\r\n        .eq('id', leaseId)\r\n        .single();\r\n\r\n    if (!lease) {\r\n        return { success: false, error: \"Bail introuvable\" };\r\n    }\r\n\r\n    if (lease.owner_id !== user.id) {\r\n        return { success: false, error: \"Action non autorisée\" };\r\n    }\r\n\r\n    if (lease.status !== 'terminated') {\r\n        return { success: false, error: \"Ce bail n'est pas résilié\" };\r\n    }\r\n\r\n    // Réactiver le bail\r\n    const { error } = await supabase\r\n        .from('leases')\r\n        .update({\r\n            status: 'active'\r\n            // Note: end_date sera supprimé plus tard via migration\r\n        })\r\n        .eq('id', leaseId);\r\n\r\n    if (error) {\r\n        console.error(\"Erreur réactivation bail:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return {\r\n        success: true,\r\n        message: `Le bail de ${lease.tenant_name} a été réactivé.`\r\n    };\r\n}\r\n\r\n/**\r\n * Signaler une demande de maintenance\r\n * Peut être signalé par le propriétaire (avec sélection du bail) ou le locataire\r\n */\r\nexport async function createMaintenanceRequest(data: {\r\n    leaseId?: string;\r\n    description: string;\r\n    category?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    // Si pas de leaseId fourni, prendre le premier bail actif du propriétaire\r\n    let targetLeaseId = data.leaseId;\r\n\r\n    if (!targetLeaseId) {\r\n        const { data: firstLease } = await supabase\r\n            .from('leases')\r\n            .select('id')\r\n            .eq('owner_id', user.id)\r\n            .eq('status', 'active')\r\n            .limit(1)\r\n            .single();\r\n\r\n        if (!firstLease) {\r\n            return { success: false, error: \"Aucun bail actif trouvé\" };\r\n        }\r\n        targetLeaseId = firstLease.id;\r\n    }\r\n\r\n    // 1. Récupérer les infos du bail pour le contexte (Adresse pour Google Maps)\r\n    const { data: leaseContext } = await supabase\r\n        .from('leases')\r\n        .select('property_address, tenant_name, tenant_phone, tenant_email')\r\n        .eq('id', targetLeaseId)\r\n        .single();\r\n\r\n    // Variables pour stocker les infos artisan\r\n    let artisanData: {\r\n        name?: string;\r\n        phone?: string;\r\n        rating?: number;\r\n        address?: string;\r\n    } = {};\r\n    let status = 'open';\r\n\r\n    // 2. APPEL DU WEBHOOK MAKE (Recherche Artisan)\r\n    const MAKE_WEBHOOK_URL = process.env.MAKE_WEBHOOK_URL || process.env.N8N_WEBHOOK_URL;\r\n\r\n    if (MAKE_WEBHOOK_URL) {\r\n        try {\r\n            const response = await fetch(MAKE_WEBHOOK_URL, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    category: data.category || \"General\",\r\n                    location: leaseContext?.property_address || \"Dakar, Sénégal\",\r\n                    issue: data.description,\r\n                    tenantName: leaseContext?.tenant_name,\r\n                    tenantPhone: leaseContext?.tenant_phone,\r\n                    tenantEmail: leaseContext?.tenant_email,\r\n                    webhookType: 'find_artisan'\r\n                })\r\n            });\r\n\r\n            if (response.ok) {\r\n                const result = await response.json();\r\n                if (result.artisan_name) {\r\n                    artisanData = {\r\n                        name: result.artisan_name,\r\n                        phone: result.artisan_phone,\r\n                        rating: parseFloat(result.rating) || undefined,\r\n                        address: result.address\r\n                    };\r\n                    status = 'artisan_found'; // Nouveau statut clair\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Erreur Webhook Make:\", e);\r\n        }\r\n    }\r\n\r\n    // 3. Enregistrer la demande en base avec colonnes dédiées\r\n    const { data: request, error } = await supabase\r\n        .from('maintenance_requests')\r\n        .insert([{\r\n            lease_id: targetLeaseId,\r\n            description: data.description,\r\n            status: status,\r\n            // Colonnes dédiées pour l'artisan (après migration)\r\n            artisan_name: artisanData.name || null,\r\n            artisan_phone: artisanData.phone || null,\r\n            artisan_rating: artisanData.rating || null,\r\n            artisan_address: artisanData.address || null\r\n        }])\r\n        .select('id, description, status, created_at, artisan_name, artisan_phone')\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error(\"Erreur création demande maintenance:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n\r\n    return {\r\n        success: true,\r\n        id: request.id,\r\n        artisanFound: status === 'artisan_found',\r\n        artisan: artisanData.name ? artisanData : null,\r\n        message: status === 'artisan_found' ? \"Artisan trouvé !\" : \"Demande enregistrée.\"\r\n    };\r\n}\r\n\r\n/**\r\n * Saisir le devis réel après contact avec l'artisan\r\n * Passe le statut à 'awaiting_approval' pour validation propriétaire\r\n */\r\nexport async function submitQuote(requestId: string, data: {\r\n    quoted_price: number;\r\n    intervention_date: string;\r\n}) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) return { success: false, error: \"Non autorisé\" };\r\n\r\n    const { error } = await supabase\r\n        .from('maintenance_requests')\r\n        .update({\r\n            quoted_price: data.quoted_price,\r\n            intervention_date: data.intervention_date,\r\n            status: 'awaiting_approval' // En attente de validation propriétaire\r\n        })\r\n        .eq('id', requestId);\r\n\r\n    if (error) {\r\n        console.error(\"Erreur saisie devis:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return { success: true, message: \"Devis enregistré, en attente de validation.\" };\r\n}\r\n\r\n/**\r\n * Le propriétaire approuve le devis\r\n * Passe le statut à 'approved' et lance les travaux\r\n */\r\nexport async function approveQuoteByOwner(requestId: string) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) return { success: false, error: \"Non autorisé\" };\r\n\r\n    const { data: request, error } = await supabase\r\n        .from('maintenance_requests')\r\n        .update({\r\n            status: 'approved',\r\n            owner_approved: true\r\n        })\r\n        .eq('id', requestId)\r\n        .select('*, leases(tenant_name, tenant_email, owner_id)')\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error(\"Erreur approbation devis:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    // Récupérer les informations complètes du bail pour l'email\r\n    const lease = Array.isArray(request.leases) ? request.leases[0] : request.leases;\r\n    const tenantEmail = lease?.tenant_email;\r\n    const tenantName = lease?.tenant_name;\r\n\r\n    // Notification à l'artisan via webhook\r\n    await triggerN8N('maintenance-quote-approved', {\r\n        requestId: request.id,\r\n        description: request.description,\r\n        quoteAmount: request.quoted_price,\r\n        artisanPhone: request.artisan_phone\r\n    });\r\n\r\n    // Notification au locataire par email (Nodemailer)\r\n    if (tenantEmail && request.artisan_name) {\r\n        const datePrevue = request.intervention_date\r\n            ? new Date(request.intervention_date).toLocaleDateString('fr-FR')\r\n            : 'à confirmer';\r\n\r\n        try {\r\n            await sendEmail({\r\n                to: tenantEmail,\r\n                subject: `✅ Intervention validée : ${request.description}`,\r\n                html: `\r\n                    <div style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; background-color: #f9fafb; padding: 20px;\">\r\n                        <div style=\"background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 30px 20px; border-radius: 10px 10px 0 0; text-align: center;\">\r\n                            <h1 style=\"margin: 0; font-size: 24px;\">✅ Intervention Validée</h1>\r\n                        </div>\r\n\r\n                        <div style=\"background-color: white; padding: 30px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\r\n                            <p style=\"font-size: 16px; color: #374151; margin-bottom: 20px;\">\r\n                                Bonjour <strong>${tenantName || 'Locataire'}</strong>,\r\n                            </p>\r\n\r\n                            <p style=\"font-size: 14px; color: #6b7280; line-height: 1.6;\">\r\n                                Bonne nouvelle ! La demande d'intervention pour <strong style=\"color: #16a34a;\">${request.description}</strong> a été validée par le propriétaire.\r\n                            </p>\r\n\r\n                            <div style=\"background-color: #f0fdf4; border-left: 4px solid #16a34a; padding: 20px; margin: 25px 0; border-radius: 8px;\">\r\n                                <p style=\"margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #15803d; font-weight: bold;\">\r\n                                    👷‍♂️ Artisan Assigné\r\n                                </p>\r\n                                <h2 style=\"margin: 10px 0; font-size: 20px; color: #111827;\">${request.artisan_name}</h2>\r\n\r\n                                <div style=\"margin-top: 15px;\">\r\n                                    <p style=\"margin: 5px 0; font-size: 14px; color: #374151;\">\r\n                                        <strong>📞 Téléphone :</strong>\r\n                                        <a href=\"tel:${request.artisan_phone}\" style=\"color: #16a34a; text-decoration: none; font-weight: 600;\">${request.artisan_phone}</a>\r\n                                    </p>\r\n                                    ${request.artisan_address ? `\r\n                                    <p style=\"margin: 5px 0; font-size: 14px; color: #374151;\">\r\n                                        <strong>📍 Adresse :</strong> ${request.artisan_address}\r\n                                    </p>` : ''}\r\n                                    <p style=\"margin: 5px 0; font-size: 14px; color: #374151;\">\r\n                                        <strong>📅 Date prévue :</strong> ${datePrevue}\r\n                                    </p>\r\n                                    ${request.quoted_price ? `\r\n                                    <p style=\"margin: 5px 0; font-size: 14px; color: #374151;\">\r\n                                        <strong>💰 Montant :</strong> ${request.quoted_price.toLocaleString('fr-FR')} FCFA\r\n                                    </p>` : ''}\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div style=\"background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin-top: 20px;\">\r\n                                <p style=\"margin: 0; font-size: 13px; color: #92400e;\">\r\n                                    <strong>ℹ️ Que faire maintenant ?</strong><br/>\r\n                                    L'artisan a été notifié et devrait vous contacter sous peu. Si vous ne recevez pas d'appel dans les 24h, n'hésitez pas à le contacter directement au numéro ci-dessus.\r\n                                </p>\r\n                            </div>\r\n\r\n                            <p style=\"font-size: 14px; color: #6b7280; margin-top: 30px; line-height: 1.6;\">\r\n                                Cordialement,<br/>\r\n                                <strong style=\"color: #111827;\">L'équipe de Gestion</strong>\r\n                            </p>\r\n\r\n                            <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 25px 0;\" />\r\n\r\n                            <p style=\"font-size: 11px; color: #9ca3af; text-align: center; margin: 0;\">\r\n                                Cet email a été envoyé automatiquement. Pour toute question, contactez votre propriétaire.\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                `\r\n            });\r\n            console.log(`✅ Email envoyé à ${tenantEmail} pour intervention ${request.description}`);\r\n        } catch (emailError) {\r\n            console.error(\"❌ Erreur envoi email locataire:\", emailError);\r\n            // On ne bloque pas le workflow si l'email échoue\r\n        }\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return { success: true, message: \"Devis approuvé ! Le locataire et l'artisan ont été notifiés.\" };\r\n}\r\n\r\n/**\r\n * Terminer l'intervention et créer la dépense comptable\r\n * Crée automatiquement une ligne dans la table 'expenses'\r\n */\r\nexport async function completeIntervention(requestId: string) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) return { success: false, error: \"Non autorisé\" };\r\n\r\n    // 1. Récupérer les détails de l'intervention\r\n    const { data: request, error: fetchError } = await supabase\r\n        .from('maintenance_requests')\r\n        .select('*, leases(owner_id, property_id)')\r\n        .eq('id', requestId)\r\n        .single();\r\n\r\n    if (fetchError || !request) {\r\n        return { success: false, error: \"Intervention introuvable\" };\r\n    }\r\n\r\n    // Vérifier que le devis a été approuvé\r\n    if (!request.owner_approved) {\r\n        return { success: false, error: \"Le devis doit être approuvé avant de terminer.\" };\r\n    }\r\n\r\n    // 2. Mettre à jour le statut de l'intervention\r\n    const { error: updateError } = await supabase\r\n        .from('maintenance_requests')\r\n        .update({\r\n            status: 'completed',\r\n            completed_at: new Date().toISOString()\r\n        })\r\n        .eq('id', requestId);\r\n\r\n    if (updateError) {\r\n        return { success: false, error: updateError.message };\r\n    }\r\n\r\n    // 3. Créer la dépense comptable\r\n    const leaseData = request.leases as { owner_id: string; property_id?: string } | null;\r\n\r\n    if (leaseData && request.quoted_price) {\r\n        const { error: expenseError } = await supabase\r\n            .from('expenses')\r\n            .insert([{\r\n                owner_id: leaseData.owner_id,\r\n                property_id: leaseData.property_id || null,\r\n                maintenance_request_id: requestId,\r\n                description: `Intervention: ${request.description} (${request.artisan_name || 'Artisan'})`,\r\n                amount: request.quoted_price,\r\n                category: 'maintenance',\r\n                expense_date: new Date().toISOString().split('T')[0]\r\n            }]);\r\n\r\n        if (expenseError) {\r\n            console.error(\"Erreur création dépense:\", expenseError.message);\r\n            // On ne bloque pas la clôture, mais on log l'erreur\r\n        }\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return {\r\n        success: true,\r\n        message: `Intervention terminée ! Dépense de ${request.quoted_price?.toLocaleString('fr-FR')} FCFA enregistrée.`\r\n    };\r\n}\r\n\r\n/**\r\n * Récupérer les baux actifs (pour le select du formulaire de signalement)\r\n */\r\nexport async function getActiveLeases() {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, data: [] };\r\n    }\r\n\r\n    const { data: leases, error } = await supabase\r\n        .from('leases')\r\n        .select('id, tenant_name, property_address')\r\n        .eq('owner_id', user.id)\r\n        .eq('status', 'active');\r\n\r\n    if (error) {\r\n        return { success: false, data: [] };\r\n    }\r\n\r\n    return { success: true, data: leases || [] };\r\n}\r\n\r\n/**\r\n * Envoie les données de quittance à Pipedream\r\n * Formate correctement le payload pour le webhook Pipedream\r\n */\r\nexport async function sendReceiptToN8N(data: Record<string, unknown>) {\r\n    // 1. On récupère l'URL Pipedream définie dans .env.local\r\n    const WEBHOOK_URL = process.env.NEXT_PUBLIC_WEBHOOK_URL;\r\n\r\n    if (!WEBHOOK_URL) {\r\n        console.error(\"URL Pipedream manquante !\");\r\n        return { success: false, error: \"Configuration webhook manquante\" };\r\n    }\r\n\r\n    // 2. On prépare le paquet de données (L'enveloppe)\r\n    // On mappe vos données Supabase vers les noms attendus par Pipedream\r\n\r\n    // Debug: Voir ce qu'on reçoit vraiment\r\n    console.log(\"=\".repeat(80));\r\n    console.log(\"📦 DONNÉES BRUTES REÇUES AVANT ENVOI:\");\r\n    const tenant = data.tenant as Record<string, unknown> | undefined;\r\n    const profile = data.profile as Record<string, unknown> | undefined;\r\n    console.log(\"📧 Email du tenant:\", tenant?.email);\r\n    console.log(\"📞 Téléphone du tenant:\", tenant?.phone);\r\n    console.log(\"👤 Objet tenant complet:\", JSON.stringify(tenant, null, 2));\r\n    console.log(\"=\".repeat(80));\r\n\r\n    const payload = {\r\n        // Infos Locataire\r\n        tenantName: tenant?.tenant_name || tenant?.name || '',\r\n        tenantEmail: tenant?.email || tenant?.tenant_email || '',\r\n        tenantPhone: tenant?.phone || tenant?.tenant_phone || '',\r\n        tenantAddress: tenant?.address || (data.property_address as string) || '',\r\n\r\n        // Infos Paiement\r\n        amount: Number(data.amount) || 0,\r\n        periodMonth: data.periodMonth || `${data.month || new Date().getMonth() + 1}/2025`,\r\n        periodStart: data.periodStart || `01/${data.month || new Date().getMonth() + 1}/2025`,\r\n        periodEnd: data.periodEnd || `30/${data.month || new Date().getMonth() + 1}/2025`,\r\n        receiptNumber: data.receiptNumber || `QUITT-${Date.now().toString().slice(-6)}`,\r\n\r\n        // Infos Propriétaire (Baraka Immo)\r\n        ownerName: profile?.company_name || profile?.full_name || 'Propriétaire',\r\n        ownerEmail: profile?.email || '',\r\n        ownerLogo: profile?.logo_url || null,\r\n        ownerSignature: profile?.signature_url || null,\r\n        ownerAddress: profile?.company_address || '',\r\n        ownerNinea: profile?.ninea || '',\r\n\r\n        // Infos Propriété\r\n        propertyAddress: (data.property_address as string) || tenant?.address || '',\r\n\r\n        // Image de la quittance (si générée côté client)\r\n        receiptImage: data.receiptImage || null\r\n    };\r\n\r\n    console.log(\"📤 Envoi à Pipedream :\", JSON.stringify(payload, null, 2)); // Pour vérifier dans vos logs serveur\r\n\r\n    try {\r\n        // 3. On expédie le tout à Pipedream\r\n        const response = await fetch(WEBHOOK_URL, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json'\r\n            },\r\n            body: JSON.stringify(payload) // Pipedream : envoyer directement le payload, pas enveloppé\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('❌ Erreur Pipedream:', response.status, response.statusText);\r\n            console.error('Réponse brute:', errorText.substring(0, 500)); // Log les 500 premiers caractères\r\n            return {\r\n                success: false,\r\n                error: `Erreur webhook (${response.status}): ${response.statusText}`\r\n            };\r\n        }\r\n\r\n        // Essayer de parser la réponse comme JSON\r\n        const responseText = await response.text();\r\n        let result;\r\n\r\n        try {\r\n            result = JSON.parse(responseText);\r\n            console.log(\"✅ Réponse Pipedream:\", result);\r\n            return { success: true, data: result };\r\n        } catch (parseError) {\r\n            // Si ce n'est pas du JSON, c'est probablement du HTML d'erreur\r\n            console.warn(\"⚠️ Réponse non-JSON reçue:\", responseText.substring(0, 200));\r\n\r\n            // On considère quand même que c'est un succès si status 200\r\n            if (response.status === 200) {\r\n                console.log(\"✅ Requête envoyée avec succès (pas de JSON retourné)\");\r\n                return {\r\n                    success: true,\r\n                    data: {\r\n                        message: \"Envoyé à Pipedream (pas de réponse JSON)\",\r\n                        rawResponse: responseText.substring(0, 200)\r\n                    }\r\n                };\r\n            }\r\n\r\n            return {\r\n                success: false,\r\n                error: \"Réponse invalide de Pipedream (pas du JSON)\"\r\n            };\r\n        }\r\n    } catch (error) {\r\n        console.error(\"❌ Echec envoi Pipedream:\", error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : \"Impossible de joindre le webhook\"\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Supprime une transaction (pour nettoyer les doublons générés par erreur)\r\n */\r\nexport async function deleteTransaction(transactionId: string) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    // Sécurité: Vérifier que la transaction appartient bien à un bail de l'utilisateur\r\n    // On fait un join car rental_transactions n'a pas owner_id directement\r\n    const { data: transaction } = await supabase\r\n        .from('rental_transactions')\r\n        .select('lease_id, leases!inner(owner_id)')\r\n        .eq('id', transactionId)\r\n        .single();\r\n\r\n    // Cast sécurisé ou accès flexible car Join Supabase peut être un objet ou tableau selon la version\r\n    const leaseData = transaction?.leases as { owner_id: string } | undefined;\r\n\r\n    if (!transaction || !leaseData || leaseData.owner_id !== user.id) {\r\n        return { success: false, error: \"Transaction introuvable ou non autorisée\" };\r\n    }\r\n\r\n    const { error } = await supabase\r\n        .from('rental_transactions')\r\n        .delete()\r\n        .eq('id', transactionId);\r\n\r\n    if (error) {\r\n        console.error(\"Erreur suppression transaction:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return { success: true };\r\n}\r\n\r\n/**\r\n * Supprime DÉFINITIVEMENT un bail (Fonction de nettoyage)\r\n */\r\nexport async function deleteLease(leaseId: string) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) return { success: false, error: \"Non autorisé\" };\r\n\r\n    const { data: lease } = await supabase\r\n        .from('leases')\r\n        .select('owner_id')\r\n        .eq('id', leaseId)\r\n        .single();\r\n\r\n    if (!lease || lease.owner_id !== user.id) {\r\n        return { success: false, error: \"Bail introuvable ou non autorisé\" };\r\n    }\r\n\r\n    const { error } = await supabase\r\n        .from('leases')\r\n        .delete()\r\n        .eq('id', leaseId);\r\n\r\n    if (error) {\r\n        console.error(\"Erreur suppression bail:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative');\r\n    return { success: true };\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\AddTenantButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[670,673],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[670,673],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from 'react';\r\nimport { Plus, Loader2 } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { createNewLease } from \"../actions\";\r\nimport { toast } from 'sonner';\r\nimport { useRouter } from 'next/navigation';\r\nimport { GenerateContractModal } from '@/components/contracts/GenerateContractModal';\r\n\r\ninterface AddTenantButtonProps {\r\n    ownerId: string;\r\n    trigger?: React.ReactNode;\r\n    profile?: any; // To allow flexibility with Supabase types\r\n    initialData?: {\r\n        name?: string;\r\n        phone?: string;\r\n        email?: string;\r\n        address?: string;\r\n        amount?: number;\r\n        day?: number;\r\n        startDate?: string;\r\n        endDate?: string;\r\n    };\r\n}\r\n\r\nexport function AddTenantButton({ ownerId, trigger, initialData, profile }: AddTenantButtonProps) {\r\n    const [open, setOpen] = useState(false);\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [showProfileAlert, setShowProfileAlert] = useState(false);\r\n\r\n    // Contract Generation Flow State\r\n    const [showContractPrompt, setShowContractPrompt] = useState(false);\r\n    const [showContractModal, setShowContractModal] = useState(false);\r\n    const [createdLease, setCreatedLease] = useState<{ id: string, name: string } | null>(null);\r\n\r\n    const router = useRouter();\r\n\r\n    const handleOpenChange = (isOpen: boolean) => {\r\n        if (isOpen) {\r\n            // Check if profile is complete enough for legal contracts\r\n            // We check for minimal required fields: Name/Company and Address\r\n            const isProfileComplete = profile && (\r\n                (profile.full_name || profile.company_name) &&\r\n                (profile.company_address)\r\n            );\r\n\r\n            if (!isProfileComplete) {\r\n                setShowProfileAlert(true);\r\n                return;\r\n            }\r\n        }\r\n        setOpen(isOpen);\r\n    };\r\n\r\n    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\r\n        e.preventDefault();\r\n        setLoading(true);\r\n        setError(null);\r\n        const formData = new FormData(e.currentTarget);\r\n        const tenantNameVal = formData.get('tenant_name') as string;\r\n\r\n        const data = {\r\n            owner_id: ownerId,\r\n            tenant_name: tenantNameVal,\r\n            tenant_phone: formData.get('tenant_phone') as string,\r\n            tenant_email: formData.get('tenant_email') as string,\r\n            property_address: formData.get('property_address') as string,\r\n            monthly_amount: Number(formData.get('monthly_amount')),\r\n            billing_day: Number(formData.get('billing_day')) || 5,\r\n            start_date: formData.get('start_date') as string,\r\n            end_date: formData.get('end_date') as string || null,\r\n            status: 'active' as const,\r\n        };\r\n\r\n        const result = await createNewLease(data);\r\n        setLoading(false);\r\n\r\n        if (result.success && result.id) {\r\n            toast.success('Locataire ajouté avec succès');\r\n            // Instead of closing immediately, trigger the contract flow\r\n            setCreatedLease({ id: result.id, name: tenantNameVal });\r\n            setOpen(false); // Close the \"Add Tenant\" modal\r\n\r\n            // Short delay to allow smooth transition before showing contract prompt\r\n            setTimeout(() => {\r\n                setShowContractPrompt(true);\r\n            }, 300);\r\n\r\n            router.refresh();\r\n        } else {\r\n            const errorMsg = result.error || 'Erreur lors de la création';\r\n            setError(errorMsg);\r\n            toast.error(errorMsg);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            <Dialog open={open} onOpenChange={handleOpenChange}>\r\n                <DialogTrigger asChild>\r\n                    {trigger ? (\r\n                        trigger\r\n                    ) : (\r\n                        <Button className=\"bg-[#F4C430] text-black hover:bg-[#F4C430]/90 rounded-lg h-9 px-4 font-medium text-sm transition-all\">\r\n                            <Plus className=\"w-4 h-4 mr-1.5\" /> Nouveau\r\n                        </Button>\r\n                    )}\r\n                </DialogTrigger>\r\n                <DialogContent className=\"z-[100] fixed top-[4%] left-[50%] translate-x-[-50%] translate-y-0 sm:top-[50%] sm:translate-y-[-50%] w-[90vw] sm:w-full max-w-lg max-h-[92vh] overflow-y-auto overflow-x-hidden bg-slate-900 border-slate-800 text-white px-4 pt-4 pb-24 sm:p-6 outline-none\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"text-xl font-semibold text-white\">\r\n                            {initialData ? \"Exemple de Bail (Démo)\" : \"Nouveau Locataire\"}\r\n                        </DialogTitle>\r\n                        <DialogDescription className=\"text-slate-400\">\r\n                            {initialData ? \"Ces données sont pré-remplies pour tester la création.\" : \"Remplissez les informations pour créer un nouveau bail\"}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <form onSubmit={handleSubmit} className=\"space-y-4 mt-4\">\r\n                        {/* Zone d'erreur critique */}\r\n                        {error && (\r\n                            <div className=\"bg-red-500/10 border border-red-500/50 rounded-lg p-3 flex items-start gap-3\">\r\n                                <span className=\"text-red-500 mt-0.5\">⚠️</span>\r\n                                <div className=\"space-y-1\">\r\n                                    <h4 className=\"text-sm font-semibold text-red-500\">Erreur Bloquante</h4>\r\n                                    <p className=\"text-sm text-red-200/90\">{error}</p>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-slate-300\">\r\n                                    Nom complet <span className=\"text-red-400\">*</span>\r\n                                </label>\r\n                                <Input\r\n                                    name=\"tenant_name\"\r\n                                    placeholder=\"ex: Mamadou Diop\"\r\n                                    defaultValue={initialData?.name}\r\n                                    required\r\n                                    className=\"bg-slate-800 border-slate-700 text-white\"\r\n                                    whileFocus={{ scale: 1 }}\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-slate-300\">Téléphone</label>\r\n                                <Input\r\n                                    name=\"tenant_phone\"\r\n                                    placeholder=\"ex: +221 77...\"\r\n                                    defaultValue={initialData?.phone}\r\n                                    className=\"bg-slate-800 border-slate-700 text-white\"\r\n                                    whileFocus={{ scale: 1 }}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-300\">\r\n                                Email <span className=\"text-red-400\">*</span>\r\n                                <span className=\"text-xs text-slate-500 ml-2\">(pour l&apos;envoi des quittances)</span>\r\n                            </label>\r\n                            <Input\r\n                                name=\"tenant_email\"\r\n                                type=\"email\"\r\n                                placeholder=\"ex: locataire@email.com\"\r\n                                defaultValue={initialData?.email}\r\n                                required\r\n                                className=\"bg-slate-800 border-slate-700 text-white\"\r\n                                whileFocus={{ scale: 1 }}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-300\">\r\n                                Adresse du bien <span className=\"text-red-400\">*</span>\r\n                            </label>\r\n                            <Input\r\n                                name=\"property_address\"\r\n                                placeholder=\"ex: Appartement F3, Almadies, Dakar\"\r\n                                defaultValue={initialData?.address}\r\n                                required\r\n                                className=\"bg-slate-800 border-slate-700 text-white\"\r\n                                whileFocus={{ scale: 1 }}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-slate-300\">\r\n                                    Loyer (FCFA) <span className=\"text-red-400\">*</span>\r\n                                </label>\r\n                                <Input\r\n                                    name=\"monthly_amount\"\r\n                                    type=\"number\"\r\n                                    placeholder=\"500000\"\r\n                                    defaultValue={initialData?.amount}\r\n                                    required\r\n                                    className=\"bg-slate-800 border-slate-700 text-white font-mono\"\r\n                                    whileFocus={{ scale: 1 }}\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-slate-300\">Jour de paiement</label>\r\n                                <Input\r\n                                    name=\"billing_day\"\r\n                                    type=\"number\"\r\n                                    min=\"1\"\r\n                                    max=\"31\"\r\n                                    defaultValue={initialData?.day || 5}\r\n                                    className=\"bg-slate-800 border-slate-700 text-white\"\r\n                                    whileFocus={{ scale: 1 }}\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-slate-300\">\r\n                                    Début bail <span className=\"text-red-400\">*</span>\r\n                                </label>\r\n                                <Input\r\n                                    name=\"start_date\"\r\n                                    type=\"date\"\r\n                                    defaultValue={initialData?.startDate}\r\n                                    required\r\n                                    className=\"bg-slate-800 border-slate-700 text-white h-10 w-full px-3 block [color-scheme:dark] [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-calendar-picker-indicator]:opacity-60 [&::-webkit-calendar-picker-indicator]:hover:opacity-100 [&::-webkit-calendar-picker-indicator]:ml-auto [&::-webkit-calendar-picker-indicator]:p-1\"\r\n                                    whileFocus={{ scale: 1 }}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-300\">\r\n                                Fin bail <span className=\"text-red-400\">*</span>\r\n                                <span className=\"text-xs text-slate-500 ml-2\">(pour les alertes juridiques J-180 et J-90)</span>\r\n                            </label>\r\n                            <Input\r\n                                name=\"end_date\"\r\n                                type=\"date\"\r\n                                defaultValue={initialData?.endDate}\r\n                                required\r\n                                className=\"bg-slate-800 border-slate-700 text-white h-10 w-full px-3 block [color-scheme:dark] [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-calendar-picker-indicator]:opacity-60 [&::-webkit-calendar-picker-indicator]:hover:opacity-100 [&::-webkit-calendar-picker-indicator]:ml-auto [&::-webkit-calendar-picker-indicator]:p-1\"\r\n                                whileFocus={{ scale: 1 }}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"pt-4\">\r\n                            <Button\r\n                                type=\"submit\"\r\n                                disabled={loading}\r\n                                className=\"w-full bg-[#F4C430] text-black hover:bg-[#F4C430]/90 h-11 text-base font-semibold rounded-lg disabled:opacity-70 disabled:cursor-not-allowed\"\r\n                            >\r\n                                {loading ? (\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Loader2 className=\"h-5 w-5 animate-spin\" />\r\n                                        <span>Création en cours...</span>\r\n                                    </div>\r\n                                ) : (\r\n                                    \"Confirmer & Créer le Bail\"\r\n                                )}\r\n                            </Button>\r\n                        </div>\r\n                    </form>\r\n                </DialogContent>\r\n            </Dialog >\r\n\r\n            {/* PROMPT: Generate Contract? */}\r\n            <Dialog open={showContractPrompt} onOpenChange={setShowContractPrompt}>\r\n                <DialogContent className=\"sm:max-w-md bg-slate-900 border-slate-800 text-white\">\r\n                    <DialogHeader>\r\n                        <DialogTitle>Générer le contrat de bail ?</DialogTitle>\r\n                        <DialogDescription className=\"text-slate-400\">\r\n                            Le locataire a été créé avec succès. Souhaitez-vous générer et personnaliser le contrat de bail maintenant ?\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <div className=\"flex justify-end gap-3 mt-4\">\r\n                        <Button\r\n                            variant=\"ghost\"\r\n                            onClick={() => setShowContractPrompt(false)}\r\n                            className=\"text-slate-400 hover:text-white\"\r\n                        >\r\n                            Non, plus tard\r\n                        </Button>\r\n                        <Button\r\n                            onClick={() => {\r\n                                setShowContractPrompt(false);\r\n                                // Small delay to prevent body scroll locking issues between modals\r\n                                setTimeout(() => setShowContractModal(true), 150);\r\n                            }}\r\n                            className=\"bg-[#F4C430] text-black hover:bg-[#F4C430]/90\"\r\n                        >\r\n                            Oui, générer le contrat\r\n                        </Button>\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            {/* MODAL: Generate Contract */}\r\n            {\r\n                createdLease && (\r\n                    <GenerateContractModal\r\n                        leaseId={createdLease.id}\r\n                        tenantName={createdLease.name}\r\n                        open={showContractModal}\r\n                        onOpenChange={setShowContractModal}\r\n                        onSuccess={() => {\r\n                            // Contract generated successfully\r\n                            setShowContractModal(false);\r\n                        }}\r\n                    />\r\n                )\r\n            }\r\n            {/* ALERT: Profile Incomplete */}\r\n            <Dialog open={showProfileAlert} onOpenChange={setShowProfileAlert}>\r\n                <DialogContent className=\"sm:max-w-md bg-slate-900 border-red-900/50 text-white\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"flex items-center gap-2 text-red-500\">\r\n                            <span>⚠️ Profil Incomplet</span>\r\n                        </DialogTitle>\r\n                        <DialogDescription className=\"text-slate-300 pt-2\">\r\n                            Pour créer des baux valides et générer des contrats légaux, vous devez d&apos;abord renseigner vos informations (Nom/Agence et Adresse).\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <div className=\"flex justify-end gap-3 mt-4\">\r\n                        <Button\r\n                            variant=\"ghost\"\r\n                            onClick={() => setShowProfileAlert(false)}\r\n                            className=\"text-slate-400 hover:text-white\"\r\n                        >\r\n                            Annuler\r\n                        </Button>\r\n                        <Button\r\n                            onClick={() => router.push('/compte/gestion-locative/config')}\r\n                            className=\"bg-red-600 hover:bg-red-700 text-white\"\r\n                        >\r\n                            Compléter mon profil\r\n                        </Button>\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\EditTenantDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogDescription,\r\n} from \"@/components/ui/dialog\";\r\nimport { updateLease } from \"../actions\";\r\nimport { toast } from 'sonner';\r\nimport { useRouter } from 'next/navigation';\r\n\r\ninterface Tenant {\r\n    id: string;\r\n    name: string;\r\n    phone?: string;\r\n    email?: string;\r\n    property: string;\r\n    rentAmount: number;\r\n    dueDate?: number;\r\n    startDate?: string;\r\n    endDate?: string;\r\n}\r\n\r\ninterface EditTenantDialogProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    tenant: Tenant;\r\n}\r\n\r\nexport function EditTenantDialog({ isOpen, onClose, tenant }: EditTenantDialogProps) {\r\n    const [loading, setLoading] = useState(false);\r\n    const router = useRouter();\r\n\r\n    if (!tenant) return null;\r\n\r\n    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\r\n        e.preventDefault();\r\n        setLoading(true);\r\n        const formData = new FormData(e.currentTarget);\r\n\r\n        // Only include fields that have values\r\n        const data: Record<string, string | number> = {};\r\n\r\n        const tenantName = formData.get('tenant_name') as string;\r\n        if (tenantName) data.tenant_name = tenantName;\r\n\r\n        const tenantPhone = formData.get('tenant_phone') as string;\r\n        if (tenantPhone) data.tenant_phone = tenantPhone;\r\n\r\n        const tenantEmail = formData.get('tenant_email') as string;\r\n        if (tenantEmail) data.tenant_email = tenantEmail;\r\n\r\n        const propertyAddress = formData.get('property_address') as string;\r\n        if (propertyAddress) data.property_address = propertyAddress;\r\n\r\n        const monthlyAmount = formData.get('monthly_amount');\r\n        if (monthlyAmount) data.monthly_amount = Number(monthlyAmount);\r\n\r\n        const billingDay = formData.get('billing_day');\r\n        if (billingDay) data.billing_day = Number(billingDay);\r\n\r\n        // Start date might be needed if user wants to correct it\r\n        const startDate = formData.get('start_date') as string;\r\n        if (startDate) data.start_date = startDate;\r\n\r\n        // End date for legal alerts (J-180 and J-90)\r\n        const endDate = formData.get('end_date') as string;\r\n        if (endDate) data.end_date = endDate;\r\n\r\n        const result = await updateLease(tenant.id, data);\r\n        setLoading(false);\r\n\r\n        if (result.success) {\r\n            toast.success('Bail modifié avec succès');\r\n            onClose();\r\n            router.refresh();\r\n        } else {\r\n            toast.error(result.error || 'Erreur lors de la modification');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\r\n            <DialogContent className=\"z-[100] fixed top-[4%] left-[50%] translate-x-[-50%] translate-y-0 sm:top-[50%] sm:translate-y-[-50%] w-[90vw] sm:w-full sm:max-w-[550px] max-h-[92vh] overflow-y-auto overflow-x-hidden bg-slate-900 border-slate-800 text-white px-4 pt-4 pb-24 sm:p-6 outline-none\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"text-xl font-semibold text-white\">Modifier le bail</DialogTitle>\r\n                    <DialogDescription className=\"text-slate-400\">\r\n                        Modifications pour {tenant.name}\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <form onSubmit={handleSubmit} className=\"space-y-4 mt-4\">\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-300\">\r\n                                Nom complet\r\n                            </label>\r\n                            <Input\r\n                                name=\"tenant_name\"\r\n                                defaultValue={tenant.name}\r\n                                placeholder=\"ex: Mamadou Diop\"\r\n                                className=\"bg-slate-800 border-slate-700 text-white\"\r\n                                whileFocus={{ scale: 1 }}\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-300\">Téléphone</label>\r\n                            <Input\r\n                                name=\"tenant_phone\"\r\n                                defaultValue={tenant.phone}\r\n                                placeholder=\"ex: +221 77...\"\r\n                                className=\"bg-slate-800 border-slate-700 text-white\"\r\n                                whileFocus={{ scale: 1 }}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-medium text-slate-300\">\r\n                            Email\r\n                        </label>\r\n                        <Input\r\n                            name=\"tenant_email\"\r\n                            type=\"email\"\r\n                            defaultValue={tenant.email}\r\n                            placeholder=\"ex: locataire@email.com\"\r\n                            className=\"bg-slate-800 border-slate-700 text-white\"\r\n                            whileFocus={{ scale: 1 }}\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-medium text-slate-300\">Adresse du bien</label>\r\n                        <Input\r\n                            name=\"property_address\"\r\n                            defaultValue={tenant.property}\r\n                            placeholder=\"ex: Appartement F3, Almadies, Dakar\"\r\n                            className=\"bg-slate-800 border-slate-700 text-white\"\r\n                            whileFocus={{ scale: 1 }}\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-300\">\r\n                                Loyer (FCFA)\r\n                            </label>\r\n                            <Input\r\n                                name=\"monthly_amount\"\r\n                                type=\"number\"\r\n                                defaultValue={tenant.rentAmount}\r\n                                placeholder=\"500000\"\r\n                                className=\"bg-slate-800 border-slate-700 text-white font-mono\"\r\n                                whileFocus={{ scale: 1 }}\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-300\">Jour paiement</label>\r\n                            <Input\r\n                                name=\"billing_day\"\r\n                                type=\"number\"\r\n                                min=\"1\"\r\n                                max=\"31\"\r\n                                defaultValue={tenant.dueDate || 5}\r\n                                className=\"bg-slate-800 border-slate-700 text-white\"\r\n                                whileFocus={{ scale: 1 }}\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-300\">\r\n                                Début bail <span className=\"text-red-400\">*</span>\r\n                            </label>\r\n                            <Input\r\n                                name=\"start_date\"\r\n                                type=\"date\"\r\n                                required\r\n                                defaultValue={tenant.startDate}\r\n                                className=\"bg-slate-800 border-slate-700 text-white h-10 w-full px-3 block [color-scheme:dark] [&::-webkit-calendar-picker-indicator]:ml-auto [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-calendar-picker-indicator]:opacity-60 hover:[&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-calendar-picker-indicator]:p-1\"\r\n                                whileFocus={{ scale: 1 }}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-medium text-slate-300\">\r\n                            Fin bail <span className=\"text-red-400\">*</span>\r\n                            <span className=\"text-xs text-slate-500 ml-2\">(pour les alertes juridiques J-180 et J-90)</span>\r\n                        </label>\r\n                        <Input\r\n                            name=\"end_date\"\r\n                            type=\"date\"\r\n                            required\r\n                            defaultValue={tenant.endDate}\r\n                            className=\"bg-slate-800 border-slate-700 text-white h-10 w-full px-3 block [color-scheme:dark] [&::-webkit-calendar-picker-indicator]:ml-auto [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-calendar-picker-indicator]:opacity-60 hover:[&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-calendar-picker-indicator]:p-1\"\r\n                            whileFocus={{ scale: 1 }}\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"pt-4 flex justify-end gap-3\">\r\n                        <Button\r\n                            type=\"button\"\r\n                            variant=\"ghost\"\r\n                            onClick={onClose}\r\n                            className=\"hover:bg-slate-800 text-slate-300\"\r\n                        >\r\n                            Annuler\r\n                        </Button>\r\n                        <Button\r\n                            type=\"submit\"\r\n                            disabled={loading}\r\n                            className=\"bg-[#F4C430] text-black hover:bg-[#F4C430]/90\"\r\n                        >\r\n                            {loading ? \"Enregistrement...\" : \"Enregistrer\"}\r\n                        </Button>\r\n                    </div>\r\n                </form>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\GestionLocativeClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\InvoiceActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\LegalAlertsWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\MaintenanceHub.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTriangle' is defined but never used.","line":3,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { Wrench, Clock, CheckCircle2, AlertTriangle, Send, Loader2, X, ChevronDown, Phone, Star, MapPin, Calendar, CircleDollarSign } from 'lucide-react';\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { useState, useEffect } from 'react';\r\nimport { createMaintenanceRequest, getActiveLeases, submitQuote, approveQuoteByOwner, completeIntervention } from '../actions';\r\nimport { toast } from 'sonner';\r\nimport { EmptyState } from '@/components/ui/empty-state';\r\n\r\ninterface MaintenanceRequest {\r\n    id: string;\r\n    description: string;\r\n    category?: string;\r\n    status: 'open' | 'artisan_found' | 'awaiting_approval' | 'approved' | 'in_progress' | 'completed';\r\n    quoted_price?: number;\r\n    intervention_date?: string;\r\n    created_at?: string;\r\n    tenant_name?: string;\r\n    // Colonnes artisan\r\n    artisan_name?: string;\r\n    artisan_phone?: string;\r\n    artisan_rating?: number;\r\n    artisan_address?: string;\r\n    owner_approved?: boolean;\r\n}\r\n\r\ninterface Lease {\r\n    id: string;\r\n    tenant_name: string;\r\n    property_address?: string;\r\n}\r\n\r\ninterface MaintenanceHubProps {\r\n    requests?: MaintenanceRequest[];\r\n}\r\n\r\nconst CATEGORIES = [\r\n    { value: 'Plomberie', emoji: '🔧' },\r\n    { value: 'Électricité', emoji: '⚡' },\r\n    { value: 'Maçonnerie', emoji: '🧱' },\r\n    { value: 'Climatisation', emoji: '❄️' },\r\n    { value: 'Serrurerie', emoji: '🔑' },\r\n    { value: 'Peinture', emoji: '🎨' },\r\n    { value: 'Autre', emoji: '📋' }\r\n];\r\n\r\nexport function MaintenanceHub({ requests = [] }: MaintenanceHubProps) {\r\n    const [showForm, setShowForm] = useState(false);\r\n    const [description, setDescription] = useState('');\r\n    const [category, setCategory] = useState('Plomberie');\r\n    const [selectedLease, setSelectedLease] = useState('');\r\n    const [leases, setLeases] = useState<Lease[]>([]);\r\n    const [submitting, setSubmitting] = useState(false);\r\n    const [processingId, setProcessingId] = useState<string | null>(null);\r\n\r\n    // Modal saisie devis\r\n    const [showQuoteModal, setShowQuoteModal] = useState(false);\r\n    const [quoteRequestId, setQuoteRequestId] = useState<string | null>(null);\r\n    const [quotePrice, setQuotePrice] = useState('');\r\n    const [quoteDate, setQuoteDate] = useState('');\r\n\r\n    useEffect(() => {\r\n        if (showForm) {\r\n            getActiveLeases().then(result => {\r\n                if (result.success && result.data) {\r\n                    setLeases(result.data);\r\n                    if (result.data.length > 0) {\r\n                        setSelectedLease(result.data[0].id);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }, [showForm]);\r\n\r\n    const getStatusStyle = (status: string) => {\r\n        switch (status) {\r\n            case 'open': return \"bg-blue-500/10 text-blue-400\";\r\n            case 'artisan_found': return \"bg-emerald-500/10 text-emerald-400\";\r\n            case 'awaiting_approval': return \"bg-orange-500/10 text-orange-400\";\r\n            case 'approved': return \"bg-purple-500/10 text-purple-400\";\r\n            case 'in_progress': return \"bg-yellow-500/10 text-yellow-400\";\r\n            case 'completed': return \"bg-green-500/10 text-green-400\";\r\n            default: return \"bg-gray-500/10 text-gray-400\";\r\n        }\r\n    };\r\n\r\n    const getStatusLabel = (status: string) => {\r\n        switch (status) {\r\n            case 'open': return \"Recherche...\";\r\n            case 'artisan_found': return \"Artisan trouvé\";\r\n            case 'awaiting_approval': return \"Validation requise\";\r\n            case 'approved': return \"Approuvé\";\r\n            case 'in_progress': return \"En cours\";\r\n            case 'completed': return \"Terminé\";\r\n            default: return status;\r\n        }\r\n    };\r\n\r\n    const handleSubmit = async () => {\r\n        if (!description.trim()) {\r\n            toast.error('Veuillez décrire le problème');\r\n            return;\r\n        }\r\n\r\n        setSubmitting(true);\r\n        const result = await createMaintenanceRequest({\r\n            leaseId: selectedLease || undefined,\r\n            description: description.trim(),\r\n            category: category\r\n        });\r\n        setSubmitting(false);\r\n\r\n        if (result.success) {\r\n            toast.success(result.message || 'Intervention signalée!');\r\n            setDescription('');\r\n            setCategory('Plomberie');\r\n            setShowForm(false);\r\n        } else {\r\n            toast.error(result.error || 'Erreur lors du signalement');\r\n        }\r\n    };\r\n\r\n    const openQuoteModal = (requestId: string) => {\r\n        setQuoteRequestId(requestId);\r\n        setQuotePrice('');\r\n        setQuoteDate('');\r\n        setShowQuoteModal(true);\r\n    };\r\n\r\n    const handleSubmitQuote = async () => {\r\n        if (!quoteRequestId || !quotePrice || !quoteDate) {\r\n            toast.error('Veuillez remplir tous les champs');\r\n            return;\r\n        }\r\n\r\n        setProcessingId(quoteRequestId);\r\n        const result = await submitQuote(quoteRequestId, {\r\n            quoted_price: parseInt(quotePrice),\r\n            intervention_date: quoteDate\r\n        });\r\n        setProcessingId(null);\r\n\r\n        if (result.success) {\r\n            toast.success(result.message || 'Devis enregistré !');\r\n            setShowQuoteModal(false);\r\n        } else {\r\n            toast.error(result.error || 'Erreur');\r\n        }\r\n    };\r\n\r\n    const handleApproveQuote = async (requestId: string) => {\r\n        setProcessingId(requestId);\r\n        const result = await approveQuoteByOwner(requestId);\r\n        setProcessingId(null);\r\n        if (result.success) {\r\n            toast.success(result.message || 'Devis approuvé !');\r\n        } else {\r\n            toast.error(result.error || 'Erreur');\r\n        }\r\n    };\r\n\r\n    const handleComplete = async (requestId: string) => {\r\n        setProcessingId(requestId);\r\n        const result = await completeIntervention(requestId);\r\n        setProcessingId(null);\r\n        if (result.success) {\r\n            toast.success(result.message || 'Intervention terminée !');\r\n        } else {\r\n            toast.error(result.error || 'Erreur');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between\">\r\n                <h3 className=\"text-base font-bold flex items-center gap-2\">\r\n                    <Wrench className=\"w-4 h-4 text-orange-500\" /> Interventions\r\n                </h3>\r\n                <Button\r\n                    size=\"sm\"\r\n                    variant={showForm ? \"ghost\" : \"outline\"}\r\n                    className={`text-xs h-8 ${showForm ? 'text-red-400 hover:text-red-300 hover:bg-red-500/10' : 'border-gray-700 hover:bg-gray-800'}`}\r\n                    onClick={() => setShowForm(!showForm)}\r\n                >\r\n                    {showForm ? <><X className=\"w-3 h-3 mr-1\" /> Annuler</> : 'Signaler'}\r\n                </Button>\r\n            </div>\r\n\r\n            {/* Formulaire */}\r\n            {showForm && (\r\n                <div className=\"p-4 bg-gray-800/50 border border-gray-700 rounded-xl space-y-3\">\r\n                    <p className=\"text-xs font-medium text-orange-400\">Nouvelle intervention</p>\r\n\r\n                    {leases.length > 0 && (\r\n                        <div className=\"relative\">\r\n                            <select\r\n                                value={selectedLease}\r\n                                onChange={(e) => setSelectedLease(e.target.value)}\r\n                                className=\"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 pr-8 text-sm text-white appearance-none cursor-pointer\"\r\n                            >\r\n                                {leases.map(lease => (\r\n                                    <option key={lease.id} value={lease.id}>\r\n                                        {lease.tenant_name}\r\n                                    </option>\r\n                                ))}\r\n                            </select>\r\n                            <ChevronDown className=\"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none\" />\r\n                        </div>\r\n                    )}\r\n\r\n                    <textarea\r\n                        placeholder=\"Décrivez le problème...\"\r\n                        value={description}\r\n                        onChange={(e) => setDescription(e.target.value)}\r\n                        className=\"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm resize-none h-16 focus:border-orange-500/50 focus:outline-none\"\r\n                    />\r\n\r\n                    <div className=\"flex gap-2\">\r\n                        <div className=\"relative flex-1\">\r\n                            <select\r\n                                value={category}\r\n                                onChange={(e) => setCategory(e.target.value)}\r\n                                className=\"w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 pr-8 text-sm text-white appearance-none cursor-pointer\"\r\n                            >\r\n                                {CATEGORIES.map(cat => (\r\n                                    <option key={cat.value} value={cat.value}>\r\n                                        {cat.emoji} {cat.value}\r\n                                    </option>\r\n                                ))}\r\n                            </select>\r\n                            <ChevronDown className=\"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none\" />\r\n                        </div>\r\n                        <Button\r\n                            onClick={handleSubmit}\r\n                            disabled={!description.trim() || submitting}\r\n                            size=\"sm\"\r\n                            className=\"bg-orange-600 hover:bg-orange-700 h-9 px-4\"\r\n                        >\r\n                            {submitting ? (\r\n                                <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                            ) : (\r\n                                <><Send className=\"w-3 h-3 mr-1\" /> Envoyer</>\r\n                            )}\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Liste des demandes */}\r\n            <div className=\"space-y-3\">\r\n                {requests.length > 0 ? requests.map((req) => (\r\n                    <div key={req.id} className=\"p-4 bg-gray-900/40 border border-gray-800 rounded-2xl space-y-3\">\r\n                        {/* En-tête */}\r\n                        <div className=\"flex justify-between items-start\">\r\n                            <div>\r\n                                <h4 className=\"font-bold text-sm\">{req.description}</h4>\r\n                                <p className=\"text-xs text-gray-500\">{req.category}</p>\r\n                            </div>\r\n                            <span className={`text-[10px] px-2 py-1 rounded-full font-medium ${getStatusStyle(req.status)}`}>\r\n                                {getStatusLabel(req.status)}\r\n                            </span>\r\n                        </div>\r\n\r\n                        {/* Bloc Artisan (si trouvé) */}\r\n                        {req.artisan_name && (\r\n                            <div className=\"bg-gray-800/50 p-3 rounded-lg border border-gray-700/50\">\r\n                                <p className=\"text-[10px] text-gray-500 uppercase font-bold mb-2\">Artisan suggéré</p>\r\n                                <div className=\"flex items-center justify-between flex-wrap gap-2\">\r\n                                    <div>\r\n                                        <p className=\"font-bold text-white text-sm\">{req.artisan_name}</p>\r\n                                        {req.artisan_rating && (\r\n                                            <span className=\"text-yellow-500 text-xs flex items-center gap-1\">\r\n                                                <Star className=\"w-3 h-3 fill-current\" /> {req.artisan_rating}/5\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                    {req.artisan_phone && (\r\n                                        <a\r\n                                            href={`tel:${req.artisan_phone}`}\r\n                                            className=\"bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-3 py-1.5 rounded-lg flex items-center gap-1.5 transition-colors\"\r\n                                        >\r\n                                            <Phone className=\"w-3 h-3\" /> Appeler\r\n                                        </a>\r\n                                    )}\r\n                                </div>\r\n                                {req.artisan_address && (\r\n                                    <p className=\"text-xs text-gray-400 mt-1 flex items-center gap-1\">\r\n                                        <MapPin className=\"w-3 h-3\" /> {req.artisan_address}\r\n                                    </p>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Infos devis (si saisi) */}\r\n                        {req.quoted_price && (\r\n                            <div className=\"flex items-center gap-4 text-xs text-gray-400\">\r\n                                <span className=\"flex items-center gap-1\">\r\n                                    <CircleDollarSign className=\"w-3 h-3\" /> {req.quoted_price.toLocaleString('fr-FR')} FCFA\r\n                                </span>\r\n                                {req.intervention_date && (\r\n                                    <span className=\"flex items-center gap-1\">\r\n                                        <Calendar className=\"w-3 h-3\" /> {new Date(req.intervention_date).toLocaleDateString('fr-FR')}\r\n                                    </span>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Actions selon le statut */}\r\n                        <div className=\"flex gap-2 pt-1 flex-wrap\">\r\n                            {/* Artisan trouvé → Saisir devis */}\r\n                            {req.status === 'artisan_found' && (\r\n                                <Button\r\n                                    onClick={() => openQuoteModal(req.id)}\r\n                                    size=\"sm\"\r\n                                    className=\"bg-blue-600 hover:bg-blue-700 text-xs h-8\"\r\n                                >\r\n                                    <CircleDollarSign className=\"w-3 h-3 mr-1\" /> Saisir le devis\r\n                                </Button>\r\n                            )}\r\n\r\n                            {/* En attente d'approbation → Approuver */}\r\n                            {req.status === 'awaiting_approval' && (\r\n                                <Button\r\n                                    onClick={() => handleApproveQuote(req.id)}\r\n                                    disabled={processingId === req.id}\r\n                                    size=\"sm\"\r\n                                    className=\"bg-orange-600 hover:bg-orange-700 text-xs h-8\"\r\n                                >\r\n                                    {processingId === req.id ? (\r\n                                        <Loader2 className=\"w-3 h-3 animate-spin\" />\r\n                                    ) : (\r\n                                        <>Approuver {req.quoted_price?.toLocaleString('fr-FR')} FCFA</>\r\n                                    )}\r\n                                </Button>\r\n                            )}\r\n\r\n                            {/* Approuvé → Terminer */}\r\n                            {req.status === 'approved' && (\r\n                                <Button\r\n                                    onClick={() => handleComplete(req.id)}\r\n                                    disabled={processingId === req.id}\r\n                                    size=\"sm\"\r\n                                    className=\"bg-green-600 hover:bg-green-700 text-xs h-8\"\r\n                                >\r\n                                    {processingId === req.id ? (\r\n                                        <Loader2 className=\"w-3 h-3 animate-spin\" />\r\n                                    ) : (\r\n                                        <><CheckCircle2 className=\"w-3 h-3 mr-1\" /> Terminer &amp; Payer</>\r\n                                    )}\r\n                                </Button>\r\n                            )}\r\n\r\n                            {/* Terminé */}\r\n                            {req.status === 'completed' && (\r\n                                <span className=\"text-xs text-green-400 flex items-center gap-1\">\r\n                                    <CheckCircle2 className=\"w-3 h-3\" /> Intervention clôturée\r\n                                </span>\r\n                            )}\r\n\r\n                            {/* Open (sans artisan) */}\r\n                            {req.status === 'open' && !req.artisan_name && (\r\n                                <span className=\"text-xs text-gray-500 italic flex items-center gap-1\">\r\n                                    <Clock className=\"w-3 h-3\" /> Recherche d&apos;artisan en cours...\r\n                                </span>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )) : (\r\n                    <EmptyState\r\n                        title=\"Aucun signalement à traiter\"\r\n                        description=\"Vos locataires n'ont signalé aucun incident pour le moment. Vous pouvez créer une intervention manuellement si nécessaire.\"\r\n                        icon={Wrench}\r\n                        actionLabel=\"Créer une intervention\"\r\n                        onAction={() => setShowForm(true)}\r\n                    />\r\n                )}\r\n            </div>\r\n\r\n            {/* Modal Saisie Devis */}\r\n            {showQuoteModal && (\r\n                <div className=\"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4\">\r\n                    <div className=\"bg-gray-900 border border-gray-700 rounded-xl p-5 w-full max-w-sm space-y-4\">\r\n                        <div className=\"flex justify-between items-center\">\r\n                            <h4 className=\"font-bold\">Saisir le devis</h4>\r\n                            <button onClick={() => setShowQuoteModal(false)} className=\"text-gray-400 hover:text-white\">\r\n                                <X className=\"w-5 h-5\" />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-3\">\r\n                            <div>\r\n                                <label className=\"text-xs text-gray-400 mb-1 block\">Montant (FCFA)</label>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    value={quotePrice}\r\n                                    onChange={(e) => setQuotePrice(e.target.value)}\r\n                                    placeholder=\"Ex: 25000\"\r\n                                    className=\"w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-orange-500/50 focus:outline-none\"\r\n                                />\r\n                            </div>\r\n                            <div>\r\n                                <label className=\"text-xs text-gray-400 mb-1 block\">Date d&apos;intervention</label>\r\n                                <input\r\n                                    type=\"date\"\r\n                                    value={quoteDate}\r\n                                    onChange={(e) => setQuoteDate(e.target.value)}\r\n                                    className=\"w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-orange-500/50 focus:outline-none\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"flex gap-2 pt-2\">\r\n                            <Button\r\n                                onClick={() => setShowQuoteModal(false)}\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                className=\"flex-1 border-gray-700\"\r\n                            >\r\n                                Annuler\r\n                            </Button>\r\n                            <Button\r\n                                onClick={handleSubmitQuote}\r\n                                disabled={!quotePrice || !quoteDate || processingId === quoteRequestId}\r\n                                size=\"sm\"\r\n                                className=\"flex-1 bg-orange-600 hover:bg-orange-700\"\r\n                            >\r\n                                {processingId === quoteRequestId ? (\r\n                                    <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                                ) : (\r\n                                    'Valider'\r\n                                )}\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\MonthSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":3,"column":37,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":45},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":81,"column":32,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[3023,3082],"text":"\r\n                        Aujourd&apos;hui\r\n                    "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[3023,3082],"text":"\r\n                        Aujourd&lsquo;hui\r\n                    "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[3023,3082],"text":"\r\n                        Aujourd&#39;hui\r\n                    "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[3023,3082],"text":"\r\n                        Aujourd&rsquo;hui\r\n                    "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { ChevronLeft, ChevronRight, Calendar } from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\n\r\ninterface MonthSelectorProps {\r\n    selectedMonth: number; // 1-12\r\n    selectedYear: number;\r\n    onMonthChange: (month: number, year: number) => void;\r\n    minDate?: string;\r\n}\r\n\r\nconst MONTHS_FR = [\r\n    'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',\r\n    'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'\r\n];\r\n\r\nexport function MonthSelector({ selectedMonth, selectedYear, onMonthChange, minDate }: MonthSelectorProps) {\r\n    const handlePrevious = () => {\r\n        if (selectedMonth === 1) {\r\n            onMonthChange(12, selectedYear - 1);\r\n        } else {\r\n            onMonthChange(selectedMonth - 1, selectedYear);\r\n        }\r\n    };\r\n\r\n    const handleNext = () => {\r\n        if (selectedMonth === 12) {\r\n            onMonthChange(1, selectedYear + 1);\r\n        } else {\r\n            onMonthChange(selectedMonth + 1, selectedYear);\r\n        }\r\n    };\r\n\r\n    const handleToday = () => {\r\n        const today = new Date();\r\n        onMonthChange(today.getMonth() + 1, today.getFullYear());\r\n    };\r\n\r\n    const isCurrentMonth = () => {\r\n        const today = new Date();\r\n        return selectedMonth === today.getMonth() + 1 && selectedYear === today.getFullYear();\r\n    };\r\n\r\n    const isPastLimit = () => {\r\n        if (!minDate) return false;\r\n        const limit = new Date(minDate);\r\n        // On compare l'année et le mois.\r\n        // Si l'année affichée est < année limite, c'est bloqué.\r\n        if (selectedYear < limit.getFullYear()) return true;\r\n        // Si même année, on regarde le mois.\r\n        if (selectedYear === limit.getFullYear() && selectedMonth <= limit.getMonth() + 1) return true;\r\n\r\n        return false;\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex items-center justify-between sm:justify-start gap-2 px-3 py-2 bg-slate-900 border border-slate-800 rounded-lg w-full sm:w-auto\">\r\n            {/* Bouton Mois précédent */}\r\n            <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={handlePrevious}\r\n                disabled={isPastLimit()}\r\n                className={`h-8 w-8 p-0 hover:bg-slate-800 ${isPastLimit() ? 'opacity-30 cursor-not-allowed' : ''}`}\r\n                title=\"Mois précédent\"\r\n            >\r\n                <ChevronLeft className=\"w-4 h-4 text-slate-400\" />\r\n            </Button>\r\n\r\n            {/* Affichage du mois et année */}\r\n            <div className=\"flex items-center justify-center gap-2 px-2 flex-1 sm:flex-none\">\r\n                <span className=\"text-sm font-medium text-white whitespace-nowrap\">\r\n                    {MONTHS_FR[selectedMonth - 1]} {selectedYear}\r\n                </span>\r\n                {!isCurrentMonth() && (\r\n                    <button\r\n                        onClick={handleToday}\r\n                        className=\"text-xs text-slate-500 hover:text-[#F4C430] transition-colors\"\r\n                    >\r\n                        Aujourd'hui\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            {/* Bouton Mois suivant */}\r\n            <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={handleNext}\r\n                disabled={isCurrentMonth()}\r\n                className={`h-8 w-8 p-0 hover:bg-slate-800 ${isCurrentMonth() ? 'opacity-30 cursor-not-allowed' : ''}`}\r\n                title=\"Mois suivant\"\r\n            >\r\n                <ChevronRight className=\"w-4 h-4 text-slate-400\" />\r\n            </Button>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\ReceiptModal.tsx","messages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":51,"column":39,"nodeType":"Identifier","endLine":51,"endColumn":47}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { X, Download, Mail } from 'lucide-react';\r\nimport { ReceiptPreview } from './ReceiptPreview';\r\nimport { Button } from '@/components/ui/button';\r\nimport { toast } from 'sonner';\r\nimport { PDFDownloadLink } from '@react-pdf/renderer';\r\nimport { createQuittanceDocument } from '@/components/pdf/QuittancePDF_v2';\r\n\r\ninterface ReceiptData {\r\n    tenant?: {\r\n        tenant_name?: string;\r\n        name?: string;\r\n        email?: string;\r\n        phone?: string;\r\n        address?: string;\r\n    };\r\n    property_address?: string;\r\n    amount?: number;\r\n    period?: string;\r\n    month?: string | number;\r\n    year?: number;\r\n    periodStart?: string;\r\n    periodEnd?: string;\r\n    receiptNumber?: string;\r\n    userEmail?: string;\r\n    profile?: {\r\n        company_name?: string | null;\r\n        full_name?: string | null;\r\n        company_address?: string | null;\r\n        company_email?: string | null;\r\n        email?: string;\r\n        logo_url?: string | null;\r\n        signature_url?: string | null;\r\n        ninea?: string | null;\r\n        company_ninea?: string | null;\r\n    };\r\n    receiptImage?: string | null;\r\n}\r\n\r\ninterface ReceiptModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    data: ReceiptData | null;\r\n}\r\n\r\nexport function ReceiptModal({ isOpen, onClose, data }: ReceiptModalProps) {\r\n    if (!isOpen || !data) return null;\r\n\r\n    const [isSending, setIsSending] = useState(false);\r\n\r\n    // Préparer les données pour le PDF\r\n    const receiptData = {\r\n        // Locataire\r\n        tenantName: data.tenant?.tenant_name || data.tenant?.name || 'Locataire',\r\n        tenantEmail: data.tenant?.email || '',\r\n        tenantPhone: data.tenant?.phone || '',\r\n        tenantAddress: data.property_address || '',\r\n\r\n        // Montants\r\n        amount: Number(data.amount) || 0,\r\n\r\n        // Période\r\n        periodMonth: `${String(data.month).padStart(2, '0')}/${data.year}`,\r\n        periodStart: `01/${String(data.month).padStart(2, '0')}/${data.year}`,\r\n        periodEnd: `30/${String(data.month).padStart(2, '0')}/${data.year}`,\r\n\r\n        // Référence\r\n        receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\r\n\r\n        // Propriétaire\r\n        ownerName: data.profile?.company_name || data.profile?.full_name || 'Propriétaire',\r\n        ownerAddress: data.profile?.company_address || '',\r\n        ownerNinea: data.profile?.company_ninea || '',\r\n        ownerLogo: data.profile?.logo_url || undefined,\r\n        ownerSignature: data.profile?.signature_url || undefined,\r\n        ownerEmail: data.profile?.company_email || undefined, // Email de config (priorité)\r\n        ownerAccountEmail: data.userEmail || undefined, // Email du compte (fallback)\r\n\r\n        // Propriété\r\n        propertyAddress: data.property_address || 'Adresse non renseignée',\r\n    };\r\n\r\n    // Nom de fichier pour le téléchargement\r\n    const filename = `Quittance_${receiptData.tenantName.replace(/\\s+/g, '_')}_${String(data.month).padStart(2, '0')}_${data.year}.pdf`;\r\n\r\n    const handleSendEmail = async () => {\r\n        if (isSending) return;\r\n        setIsSending(true);\r\n\r\n        try {\r\n            console.log(\"📤 Envoi de la quittance...\", receiptData);\r\n\r\n            // Appeler l'API Next.js interne\r\n            const response = await fetch('/api/send-receipt', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify(receiptData),\r\n            });\r\n\r\n            const result = await response.json();\r\n\r\n            if (result.success) {\r\n                toast.success(`Quittance envoyée à ${receiptData.tenantEmail} !`, {\r\n                    description: `N° ${receiptData.receiptNumber}`,\r\n                });\r\n            } else {\r\n                toast.error(\"Erreur : \" + (result.error || \"Problème inconnu\"));\r\n            }\r\n        } catch (err) {\r\n            console.error(\"❌ Erreur technique:\", err);\r\n            toast.error(\"Erreur technique lors de l'envoi.\");\r\n        } finally {\r\n            setIsSending(false);\r\n        }\r\n    };\r\n\r\n\r\n    return (\r\n        <div\r\n            className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 print:p-0 print:bg-white print:block print:relative\"\r\n            onClick={onClose}\r\n        >\r\n            {/* Header Actions (Masqué à l'impression) */}\r\n            {/* Boutons d'actions centrés */}\r\n            <div className=\"absolute top-4 left-1/2 -translate-x-1/2 z-50 print:hidden flex gap-2\">\r\n                {/* Bouton Télécharger PDF avec @react-pdf/renderer */}\r\n                <PDFDownloadLink\r\n                    document={createQuittanceDocument(receiptData)}\r\n                    fileName={filename}\r\n                    className=\"inline-flex items-center gap-1 md:gap-2 bg-white text-black hover:bg-gray-100 border-none shadow-lg rounded-full text-xs md:text-sm px-3 md:px-4 h-9 md:h-10 font-medium transition-colors\"\r\n                    onClick={(e) => e.stopPropagation()}\r\n                >\r\n                    {({ loading }) => (\r\n                        <>\r\n                            {loading ? (\r\n                                <>\r\n                                    <div className=\"w-3 h-3 md:w-4 md:h-4 border-2 border-black border-t-transparent rounded-full animate-spin\" />\r\n                                    <span className=\"hidden sm:inline\">Préparation...</span>\r\n                                    <span className=\"sm:hidden\">...</span>\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Download className=\"w-3 h-3 md:w-4 md:h-4\" />\r\n                                    <span className=\"hidden sm:inline\">Télécharger PDF</span>\r\n                                    <span className=\"sm:hidden\">PDF</span>\r\n                                </>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                </PDFDownloadLink>\r\n\r\n                {/* Bouton Envoyer par Email */}\r\n                <Button\r\n                    onClick={(e) => {\r\n                        e.stopPropagation();\r\n                        handleSendEmail();\r\n                    }}\r\n                    disabled={isSending}\r\n                    className=\"bg-[#F4C430] hover:bg-[#E5B020] text-black border-none shadow-lg gap-1 md:gap-2 rounded-full text-xs md:text-sm px-3 md:px-4 h-9 md:h-10 font-semibold disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                    {isSending ? (\r\n                        <>\r\n                            <div className=\"w-3 h-3 md:w-4 md:h-4 border-2 border-black border-t-transparent rounded-full animate-spin\" />\r\n                            <span className=\"hidden sm:inline\">Envoi...</span>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <Mail className=\"w-3 h-3 md:w-4 md:h-4\" />\r\n                            <span className=\"hidden sm:inline\">Envoyer par Email</span>\r\n                            <span className=\"sm:hidden\">Email</span>\r\n                        </>\r\n                    )}\r\n                </Button>\r\n            </div>\r\n\r\n            {/* Bouton Fermer à droite */}\r\n            <Button\r\n                onClick={onClose}\r\n                variant=\"outline\"\r\n                className=\"absolute top-4 right-4 z-50 bg-red-600 hover:bg-red-700 text-white border-none shadow-lg rounded-full h-9 md:h-10 w-9 md:w-10 p-0 print:hidden\"\r\n            >\r\n                <X className=\"w-4 h-4\" />\r\n            </Button>\r\n\r\n            <div\r\n                className=\"relative w-full max-w-4xl bg-gray-900 rounded-2xl md:rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/10 print:shadow-none print:border-none print:w-full print:max-w-none print:rounded-none print:bg-white\"\r\n                onClick={(e) => e.stopPropagation()}\r\n            >\r\n                <div className=\"p-4 md:p-8 max-h-[85vh] md:max-h-[90vh] overflow-y-auto bg-gray-100 flex justify-center print:max-h-none print:overflow-visible print:p-0 print:bg-white\">\r\n                    <ReceiptPreview\r\n                        tenant={{\r\n                            tenant_name: data.tenant?.tenant_name || data.tenant?.name || 'Locataire',\r\n                            address: data.property_address || data.tenant?.address || ''\r\n                        }}\r\n                        profile={{\r\n                            company_name: data.profile?.company_name || data.profile?.full_name || 'Propriétaire',\r\n                            company_address: data.profile?.company_address || '',\r\n                            company_ninea: data.profile?.company_ninea || data.profile?.ninea || undefined,\r\n                            logo_url: data.profile?.logo_url || undefined,\r\n                            signature_url: data.profile?.signature_url || undefined\r\n                        }}\r\n                        amount={data.amount || 0}\r\n                        month={data.month || new Date().getMonth() + 1}\r\n                        year={data.year || new Date().getFullYear()}\r\n                    />\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\ReceiptPreview.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":37,"column":25,"nodeType":"JSXOpeningElement","endLine":37,"endColumn":110,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":97,"column":29,"nodeType":"JSXOpeningElement","endLine":97,"endColumn":127,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\RentalStats.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cards' is assigned a value but never used.","line":12,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Wallet, Clock, AlertCircle } from 'lucide-react';\r\n\r\ninterface RentalStatsProps {\r\n    stats: {\r\n        collected: string;\r\n        pending: string;\r\n        overdue: string;\r\n    };\r\n}\r\n\r\nexport function RentalStats({ stats }: RentalStatsProps) {\r\n    const cards = [\r\n        { title: \"Collecté ce mois\", value: stats.collected, color: \"text-green-500\", icon: Wallet, bg: \"bg-green-500/10\" },\r\n        { title: \"En attente\", value: stats.pending, color: \"text-yellow-500\", icon: Clock, bg: \"bg-yellow-500/10\" },\r\n        { title: \"Retards / Impayés\", value: stats.overdue, color: \"text-red-500\", icon: AlertCircle, bg: \"bg-red-500/10\" },\r\n    ];\r\n\r\n    return (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n            <div className=\"p-6 rounded-3xl bg-gray-900/40 border border-gray-800 flex items-center gap-4\">\r\n                <div className=\"p-4 rounded-2xl bg-green-500/10\">\r\n                    <Wallet className=\"w-6 h-6 text-green-500\" />\r\n                </div>\r\n                <div>\r\n                    <p className=\"text-sm text-gray-400 font-medium\">Collecté ce mois</p>\r\n                    <p className=\"text-xl font-bold text-green-500\">{stats.collected} FCFA</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"p-6 rounded-3xl bg-gray-900/40 border border-gray-800 flex items-center gap-4\">\r\n                <div className=\"p-4 rounded-2xl bg-yellow-500/10\">\r\n                    <Clock className=\"w-6 h-6 text-yellow-500\" />\r\n                </div>\r\n                <div>\r\n                    <p className=\"text-sm text-gray-400 font-medium\">En attente</p>\r\n                    <p className=\"text-xl font-bold text-yellow-500\">{stats.pending} FCFA</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"p-6 rounded-3xl bg-gray-900/40 border border-gray-800 flex items-center gap-4\">\r\n                <div className={`p-4 rounded-2xl ${Number(stats.overdue.replace(/\\s/g, '')) > 0 ? 'bg-red-500/20' : 'bg-gray-800'}`}>\r\n                    <AlertCircle className={`w-6 h-6 ${Number(stats.overdue.replace(/\\s/g, '')) > 0 ? 'text-red-500' : 'text-gray-400'}`} />\r\n                </div>\r\n                <div>\r\n                    <p className=\"text-sm text-gray-400 font-medium\">Retards / Impayés</p>\r\n                    <p className={`text-xl font-bold ${Number(stats.overdue.replace(/\\s/g, '')) > 0 ? 'text-red-500' : 'text-gray-300'}`}>{stats.overdue} FCFA</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\SendRemindersButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\TenantList.tsx","messages":[{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\TenantList.tsx:256:41\n  254 |                 periodStart: periodStartDate.toLocaleDateString('fr-FR'),\n  255 |                 periodEnd: periodEndDate.toLocaleDateString('fr-FR'),\n> 256 |                 receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\n      |                                         ^^^^^^^^^^ Cannot call impure function\n  257 |                 ownerName: landlordName,\n  258 |                 ownerAddress: landlordAddress,\n  259 |                 ownerNinea: profile?.company_ninea || undefined,","line":256,"column":41,"nodeType":null,"endLine":256,"endColumn":51}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { ReceiptModal } from './ReceiptModal';\r\nimport { useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { User, Phone, Calendar, Edit2, X, Check, Mail, MapPin, Loader2, CheckCircle, Eye, Trash2, RotateCcw } from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { updateLease, confirmPayment, terminateLease, reactivateLease } from '../actions';\r\nimport { toast } from 'sonner';\r\n\r\ninterface Tenant {\r\n    id: string;\r\n    name: string;\r\n    property: string;\r\n    phone?: string;\r\n    email?: string;\r\n    rentAmount: number;\r\n    status: 'paid' | 'pending' | 'overdue';\r\n    dueDate?: number;\r\n    startDate?: string;\r\n    last_transaction_id?: string;\r\n    // DONNÉES DE PÉRIODE (depuis la DB, pas calculées!)\r\n    period_month?: number;\r\n    period_year?: number;\r\n    period_start?: string | null;\r\n    period_end?: string | null;\r\n}\r\n\r\ninterface ProfileData {\r\n    company_name?: string | null;\r\n    full_name?: string | null;\r\n    company_address?: string | null;\r\n    company_email?: string | null;\r\n    company_ninea?: string | null;\r\n    signature_url?: string | null;\r\n    logo_url?: string | null;\r\n}\r\n\r\ninterface TenantListProps {\r\n    tenants?: Tenant[];\r\n    profile?: ProfileData | null;\r\n    userEmail?: string;\r\n    isViewingTerminated?: boolean;\r\n}\r\n\r\nconst statusColors = {\r\n    paid: 'bg-green-500/20 text-green-400 border-green-500/30',\r\n    pending: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',\r\n    overdue: 'bg-red-500/20 text-red-400 border-red-500/30'\r\n};\r\n\r\nconst statusLabels = {\r\n    paid: 'Payé',\r\n    pending: 'En attente',\r\n    overdue: 'Retard'\r\n};\r\n\r\nexport function TenantList({ tenants = [], profile, userEmail, isViewingTerminated = false }: TenantListProps) {\r\n    const router = useRouter();\r\n    const [editingId, setEditingId] = useState<string | null>(null);\r\n    const [editData, setEditData] = useState<Partial<Tenant>>({});\r\n    const [saving, setSaving] = useState(false);\r\n\r\n    // État pour la modale de quittance\r\n    const [isReceiptOpen, setIsReceiptOpen] = useState(false);\r\n    const [currentReceipt, setCurrentReceipt] = useState<{\r\n        tenant: {\r\n            tenant_name: string;\r\n            email?: string;\r\n            phone?: string;\r\n            address: string;\r\n        };\r\n        profile: {\r\n            company_name: string;\r\n            company_address: string;\r\n            company_email?: string;\r\n            company_ninea?: string;\r\n            logo_url?: string;\r\n            signature_url?: string;\r\n        };\r\n        userEmail?: string;\r\n        amount: number;\r\n        month: string;\r\n        year: number;\r\n        property_address: string;\r\n    } | null>(null);\r\n\r\n    const getInitials = (name: string) => {\r\n        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\r\n    };\r\n\r\n    const formatAmount = (amount: number) => {\r\n        return amount.toLocaleString('fr-FR');\r\n    };\r\n\r\n    const handleEdit = (tenant: Tenant) => {\r\n        setEditingId(tenant.id);\r\n        setEditData({\r\n            name: tenant.name,\r\n            phone: tenant.phone || '',\r\n            email: tenant.email || '',\r\n            property: tenant.property,\r\n            rentAmount: tenant.rentAmount,\r\n            dueDate: tenant.dueDate,\r\n            startDate: tenant.startDate\r\n        });\r\n    };\r\n\r\n    const handleCancelEdit = () => {\r\n        setEditingId(null);\r\n        setEditData({});\r\n    };\r\n\r\n    const handleSaveEdit = async () => {\r\n        if (!editingId || !editData.email) {\r\n            toast.error('L\\'email est obligatoire');\r\n            return;\r\n        }\r\n\r\n        setSaving(true);\r\n        const result = await updateLease(editingId, {\r\n            tenant_name: editData.name,\r\n            tenant_phone: editData.phone,\r\n            tenant_email: editData.email,\r\n            property_address: editData.property,\r\n            monthly_amount: editData.rentAmount,\r\n            billing_day: editData.dueDate,\r\n            start_date: editData.startDate\r\n        });\r\n        setSaving(false);\r\n\r\n        if (result.success) {\r\n            toast.success('Locataire mis à jour!');\r\n            setEditingId(null);\r\n            setEditData({});\r\n            router.refresh(); // Rafraîchir pour afficher les nouvelles données\r\n        } else {\r\n            toast.error(result.error || 'Erreur lors de la mise à jour');\r\n        }\r\n    };\r\n\r\n    const handleTerminateLease = async (leaseId: string, tenantName: string) => {\r\n        // Confirmation avant résiliation\r\n        const confirmed = window.confirm(\r\n            `⚠️ Voulez-vous vraiment résilier le bail de ${tenantName} ?\\n\\n` +\r\n            `Le locataire n&apos;apparaîtra plus dans la liste active, mais l&apos;historique des paiements sera conservé.`\r\n        );\r\n\r\n        if (!confirmed) return;\r\n\r\n        setSaving(true);\r\n        const result = await terminateLease(leaseId);\r\n        setSaving(false);\r\n\r\n        if (result.success) {\r\n            toast.success(result.message || 'Bail résilié avec succès');\r\n            router.refresh(); // Rafraîchir pour mettre à jour la liste\r\n        } else {\r\n            toast.error(result.error || 'Erreur lors de la résiliation');\r\n        }\r\n    };\r\n\r\n    const handleReactivateLease = async (leaseId: string, tenantName: string) => {\r\n        // Confirmation avant réactivation\r\n        const confirmed = window.confirm(\r\n            `✅ Voulez-vous réactiver le bail de ${tenantName} ?\\n\\n` +\r\n            `Le locataire réapparaîtra dans la liste active et le Cron générera automatiquement les prochaines échéances.`\r\n        );\r\n\r\n        if (!confirmed) return;\r\n\r\n        setSaving(true);\r\n        const result = await reactivateLease(leaseId);\r\n        setSaving(false);\r\n\r\n        if (result.success) {\r\n            toast.success(result.message || 'Bail réactivé avec succès');\r\n            router.refresh(); // Rafraîchir pour mettre à jour la liste\r\n        } else {\r\n            toast.error(result.error || 'Erreur lors de la réactivation');\r\n        }\r\n    };\r\n\r\n    const handleConfirmPayment = async (leaseId: string, transactionId?: string) => {\r\n        // Trouver le locataire pour les données de la quittance\r\n        const tenant = tenants.find(t => t.id === leaseId);\r\n\r\n        if (!tenant) {\r\n            toast.error('Locataire introuvable');\r\n            return;\r\n        }\r\n\r\n        // Étape 1: Marquer comme payé dans la DB\r\n        const result = await confirmPayment(leaseId, transactionId);\r\n\r\n        if (!result.success) {\r\n            toast.error(result.error || 'Erreur inconnue', {\r\n                description: \"Vous pouvez toujours générer la quittance manuellement via le bouton &quot;Voir quittance&quot;.\",\r\n                duration: 7000,\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Étape 2: Demander si on envoie la quittance\r\n        const shouldSendReceipt = window.confirm(\r\n            `Le loyer est marqué comme payé. Souhaitez-vous envoyer immédiatement la quittance par email à ${tenant.name} ?`\r\n        );\r\n\r\n        if (shouldSendReceipt) {\r\n            // Vérifier si l'email existe\r\n            if (!tenant.email) {\r\n                toast.error('Email manquant pour ce locataire', {\r\n                    description: \"Modifiez le locataire pour ajouter son email.\",\r\n                    duration: 5000,\r\n                });\r\n                return;\r\n            }\r\n\r\n            // Vérifier si l'adresse du bien est renseignée\r\n            if (!tenant.property || tenant.property === 'Adresse non renseignée') {\r\n                toast.error('Adresse du bien manquante', {\r\n                    description: \"Veuillez modifier le locataire et ajouter l&apos;adresse du bien avant d&apos;envoyer la quittance.\",\r\n                    duration: 6000,\r\n                });\r\n                return;\r\n            }\r\n\r\n            // Préparer les données pour la quittance\r\n            const landlordName = profile?.company_name || profile?.full_name || \"Propriétaire\";\r\n            const landlordAddress = profile?.company_address || \"Adresse non renseignée\";\r\n\r\n            // 🚨 CRITIQUE: Utiliser les données de la transaction (DB), PAS new Date()\r\n            const periodMonth = tenant.period_month?.toString().padStart(2, '0') || '01';\r\n            const periodYear = tenant.period_year || new Date().getFullYear();\r\n\r\n            // Calculer les dates de début/fin si non présentes (fallback)\r\n            const periodStartDate = tenant.period_start\r\n                ? new Date(tenant.period_start)\r\n                : new Date(periodYear, parseInt(periodMonth) - 1, 1);\r\n\r\n            const periodEndDate = tenant.period_end\r\n                ? new Date(tenant.period_end)\r\n                : new Date(periodYear, parseInt(periodMonth), 0);\r\n\r\n            const receiptData = {\r\n                tenantName: tenant.name,\r\n                tenantEmail: tenant.email,\r\n                tenantPhone: tenant.phone || '',\r\n                tenantAddress: tenant.property,\r\n                amount: Number(tenant.rentAmount) || 0,\r\n                // DONNÉES DYNAMIQUES depuis la DB (transaction)\r\n                periodMonth: `${periodMonth}/${periodYear}`,\r\n                periodStart: periodStartDate.toLocaleDateString('fr-FR'),\r\n                periodEnd: periodEndDate.toLocaleDateString('fr-FR'),\r\n                receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\r\n                ownerName: landlordName,\r\n                ownerAddress: landlordAddress,\r\n                ownerNinea: profile?.company_ninea || undefined,\r\n                ownerLogo: profile?.logo_url || undefined,\r\n                ownerSignature: profile?.signature_url || undefined,\r\n                ownerEmail: profile?.company_email || undefined, // Email de config (priorité)\r\n                ownerAccountEmail: userEmail || undefined, // Email du compte (fallback)\r\n                propertyAddress: tenant.property,\r\n            };\r\n\r\n            // Envoyer la quittance\r\n            toast.promise(\r\n                fetch('/api/send-receipt', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify(receiptData),\r\n                }).then(async (res) => {\r\n                    const data = await res.json();\r\n                    if (!res.ok) throw new Error(data.error || 'Erreur lors de l&apos;envoi');\r\n                    return data;\r\n                }),\r\n                {\r\n                    loading: 'Envoi de la quittance par email...',\r\n                    success: 'Quittance envoyée avec succès !',\r\n                    error: (err) => `Erreur: ${err.message}`,\r\n                }\r\n            );\r\n        } else {\r\n            // Juste confirmer le paiement sans envoi\r\n            toast.success(result.message || \"Paiement enregistré avec succès !\", {\r\n                duration: 5000,\r\n            });\r\n        }\r\n\r\n        // IMPORTANT: Rafraîchir la page pour afficher le nouveau statut \"paid\"\r\n        // Cela recharge les données depuis le serveur et met à jour TOUS les locataires\r\n        router.refresh();\r\n    };\r\n\r\n    // --- LOGIQUE QUITTANCE ---\r\n    const handleViewReceipt = (tenant: Tenant) => {\r\n        // Extraction sécurisée des infos avec fallback intelligent\r\n        const landlordName = profile?.company_name || profile?.full_name || \"Propriétaire (non configuré)\";\r\n        const landlordAddress = profile?.company_address || \"Adresse (non configurée)\";\r\n\r\n        const safeProfile = {\r\n            company_name: landlordName,\r\n            company_address: landlordAddress,\r\n            company_email: profile?.company_email || undefined,\r\n            company_ninea: profile?.company_ninea || undefined,\r\n            logo_url: profile?.logo_url || undefined,\r\n            signature_url: profile?.signature_url || undefined\r\n        };\r\n\r\n        // Avertissement si le profil n'est pas complet\r\n        if (!profile?.company_name && !profile?.full_name) {\r\n            toast.warning(\"Info: Configurez votre profil pour personnaliser la quittance.\", {\r\n                duration: 5000,\r\n            });\r\n        }\r\n\r\n        // 🚨 CRITIQUE: Utiliser les données de la transaction (DB), PAS new Date()\r\n        const periodMonth = tenant.period_month?.toString().padStart(2, '0') || '01';\r\n        const periodYear = tenant.period_year || new Date().getFullYear();\r\n\r\n        setCurrentReceipt({\r\n            tenant: {\r\n                tenant_name: tenant.name,\r\n                email: tenant.email,\r\n                phone: tenant.phone,\r\n                address: tenant.property\r\n            },\r\n            profile: safeProfile,\r\n            userEmail: userEmail, // Email du compte pour fallback\r\n            amount: tenant.rentAmount,\r\n            // DONNÉES DYNAMIQUES depuis la DB (transaction)\r\n            month: periodMonth,\r\n            year: periodYear,\r\n            property_address: tenant.property\r\n        });\r\n        setIsReceiptOpen(true);\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-3\">\r\n            {/* Modale Quittance */}\r\n            <ReceiptModal\r\n                isOpen={isReceiptOpen}\r\n                onClose={() => setIsReceiptOpen(false)}\r\n                data={currentReceipt}\r\n            />\r\n            {tenants.length > 0 ? (\r\n                <div className=\"max-h-[600px] overflow-y-auto pr-2 space-y-3 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-900 [&::-webkit-scrollbar-thumb]:bg-gray-700 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-thumb]:hover:bg-gray-600\">\r\n                    {tenants.map((tenant) => (\r\n                        <div\r\n                            key={tenant.id}\r\n                            className={`p-4 rounded-xl border transition-all w-full max-w-[100vw] overflow-hidden ${editingId === tenant.id\r\n                                ? 'bg-blue-500/5 border-blue-500/30 ring-1 ring-blue-500/20'\r\n                                : 'bg-gray-900/40 border-gray-800 hover:border-gray-700'\r\n                                }`}\r\n                        >\r\n                            {editingId === tenant.id ? (\r\n                                // ===== MODE ÉDITION =====\r\n                                <div className=\"space-y-4\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <h4 className=\"text-sm font-bold text-blue-400 flex items-center gap-2\">\r\n                                            <Edit2 className=\"w-4 h-4\" /> Modification\r\n                                        </h4>\r\n                                        <Button\r\n                                            variant=\"ghost\"\r\n                                            size=\"sm\"\r\n                                            onClick={handleCancelEdit}\r\n                                            className=\"text-gray-400 hover:text-white h-8 px-2\"\r\n                                        >\r\n                                            <X className=\"w-4 h-4\" />\r\n                                        </Button>\r\n                                    </div>\r\n\r\n                                    <div className=\"grid grid-cols-1 gap-3\">\r\n                                        <Input\r\n                                            placeholder=\"Nom complet\"\r\n                                            value={editData.name || ''}\r\n                                            onChange={(e) => setEditData({ ...editData, name: e.target.value })}\r\n                                            className=\"bg-gray-800/50 border-gray-700 h-10\"\r\n                                        />\r\n                                        <Input\r\n                                            type=\"email\"\r\n                                            placeholder=\"Email *\"\r\n                                            value={editData.email || ''}\r\n                                            onChange={(e) => setEditData({ ...editData, email: e.target.value })}\r\n                                            className={`bg-gray-800/50 border-gray-700 h-10 ${!editData.email ? 'border-red-500/50' : ''}`}\r\n                                        />\r\n                                        <Input\r\n                                            placeholder=\"Téléphone\"\r\n                                            value={editData.phone || ''}\r\n                                            onChange={(e) => setEditData({ ...editData, phone: e.target.value })}\r\n                                            className=\"bg-gray-800/50 border-gray-700 h-10\"\r\n                                        />\r\n                                        <Input\r\n                                            type=\"number\"\r\n                                            placeholder=\"Loyer FCFA\"\r\n                                            value={editData.rentAmount || ''}\r\n                                            onChange={(e) => setEditData({ ...editData, rentAmount: Number(e.target.value) })}\r\n                                            className=\"bg-gray-800/50 border-gray-700 h-10\"\r\n                                        />\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <span className=\"text-xs text-gray-500 whitespace-nowrap\">Jour fact.</span>\r\n                                            <Input\r\n                                                type=\"number\"\r\n                                                min={1}\r\n                                                max={31}\r\n                                                placeholder=\"Ex: 5\"\r\n                                                value={editData.dueDate || ''}\r\n                                                onChange={(e) => setEditData({ ...editData, dueDate: Number(e.target.value) })}\r\n                                                className=\"bg-gray-800/50 border-gray-700 h-10 w-20\"\r\n                                            />\r\n                                            <span className=\"text-xs text-gray-500 whitespace-nowrap ml-2\">Début bail</span>\r\n                                            <Input\r\n                                                type=\"date\"\r\n                                                value={editData.startDate || ''}\r\n                                                onChange={(e) => setEditData({ ...editData, startDate: e.target.value })}\r\n                                                className=\"bg-gray-800/50 border-gray-700 h-10\"\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <Input\r\n                                        placeholder=\"Adresse du bien loué *\"\r\n                                        value={editData.property || ''}\r\n                                        onChange={(e) => setEditData({ ...editData, property: e.target.value })}\r\n                                        className={`bg-gray-800/50 border-gray-700 h-10 ${!editData.property || editData.property === 'Adresse non renseignée' ? 'border-orange-500/50' : ''}`}\r\n                                    />\r\n\r\n                                    <div className=\"flex gap-2\">\r\n                                        <Button\r\n                                            onClick={handleSaveEdit}\r\n                                            disabled={saving || !editData.email}\r\n                                            className=\"flex-1 bg-green-600 hover:bg-green-700 h-10\"\r\n                                        >\r\n                                            {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <><Check className=\"w-4 h-4 mr-2\" /> Enregistrer</>}\r\n                                        </Button>\r\n                                        {isViewingTerminated ? (\r\n                                            <Button\r\n                                                onClick={() => handleReactivateLease(tenant.id, tenant.name)}\r\n                                                disabled={saving}\r\n                                                variant=\"outline\"\r\n                                                className=\"border-green-500/50 text-green-400 hover:bg-green-500/10 hover:text-green-300 h-10 px-4\"\r\n                                                title=\"Réactiver le bail\"\r\n                                            >\r\n                                                <RotateCcw className=\"w-4 h-4\" />\r\n                                            </Button>\r\n                                        ) : (\r\n                                            <Button\r\n                                                onClick={() => handleTerminateLease(tenant.id, tenant.name)}\r\n                                                disabled={saving}\r\n                                                variant=\"outline\"\r\n                                                className=\"border-red-500/50 text-red-400 hover:bg-red-500/10 hover:text-red-300 h-10 px-4\"\r\n                                                title=\"Résilier le bail (conserve l'historique)\"\r\n                                            >\r\n                                                <Trash2 className=\"w-4 h-4\" />\r\n                                            </Button>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                // ===== MODE AFFICHAGE =====\r\n                                <div className=\"space-y-3\">\r\n                                    {/* Ligne 1: Avatar + Nom + Statut */}\r\n                                    <div className=\"flex items-center gap-3\">\r\n                                        <div className=\"w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm shrink-0\">\r\n                                            {getInitials(tenant.name)}\r\n                                        </div>\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <h3 className=\"font-semibold text-white truncate text-sm\">{tenant.name}</h3>\r\n                                            <p className=\"text-xs text-gray-500 truncate\">{tenant.property}</p>\r\n                                        </div>\r\n                                        <span className={`px-2 py-1 rounded-lg text-[10px] font-medium border shrink-0 ${statusColors[tenant.status] || statusColors.pending}`}>\r\n                                            {statusLabels[tenant.status] || 'En attente'}\r\n                                        </span>\r\n                                    </div>\r\n\r\n                                    {/* Ligne 2: Infos + Montant */}\r\n                                    <div className=\"flex items-center justify-between text-xs text-gray-400 pl-[52px]\">\r\n                                        <div className=\"flex items-center gap-4 overflow-hidden\">\r\n                                            {tenant.phone && (\r\n                                                <span className=\"flex items-center gap-1 shrink-0\">\r\n                                                    <Phone className=\"w-3 h-3\" /> {tenant.phone}\r\n                                                </span>\r\n                                            )}\r\n                                            {tenant.dueDate && (\r\n                                                <span className=\"flex items-center gap-1 shrink-0\">\r\n                                                    <Calendar className=\"w-3 h-3\" /> {tenant.dueDate} du mois\r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n                                        <div className=\"text-right shrink-0\">\r\n                                            <span className=\"text-white font-bold text-base\">{formatAmount(tenant.rentAmount)}</span>\r\n                                            <span className=\"text-gray-500 ml-1\">FCFA/mois</span>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Ligne 3: Warning email/adresse + Actions */}\r\n                                    <div className=\"flex items-center justify-between pl-[52px]\">\r\n                                        <div className=\"flex flex-col gap-1\">\r\n                                            {!tenant.email ? (\r\n                                                <span className=\"text-xs text-red-400 flex items-center gap-1\">\r\n                                                    <Mail className=\"w-3 h-3\" /> Email manquant\r\n                                                </span>\r\n                                            ) : (\r\n                                                <span className=\"text-xs text-gray-600 truncate\">{tenant.email}</span>\r\n                                            )}\r\n                                            {(!tenant.property || tenant.property === 'Adresse non renseignée') && (\r\n                                                <span className=\"text-xs text-orange-400 flex items-center gap-1\">\r\n                                                    <MapPin className=\"w-3 h-3\" /> Adresse manquante\r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n\r\n                                        <div className=\"flex items-center gap-2 mt-4\">\r\n                                            {/* Bouton \"Marquer payé\" pour pending ET overdue */}\r\n                                            {(tenant.status === 'pending' || tenant.status === 'overdue') && (\r\n                                                <Button\r\n                                                    size=\"sm\"\r\n                                                    onClick={() => handleConfirmPayment(tenant.id, tenant.last_transaction_id)}\r\n                                                    className={`${tenant.status === 'overdue'\r\n                                                        ? 'bg-orange-600 hover:bg-orange-700 shadow-orange-500/20'\r\n                                                        : 'bg-green-600 hover:bg-green-700 shadow-green-500/20'\r\n                                                        } text-white font-bold rounded-xl h-9 shadow-lg transition-all active:scale-95`}\r\n                                                >\r\n                                                    <CheckCircle className=\"w-4 h-4 mr-2\" />\r\n                                                    {tenant.status === 'overdue' ? 'Paiement reçu' : 'Marquer payé'}\r\n                                                </Button>\r\n                                            )}\r\n                                            {/* Bouton \"Voir quittance\" uniquement pour paid */}\r\n                                            {tenant.status === 'paid' && (\r\n                                                <button\r\n                                                    onClick={() => handleViewReceipt(tenant)}\r\n                                                    className=\"flex items-center gap-2 px-3 py-2 rounded-xl bg-blue-500/10 text-blue-400 hover:bg-blue-500/20 transition-colors text-xs font-medium border border-blue-500/20\"\r\n                                                >\r\n                                                    <Eye className=\"w-3 h-3\" /> Voir quittance\r\n                                                </button>\r\n                                            )}\r\n                                            <Button\r\n                                                variant=\"outline\"\r\n                                                size=\"sm\"\r\n                                                className=\"rounded-xl border-gray-700 text-gray-400 hover:text-white hover:bg-gray-800\"\r\n                                                onClick={() => handleEdit(tenant)}\r\n                                            >\r\n                                                Modifier\r\n                                            </Button>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    ))\r\n                    }\r\n                </div>\r\n            ) : (\r\n                <div className=\"p-12 text-center border-2 border-dashed border-gray-800 rounded-2xl\">\r\n                    <User className=\"w-10 h-10 text-gray-700 mx-auto mb-3\" />\r\n                    <p className=\"text-gray-400 text-sm\">Aucun locataire enregistré</p>\r\n                    <p className=\"text-xs text-gray-600 mt-1\">Cliquez sur &quot;Nouveau Locataire&quot; pour commencer</p>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\TenantTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Edit2' is defined but never used.","line":6,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'onDelete' is defined but never used.","line":102,"column":129,"nodeType":null,"messageId":"unusedVar","endLine":102,"endColumn":137},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'onDeleteLease' is defined but never used.","line":102,"column":139,"nodeType":null,"messageId":"unusedVar","endLine":102,"endColumn":152},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'saving' is assigned a value but never used.","line":104,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":104,"endColumn":18},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\components\\TenantTable.tsx:219:41\n  217 |                 periodStart: periodStartDate.toLocaleDateString('fr-FR'),\n  218 |                 periodEnd: periodEndDate.toLocaleDateString('fr-FR'),\n> 219 |                 receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\n      |                                         ^^^^^^^^^^ Cannot call impure function\n  220 |                 ownerName: profile?.company_name || profile?.full_name || \"Propriétaire\",\n  221 |                 ownerAddress: profile?.company_address || \"Adresse non renseignée\",\n  222 |                 ownerNinea: profile?.company_ninea || undefined,","line":219,"column":41,"nodeType":null,"endLine":219,"endColumn":51}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { ReceiptModal } from './ReceiptModal';\nimport { useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { MoreHorizontal, Eye, Edit2, CheckCircle, Trash2, RotateCcw, ArrowUpDown, ArrowUp, ArrowDown, FileText } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { GenerateContractButton } from '@/components/contracts/GenerateContractButton';\nimport { EmptyState } from '@/components/ui/empty-state';\nimport { AddTenantButton } from './AddTenantButton';\nimport {\n    DropdownMenu,\n    DropdownMenuContent,\n    DropdownMenuItem,\n    DropdownMenuSeparator,\n    DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport { confirmPayment, terminateLease, reactivateLease } from '../actions';\nimport { toast } from 'sonner';\n\ninterface Tenant {\n    id: string;\n    name: string;\n    property: string;\n    phone?: string;\n    email?: string;\n    rentAmount: number;\n    status: 'paid' | 'pending' | 'overdue';\n    dueDate?: number;\n    startDate?: string;\n    last_transaction_id?: string;\n    period_month?: number;\n    period_year?: number;\n    period_start?: string | null;\n    period_end?: string | null;\n    lease_pdf_url?: string | null;\n    tenant_name?: string; // Often redundant with name but useful if explicit\n}\n\ninterface ProfileData {\n    company_name?: string | null;\n    full_name?: string | null;\n    company_address?: string | null;\n    company_email?: string | null;\n    company_ninea?: string | null;\n    signature_url?: string | null;\n    logo_url?: string | null;\n}\n\ninterface TenantTableProps {\n    tenants?: Tenant[];\n    profile?: ProfileData | null;\n    userEmail?: string;\n    isViewingTerminated?: boolean;\n    searchQuery?: string;\n    onEdit?: (tenant: Tenant) => void;\n    onDelete?: (transactionId: string) => void;\n    onDeleteLease?: (leaseId: string) => void;\n    ownerId?: string;\n}\n\nconst statusConfig = {\n    paid: { label: 'Payé', bg: 'bg-green-500/10', text: 'text-green-400', dot: 'bg-green-500' },\n    pending: { label: 'Attente', bg: 'bg-yellow-500/10', text: 'text-yellow-400', dot: 'bg-yellow-500' },\n    overdue: { label: 'Retard', bg: 'bg-red-500/10', text: 'text-red-400', dot: 'bg-red-500' }\n};\n\ntype SortField = 'name' | 'property' | 'rentAmount' | 'status' | 'period';\ntype SortOrder = 'asc' | 'desc';\n\ninterface ReceiptData {\n    tenant?: {\n        tenant_name?: string;\n        name?: string;\n        email?: string;\n        phone?: string;\n        address?: string;\n    };\n    property_address?: string;\n    amount?: number;\n    period?: string;\n    month?: string | number;\n    year?: number;\n    periodStart?: string;\n    periodEnd?: string;\n    receiptNumber?: string;\n    userEmail?: string;\n    profile?: {\n        company_name?: string | null;\n        full_name?: string | null;\n        company_address?: string | null;\n        company_email?: string | null;\n        email?: string;\n        logo_url?: string | null;\n        signature_url?: string | null;\n        ninea?: string | null;\n        company_ninea?: string | null;\n    };\n    receiptImage?: string | null;\n}\n\nexport function TenantTable({ tenants = [], profile, userEmail, ownerId, isViewingTerminated = false, searchQuery = '', onEdit, onDelete, onDeleteLease }: TenantTableProps) {\n    const router = useRouter();\n    const [saving, setSaving] = useState(false);\n    const [isReceiptOpen, setIsReceiptOpen] = useState(false);\n    const [currentReceipt, setCurrentReceipt] = useState<ReceiptData | null>(null);\n    const [sortField, setSortField] = useState<SortField>('name');\n    const [sortOrder, setSortOrder] = useState<SortOrder>('asc');\n\n    const getInitials = (name: string) => {\n        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n    };\n\n    const formatAmount = (amount: number) => {\n        return amount.toLocaleString('fr-FR');\n    };\n\n    const handleSort = (field: SortField) => {\n        if (sortField === field) {\n            setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');\n        } else {\n            setSortField(field);\n            setSortOrder('asc');\n        }\n    };\n\n    const SortIcon = ({ field }: { field: SortField }) => {\n        if (sortField !== field) {\n            return <ArrowUpDown className=\"w-3 h-3 text-slate-600\" />;\n        }\n        return sortOrder === 'asc'\n            ? <ArrowUp className=\"w-3 h-3 text-slate-400\" />\n            : <ArrowDown className=\"w-3 h-3 text-slate-400\" />;\n    };\n\n    const filteredTenants = tenants\n        .filter(tenant =>\n            tenant.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n            tenant.property.toLowerCase().includes(searchQuery.toLowerCase()) ||\n            tenant.email?.toLowerCase().includes(searchQuery.toLowerCase())\n        )\n        .sort((a, b) => {\n            let compareA: string | number;\n            let compareB: string | number;\n\n            switch (sortField) {\n                case 'name':\n                    compareA = a.name.toLowerCase();\n                    compareB = b.name.toLowerCase();\n                    break;\n                case 'property':\n                    compareA = a.property.toLowerCase();\n                    compareB = b.property.toLowerCase();\n                    break;\n                case 'rentAmount':\n                    compareA = a.rentAmount;\n                    compareB = b.rentAmount;\n                    break;\n                case 'status':\n                    const statusOrder = { paid: 0, pending: 1, overdue: 2 };\n                    compareA = statusOrder[a.status];\n                    compareB = statusOrder[b.status];\n                    break;\n                case 'period':\n                    compareA = `${a.period_year}-${String(a.period_month).padStart(2, '0')}`;\n                    compareB = `${b.period_year}-${String(b.period_month).padStart(2, '0')}`;\n                    break;\n                default:\n                    return 0;\n            }\n\n            if (compareA < compareB) return sortOrder === 'asc' ? -1 : 1;\n            if (compareA > compareB) return sortOrder === 'asc' ? 1 : -1;\n            return 0;\n        });\n\n    const handleConfirmPayment = async (leaseId: string, transactionId?: string) => {\n        const tenant = tenants.find(t => t.id === leaseId);\n        if (!tenant) {\n            toast.error('Locataire introuvable');\n            return;\n        }\n\n        const result = await confirmPayment(leaseId, transactionId);\n\n        if (!result.success) {\n            toast.error(result.error || 'Erreur inconnue');\n            return;\n        }\n\n        const shouldSendReceipt = window.confirm(\n            `Le loyer est marqué comme payé. Envoyer la quittance par email à ${tenant.name} ?`\n        );\n\n        if (shouldSendReceipt) {\n            if (!tenant.email) {\n                toast.error('Email manquant pour ce locataire');\n                return;\n            }\n\n            const periodMonth = tenant.period_month?.toString().padStart(2, '0') || '01';\n            const periodYear = tenant.period_year || new Date().getFullYear();\n            const periodStartDate = tenant.period_start\n                ? new Date(tenant.period_start)\n                : new Date(periodYear, parseInt(periodMonth) - 1, 1);\n            const periodEndDate = tenant.period_end\n                ? new Date(tenant.period_end)\n                : new Date(periodYear, parseInt(periodMonth), 0);\n\n            const receiptData = {\n                tenantName: tenant.name,\n                tenantEmail: tenant.email,\n                tenantPhone: tenant.phone || '',\n                tenantAddress: tenant.property,\n                amount: Number(tenant.rentAmount) || 0,\n                periodMonth: `${periodMonth}/${periodYear}`,\n                periodStart: periodStartDate.toLocaleDateString('fr-FR'),\n                periodEnd: periodEndDate.toLocaleDateString('fr-FR'),\n                receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\n                ownerName: profile?.company_name || profile?.full_name || \"Propriétaire\",\n                ownerAddress: profile?.company_address || \"Adresse non renseignée\",\n                ownerNinea: profile?.company_ninea || undefined,\n                ownerLogo: profile?.logo_url || undefined,\n                ownerSignature: profile?.signature_url || undefined,\n                ownerEmail: profile?.company_email || undefined,\n                ownerAccountEmail: userEmail || undefined,\n                propertyAddress: tenant.property,\n            };\n\n            toast.promise(\n                fetch('/api/send-receipt', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(receiptData),\n                }).then(async (res) => {\n                    const data = await res.json();\n                    if (!res.ok) throw new Error(data.error || 'Erreur lors de l\\'envoi');\n                    return data;\n                }),\n                {\n                    loading: 'Envoi de la quittance...',\n                    success: 'Quittance envoyée !',\n                    error: (err) => `Erreur: ${err.message}`,\n                }\n            );\n        } else {\n            toast.success(result.message || \"Paiement enregistré !\");\n        }\n\n        router.refresh();\n    };\n\n    const handleViewReceipt = (tenant: Tenant) => {\n        const periodMonth = tenant.period_month?.toString().padStart(2, '0') || '01';\n        const periodYear = tenant.period_year || new Date().getFullYear();\n\n        setCurrentReceipt({\n            tenant: {\n                tenant_name: tenant.name,\n                email: tenant.email,\n                phone: tenant.phone,\n                address: tenant.property\n            },\n            profile: {\n                company_name: profile?.company_name || profile?.full_name || \"Propriétaire\",\n                company_address: profile?.company_address || \"Adresse non renseignée\",\n                company_email: profile?.company_email || undefined,\n                company_ninea: profile?.company_ninea || undefined,\n                logo_url: profile?.logo_url || undefined,\n                signature_url: profile?.signature_url || undefined\n            },\n            userEmail: userEmail,\n            amount: tenant.rentAmount,\n            month: periodMonth,\n            year: periodYear,\n            property_address: tenant.property\n        });\n        setIsReceiptOpen(true);\n    };\n\n    const handleTerminateLease = async (leaseId: string, tenantName: string) => {\n        const confirmed = window.confirm(\n            `⚠️ Voulez-vous vraiment résilier le bail de ${tenantName} ?`\n        );\n        if (!confirmed) return;\n\n        setSaving(true);\n        const result = await terminateLease(leaseId);\n        setSaving(false);\n\n        if (result.success) {\n            toast.success(result.message || 'Bail résilié');\n            router.refresh();\n        } else {\n            toast.error(result.error || 'Erreur');\n        }\n    };\n\n    const handleReactivateLease = async (leaseId: string, tenantName: string) => {\n        const confirmed = window.confirm(\n            `✅ Réactiver le bail de ${tenantName} ?`\n        );\n        if (!confirmed) return;\n\n        setSaving(true);\n        const result = await reactivateLease(leaseId);\n        setSaving(false);\n\n        if (result.success) {\n            toast.success(result.message || 'Bail réactivé');\n            router.refresh();\n        } else {\n            toast.error(result.error || 'Erreur');\n        }\n    };\n\n    const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];\n\n    return (\n        <>\n            <ReceiptModal\n                isOpen={isReceiptOpen}\n                onClose={() => setIsReceiptOpen(false)}\n                data={currentReceipt}\n            />\n\n            {/* Table Dark Enterprise - Responsive */}\n            <div className=\"bg-black border border-slate-800 rounded-lg overflow-x-auto max-w-[100vw] w-full\">\n                <table className=\"w-full text-left text-sm\">\n                    <thead className=\"border-b border-slate-800\">\n                        <tr>\n                            {/* Locataire - Always visible */}\n                            <th className=\"py-3 px-2 sm:px-4\">\n                                <button\n                                    onClick={() => handleSort('name')}\n                                    className=\"flex items-center gap-1.5 text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-300 transition-colors\"\n                                >\n                                    Locataire\n                                    <SortIcon field=\"name\" />\n                                </button>\n                            </th>\n\n                            {/* Bien - Hidden on mobile */}\n                            <th className=\"py-3 px-4 hidden lg:table-cell\">\n                                <button\n                                    onClick={() => handleSort('property')}\n                                    className=\"flex items-center gap-1.5 text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-300 transition-colors\"\n                                >\n                                    Bien\n                                    <SortIcon field=\"property\" />\n                                </button>\n                            </th>\n\n                            {/* Période - Hidden on mobile */}\n                            <th className=\"py-3 px-4 hidden md:table-cell\">\n                                <button\n                                    onClick={() => handleSort('period')}\n                                    className=\"flex items-center gap-1.5 text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-300 transition-colors\"\n                                >\n                                    Période\n                                    <SortIcon field=\"period\" />\n                                </button>\n                            </th>\n\n                            {/* Statut - Always visible */}\n                            <th className=\"py-3 px-4\">\n                                <button\n                                    onClick={() => handleSort('status')}\n                                    className=\"flex items-center gap-1.5 text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-300 transition-colors\"\n                                >\n                                    Statut\n                                    <SortIcon field=\"status\" />\n                                </button>\n                            </th>\n\n                            {/* Montant - Always visible */}\n                            <th className=\"py-3 px-4 text-right\">\n                                <button\n                                    onClick={() => handleSort('rentAmount')}\n                                    className=\"flex items-center gap-1.5 ml-auto text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-300 transition-colors\"\n                                >\n                                    Montant\n                                    <SortIcon field=\"rentAmount\" />\n                                </button>\n                            </th>\n\n                            {/* Actions */}\n                            <th className=\"py-3 px-4 text-right w-12\">\n                                <span className=\"sr-only\">Actions</span>\n                            </th>\n                        </tr>\n                    </thead>\n                    <tbody className=\"divide-y divide-slate-800/50\">\n                        {filteredTenants.map((tenant) => {\n                            const periodLabel = tenant.period_month && tenant.period_year\n                                ? `${monthNames[tenant.period_month - 1]} ${tenant.period_year}`\n                                : '-';\n\n                            return (\n                                <tr key={tenant.last_transaction_id || tenant.id} className=\"hover:bg-slate-900/50 transition-colors\">\n                                    {/* Locataire */}\n                                    <td className=\"py-3 px-2 sm:px-4\">\n                                        <div className=\"flex items-center gap-3\">\n                                            <div className=\"w-8 h-8 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-white text-xs font-medium shrink-0\">\n                                                {getInitials(tenant.name)}\n                                            </div>\n                                            <div className=\"min-w-0\">\n                                                <div className=\"font-medium text-white text-sm truncate\">{tenant.name}</div>\n                                                <div className=\"text-xs text-slate-500 truncate\">{tenant.email || 'Email manquant'}</div>\n                                            </div>\n                                        </div>\n                                    </td>\n\n                                    {/* Bien - Hidden on mobile */}\n                                    <td className=\"py-3 px-4 hidden lg:table-cell\">\n                                        <div className=\"text-sm text-slate-400 truncate max-w-[200px]\">{tenant.property}</div>\n                                    </td>\n\n                                    {/* Période - Hidden on mobile */}\n                                    <td className=\"py-3 px-4 hidden md:table-cell\">\n                                        <div className=\"text-sm text-slate-400\">{periodLabel}</div>\n                                    </td>\n\n                                    {/* Statut */}\n                                    <td className=\"py-3 px-4\">\n                                        <div className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-medium ${statusConfig[tenant.status].bg} ${statusConfig[tenant.status].text}`}>\n                                            <div className={`w-1.5 h-1.5 rounded-full ${statusConfig[tenant.status].dot}`} />\n                                            {statusConfig[tenant.status].label}\n                                        </div>\n                                    </td>\n\n                                    {/* Montant */}\n                                    <td className=\"py-3 px-4 text-right\">\n                                        <div className=\"font-mono font-medium text-white text-sm\">{formatAmount(tenant.rentAmount)}</div>\n                                        <div className=\"text-xs text-slate-600\">FCFA</div>\n                                    </td>\n\n                                    {/* Actions */}\n                                    <td className=\"py-3 px-4 text-right\">\n                                        <DropdownMenu>\n                                            <DropdownMenuTrigger asChild>\n                                                <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0 hover:bg-slate-800\">\n                                                    <MoreHorizontal className=\"h-4 w-4 text-slate-500\" />\n                                                </Button>\n                                            </DropdownMenuTrigger>\n                                            <DropdownMenuContent align=\"end\" className=\"w-44 bg-slate-900 border-slate-800\">\n                                                {tenant.status === 'paid' && (\n                                                    <DropdownMenuItem onClick={() => handleViewReceipt(tenant)} className=\"text-slate-300 hover:bg-slate-800 focus:bg-slate-800\">\n                                                        <Eye className=\"mr-2 h-4 w-4\" />\n                                                        Voir quittance\n                                                    </DropdownMenuItem>\n                                                )}\n                                                {(tenant.status === 'pending' || tenant.status === 'overdue') && (\n                                                    <DropdownMenuItem onClick={() => handleConfirmPayment(tenant.id, tenant.last_transaction_id)} className=\"text-slate-300 hover:bg-slate-800 focus:bg-slate-800\">\n                                                        <CheckCircle className=\"mr-2 h-4 w-4\" />\n                                                        Marquer payé\n                                                    </DropdownMenuItem>\n                                                )}\n                                                <DropdownMenuItem\n                                                    onClick={() => onEdit?.(tenant)}\n                                                    className=\"text-slate-300 hover:bg-slate-800 focus:bg-slate-800\"\n                                                >\n                                                    Modifier\n                                                </DropdownMenuItem>\n\n                                                <DropdownMenuItem asChild>\n                                                    <div className=\"w-full cursor-pointer text-slate-300 hover:bg-slate-800 focus:bg-slate-800\">\n                                                        <GenerateContractButton\n                                                            leaseId={tenant.id}\n                                                            tenantName={tenant.name || tenant.tenant_name || \"Locataire\"}\n                                                            existingContractUrl={tenant.lease_pdf_url || undefined}\n                                                            variant=\"ghost\"\n                                                            className=\"w-full justify-start px-2 py-1.5 h-auto font-normal\"\n                                                        />\n                                                    </div>\n                                                </DropdownMenuItem>\n\n                                                <DropdownMenuSeparator className=\"bg-slate-800\" />\n                                                {isViewingTerminated ? (\n                                                    <DropdownMenuItem onClick={() => handleReactivateLease(tenant.id, tenant.name)} className=\"text-green-400 hover:bg-slate-800 focus:bg-slate-800\">\n                                                        <RotateCcw className=\"mr-2 h-4 w-4\" />\n                                                        Réactiver\n                                                    </DropdownMenuItem>\n                                                ) : (\n                                                    <DropdownMenuItem onClick={() => handleTerminateLease(tenant.id, tenant.name)} className=\"text-orange-400 hover:bg-slate-800 focus:bg-slate-800\">\n                                                        <Trash2 className=\"mr-2 h-4 w-4\" />\n                                                        Résilier\n                                                    </DropdownMenuItem>\n                                                )}\n                                            </DropdownMenuContent>\n                                        </DropdownMenu>\n                                    </td>\n                                </tr>\n                            );\n                        })}\n                    </tbody>\n                </table>\n\n                {filteredTenants.length === 0 && (\n                    <div className=\"py-8 px-4\">\n                        {!searchQuery ? (\n                            <EmptyState\n                                title=\"Votre gestion commence ici\"\n                                description=\"Créez un bail pour générer automatiquement vos contrats et quittances.\"\n                                icon={FileText}\n                                actionComponent={\n                                    ownerId ? (\n                                        <AddTenantButton\n                                            ownerId={ownerId}\n                                            trigger={\n                                                <Button size=\"lg\" className=\"bg-[#F4C430] text-black hover:bg-[#F4C430]/90 font-semibold w-full sm:w-auto\">\n                                                    Créer un Bail\n                                                </Button>\n                                            }\n                                        />\n                                    ) : null\n                                }\n                                secondaryActionComponent={\n                                    ownerId ? (\n                                        <AddTenantButton\n                                            ownerId={ownerId}\n                                            initialData={{\n                                                name: \"Moussa Diop\",\n                                                phone: \"+221 77 123 45 67\",\n                                                email: \"moussa.diop@example.com\",\n                                                address: \"Appartement F4, Sacré-Cœur 3, Dakar\",\n                                                amount: 250000,\n                                                day: 5,\n                                                startDate: new Date().toISOString().split('T')[0],\n                                                endDate: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0]\n                                            }}\n                                            trigger={\n                                                <Button variant=\"ghost\" className=\"mt-2 sm:mt-0 sm:ml-2\">\n                                                    Voir un exemple de bail\n                                                </Button>\n                                            }\n                                        />\n                                    ) : null\n                                }\n                            />\n                        ) : (\n                            <div className=\"text-center py-16\">\n                                <div className=\"text-slate-500 text-sm\">\n                                    Aucun résultat pour cette recherche\n                                </div>\n                            </div>\n                        )}\n                    </div>\n                )}\n            </div >\n        </>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\config\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'uploadData' is assigned a value but never used.","line":91,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'uploadData' is assigned a value but never used.","line":133,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":133,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":185,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":185,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5660,5663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5660,5663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function updateBranding(formData: FormData) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) return { success: false, error: \"Non autorisé\" };\r\n\r\n    const updates = {\r\n        company_name: formData.get('company_name'),\r\n        company_address: formData.get('company_address'),\r\n        company_phone: formData.get('company_phone'),\r\n        company_email: formData.get('company_email'),\r\n        company_ninea: formData.get('company_ninea'),\r\n        updated_at: new Date().toISOString()\r\n    };\r\n\r\n    const { error } = await supabase\r\n        .from('profiles')\r\n        .update(updates)\r\n        .eq('id', user.id);\r\n\r\n    if (!error) {\r\n        // IMPORTANT: Revalider TOUTES les pages qui utilisent le profil\r\n        revalidatePath('/compte/gestion-locative/config');\r\n        revalidatePath('/compte/gestion-locative');\r\n    }\r\n\r\n    return { success: !error, error: error?.message };\r\n}\r\n\r\n/**\r\n * Met à jour les paramètres de branding Premium de l'utilisateur\r\n */\r\nexport async function updatePremiumBranding(formData: {\r\n    company_name?: string;\r\n    company_address?: string;\r\n    company_phone?: string;\r\n    company_email?: string;\r\n    company_ninea?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    const updates = {\r\n        company_name: formData.company_name || null,\r\n        company_address: formData.company_address || null,\r\n        company_phone: formData.company_phone || null,\r\n        company_email: formData.company_email || null,\r\n        company_ninea: formData.company_ninea || null,\r\n        updated_at: new Date().toISOString()\r\n    };\r\n\r\n    const { error } = await supabase\r\n        .from('profiles')\r\n        .update(updates)\r\n        .eq('id', user.id);\r\n\r\n    if (error) {\r\n        console.error(\"Erreur mise à jour branding:\", error.message);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative/config');\r\n    return { success: true };\r\n}\r\n\r\n/**\r\n * Upload du logo vers Supabase Storage et mise à jour du profil\r\n */\r\nexport async function uploadLogo(file: File) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    // Générer un nom de fichier unique\r\n    const fileExt = file.name.split('.').pop();\r\n    const fileName = `${user.id}/logo.${fileExt}`;\r\n\r\n    // Upload vers le bucket 'branding'\r\n    const { data: uploadData, error: uploadError } = await supabase.storage\r\n        .from('branding')\r\n        .upload(fileName, file, { upsert: true });\r\n\r\n    if (uploadError) {\r\n        console.error(\"Erreur upload logo:\", uploadError.message);\r\n        return { success: false, error: uploadError.message };\r\n    }\r\n\r\n    // Obtenir l'URL publique\r\n    const { data: { publicUrl } } = supabase.storage\r\n        .from('branding')\r\n        .getPublicUrl(fileName);\r\n\r\n    // Mettre à jour le profil avec l'URL du logo\r\n    const { error } = await supabase\r\n        .from('profiles')\r\n        .update({ logo_url: publicUrl })\r\n        .eq('id', user.id);\r\n\r\n    if (error) {\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative/config');\r\n    return { success: true, url: publicUrl };\r\n}\r\n\r\n/**\r\n * Upload de la signature vers Supabase Storage et mise à jour du profil\r\n */\r\nexport async function uploadSignature(file: File) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    const fileExt = file.name.split('.').pop();\r\n    const fileName = `${user.id}/signature.${fileExt}`;\r\n\r\n    const { data: uploadData, error: uploadError } = await supabase.storage\r\n        .from('branding')\r\n        .upload(fileName, file, { upsert: true });\r\n\r\n    if (uploadError) {\r\n        console.error(\"Erreur upload signature:\", uploadError.message);\r\n        return { success: false, error: uploadError.message };\r\n    }\r\n\r\n    const { data: { publicUrl } } = supabase.storage\r\n        .from('branding')\r\n        .getPublicUrl(fileName);\r\n\r\n    const { error } = await supabase\r\n        .from('profiles')\r\n        .update({ signature_url: publicUrl })\r\n        .eq('id', user.id);\r\n\r\n    if (error) {\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    revalidatePath('/compte/gestion-locative/config');\r\n    return { success: true, url: publicUrl };\r\n}\r\n\r\n/**\r\n * Récupérer les données de branding de l'utilisateur\r\n */\r\nexport async function getPremiumBranding() {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, data: null };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n        .from('profiles')\r\n        .select('company_name, company_address, company_phone, company_email, company_ninea, logo_url, signature_url')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (error) {\r\n        return { success: false, data: null };\r\n    }\r\n\r\n    return { success: true, data };\r\n}\r\n\r\nconst N8N_WEBHOOK_URL = process.env.N8N_WEBHOOK_URL;\r\n\r\nexport async function sendTestEmail(profileData: any) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non autorisé\" };\r\n    }\r\n\r\n    if (!N8N_WEBHOOK_URL) {\r\n        console.warn('N8N_WEBHOOK_URL non configuré');\r\n        // Fallback simulation for dev environment if no webhook\r\n        await new Promise(resolve => setTimeout(resolve, 1000));\r\n        return { success: true, message: \"Simulation (Webhook non configuré)\" };\r\n    }\r\n\r\n    try {\r\n        // Construct the test payload with user's specific branding\r\n        const payload = {\r\n            type: 'test_email',\r\n            recipientEmail: user.email, // Send to the logged-in user\r\n            ownerName: profileData?.full_name || \"Nom Propriétaire\",\r\n            companyName: profileData?.company_name || \"Nom Agence\",\r\n            companyAddress: profileData?.company_address || \"Adresse Agence\",\r\n            companyLogo: profileData?.logo_url || \"\",\r\n            companySignature: profileData?.signature_url || \"\",\r\n            // Add dummy data for template preview\r\n            tenantName: \"Jean Dupont (Exemple)\",\r\n            amount: 150000,\r\n            month: new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })\r\n        };\r\n\r\n        const response = await fetch(`${N8N_WEBHOOK_URL}/generate-lease-pdf`, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify(payload),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`Webhook error: ${response.status}`);\r\n        }\r\n\r\n        return { success: true };\r\n    } catch (error) {\r\n        console.error('Erreur envoi test:', error);\r\n        return { success: false, error: \"Erreur lors de l'envoi\" };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\config\\api-settings.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[330,333],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[330,333],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":29,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Mail, CheckCircle2, ShieldCheck, Lock, MessageSquare, Send, RefreshCw } from 'lucide-react';\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nimport { sendTestEmail } from './actions';\r\nimport { toast } from 'sonner';\r\n\r\ninterface ApiSettingsProps {\r\n    profile?: any;\r\n}\r\n\r\nexport function ApiSettings({ profile }: ApiSettingsProps) {\r\n    const [testing, setTesting] = useState(false);\r\n    const [testSuccess, setTestSuccess] = useState(false);\r\n\r\n    const handleTestEmail = async () => {\r\n        setTesting(true);\r\n        try {\r\n            const result = await sendTestEmail(profile);\r\n            if (result.success) {\r\n                setTestSuccess(true);\r\n                toast.success(\"Email de test envoyé avec vos paramètres !\");\r\n                setTimeout(() => setTestSuccess(false), 5000);\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors de l'envoi\");\r\n            }\r\n        } catch (e) {\r\n            toast.error(\"Erreur technique\");\r\n        } finally {\r\n            setTesting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-8 mt-10\">\r\n            <div className=\"flex items-center gap-2 text-blue-500 font-bold\">\r\n                <ShieldCheck className=\"w-5 h-5\" />\r\n                <h2 className=\"text-lg\">Configuration des Envois Premium</h2>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 gap-6\">\r\n                {/* Focus Principal : Gmail */}\r\n                <div className=\"p-6 md:p-8 bg-blue-600/5 border border-blue-500/20 rounded-[2rem]\">\r\n                    <div className=\"flex flex-col md:flex-row items-start md:items-center gap-6\">\r\n                        <div className=\"p-4 bg-blue-500/20 rounded-2xl shrink-0\">\r\n                            <Mail className=\"w-8 h-8 text-blue-400\" />\r\n                        </div>\r\n\r\n                        <div className=\"flex-1 space-y-3\">\r\n                            <div className=\"flex flex-wrap items-center gap-2\">\r\n                                <h3 className=\"text-xl font-bold\">Service Email (Gmail)</h3>\r\n                                <span className=\"text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full uppercase font-bold\">\r\n                                    Actif\r\n                                </span>\r\n                            </div>\r\n\r\n                            <p className=\"text-sm text-gray-400\">\r\n                                Votre compte Gmail est utilisé pour envoyer automatiquement les{' '}\r\n                                <span className=\"text-blue-300 font-medium\">Baux</span>,{' '}\r\n                                <span className=\"text-blue-300 font-medium\">Avis d&apos;échéance</span> et{' '}\r\n                                <span className=\"text-blue-300 font-medium\">Quittances</span> à vos locataires.\r\n                            </p>\r\n\r\n                            <div className=\"flex items-center gap-2 text-xs text-blue-300 font-medium\">\r\n                                <CheckCircle2 className=\"w-4 h-4\" />\r\n                                Certificats PDF envoyés avec succès via votre adresse liée.\r\n                            </div>\r\n\r\n\r\n                        </div>\r\n\r\n                        <div className=\"w-full md:w-auto\">\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                className={`w-full md:w-auto border-gray-700 transition-all ${testSuccess\r\n                                    ? 'border-green-500/50 text-green-400 bg-green-500/10'\r\n                                    : 'text-gray-400 hover:text-white hover:bg-gray-800'\r\n                                    }`}\r\n                                onClick={handleTestEmail}\r\n                                disabled={testing}\r\n                            >\r\n                                {testing ? (\r\n                                    <><RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" /> Envoi en cours...</>\r\n                                ) : testSuccess ? (\r\n                                    <><CheckCircle2 className=\"w-4 h-4 mr-2\" /> Email envoyé!</>\r\n                                ) : (\r\n                                    <><Send className=\"w-4 h-4 mr-2\" /> Tester l&apos;envoi</>\r\n                                )}\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Section WhatsApp (Désactivée - Bientôt disponible) */}\r\n                <div className=\"p-6 bg-gray-900/20 border border-gray-800 rounded-[2rem] relative overflow-hidden\">\r\n                    {/* Overlay \"Coming Soon\" */}\r\n                    <div className=\"absolute inset-0 bg-black/20 backdrop-blur-[1px] z-10 flex items-center justify-center\">\r\n                        <div className=\"bg-gray-800 px-4 py-2 rounded-full flex items-center gap-2 text-xs font-bold text-gray-300 shadow-xl border border-gray-700\">\r\n                            <Lock className=\"w-3 h-3\" /> Bientôt disponible\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Contenu désactivé */}\r\n                    <div className=\"opacity-40\">\r\n                        <div className=\"flex items-center gap-3 mb-4\">\r\n                            <div className=\"p-3 bg-gray-800 rounded-xl\">\r\n                                <MessageSquare className=\"w-5 h-5 text-gray-500\" />\r\n                            </div>\r\n                            <div>\r\n                                <h3 className=\"font-bold text-gray-500\">Notifications WhatsApp</h3>\r\n                                <p className=\"text-xs text-gray-600\">Envoyez des rappels directement sur WhatsApp</p>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <div className=\"h-10 w-full bg-gray-800/50 rounded-xl\"></div>\r\n                            <div className=\"h-10 w-2/3 bg-gray-800/50 rounded-xl\"></div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Note informative */}\r\n            <div className=\"p-4 bg-gray-900/30 border border-gray-800 rounded-2xl\">\r\n                <p className=\"text-xs text-gray-500 text-center\">\r\n                    💡 Les emails sont envoyés automatiquement via n8n. Assurez-vous que votre workflow n8n est configuré\r\n                    et que votre compte Gmail est connecté dans les paramètres n8n.\r\n                </p>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\config\\config-form.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":42,"column":9,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":42,"endColumn":71},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":70,"column":13,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":70,"endColumn":77},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":147,"column":33,"nodeType":"JSXOpeningElement","endLine":147,"endColumn":105},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":201,"column":33,"nodeType":"JSXOpeningElement","endLine":201,"endColumn":115},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":312,"column":33,"nodeType":"JSXOpeningElement","endLine":312,"endColumn":101},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":335,"column":29,"nodeType":"JSXOpeningElement","endLine":335,"endColumn":107}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Upload, PenTool, Building2, Save, Check, Phone, Mail, MapPin, Loader2, Trash2 } from 'lucide-react';\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { updateBranding } from './actions';\r\nimport { toast } from 'sonner';\r\n\r\ninterface BrandingData {\r\n    company_name?: string | null;\r\n    company_address?: string | null;\r\n    company_phone?: string | null;\r\n    company_email?: string | null;\r\n    company_ninea?: string | null;\r\n    logo_url?: string | null;\r\n    signature_url?: string | null;\r\n}\r\n\r\ninterface ConfigFormProps {\r\n    initialData: BrandingData | null;\r\n}\r\n\r\nexport function ConfigForm({ initialData }: ConfigFormProps) {\r\n    const [logoPreview, setLogoPreview] = useState<string | null>(initialData?.logo_url || null);\r\n    const [signaturePreview, setSignaturePreview] = useState<string | null>(initialData?.signature_url || null);\r\n    const [saving, setSaving] = useState(false);\r\n    const [saved, setSaved] = useState(false);\r\n    const [uploadingLogo, setUploadingLogo] = useState(false);\r\n    const [uploadingSignature, setUploadingSignature] = useState(false);\r\n\r\n    const [formData, setFormData] = useState({\r\n        company_name: initialData?.company_name || '',\r\n        company_address: initialData?.company_address || '',\r\n        company_phone: initialData?.company_phone || '',\r\n        company_email: initialData?.company_email || '',\r\n        company_ninea: initialData?.company_ninea || ''\r\n    });\r\n\r\n    const handleFileUpload = async (file: File, type: 'logo' | 'signature') => {\r\n        const isLogo = type === 'logo';\r\n        isLogo ? setUploadingLogo(true) : setUploadingSignature(true);\r\n\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append('file', file);\r\n            formData.append('type', type);\r\n\r\n            const response = await fetch('/api/branding/upload', {\r\n                method: 'POST',\r\n                body: formData\r\n            });\r\n\r\n            const result = await response.json();\r\n\r\n            if (result.success) {\r\n                if (isLogo) {\r\n                    setLogoPreview(result.url);\r\n                } else {\r\n                    setSignaturePreview(result.url);\r\n                }\r\n                toast.success(result.message || `${isLogo ? 'Logo' : 'Signature'} enregistré!`);\r\n            } else {\r\n                toast.error(result.error || 'Erreur lors de l\\'upload');\r\n            }\r\n        } catch (error) {\r\n            console.error('Erreur upload:', error);\r\n            toast.error('Erreur lors de l\\'upload du fichier');\r\n        } finally {\r\n            isLogo ? setUploadingLogo(false) : setUploadingSignature(false);\r\n        }\r\n    };\r\n\r\n    const handleLogoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (file) {\r\n            // Prévisualisation immédiate\r\n            const reader = new FileReader();\r\n            reader.onloadend = () => setLogoPreview(reader.result as string);\r\n            reader.readAsDataURL(file);\r\n\r\n            // Upload vers Supabase\r\n            handleFileUpload(file, 'logo');\r\n        }\r\n    };\r\n\r\n    const handleSignatureUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (file) {\r\n            const reader = new FileReader();\r\n            reader.onloadend = () => setSignaturePreview(reader.result as string);\r\n            reader.readAsDataURL(file);\r\n\r\n            handleFileUpload(file, 'signature');\r\n        }\r\n    };\r\n\r\n    const handleSave = async () => {\r\n        setSaving(true);\r\n\r\n        const formDataObj = new FormData();\r\n        if (formData.company_name) formDataObj.append('company_name', formData.company_name);\r\n        if (formData.company_address) formDataObj.append('company_address', formData.company_address);\r\n        if (formData.company_phone) formDataObj.append('company_phone', formData.company_phone);\r\n        if (formData.company_email) formDataObj.append('company_email', formData.company_email);\r\n        if (formData.company_ninea) formDataObj.append('company_ninea', formData.company_ninea);\r\n\r\n        // Appel à la nouvelle server action (Step 3)\r\n        const result = await updateBranding(formDataObj); // utilisation de updateBranding importé depuis ./actions (ou config/actions)\r\n\r\n        setSaving(false);\r\n        if (result.success) {\r\n            setSaved(true);\r\n            toast.success('Configuration enregistrée!');\r\n            setTimeout(() => setSaved(false), 3000);\r\n        } else {\r\n            toast.error(result.error || 'Erreur lors de la sauvegarde');\r\n        }\r\n    };\r\n\r\n    const handleInputChange = (field: keyof typeof formData, value: string) => {\r\n        setFormData(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-10\">\r\n            {/* Upload Sections */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                {/* Section Logo */}\r\n                <section className=\"space-y-4 p-6 bg-gray-900/40 rounded-3xl border border-gray-800\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-blue-400 font-bold\">\r\n                            <Building2 className=\"w-5 h-5\" /> Logo de l&apos;Agence\r\n                        </div>\r\n                        {uploadingLogo && (\r\n                            <div className=\"flex items-center gap-2 text-xs text-blue-400\">\r\n                                <Loader2 className=\"w-3 h-3 animate-spin\" /> Upload...\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                    <label className=\"block\">\r\n                        <div className={`h-40 border-2 border-dashed rounded-2xl flex flex-col items-center justify-center transition-all cursor-pointer relative overflow-hidden ${logoPreview\r\n                            ? 'border-blue-500/50 bg-blue-500/5'\r\n                            : 'border-gray-700 bg-gray-900/20 hover:border-blue-500/50'\r\n                            } ${uploadingLogo ? 'opacity-50 pointer-events-none' : ''}`}>\r\n                            {logoPreview ? (\r\n                                <img src={logoPreview} alt=\"Logo\" className=\"max-h-32 object-contain\" />\r\n                            ) : (\r\n                                <>\r\n                                    <Upload className=\"w-8 h-8 text-gray-600 mb-2\" />\r\n                                    <p className=\"text-xs text-gray-500 text-center px-4\">\r\n                                        Cliquez pour ajouter votre logo\r\n                                    </p>\r\n                                    <p className=\"text-[10px] text-gray-600 mt-1\">PNG, JPG (max 2MB)</p>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                        <input\r\n                            type=\"file\"\r\n                            accept=\"image/png,image/jpeg,image/webp\"\r\n                            className=\"hidden\"\r\n                            onChange={handleLogoUpload}\r\n                            disabled={uploadingLogo}\r\n                        />\r\n                    </label>\r\n                    {logoPreview && !uploadingLogo && (\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-xs text-green-400 flex items-center gap-1\">\r\n                                <Check className=\"w-3 h-3\" /> Logo enregistré\r\n                            </span>\r\n                            <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                className=\"text-red-400 text-xs hover:bg-red-500/10\"\r\n                                onClick={() => setLogoPreview(null)}\r\n                            >\r\n                                <Trash2 className=\"w-3 h-3 mr-1\" /> Supprimer\r\n                            </Button>\r\n                        </div>\r\n                    )}\r\n                </section>\r\n\r\n                {/* Section Signature */}\r\n                <section className=\"space-y-4 p-6 bg-gray-900/40 rounded-3xl border border-gray-800\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2 text-purple-400 font-bold\">\r\n                            <PenTool className=\"w-5 h-5\" /> Signature Numérique\r\n                        </div>\r\n                        {uploadingSignature && (\r\n                            <div className=\"flex items-center gap-2 text-xs text-purple-400\">\r\n                                <Loader2 className=\"w-3 h-3 animate-spin\" /> Upload...\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                    <label className=\"block\">\r\n                        <div className={`h-40 border-2 border-dashed rounded-2xl flex flex-col items-center justify-center transition-all cursor-pointer relative overflow-hidden ${signaturePreview\r\n                            ? 'border-purple-500/50 bg-purple-500/5'\r\n                            : 'border-gray-700 bg-gray-900/20 hover:border-purple-500/50'\r\n                            } ${uploadingSignature ? 'opacity-50 pointer-events-none' : ''}`}>\r\n                            {signaturePreview ? (\r\n                                <img src={signaturePreview} alt=\"Signature\" className=\"max-h-32 object-contain\" />\r\n                            ) : (\r\n                                <>\r\n                                    <Upload className=\"w-8 h-8 text-gray-600 mb-2\" />\r\n                                    <p className=\"text-xs text-gray-500 text-center px-4\">\r\n                                        Importez votre signature scannée\r\n                                    </p>\r\n                                    <p className=\"text-[10px] text-gray-600 mt-1\">PNG avec fond transparent recommandé</p>\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                        <input\r\n                            type=\"file\"\r\n                            accept=\"image/png,image/jpeg,image/webp\"\r\n                            className=\"hidden\"\r\n                            onChange={handleSignatureUpload}\r\n                            disabled={uploadingSignature}\r\n                        />\r\n                    </label>\r\n                    {signaturePreview && !uploadingSignature && (\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-xs text-green-400 flex items-center gap-1\">\r\n                                <Check className=\"w-3 h-3\" /> Signature enregistrée\r\n                            </span>\r\n                            <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                className=\"text-red-400 text-xs hover:bg-red-500/10\"\r\n                                onClick={() => setSignaturePreview(null)}\r\n                            >\r\n                                <Trash2 className=\"w-3 h-3 mr-1\" /> Supprimer\r\n                            </Button>\r\n                        </div>\r\n                    )}\r\n                </section>\r\n            </div>\r\n\r\n            {/* Informations Commerciales */}\r\n            <section className=\"p-6 md:p-8 bg-gray-900/40 rounded-3xl border border-gray-800 space-y-6\">\r\n                <h2 className=\"text-lg font-bold flex items-center gap-2\">\r\n                    <Building2 className=\"w-5 h-5 text-gray-400\" />\r\n                    Informations de l&apos;émetteur\r\n                </h2>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm text-gray-400\">Nom commercial / Raison sociale</label>\r\n                        <Input\r\n                            placeholder=\"ex: SCI Teranga Immo\"\r\n                            className=\"bg-gray-800/50 border-gray-700 h-12\"\r\n                            value={formData.company_name}\r\n                            onChange={(e) => handleInputChange('company_name', e.target.value)}\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm text-gray-400\">NINEA (optionnel)</label>\r\n                        <Input\r\n                            placeholder=\"ex: 12345678 A 01\"\r\n                            className=\"bg-gray-800/50 border-gray-700 h-12\"\r\n                            value={formData.company_ninea}\r\n                            onChange={(e) => handleInputChange('company_ninea', e.target.value)}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                    <label className=\"text-sm text-gray-400 flex items-center gap-2\">\r\n                        <MapPin className=\"w-4 h-4\" /> Adresse complète\r\n                    </label>\r\n                    <Input\r\n                        placeholder=\"ex: Rue 10 x Avenue Cheikh Anta Diop, Dakar\"\r\n                        className=\"bg-gray-800/50 border-gray-700 h-12\"\r\n                        value={formData.company_address}\r\n                        onChange={(e) => handleInputChange('company_address', e.target.value)}\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm text-gray-400 flex items-center gap-2\">\r\n                            <Phone className=\"w-4 h-4\" /> Téléphone\r\n                        </label>\r\n                        <Input\r\n                            placeholder=\"ex: +221 77 123 45 67\"\r\n                            className=\"bg-gray-800/50 border-gray-700 h-12\"\r\n                            value={formData.company_phone}\r\n                            onChange={(e) => handleInputChange('company_phone', e.target.value)}\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm text-gray-400 flex items-center gap-2\">\r\n                            <Mail className=\"w-4 h-4\" /> Email professionnel\r\n                        </label>\r\n                        <Input\r\n                            type=\"email\"\r\n                            placeholder=\"ex: contact@monagence.sn\"\r\n                            className=\"bg-gray-800/50 border-gray-700 h-12\"\r\n                            value={formData.company_email}\r\n                            onChange={(e) => handleInputChange('company_email', e.target.value)}\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </section>\r\n\r\n            {/* Aperçu Document */}\r\n            <section className=\"p-6 md:p-8 bg-gradient-to-br from-gray-900/60 to-gray-800/40 rounded-3xl border border-gray-700 space-y-4\">\r\n                <h2 className=\"text-lg font-bold\">Aperçu sur vos documents</h2>\r\n                <div className=\"bg-white text-black rounded-2xl p-6 space-y-4\">\r\n                    <div className=\"flex items-center justify-between border-b border-gray-200 pb-4\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            {logoPreview ? (\r\n                                <img src={logoPreview} alt=\"Logo\" className=\"h-10 object-contain\" />\r\n                            ) : (\r\n                                <div className=\"w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 text-xs\">\r\n                                    Logo\r\n                                </div>\r\n                            )}\r\n                            <div>\r\n                                <p className=\"font-bold text-sm\">{formData.company_name || 'Votre nom commercial'}</p>\r\n                                <p className=\"text-[10px] text-gray-500\">\r\n                                    {formData.company_address || 'Votre adresse'} | {formData.company_phone || 'Votre téléphone'}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                            <p className=\"text-[10px] text-gray-400\">QUITTANCE DE LOYER</p>\r\n                            <p className=\"text-sm font-bold text-green-600\">PAYÉ ✓</p>\r\n                        </div>\r\n                    </div>\r\n                    <div className=\"text-center py-4 text-gray-400 text-sm\">\r\n                        [Contenu du document...]\r\n                    </div>\r\n                    <div className=\"flex justify-end pt-4 border-t border-gray-200\">\r\n                        {signaturePreview ? (\r\n                            <img src={signaturePreview} alt=\"Signature\" className=\"h-12 object-contain\" />\r\n                        ) : (\r\n                            <div className=\"w-24 h-12 border-b-2 border-gray-300 flex items-end justify-center text-[10px] text-gray-400 pb-1\">\r\n                                Signature\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </section>\r\n\r\n            {/* Bouton Save */}\r\n            <div className=\"flex justify-end\">\r\n                <Button\r\n                    onClick={handleSave}\r\n                    disabled={saving || uploadingLogo || uploadingSignature}\r\n                    className={`px-10 h-14 text-lg font-bold rounded-2xl transition-all ${saved\r\n                        ? 'bg-green-600 hover:bg-green-600'\r\n                        : 'bg-blue-600 hover:bg-blue-700'\r\n                        }`}\r\n                >\r\n                    {saving ? (\r\n                        <><Loader2 className=\"w-5 h-5 mr-2 animate-spin\" /> Enregistrement...</>\r\n                    ) : saved ? (\r\n                        <><Check className=\"w-5 h-5 mr-2\" /> Configuration sauvegardée</>\r\n                    ) : (\r\n                        <><Save className=\"w-5 h-5 mr-2\" /> Enregistrer ma configuration</>\r\n                    )}\r\n                </Button>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\config\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RentalStats' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'stats' is assigned a value but never used.","line":107,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":107,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { RentalStats } from \"./components/RentalStats\";\r\nimport { getRentalStats } from \"./actions\";\r\nimport { GestionLocativeClient } from \"./components/GestionLocativeClient\";\r\nimport { AddTenantButton } from \"./components/AddTenantButton\";\r\nimport { MaintenanceHub } from \"./components/MaintenanceHub\";\r\nimport { LegalAlertsWidget } from \"./components/LegalAlertsWidget\";\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport { redirect } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\n\r\nexport default async function GestionLocativePage({\r\n    searchParams,\r\n}: {\r\n    searchParams?: Promise<{ view?: string }>;\r\n}) {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        redirect('/auth');\r\n    }\r\n\r\n    // Unwrap searchParams (Next.js 15+)\r\n    const params = await searchParams;\r\n\r\n    // Déterminer le statut à afficher (actifs ou résiliés)\r\n    const viewMode = params?.view === 'terminated' ? 'terminated' : 'active';\r\n    const isViewingTerminated = viewMode === 'terminated';\r\n\r\n    // ========================================\r\n    // RÉCUPÉRATION DES VRAIES DONNÉES SUPABASE\r\n    // ========================================\r\n\r\n    // 0. Récupérer le profil pour les infos de quittance (Branding)\r\n    // IMPORTANT: On récupère TOUS les champs nécessaires pour le fallback intelligent\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('company_name, company_address, company_email, company_ninea, signature_url, logo_url, full_name')\r\n        .eq('id', user.id)\r\n        .maybeSingle();\r\n\r\n    // 1. Récupérer tous les baux du propriétaire (colonnes explicites)\r\n    const { data: leases, error: leasesError } = await supabase\r\n        .from('leases')\r\n        .select('id, tenant_name, tenant_phone, tenant_email, property_address, monthly_amount, billing_day, start_date, end_date, status, created_at')\r\n        .eq('owner_id', user.id)\r\n        // TEMPORAIRE: Afficher TOUS les baux pour diagnostic\r\n        // .eq('status', viewMode) // Dynamique: 'active' ou 'terminated'\r\n        .order('created_at', { ascending: false });\r\n\r\n    // Filtrer côté client selon le statut\r\n    const filteredLeases = isViewingTerminated\r\n        ? (leases || []).filter(l => l.status === 'terminated')\r\n        : (leases || []).filter(l => !l.status || l.status === 'active' || l.status === 'pending');\r\n\r\n    if (leasesError) {\r\n        console.error(\"Erreur récupération baux:\", leasesError.message);\r\n    }\r\n\r\n    // 1.5 Récupérer la date du tout premier bail (pour bloquer la navigation avant l'activité)\r\n    const { data: earliestLease } = await supabase\r\n        .from('leases')\r\n        .select('start_date')\r\n        .eq('owner_id', user.id)\r\n        .order('start_date', { ascending: true })\r\n        .limit(1)\r\n        .single();\r\n\r\n    const minDateStr = earliestLease?.start_date || new Date().toISOString();\r\n\r\n    // 2. Récupérer TOUTES les transactions de loyer (pour tous les mois)\r\n    const { data: rawTransactions, error: transError } = await supabase\r\n        .from('rental_transactions')\r\n        .select('id, lease_id, period_month, period_year, status, amount_due, paid_at, period_start, period_end')\r\n        .in('lease_id', (filteredLeases || []).map(l => l.id))\r\n        .order('period_year', { ascending: false })\r\n        .order('period_month', { ascending: false });\r\n\r\n    // Polyfill pour amount_paid (car la colonne n'existe pas encore en base)\r\n    // Cela permet au Finance Guard de fonctionner (Règle : Encaissé = amount_paid)\r\n    // En attendant la migration DB, on assume que Payé = Totalité.\r\n    const transactions = (rawTransactions || []).map(t => ({\r\n        ...t,\r\n        amount_paid: (t.status?.toLowerCase() === 'paid') ? t.amount_due : 0\r\n    }));\r\n\r\n    if (transError) {\r\n        console.error(\"Erreur récupération transactions:\", transError.message);\r\n    }\r\n\r\n    // 3. Récupérer les demandes de maintenance (avec infos artisan) - Aperçu seulement\r\n    const { data: maintenanceData, error: maintenanceError } = await supabase\r\n        .from('maintenance_requests')\r\n        .select('id, description, status, created_at, lease_id, artisan_name, artisan_phone, artisan_rating, artisan_address, quoted_price, intervention_date, owner_approved')\r\n        .order('created_at', { ascending: false })\r\n        .limit(5); // Limiter à 5 pour l'aperçu\r\n\r\n    const maintenanceRequests = maintenanceData || [];\r\n\r\n    if (maintenanceError) {\r\n        console.error(\"Erreur récupération maintenance:\", maintenanceError.message);\r\n    }\r\n\r\n    // ========================================\r\n    // CALCUL DES STATISTIQUES (MODE RÉEL)\r\n    // ========================================\r\n    const stats = await getRentalStats();\r\n\r\n    // Transformer les demandes de maintenance pour MaintenanceHub\r\n    const formattedRequests = (maintenanceRequests || []).map(req => {\r\n        const categoryMatch = req.description?.match(/\\[([^\\]]+)\\]$/);\r\n        const category = categoryMatch ? categoryMatch[1] : undefined;\r\n        const cleanDescription = category ? req.description.replace(` [${category}]`, '') : req.description;\r\n\r\n        return {\r\n            id: req.id,\r\n            description: cleanDescription,\r\n            category: category,\r\n            status: req.status,\r\n            created_at: req.created_at,\r\n            artisan_name: req.artisan_name,\r\n            artisan_phone: req.artisan_phone,\r\n            artisan_rating: req.artisan_rating,\r\n            artisan_address: req.artisan_address,\r\n            quoted_price: req.quoted_price,\r\n            intervention_date: req.intervention_date,\r\n            owner_approved: req.owner_approved\r\n        };\r\n    });\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-950 print:hidden\">\r\n            {/* Sub-header avec filtres Actifs/Résiliés */}\r\n            <div className=\"border-b border-slate-800 bg-slate-900/50\">\r\n                <div className=\"w-full mx-auto px-4 md:px-6 py-3\">\r\n                    <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n                        <div className=\"flex items-center gap-2 px-3 py-1 bg-slate-900 border border-slate-800 rounded-lg\">\r\n                            <Link\r\n                                href=\"/compte/gestion-locative\"\r\n                                className={`px-3 py-1 text-xs font-medium rounded transition-all ${!isViewingTerminated\r\n                                    ? 'bg-green-500/10 text-green-400'\r\n                                    : 'text-slate-400 hover:text-white'\r\n                                    }`}\r\n                            >\r\n                                Actifs\r\n                            </Link>\r\n                            <Link\r\n                                href=\"/compte/gestion-locative?view=terminated\"\r\n                                className={`px-3 py-1 text-xs font-medium rounded transition-all ${isViewingTerminated\r\n                                    ? 'bg-orange-500/10 text-orange-400'\r\n                                    : 'text-slate-400 hover:text-white'\r\n                                    }`}\r\n                            >\r\n                                Résiliés\r\n                            </Link>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            {!isViewingTerminated && <AddTenantButton ownerId={user.id} profile={profile} />}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Contenu principal */}\r\n            <div className=\"w-full mx-auto px-4 md:px-6 py-6\">\r\n                {/* Table des locataires - Pleine largeur */}\r\n                <div className=\"mb-6\">\r\n                    <GestionLocativeClient\r\n                        leases={filteredLeases || []}\r\n                        transactions={transactions || []}\r\n                        profile={profile}\r\n                        userEmail={user.email}\r\n                        ownerId={user.id}\r\n                        isViewingTerminated={isViewingTerminated}\r\n                        minDate={minDateStr}\r\n                    />\r\n                </div>\r\n\r\n                {/* Widgets Dashboard - Vue d'ensemble */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 min-w-0\">\r\n                    {/* Interventions - Aperçu */}\r\n                    <div className=\"bg-slate-900 border border-slate-800 rounded-lg p-4\">\r\n                        <div className=\"flex items-center justify-between mb-4\">\r\n                            <h3 className=\"text-sm font-semibold text-white\">Interventions Récentes</h3>\r\n                            <Link\r\n                                href=\"/compte/interventions\"\r\n                                className=\"text-xs text-slate-400 hover:text-white transition-colors\"\r\n                            >\r\n                                Voir tout →\r\n                            </Link>\r\n                        </div>\r\n                        <MaintenanceHub requests={formattedRequests} />\r\n                    </div>\r\n\r\n                    {/* Alertes Juridiques */}\r\n                    <div className=\"bg-slate-900 border border-slate-800 rounded-lg p-4\">\r\n                        <div className=\"flex items-center justify-between mb-4\">\r\n                            <h3 className=\"text-sm font-semibold text-white\">Alertes Juridiques</h3>\r\n                            <Link\r\n                                href=\"/compte/legal\"\r\n                                className=\"text-xs text-slate-400 hover:text-white transition-colors\"\r\n                            >\r\n                                Voir tout →\r\n                            </Link>\r\n                        </div>\r\n                        <LegalAlertsWidget />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\gestion-locative\\templates\\document-structures.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\interventions\\page.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":59,"column":84,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[2613,2664],"text":"Gérez les demandes d&apos;intervention de vos locataires"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[2613,2664],"text":"Gérez les demandes d&lsquo;intervention de vos locataires"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[2613,2664],"text":"Gérez les demandes d&#39;intervention de vos locataires"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[2613,2664],"text":"Gérez les demandes d&rsquo;intervention de vos locataires"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MaintenanceHub } from \"../gestion-locative/components/MaintenanceHub\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { redirect } from \"next/navigation\";\nimport { RentalTour } from \"@/components/onboarding/RentalTour\";\n\nexport default async function InterventionsPage() {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n        redirect('/auth');\n    }\n\n    // Récupérer les demandes de maintenance (avec infos artisan)\n    const { data: maintenanceData, error: maintenanceError } = await supabase\n        .from('maintenance_requests')\n        .select('id, description, status, created_at, lease_id, artisan_name, artisan_phone, artisan_rating, artisan_address, quoted_price, intervention_date, owner_approved')\n        .order('created_at', { ascending: false });\n\n    const maintenanceRequests = maintenanceData || [];\n\n    if (maintenanceError) {\n        console.error(\"Erreur récupération maintenance:\", maintenanceError.message);\n    }\n\n    // Transformer les demandes de maintenance pour MaintenanceHub\n    const formattedRequests = (maintenanceRequests || []).map(req => {\n        // Extraire la catégorie de la description si elle existe (format: \"description [Catégorie]\")\n        const categoryMatch = req.description?.match(/\\[([^\\]]+)\\]$/);\n        const category = categoryMatch ? categoryMatch[1] : undefined;\n        const cleanDescription = category ? req.description.replace(` [${category}]`, '') : req.description;\n\n        return {\n            id: req.id,\n            description: cleanDescription,\n            category: category,\n            status: req.status,\n            created_at: req.created_at,\n            // Infos artisan (Make.com)\n            artisan_name: req.artisan_name,\n            artisan_phone: req.artisan_phone,\n            artisan_rating: req.artisan_rating,\n            artisan_address: req.artisan_address,\n            // Infos devis\n            quoted_price: req.quoted_price,\n            intervention_date: req.intervention_date,\n            owner_approved: req.owner_approved\n        };\n    });\n\n    return (\n        <div className=\"min-h-screen bg-slate-950\">\n            <RentalTour page=\"interventions\" />\n\n            {/* Header */}\n            <div id=\"tour-intervention-stats\" className=\"border-b border-slate-800 bg-slate-900/50\">\n                <div className=\"w-full mx-auto px-4 md:px-6 py-4\">\n                    <h1 className=\"text-2xl font-bold text-white\">Interventions & Maintenance</h1>\n                    <p className=\"text-sm text-slate-400 mt-1\">Gérez les demandes d'intervention de vos locataires</p>\n                </div>\n            </div>\n\n            {/* Contenu principal */}\n            <div className=\"w-full mx-auto px-4 md:px-6 py-6\">\n                <div id=\"tour-intervention-list\" className=\"max-w-4xl mx-auto\">\n                    <MaintenanceHub requests={formattedRequests} />\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\legal\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\legal\\components\\CreateContractDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Search' is defined but never used.","line":4,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":52},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cn' is defined but never used.","line":22,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { ShieldCheck, FileText, CheckCircle, Search } from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogTrigger,\r\n} from '@/components/ui/dialog';\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { GenerateContractButton } from '@/components/contracts/GenerateContractButton';\r\nimport { cn } from '@/lib/utils';\r\n\r\ninterface Lease {\r\n    id: string;\r\n    tenant_name: string;\r\n    property_address: string;\r\n    lease_pdf_url?: string | null;\r\n}\r\n\r\ninterface CreateContractDialogProps {\r\n    leases: Lease[];\r\n}\r\n\r\nexport function CreateContractDialog({ leases }: CreateContractDialogProps) {\r\n    const [selectedLeaseId, setSelectedLeaseId] = useState<string>('');\r\n    const [isOpen, setIsOpen] = useState(false);\r\n\r\n    const selectedLease = leases.find(l => l.id === selectedLeaseId);\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={setIsOpen}>\r\n            <DialogTrigger asChild>\r\n                <button id=\"tour-generate-contract\" className=\"w-full text-left p-6 rounded-xl border border-slate-800 bg-gradient-to-br from-slate-900 to-black hover:border-slate-700 transition-all group outline-none focus:ring-2 focus:ring-blue-500/50\">\r\n                    <div className=\"h-10 w-10 rounded-lg bg-slate-800 flex items-center justify-center mb-4 group-hover:bg-slate-700 transition-colors\">\r\n                        <ShieldCheck className=\"h-5 w-5 text-white\" />\r\n                    </div>\r\n                    <h3 className=\"text-lg font-semibold text-white\">Nouveau Contrat de Bail</h3>\r\n                    <p className=\"text-sm text-slate-400 mt-2\">Générer un contrat conforme OHADA / Sénégal pour un locataire existant.</p>\r\n                </button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"bg-slate-900 border-slate-800 text-slate-100 sm:max-w-md\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2 text-white\">\r\n                        <FileText className=\"h-5 w-5 text-blue-500\" />\r\n                        Générateur de Contrat\r\n                    </DialogTitle>\r\n                    <DialogDescription className=\"text-slate-400\">\r\n                        Sélectionnez un bail actif pour générer le contrat PDF.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-6 py-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <label className=\"text-sm font-medium text-slate-300\">Locataire & Bien</label>\r\n                        <Select value={selectedLeaseId} onValueChange={setSelectedLeaseId}>\r\n                            <SelectTrigger className=\"bg-slate-800 border-slate-700 text-slate-100 focus:ring-blue-500 focus:ring-offset-slate-900\">\r\n                                <SelectValue placeholder=\"Sélectionner un bail...\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent className=\"bg-slate-800 border-slate-700 text-slate-100\">\r\n                                {leases.length === 0 ? (\r\n                                    <div className=\"py-6 text-center text-sm text-slate-500\">\r\n                                        Aucun bail actif trouvé\r\n                                    </div>\r\n                                ) : (\r\n                                    leases.map((lease) => (\r\n                                        <SelectItem key={lease.id} value={lease.id} className=\"focus:bg-slate-700 focus:text-slate-100 data-[state=checked]:bg-slate-700\">\r\n                                            <span className=\"font-medium\">{lease.tenant_name}</span>\r\n                                            <span className=\"ml-2 text-slate-500 text-xs truncate max-w-[200px] inline-block align-bottom\">\r\n                                                - {lease.property_address}\r\n                                            </span>\r\n                                        </SelectItem>\r\n                                    ))\r\n                                )}\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n\r\n                    {selectedLease && (\r\n                        <div className=\"bg-slate-800/50 rounded-lg p-4 space-y-3 border border-slate-700/50\">\r\n                            <div className=\"flex justify-between items-start\">\r\n                                <div>\r\n                                    <h4 className=\"font-medium text-white\">{selectedLease.tenant_name}</h4>\r\n                                    <p className=\"text-xs text-slate-400 mt-1\">{selectedLease.property_address}</p>\r\n                                </div>\r\n                                {selectedLease.lease_pdf_url && (\r\n                                    <div className=\"px-2 py-1 rounded-full bg-green-500/10 text-green-400 text-[10px] font-medium border border-green-500/20 flex items-center gap-1\">\r\n                                        <CheckCircle className=\"h-3 w-3\" />\r\n                                        Contrat existant\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div className=\"pt-2 flex justify-end\">\r\n                                <GenerateContractButton\r\n                                    leaseId={selectedLease.id}\r\n                                    tenantName={selectedLease.tenant_name}\r\n                                    existingContractUrl={selectedLease.lease_pdf_url || undefined}\r\n                                    variant=\"default\"\r\n                                    className=\"w-full bg-blue-600 hover:bg-blue-700 text-white\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\legal\\components\\DecisionModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\legal\\components\\GenerateNoticeButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\(gestion)\\legal\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Gavel' is defined but never used.","line":1,"column":48,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":53},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShieldCheck' is defined but never used.","line":1,"column":55,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":66},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Scale' is defined but never used.","line":1,"column":75,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":80},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used.","line":1,"column":92,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":98},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":86,"column":111,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[5298,5311],"text":"Type d&apos;alerte"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[5298,5311],"text":"Type d&lsquo;alerte"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[5298,5311],"text":"Type d&#39;alerte"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[5298,5311],"text":"Type d&rsquo;alerte"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AlertTriangle, CheckCircle, FileText, Gavel, ShieldCheck, Clock, Scale, BookOpen, Shield } from \"lucide-react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { format } from \"date-fns\";\r\nimport { fr } from \"date-fns/locale\";\r\nimport { getLegalStats, getLeaseAlerts, getAllActiveLeases } from \"./actions\";\r\nimport { DecisionModal } from \"./components/DecisionModal\";\r\nimport { CreateContractDialog } from \"./components/CreateContractDialog\";\r\n\r\nimport { RentalTour } from \"@/components/onboarding/RentalTour\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function LegalAssistantPage() {\r\n    const stats = await getLegalStats();\r\n    const alerts = await getLeaseAlerts();\r\n    const leases = await getAllActiveLeases();\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-950\">\r\n            <RentalTour page=\"legal\" />\r\n            <div className=\"max-w-[1400px] mx-auto px-4 md:px-6 py-8 space-y-8 animate-in fade-in duration-500\">\r\n\r\n                {/* SECTION 1 : EN-TÊTE */}\r\n                <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-bold text-white\">\r\n                            Assistant Juridique\r\n                        </h1>\r\n                        <p className=\"text-slate-400 mt-1\">Conformité Loi 2014 & COCC Sénégal 🇸🇳</p>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* SECTION 2 : LES KPI (Indicateurs Clés) */}\r\n                <div id=\"tour-legal-kpi\" className=\"grid gap-4 md:grid-cols-3\">\r\n                    <Card className=\"bg-slate-900 border-slate-800\">\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium text-slate-200\">Baux Actifs</CardTitle>\r\n                            <FileText className=\"h-4 w-4 text-blue-500\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold text-white\">{stats.activeLeases}</div>\r\n                            <p className=\"text-xs text-slate-500\">Tous enregistrés</p>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    <Card className=\"bg-slate-900 border-slate-800 relative overflow-hidden\">\r\n                        {/* Indicateur visuel pour attirer l'oeil */}\r\n                        {stats.upcomingRenewals > 0 && (\r\n                            <div className=\"absolute top-0 right-0 w-1 h-full bg-orange-500\" />\r\n                        )}\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium text-slate-200\">Renouvellements (3 mois)</CardTitle>\r\n                            <Clock className=\"h-4 w-4 text-orange-500\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold text-white\">{stats.upcomingRenewals}</div>\r\n                            <p className=\"text-xs text-orange-400\">\r\n                                {stats.upcomingRenewals > 0 ? 'Tacite reconduction approche' : 'Aucune échéance proche'}\r\n                            </p>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    <Card className=\"bg-slate-900 border-slate-800\">\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium text-slate-200\">Risque Juridique</CardTitle>\r\n                            <AlertTriangle className=\"h-4 w-4 text-red-500\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold text-white\">{stats.legalRisks}</div>\r\n                            <p className=\"text-xs text-slate-500\">Aucun contentieux en cours</p>\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* SECTION 3 : LE RADAR DES ÉCHÉANCES */}\r\n                <div id=\"tour-legal-alerts\" className=\"space-y-4\">\r\n                    <h2 className=\"text-xl font-semibold text-white\">Radar des Échéances</h2>\r\n                    <div className=\"rounded-lg border border-slate-800 bg-black/50 overflow-hidden\">\r\n                        {alerts.length > 0 ? (\r\n                            <div className=\"overflow-x-auto\">\r\n                                <table className=\"w-full text-sm text-left min-w-[600px]\">\r\n                                    <thead className=\"bg-slate-900/50 text-slate-400 font-medium border-b border-slate-800\">\r\n                                        <tr>\r\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Locataire & Bien</th>\r\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Échéance</th>\r\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Type d'alerte</th>\r\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Statut</th>\r\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 text-right whitespace-nowrap\">Action</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody className=\"divide-y divide-slate-800\">\r\n                                        {alerts.map((alert) => (\r\n                                            <tr key={alert.id} className=\"hover:bg-slate-900/50 transition-colors group\">\r\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\r\n                                                    <div className=\"text-white font-medium whitespace-nowrap\">{alert.tenant_name}</div>\r\n                                                    <div className=\"text-slate-500 text-xs max-w-[150px] md:max-w-none truncate\">{alert.property_address}</div>\r\n                                                </td>\r\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4 text-slate-300 whitespace-nowrap\">\r\n                                                    {format(new Date(alert.end_date), 'dd MMM yyyy', { locale: fr })}\r\n                                                </td>\r\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\r\n                                                    <div className=\"flex items-center gap-2\">\r\n                                                        <span className={`w-2 h-2 rounded-full flex-shrink-0 ${alert.alert_type === 'J-180'\r\n                                                            ? 'bg-orange-500'\r\n                                                            : 'bg-blue-500'\r\n                                                            }`} />\r\n                                                        <span className=\"text-slate-300 text-xs md:text-sm whitespace-nowrap\">\r\n                                                            {alert.alert_type === 'J-180' ? 'Congé (6 mois)' : 'Reconduction (3 mois)'}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                </td>\r\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\r\n                                                    <div className=\"flex items-center gap-2 text-slate-400 text-xs md:text-sm whitespace-nowrap\">\r\n                                                        <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${alert.status === 'sent' ? 'bg-green-500' : 'bg-amber-500'\r\n                                                            }`} />\r\n                                                        {alert.status === 'sent' ? 'Envoyé' : 'En attente'}\r\n                                                    </div>\r\n                                                </td>\r\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4 text-right\">\r\n                                                    <DecisionModal alert={alert} />\r\n                                                </td>\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"px-6 py-12 text-center\">\r\n                                <CheckCircle className=\"w-12 h-12 text-green-500 mx-auto mb-3\" />\r\n                                <p className=\"text-slate-300 font-medium\">Aucune échéance dans les 6 prochains mois</p>\r\n                                <p className=\"text-slate-500 text-sm mt-1\">Tous vos baux sont à jour</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* SECTION 4 : GÉNÉRATEUR RAPIDE */}\r\n                <div id=\"tour-legal-tools\" className=\"grid gap-6 md:grid-cols-2\">\r\n                    {/* Carte Quittance */}\r\n                    <div className=\"p-6 rounded-xl border border-slate-800 bg-gradient-to-br from-slate-900 to-black hover:border-slate-700 transition-all cursor-pointer group\">\r\n                        <div className=\"h-10 w-10 rounded-lg bg-slate-800 flex items-center justify-center mb-4 group-hover:bg-slate-700 transition-colors\">\r\n                            <FileText className=\"h-5 w-5 text-white\" />\r\n                        </div>\r\n                        <h3 className=\"text-lg font-semibold text-white\">Générer une Quittance</h3>\r\n                        <p className=\"text-sm text-slate-400 mt-2\">Créer manuellement une quittance pour un paiement hors plateforme.</p>\r\n                    </div>\r\n\r\n                    {/* Carte Nouveau Bail (Interactive) */}\r\n                    <CreateContractDialog leases={leases} />\r\n                </div>\r\n\r\n                {/* Référence juridique */}\r\n                <div id=\"tour-legal-reference\" className=\"p-6 bg-slate-900 border border-slate-800 rounded-lg\">\r\n                    <h2 className=\"text-lg font-semibold text-white mb-4 flex items-center gap-2\">\r\n                        <BookOpen className=\"w-5 h-5 text-green-500\" />\r\n                        Cadre Juridique de Référence\r\n                    </h2>\r\n                    <div className=\"grid gap-4 md:grid-cols-2\">\r\n                        <div>\r\n                            <h3 className=\"text-sm font-medium text-slate-300 mb-2\">Textes applicables :</h3>\r\n                            <ul className=\"space-y-1 text-sm text-slate-400\">\r\n                                <li>• COCC (Code des Obligations Civiles et Commerciales)</li>\r\n                                <li>• Décret de 2014 sur la baisse des loyers</li>\r\n                                <li>• Loi de régulation 2024</li>\r\n                                <li>• Droit OHADA (usage commercial)</li>\r\n                            </ul>\r\n                        </div>\r\n                        <div>\r\n                            <h3 className=\"text-sm font-medium text-slate-300 mb-2\">Délais clés :</h3>\r\n                            <ul className=\"space-y-1 text-sm text-slate-400\">\r\n                                <li>• <span className=\"text-red-500 font-semibold\">6 mois</span> : Préavis propriétaire (congé pour reprise)</li>\r\n                                <li>• <span className=\"text-yellow-500 font-semibold\">3 mois</span> : Négociation avant tacite reconduction</li>\r\n                                <li>• <span className=\"text-blue-500 font-semibold\">2 mois</span> : Préavis locataire (résidentiel)</li>\r\n                                <li>• <span className=\"text-purple-500 font-semibold\">1 mois</span> : Préavis locataire (meublé)</li>\r\n                            </ul>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\alertes\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\alertes\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnimatePresence' is defined but never used.","line":6,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":13,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":4},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MapPin' is defined but never used.","line":14,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used.","line":15,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Home' is defined but never used.","line":16,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":19,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showCreateAlert' is assigned a value but never used.","line":73,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setShowCreateAlert' is assigned a value but never used.","line":73,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":45},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadAlerts' and 'loadPreferences'. Either include them or remove the dependency array.","line":91,"column":6,"nodeType":"ArrayExpression","endLine":91,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [user, authLoading, router, loadAlerts, loadPreferences]","fix":{"range":[2385,2412],"text":"[user, authLoading, router, loadAlerts, loadPreferences]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":116,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":116,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":141,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":141,"endColumn":19},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":482,"column":32,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[17704,17806],"text":"\r\n                  Alertes sur l&apos;état de vos biens déposés (approuvé, refusé, etc.)\r\n                "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[17704,17806],"text":"\r\n                  Alertes sur l&lsquo;état de vos biens déposés (approuvé, refusé, etc.)\r\n                "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[17704,17806],"text":"\r\n                  Alertes sur l&#39;état de vos biens déposés (approuvé, refusé, etc.)\r\n                "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[17704,17806],"text":"\r\n                  Alertes sur l&rsquo;état de vos biens déposés (approuvé, refusé, etc.)\r\n                "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport {\r\n  Bell,\r\n  ArrowLeft,\r\n  Settings,\r\n  Plus,\r\n  Search,\r\n  X,\r\n  MapPin,\r\n  DollarSign,\r\n  Home,\r\n  Filter,\r\n  Trash2,\r\n  Check,\r\n  ToggleLeft,\r\n  ToggleRight,\r\n} from \"lucide-react\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { useAuth } from \"@/hooks/use-auth\";\r\nimport { useNotifications } from \"@/hooks/use-notifications\";\r\nimport { NotificationBell } from \"@/components/layout/notification-bell\";\r\nimport { FadeIn } from \"@/components/ui/motion-wrapper\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\nimport { toast } from \"sonner\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\nimport { deleteSearchAlert, updateSearchAlert } from \"./actions\";\r\n\r\ninterface SearchAlert {\r\n  id: string;\r\n  user_id: string;\r\n  name: string;\r\n  filters: {\r\n    category?: \"vente\" | \"location\";\r\n    city?: string;\r\n    minPrice?: number;\r\n    maxPrice?: number;\r\n    rooms?: number;\r\n    bedrooms?: number;\r\n    type?: \"Appartement\" | \"Maison\" | \"Studio\";\r\n  };\r\n  is_active: boolean;\r\n  created_at: string;\r\n}\r\n\r\ninterface NotificationPreferences {\r\n  new_properties: boolean;\r\n  property_updates: boolean;\r\n  price_drops: boolean;\r\n  matching_alerts: boolean;\r\n}\r\n\r\nexport default function AlertesPage() {\r\n  const { user, loading: authLoading } = useAuth();\r\n  const router = useRouter();\r\n  const { notifications, unreadCount, loading: notificationsLoading } = useNotifications(user?.id || null);\r\n  const [alerts, setAlerts] = useState<SearchAlert[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [showCreateAlert, setShowCreateAlert] = useState(false);\r\n  const [preferences, setPreferences] = useState<NotificationPreferences>({\r\n    new_properties: true,\r\n    property_updates: true,\r\n    price_drops: true,\r\n    matching_alerts: true,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (authLoading) return;\r\n\r\n    if (!user) {\r\n      router.push(\"/login\");\r\n      return;\r\n    }\r\n\r\n    loadAlerts();\r\n    loadPreferences();\r\n  }, [user, authLoading, router]);\r\n\r\n  const loadAlerts = async () => {\r\n    if (!user) return;\r\n\r\n    try {\r\n      const supabase = createClient();\r\n      const { data, error } = await supabase\r\n        .from(\"search_alerts\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", user.id)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      // Si la table n'existe pas, utiliser un tableau vide (silencieux)\r\n      if (error) {\r\n        if (error.code === \"PGRST116\" || error.message?.includes(\"does not exist\")) {\r\n          setAlerts([]);\r\n          return;\r\n        }\r\n        // Erreur de permission ou autre - utiliser un tableau vide (silencieux)\r\n        setAlerts([]);\r\n        return;\r\n      }\r\n\r\n      setAlerts(data || []);\r\n    } catch (error) {\r\n      // Erreur silencieuse - utiliser un tableau vide\r\n      // Ne pas logger car c'est normal si la table n'existe pas\r\n      setAlerts([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadPreferences = async () => {\r\n    if (!user) return;\r\n\r\n    try {\r\n      const { getNotificationPreferences } = await import(\"./actions\");\r\n      const result = await getNotificationPreferences();\r\n\r\n      if (result.error) {\r\n        // Erreur silencieuse - utiliser les valeurs par défaut\r\n        return;\r\n      }\r\n\r\n      if (result.data) {\r\n        setPreferences(result.data);\r\n      }\r\n      // Sinon, les valeurs par défaut sont déjà définies\r\n    } catch (error) {\r\n      // Erreur silencieuse - utiliser les valeurs par défaut\r\n      // Ne pas logger car c'est normal si la table n'existe pas\r\n    }\r\n  };\r\n\r\n  const savePreferences = async (newPreferences: NotificationPreferences) => {\r\n    if (!user) return;\r\n\r\n    try {\r\n      const { saveNotificationPreferences } = await import(\"./actions\");\r\n      const result = await saveNotificationPreferences(newPreferences);\r\n\r\n      if (result.error) {\r\n        toast.error(\"Erreur\", {\r\n          description: result.error,\r\n        });\r\n        return;\r\n      }\r\n\r\n      setPreferences(newPreferences);\r\n      toast.success(\"Préférences mises à jour\");\r\n    } catch (error) {\r\n      console.error(\"Error saving preferences:\", error);\r\n      toast.error(\"Erreur lors de la sauvegarde des préférences\");\r\n    }\r\n  };\r\n\r\n  const togglePreference = (key: keyof NotificationPreferences) => {\r\n    const newPreferences = { ...preferences, [key]: !preferences[key] };\r\n    savePreferences(newPreferences);\r\n  };\r\n\r\n  const deleteAlert = async (alertId: string) => {\r\n    try {\r\n      const result = await deleteSearchAlert(alertId);\r\n\r\n      if (result.error) {\r\n        toast.error(\"Erreur\", {\r\n          description: result.error,\r\n        });\r\n        return;\r\n      }\r\n\r\n      setAlerts((prev) => prev.filter((a) => a.id !== alertId));\r\n      toast.success(\"Alerte supprimée\");\r\n    } catch (error) {\r\n      console.error(\"Error deleting alert:\", error);\r\n      toast.error(\"Erreur lors de la suppression de l'alerte\");\r\n    }\r\n  };\r\n\r\n  const toggleAlert = async (alert: SearchAlert) => {\r\n    try {\r\n      const result = await updateSearchAlert(alert.id, {\r\n        is_active: !alert.is_active,\r\n      });\r\n\r\n      if (result.error) {\r\n        toast.error(\"Erreur\", {\r\n          description: result.error,\r\n        });\r\n        return;\r\n      }\r\n\r\n      setAlerts((prev) =>\r\n        prev.map((a) => (a.id === alert.id ? { ...a, is_active: !a.is_active } : a))\r\n      );\r\n      toast.success(`Alerte ${!alert.is_active ? \"activée\" : \"désactivée\"}`);\r\n    } catch (error) {\r\n      console.error(\"Error toggling alert:\", error);\r\n      toast.error(\"Erreur lors de la modification de l'alerte\");\r\n    }\r\n  };\r\n\r\n  const formatAlertFilters = (filters: SearchAlert[\"filters\"]) => {\r\n    const parts: string[] = [];\r\n    if (filters.category) parts.push(filters.category === \"vente\" ? \"Achat\" : \"Location\");\r\n    if (filters.city) parts.push(filters.city);\r\n    if (filters.minPrice || filters.maxPrice) {\r\n      const priceRange = [filters.minPrice, filters.maxPrice].filter(Boolean).join(\" - \");\r\n      parts.push(`${priceRange} FCFA`);\r\n    }\r\n    if (filters.type) parts.push(filters.type);\r\n    if (filters.rooms) parts.push(`${filters.rooms} pièces`);\r\n    if (filters.bedrooms) parts.push(`${filters.bedrooms} chambres`);\r\n    return parts.join(\" • \") || \"Aucun filtre\";\r\n  };\r\n\r\n  const formatTimeAgo = (dateString: string) => {\r\n    try {\r\n      const result = formatDistanceToNow(new Date(dateString), {\r\n        addSuffix: true,\r\n      });\r\n      // Traduire les termes de base en français\r\n      return result\r\n        .replace(\"about \", \"\")\r\n        .replace(\"less than a minute ago\", \"à l'instant\")\r\n        .replace(\"minute ago\", \"minute\")\r\n        .replace(\"minutes ago\", \"minutes\")\r\n        .replace(\"hour ago\", \"heure\")\r\n        .replace(\"hours ago\", \"heures\")\r\n        .replace(\"day ago\", \"jour\")\r\n        .replace(\"days ago\", \"jours\")\r\n        .replace(\"month ago\", \"mois\")\r\n        .replace(\"months ago\", \"mois\")\r\n        .replace(\"year ago\", \"an\")\r\n        .replace(\"years ago\", \"ans\")\r\n        .replace(\" ago\", \"\");\r\n    } catch {\r\n      return \"Récemment\";\r\n    }\r\n  };\r\n\r\n  if (authLoading || loading) {\r\n    return (\r\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\r\n        <div className=\"text-white/60\">Chargement...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6 py-6\">\r\n      <FadeIn>\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <Link href=\"/compte\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                className=\"text-white/60 hover:text-white hover:bg-white/10\"\r\n              >\r\n                <ArrowLeft className=\"h-5 w-5\" />\r\n              </Button>\r\n            </Link>\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold text-white\">Mes Alertes</h1>\r\n              <p className=\"text-sm text-white/60 mt-1\">\r\n                Gérez vos notifications et alertes de recherche\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <NotificationBell userId={user.id} />\r\n        </div>\r\n\r\n        {/* Notifications récentes */}\r\n        <Card className=\"border-white/10 bg-white/5 backdrop-blur-sm\">\r\n          <CardHeader>\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle className=\"text-white\">Notifications récentes</CardTitle>\r\n                <CardDescription className=\"text-white/60\">\r\n                  {unreadCount > 0 ? `${unreadCount} non lue${unreadCount > 1 ? \"s\" : \"\"}` : \"Aucune nouvelle notification\"}\r\n                </CardDescription>\r\n              </div>\r\n              {notifications.length > 0 && (\r\n                <Link href=\"/compte/alertes#notifications\">\r\n                  <Button variant=\"outline\" size=\"sm\" className=\"text-white border-white/20 hover:bg-white/10\">\r\n                    Voir tout\r\n                  </Button>\r\n                </Link>\r\n              )}\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {notificationsLoading ? (\r\n              <div className=\"flex items-center justify-center py-8\">\r\n                <div className=\"h-6 w-6 animate-spin rounded-full border-2 border-white/20 border-t-white\" />\r\n              </div>\r\n            ) : notifications.length === 0 ? (\r\n              <div className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n                <Bell className=\"h-12 w-12 text-white/20 mb-4\" />\r\n                <p className=\"text-white/60\">Aucune notification</p>\r\n                <p className=\"text-sm text-white/40 mt-2\">\r\n                  Vous serez notifié quand de nouveaux biens correspondent à vos critères\r\n                </p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-3\">\r\n                {notifications.slice(0, 3).map((notification) => (\r\n                  <div\r\n                    key={notification.id}\r\n                    className={`rounded-lg border p-3 transition-colors ${\r\n                      !notification.is_read\r\n                        ? \"border-white/20 bg-white/5\"\r\n                        : \"border-white/10 bg-white/5 opacity-60\"\r\n                    }`}\r\n                  >\r\n                    <div className=\"flex items-start justify-between\">\r\n                      <div className=\"flex-1\">\r\n                        <p className={`text-sm font-medium ${!notification.is_read ? \"text-white\" : \"text-white/70\"}`}>\r\n                          {notification.title}\r\n                        </p>\r\n                        <p className=\"text-xs text-white/60 mt-1 line-clamp-2\">\r\n                          {notification.message}\r\n                        </p>\r\n                        <p className=\"text-xs text-white/40 mt-2\">\r\n                          {formatTimeAgo(notification.created_at)}\r\n                        </p>\r\n                      </div>\r\n                      {!notification.is_read && (\r\n                        <div className=\"h-2 w-2 rounded-full bg-amber-500 ml-3 mt-1\" />\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Alertes de recherche */}\r\n        <Card className=\"border-white/10 bg-white/5 backdrop-blur-sm\">\r\n          <CardHeader>\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle className=\"text-white\">Alertes de recherche</CardTitle>\r\n                <CardDescription className=\"text-white/60\">\r\n                  Créez des alertes pour être notifié des nouveaux biens correspondant à vos critères\r\n                </CardDescription>\r\n              </div>\r\n              <Button\r\n                onClick={() => {\r\n                  router.push(\"/recherche?alert=create\");\r\n                }}\r\n                className=\"bg-background text-foreground hover:bg-background/90\"\r\n              >\r\n                <Plus className=\"h-4 w-4 mr-2\" />\r\n                Nouvelle alerte\r\n              </Button>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {alerts.length === 0 ? (\r\n              <div className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n                <Search className=\"h-12 w-12 text-white/20 mb-4\" />\r\n                <p className=\"text-white/60\">Aucune alerte de recherche</p>\r\n                <p className=\"text-sm text-white/40 mt-2\">\r\n                  Créez une alerte pour être notifié automatiquement des nouveaux biens\r\n                </p>\r\n                <Button\r\n                  onClick={() => router.push(\"/recherche?alert=create\")}\r\n                  className=\"mt-4 bg-background text-foreground hover:bg-background/90\"\r\n                >\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Créer ma première alerte\r\n                </Button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-3\">\r\n                {alerts.map((alert) => (\r\n                  <motion.div\r\n                    key={alert.id}\r\n                    initial={{ opacity: 0, y: 10 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    className=\"rounded-lg border border-white/10 bg-white/5 p-4\"\r\n                  >\r\n                    <div className=\"flex items-start justify-between\">\r\n                      <div className=\"flex-1\">\r\n                        <div className=\"flex items-center gap-2 mb-2\">\r\n                          <h4 className=\"font-semibold text-white\">{alert.name}</h4>\r\n                          <Badge\r\n                            variant={alert.is_active ? \"default\" : \"secondary\"}\r\n                            className={alert.is_active ? \"bg-amber-500 text-black\" : \"bg-white/10 text-white/60\"}\r\n                          >\r\n                            {alert.is_active ? \"Active\" : \"Inactive\"}\r\n                          </Badge>\r\n                        </div>\r\n                        <div className=\"flex flex-wrap items-center gap-2 text-sm text-white/60 mb-3\">\r\n                          <Filter className=\"h-4 w-4\" />\r\n                          <span>{formatAlertFilters(alert.filters)}</span>\r\n                        </div>\r\n                        <p className=\"text-xs text-white/40\">\r\n                          Créée {formatTimeAgo(alert.created_at)}\r\n                        </p>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-2 ml-4\">\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          onClick={() => toggleAlert(alert)}\r\n                          className=\"text-white/60 hover:text-white hover:bg-white/10\"\r\n                        >\r\n                          {alert.is_active ? (\r\n                            <ToggleRight className=\"h-5 w-5\" />\r\n                          ) : (\r\n                            <ToggleLeft className=\"h-5 w-5\" />\r\n                          )}\r\n                        </Button>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          onClick={() => deleteAlert(alert.id)}\r\n                          className=\"text-red-400/60 hover:text-red-400 hover:bg-red-400/10\"\r\n                        >\r\n                          <Trash2 className=\"h-4 w-4\" />\r\n                        </Button>\r\n                      </div>\r\n                    </div>\r\n                  </motion.div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Paramètres d'alertes */}\r\n        <Card className=\"border-white/10 bg-white/5 backdrop-blur-sm\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-white flex items-center gap-2\">\r\n              <Settings className=\"h-5 w-5\" />\r\n              Paramètres de notifications\r\n            </CardTitle>\r\n            <CardDescription className=\"text-white/60\">\r\n              Configurez vos préférences de notifications\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-4\">\r\n            <div className=\"flex items-center justify-between rounded-lg border border-white/10 bg-white/5 p-4\">\r\n              <div className=\"flex-1\">\r\n                <p className=\"text-sm font-medium text-white\">Nouveaux biens</p>\r\n                <p className=\"text-xs text-white/60 mt-1\">\r\n                  Recevez une notification pour chaque nouveau bien publié\r\n                </p>\r\n              </div>\r\n              <Switch\r\n                checked={preferences.new_properties}\r\n                onCheckedChange={() => togglePreference(\"new_properties\")}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex items-center justify-between rounded-lg border border-white/10 bg-white/5 p-4\">\r\n              <div className=\"flex-1\">\r\n                <p className=\"text-sm font-medium text-white\">Mises à jour de vos annonces</p>\r\n                <p className=\"text-xs text-white/60 mt-1\">\r\n                  Alertes sur l'état de vos biens déposés (approuvé, refusé, etc.)\r\n                </p>\r\n              </div>\r\n              <Switch\r\n                checked={preferences.property_updates}\r\n                onCheckedChange={() => togglePreference(\"property_updates\")}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex items-center justify-between rounded-lg border border-white/10 bg-white/5 p-4\">\r\n              <div className=\"flex-1\">\r\n                <p className=\"text-sm font-medium text-white\">Baisse de prix</p>\r\n                <p className=\"text-xs text-white/60 mt-1\">\r\n                  Soyez notifié quand un bien de vos favoris baisse de prix\r\n                </p>\r\n              </div>\r\n              <Switch\r\n                checked={preferences.price_drops}\r\n                onCheckedChange={() => togglePreference(\"price_drops\")}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex items-center justify-between rounded-lg border border-white/10 bg-white/5 p-4\">\r\n              <div className=\"flex-1\">\r\n                <p className=\"text-sm font-medium text-white\">Alertes de recherche</p>\r\n                <p className=\"text-xs text-white/60 mt-1\">\r\n                  Notifications quand de nouveaux biens correspondent à vos alertes de recherche\r\n                </p>\r\n              </div>\r\n              <Switch\r\n                checked={preferences.matching_alerts}\r\n                onCheckedChange={() => togglePreference(\"matching_alerts\")}\r\n              />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </FadeIn>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\biens\\[id]\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperty'. Either include it or remove the dependency array.","line":75,"column":6,"nodeType":"ArrayExpression","endLine":75,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [user, authLoading, loadProperty]","fix":{"range":[2564,2583],"text":"[user, authLoading, loadProperty]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperty'. Either include it or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [user, authLoading, propertyId, loadProperty]","fix":{"range":[2039,2070],"text":"[user, authLoading, propertyId, loadProperty]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { useRouter, useParams } from \"next/navigation\";\nimport Link from \"next/link\";\nimport Image from \"next/image\";\nimport { ArrowLeft, AlertCircle, CheckCircle2, Clock } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { motion } from \"framer-motion\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport { VerificationUploadForm } from \"@/components/dashboard/verification-upload-form\";\nimport { VerificationStatusBadge } from \"@/components/dashboard/verification-status-badge\";\nimport type { Property } from \"@/types/property\";\n\ntype PropertyWithVerification = Property & {\n  verification_status: \"pending\" | \"verified\" | \"rejected\" | null;\n  proof_document_url?: string | null;\n  verification_rejection_reason?: string | null;\n  verification_requested_at?: string | null;\n};\n\nexport default function PropertyDetailPage() {\n  const router = useRouter();\n  const params = useParams();\n  const propertyId = params.id as string;\n  const { user, loading: authLoading } = useAuth();\n  const [loading, setLoading] = useState(true);\n  const [property, setProperty] = useState<PropertyWithVerification | null>(null);\n\n  const loadProperty = async () => {\n    if (!user || !propertyId) return;\n\n    const supabase = createClient();\n    const { data, error } = await supabase\n      .from(\"properties\")\n      .select(\"*\")\n      .eq(\"id\", propertyId)\n      .eq(\"owner_id\", user.id)\n      .single();\n\n    if (error || !data) {\n      toast.error(\"Bien introuvable ou accès non autorisé\");\n      router.push(\"/compte/mes-biens\");\n      return;\n    }\n\n    setProperty(data as PropertyWithVerification);\n    setLoading(false);\n  };\n\n  useEffect(() => {\n    if (user && !authLoading) {\n      loadProperty();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [user, authLoading, propertyId]);\n\n  // Recharger la page après une soumission réussie\n  // On utilise un listener pour détecter les changements de route\n  useEffect(() => {\n    const handleFocus = () => {\n      // Recharger les données quand la fenêtre redevient active\n      // (utile après une redirection ou un refresh)\n      if (user && !authLoading) {\n        loadProperty();\n      }\n    };\n    \n    window.addEventListener(\"focus\", handleFocus);\n    return () => window.removeEventListener(\"focus\", handleFocus);\n  }, [user, authLoading]);\n\n  if (authLoading || loading) {\n    return (\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\n        <div className=\"text-white/70\">Chargement...</div>\n      </div>\n    );\n  }\n\n  if (!property) {\n    return null;\n  }\n\n  const verificationStatus = property.verification_status || null;\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat(\"fr-FR\", {\n      maximumFractionDigits: 0,\n    }).format(price);\n  };\n\n  return (\n    <div className=\"space-y-6 pb-10\">\n      {/* Header avec bouton retour */}\n      <div className=\"flex items-center justify-between\">\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={() => router.push(\"/compte/mes-biens\")}\n          className=\"text-white/70 hover:text-white\"\n        >\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Retour à mes biens\n        </Button>\n        <Link href={`/compte/biens/edit/${propertyId}`}>\n          <Button variant=\"secondary\" size=\"sm\">\n            Modifier\n          </Button>\n        </Link>\n      </div>\n\n      {/* Titre du bien */}\n      <div>\n        <h1 className=\"text-3xl font-semibold text-white\">{property.title}</h1>\n        <p className=\"mt-2 text-lg text-white/70\">\n          {formatPrice(property.price)} FCFA\n        </p>\n      </div>\n\n      {/* Image principale */}\n      {property.images && property.images[0] && (\n        <div className=\"relative h-[400px] w-full overflow-hidden rounded-2xl\">\n          <Image\n            src={property.images[0]}\n            alt={property.title}\n            fill\n            className=\"object-cover\"\n            sizes=\"(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px\"\n            priority\n          />\n        </div>\n      )}\n\n      {/* Informations principales */}\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <CardTitle className=\"text-white\">Informations principales</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm text-white/60\">Type</p>\n              <p className=\"text-white\">{property.details?.type || \"Non spécifié\"}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-white/60\">Surface</p>\n              <p className=\"text-white\">{property.specs?.surface} m²</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-white/60\">Pièces</p>\n              <p className=\"text-white\">\n                {property.specs?.rooms} pièce{property.specs?.rooms && property.specs.rooms > 1 ? \"s\" : \"\"}\n                {property.specs?.bedrooms && ` • ${property.specs.bedrooms} chambre${property.specs.bedrooms > 1 ? \"s\" : \"\"}`}\n              </p>\n            </div>\n            <div>\n              <p className=\"text-sm text-white/60\">Localisation</p>\n              <p className=\"text-white\">\n                {property.location.city}\n                {property.location.address && `, ${property.location.address}`}\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <CardTitle className=\"text-white\">Statut de publication</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm text-white/60\">Statut</p>\n              <p className=\"text-white capitalize\">\n                {property.status || \"disponible\"}\n              </p>\n            </div>\n            <div>\n              <p className=\"text-sm text-white/60\">Transaction</p>\n              <p className=\"text-white capitalize\">{property.transaction}</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Section Vérification du Bien */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.3 }}\n      >\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <CardTitle className=\"text-white\">Vérification du bien</CardTitle>\n                <CardDescription className=\"text-white/60\">\n                  Certifiez votre bien pour plus de visibilité\n                </CardDescription>\n              </div>\n              {verificationStatus && (\n                <VerificationStatusBadge status={verificationStatus} />\n              )}\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Statut: verified */}\n            {verificationStatus === \"verified\" && (\n              <div className=\"flex items-start gap-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20 p-4\">\n                <CheckCircle2 className=\"h-5 w-5 text-emerald-400 mt-0.5 flex-shrink-0\" />\n                <div className=\"flex-1\">\n                  <p className=\"font-medium text-emerald-300\">\n                    Votre bien est vérifié et certifié\n                  </p>\n                  <p className=\"mt-1 text-sm text-emerald-200/80\">\n                    Votre bien est certifié et mis en avant sur la plateforme. Les utilisateurs\n                    peuvent faire confiance à votre annonce.\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {/* Statut: pending */}\n            {verificationStatus === \"pending\" && (\n              <div className=\"flex items-start gap-3 rounded-lg bg-amber-500/10 border border-amber-500/20 p-4\">\n                <Clock className=\"h-5 w-5 text-amber-400 mt-0.5 flex-shrink-0\" />\n                <div className=\"flex-1\">\n                  <p className=\"font-medium text-amber-300\">\n                    Vérification en cours\n                  </p>\n                  <p className=\"mt-1 text-sm text-amber-200/80\">\n                    Nos équipes analysent votre document. Vous serez notifié dès que la vérification\n                    sera terminée.\n                  </p>\n                  {property.verification_requested_at && (\n                    <p className=\"mt-2 text-xs text-amber-200/60\">\n                      Demande soumise le{\" \"}\n                      {new Date(property.verification_requested_at).toLocaleDateString(\"fr-FR\", {\n                        day: \"numeric\",\n                        month: \"long\",\n                        year: \"numeric\",\n                        hour: \"2-digit\",\n                        minute: \"2-digit\",\n                      })}\n                    </p>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {/* Statut: rejected */}\n            {verificationStatus === \"rejected\" && (\n              <div className=\"flex items-start gap-3 rounded-lg bg-red-500/10 border border-red-500/20 p-4\">\n                <AlertCircle className=\"h-5 w-5 text-red-400 mt-0.5 flex-shrink-0\" />\n                <div className=\"flex-1\">\n                  <p className=\"font-medium text-red-300\">\n                    Vérification refusée\n                  </p>\n                  {property.verification_rejection_reason && (\n                    <p className=\"mt-2 text-sm text-red-200/90 bg-red-500/10 rounded-lg p-3 border border-red-500/20\">\n                      <span className=\"font-medium\">Raison :</span> {property.verification_rejection_reason}\n                    </p>\n                  )}\n                  <p className=\"mt-2 text-sm text-red-200/80\">\n                    Vous pouvez soumettre un nouveau document pour relancer la vérification.\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {/* Statut: null (aucune vérification) */}\n            {verificationStatus === null && (\n              <div className=\"rounded-lg bg-white/5 border border-white/10 p-4\">\n                <p className=\"text-sm text-white/70\">\n                  Soumettez un document de preuve de propriété pour certifier votre bien. Les biens\n                  vérifiés bénéficient d&apos;une meilleure visibilité et de la confiance des utilisateurs.\n                </p>\n              </div>\n            )}\n\n            {/* Formulaire d'upload - Affiché uniquement si verified, rejected ou null */}\n            {(verificationStatus === null || verificationStatus === \"rejected\") && (\n              <div className=\"mt-4\">\n                <VerificationUploadForm\n                  propertyId={property.id}\n                  currentStatus={verificationStatus}\n                  proofDocumentUrl={property.proof_document_url}\n                />\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Description */}\n      {property.description && (\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <CardTitle className=\"text-white\">Description</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-white/80 whitespace-pre-line\">{property.description}</p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\biens\\edit\\[id]\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\biens\\edit\\[id]\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":479,"column":17,"nodeType":"JSXOpeningElement","endLine":483,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\components\\GestionLocativeWidget.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowRight' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ArrowRight, Building2, Clock, AlertCircle, CheckCircle } from 'lucide-react';\r\nimport Link from 'next/link';\r\n\r\ninterface GestionLocativeWidgetProps {\r\n    activeLeases?: number;\r\n    pendingPayments?: number;\r\n    maintenanceRequests?: number;\r\n    financials?: {\r\n        total: number;\r\n        collected: number;\r\n        percent: number;\r\n    };\r\n}\r\n\r\nexport function GestionLocativeWidget({\r\n    activeLeases = 3,\r\n    pendingPayments = 2,\r\n    maintenanceRequests = 1,\r\n    financials = { total: 0, collected: 0, percent: 0 }\r\n}: GestionLocativeWidgetProps) {\r\n    // Format current month (e.g., \"Décembre\")\r\n    const currentMonthName = new Date().toLocaleString('fr-FR', { month: 'long' });\r\n    const monthLabel = currentMonthName.charAt(0).toUpperCase() + currentMonthName.slice(1);\r\n\r\n    return (\r\n        <div className=\"group relative overflow-hidden rounded-xl border border-slate-800 bg-slate-900/50 hover:bg-slate-900 transition-all duration-300 mb-8\">\r\n\r\n            {/* 1. HEADER : Titre + Badge Premium */}\r\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-800/50\">\r\n                <div className=\"space-y-0.5\">\r\n                    <h3 className=\"text-lg font-semibold text-white flex items-center gap-2\">\r\n                        Gestion Locative\r\n                    </h3>\r\n                    <p className=\"text-xs text-slate-400\">\r\n                        Automatisez vos revenus fonciers.\r\n                    </p>\r\n                </div>\r\n\r\n                {/* Badge Premium Style \"Linear\" */}\r\n                <div className=\"flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-500/10 border border-yellow-500/20\">\r\n                    <div className=\"w-1.5 h-1.5 rounded-full bg-yellow-400 animate-pulse\" />\r\n                    <span className=\"text-[10px] font-medium text-yellow-500 uppercase tracking-wider\">Premium</span>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 2. BODY : Les Métriques (Grid) */}\r\n            <div className=\"grid grid-cols-3 divide-x divide-slate-800/50\">\r\n\r\n                {/* KPI 1 : Baux Actifs */}\r\n                <Link href=\"/compte/gestion-locative\" className=\"p-2 flex flex-col items-center justify-center text-center gap-2 hover:bg-slate-800/30 transition-colors cursor-pointer\">\r\n                    <div className=\"p-2 rounded-lg bg-blue-500/10 text-blue-400\">\r\n                        <Building2 className=\"w-4 h-4\" />\r\n                    </div>\r\n                    <div>\r\n                        <span className=\"text-xl font-mono font-bold text-white\">{activeLeases}</span>\r\n                        <p className=\"text-[10px] text-slate-500 font-medium uppercase tracking-wide mt-1\">Baux Actifs</p>\r\n                    </div>\r\n                </Link>\r\n\r\n                {/* KPI 2 : En Attente (Dynamic Color) */}\r\n                <Link href=\"/compte/gestion-locative\" className=\"p-2 flex flex-col items-center justify-center text-center gap-2 hover:bg-slate-800/30 transition-colors cursor-pointer\">\r\n                    <div className={`p-2 rounded-lg ${pendingPayments > 0 ? 'bg-orange-500/10 text-orange-400' : 'bg-emerald-500/10 text-emerald-400'}`}>\r\n                        {pendingPayments > 0 ? <Clock className=\"w-4 h-4\" /> : <CheckCircle className=\"w-4 h-4\" />}\r\n                    </div>\r\n                    <div>\r\n                        <span className={`text-xl font-mono font-bold ${pendingPayments > 0 ? 'text-white' : 'text-emerald-400'}`}>\r\n                            {pendingPayments}\r\n                        </span>\r\n                        <p className=\"text-[10px] text-slate-500 font-medium uppercase tracking-wide mt-1\">\r\n                            {pendingPayments === 0 ? 'Retard' : 'En attente'}\r\n                        </p>\r\n                    </div>\r\n                </Link>\r\n\r\n                {/* KPI 3 : Pannes (Rouge) */}\r\n                <Link href=\"/compte/gestion-locative\" className=\"p-2 flex flex-col items-center justify-center text-center gap-2 hover:bg-slate-800/30 transition-colors cursor-pointer\">\r\n                    <div className=\"p-2 rounded-lg bg-red-500/10 text-red-400\">\r\n                        <AlertCircle className=\"w-4 h-4\" />\r\n                    </div>\r\n                    <div>\r\n                        <span className=\"text-xl font-mono font-bold text-white\">{maintenanceRequests}</span>\r\n                        <p className=\"text-[10px] text-slate-500 font-medium uppercase tracking-wide mt-1\">Pannes</p>\r\n                    </div>\r\n                </Link>\r\n\r\n            </div>\r\n\r\n            {/* 3. FOOTER : Section Financière (Remplacement du simple lien) */}\r\n            <Link href=\"/compte/gestion-locative\" className=\"block border-t border-slate-800 bg-slate-900/30 p-4 hover:bg-slate-800/50 transition-colors\">\r\n                <div className=\"flex items-center justify-between text-sm mb-2\">\r\n                    <span className=\"text-slate-400 text-xs\">Revenus de {monthLabel}</span>\r\n                    <span className=\"text-white font-mono font-medium text-xs\">\r\n                        {financials.percent}% <span className=\"text-slate-500 text-[10px]\">encaissé</span>\r\n                    </span>\r\n                </div>\r\n\r\n                {/* Barre de progression */}\r\n                <div className=\"h-1.5 w-full bg-slate-800 rounded-full overflow-hidden\">\r\n                    <div\r\n                        className=\"h-full bg-emerald-500 transition-all duration-500 ease-out\"\r\n                        style={{ width: `${financials.percent}%` }}\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"flex justify-between mt-2 text-[10px] font-mono\">\r\n                    <div className=\"text-emerald-400 font-medium\">\r\n                        + {financials.collected.toLocaleString()} FCFA\r\n                    </div>\r\n                    <div className=\"text-slate-500\">\r\n                        Obj: {financials.total.toLocaleString()} FCFA\r\n                    </div>\r\n                </div>\r\n            </Link>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\components\\LegalAssistantWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\deposer\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\deposer\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'quartiers' is assigned a value but never used.","line":130,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":130,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":208,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":208,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7476,7479],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7476,7479],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":216,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":216,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7673,7676],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7673,7676],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":274,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":274,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'getValues', 'isCharacteristicsValid', 'isDescriptionValid', 'isEssentialsValid', and 'isLocationValid'. Either include them or remove the dependency array.","line":314,"column":6,"nodeType":"ArrayExpression","endLine":314,"endColumn":326,"suggestions":[{"desc":"Update the dependencies array to be: [imageUrls, activeSection, step, completedSections, submitting, getValues, isEssentialsValid, isLocationValid, isCharacteristicsValid, isDescriptionValid]","fix":{"range":[11616,11936],"text":"[imageUrls, activeSection, step, completedSections, submitting, getValues, isEssentialsValid, isLocationValid, isCharacteristicsValid, isDescriptionValid]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":7,"nodeType":"CallExpression","endLine":314,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":22,"nodeType":"CallExpression","endLine":314,"endColumn":39},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":41,"nodeType":"CallExpression","endLine":314,"endColumn":55},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":57,"nodeType":"CallExpression","endLine":314,"endColumn":71},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":73,"nodeType":"CallExpression","endLine":314,"endColumn":86},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":88,"nodeType":"CallExpression","endLine":314,"endColumn":105},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":107,"nodeType":"CallExpression","endLine":314,"endColumn":123},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":125,"nodeType":"CallExpression","endLine":314,"endColumn":141},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":143,"nodeType":"CallExpression","endLine":314,"endColumn":165},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":167,"nodeType":"CallExpression","endLine":314,"endColumn":185},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":187,"nodeType":"CallExpression","endLine":314,"endColumn":201},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":203,"nodeType":"CallExpression","endLine":314,"endColumn":220},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":222,"nodeType":"CallExpression","endLine":314,"endColumn":240},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":314,"column":242,"nodeType":"CallExpression","endLine":314,"endColumn":262}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":1402,"column":27,"nodeType":"JSXOpeningElement","endLine":1406,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":2,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, Suspense } from \"react\";\nimport { useRouter, usePathname, useSearchParams } from \"next/navigation\";\nimport { useForm, Controller } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { toast } from \"sonner\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { ArrowLeft, ArrowRight, Check, Home, Building2, Mountain, Store, X } from \"lucide-react\";\nimport { InfoTooltip } from \"@/components/ui/info-tooltip\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { PhoneInput } from \"@/components/ui/phone-input\";\nimport { AddressInputWithMap } from \"@/components/forms/address-input-with-map\";\nimport { DocumentSelector } from \"@/components/document/document-selector\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { submitUserListing } from \"@/app/compte/deposer/actions\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport Link from \"next/link\";\n\n// Schéma de validation complet\nconst depositSchema = z\n  .object({\n    type: z.enum([\"villa\", \"appartement\", \"terrain\", \"immeuble\"]),\n    title: z.string().min(3, \"Le titre doit contenir au moins 3 caractères\"),\n    description: z.string().min(10, \"La description doit contenir au moins 10 caractères\"),\n    price: z.preprocess(\n      (val) => {\n        if (val === \"\" || val === null || val === undefined) return undefined;\n        const num = Number(val);\n        return isNaN(num) ? undefined : num;\n      },\n      z.number().min(1, \"Le prix doit être supérieur à 0\")\n    ),\n    category: z.enum([\"vente\", \"location\"]),\n    city: z.string().min(1, \"La région est requise\"),\n    district: z.string().min(1, \"Le quartier est requis\"),\n    address: z.string().min(3, \"L'adresse est requise\"),\n    landmark: z.string().optional().or(z.literal(\"\")),\n\n    surface: z.preprocess(\n      (val) => (typeof val === \"number\" && isNaN(val) ? undefined : val),\n      z.number().optional()\n    ),\n    surfaceTotale: z.preprocess(\n      (val) => (typeof val === \"number\" && isNaN(val) ? undefined : val),\n      z.number().optional()\n    ),\n    juridique: z.string().optional().refine(\n      (val) => !val || val === \"\" || [\"titre-foncier\", \"bail\", \"deliberation\", \"nicad\"].includes(val),\n      { message: \"Situation juridique invalide\" }\n    ),\n    rooms: z.preprocess(\n      (val) => (typeof val === \"number\" && isNaN(val) ? undefined : val),\n      z.number().optional()\n    ),\n    bedrooms: z.preprocess(\n      (val) => (typeof val === \"number\" && isNaN(val) ? undefined : val),\n      z.number().optional()\n    ),\n    bathrooms: z.preprocess(\n      (val) => (typeof val === \"number\" && isNaN(val) ? undefined : val),\n      z.number().optional()\n    ),\n\n    service_type: z.enum([\"mandat_confort\", \"boost_visibilite\"]),\n    payment_ref: z.string().optional(),\n    contact_phone: z.string().optional(),\n  })\n  .superRefine((data, ctx) => {\n    const isTerrain = data.type === \"terrain\";\n\n    if (isTerrain) {\n      if (!data.surfaceTotale || data.surfaceTotale < 10) {\n        ctx.addIssue({\n          code: z.ZodIssueCode.custom,\n          message: \"La surface totale est requise (min 10 m²)\",\n          path: [\"surfaceTotale\"],\n        });\n      }\n      if (!data.juridique) {\n        ctx.addIssue({\n          code: z.ZodIssueCode.custom,\n          message: \"La situation juridique est requise pour un terrain\",\n          path: [\"juridique\"],\n        });\n      }\n    } else {\n      if (!data.surface || data.surface < 10) {\n        ctx.addIssue({\n          code: z.ZodIssueCode.custom,\n          message: \"La surface habitable est requise (min 10 m²)\",\n          path: [\"surface\"],\n        });\n      }\n      if (!data.rooms || data.rooms < 1) {\n        ctx.addIssue({\n          code: z.ZodIssueCode.custom,\n          message: \"Le nombre de pièces est requis\",\n          path: [\"rooms\"],\n        });\n      }\n      // Bedrooms et bathrooms peuvent être 0 (studio)\n      if (data.bedrooms === undefined || data.bedrooms < 0) {\n        ctx.addIssue({\n          code: z.ZodIssueCode.custom,\n          message: \"Le nombre de chambres est requis\",\n          path: [\"bedrooms\"],\n        });\n      }\n      if (data.bathrooms === undefined || data.bathrooms < 0) {\n        ctx.addIssue({\n          code: z.ZodIssueCode.custom,\n          message: \"Le nombre de salles de bain est requis\",\n          path: [\"bathrooms\"],\n        });\n      }\n    }\n  });\n\n\nimport { smartGeocode } from \"@/lib/geocoding\";\n\n// Dériver le type directement du schéma Zod pour éviter les incohérences\ntype DepositFormValues = z.infer<typeof depositSchema>;\n\nconst quartiers = [\n  \"Almadies\",\n  \"Plateau\",\n  \"Mermoz\",\n  \"Yoff\",\n  \"Ngor\",\n  \"Ouakam\",\n  \"Sacré-Cœur\",\n  \"Les Mamelles\",\n];\n\nconst situationsJuridiques = [\n  { value: \"titre-foncier\", label: \"Titre Foncier\" },\n  { value: \"bail\", label: \"Bail\" },\n  { value: \"deliberation\", label: \"Délibération\" },\n  { value: \"nicad\", label: \"Nicad\" },\n];\n\nconst typesBien = [\n  { value: \"villa\", label: \"Villa\", icon: Home },\n  { value: \"appartement\", label: \"Appartement\", icon: Building2 },\n  { value: \"terrain\", label: \"Terrain\", icon: Mountain },\n  { value: \"immeuble\", label: \"Immeuble / Commercial\", icon: Store },\n];\n\nfunction DeposerPageContent() {\n  const router = useRouter();\n  const pathname = usePathname();\n  const searchParams = useSearchParams();\n  const { user, loading } = useAuth();\n\n  const [step, setStep] = useState(1);\n  const [imageUrls, setImageUrls] = useState<string[]>([]);\n  const [submitting, setSubmitting] = useState(false);\n  const [uploading, setUploading] = useState(false);\n  const [services, setServices] = useState<{ code: string; name: string; price: number; description: string }[]>([]);\n  const [proofUrl, setProofUrl] = useState<string | null>(null);\n  const [proofDocumentId, setProofDocumentId] = useState<string | null>(null);\n  const [formSaving, setFormSaving] = useState(false);\n\n  // États accordéon intelligent\n  const [activeSection, setActiveSection] = useState<string>(\"essentials\");\n  const [completedSections, setCompletedSections] = useState<string[]>([]);\n\n  // Charger les services depuis la base de données\n  useEffect(() => {\n    const fetchServices = async () => {\n      const supabase = createClient();\n      const { data, error } = await supabase.from(\"services\").select(\"*\");\n      if (error) {\n        console.error(\"Erreur chargement services:\", error);\n        toast.error(\"Impossible de charger les offres\");\n      } else if (data) {\n        setServices(data);\n      }\n    };\n    fetchServices();\n  }, []);\n\n  // Coordonnées sélectionnées manuellement sur la carte\n  const [manualCoordinates, setManualCoordinates] = useState<{ lat: number; lng: number } | null>(null);\n\n  // États Paiement - FLUX STRICT\n  const [paymentToken, setPaymentToken] = useState<string | null>(null);\n  const [paymentVerification, setPaymentVerification] = useState<\"idle\" | \"checking\" | \"success\" | \"error\">(\"idle\");\n  const [paymentMessage, setPaymentMessage] = useState<string | null>(null);\n  // État persistant pour éviter le flash du formulaire pendant la soumission\n  const [isPaymentConfirmed, setIsPaymentConfirmed] = useState(false);\n\n  const {\n    register,\n    watch,\n    getValues,\n    setValue,\n    trigger,\n    control,\n    formState: { errors },\n  } = useForm<DepositFormValues>({\n    resolver: zodResolver(depositSchema) as any,\n    mode: \"onChange\",\n    defaultValues: {\n      type: \"appartement\",\n      category: \"vente\",\n      service_type: \"mandat_confort\",\n      title: \"\",\n      description: \"\",\n      price: \"\" as any,\n      city: \"\",\n      district: \"\",\n      address: \"\",\n      landmark: \"\",\n      surface: undefined,\n      surfaceTotale: undefined,\n      rooms: undefined,\n      bedrooms: undefined,\n      bathrooms: undefined,\n      juridique: \"\",\n    },\n  });\n\n  // Pré-remplir le téléphone avec celui du profil utilisateur (une fois que user est chargé)\n  useEffect(() => {\n    if (user?.user_metadata?.phone && !getValues(\"contact_phone\")) {\n      // Seulement si le champ est vide (pas de données sauvegardées)\n      setValue(\"contact_phone\", user.user_metadata.phone);\n    }\n  }, [user, setValue, getValues]);\n\n  const serviceType = watch(\"service_type\");\n  const category = watch(\"category\");\n  const type = watch(\"type\");\n  const isTerrain = type === \"terrain\";\n  const needsPayment = serviceType === \"boost_visibilite\";\n\n  // Fonctions de validation par section\n  const isEssentialsValid = () => {\n    const data = getValues();\n    return !!(data.type && data.category && data.title && data.title.length >= 3 && data.price && data.price > 0);\n  };\n\n  const isLocationValid = () => {\n    const data = getValues();\n    return !!(data.city && data.city.length >= 1 && data.district && data.district.length >= 1 && data.address && data.address.length >= 3);\n  };\n\n  const isCharacteristicsValid = () => {\n    const data = getValues();\n    if (data.type === \"terrain\") {\n      return !!(data.surfaceTotale && data.surfaceTotale >= 10 && data.juridique);\n    } else {\n      return !!(data.surface && data.surface >= 10 && data.rooms && data.rooms >= 1 && data.bedrooms !== undefined && data.bedrooms >= 0 && data.bathrooms !== undefined && data.bathrooms >= 0);\n    }\n  };\n\n  const isDescriptionValid = () => {\n    const data = getValues();\n    return !!(data.description && data.description.length >= 10 && imageUrls.length > 0);\n  };\n\n  // Logique d'auto-expansion intelligente avec debounce\n  useEffect(() => {\n    // Ne pas exécuter pendant la soumission pour éviter les flash backs\n    if (step !== 1 || submitting) return;\n\n    const data = getValues();\n\n    // Marquer les sections comme complétées\n    if (isEssentialsValid() && !completedSections.includes(\"essentials\")) {\n      setCompletedSections((prev) => [...prev, \"essentials\"]);\n    }\n    if (isLocationValid() && !completedSections.includes(\"location\")) {\n      setCompletedSections((prev) => [...prev, \"location\"]);\n    }\n    if (isCharacteristicsValid() && !completedSections.includes(\"characteristics\")) {\n      setCompletedSections((prev) => [...prev, \"characteristics\"]);\n    }\n    if (isDescriptionValid() && !completedSections.includes(\"description\")) {\n      setCompletedSections((prev) => [...prev, \"description\"]);\n    }\n\n    // Auto-expansion avec délai de 1.5s pour laisser l'utilisateur finir de taper\n    const autoExpandTimer = setTimeout(() => {\n      if (isEssentialsValid() && activeSection === \"essentials\" && !completedSections.includes(\"essentials\")) {\n        setActiveSection(\"location\");\n        const element = document.getElementById(\"section-location\");\n        if (element) {\n          element.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n        }\n      } else if (isLocationValid() && activeSection === \"location\" && !completedSections.includes(\"location\")) {\n        setActiveSection(\"characteristics\");\n        const element = document.getElementById(\"section-characteristics\");\n        if (element) {\n          element.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n        }\n      } else if (isCharacteristicsValid() && activeSection === \"characteristics\" && !completedSections.includes(\"characteristics\")) {\n        setActiveSection(\"description\");\n        const element = document.getElementById(\"section-description\");\n        if (element) {\n          element.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n        }\n      }\n    }, 1500); // 1.5 secondes de délai\n\n    return () => clearTimeout(autoExpandTimer);\n  }, [watch(\"type\"), watch(\"category\"), watch(\"title\"), watch(\"price\"), watch(\"city\"), watch(\"district\"), watch(\"address\"), watch(\"surface\"), watch(\"surfaceTotale\"), watch(\"juridique\"), watch(\"rooms\"), watch(\"bedrooms\"), watch(\"bathrooms\"), watch(\"description\"), imageUrls, activeSection, step, completedSections, submitting]);\n\n  // Scroll vers le haut à chaque changement d'étape\n  useEffect(() => {\n    window.scrollTo({ top: 0, left: 0, behavior: \"instant\" });\n  }, [step]);\n\n  // Restaurer les données du formulaire (formulaire en cours, pas de gestion de paiement ici)\n  // Ce useEffect ne gère PAS le retour après paiement (c'est le rôle du useEffect suivant)\n  useEffect(() => {\n    if (typeof window === \"undefined\") return;\n\n    // Vérifier si on revient d'un paiement (paramètre URL)\n    // Si oui, on laisse le useEffect suivant gérer TOUT (étape + données)\n    const paymentStatus = searchParams?.get(\"payment\");\n    if (paymentStatus === \"success\" || paymentStatus === \"canceled\") {\n      // Le useEffect suivant va gérer le retour après paiement\n      // On ne fait rien ici pour éviter les conflits\n      return;\n    }\n\n    // NOUVEAU FORMULAIRE ou REPRISE : Restaurer les données mais pas l'étape si nouveau formulaire\n    const storedFormData = localStorage.getItem(\"deposit_form_data\");\n    const storedImages = localStorage.getItem(\"deposit_form_images\");\n    const storedStep = localStorage.getItem(\"deposit_form_step\");\n\n    // Restaurer les valeurs du formulaire sauvegardées (si on reprend un formulaire en cours)\n    if (storedFormData) {\n      try {\n        const formData = JSON.parse(storedFormData);\n        Object.keys(formData).forEach((key) => {\n          if (formData[key] !== undefined && formData[key] !== null) {\n            setValue(key as keyof DepositFormValues, formData[key]);\n          }\n        });\n      } catch (error) {\n        console.error(\"Erreur lors de la restauration des données du formulaire:\", error);\n      }\n    }\n\n    // Restaurer les images\n    if (storedImages) {\n      try {\n        const images = JSON.parse(storedImages);\n        if (Array.isArray(images)) {\n          setImageUrls(images);\n        }\n      } catch (error) {\n        console.error(\"Erreur lors de la restauration des images:\", error);\n      }\n    }\n\n    // Si on a un paiement déjà vérifié (refresh de page après paiement confirmé)\n    // On restaure l'état mais on laisse l'étape être gérée par le useEffect suivant\n    const storedToken = localStorage.getItem(\"paydunya_payment_token\");\n    const verified = localStorage.getItem(\"paydunya_payment_verified\");\n    if (storedToken && verified === \"true\") {\n      setPaymentToken(storedToken);\n      setPaymentVerification(\"success\");\n      setIsPaymentConfirmed(true);\n      // L'étape sera gérée par le useEffect suivant si payment=success est dans l'URL\n      // Sinon, on restaure l'étape sauvegardée\n      if (!paymentStatus && storedStep) {\n        const stepNum = parseInt(storedStep, 10);\n        if (stepNum >= 1 && stepNum <= 3) {\n          setStep(stepNum);\n        }\n      }\n    } else if (!paymentStatus) {\n      // NOUVEAU FORMULAIRE : Toujours commencer à l'étape 1\n      setStep(1);\n    }\n  }, [setValue, searchParams]);\n\n  // Sauvegarder l'étape dans localStorage à chaque changement\n  useEffect(() => {\n    // Ne pas sauvegarder pendant la soumission pour éviter les conflits\n    if (typeof window !== \"undefined\" && step >= 1 && step <= 3 && !submitting) {\n      localStorage.setItem(\"deposit_form_step\", step.toString());\n    }\n  }, [step, submitting]);\n\n  // Sauvegarder les valeurs du formulaire dans localStorage à chaque changement de valeur\n  useEffect(() => {\n    // Ne pas auto-sauvegarder pendant la soumission\n    if (typeof window === \"undefined\" || submitting) return;\n\n    const subscription = watch((value) => {\n      try {\n        setFormSaving(true);\n        localStorage.setItem(\"deposit_form_data\", JSON.stringify(value));\n        // Masquer l'indicateur après 800ms\n        setTimeout(() => setFormSaving(false), 800);\n      } catch (error) {\n        console.error(\"Erreur lors de la sauvegarde des données du formulaire:\", error);\n        setFormSaving(false);\n      }\n    });\n\n    return () => subscription.unsubscribe();\n  }, [watch, setValue, submitting]);\n\n  // Sauvegarder les images dans localStorage à chaque changement\n  useEffect(() => {\n    if (typeof window !== \"undefined\" && imageUrls.length > 0) {\n      try {\n        localStorage.setItem(\"deposit_form_images\", JSON.stringify(imageUrls));\n      } catch (error) {\n        console.error(\"Erreur lors de la sauvegarde des images:\", error);\n      }\n    }\n  }, [imageUrls]);\n\n  // --- LOGIQUE DE RETOUR PAIEMENT (FLUX STRICT : PAS D'AUTO-SUBMIT) ---\n  // Ce useEffect est le SEUL responsable de gérer le retour après paiement\n  useEffect(() => {\n    const paymentStatus = searchParams?.get(\"payment\");\n    if (!paymentStatus) return;\n\n    const clearPaymentQuery = () => {\n      const params = new URLSearchParams(searchParams.toString());\n      params.delete(\"payment\");\n      const query = params.toString();\n      router.replace(query ? `${pathname}?${query}` : pathname, { scroll: false });\n    };\n\n    if (paymentStatus === \"success\") {\n      if (typeof window === \"undefined\") {\n        clearPaymentQuery();\n        return;\n      }\n\n      // ÉTAPE CRITIQUE : FORCER L'ÉTAPE 3 IMMÉDIATEMENT et restaurer les données\n      // Cela doit être fait AVANT toute autre logique pour éviter les conflits\n      setStep(3);\n      localStorage.setItem(\"deposit_form_step\", \"3\");\n\n      // Restaurer les données du formulaire immédiatement\n      const storedFormData = localStorage.getItem(\"deposit_form_data\");\n      const storedImages = localStorage.getItem(\"deposit_form_images\");\n\n      if (storedFormData) {\n        try {\n          const formData = JSON.parse(storedFormData);\n          Object.keys(formData).forEach((key) => {\n            if (formData[key] !== undefined && formData[key] !== null) {\n              setValue(key as keyof DepositFormValues, formData[key]);\n            }\n          });\n        } catch (error) {\n          console.error(\"Erreur lors de la restauration des données:\", error);\n        }\n      }\n\n      if (storedImages) {\n        try {\n          const images = JSON.parse(storedImages);\n          if (Array.isArray(images)) {\n            setImageUrls(images);\n          }\n        } catch (error) {\n          console.error(\"Erreur lors de la restauration des images:\", error);\n        }\n      }\n\n      const token = localStorage.getItem(\"paydunya_payment_token\");\n      if (!token) {\n        setPaymentVerification(\"error\");\n        setPaymentMessage(\"Impossible de vérifier le paiement. Merci de réessayer.\");\n        toast.error(\"Paiement introuvable\", {\n          description: \"Veuillez relancer la procédure de paiement.\",\n        });\n        clearPaymentQuery();\n        return;\n      }\n\n      setPaymentVerification(\"checking\");\n      setPaymentMessage(\"Vérification du paiement en cours...\");\n\n      const verifyPayment = async () => {\n        try {\n          const res = await fetch(`/api/paydunya/confirm?token=${token}`);\n          const data = await res.json();\n\n          if (!res.ok || !data?.success) {\n            console.error(\"❌ Erreur de vérification:\", data);\n            throw new Error(data?.error || \"Vérification impossible\");\n          }\n\n          // Accepter plusieurs statuts de confirmation\n          const isPaymentCompleted =\n            data.status === \"completed\" ||\n            data.isCompleted ||\n            data.status === \"paid\" ||\n            (data.response?.response_code === \"00\");\n\n          if (isPaymentCompleted) {\n            localStorage.setItem(\"paydunya_payment_verified\", \"true\");\n            setPaymentToken(token);\n            setPaymentVerification(\"success\");\n            setIsPaymentConfirmed(true);\n            setPaymentMessage(null);\n            // FORCER L'ÉTAPE 3 une dernière fois pour être sûr (après vérification)\n            setStep(3);\n            localStorage.setItem(\"deposit_form_step\", \"3\");\n            toast.success(\"Paiement confirmé ✅\", {\n              description: \"Veuillez cliquer sur 'Confirmer le dépôt' pour terminer.\",\n            });\n          } else {\n            console.error(\"❌ Statut de paiement non confirmé:\", data);\n            throw new Error(`Paiement non confirmé. Statut: ${data.status || \"inconnu\"}`);\n          }\n        } catch (error) {\n          console.error(\"❌ Vérification PayDunya échouée:\", error);\n          setPaymentVerification(\"error\");\n          setPaymentToken(null);\n          setIsPaymentConfirmed(false);\n          setPaymentMessage(\"Le paiement n'a pas été confirmé. Merci de réessayer.\");\n          localStorage.removeItem(\"paydunya_payment_token\");\n          localStorage.removeItem(\"paydunya_payment_verified\");\n          toast.error(\"Paiement non confirmé\", {\n            description: error instanceof Error ? error.message : undefined,\n          });\n        } finally {\n          // Ne pas supprimer le paramètre payment immédiatement\n          // On le garde pour éviter que le premier useEffect ne remette l'étape à 1\n          // On le supprimera après un court délai pour permettre à l'utilisateur de voir le succès\n          setTimeout(() => {\n            clearPaymentQuery();\n          }, 2000);\n        }\n      };\n\n      void verifyPayment();\n    } else if (paymentStatus === \"canceled\") {\n      if (typeof window !== \"undefined\") {\n        localStorage.removeItem(\"paydunya_payment_token\");\n        localStorage.removeItem(\"paydunya_payment_verified\");\n      }\n      setPaymentToken(null);\n      setPaymentVerification(\"idle\");\n      setIsPaymentConfirmed(false);\n      setPaymentMessage(\"Paiement annulé. Vous pouvez réessayer.\");\n      // Rester à l'étape 3 pour permettre de réessayer le paiement\n      setStep(3);\n      localStorage.setItem(\"deposit_form_step\", \"3\");\n      toast.error(\"Paiement annulé\", {\n        description: \"Vous pouvez relancer le paiement quand vous êtes prêt.\",\n      });\n      clearPaymentQuery();\n    }\n  }, [pathname, router, searchParams, setValue]);\n\n  if (loading) {\n    return (\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\n        <div className=\"text-white/70\">Chargement...</div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return (\n      <div className=\"space-y-6 py-6 text-center\">\n        <h1 className=\"text-2xl font-semibold text-white\">\n          Connexion requise\n        </h1>\n        <p className=\"text-white/70\">\n          Vous devez être connecté pour déposer une annonce\n        </p>\n        <Button asChild>\n          <Link href=\"/login\">Se connecter</Link>\n        </Button>\n      </div>\n    );\n  }\n\n  const handleImageUpload = async (files: FileList) => {\n    if (!user) {\n      toast.error(\"Vous devez être connecté pour uploader des images\");\n      return;\n    }\n\n    const fileArray = Array.from(files);\n    if (!fileArray.length) return;\n\n    setUploading(true);\n    try {\n      const supabase = createClient();\n      const uploadedUrls: string[] = [];\n\n      for (const file of fileArray) {\n        const fileExt = file.name.split(\".\").pop();\n        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;\n        const filePath = fileName;\n\n        const { error: uploadError } = await supabase.storage\n          .from(\"properties\")\n          .upload(filePath, file, {\n            cacheControl: \"3600\",\n            upsert: false,\n          });\n\n        if (uploadError) {\n          console.error(\"Upload error:\", uploadError);\n          throw uploadError;\n        }\n\n        const {\n          data: { publicUrl },\n        } = supabase.storage.from(\"properties\").getPublicUrl(filePath);\n\n        uploadedUrls.push(publicUrl);\n      }\n\n      setImageUrls((prev) => [...prev, ...uploadedUrls]);\n      toast.success(`${fileArray.length} photo(s) ajoutée(s) avec succès`);\n    } catch (error) {\n      console.error(\"Error uploading images:\", error);\n      const errorMessage = error instanceof Error ? error.message : \"Veuillez réessayer\";\n      toast.error(\"Erreur lors de l'upload des photos\", {\n        description: errorMessage,\n      });\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  // --- SOUMISSION FINALE (APPELÉE UNIQUEMENT PAR CLIC MANUEL) ---\n  const onSubmit = async (values: DepositFormValues) => {\n    // PROTECTION STRICTE : Vérifier qu'on est bien à l'étape 3 EN PREMIER\n    if (step !== 3) {\n      console.error(\"❌ BLOCAGE : Pas à l'étape 3, step actuel:\", step);\n      toast.error(\"Formulaire incomplet\", {\n        description: `Vous devez compléter toutes les étapes. Étape actuelle: ${step}/3`,\n      });\n      setSubmitting(false);\n      return;\n    }\n\n    // Validation : vérifier que les champs essentiels sont remplis\n    if (!values.title || values.title.trim().length < 3) {\n      console.error(\"❌ BLOCAGE : Titre manquant ou invalide\");\n      toast.error(\"Formulaire incomplet\", {\n        description: \"Le titre de l'annonce est requis.\",\n      });\n      setSubmitting(false);\n      return;\n    }\n\n    // Validation : au moins une image est requise\n    if (imageUrls.length === 0) {\n      console.error(\"❌ BLOCAGE : Aucune image\");\n      toast.error(\"Au moins une photo est requise\", {\n        description: \"Veuillez ajouter au moins une photo de votre bien.\",\n      });\n      setSubmitting(false);\n      return;\n    }\n\n    // Validation : si Diffusion Simple, un token de paiement PayDunya est requis\n    if (\n      needsPayment &&\n      (!isPaymentConfirmed && (!paymentToken || paymentVerification !== \"success\")) &&\n      !values.payment_ref?.trim()\n    ) {\n      console.error(\"❌ BLOCAGE : Paiement non effectué\");\n      toast.error(\"Paiement requis\", {\n        description: \"Veuillez effectuer le paiement avant de finaliser votre annonce.\",\n      });\n      setSubmitting(false);\n      return;\n    }\n\n    setSubmitting(true);\n\n    // GÉOCODAGE INTELLIGENT (Triangulation) - GARANTIT toujours un résultat\n    let coordinates = { lat: 0, lng: 0 };\n\n    // PRIORITÉ 1: Coordonnées sélectionnées manuellement sur la carte\n    if (manualCoordinates && manualCoordinates.lat !== 0 && manualCoordinates.lng !== 0) {\n      coordinates = manualCoordinates;\n      console.log(\"✅ Coordonnées utilisées (sélection manuelle sur carte):\", coordinates);\n    } else {\n      // PRIORITÉ 2: Géocodage automatique via smartGeocode\n      try {\n        // smartGeocode utilise une stratégie multi-niveaux et garantit toujours un résultat\n        coordinates = await smartGeocode(\n          values.address,\n          values.district,\n          values.city\n        );\n        console.log(\"✅ Coordonnées trouvées (smartGeocode):\", coordinates);\n      } catch (geoError) {\n        console.error(\"Erreur lors du géocodage:\", geoError);\n        // En cas d'erreur inattendue, utiliser les coordonnées par défaut (Dakar)\n        coordinates = { lat: 14.7167, lng: -17.4677 };\n        console.warn(\"⚠️ Utilisation des coordonnées par défaut (Dakar)\");\n      }\n    }\n\n    try {\n      const result = await submitUserListing({\n        ...values,\n        images: imageUrls,\n        payment_ref: paymentToken || values.payment_ref,\n        proof_document_url: proofUrl || undefined, // Ajout du document de preuve\n        // Ajout des coordonnées géographiques\n        // Note: Il faudra peut-être adapter submitUserListing pour accepter coords séparément\n        // ou l'inclure dans location si la structure le permet\n        location: {\n          address: values.address,\n          city: values.city,\n          district: values.district,\n          landmark: values.landmark || \"\",\n          coords: coordinates\n        }\n      });\n\n      if (result?.error) {\n        console.error(\"❌ Erreur lors de la soumission:\", result.error);\n        toast.error(\"Erreur lors du dépôt\", {\n          description: result.error || \"Une erreur est survenue. Veuillez réessayer.\",\n          duration: 6000,\n        });\n      } else if (result?.success) {\n        toast.success(\"Annonce déposée avec succès !\", {\n          description: needsPayment\n            ? \"Votre annonce est en attente de validation après vérification du paiement.\"\n            : \"Votre annonce est en attente de validation par notre équipe.\",\n          duration: 5000,\n        });\n        // Petit délai pour voir le toast avant la redirection\n        // NE PAS réinitialiser les états de paiement avant la redirection pour éviter le flash du formulaire\n        setTimeout(() => {\n          // Nettoyer le token PayDunya, l'étape ET les données du formulaire AVANT la redirection\n          localStorage.removeItem(\"paydunya_payment_token\");\n          localStorage.removeItem(\"paydunya_payment_verified\");\n          localStorage.removeItem(\"deposit_form_step\");\n          localStorage.removeItem(\"deposit_form_data\");\n          localStorage.removeItem(\"deposit_form_images\");\n\n          // IMPORTANT: Ne PAS réinitialiser les états React avant la redirection\n          // pour éviter un re-render qui causerait un flash back vers les étapes précédentes\n          // Le nettoyage des états React sera automatique lors du unmount du composant\n\n          // Redirection immédiate sans modification des états React\n          router.push(\"/compte/mes-biens\");\n          router.refresh();\n        }, 1500);\n      } else {\n        console.error(\"❌ Réponse inattendue:\", result);\n        toast.error(\"Erreur inattendue\", {\n          description: \"La réponse du serveur est invalide. Veuillez réessayer.\",\n        });\n      }\n    } catch (error) {\n      console.error(\"❌ Erreur lors du dépôt:\", error);\n      const errorMessage = error instanceof Error ? error.message : \"Une erreur inattendue est survenue\";\n      toast.error(\"Erreur lors du dépôt de l'annonce\", {\n        description: errorMessage,\n        duration: 6000,\n      });\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  // Handler pour le bouton submit\n  const handleSubmitClick = async (e?: React.MouseEvent<HTMLButtonElement>) => {\n    e?.preventDefault();\n    e?.stopPropagation();\n\n    try {\n      // Valider tous les champs du formulaire\n      const isValid = await trigger();\n      const currentValues = getValues();\n\n      if (!isValid) {\n        console.error(\"❌ Formulaire invalide. Erreurs détaillées:\", errors);\n        console.error(\"❌ Valeurs actuelles:\", currentValues);\n\n        // Afficher les erreurs spécifiques\n        const errorMessages = Object.entries(errors)\n          .map(([field, error]) => `${field}: ${error?.message}`)\n          .filter(Boolean)\n          .join(\", \");\n\n        toast.error(\"Veuillez corriger les erreurs du formulaire\", {\n          description: errorMessages || \"Certains champs sont manquants ou invalides. Vérifiez que vous avez bien rempli toutes les étapes du formulaire.\",\n        });\n        return;\n      }\n\n      // Vérifier qu'on est à l'étape 3\n      if (step !== 3) {\n        console.error(\"❌ Pas à l'étape 3:\", step);\n        toast.error(\"Formulaire incomplet\", {\n          description: \"Veuillez compléter toutes les étapes du formulaire.\",\n        });\n        return;\n      }\n\n      // Vérifier qu'il y a au moins une image\n      if (imageUrls.length === 0) {\n        console.error(\"❌ Aucune image\");\n        toast.error(\"Au moins une photo est requise\", {\n          description: \"Veuillez ajouter au moins une photo de votre bien.\",\n        });\n        return;\n      }\n\n      // Récupérer les valeurs validées\n      const values = getValues();\n\n      // Appeler onSubmit avec les valeurs\n      await onSubmit(values);\n    } catch (error) {\n      console.error(\"❌ Erreur lors de la validation du formulaire:\", error);\n      toast.error(\"Erreur lors de la validation\", {\n        description: error instanceof Error ? error.message : \"Une erreur est survenue\",\n      });\n      setSubmitting(false);\n    }\n  };\n\n  const handleNext = async () => {\n    if (step < 3) {\n      // Valider les champs de l'étape actuelle avant de passer à la suivante\n      let fieldsToValidate: (keyof DepositFormValues)[] = [];\n\n      if (step === 1) {\n        fieldsToValidate = [\n          \"type\",\n          \"title\",\n          \"description\",\n          \"price\",\n          \"category\",\n          \"city\",\n          \"district\",\n          \"address\",\n          \"landmark\",\n        ];\n\n        if (isTerrain) {\n          fieldsToValidate.push(\"surfaceTotale\", \"juridique\");\n        } else {\n          fieldsToValidate.push(\"surface\", \"rooms\", \"bedrooms\", \"bathrooms\");\n        }\n      } else if (step === 2) {\n        fieldsToValidate = [\"service_type\"];\n      }\n\n      const isValidStep = await trigger(fieldsToValidate);\n\n      if (isValidStep) {\n        // Sauvegarder les valeurs actuelles avant de changer d'étape\n        const currentValues = getValues();\n        localStorage.setItem(\"deposit_form_data\", JSON.stringify(currentValues));\n\n        setStep(step + 1);\n        window.scrollTo({ top: 0, left: 0, behavior: \"instant\" });\n      } else {\n        toast.error(\"Veuillez remplir tous les champs requis\", {\n          description: \"Certains champs sont manquants ou invalides.\",\n        });\n      }\n    }\n  };\n\n  const handlePrev = () => {\n    if (step > 1) {\n      setStep(step - 1);\n      window.scrollTo({ top: 0, left: 0, behavior: \"instant\" });\n    }\n  };\n\n  const priceLabel =\n    category === \"location\"\n      ? \"Loyer Mensuel (FCFA)\"\n      : \"Prix de Vente (FCFA)\";\n\n  return (\n    <div className=\"max-w-lg mx-auto px-5 pt-6 pb-32 text-white\">\n      <div className=\"h-16 md:hidden\" />\n\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Button variant=\"ghost\" size=\"icon\" asChild>\n          <Link href=\"/compte\">\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Link>\n        </Button>\n        <div>\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/40\">\n            Espace Propriétaire\n          </p>\n          <h1 className=\"text-3xl font-semibold\">Déposer une annonce</h1>\n        </div>\n      </div>\n\n      {/* Progress Bar - Enhanced */}\n      <div className=\"mb-6\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-sm font-medium text-white\">Étape {step} sur 3</span>\n            <span className=\"text-xs text-white/50\">\n              {step === 1 ? \"Informations du bien\" : step === 2 ? \"Choix de l'offre\" : \"Finalisation\"}\n            </span>\n          </div>\n          <span className=\"text-sm font-semibold text-primary\">{Math.round((step / 3) * 100)}%</span>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {[1, 2, 3].map((s) => (\n            <div key={s} className=\"flex-1\">\n              <div className=\"relative h-2 rounded-full bg-white/10 overflow-hidden\">\n                <div\n                  className={`h-full rounded-full transition-all duration-500 ${\n                    s <= step ? \"bg-primary\" : \"bg-transparent\"\n                  }`}\n                  style={{\n                    width: s < step ? \"100%\" : s === step ? \"50%\" : \"0%\"\n                  }}\n                />\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <form\n        className=\"rounded-[32px] border border-white/10 bg-card p-5 sm:p-6 mt-6\"\n        onSubmit={(e) => {\n          e.preventDefault();\n        }}\n      >\n        <AnimatePresence mode=\"wait\">\n          {/* Step 1: Informations du bien */}\n          {step === 1 && (\n            <motion.div\n              key=\"step1\"\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: -20 }}\n              className=\"space-y-8\"\n            >\n              <div>\n                <h2 className=\"text-xl font-semibold mb-1\">1. Informations du bien</h2>\n                <p className=\"text-sm text-white/50\">Complétez les informations essentielles de votre bien</p>\n              </div>\n\n              {/* Section: Informations Essentielles */}\n              <div id=\"section-essentials\" className=\"rounded-2xl border border-white/5 bg-white/[0.02] overflow-hidden\">\n                <button\n                  type=\"button\"\n                  onClick={() => setActiveSection(activeSection === \"essentials\" ? \"\" : \"essentials\")}\n                  className=\"w-full p-5 text-left flex items-center justify-between hover:bg-white/[0.02] transition-colors\"\n                >\n                  <h3 className=\"text-sm font-semibold text-white/90 uppercase tracking-wider flex items-center gap-2\">\n                    <div className=\"h-1.5 w-1.5 rounded-full bg-primary\" />\n                    Informations Essentielles\n                  </h3>\n                  <div className=\"flex items-center gap-2\">\n                    {completedSections.includes(\"essentials\") && (\n                      <Check className=\"h-5 w-5 text-emerald-400\" />\n                    )}\n                    <motion.div\n                      animate={{ rotate: activeSection === \"essentials\" ? 180 : 0 }}\n                      transition={{ duration: 0.3 }}\n                    >\n                      <svg className=\"h-5 w-5 text-white/40\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                      </svg>\n                    </motion.div>\n                  </div>\n                </button>\n                <AnimatePresence>\n                  {activeSection === \"essentials\" && (\n                    <motion.div\n                      initial={{ height: 0, opacity: 0 }}\n                      animate={{ height: \"auto\", opacity: 1 }}\n                      exit={{ height: 0, opacity: 0 }}\n                      transition={{ duration: 0.4, ease: \"easeInOut\" }}\n                    >\n                      <div className=\"px-5 pb-5 space-y-4\">\n                <div className=\"grid gap-4 sm:grid-cols-2\">\n                <div>\n                  <label className=\"text-sm text-white/70\">Type de bien</label>\n                  <select\n                    {...register(\"type\")}\n                    className=\"mt-2 h-12 w-full rounded-2xl border border-white/10 bg-card px-4 text-[16px] text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                    style={{\n                      colorScheme: \"dark\",\n                      fontSize: \"16px\",\n                      backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                      backgroundPosition: \"right 0.75rem center\",\n                      backgroundSize: \"1.5em 1.5em\"\n                    }}\n                  >\n                    {typesBien.map((t) => (\n                      <option key={t.value} value={t.value} className=\"bg-[#121212] text-white py-2\">\n                        {t.label}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-white/70\">Catégorie</label>\n                  <select\n                    {...register(\"category\")}\n                    className=\"mt-2 h-12 w-full rounded-2xl border border-white/10 bg-card px-4 text-[16px] text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                    style={{\n                      colorScheme: \"dark\",\n                      fontSize: \"16px\",\n                      backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                      backgroundPosition: \"right 0.75rem center\",\n                      backgroundSize: \"1.5em 1.5em\"\n                    }}\n                  >\n                    <option value=\"vente\" className=\"bg-[#121212] text-white py-2\">\n                      Vente\n                    </option>\n                    <option value=\"location\" className=\"bg-[#121212] text-white py-2\">\n                      Location\n                    </option>\n                  </select>\n                </div>\n\n                <div className=\"sm:col-span-2\">\n                  <label className=\"text-sm text-white/70\">Titre</label>\n                  <div className=\"relative\">\n                    <Input {...register(\"title\")} className=\"mt-2 text-[16px] pr-10\" />\n                    {!errors.title && watch(\"title\") && watch(\"title\").length >= 3 && (\n                      <Check className=\"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-emerald-400\" />\n                    )}\n                  </div>\n                  {errors.title && (\n                    <p className=\"mt-1 text-sm text-amber-300\">\n                      {errors.title.message}\n                    </p>\n                  )}\n                </div>\n\n                <div className=\"sm:col-span-2\">\n                  <label className=\"text-sm text-white/70\">{priceLabel}</label>\n                  <div className=\"relative\">\n                    <Input\n                      type=\"number\"\n                      {...register(\"price\")}\n                      className=\"mt-2 text-[16px] pr-10\"\n                      placeholder={category === \"location\" ? \"Ex: 250000\" : \"Ex: 45000000\"}\n                    />\n                    {!errors.price && watch(\"price\") && Number(watch(\"price\")) > 0 && (\n                      <Check className=\"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-emerald-400\" />\n                    )}\n                  </div>\n                  {errors.price && (\n                    <p className=\"mt-1 text-sm text-amber-300\">\n                      {errors.price.message}\n                    </p>\n                  )}\n                </div>\n              </div>\n                      </div>\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </div>\n\n            {/* Section: Localisation */}\n            <div id=\"section-location\" className=\"rounded-2xl border border-white/5 bg-white/[0.02] overflow-hidden\">\n              <button\n                type=\"button\"\n                onClick={() => setActiveSection(activeSection === \"location\" ? \"\" : \"location\")}\n                className=\"w-full p-5 text-left flex items-center justify-between hover:bg-white/[0.02] transition-colors\"\n              >\n                <h3 className=\"text-sm font-semibold text-white/90 uppercase tracking-wider flex items-center gap-2\">\n                  <div className=\"h-1.5 w-1.5 rounded-full bg-primary\" />\n                  Localisation\n                </h3>\n                <div className=\"flex items-center gap-2\">\n                  {completedSections.includes(\"location\") && (\n                    <Check className=\"h-5 w-5 text-emerald-400\" />\n                  )}\n                  <motion.div\n                    animate={{ rotate: activeSection === \"location\" ? 180 : 0 }}\n                    transition={{ duration: 0.3 }}\n                  >\n                    <svg className=\"h-5 w-5 text-white/40\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                    </svg>\n                  </motion.div>\n                </div>\n              </button>\n              <AnimatePresence>\n                {activeSection === \"location\" && (\n                  <motion.div\n                    initial={{ height: 0, opacity: 0 }}\n                    animate={{ height: \"auto\", opacity: 1 }}\n                    exit={{ height: 0, opacity: 0 }}\n                    transition={{ duration: 0.4, ease: \"easeInOut\" }}\n                  >\n                    <div className=\"px-5 pb-5 space-y-4\">\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                <div>\n                  <label className=\"text-sm text-white/70\">Région</label>\n                  <Input {...register(\"city\")} className=\"mt-2 text-base\" />\n                  {errors.city && (\n                    <p className=\"mt-1 text-sm text-amber-300\">\n                      {errors.city.message}\n                    </p>\n                  )}\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-white/70\">Quartier (ville)</label>\n                  <Input {...register(\"district\")} className=\"mt-2 text-base\" />\n                  {errors.district && (\n                    <p className=\"mt-1 text-sm text-amber-300\">\n                      {errors.district.message}\n                    </p>\n                  )}\n                </div>\n\n                <div className=\"sm:col-span-2\">\n                  <label className=\"text-sm text-white/70\">Adresse</label>\n                  <AddressInputWithMap\n                    register={register(\"address\")}\n                    error={errors.address?.message}\n                    setValue={setValue}\n                    currentAddress={watch(\"address\")}\n                    city={watch(\"city\")}\n                    district={watch(\"district\")}\n                    onLocationSelect={(lat, lng) => {\n                      setManualCoordinates({ lat, lng });\n                      console.log(\"📍 Coordonnées sélectionnées manuellement:\", { lat, lng });\n                    }}\n                    onAddressFound={(details) => {\n                      if (details.city) {\n                        setValue(\"city\", details.city, { shouldValidate: true });\n                      }\n                      if (details.district) {\n                        setValue(\"district\", details.district, { shouldValidate: true });\n                      }\n                    }}\n                    className=\"mt-2\"\n                  />\n                </div>\n\n                <div className=\"sm:col-span-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <label className=\"text-sm text-white/70\">Point de repère <span className=\"text-white/40\">(optionnel)</span></label>\n                    <InfoTooltip content=\"Ex: Près de la station Total, à côté de l'école primaire Liberté, face à la mosquée...\" />\n                  </div>\n                  <Input {...register(\"landmark\")} className=\"mt-2 text-[16px]\" placeholder=\"Ex: Près de la station Total...\" />\n                  {errors.landmark && (\n                    <p className=\"mt-1 text-sm text-amber-300\">\n                      {errors.landmark.message}\n                    </p>\n                  )}\n                </div>\n              </div>\n                    </div>\n                  </motion.div>\n                )}\n              </AnimatePresence>\n            </div>\n\n            {/* Section: Caractéristiques (conditionnelle selon le type) */}\n            <div id=\"section-characteristics\" className=\"rounded-2xl border border-white/5 bg-white/[0.02] overflow-hidden\">\n              <button\n                type=\"button\"\n                onClick={() => setActiveSection(activeSection === \"characteristics\" ? \"\" : \"characteristics\")}\n                className=\"w-full p-5 text-left flex items-center justify-between hover:bg-white/[0.02] transition-colors\"\n              >\n                <h3 className=\"text-sm font-semibold text-white/90 uppercase tracking-wider flex items-center gap-2\">\n                  <div className=\"h-1.5 w-1.5 rounded-full bg-primary\" />\n                  Caractéristiques\n                </h3>\n                <div className=\"flex items-center gap-2\">\n                  {completedSections.includes(\"characteristics\") && (\n                    <Check className=\"h-5 w-5 text-emerald-400\" />\n                  )}\n                  <motion.div\n                    animate={{ rotate: activeSection === \"characteristics\" ? 180 : 0 }}\n                    transition={{ duration: 0.3 }}\n                  >\n                    <svg className=\"h-5 w-5 text-white/40\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                    </svg>\n                  </motion.div>\n                </div>\n              </button>\n              <AnimatePresence>\n                {activeSection === \"characteristics\" && (\n                  <motion.div\n                    initial={{ height: 0, opacity: 0 }}\n                    animate={{ height: \"auto\", opacity: 1 }}\n                    exit={{ height: 0, opacity: 0 }}\n                    transition={{ duration: 0.4, ease: \"easeInOut\" }}\n                  >\n                    <div className=\"px-5 pb-5 space-y-4\">\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                {/* Champs conditionnels selon le type */}\n                {isTerrain ? (\n                  <>\n                    <div className=\"sm:col-span-2\">\n                      <label className=\"text-sm text-white/70\">Surface totale (m²)</label>\n                      <Input\n                        type=\"number\"\n                        {...register(\"surfaceTotale\", { valueAsNumber: true })}\n                        className=\"mt-2 text-[16px]\"\n                      />\n                      {errors.surfaceTotale && (\n                        <p className=\"mt-1 text-sm text-amber-300\">\n                          {errors.surfaceTotale.message}\n                        </p>\n                      )}\n                    </div>\n                    <div className=\"sm:col-span-2\">\n                      <label className=\"text-sm text-white/70\">Situation juridique</label>\n                      <select\n                        {...register(\"juridique\")}\n                        className=\"mt-2 h-12 w-full rounded-2xl border border-white/10 bg-card px-4 text-[16px] text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                        style={{\n                          colorScheme: \"dark\",\n                          fontSize: \"16px\",\n                          backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                          backgroundPosition: \"right 0.75rem center\",\n                          backgroundSize: \"1.5em 1.5em\"\n                        }}\n                      >\n                        <option value=\"\" className=\"bg-[#121212] text-white py-2\">\n                          Sélectionnez\n                        </option>\n                        {situationsJuridiques.map((sj) => (\n                          <option\n                            key={sj.value}\n                            value={sj.value}\n                            className=\"bg-[#121212] text-white py-2\"\n                          >\n                            {sj.label}\n                          </option>\n                        ))}\n                      </select>\n                      {errors.juridique && (\n                        <p className=\"mt-1 text-sm text-amber-300\">\n                          {errors.juridique.message}\n                        </p>\n                      )}\n                    </div>\n                  </>\n                ) : (\n                  <>\n                    <div>\n                      <label className=\"text-sm text-white/70\">Surface habitable (m²)</label>\n                      <Input\n                        type=\"number\"\n                        {...register(\"surface\", { valueAsNumber: true })}\n                        className=\"mt-2 text-[16px]\"\n                      />\n                      {errors.surface && (\n                        <p className=\"mt-1 text-sm text-amber-300\">\n                          {errors.surface.message}\n                        </p>\n                      )}\n                    </div>\n                    <div>\n                      <label className=\"text-sm text-white/70\">Pièces</label>\n                      <Input\n                        type=\"number\"\n                        {...register(\"rooms\", { valueAsNumber: true })}\n                        className=\"mt-2 text-[16px]\"\n                      />\n                      {errors.rooms && (\n                        <p className=\"mt-1 text-sm text-amber-300\">\n                          {errors.rooms.message}\n                        </p>\n                      )}\n                    </div>\n                    <div>\n                      <label className=\"text-sm text-white/70\">Chambres</label>\n                      <Input\n                        type=\"number\"\n                        {...register(\"bedrooms\", { valueAsNumber: true })}\n                        className=\"mt-2 text-[16px]\"\n                      />\n                      {errors.bedrooms && (\n                        <p className=\"mt-1 text-sm text-amber-300\">\n                          {errors.bedrooms.message}\n                        </p>\n                      )}\n                    </div>\n                    <div>\n                      <label className=\"text-sm text-white/70\">Salles de bain</label>\n                      <Input\n                        type=\"number\"\n                        {...register(\"bathrooms\", { valueAsNumber: true })}\n                        className=\"mt-2 text-[16px]\"\n                      />\n                      {errors.bathrooms && (\n                        <p className=\"mt-1 text-sm text-amber-300\">\n                          {errors.bathrooms.message}\n                        </p>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n                    </div>\n                  </motion.div>\n                )}\n              </AnimatePresence>\n            </div>\n\n            {/* Section: Description & Photos */}\n            <div id=\"section-description\" className=\"rounded-2xl border border-white/5 bg-white/[0.02] overflow-hidden\">\n              <button\n                type=\"button\"\n                onClick={() => setActiveSection(activeSection === \"description\" ? \"\" : \"description\")}\n                className=\"w-full p-5 text-left flex items-center justify-between hover:bg-white/[0.02] transition-colors\"\n              >\n                <h3 className=\"text-sm font-semibold text-white/90 uppercase tracking-wider flex items-center gap-2\">\n                  <div className=\"h-1.5 w-1.5 rounded-full bg-primary\" />\n                  Description & Photos\n                </h3>\n                <div className=\"flex items-center gap-2\">\n                  {completedSections.includes(\"description\") && (\n                    <Check className=\"h-5 w-5 text-emerald-400\" />\n                  )}\n                  <motion.div\n                    animate={{ rotate: activeSection === \"description\" ? 180 : 0 }}\n                    transition={{ duration: 0.3 }}\n                  >\n                    <svg className=\"h-5 w-5 text-white/40\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                    </svg>\n                  </motion.div>\n                </div>\n              </button>\n              <AnimatePresence>\n                {activeSection === \"description\" && (\n                  <motion.div\n                    initial={{ height: 0, opacity: 0 }}\n                    animate={{ height: \"auto\", opacity: 1 }}\n                    exit={{ height: 0, opacity: 0 }}\n                    transition={{ duration: 0.4, ease: \"easeInOut\" }}\n                  >\n                    <div className=\"px-5 pb-5 space-y-4\">\n\n              <div>\n                <label className=\"text-sm text-white/70\">Description</label>\n                <Textarea\n                  {...register(\"description\")}\n                  className=\"mt-2 min-h-[120px]\"\n                  placeholder=\"Décrivez votre bien en détail...\"\n                />\n                {errors.description && (\n                  <p className=\"mt-1 text-sm text-amber-300\">\n                    {errors.description.message}\n                  </p>\n                )}\n              </div>\n\n              <div>\n                <label className=\"text-sm text-white/70\">Photos</label>\n                <div className=\"mt-2 rounded-2xl border border-dashed border-white/20 bg-white/5 p-6 text-center\">\n                  <input\n                    type=\"file\"\n                    multiple\n                    accept=\"image/*\"\n                    className=\"hidden\"\n                    id=\"photo-upload\"\n                    onChange={(e) => e.target.files && handleImageUpload(e.target.files)}\n                    disabled={uploading}\n                  />\n                  <label\n                    htmlFor=\"photo-upload\"\n                    className={`inline-flex cursor-pointer items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-sm text-white hover:bg-white/10 ${uploading ? \"opacity-50 cursor-not-allowed\" : \"\"\n                      }`}\n                  >\n                    {uploading ? \"Upload en cours...\" : \"Choisir des photos\"}\n                  </label>\n                  {imageUrls.length > 0 && (\n                    <div className=\"mt-4 grid grid-cols-2 gap-2 sm:grid-cols-3\">\n                      {imageUrls.map((url, index) => (\n                        <div key={index} className=\"relative aspect-square overflow-hidden rounded-xl\">\n                          {/* eslint-disable-next-line @next/next/no-img-element */}\n                          <img\n                            src={url}\n                            alt={`Photo ${index + 1}`}\n                            className=\"h-full w-full object-cover\"\n                          />\n                          <button\n                            type=\"button\"\n                            onClick={() => setImageUrls((prev) => prev.filter((_, i) => i !== index))}\n                            className=\"absolute right-2 top-2 rounded-full bg-red-500 p-1.5 text-white hover:bg-red-600\"\n                          >\n                            <X className=\"h-3 w-3\" />\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                  {imageUrls.length === 0 && (\n                    <p className=\"mt-2 text-xs text-white/50\">\n                      Au moins une photo est requise\n                    </p>\n                  )}\n                </div>\n              </div>\n                    </div>\n                  </motion.div>\n                )}\n              </AnimatePresence>\n            </div>\n            </motion.div>\n          )}\n\n          {/* Step 2: L'Offre */}\n          {step === 2 && (\n            <motion.div\n              key=\"step2\"\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: -20 }}\n              className=\"space-y-6\"\n            >\n              <h2 className=\"text-xl font-semibold\">2. Choisissez votre offre</h2>\n\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                <button\n                  type=\"button\"\n                  onClick={() => setValue(\"service_type\", \"mandat_confort\")}\n                  className={`rounded-2xl border-2 p-6 text-left transition-all ${serviceType === \"mandat_confort\"\n                    ? \"border-primary bg-primary/10\"\n                    : \"border-white/10 bg-card hover:border-white/20\"\n                    }`}\n                >\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2\">\n                        <h3 className=\"text-lg font-semibold text-white\">\n                          Mandat Agence\n                        </h3>\n                        <InfoTooltip content=\"L'option sérénité. Doussel Immo s'occupe de tout : photos professionnelles, visites, rédaction du bail/vente. Vous ne payez rien maintenant. Une commission sera prélevée uniquement si nous trouvons un preneur.\" />\n                      </div>\n                      <p className=\"mt-2 text-sm text-white/70\">\n                        On s&apos;occupe de tout. Commission au succès.\n                      </p>\n                      <div className=\"mt-4 flex items-center gap-2\">\n                        <span className=\"text-2xl font-bold text-amber-400\">\n                          Gratuit\n                        </span>\n                      </div>\n                    </div>\n                    {serviceType === \"mandat_confort\" && (\n                      <Check className=\"h-6 w-6 text-amber-400\" />\n                    )}\n                  </div>\n                </button>\n\n                <button\n                  type=\"button\"\n                  onClick={() => setValue(\"service_type\", \"boost_visibilite\")}\n                  className={`rounded-2xl border-2 p-6 text-left transition-all ${serviceType === \"boost_visibilite\"\n                    ? \"border-primary bg-primary/10\"\n                    : \"border-white/10 bg-card hover:border-white/20\"\n                    }`}\n                >\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2\">\n                        <h3 className=\"text-lg font-semibold text-white\">\n                          Diffusion Simple\n                        </h3>\n                        <InfoTooltip content=\"L'option autonomie. Vous payez pour afficher votre annonce sur notre site pendant 30 jours. Vous gérez vous-même les appels et les visites. Idéal si vous voulez garder le contrôle total.\" />\n                      </div>\n                      <p className=\"mt-2 text-sm text-white/70\">\n                        Vous gérez vos visites. Votre annonce visible 30 jours.\n                      </p>\n                      <div className=\"mt-4 flex items-center gap-2\">\n                        <span className=\"text-2xl font-bold text-amber-400\">\n                          {services.find(s => s.code === \"boost_visibilite\")?.price.toLocaleString(\"fr-SN\") || \"1 500\"} FCFA\n                        </span>\n                      </div>\n                    </div>\n                    {serviceType === \"boost_visibilite\" && (\n                      <Check className=\"h-6 w-6 text-amber-400\" />\n                    )}\n                  </div>\n                </button>\n              </div>\n            </motion.div>\n          )}\n\n          {/* Step 3: Paiement & Confirmation */}\n          {step === 3 && (\n            <motion.div\n              key=\"step3\"\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: -20 }}\n              className=\"space-y-6\"\n            >\n              <h2 className=\"text-xl font-semibold\">3. Finalisation</h2>\n\n              {/* Champ téléphone de contact */}\n              <div>\n                <label className=\"text-sm text-white/70\">\n                  Votre numéro de téléphone (pour vous contacter)\n                </label>\n                <Controller\n                  name=\"contact_phone\"\n                  control={control}\n                  render={({ field: { onChange, value, ...field } }) => (\n                    <PhoneInput\n                      {...field}\n                      value={value || undefined}\n                      onChange={(val) => onChange(val || \"\")}\n                      defaultCountry=\"SN\"\n                      international\n                      className=\"mt-2\"\n                    />\n                  )}\n                />\n                {errors.contact_phone && (\n                  <p className=\"mt-1 text-sm text-amber-300\">\n                    {errors.contact_phone.message}\n                  </p>\n                )}\n              </div>\n\n              {/* DOCUMENT JUSTIFICATIF (depuis coffre-fort) */}\n              <DocumentSelector\n                className=\"mb-6\"\n                label=\"Document justificatif (optionnel)\"\n                description=\"Sélectionnez un document depuis votre coffre-fort pour certifier votre annonce\"\n                selectedDocumentId={proofDocumentId || undefined}\n                onSelect={(doc) => {\n                  if (doc) {\n                    setProofDocumentId(doc.id);\n                    setProofUrl(doc.url);\n                    console.log(\"✅ Document sélectionné:\", doc);\n                  } else {\n                    setProofDocumentId(null);\n                    setProofUrl(null);\n                  }\n                }}\n              />\n\n              {/* LOGIQUE PAIEMENT - FLUX STRICT */}\n              {needsPayment ? (\n                <>\n                  {/* On affiche le succès SI le paiement est confirmé (état persistant pour éviter le flash) */}\n                  {(isPaymentConfirmed || (paymentToken && paymentVerification === \"success\")) ? (\n                    // CAS 1 : PAIEMENT RÉUSSI -> CARTE VERTE + BOUTON CONFIRMER\n                    <div className=\"space-y-6\">\n                      <div className=\"rounded-2xl border border-emerald-500/30 bg-emerald-500/10 p-6 text-center animate-in fade-in zoom-in duration-500\">\n                        <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-emerald-500/20\">\n                          <Check className=\"h-8 w-8 text-emerald-400\" />\n                        </div>\n                        <h3 className=\"text-xl font-bold text-white\">\n                          Paiement validé ✅\n                        </h3>\n                        <p className=\"mt-2 text-white/70\">\n                          Nous avons bien reçu votre paiement de 1 500 FCFA.\n                        </p>\n                      </div>\n\n                      {/* LE BOUTON FINAL - ACTION MANUELLE OBLIGATOIRE */}\n                      <Button\n                        type=\"button\"\n                        onClick={(e) => {\n                          e.preventDefault();\n                          handleSubmitClick(e);\n                        }}\n                        disabled={submitting}\n                        className=\"w-full h-14 text-lg font-semibold rounded-xl bg-emerald-500 text-white hover:bg-emerald-600 shadow-lg shadow-emerald-500/20 transition-all hover:scale-[1.02] active:scale-[0.98]\"\n                      >\n                        {submitting ? (\n                          <>\n                            <svg\n                              className=\"mr-2 h-5 w-5 animate-spin\"\n                              xmlns=\"http://www.w3.org/2000/svg\"\n                              fill=\"none\"\n                              viewBox=\"0 0 24 24\"\n                            >\n                              <circle\n                                className=\"opacity-25\"\n                                cx=\"12\"\n                                cy=\"12\"\n                                r=\"10\"\n                                stroke=\"currentColor\"\n                                strokeWidth=\"4\"\n                              ></circle>\n                              <path\n                                className=\"opacity-75\"\n                                fill=\"currentColor\"\n                                d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n                              ></path>\n                            </svg>\n                            Finalisation en cours...\n                          </>\n                        ) : (\n                          \"Confirmer le dépôt de l'annonce\"\n                        )}\n                      </Button>\n                    </div>\n                  ) : (\n                    // CAS 2 : PAS ENCORE PAYÉ -> BOUTON PAYER\n                    <div className=\"rounded-2xl border border-white/10 bg-card p-6 text-center\">\n                      <p className=\"text-sm text-white/70 mb-4\">\n                        Paiement sécurisé via PayDunya\n                      </p>\n                      <p className=\"text-lg font-semibold text-white mb-2\">\n                        {services.find(s => s.code === \"boost_visibilite\")?.price.toLocaleString(\"fr-SN\") || \"1 500\"} FCFA\n                      </p>\n                      <p className=\"text-sm text-white/60 mb-4\">\n                        Accepte Wave, Orange Money et Free Money\n                      </p>\n                      <Button\n                        type=\"button\"\n                        onClick={async () => {\n                          try {\n                            setSubmitting(true);\n                            const values = getValues();\n\n                            // Créer la facture PayDunya\n                            const response = await fetch(\"/api/paydunya/create-invoice\", {\n                              method: \"POST\",\n                              headers: {\n                                \"Content-Type\": \"application/json\",\n                              },\n                              body: JSON.stringify({\n                                serviceType: \"boost_visibilite\", // On envoie le CODE du service, pas le montant\n                                description: `Diffusion Simple - ${values.title}`,\n                                propertyId: null,\n                                returnUrl: `${window.location.origin}/compte/deposer?payment=success`,\n                                cancelUrl: `${window.location.origin}/compte/deposer?payment=canceled`,\n                              }),\n                            });\n\n                            const data = await response.json();\n\n                            if (!response.ok || !data.success) {\n                              throw new Error(data.error || \"Erreur lors de la création du paiement\");\n                            }\n\n                            // Stocker le token avant la redirection\n                            if (data.token) {\n                              localStorage.removeItem(\"paydunya_payment_verified\");\n                              localStorage.setItem(\"paydunya_payment_token\", data.token);\n                              setPaymentToken(null);\n                              setPaymentVerification(\"idle\");\n                              setIsPaymentConfirmed(false); // Réinitialiser l'état de confirmation avant redirection\n                              setPaymentMessage(null);\n                            }\n\n                            // Rediriger vers PayDunya\n                            window.location.href = data.checkout_url;\n                          } catch (error) {\n                            console.error(\"Erreur PayDunya:\", error);\n                            toast.error(\"Erreur lors de la création du paiement\", {\n                              description: error instanceof Error ? error.message : \"Veuillez réessayer\",\n                            });\n                            setSubmitting(false);\n                          }\n                        }}\n                        disabled={submitting}\n                        className=\"w-full h-12 rounded-xl bg-primary text-black hover:bg-primary/90 disabled:opacity-50\"\n                      >\n                        {submitting ? \"Redirection...\" : \"Payer avec PayDunya\"}\n                      </Button>\n\n                      {paymentVerification === \"checking\" && (\n                        <div className=\"mt-4 rounded-2xl border border-white/10 bg-card p-4 text-center text-sm text-white/70\">\n                          Vérification du paiement en cours...\n                        </div>\n                      )}\n                      {paymentMessage && paymentVerification === \"error\" && (\n                        <div className=\"mt-4 rounded-2xl border border-primary/40 bg-primary/10 p-4 text-center text-sm text-primary\">\n                          {paymentMessage}\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </>\n              ) : (\n                // CAS GRATUIT (Mandat)\n                <div className=\"rounded-2xl border border-primary/20 bg-primary/10 p-6 text-center\">\n                  <Check className=\"mx-auto h-12 w-12 text-primary\" />\n                  <p className=\"mt-4 text-lg font-semibold text-white\">\n                    Offre gratuite sélectionnée\n                  </p>\n                  <p className=\"mt-2 text-sm text-white/70\">\n                    Votre annonce sera vérifiée par notre équipe avant publication\n                  </p>\n\n                  {/* Bouton pour les annonces gratuites */}\n                  <Button\n                    type=\"button\"\n                    onClick={(e) => {\n                      e.preventDefault();\n                      handleSubmitClick(e);\n                    }}\n                    disabled={submitting}\n                    className=\"mt-6 w-full h-12 rounded-xl bg-primary text-black hover:bg-primary/90 disabled:opacity-50\"\n                  >\n                    {submitting ? \"Envoi...\" : \"Confirmer le dépôt\"}\n                  </Button>\n                </div>\n              )}\n            </motion.div>\n          )}\n        </AnimatePresence>\n\n        {/* Navigation Buttons - CACHÉ À L'ÉTAPE 3 SI PAIEMENT REQUIS */}\n        <div className=\"mt-8 flex justify-between gap-4\">\n          {step > 1 ? (\n            <Button\n              type=\"button\"\n              variant=\"secondary\"\n              size=\"lg\"\n              onClick={handlePrev}\n              className=\"h-12 rounded-full text-base\"\n            >\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Précédent\n            </Button>\n          ) : (\n            <div />\n          )}\n\n          {step < 3 ? (\n            <Button\n              type=\"button\"\n              size=\"lg\"\n              onClick={handleNext}\n              className=\"h-12 rounded-full bg-primary text-black text-base\"\n            >\n              Suivant\n              <ArrowRight className=\"ml-2 h-4 w-4\" />\n            </Button>\n          ) : !needsPayment ? (\n            // Bouton visible uniquement pour les annonces GRATUITES à l'étape 3\n            // (Pour les payantes, le bouton est dans le bloc de paiement)\n            <Button\n              type=\"button\"\n              size=\"lg\"\n              onClick={(e) => {\n                e.preventDefault();\n                handleSubmitClick(e);\n              }}\n              disabled={submitting || uploading}\n              className=\"h-12 rounded-full bg-primary text-black text-base disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              {submitting ? (\n                <>\n                  <svg\n                    className=\"mr-2 h-5 w-5 animate-spin\"\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                  >\n                    <circle\n                      className=\"opacity-25\"\n                      cx=\"12\"\n                      cy=\"12\"\n                      r=\"10\"\n                      stroke=\"currentColor\"\n                      strokeWidth=\"4\"\n                    ></circle>\n                    <path\n                      className=\"opacity-75\"\n                      fill=\"currentColor\"\n                      d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n                    ></path>\n                  </svg>\n                  Envoi en cours...\n                </>\n              ) : (\n                \"Confirmer le dépôt\"\n              )}\n            </Button>\n          ) : null}\n        </div>\n      </form>\n\n      {/* Auto-save Indicator */}\n      <AnimatePresence>\n        {formSaving && (\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: 20 }}\n            className=\"fixed bottom-6 left-1/2 -translate-x-1/2 z-50\"\n          >\n            <div className=\"flex items-center gap-2 px-4 py-2.5 bg-white/10 backdrop-blur-md border border-white/20 rounded-full text-sm text-white shadow-lg\">\n              <div className=\"h-2 w-2 rounded-full bg-emerald-400 animate-pulse\" />\n              <span className=\"font-medium\">Sauvegarde automatique...</span>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div >\n  );\n}\n\nexport default function DeposerPage() {\n  return (\n    <Suspense fallback={<div className=\"min-h-screen flex items-center justify-center\"><div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500\"></div></div>}>\n      <DeposerPageContent />\n    </Suspense>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\mes-biens\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\mes-biens\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShieldCheck' is defined but never used.","line":18,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":21}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperties'. Either include it or remove the dependency array.","line":103,"column":6,"nodeType":"ArrayExpression","endLine":103,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [loadProperties, user]","fix":{"range":[3202,3208],"text":"[loadProperties, user]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport Image from \"next/image\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { EmptyState } from \"@/components/ui/empty-state\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Plus, Eye, Clock, CheckCircle, XCircle, AlertCircle, Package } from \"lucide-react\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { useAuth } from \"@/hooks/use-auth\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\nimport type { Property } from \"@/types/property\";\r\nimport { PropertyCardActions } from \"./property-card-actions\";\r\nimport { VerificationUploadForm } from \"@/components/dashboard/verification-upload-form\";\r\nimport { VerifiedBadge } from \"@/components/ui/verified-badge\";\r\nimport { ShieldCheck, Timer } from \"lucide-react\";\r\n\r\ntype PropertyWithStatus = Property & {\r\n  validation_status: \"pending\" | \"payment_pending\" | \"approved\" | \"rejected\";\r\n  validation_rejection_reason?: string | null;\r\n  verification_status?: \"pending\" | \"verified\" | \"rejected\";\r\n  rejection_reason?: string | null;\r\n  views_count?: number;\r\n};\r\n\r\nconst statusConfig = {\r\n  pending: {\r\n    label: \"Vérification en cours\",\r\n    color: \"bg-amber-500/20 text-amber-300\",\r\n    icon: Clock,\r\n  },\r\n  payment_pending: {\r\n    label: \"Paiement en attente\",\r\n    color: \"bg-blue-500/20 text-blue-300\",\r\n    icon: Clock,\r\n  },\r\n  approved: {\r\n    label: \"En ligne\",\r\n    color: \"bg-emerald-500/20 text-emerald-300\",\r\n    icon: CheckCircle,\r\n  },\r\n  rejected: {\r\n    label: \"Refusé\",\r\n    color: \"bg-red-500/20 text-red-300\",\r\n    icon: XCircle,\r\n  },\r\n};\r\n\r\nexport default function MesBiensPage() {\r\n  const router = useRouter();\r\n  const { user, loading } = useAuth();\r\n  const [properties, setProperties] = useState<PropertyWithStatus[]>([]);\r\n  const [loadingProperties, setLoadingProperties] = useState(true);\r\n\r\n  const loadProperties = async () => {\r\n    if (!user) return;\r\n\r\n    const supabase = createClient();\r\n    // Récupérer TOUTES les annonces de l'utilisateur sans limite\r\n    // Supabase a une limite par défaut de 1000, mais on peut la contourner avec range()\r\n    let allProperties: PropertyWithStatus[] = [];\r\n    let from = 0;\r\n    const pageSize = 1000; // Taille maximale par requête Supabase\r\n\r\n    while (true) {\r\n      const { data, error } = await supabase\r\n        .from(\"properties\")\r\n        .select(\"*\")\r\n        .eq(\"owner_id\", user.id)\r\n        .order(\"created_at\", { ascending: false })\r\n        .range(from, from + pageSize - 1);\r\n\r\n      if (error) {\r\n        console.error(\"Error loading properties:\", error);\r\n        break;\r\n      }\r\n\r\n      if (!data || data.length === 0) {\r\n        break;\r\n      }\r\n\r\n      allProperties = [...allProperties, ...(data as PropertyWithStatus[])];\r\n\r\n      // Si on a récupéré moins que la taille de page, c'est qu'on a tout récupéré\r\n      if (data.length < pageSize) {\r\n        break;\r\n      }\r\n\r\n      from += pageSize;\r\n    }\r\n\r\n    setProperties(allProperties);\r\n    setLoadingProperties(false);\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      loadProperties();\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user]);\r\n\r\n  if (loading || loadingProperties) {\r\n    return (\r\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\r\n        <div className=\"text-white/70\">Chargement...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"space-y-6 py-6 text-center\">\r\n        <h1 className=\"text-2xl font-semibold text-white\">\r\n          Connexion requise\r\n        </h1>\r\n        <Button asChild>\r\n          <Link href=\"/login\">Se connecter</Link>\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6 py-6 text-white\">\r\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/40\">\r\n            Espace Propriétaire\r\n          </p>\r\n          <h1 className=\"text-3xl font-semibold\">Mes biens</h1>\r\n        </div>\r\n        <Button className=\"rounded-full bg-primary text-black\" asChild>\r\n          <Link href=\"/compte/deposer\">\r\n            <Plus className=\"mr-2 h-4 w-4\" />\r\n            Déposer une annonce\r\n          </Link>\r\n        </Button>\r\n      </div>\r\n\r\n      {properties.length === 0 ? (\r\n        <EmptyState\r\n          title=\"Vous n'avez pas encore déposé d'annonce\"\r\n          description=\"Déposez votre premier bien et commencez à toucher des revenus. C'est simple, rapide et gratuit avec le mandat agence.\"\r\n          actionLabel=\"Déposer mon bien\"\r\n          onAction={() => router.push(\"/compte/deposer\")}\r\n          icon={Package}\r\n        />\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4\">\r\n          {properties.map((property) => {\r\n            const status = statusConfig[property.validation_status || \"pending\"];\r\n            const StatusIcon = status.icon;\r\n\r\n            return (\r\n              <motion.div\r\n                key={property.id}\r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                className=\"group overflow-hidden rounded-2xl border border-white/10 bg-background/5 transition-all hover:border-white/20\"\r\n              >\r\n                {property.images?.[0] && (\r\n                  <div className=\"relative h-48 w-full overflow-hidden\">\r\n                    <Image\r\n                      src={property.images[0]}\r\n                      alt={property.title}\r\n                      fill\r\n                      className=\"object-cover transition-transform group-hover:scale-105\"\r\n                      sizes=\"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw\"\r\n                      quality={75}\r\n                    />\r\n                  </div>\r\n                )}\r\n                <div className=\"p-4\">\r\n                  <div className=\"mb-2 flex items-start justify-between gap-2\">\r\n                    <h3 className=\"flex-1 font-semibold text-white line-clamp-2\">\r\n                      {property.title}\r\n                    </h3>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      {/* Status Certification */}\r\n                      {property.verification_status === \"verified\" ? (\r\n                        <VerifiedBadge size=\"sm\" />\r\n                      ) : property.verification_status === \"pending\" ? (\r\n                        <div className=\"flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2 py-1 text-xs text-white/50\">\r\n                          <Timer className=\"h-3 w-3\" />\r\n                          <span>Vérif. en cours</span>\r\n                        </div>\r\n                      ) : (\r\n                        // Afficher le bouton seulement si le bien a un statut de base \"approved\" ou \"payment_pending\"\r\n                        // Pour éviter de certifier des brouillons ou des biens rejetés par la modération principale\r\n                        (!property.verification_status || property.verification_status === \"rejected\") &&\r\n                        (property.validation_status === \"approved\" || property.validation_status === \"pending\") && (\r\n                          <VerificationUploadForm propertyId={property.id} />\r\n                        )\r\n                      )}\r\n\r\n                      <span\r\n                        className={`flex items-center gap-1 rounded-full px-2 py-1 text-xs font-semibold ${status.color}`}\r\n                      >\r\n                        <StatusIcon className=\"h-3 w-3\" />\r\n                        {status.label}\r\n                      </span>\r\n                      <PropertyCardActions\r\n                        propertyId={property.id}\r\n                        validationStatus={property.validation_status || \"pending\"}\r\n                        status={property.status || \"disponible\"}\r\n                      />\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Feedback de refus */}\r\n                  {property.validation_status === \"rejected\" && property.rejection_reason && (\r\n                    <div className=\"mb-3 rounded-lg border border-red-500/20 bg-red-500/10 p-3\">\r\n                      <div className=\"flex items-start gap-2\">\r\n                        <AlertCircle className=\"h-4 w-4 text-red-300 mt-0.5 flex-shrink-0\" />\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-semibold text-red-300 mb-1\">\r\n                            Refusé\r\n                          </p>\r\n                          <p className=\"text-xs text-red-200/80\">\r\n                            {property.rejection_reason}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  <p className=\"mb-3 text-lg font-bold text-amber-400\">\r\n                    {new Intl.NumberFormat(\"fr-SN\", {\r\n                      maximumFractionDigits: 0,\r\n                    }).format(property.price)}{\" \"}\r\n                    FCFA\r\n                  </p>\r\n\r\n                  <p className=\"mb-4 text-sm text-white/60\">\r\n                    {property.location.city}\r\n                    {(property.location as { district?: string }).district &&\r\n                      `, ${(property.location as { district?: string }).district}`\r\n                    }\r\n                  </p>\r\n\r\n                  {property.validation_status === \"approved\" && (\r\n                    <div className=\"flex items-center gap-2 text-sm text-white/50\">\r\n                      <Eye className=\"h-4 w-4\" />\r\n                      <span>\r\n                        {property.views_count || 0} vue{(property.views_count || 0) > 1 ? \"s\" : \"\"}\r\n                      </span>\r\n                    </div>\r\n                  )}\r\n\r\n                  <Button\r\n                    variant=\"secondary\"\r\n                    className=\"mt-4 w-full rounded-full bg-background/5 border border-white/10\"\r\n                    asChild\r\n                  >\r\n                    <Link href={`/biens/${property.id}`}>Voir l&apos;annonce</Link>\r\n                  </Button>\r\n                </div>\r\n              </motion.div>\r\n            );\r\n          })}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\mes-biens\\property-card-actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\mes-documents\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\mes-documents\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MapPin' is defined but never used.","line":18,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":153,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":153,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":300,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":300,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatFileSize' is assigned a value but never used.","line":305,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":305,"endColumn":23},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":478,"column":87,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[18672,18695],"text":"Aucune pièce d&apos;identité"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[18672,18695],"text":"Aucune pièce d&lsquo;identité"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[18672,18695],"text":"Aucune pièce d&#39;identité"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[18672,18695],"text":"Aucune pièce d&rsquo;identité"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":514,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[20982,21063],"text":"\r\n                            Vérification d&apos;identité\r\n                          "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[20982,21063],"text":"\r\n                            Vérification d&lsquo;identité\r\n                          "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[20982,21063],"text":"\r\n                            Vérification d&#39;identité\r\n                          "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[20982,21063],"text":"\r\n                            Vérification d&rsquo;identité\r\n                          "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":524,"column":67,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[21675,21676],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[21675,21676],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[21675,21676],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[21675,21676],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":524,"column":90,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[21698,21699],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[21698,21699],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[21698,21699],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[21698,21699],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":629,"column":67,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[28058,28059],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[28058,28059],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[28058,28059],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[28058,28059],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":629,"column":90,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[28081,28082],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[28081,28082],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[28081,28082],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[28081,28082],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  LockKey,\r\n  ShieldCheck,\r\n  FileText,\r\n  DownloadSimple,\r\n  Trash,\r\n  UploadSimple,\r\n  Eye,\r\n  WarningCircle,\r\n  CheckCircle,\r\n  UserCheck,\r\n  House,\r\n  Fingerprint,\r\n  MapPin,\r\n} from \"@phosphor-icons/react\";\r\nimport { toast } from \"sonner\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { EmptyState } from \"@/components/ui/empty-state\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { uploadDocument, getMyDocuments, deleteDocument, getVerificationDocuments, refreshDocumentUrl } from \"./actions\";\r\n\r\ntype Document = {\r\n  id: string;\r\n  name: string;\r\n  type: string;\r\n  size: number;\r\n  url: string;\r\n  uploaded_at: string;\r\n  source: \"manual\" | \"verification\";\r\n  certification_scope?: \"global\" | \"specific\";\r\n  is_certified?: boolean;\r\n  rejection_reason?: string;\r\n};\r\n\r\nconst documentTypes = [\r\n  { value: \"titre_propriete\", label: \"Titre de Propriété\" },\r\n  { value: \"bail\", label: \"Bail / Contrat de Location\" },\r\n  { value: \"cni\", label: \"CNI / Passeport\" },\r\n  { value: \"facture\", label: \"Facture (Eau, Électricité)\" },\r\n  { value: \"attestation\", label: \"Attestation Fiscale\" },\r\n  { value: \"autre\", label: \"Autre Document\" },\r\n];\r\n\r\nexport default function MesDocumentsPage() {\r\n  const [documents, setDocuments] = useState<Document[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [uploading, setUploading] = useState(false);\r\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n  const [selectedType, setSelectedType] = useState<string>(\"\");\r\n  const [dialogOpen, setDialogOpen] = useState(false);\r\n\r\n  useEffect(() => {\r\n    loadDocuments();\r\n  }, []);\r\n\r\n  const loadDocuments = async () => {\r\n    console.log(\"🔍 [CLIENT] loadDocuments - Début\");\r\n    setLoading(true);\r\n    try {\r\n      // Récupérer les documents manuels\r\n      console.log(\"🔍 [CLIENT] Appel getMyDocuments()...\");\r\n      const manualDocs = await getMyDocuments();\r\n      console.log(\"🔍 [CLIENT] manualDocs:\", manualDocs);\r\n\r\n      // Récupérer les documents de certification (annonces certifiées)\r\n      console.log(\"🔍 [CLIENT] Appel getVerificationDocuments()...\");\r\n      const verificationDocs = await getVerificationDocuments();\r\n      console.log(\"🔍 [CLIENT] verificationDocs:\", verificationDocs);\r\n\r\n      // Combiner les documents (même si l'un des deux échoue)\r\n      const manualDocsArray = manualDocs.success ? (manualDocs.data || []) : [];\r\n      const verificationDocsArray = verificationDocs.success ? (verificationDocs.data || []) : [];\r\n\r\n      // Filtrer et combiner les documents valides\r\n      const allDocs = [\r\n        ...manualDocsArray.filter(doc => doc !== null),\r\n        ...verificationDocsArray.filter(doc => doc !== null),\r\n      ] as Document[];\r\n\r\n      console.log(\"✅ [CLIENT] Total documents:\", allDocs.length);\r\n      console.log(\"✅ [CLIENT] Documents manuels:\", manualDocs.success ? manualDocs.data?.length : 0);\r\n      console.log(\"✅ [CLIENT] Documents certifiés:\", verificationDocs.success ? verificationDocs.data?.length : 0);\r\n      console.log(\"📋 [CLIENT] Détails des documents certifiés:\",\r\n        verificationDocsArray.filter(d => d !== null).map(d => ({\r\n          name: d.name,\r\n          type: d.type,\r\n          scope: d.certification_scope,\r\n          is_certified: d.is_certified\r\n        }))\r\n      );\r\n\r\n      setDocuments(allDocs);\r\n\r\n      // Afficher un warning si getVerificationDocuments a échoué\r\n      if (!verificationDocs.success) {\r\n        console.warn(\"⚠️ [CLIENT] getVerificationDocuments a échoué:\", verificationDocs.error);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"❌ [CLIENT] Exception:\", error);\r\n      toast.error(\"Erreur lors du chargement des documents\");\r\n    } finally {\r\n      setLoading(false);\r\n      console.log(\"🔍 [CLIENT] loadDocuments - Fin\");\r\n    }\r\n  };\r\n\r\n  const handleUpload = async () => {\r\n    if (!selectedFile || !selectedType) {\r\n      toast.error(\"Veuillez sélectionner un fichier et un type de document\");\r\n      return;\r\n    }\r\n\r\n    setUploading(true);\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append(\"file\", selectedFile);\r\n      formData.append(\"type\", selectedType);\r\n\r\n      const result = await uploadDocument(formData);\r\n\r\n      if (result.success) {\r\n        toast.success(\"Document ajouté au coffre-fort\", {\r\n          description: \"Votre document est maintenant sécurisé\",\r\n        });\r\n        setDialogOpen(false);\r\n        setSelectedFile(null);\r\n        setSelectedType(\"\");\r\n        loadDocuments();\r\n      } else {\r\n        toast.error(result.error || \"Erreur lors de l'upload\");\r\n      }\r\n    } catch (error) {\r\n      toast.error(\"Erreur lors de l'upload du document\");\r\n    } finally {\r\n      setUploading(false);\r\n    }\r\n  };\r\n\r\n  const handleDownload = async (url: string, filename: string, docId: string, docSource: \"manual\" | \"verification\") => {\r\n    console.group(`🔍 [DEBUG] Téléchargement: ${filename}`);\r\n    console.log(\"🔗 URL Signée:\", url);\r\n\r\n    try {\r\n      // 1. Tenter de récupérer le fichier\r\n      const response = await fetch(url);\r\n\r\n      console.log(\"📡 Status HTTP:\", response.status);\r\n      console.log(\"📄 Content-Type:\", response.headers.get(\"content-type\"));\r\n\r\n      // Si Supabase renvoie une erreur (400, 403, 404) => URL expirée\r\n      if (!response.ok) {\r\n        console.warn(\"⚠️ URL peut-être expirée, tentative de régénération...\");\r\n\r\n        // Tenter de régénérer l'URL\r\n        const refreshResult = await refreshDocumentUrl(docId, docSource);\r\n\r\n        if (refreshResult.success && refreshResult.data?.url) {\r\n          console.log(\"✅ URL régénérée, nouvelle tentative de téléchargement...\");\r\n\r\n          // Réessayer avec la nouvelle URL\r\n          const retryResponse = await fetch(refreshResult.data.url);\r\n\r\n          if (!retryResponse.ok) {\r\n            throw new Error(`Erreur HTTP ${retryResponse.status} - Impossible de récupérer le fichier même après régénération`);\r\n          }\r\n\r\n          const blob = await retryResponse.blob();\r\n          console.log(\"📦 Taille du fichier (retry):\", blob.size, \"octets\");\r\n\r\n          // Télécharger le fichier\r\n          const downloadUrl = window.URL.createObjectURL(blob);\r\n          const link = document.createElement(\"a\");\r\n          link.href = downloadUrl;\r\n          link.download = filename;\r\n          document.body.appendChild(link);\r\n          link.click();\r\n          document.body.removeChild(link);\r\n          window.URL.revokeObjectURL(downloadUrl);\r\n\r\n          console.log(\"✅ Téléchargement réussi après régénération\");\r\n          toast.success(\"Téléchargement lancé\");\r\n\r\n          // Recharger les documents pour rafraîchir les URLs\r\n          loadDocuments();\r\n          console.groupEnd();\r\n          return;\r\n        } else {\r\n          throw new Error(`Impossible de régénérer l'URL: ${refreshResult.error}`);\r\n        }\r\n      }\r\n\r\n      // 2. Vérifier le contenu\r\n      const blob = await response.blob();\r\n      console.log(\"📦 Taille du fichier:\", blob.size, \"octets\");\r\n      console.log(\"📦 Type du Blob:\", blob.type);\r\n\r\n      // Si le fichier est minuscule (<1KB), c'est souvent une erreur texte cachée\r\n      if (blob.size < 500) {\r\n        const textError = await blob.text();\r\n        console.error(\"⚠️ Le fichier semble être une erreur texte:\", textError);\r\n\r\n        // Tenter de régénérer l'URL\r\n        console.warn(\"⚠️ Fichier trop petit, tentative de régénération...\");\r\n        const refreshResult = await refreshDocumentUrl(docId, docSource);\r\n\r\n        if (refreshResult.success && refreshResult.data?.url) {\r\n          console.log(\"✅ URL régénérée, nouvelle tentative...\");\r\n          const retryResponse = await fetch(refreshResult.data.url);\r\n          const retryBlob = await retryResponse.blob();\r\n\r\n          if (retryBlob.size < 500) {\r\n            toast.error(\"Fichier corrompu\", {\r\n              description: \"Le fichier reçu est trop petit ou vide.\",\r\n            });\r\n            console.groupEnd();\r\n            return;\r\n          }\r\n\r\n          // Télécharger le fichier régénéré\r\n          const downloadUrl = window.URL.createObjectURL(retryBlob);\r\n          const link = document.createElement(\"a\");\r\n          link.href = downloadUrl;\r\n          link.download = filename;\r\n          document.body.appendChild(link);\r\n          link.click();\r\n          document.body.removeChild(link);\r\n          window.URL.revokeObjectURL(downloadUrl);\r\n\r\n          console.log(\"✅ Téléchargement réussi après régénération\");\r\n          toast.success(\"Téléchargement lancé\");\r\n\r\n          // Recharger les documents\r\n          loadDocuments();\r\n          console.groupEnd();\r\n          return;\r\n        }\r\n\r\n        toast.error(\"Fichier corrompu\", {\r\n          description: \"Le fichier reçu est trop petit ou vide.\",\r\n        });\r\n        console.groupEnd();\r\n        return;\r\n      }\r\n\r\n      // 3. Créer le téléchargement forcé\r\n      const downloadUrl = window.URL.createObjectURL(blob);\r\n      const link = document.createElement(\"a\");\r\n      link.href = downloadUrl;\r\n      link.download = filename;\r\n      document.body.appendChild(link);\r\n      link.click();\r\n      document.body.removeChild(link);\r\n      window.URL.revokeObjectURL(downloadUrl);\r\n\r\n      console.log(\"✅ Téléchargement déclenché\");\r\n      toast.success(\"Téléchargement lancé\");\r\n    } catch (error) {\r\n      console.error(\"❌ Erreur critique:\", error);\r\n      toast.error(\"Erreur de téléchargement\", {\r\n        description: error instanceof Error ? error.message : \"Impossible de télécharger ce document.\",\r\n      });\r\n    } finally {\r\n      console.groupEnd();\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (documentId: string) => {\r\n    if (!confirm(\"Êtes-vous sûr de vouloir supprimer ce document ?\")) return;\r\n\r\n    try {\r\n      const result = await deleteDocument(documentId);\r\n\r\n      if (result.success) {\r\n        toast.success(\"Document supprimé\");\r\n        loadDocuments();\r\n      } else {\r\n        toast.error(result.error || \"Erreur lors de la suppression\");\r\n      }\r\n    } catch (error) {\r\n      toast.error(\"Erreur lors de la suppression\");\r\n    }\r\n  };\r\n\r\n  const formatFileSize = (bytes: number) => {\r\n    if (bytes < 1024) return bytes + \" B\";\r\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + \" KB\";\r\n    return (bytes / (1024 * 1024)).toFixed(1) + \" MB\";\r\n  };\r\n\r\n  const getDocumentIcon = (type: string, isIdentity: boolean = false) => {\r\n    if (isIdentity) {\r\n      return <Fingerprint weight=\"light\" className=\"h-7 w-7 text-blue-400\" />;\r\n    }\r\n    return <FileText weight=\"light\" className=\"h-7 w-7 text-emerald-400\" />;\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-b from-background via-background to-black px-4 py-12\">\r\n      <div className=\"mx-auto max-w-6xl\">\r\n        {/* Header */}\r\n        <motion.div\r\n          initial={{ opacity: 0, y: 20 }}\r\n          animate={{ opacity: 1, y: 0 }}\r\n          className=\"mb-8\"\r\n        >\r\n          <div className=\"flex items-center gap-3 mb-4\">\r\n            <div className=\"rounded-2xl bg-primary/10 p-3 border border-primary/20\">\r\n              <LockKey weight=\"light\" className=\"h-8 w-8 text-primary\" />\r\n            </div>\r\n            <div>\r\n              <h1 className=\"text-3xl font-bold text-white\">Mes Documents</h1>\r\n              <p className=\"text-white/60\">Coffre-fort numérique ultra-sécurisé</p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Security Badges */}\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            <span className=\"inline-flex items-center gap-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-400\">\r\n              <ShieldCheck weight=\"light\" className=\"h-3.5 w-3.5\" />\r\n              Chiffré AES-256\r\n            </span>\r\n            <span className=\"inline-flex items-center gap-1.5 rounded-full bg-primary/10 border border-primary/20 px-3 py-1 text-xs font-semibold text-primary\">\r\n              <LockKey weight=\"light\" className=\"h-3.5 w-3.5\" />\r\n              Confidentiel\r\n            </span>\r\n            <span className=\"inline-flex items-center gap-1.5 rounded-full bg-blue-500/10 border border-blue-500/20 px-3 py-1 text-xs font-semibold text-blue-400\">\r\n              <CheckCircle weight=\"light\" className=\"h-3.5 w-3.5\" />\r\n              Accès Privé\r\n            </span>\r\n          </div>\r\n        </motion.div>\r\n\r\n        {/* Upload Button */}\r\n        <motion.div\r\n          initial={{ opacity: 0, y: 20 }}\r\n          animate={{ opacity: 1, y: 0 }}\r\n          transition={{ delay: 0.1 }}\r\n          className=\"mb-6\"\r\n        >\r\n          <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\r\n            <DialogTrigger asChild>\r\n              <Button className=\"bg-primary text-black hover:bg-primary/90 font-semibold\">\r\n                <UploadSimple weight=\"light\" className=\"mr-2 h-4 w-4\" />\r\n                Ajouter un document\r\n              </Button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"bg-[#121212] border-primary/20\">\r\n              <DialogHeader>\r\n                <DialogTitle className=\"text-white\">Ajouter un document</DialogTitle>\r\n                <DialogDescription className=\"text-white/60\">\r\n                  Téléversez un document dans votre coffre-fort sécurisé\r\n                </DialogDescription>\r\n              </DialogHeader>\r\n\r\n              <div className=\"space-y-4 pt-4\">\r\n                <div>\r\n                  <Label htmlFor=\"document-type\" className=\"text-white/70\">\r\n                    Type de document\r\n                  </Label>\r\n                  <Select value={selectedType} onValueChange={setSelectedType}>\r\n                    <SelectTrigger className=\"mt-2 bg-background border-white/10 text-white\">\r\n                      <SelectValue placeholder=\"Sélectionnez le type\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent className=\"bg-[#121212] border-white/10\">\r\n                      {documentTypes.map((type) => (\r\n                        <SelectItem\r\n                          key={type.value}\r\n                          value={type.value}\r\n                          className=\"text-white hover:bg-white/10\"\r\n                        >\r\n                          {type.label}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                <div>\r\n                  <Label htmlFor=\"file\" className=\"text-white/70\">\r\n                    Fichier\r\n                  </Label>\r\n                  <Input\r\n                    id=\"file\"\r\n                    type=\"file\"\r\n                    accept=\".pdf,.jpg,.jpeg,.png\"\r\n                    onChange={(e) => setSelectedFile(e.target.files?.[0] || null)}\r\n                    className=\"mt-2 bg-background border-white/10 text-white file:bg-primary file:text-black file:border-0 file:rounded-lg file:px-4 file:py-2 file:font-semibold\"\r\n                  />\r\n                  <p className=\"mt-1 text-xs text-white/50\">\r\n                    PDF, JPG ou PNG • Max 10 MB\r\n                  </p>\r\n                </div>\r\n\r\n                <Button\r\n                  onClick={handleUpload}\r\n                  disabled={!selectedFile || !selectedType || uploading}\r\n                  className=\"w-full bg-primary text-black hover:bg-primary/90 font-semibold\"\r\n                >\r\n                  {uploading ? \"Upload en cours...\" : \"Ajouter au coffre-fort\"}\r\n                </Button>\r\n              </div>\r\n            </DialogContent>\r\n          </Dialog>\r\n        </motion.div>\r\n\r\n        {/* Documents Grid */}\r\n        {loading ? (\r\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\r\n            {[...Array(6)].map((_, i) => (\r\n              <Card key={i} className=\"bg-background border-white/10 p-6 animate-pulse\">\r\n                <div className=\"h-24 bg-white/5 rounded-xl\" />\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        ) : documents.length === 0 ? (\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ delay: 0.2 }}\r\n          >\r\n            <EmptyState\r\n              title=\"Votre coffre-fort est vide\"\r\n              description=\"Commencez par ajouter vos documents importants\"\r\n              actionLabel=\"Ajouter mon premier document\"\r\n              onAction={() => setDialogOpen(true)}\r\n              icon={undefined} // Using children for Phosphor icon\r\n            >\r\n              <LockKey weight=\"light\" className=\"h-10 w-10 text-white/40\" />\r\n            </EmptyState>\r\n          </motion.div>\r\n        ) : (\r\n          <div className=\"space-y-12\">\r\n            {/* SECTION IDENTITÉ */}\r\n            <motion.section\r\n              initial={{ opacity: 0, y: 20 }}\r\n              animate={{ opacity: 1, y: 0 }}\r\n              transition={{ delay: 0.2 }}\r\n            >\r\n              <div className=\"flex items-center gap-3 mb-4\">\r\n                <div className=\"rounded-xl bg-blue-500/10 p-2.5 border border-blue-500/20\">\r\n                  <UserCheck weight=\"light\" className=\"h-6 w-6 text-blue-400\" />\r\n                </div>\r\n                <div>\r\n                  <h2 className=\"text-2xl font-bold text-blue-400\">Mon Identité Officielle</h2>\r\n                  <p className=\"text-sm text-white/50\">Ces documents permettent de certifier votre profil sur toute la plateforme</p>\r\n                </div>\r\n              </div>\r\n\r\n              {(() => {\r\n                const identityDocs = documents.filter(doc => doc.certification_scope === 'global');\r\n                console.log(\"🔍 [CLIENT] Documents d'identité filtrés (scope='global'):\", identityDocs.length);\r\n                console.log(\"📋 [CLIENT] Tous les documents disponibles:\", documents.map(d => ({ name: d.name, scope: d.certification_scope })));\r\n                return identityDocs.length === 0;\r\n              })() ? (\r\n                <Card className=\"bg-background border-white/10 p-8 text-center\">\r\n                  <ShieldCheck weight=\"light\" className=\"h-12 w-12 mx-auto mb-3 text-white/20\" />\r\n                  <h3 className=\"text-lg font-semibold text-white mb-1\">Aucune pièce d'identité</h3>\r\n                  <p className=\"text-sm text-white/50\">Ajoutez votre CNI ou passeport pour être vérifié</p>\r\n                </Card>\r\n              ) : (\r\n                <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\r\n                  {documents.filter(doc => doc.certification_scope === 'global').map((doc, index) => (\r\n                    <motion.div\r\n                      key={doc.id}\r\n                      initial={{ opacity: 0, y: 20 }}\r\n                      animate={{ opacity: 1, y: 0 }}\r\n                      transition={{ delay: 0.1 * index }}\r\n                    >\r\n                      <Card className={`group relative bg-gray-900/40 p-5 transition-all rounded-[22px] hover:shadow-2xl ${doc.is_certified\r\n                        ? \"border-2 border-blue-500/40 shadow-[0_0_20px_rgba(59,130,246,0.15)]\"\r\n                        : \"border border-gray-800/60 hover:border-blue-500/30 hover:shadow-blue-500/5\"\r\n                        }`}>\r\n                        {doc.is_certified && (\r\n                          <div className=\"absolute -right-2 -top-2 bg-blue-500/90 text-white px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg z-10 flex items-center gap-1.5\">\r\n                            <ShieldCheck weight=\"fill\" size={14} />\r\n                            Profil Vérifié\r\n                          </div>\r\n                        )}\r\n                        <div className=\"flex items-start justify-between mb-6\">\r\n                          <div className=\"rounded-2xl bg-blue-500/10 p-3\">\r\n                            {getDocumentIcon(doc.type, true)}\r\n                          </div>\r\n                          {doc.source === \"verification\" && (\r\n                            <span className=\"rounded-full bg-blue-500/5 border border-blue-500/20 px-3 py-1.5 text-[10px] font-bold tracking-widest uppercase text-blue-400\">\r\n                              VÉRIFIÉ\r\n                            </span>\r\n                          )}\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1\">\r\n                          <h3 className=\"text-sm font-semibold text-gray-100 truncate\">{doc.name}</h3>\r\n                          <p className=\"text-[11px] text-gray-500 flex items-center gap-1\">\r\n                            Vérification d'identité\r\n                          </p>\r\n                        </div>\r\n\r\n                        {/* Affichage de la raison du rejet/révocation */}\r\n                        {!doc.is_certified && doc.rejection_reason && (\r\n                          <div className=\"mt-3 p-3 bg-red-500/10 border border-red-500/20 rounded-xl text-xs text-red-400 mb-4\">\r\n                            <p className=\"font-bold flex items-center gap-1.5 mb-1.5\">\r\n                              <WarningCircle weight=\"light\" className=\"w-3.5 h-3.5\" /> Motif du refus :\r\n                            </p>\r\n                            <p className=\"italic text-red-300/90\">\"{doc.rejection_reason}\"</p>\r\n                          </div>\r\n                        )}\r\n\r\n                        <div className=\"flex gap-2 mt-6\">\r\n                          <button\r\n                            className=\"flex-1 flex items-center justify-center gap-2 py-2.5 bg-gray-800/50 hover:bg-gray-700/50 rounded-xl text-xs font-medium transition-colors border border-gray-700/50 text-white disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                            onClick={() => {\r\n                              if (doc.url) {\r\n                                window.open(doc.url, \"_blank\", \"noopener,noreferrer\");\r\n                              } else {\r\n                                toast.error(\"Lien indisponible\");\r\n                              }\r\n                            }}\r\n                            disabled={!doc.url}\r\n                          >\r\n                            <Eye weight=\"light\" size={16} /> Voir\r\n                          </button>\r\n                          <button\r\n                            className=\"flex-1 flex items-center justify-center gap-2 py-2.5 bg-gray-800/50 hover:bg-gray-700/50 rounded-xl text-xs font-medium transition-colors border border-gray-700/50 text-white\"\r\n                            onClick={() => handleDownload(doc.url, doc.name, doc.id, doc.source)}\r\n                          >\r\n                            <DownloadSimple weight=\"light\" size={16} /> Télécharger\r\n                          </button>\r\n                          {doc.source === \"manual\" && (\r\n                            <button\r\n                              className=\"p-2.5 bg-gray-800/50 hover:bg-red-500/20 text-red-400 rounded-xl border border-gray-700/50 hover:border-red-500/30 transition-colors\"\r\n                              onClick={() => handleDelete(doc.id)}\r\n                            >\r\n                              <Trash weight=\"light\" size={16} />\r\n                            </button>\r\n                          )}\r\n                        </div>\r\n                      </Card>\r\n                    </motion.div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </motion.section>\r\n\r\n            {/* SECTION PROPRIÉTÉS */}\r\n            <motion.section\r\n              initial={{ opacity: 0, y: 20 }}\r\n              animate={{ opacity: 1, y: 0 }}\r\n              transition={{ delay: 0.3 }}\r\n            >\r\n              <div className=\"flex items-center gap-3 mb-4\">\r\n                <div className=\"rounded-xl bg-emerald-500/10 p-2.5 border border-emerald-500/20\">\r\n                  <House weight=\"light\" className=\"h-6 w-6 text-emerald-400\" />\r\n                </div>\r\n                <div>\r\n                  <h2 className=\"text-2xl font-bold text-emerald-400\">Mes Titres de Propriété Certifiés</h2>\r\n                  <p className=\"text-sm text-white/50\">Ces documents sont utilisés pour certifier vos annonces immobilières spécifiques</p>\r\n                </div>\r\n              </div>\r\n\r\n              {documents.filter(doc => doc.certification_scope !== 'global').length === 0 ? (\r\n                <Card className=\"bg-background border-white/10 p-8 text-center\">\r\n                  <FileText weight=\"light\" className=\"h-12 w-12 mx-auto mb-3 text-white/20\" />\r\n                  <h3 className=\"text-lg font-semibold text-white mb-1\">Aucun titre de propriété</h3>\r\n                  <p className=\"text-sm text-white/50\">Ajoutez vos documents de propriété pour certifier vos annonces</p>\r\n                </Card>\r\n              ) : (\r\n                <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\r\n                  {documents.filter(doc => doc.certification_scope !== 'global').map((doc, index) => (\r\n                    <motion.div\r\n                      key={doc.id}\r\n                      initial={{ opacity: 0, y: 20 }}\r\n                      animate={{ opacity: 1, y: 0 }}\r\n                      transition={{ delay: 0.1 * index }}\r\n                    >\r\n                      <Card className={`group relative bg-gray-900/40 p-5 transition-all rounded-[22px] hover:shadow-2xl ${doc.is_certified\r\n                        ? \"border-2 border-emerald-500/40 shadow-[0_0_20px_rgba(16,185,129,0.15)]\"\r\n                        : \"border border-gray-800/60 hover:border-emerald-500/30 hover:shadow-emerald-500/5\"\r\n                        }`}>\r\n                        {doc.is_certified && (\r\n                          <div className=\"absolute -right-2 -top-2 bg-emerald-500/90 text-white px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg z-10 flex items-center gap-1.5\">\r\n                            <CheckCircle weight=\"fill\" size={14} />\r\n                            Annonce Certifiée\r\n                          </div>\r\n                        )}\r\n                        <div className=\"flex items-start justify-between mb-6\">\r\n                          <div className=\"rounded-2xl bg-emerald-500/10 p-3\">\r\n                            {getDocumentIcon(doc.type, false)}\r\n                          </div>\r\n                          {doc.source === \"verification\" && (\r\n                            <span className=\"rounded-full bg-emerald-500/5 border border-emerald-500/20 px-3 py-1.5 text-[10px] font-bold tracking-widest uppercase text-emerald-400\">\r\n                              CERTIFIÉ\r\n                            </span>\r\n                          )}\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1\">\r\n                          <h3 className=\"text-sm font-semibold text-gray-100 truncate\">{doc.name}</h3>\r\n                          <p className=\"text-[11px] text-gray-500 flex items-center gap-1\">\r\n                            Preuve de propriété\r\n                          </p>\r\n                        </div>\r\n\r\n                        {/* Affichage de la raison du rejet/révocation */}\r\n                        {!doc.is_certified && doc.rejection_reason && (\r\n                          <div className=\"mt-3 p-3 bg-red-500/10 border border-red-500/20 rounded-xl text-xs text-red-400 mb-4\">\r\n                            <p className=\"font-bold flex items-center gap-1.5 mb-1.5\">\r\n                              <WarningCircle weight=\"light\" className=\"w-3.5 h-3.5\" /> Motif du refus :\r\n                            </p>\r\n                            <p className=\"italic text-red-300/90\">\"{doc.rejection_reason}\"</p>\r\n                          </div>\r\n                        )}\r\n\r\n                        <div className=\"flex gap-2 mt-6\">\r\n                          <button\r\n                            className=\"flex-1 flex items-center justify-center gap-2 py-2.5 bg-gray-800/50 hover:bg-gray-700/50 rounded-xl text-xs font-medium transition-colors border border-gray-700/50 text-white disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                            onClick={() => {\r\n                              if (doc.url) {\r\n                                window.open(doc.url, \"_blank\", \"noopener,noreferrer\");\r\n                              } else {\r\n                                toast.error(\"Lien indisponible\");\r\n                              }\r\n                            }}\r\n                            disabled={!doc.url}\r\n                          >\r\n                            <Eye weight=\"light\" size={16} /> Voir\r\n                          </button>\r\n                          <button\r\n                            className=\"flex-1 flex items-center justify-center gap-2 py-2.5 bg-gray-800/50 hover:bg-gray-700/50 rounded-xl text-xs font-medium transition-colors border border-gray-700/50 text-white\"\r\n                            onClick={() => handleDownload(doc.url, doc.name, doc.id, doc.source)}\r\n                          >\r\n                            <DownloadSimple weight=\"light\" size={16} /> Télécharger\r\n                          </button>\r\n                          {doc.source === \"manual\" && (\r\n                            <button\r\n                              className=\"p-2.5 bg-gray-800/50 hover:bg-red-500/20 text-red-400 rounded-xl border border-gray-700/50 hover:border-red-500/30 transition-colors\"\r\n                              onClick={() => handleDelete(doc.id)}\r\n                            >\r\n                              <Trash weight=\"light\" size={16} />\r\n                            </button>\r\n                          )}\r\n                        </div>\r\n                      </Card>\r\n                    </motion.div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </motion.section>\r\n          </div>\r\n        )}\r\n\r\n        {/* Info Banner */}\r\n        <motion.div\r\n          initial={{ opacity: 0, y: 20 }}\r\n          animate={{ opacity: 1, y: 0 }}\r\n          transition={{ delay: 0.3 }}\r\n          className=\"mt-8\"\r\n        >\r\n          <Card className=\"bg-blue-500/5 border-blue-500/20 p-6\">\r\n            <div className=\"flex gap-4\">\r\n              <div className=\"rounded-xl bg-blue-500/10 p-3 border border-blue-500/20 h-fit\">\r\n                <WarningCircle weight=\"light\" className=\"h-5 w-5 text-blue-400\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-semibold text-white mb-2\">\r\n                  Vos documents sont en sécurité\r\n                </h3>\r\n                <ul className=\"space-y-1 text-sm text-white/60\">\r\n                  <li>• Chiffrement AES-256 de bout en bout</li>\r\n                  <li>• Accès privé (vous uniquement + administrateurs autorisés)</li>\r\n                  <li>• Stockage sécurisé sur serveurs européens</li>\r\n                  <li>• Les documents de certification sont automatiquement ajoutés ici</li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          </Card>\r\n        </motion.div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LayoutDashboard' is defined but never used.","line":18,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { getDashboardStats } from \"./actions\";\r\nimport {\r\n  Heart,\r\n  Building2,\r\n  Plus,\r\n  Bell,\r\n  User,\r\n  ShieldCheck,\r\n  LogOut,\r\n  ArrowRight,\r\n  Lock,\r\n  LayoutDashboard,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Card,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport {\r\n  Avatar,\r\n  AvatarFallback,\r\n  AvatarImage,\r\n} from \"@/components/ui/avatar\";\r\nimport { useAuth } from \"@/hooks/use-auth\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\nimport { useFavoritesStore } from \"@/store/use-store\";\r\nimport { FadeIn } from \"@/components/ui/motion-wrapper\";\r\nimport { useUserRoles } from \"@/hooks/use-user-roles\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { ROLE_COLORS, ROLE_LABELS } from \"@/config/roles\";\r\nimport { GestionLocativeWidget } from \"./components/GestionLocativeWidget\";\r\nimport { LegalAssistantWidget } from \"./components/LegalAssistantWidget\";\r\n\r\nexport default function ComptePage() {\r\n  const { user, loading } = useAuth();\r\n  const router = useRouter();\r\n  const { favorites } = useFavoritesStore();\r\n  const { roles: userRoles, loading: rolesLoading } = useUserRoles(user?.id || null);\r\n  const [stats, setStats] = useState({ activeLeases: 0, pendingPayments: 0, maintenanceRequests: 0 });\r\n\r\n  useEffect(() => {\r\n    async function loadStats() {\r\n      if (user?.id) {\r\n        const data = await getDashboardStats();\r\n        setStats(data);\r\n      }\r\n    }\r\n    loadStats();\r\n  }, [user?.id]);\r\n\r\n  // Check if user is admin (email fallback) or has any role\r\n  const adminEmail = process.env.NEXT_PUBLIC_ADMIN_EMAIL;\r\n  const isMainAdmin = adminEmail && user?.email?.toLowerCase() === adminEmail.toLowerCase();\r\n  const hasRole = userRoles.length > 0 || isMainAdmin;\r\n\r\n  const handleSignOut = async () => {\r\n    try {\r\n      const supabase = createClient();\r\n      const { error } = await supabase.auth.signOut();\r\n\r\n      if (error) {\r\n        throw error;\r\n      }\r\n\r\n      toast.success(\"Déconnexion réussie\");\r\n\r\n      // Redirect to login page\r\n      router.push(\"/login\");\r\n      router.refresh();\r\n    } catch (error) {\r\n      console.error(\"Sign out error:\", error);\r\n      toast.error(\"Erreur lors de la déconnexion\");\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\r\n        <div className=\"text-zinc-400\">Chargement...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return null; // Let middleware handle redirect\r\n  }\r\n\r\n  // Récupérer le prénom\r\n  const firstName =\r\n    (user.user_metadata?.full_name as string)?.split(\" \")[0] ||\r\n    user.email?.split(\"@\")[0] ||\r\n    \"Utilisateur\";\r\n\r\n  const displayName =\r\n    (user.user_metadata?.full_name as string) ||\r\n    user.email?.split(\"@\")[0] ||\r\n    \"Utilisateur\";\r\n\r\n  const initials = displayName\r\n    .split(\" \")\r\n    .map((n) => n[0])\r\n    .join(\"\")\r\n    .toUpperCase()\r\n    .slice(0, 2) || \"U\";\r\n\r\n  return (\r\n    <div className=\"space-y-8 py-6\">\r\n      <FadeIn>\r\n        {/* Header Utilisateur */}\r\n        <div className=\"mb-8 flex items-start gap-4\">\r\n          <Avatar className=\"h-14 w-14 shrink-0 border border-zinc-800\">\r\n            <AvatarImage src={user.user_metadata?.avatar_url as string} alt={displayName} />\r\n            <AvatarFallback className=\"bg-zinc-900 text-zinc-100 text-lg font-semibold border border-zinc-800\">\r\n              {initials}\r\n            </AvatarFallback>\r\n          </Avatar>\r\n\r\n          <div className=\"min-w-0 flex-1\">\r\n            {/* Ligne du nom + bouton déconnexion */}\r\n            <div className=\"flex items-center justify-between gap-2\">\r\n              <h1 className=\"text-xl sm:text-2xl font-bold text-white break-words\">\r\n                Bonjour, {firstName}\r\n              </h1>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                className=\"shrink-0 text-zinc-400 hover:text-white hover:bg-zinc-900 h-8 w-8\"\r\n                onClick={handleSignOut}\r\n                title=\"Déconnexion\"\r\n              >\r\n                <LogOut className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n\r\n            {/* Badges des rôles */}\r\n            {!rolesLoading && userRoles.length > 0 && (\r\n              <div className=\"flex flex-wrap gap-1.5 mt-1\">\r\n                {userRoles.map((role) => {\r\n                  return (\r\n                    <Badge\r\n                      key={role}\r\n                      className={`text-xs shrink-0 ${ROLE_COLORS[role] || \"bg-white/10 text-white/80\"}`}\r\n                    >\r\n                      {ROLE_LABELS[role] || role}\r\n                    </Badge>\r\n                  );\r\n                })}\r\n              </div>\r\n            )}\r\n\r\n            {/* Email */}\r\n            <p className=\"mt-1 text-sm text-zinc-400 truncate\">\r\n              {user.email}\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n\r\n        {/* Widgets Premium */}\r\n        <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\r\n          <GestionLocativeWidget {...stats} />\r\n          <LegalAssistantWidget />\r\n        </div>\r\n\r\n        {/* Bento Grid */}\r\n        <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3\">\r\n          {/* Card 1: Mes Favoris */}\r\n          <motion.div\r\n            whileHover={{ scale: 1.01 }}\r\n            whileTap={{ scale: 0.99 }}\r\n            transition={{ type: \"spring\", stiffness: 400, damping: 30 }}\r\n          >\r\n            <Link href=\"/favoris\">\r\n              <Card className=\"h-full cursor-pointer border-zinc-800 bg-zinc-900/50 transition-all hover:bg-zinc-900 hover:border-zinc-700\">\r\n                <CardHeader className=\"p-6\">\r\n                  <div className=\"flex items-center justify-between mb-4\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <Heart className=\"h-6 w-6 shrink-0 text-zinc-100 stroke-[1.5]\" />\r\n                      <CardTitle className=\"text-lg font-semibold text-white\">\r\n                        Mes Favoris\r\n                      </CardTitle>\r\n                    </div>\r\n                    {favorites.length > 0 && (\r\n                      <span className=\"flex h-5 min-w-[20px] items-center justify-center rounded-full bg-zinc-800 px-2 text-xs font-medium text-zinc-300\">\r\n                        {favorites.length > 9 ? \"9+\" : favorites.length}\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                  <CardDescription className=\"text-sm text-zinc-400\">\r\n                    Retrouvez vos biens sauvegardés.\r\n                  </CardDescription>\r\n                </CardHeader>\r\n              </Card>\r\n            </Link>\r\n          </motion.div>\r\n\r\n          {/* Card 2: Gérer mes biens */}\r\n          <motion.div\r\n            whileHover={{ scale: 1.01 }}\r\n            whileTap={{ scale: 0.99 }}\r\n            transition={{ type: \"spring\", stiffness: 400, damping: 30 }}\r\n          >\r\n            <Link href=\"/compte/mes-biens\">\r\n              <Card className=\"h-full cursor-pointer border-zinc-800 bg-zinc-900/50 transition-all hover:bg-zinc-900 hover:border-zinc-700\">\r\n                <CardHeader className=\"p-6\">\r\n                  <div className=\"flex items-center gap-3 mb-4\">\r\n                    <Building2 className=\"h-6 w-6 shrink-0 text-zinc-100 stroke-[1.5]\" />\r\n                    <CardTitle className=\"text-lg font-semibold text-white\">\r\n                      Gérer mes biens\r\n                    </CardTitle>\r\n                  </div>\r\n                  <CardDescription className=\"text-sm text-zinc-400\">\r\n                    Suivez vos annonces en ligne et leurs stats.\r\n                  </CardDescription>\r\n                  <div className=\"mt-4 flex items-center text-sm text-zinc-300\">\r\n                    Voir tout\r\n                    <ArrowRight className=\"ml-2 h-4 w-4\" />\r\n                  </div>\r\n                </CardHeader>\r\n              </Card>\r\n            </Link>\r\n          </motion.div>\r\n\r\n          {/* Card 3: Louer/Vendre */}\r\n          <motion.div\r\n            whileHover={{ scale: 1.01 }}\r\n            whileTap={{ scale: 0.99 }}\r\n            transition={{ type: \"spring\", stiffness: 400, damping: 30 }}\r\n          >\r\n            <Link href=\"/compte/deposer\">\r\n              <Card className=\"h-full cursor-pointer border-zinc-800 bg-zinc-900/50 transition-all hover:bg-zinc-900 hover:border-zinc-700\">\r\n                <CardHeader className=\"p-6\">\r\n                  <div className=\"flex items-center gap-3 mb-4\">\r\n                    <Plus className=\"h-6 w-6 shrink-0 text-zinc-100 stroke-[1.5]\" />\r\n                    <CardTitle className=\"text-lg font-semibold text-white\">\r\n                      Louer ou Vendre\r\n                    </CardTitle>\r\n                  </div>\r\n                  <CardDescription className=\"text-sm text-zinc-400\">\r\n                    Créez une nouvelle annonce en 2 minutes.\r\n                  </CardDescription>\r\n                </CardHeader>\r\n              </Card>\r\n            </Link>\r\n          </motion.div>\r\n\r\n          {/* Card 4: Mes Alertes */}\r\n          <motion.div\r\n            whileHover={{ scale: 1.01 }}\r\n            whileTap={{ scale: 0.99 }}\r\n            transition={{ type: \"spring\", stiffness: 400, damping: 30 }}\r\n          >\r\n            <Link href=\"/compte/alertes\">\r\n              <Card className=\"h-full cursor-pointer border-zinc-800 bg-zinc-900/50 transition-all hover:bg-zinc-900 hover:border-zinc-700\">\r\n                <CardHeader className=\"p-6\">\r\n                  <div className=\"flex items-center gap-3 mb-4\">\r\n                    <Bell className=\"h-6 w-6 shrink-0 text-zinc-100 stroke-[1.5]\" />\r\n                    <CardTitle className=\"text-lg font-semibold text-white\">\r\n                      Mes Alertes\r\n                    </CardTitle>\r\n                  </div>\r\n                  <CardDescription className=\"text-sm text-zinc-400\">\r\n                    Soyez notifié des nouveaux biens.\r\n                  </CardDescription>\r\n                </CardHeader>\r\n              </Card>\r\n            </Link>\r\n          </motion.div>\r\n\r\n          {/* Card 5: Mes Documents (Digital Safe) */}\r\n          <motion.div\r\n            whileHover={{ scale: 1.01 }}\r\n            whileTap={{ scale: 0.99 }}\r\n            transition={{ type: \"spring\", stiffness: 400, damping: 30 }}\r\n          >\r\n            <Link href=\"/compte/mes-documents\">\r\n              <Card className=\"h-full cursor-pointer border-zinc-800 bg-zinc-900/50 transition-all hover:bg-zinc-900 hover:border-zinc-700\">\r\n                <CardHeader className=\"p-6\">\r\n                  <div className=\"flex items-center gap-3 mb-4\">\r\n                    <Lock className=\"h-6 w-6 shrink-0 text-primary stroke-[1.5]\" />\r\n                    <CardTitle className=\"text-lg font-semibold text-white\">\r\n                      Mes Documents\r\n                    </CardTitle>\r\n                  </div>\r\n                  <CardDescription className=\"text-sm text-zinc-400\">\r\n                    Coffre-fort numérique ultra-sécurisé (AES-256).\r\n                  </CardDescription>\r\n                </CardHeader>\r\n              </Card>\r\n            </Link>\r\n          </motion.div>\r\n\r\n          {/* Card 6: Profil & Sécurité */}\r\n          <motion.div\r\n            whileHover={{ scale: 1.01 }}\r\n            whileTap={{ scale: 0.99 }}\r\n            transition={{ type: \"spring\", stiffness: 400, damping: 30 }}\r\n          >\r\n            <Link href=\"/compte/parametres\">\r\n              <Card className=\"h-full cursor-pointer border-zinc-800 bg-zinc-900/50 transition-all hover:bg-zinc-900 hover:border-zinc-700\">\r\n                <CardHeader className=\"p-6\">\r\n                  <div className=\"flex items-center gap-3 mb-4\">\r\n                    <User className=\"h-6 w-6 shrink-0 text-zinc-100 stroke-[1.5]\" />\r\n                    <CardTitle className=\"text-lg font-semibold text-white\">\r\n                      Profil & Sécurité\r\n                    </CardTitle>\r\n                  </div>\r\n                  <CardDescription className=\"text-sm text-zinc-400\">\r\n                    Modifier mes infos personnelles.\r\n                  </CardDescription>\r\n                </CardHeader>\r\n              </Card>\r\n            </Link>\r\n          </motion.div>\r\n        </div>\r\n\r\n        {/* Section Admin (Conditionnelle) - Afficher pour tous les utilisateurs avec un rôle */}\r\n        {!rolesLoading && hasRole && (\r\n          <FadeIn delay={0.2}>\r\n            <motion.div\r\n              whileHover={{ scale: 1.005 }}\r\n              transition={{ type: \"spring\", stiffness: 400, damping: 30 }}\r\n              className=\"col-span-full\"\r\n            >\r\n              <Link href=\"/admin\">\r\n                <Card className=\"cursor-pointer border border-amber-900/30 bg-black transition-all hover:border-amber-900/50\">\r\n                  <CardHeader className=\"p-6\">\r\n                    <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <ShieldCheck className=\"h-6 w-6 shrink-0 text-zinc-100 stroke-[1.5]\" />\r\n                        <div className=\"min-w-0\">\r\n                          <CardTitle className=\"text-lg font-semibold text-white\">\r\n                            Espace Administration\r\n                          </CardTitle>\r\n                          <CardDescription className=\"mt-1 text-sm text-zinc-500\">\r\n                            {userRoles.length > 0\r\n                              ? `Accédez au panel admin avec vos rôles: ${userRoles.map((r) => ROLE_LABELS[r] || r).join(\", \")}`\r\n                              : \"Modération, Utilisateurs, Statistiques.\"}\r\n                          </CardDescription>\r\n                        </div>\r\n                      </div>\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        className=\"shrink-0 border-zinc-800 bg-transparent text-white hover:bg-zinc-900 hover:border-zinc-700 w-full sm:w-auto\"\r\n                      >\r\n                        Accéder\r\n                        <ArrowRight className=\"ml-2 h-4 w-4\" />\r\n                      </Button>\r\n                    </div>\r\n                  </CardHeader>\r\n                </Card>\r\n              </Link>\r\n            </motion.div>\r\n          </FadeIn>\r\n        )}\r\n      </FadeIn>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\parametres\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\compte\\parametres\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'motion' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Mail, Lock, User as UserIcon, ArrowLeft, Camera, Trash2, Upload } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport Image from \"next/image\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { useAuth } from \"@/hooks/use-auth\";\r\nimport { resetPassword } from \"@/app/auth/actions\";\r\nimport { updateAvatar, deleteAvatar } from \"./actions\";\r\nimport { FadeIn } from \"@/components/ui/motion-wrapper\";\r\nimport Link from \"next/link\";\r\nimport { PushNotifications } from \"@/components/pwa/push-notifications\";\r\n\r\ntype Profile = {\r\n  id: string;\r\n  full_name: string | null;\r\n  avatar_url: string | null;\r\n  phone: string | null;\r\n  is_identity_verified: boolean;\r\n};\r\n\r\nexport default function ParametresPage() {\r\n  const { user, loading } = useAuth();\r\n  const router = useRouter();\r\n  const [profile, setProfile] = useState<Profile | null>(null);\r\n  const [isResettingPassword, setIsResettingPassword] = useState(false);\r\n  const [resetEmail, setResetEmail] = useState(\"\");\r\n  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);\r\n  const [isUploadingAvatar, setIsUploadingAvatar] = useState(false);\r\n  const [isDeletingAvatar, setIsDeletingAvatar] = useState(false);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Fetch user profile\r\n  useEffect(() => {\r\n    const fetchProfile = async () => {\r\n      if (!user) return;\r\n\r\n      const supabase = createClient();\r\n      const { data, error } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, full_name, avatar_url, phone, is_identity_verified\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      if (!error && data) {\r\n        setProfile(data);\r\n      }\r\n    };\r\n\r\n    fetchProfile();\r\n  }, [user]);\r\n\r\n  const refetchProfile = async () => {\r\n    if (!user) return;\r\n\r\n    const supabase = createClient();\r\n    const { data, error } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"id, full_name, avatar_url, phone, is_identity_verified\")\r\n      .eq(\"id\", user.id)\r\n      .single();\r\n\r\n    if (!error && data) {\r\n      setProfile(data);\r\n    }\r\n  };\r\n\r\n  const handleResetPassword = async () => {\r\n    if (!resetEmail) {\r\n      toast.error(\"Veuillez entrer votre email\");\r\n      return;\r\n    }\r\n    try {\r\n      const result = await resetPassword(resetEmail);\r\n      if (result?.error) {\r\n        toast.error(\"Erreur lors de l'envoi de l'email\", {\r\n          description: result.error,\r\n        });\r\n      } else {\r\n        toast.success(\"Email de réinitialisation envoyé\");\r\n        setIsResettingPassword(false);\r\n        setResetEmail(\"\");\r\n      }\r\n    } catch {\r\n      toast.error(\"Erreur lors de l'envoi de l'email\");\r\n    }\r\n  };\r\n\r\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    // Validate file type\r\n    const validTypes = [\"image/jpeg\", \"image/jpg\", \"image/png\", \"image/webp\"];\r\n    if (!validTypes.includes(file.type)) {\r\n      toast.error(\"Format non supporté\", {\r\n        description: \"Utilisez JPG, PNG ou WebP\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Validate file size (5MB)\r\n    if (file.size > 5 * 1024 * 1024) {\r\n      toast.error(\"Fichier trop volumineux\", {\r\n        description: \"Taille maximale : 5MB\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Create preview\r\n    const reader = new FileReader();\r\n    reader.onloadend = () => {\r\n      setAvatarPreview(reader.result as string);\r\n    };\r\n    reader.readAsDataURL(file);\r\n  };\r\n\r\n  const handleUploadAvatar = async () => {\r\n    if (!fileInputRef.current?.files?.[0]) {\r\n      toast.error(\"Aucun fichier sélectionné\");\r\n      return;\r\n    }\r\n\r\n    setIsUploadingAvatar(true);\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append(\"avatar\", fileInputRef.current.files[0]);\r\n\r\n      const result = await updateAvatar(formData);\r\n\r\n      if (result.success) {\r\n        toast.success(\"Avatar mis à jour avec succès\");\r\n        setAvatarPreview(null);\r\n        if (fileInputRef.current) fileInputRef.current.value = \"\";\r\n        refetchProfile();\r\n      } else {\r\n        toast.error(\"Erreur lors de la mise à jour\", {\r\n          description: result.error,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      toast.error(\"Une erreur est survenue\");\r\n      console.error(error);\r\n    } finally {\r\n      setIsUploadingAvatar(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteAvatar = async () => {\r\n    if (!confirm(\"Êtes-vous sûr de vouloir supprimer votre avatar ?\")) {\r\n      return;\r\n    }\r\n\r\n    setIsDeletingAvatar(true);\r\n    try {\r\n      const result = await deleteAvatar();\r\n\r\n      if (result.success) {\r\n        toast.success(\"Avatar supprimé avec succès\");\r\n        setAvatarPreview(null);\r\n        if (fileInputRef.current) fileInputRef.current.value = \"\";\r\n        refetchProfile();\r\n      } else {\r\n        toast.error(\"Erreur lors de la suppression\", {\r\n          description: result.error,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      toast.error(\"Une erreur est survenue\");\r\n      console.error(error);\r\n    } finally {\r\n      setIsDeletingAvatar(false);\r\n    }\r\n  };\r\n\r\n  const handleCancelPreview = () => {\r\n    setAvatarPreview(null);\r\n    if (fileInputRef.current) fileInputRef.current.value = \"\";\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\r\n        <div className=\"text-zinc-400\">Chargement...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    router.push(\"/login\");\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6 py-6\">\r\n      <FadeIn>\r\n        {/* Header */}\r\n        <div className=\"flex items-center gap-4\">\r\n          <Link href=\"/compte\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"text-zinc-400 hover:text-white hover:bg-zinc-900\"\r\n            >\r\n              <ArrowLeft className=\"h-5 w-5\" />\r\n            </Button>\r\n          </Link>\r\n          <div>\r\n            <h1 className=\"text-2xl font-bold text-white\">Profil & Sécurité</h1>\r\n            <p className=\"text-sm text-zinc-400 mt-1\">\r\n              Gérez vos informations personnelles\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Avatar Section */}\r\n        <Card className=\"border-zinc-800 bg-zinc-900/50\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-white\">Photo de profil</CardTitle>\r\n            <CardDescription className=\"text-zinc-400\">\r\n              Personnalisez votre avatar\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-4\">\r\n            <div className=\"flex items-center gap-6\">\r\n              {/* Avatar Display */}\r\n              <div className=\"relative\">\r\n                <div className=\"h-24 w-24 rounded-full overflow-hidden bg-zinc-800 border-2 border-zinc-700\">\r\n                  {avatarPreview ? (\r\n                    <Image\r\n                      src={avatarPreview}\r\n                      alt=\"Aperçu avatar\"\r\n                      width={96}\r\n                      height={96}\r\n                      className=\"object-cover w-full h-full\"\r\n                    />\r\n                  ) : profile?.avatar_url ? (\r\n                    <Image\r\n                      src={profile.avatar_url}\r\n                      alt=\"Avatar actuel\"\r\n                      width={96}\r\n                      height={96}\r\n                      className=\"object-cover w-full h-full\"\r\n                    />\r\n                  ) : (\r\n                    <div className=\"flex items-center justify-center w-full h-full\">\r\n                      <UserIcon className=\"h-12 w-12 text-zinc-600\" />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n                <button\r\n                  onClick={() => fileInputRef.current?.click()}\r\n                  className=\"absolute bottom-0 right-0 p-2 bg-primary rounded-full hover:bg-primary/90 transition-colors\"\r\n                  disabled={isUploadingAvatar || isDeletingAvatar}\r\n                >\r\n                  <Camera className=\"h-4 w-4 text-black\" />\r\n                </button>\r\n              </div>\r\n\r\n              {/* Avatar Actions */}\r\n              <div className=\"flex-1 space-y-3\">\r\n                <div className=\"space-y-2\">\r\n                  <input\r\n                    ref={fileInputRef}\r\n                    type=\"file\"\r\n                    accept=\"image/jpeg,image/jpg,image/png,image/webp\"\r\n                    onChange={handleFileChange}\r\n                    className=\"hidden\"\r\n                  />\r\n                  <p className=\"text-sm text-zinc-400\">\r\n                    JPG, PNG ou WebP. Max 5MB.\r\n                  </p>\r\n                </div>\r\n\r\n                {avatarPreview ? (\r\n                  <div className=\"flex gap-2\">\r\n                    <Button\r\n                      onClick={handleUploadAvatar}\r\n                      disabled={isUploadingAvatar}\r\n                      className=\"bg-primary text-black hover:bg-primary/90\"\r\n                    >\r\n                      <Upload className=\"h-4 w-4 mr-2\" />\r\n                      {isUploadingAvatar ? \"Upload...\" : \"Enregistrer\"}\r\n                    </Button>\r\n                    <Button\r\n                      onClick={handleCancelPreview}\r\n                      variant=\"outline\"\r\n                      disabled={isUploadingAvatar}\r\n                      className=\"border-zinc-800 bg-transparent text-white hover:bg-zinc-900\"\r\n                    >\r\n                      Annuler\r\n                    </Button>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"flex gap-2\">\r\n                    <Button\r\n                      onClick={() => fileInputRef.current?.click()}\r\n                      variant=\"outline\"\r\n                      disabled={isUploadingAvatar || isDeletingAvatar}\r\n                      className=\"border-zinc-800 bg-transparent text-white hover:bg-zinc-900\"\r\n                    >\r\n                      <Upload className=\"h-4 w-4 mr-2\" />\r\n                      Choisir une photo\r\n                    </Button>\r\n                    {profile?.avatar_url && (\r\n                      <Button\r\n                        onClick={handleDeleteAvatar}\r\n                        variant=\"outline\"\r\n                        disabled={isUploadingAvatar || isDeletingAvatar}\r\n                        className=\"border-red-500/30 bg-red-500/10 text-red-400 hover:bg-red-500/20\"\r\n                      >\r\n                        <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                        {isDeletingAvatar ? \"Suppression...\" : \"Supprimer\"}\r\n                      </Button>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Informations du compte */}\r\n        <Card className=\"border-zinc-800 bg-zinc-900/50\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-white\">Informations du compte</CardTitle>\r\n            <CardDescription className=\"text-zinc-400\">\r\n              Vos informations de connexion\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-zinc-300\">Email</Label>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Mail className=\"h-4 w-4 text-zinc-500\" />\r\n                <Input\r\n                  value={user.email || \"\"}\r\n                  disabled\r\n                  className=\"bg-zinc-900 border-zinc-800 text-zinc-400\"\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-zinc-300\">Nom complet</Label>\r\n              <div className=\"flex items-center gap-2\">\r\n                <UserIcon className=\"h-4 w-4 text-zinc-500\" />\r\n                <Input\r\n                  value={(user.user_metadata?.full_name as string) || \"\"}\r\n                  disabled\r\n                  className=\"bg-zinc-900 border-zinc-800 text-zinc-400\"\r\n                  placeholder=\"Non renseigné\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Mot de passe */}\r\n        <Card className=\"border-zinc-800 bg-zinc-900/50\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-white\">Sécurité</CardTitle>\r\n            <CardDescription className=\"text-zinc-400\">\r\n              Gérez votre mot de passe\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-4\">\r\n            {!isResettingPassword ? (\r\n              <>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Lock className=\"h-4 w-4 text-zinc-500\" />\r\n                  <div className=\"flex-1\">\r\n                    <p className=\"text-sm text-zinc-300\">Mot de passe</p>\r\n                    <p className=\"text-xs text-zinc-500\">\r\n                      Dernière modification : Non disponible\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"w-full border-zinc-800 bg-transparent text-white hover:bg-zinc-900 hover:border-zinc-700\"\r\n                  onClick={() => setIsResettingPassword(true)}\r\n                >\r\n                  Changer le mot de passe\r\n                </Button>\r\n              </>\r\n            ) : (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"text-zinc-300\">Email de réinitialisation</Label>\r\n                  <Input\r\n                    type=\"email\"\r\n                    value={resetEmail}\r\n                    onChange={(e) => setResetEmail(e.target.value)}\r\n                    placeholder={user.email || \"votre@email.com\"}\r\n                    className=\"bg-zinc-900 border-zinc-800 text-white\"\r\n                  />\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    className=\"flex-1 border-zinc-800 bg-transparent text-white hover:bg-zinc-900 hover:border-zinc-700\"\r\n                    onClick={() => {\r\n                      setIsResettingPassword(false);\r\n                      setResetEmail(\"\");\r\n                    }}\r\n                  >\r\n                    Annuler\r\n                  </Button>\r\n                  <Button\r\n                    className=\"flex-1 bg-primary text-black hover:bg-primary/90\"\r\n                    onClick={handleResetPassword}\r\n                  >\r\n                    Envoyer\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Notifications */}\r\n        <Card className=\"border-zinc-800 bg-zinc-900/50\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-white\">Notifications</CardTitle>\r\n            <CardDescription className=\"text-zinc-400\">\r\n              Gérez vos préférences de notifications\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <PushNotifications />\r\n          </CardContent>\r\n        </Card>\r\n      </FadeIn>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\contact\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\estimation\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\favoris\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\legal\\cgu\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\legal\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardContent' is defined but never used.","line":4,"column":56,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":67}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\r\nimport { ArrowLeft, Shield, FileText, Lock } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardHeader, CardTitle, CardDescription, CardContent } from \"@/components/ui/card\";\r\n\r\nexport const metadata = {\r\n  title: \"Mentions Légales · Dousell Immo\",\r\n  description: \"Centre légal de Dousell Immo : Mentions légales, CGU et Politique de confidentialité\",\r\n};\r\n\r\nexport default function LegalHubPage() {\r\n  return (\r\n    <div className=\"mx-auto max-w-4xl space-y-8 py-8 px-4 text-white\">\r\n      <Button variant=\"ghost\" className=\"mb-6\" asChild>\r\n        <Link href=\"/\">\r\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n          Retour à l&apos;accueil\r\n        </Link>\r\n      </Button>\r\n\r\n      <div className=\"space-y-4 text-center mb-12\">\r\n        <h1 className=\"text-4xl font-bold\">Centre Légal</h1>\r\n        <p className=\"text-white/60\">\r\n          Retrouvez ici toutes les informations légales concernant Dousell Immo\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"grid gap-6 md:grid-cols-2\">\r\n        <Link href=\"/legal/cgu\" className=\"block h-full\">\r\n          <Card className=\"bg-background/5 border-white/10 hover:bg-background/10 transition-colors h-full cursor-pointer\">\r\n            <CardHeader>\r\n              <FileText className=\"h-8 w-8 text-amber-400 mb-2\" />\r\n              <CardTitle className=\"text-white\">Conditions Générales d&apos;Utilisation</CardTitle>\r\n              <CardDescription className=\"text-white/60\">\r\n                Règles d&apos;utilisation de la plateforme et engagements des utilisateurs.\r\n              </CardDescription>\r\n            </CardHeader>\r\n          </Card>\r\n        </Link>\r\n\r\n        <Link href=\"/legal/privacy\" className=\"block h-full\">\r\n          <Card className=\"bg-background/5 border-white/10 hover:bg-background/10 transition-colors h-full cursor-pointer\">\r\n            <CardHeader>\r\n              <Lock className=\"h-8 w-8 text-emerald-400 mb-2\" />\r\n              <CardTitle className=\"text-white\">Politique de Confidentialité</CardTitle>\r\n              <CardDescription className=\"text-white/60\">\r\n                Comment nous collectons, utilisons et protégeons vos données personnelles.\r\n              </CardDescription>\r\n            </CardHeader>\r\n          </Card>\r\n        </Link>\r\n      </div>\r\n\r\n      <div className=\"mt-12 space-y-6 prose prose-invert prose-lg max-w-none\">\r\n        <div className=\"flex items-center gap-3 mb-6\">\r\n          <Shield className=\"h-6 w-6 text-blue-400\" />\r\n          <h2 className=\"text-2xl font-semibold m-0\">Mentions Légales</h2>\r\n        </div>\r\n        \r\n        <div className=\"bg-background/5 rounded-2xl p-6 border border-white/10 space-y-4\">\r\n          <div className=\"grid md:grid-cols-2 gap-6\">\r\n            <div>\r\n              <h3 className=\"text-lg font-medium text-white mb-2\">Éditeur</h3>\r\n              <ul className=\"space-y-1 text-sm text-white/70 list-none pl-0\">\r\n                <li><strong>Raison sociale :</strong> Dousell Immo</li>\r\n                <li><strong>Siège social :</strong> Sacré-Cœur 3, VDN, Dakar</li>\r\n                <li><strong>Téléphone :</strong> +221 33 860 00 00</li>\r\n                <li><strong>Email :</strong> contact@dousell.immo</li>\r\n              </ul>\r\n            </div>\r\n            \r\n            <div>\r\n              <h3 className=\"text-lg font-medium text-white mb-2\">Hébergement</h3>\r\n              <ul className=\"space-y-1 text-sm text-white/70 list-none pl-0\">\r\n                <li><strong>Hébergeur :</strong> Vercel Inc.</li>\r\n                <li><strong>Adresse :</strong> 340 S Lemon Ave #4133</li>\r\n                <li>Walnut, CA 91789, USA</li>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\legal\\privacy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\notifications\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\offline\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\planifier-visite\\actions.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":48,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":48,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport VisitRequestEmail from \"@/emails/visit-request-email\";\nimport { sendEmail, getAdminEmail } from \"@/lib/mail\";\nimport {\n  visitRequestSchema,\n  type VisitRequestFormValues,\n} from \"@/lib/schemas/visit-request\";\nimport { createAdminClient } from \"@/utils/supabase/admin\";\nimport { verifyTurnstileToken } from \"@/lib/turnstile\";\n\n// Alias pour compatibilité\nexport async function submitLead(values: VisitRequestFormValues, turnstileToken?: string) {\n  return createVisitRequest(values, turnstileToken);\n}\n\nexport async function createVisitRequest(values: VisitRequestFormValues, turnstileToken?: string) {\n  const parsed = visitRequestSchema.safeParse(values);\n\n  if (!parsed.success) {\n    return {\n      success: false,\n      error: \"Formulaire invalide, merci de vérifier les champs.\",\n    };\n  }\n\n  // Vérification Turnstile\n  if (!turnstileToken) {\n    return {\n      success: false,\n      error: \"Vérification anti-robot requise. Veuillez réessayer.\",\n    };\n  }\n\n  const verification = await verifyTurnstileToken(turnstileToken);\n  if (!verification.success) {\n    return {\n      success: false,\n      error: verification.error || \"Vérification anti-robot échouée. Veuillez réessayer.\",\n    };\n  }\n\n  // Utiliser le client admin pour bypasser RLS (formulaire public, sécurisé par Turnstile)\n  const supabase = createAdminClient();\n  const payload = parsed.data;\n\n  // Insérer dans la table visit_requests\n  const { data, error } = await supabase.from(\"visit_requests\").insert({\n    full_name: payload.fullName,\n    phone: payload.phone,\n    project_type: payload.projectType,\n    availability: payload.availability,\n    message: payload.message,\n    status: \"nouveau\",\n  }).select().single();\n\n  if (error) {\n    console.error(\"❌ Error inserting visit request:\", error);\n    return {\n      success: false,\n      error: \"Impossible d'enregistrer la demande. Réessayez plus tard.\",\n    };\n  }\n\n  // Envoyer l'email à l'admin\n  try {\n    await sendEmail({\n      to: getAdminEmail(),\n      subject: \"Nouvelle demande de visite · Dousell Immo\",\n      react: (\n        <VisitRequestEmail\n          fullName={payload.fullName}\n          phone={payload.phone}\n          projectType={payload.projectType}\n          availability={\n            payload.availability === \"semaine-matin\"\n              ? \"En semaine (Matin)\"\n              : payload.availability === \"semaine-apres-midi\"\n                ? \"En semaine (Après-midi)\"\n                : \"Le week-end\"\n          }\n          message={payload.message}\n        />\n      ),\n    });\n  } catch (emailError) {\n    console.error(\"⚠️ Erreur lors de l'envoi de l'email:\", emailError);\n    // Ne pas bloquer le processus si l'email échoue\n  }\n\n  // Notifier tous les admins et modérateurs\n  try {\n    const { notifyModeratorsAndAdmins } = await import(\"@/lib/notifications-helpers\");\n    await notifyModeratorsAndAdmins({\n      type: \"info\",\n      title: \"Nouveau lead\",\n      message: `${payload.fullName} (${payload.phone}) a fait une demande de visite pour ${payload.projectType}`,\n      resourcePath: \"/admin/leads\",\n    });\n  } catch (error) {\n    console.error(\"⚠️ Erreur lors de la notification des modérateurs:\", error);\n    // Ne pas bloquer le processus si la notification échoue\n  }\n\n  return { success: true };\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\planifier-visite\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'propertyId' is assigned a value but never used.","line":35,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'propertyTitle' is assigned a value but never used.","line":36,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'propertyPrice' is assigned a value but never used.","line":37,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'propertyLocation' is assigned a value but never used.","line":38,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, Suspense } from \"react\";\nimport Link from \"next/link\";\nimport { useSearchParams } from \"next/navigation\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { toast } from \"sonner\";\nimport { MessageCircle } from \"lucide-react\";\n\nimport { createVisitRequest } from \"@/app/planifier-visite/actions\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Captcha } from \"@/components/ui/captcha\";\nimport { sendGTMEvent } from \"@/lib/gtm\";\nimport {\n  visitRequestSchema,\n  type VisitRequestFormValues,\n} from \"@/lib/schemas/visit-request\";\n\nconst availabilityLabels: Record<VisitRequestFormValues[\"availability\"], string> = {\n  \"semaine-matin\": \"En semaine (Matin)\",\n  \"semaine-apres-midi\": \"En semaine (Après-midi)\",\n  weekend: \"Le week-end\",\n};\n\nfunction PlanifierVisitePageContent() {\n  const searchParams = useSearchParams();\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [captchaToken, setCaptchaToken] = useState<string | null>(null);\n  const [captchaResetKey, setCaptchaResetKey] = useState(0); // Clé pour forcer le reset du widget\n\n  // Récupérer les paramètres de l'URL pour pré-remplir le formulaire\n  const propertyId = searchParams?.get(\"propertyId\");\n  const propertyTitle = searchParams?.get(\"propertyTitle\");\n  const propertyPrice = searchParams?.get(\"propertyPrice\");\n  const propertyLocation = searchParams?.get(\"propertyLocation\");\n  const projectTypeParam = searchParams?.get(\"projectType\");\n  const messageParam = searchParams?.get(\"message\");\n\n  const form = useForm<VisitRequestFormValues>({\n    resolver: zodResolver(visitRequestSchema),\n    defaultValues: {\n      fullName: \"\",\n      phone: \"\",\n      projectType: (projectTypeParam === \"location\" ? \"location\" : \"achat\") as \"achat\" | \"location\",\n      availability: \"semaine-matin\",\n      message: messageParam || \"\",\n    },\n    mode: \"onTouched\",\n  });\n\n  // Pré-remplir le formulaire si des paramètres sont présents\n  useEffect(() => {\n    if (messageParam) {\n      form.setValue(\"message\", messageParam);\n    }\n    if (projectTypeParam === \"location\" || projectTypeParam === \"achat\") {\n      form.setValue(\"projectType\", projectTypeParam);\n    }\n  }, [messageParam, projectTypeParam, form]);\n\n  const onSubmit = async (values: VisitRequestFormValues) => {\n    if (!captchaToken) {\n      toast.error(\"Veuillez compléter la vérification anti-robot\");\n      return;\n    }\n\n    try {\n      setIsSubmitting(true);\n      const result = await createVisitRequest(values, captchaToken);\n\n      if (!result.success) {\n        toast.error(result.error || \"Impossible d'envoyer la demande.\");\n        return;\n      }\n\n      toast.success(\"Demande envoyée !\", {\n        description: `${values.fullName}, un conseiller vous rappelle sous 30 min.`,\n      });\n\n      // GTM Tracking - Generate Lead\n      sendGTMEvent(\"generate_lead\", {\n        source: \"formulaire_visite\",\n        location: \"page_planifier\",\n        project_type: values.projectType\n      });\n\n      form.reset();\n    } catch (error) {\n      console.error(\"Erreur lors de l'envoi:\", error);\n      toast.error(\"Une erreur est survenue, merci de réessayer.\");\n    } finally {\n      setIsSubmitting(false);\n      setCaptchaToken(null);\n      setCaptchaResetKey((prev) => prev + 1);\n    }\n  };\n\n  return (\n    <div className=\"space-y-10 py-6\">\n      <div className=\"mx-auto w-full max-w-lg rounded-[32px] border border-white/10 bg-background/5 px-6 py-10 shadow-[0_20px_80px_rgba(5,8,12,0.55)] backdrop-blur\">\n        <div className=\"mb-10 text-center\">\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/50\">\n            Conciergerie\n          </p>\n          <h1 className=\"mt-3 text-3xl font-semibold text-white\">\n            Confiez-nous votre visite\n          </h1>\n          <p className=\"mt-2 text-white/60\">\n            Remplissez ce formulaire et un conseiller Dousell vous recontacte\n            sous 30 minutes pour organiser la visite idéale.\n          </p>\n        </div>\n\n        <form\n          onSubmit={form.handleSubmit(onSubmit)}\n          className=\"space-y-5\"\n          noValidate\n        >\n          <div className=\"space-y-2\">\n            <label className=\"text-sm text-white/70\">Nom complet</label>\n            <Input\n              type=\"text\"\n              placeholder=\"Ex: Amy Ndiaye\"\n              className=\"border-white/10 bg-background/5 text-white placeholder:text-white/40\"\n              {...form.register(\"fullName\")}\n            />\n            {form.formState.errors.fullName && (\n              <p className=\"text-sm text-amber-300\">\n                {form.formState.errors.fullName.message}\n              </p>\n            )}\n          </div>\n          <div className=\"space-y-2\">\n            <label className=\"text-sm text-white/70\">Téléphone</label>\n            <Input\n              type=\"tel\"\n              inputMode=\"tel\"\n              placeholder=\"77 000 00 00\"\n              className=\"border-white/10 bg-background/5 text-white placeholder:text-white/40\"\n              {...form.register(\"phone\")}\n            />\n            {form.formState.errors.phone && (\n              <p className=\"text-sm text-amber-300\">\n                {form.formState.errors.phone.message}\n              </p>\n            )}\n          </div>\n          <div className=\"grid gap-4 sm:grid-cols-2\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm text-white/70\">Type de projet</label>\n              <select\n                className=\"h-12 w-full rounded-2xl border border-white/10 bg-background/5 px-4 text-white outline-none transition focus:border-white/30 appearance-none bg-no-repeat bg-right pr-10\"\n                style={{\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                  backgroundPosition: \"right 0.75rem center\",\n                  backgroundSize: \"1.5em 1.5em\"\n                }}\n                {...form.register(\"projectType\")}\n              >\n                <option value=\"achat\" className=\"bg-[#121212] text-white py-2\">\n                  Achat\n                </option>\n                <option value=\"location\" className=\"bg-[#121212] text-white py-2\">\n                  Location\n                </option>\n              </select>\n              {form.formState.errors.projectType && (\n                <p className=\"text-sm text-amber-300\">\n                  {form.formState.errors.projectType.message}\n                </p>\n              )}\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm text-white/70\">Disponibilité</label>\n              <select\n                className=\"h-12 w-full rounded-2xl border border-white/10 bg-background/5 px-4 text-white outline-none transition focus:border-white/30 appearance-none bg-no-repeat bg-right pr-10\"\n                style={{\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                  backgroundPosition: \"right 0.75rem center\",\n                  backgroundSize: \"1.5em 1.5em\"\n                }}\n                {...form.register(\"availability\")}\n              >\n                {Object.entries(availabilityLabels).map(([value, label]) => (\n                  <option\n                    key={value}\n                    value={value}\n                    className=\"bg-[#121212] text-white py-2\"\n                  >\n                    {label}\n                  </option>\n                ))}\n              </select>\n              {form.formState.errors.availability && (\n                <p className=\"text-sm text-amber-300\">\n                  {form.formState.errors.availability.message}\n                </p>\n              )}\n            </div>\n          </div>\n          <div className=\"space-y-2\">\n            <label className=\"text-sm text-white/70\">\n              Votre brief (quartier, budget…)\n            </label>\n            <Textarea\n              placeholder=\"Je cherche un T3 à Mermoz, budget 800 000 FCFA/mois...\"\n              className=\"min-h-[140px] border-white/10 bg-background/5 text-white placeholder:text-white/40\"\n              {...form.register(\"message\")}\n            />\n            {form.formState.errors.message && (\n              <p className=\"text-sm text-amber-300\">\n                {form.formState.errors.message.message}\n              </p>\n            )}\n          </div>\n\n          <Captcha\n            key={captchaResetKey} // Force le remontage pour un nouveau challenge\n            onVerify={(token) => {\n              setCaptchaToken(token);\n            }}\n            onExpire={() => {\n              setCaptchaToken(null);\n              // Le widget se réinitialise automatiquement\n            }}\n          />\n\n          <Button\n            type=\"submit\"\n            size=\"lg\"\n            disabled={isSubmitting || !captchaToken}\n            className=\"w-full rounded-full bg-primary text-black hover:bg-primary/90 disabled:opacity-50\"\n          >\n            {isSubmitting ? \"Envoi en cours...\" : \"Envoyer la demande\"}\n          </Button>\n        </form>\n\n        <div className=\"mt-10 text-center\">\n          <p className=\"text-sm text-white/40\">Ou discutez directement</p>\n          <Link\n            href=\"https://wa.me/221770000000\"\n            target=\"_blank\"\n            rel=\"noreferrer\"\n            onClick={() => {\n              sendGTMEvent(\"contact_click\", {\n                method: \"whatsapp\",\n                value: \"page_planifier_bottom\"\n              });\n            }}\n            className=\"mt-3 inline-flex items-center justify-center gap-2 text-sm font-medium text-emerald-500 transition hover:text-emerald-600\"\n          >\n            <MessageCircle className=\"h-5 w-5\" />\n            Discuter directement sur WhatsApp\n          </Link>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function PlanifierVisitePage() {\n  return (\n    <Suspense fallback={\n      <div className=\"flex min-h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500\"></div>\n      </div>\n    }>\n      <PlanifierVisitePageContent />\n    </Suspense>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\recherche\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getLatestProperties' is defined but never used.","line":3,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { SearchExperience } from \"@/components/search/search-experience\";\r\nimport {\r\n  getLatestProperties,\r\n  getProperties,\r\n  type PropertyFilters,\r\n} from \"@/services/propertyService\";\r\n\r\ntype SearchPageProps = {\r\n  searchParams: Promise<Record<string, string | string[] | undefined>>;\r\n};\r\n\r\nexport const metadata = {\r\n  title: \"Recherche · Dousell Immo\",\r\n};\r\n\r\n// Utiliser ISR pour optimiser les performances\r\n// Revalidation toutes les 10 minutes (600s)\r\nexport const revalidate = 600;\r\n\r\n// Rendre la page dynamique seulement si nécessaire\r\nexport const dynamic = \"auto\";\r\nexport const dynamicParams = true;\r\n\r\nconst recordToFilters = (\r\n  params: Record<string, string | string[] | undefined>\r\n) => {\r\n  const filters: PropertyFilters = {};\r\n  \r\n  // Recherche textuelle (q ou location)\r\n  if (params.q && typeof params.q === \"string\") {\r\n    filters.location = params.q;\r\n  }\r\n  \r\n  // Catégorie (category) : location ou vente\r\n  if (params.category && typeof params.category === \"string\") {\r\n    filters.category = params.category as PropertyFilters[\"category\"];\r\n  }\r\n  \r\n  // Type de bien (type) : Maison, Appartement, Studio, Terrain, etc.\r\n  if (params.type && typeof params.type === \"string\") {\r\n    filters.type = params.type as PropertyFilters[\"type\"];\r\n  }\r\n  \r\n  // Ville (city)\r\n  if (params.city && typeof params.city === \"string\") {\r\n    filters.city = params.city;\r\n  }\r\n  \r\n  // Prix\r\n  if (params.minPrice) {\r\n    filters.minPrice = Number(params.minPrice);\r\n  }\r\n  if (params.maxPrice) {\r\n    filters.maxPrice = Number(params.maxPrice);\r\n  }\r\n  \r\n  // Spécifications\r\n  if (params.rooms) {\r\n    filters.rooms = Number(params.rooms);\r\n  }\r\n  if (params.bedrooms) {\r\n    filters.bedrooms = Number(params.bedrooms);\r\n  }\r\n  \r\n  // Features Dakar\r\n  if (params.hasBackupGenerator === \"true\") {\r\n    filters.hasBackupGenerator = true;\r\n  }\r\n  if (params.hasWaterTank === \"true\") {\r\n    filters.hasWaterTank = true;\r\n  }\r\n  \r\n  return filters;\r\n};\r\n\r\nexport default async function SearchPage({ searchParams }: SearchPageProps) {\r\n  const resolved = await searchParams;\r\n  const filters = recordToFilters(resolved);\r\n  const hasActiveFilters = Object.keys(filters).length > 0;\r\n  // Sans filtres, afficher toutes les annonces approuvées (pas de limite)\r\n  // Avec filtres, utiliser getProperties qui respecte les filtres\r\n  const properties = hasActiveFilters\r\n    ? await getProperties(filters)\r\n    : await getProperties({}); // Pas de limite = toutes les annonces approuvées\r\n\r\n  return (\r\n    <div className=\"space-y-6 py-6\">\r\n      <h1 className=\"text-3xl font-semibold text-white\">Explorer les biens</h1>\r\n      <SearchExperience initialFilters={filters} initialResults={properties} />\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\register\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectedFlag' is assigned a value but never used.","line":54,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":54,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'callingCode' is assigned a value but never used.","line":54,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":54,"endColumn":42},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\register\\page.tsx:62:11\n  60 |         const phoneNumber = parsePhoneNumber(phoneValue);\n  61 |         if (phoneNumber && phoneNumber.country) {\n> 62 |           setSelectedCountry(phoneNumber.country as RPNInput.Country);\n     |           ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  63 |         }\n  64 |       } catch (e) {\n  65 |         // Ignorer les erreurs de détection de pays (numéro invalide, etc.)","line":62,"column":11,"nodeType":null,"endLine":62,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":64,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":64,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useTransition, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  User,\r\n  Mail,\r\n  Lock,\r\n  Eye,\r\n  EyeOff,\r\n  ArrowLeft,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport * as RPNInput from \"react-phone-number-input\";\r\nimport { getCountryCallingCode } from \"react-phone-number-input\";\r\nimport { parsePhoneNumber } from \"libphonenumber-js\";\r\nimport flags from \"react-phone-number-input/flags\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { PhoneInput } from \"@/components/ui/phone-input\";\r\nimport { Captcha } from \"@/components/ui/captcha\";\r\nimport { signup } from \"@/app/auth/actions\";\r\n\r\nexport default function RegisterPage() {\r\n  const router = useRouter();\r\n  const [isPending, startTransition] = useTransition();\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [phoneValue, setPhoneValue] = useState<RPNInput.Value | undefined>(undefined);\r\n  const [selectedCountry, setSelectedCountry] = useState<RPNInput.Country>(\"SN\");\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [captchaToken, setCaptchaToken] = useState<string | null>(null);\r\n  const [validationErrors, setValidationErrors] = useState<{\r\n    fullName?: string;\r\n    email?: string;\r\n    phone?: string;\r\n    password?: string;\r\n    confirmPassword?: string;\r\n  }>({});\r\n\r\n  // Fonction pour obtenir le drapeau et l'indicatif du pays\r\n  const getCountryInfo = (country: RPNInput.Country | undefined) => {\r\n    if (!country) {\r\n      return { Flag: null, callingCode: \"\" };\r\n    }\r\n    const Flag = flags[country];\r\n    const callingCode = getCountryCallingCode(country);\r\n    return { Flag, callingCode };\r\n  };\r\n\r\n  const { Flag: SelectedFlag, callingCode } = getCountryInfo(selectedCountry);\r\n\r\n  // Synchroniser le pays sélectionné avec la valeur du téléphone\r\n  useEffect(() => {\r\n    if (phoneValue && typeof phoneValue === \"string\") {\r\n      try {\r\n        const phoneNumber = parsePhoneNumber(phoneValue);\r\n        if (phoneNumber && phoneNumber.country) {\r\n          setSelectedCountry(phoneNumber.country as RPNInput.Country);\r\n        }\r\n      } catch (e) {\r\n        // Ignorer les erreurs de détection de pays (numéro invalide, etc.)\r\n      }\r\n    }\r\n  }, [phoneValue]);\r\n\r\n  const handleGoogleSignIn = () => {\r\n    // Utiliser une route API pour Google OAuth (meilleure gestion des cookies PKCE)\r\n    window.location.href = \"/auth/google\";\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-background via-background to-black px-4 py-12\">\r\n      <motion.div\r\n        initial={{ opacity: 0, y: 20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        transition={{ duration: 0.5 }}\r\n        className=\"w-full max-w-md\"\r\n      >\r\n        {/* Back Button */}\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          className=\"mb-6 -ml-2 text-white/70 hover:text-white\"\r\n          asChild\r\n        >\r\n          <Link href=\"/\">\r\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n            Retour\r\n          </Link>\r\n        </Button>\r\n\r\n        {/* Card */}\r\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur-xl md:bg-white/10\">\r\n          {/* Header */}\r\n          <div className=\"mb-8 text-center\">\r\n            <Link href=\"/\" className=\"inline-block\">\r\n              <h1 className=\"text-2xl font-bold text-white\">Dousell Immo</h1>\r\n            </Link>\r\n            <h2 className=\"mt-4 text-2xl font-semibold text-white\">\r\n              Créer un compte\r\n            </h2>\r\n            <p className=\"mt-2 text-sm text-white/70\">\r\n              Accédez aux meilleures offres de Dakar\r\n            </p>\r\n          </div>\r\n\r\n          {/* Social Login */}\r\n          <div className=\"mb-6 space-y-3\">\r\n            <form action={handleGoogleSignIn}>\r\n              <Button\r\n                type=\"submit\"\r\n                variant=\"secondary\"\r\n                disabled={isPending}\r\n                className=\"w-full rounded-xl border border-gray-200 bg-background text-foreground hover:bg-gray-50\"\r\n              >\r\n                <svg\r\n                  className=\"mr-2 h-5 w-5\"\r\n                  viewBox=\"0 0 24 24\"\r\n                  fill=\"none\"\r\n                  xmlns=\"http://www.w3.org/2000/svg\"\r\n                >\r\n                  <path\r\n                    d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\"\r\n                    fill=\"#4285F4\"\r\n                  />\r\n                  <path\r\n                    d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\"\r\n                    fill=\"#34A853\"\r\n                  />\r\n                  <path\r\n                    d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\"\r\n                    fill=\"#FBBC05\"\r\n                  />\r\n                  <path\r\n                    d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\"\r\n                    fill=\"#EA4335\"\r\n                  />\r\n                </svg>\r\n                {isPending ? \"Connexion...\" : \"Continuer avec Google\"}\r\n              </Button>\r\n            </form>\r\n            {/* <Button\r\n              type=\"button\"\r\n              variant=\"secondary\"\r\n              className=\"w-full rounded-xl border border-white/20 bg-black text-white hover:bg-gray-900\"\r\n              onClick={() =>\r\n                toast.info(\"Connexion sociale à venir\", {\r\n                  description: \"La connexion avec Apple sera disponible prochainement\",\r\n                })\r\n              }\r\n            >\r\n              <svg\r\n                className=\"mr-2 h-5 w-5\"\r\n                viewBox=\"0 0 24 24\"\r\n                fill=\"currentColor\"\r\n                xmlns=\"http://www.w3.org/2000/svg\"\r\n              >\r\n                <path d=\"M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z\" />\r\n              </svg>\r\n              Continuer avec Apple\r\n            </Button> */}\r\n          </div>\r\n\r\n          {/* Separator */}\r\n          <div className=\"relative mb-6\">\r\n            <div className=\"absolute inset-0 flex items-center\">\r\n              <div className=\"w-full border-t border-white/10\"></div>\r\n            </div>\r\n            <div className=\"relative flex justify-center text-xs uppercase\">\r\n              <span className=\"bg-white/5 px-2 text-white/50\">ou</span>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Form */}\r\n          <form\r\n            action={async (formData: FormData) => {\r\n              setError(null);\r\n              setValidationErrors({});\r\n\r\n              if (!captchaToken) {\r\n                toast.error(\"Veuillez compléter la vérification anti-robot\");\r\n                return;\r\n              }\r\n\r\n              formData.append(\"turnstileToken\", captchaToken);\r\n\r\n              // Validation côté client\r\n              const fullName = formData.get(\"fullName\") as string;\r\n              const email = formData.get(\"email\") as string;\r\n              const phone = formData.get(\"phone\") as string;\r\n              const password = formData.get(\"password\") as string;\r\n              const confirmPassword = formData.get(\"confirmPassword\") as string;\r\n\r\n              const errors: typeof validationErrors = {};\r\n\r\n              if (!fullName || fullName.trim().length < 2) {\r\n                errors.fullName = \"Le nom complet doit contenir au moins 2 caractères\";\r\n              }\r\n\r\n              if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\r\n                errors.email = \"Adresse email invalide\";\r\n              }\r\n\r\n              // Validation du téléphone (format international)\r\n              if (!phone || phone.trim().length < 8) {\r\n                errors.phone = \"Numéro de téléphone invalide\";\r\n              } else {\r\n                // Vérifier que c'est un numéro valide (au moins 8 caractères après l'indicatif)\r\n                const phoneWithoutSpaces = phone.replace(/\\s/g, \"\");\r\n                if (phoneWithoutSpaces.length < 8) {\r\n                  errors.phone = \"Numéro de téléphone invalide\";\r\n                }\r\n              }\r\n\r\n              if (!password || password.length < 6) {\r\n                errors.password = \"Le mot de passe doit contenir au moins 6 caractères\";\r\n              }\r\n\r\n              if (password !== confirmPassword) {\r\n                errors.confirmPassword = \"Les mots de passe ne correspondent pas\";\r\n              }\r\n\r\n              if (Object.keys(errors).length > 0) {\r\n                setValidationErrors(errors);\r\n                toast.error(\"Veuillez corriger les erreurs dans le formulaire\");\r\n                return;\r\n              }\r\n\r\n              // La vérification HIBP se fait maintenant côté serveur dans la Server Action signup()\r\n              // Cela évite les problèmes CORS et améliore la sécurité\r\n\r\n              startTransition(async () => {\r\n                const result = await signup(formData);\r\n                console.log(\"📋 Résultat signup:\", result); // Log pour debugging\r\n                if (result?.error) {\r\n                  setError(result.error);\r\n                  console.error(\"🔴 Erreur affichée à l'utilisateur:\", result.error);\r\n                  // Afficher un toast uniquement pour les erreurs critiques (pas de duplication avec la boîte d'erreur)\r\n                  // Le toast est plus visible et disparaît automatiquement\r\n                  if (result.error.includes(\"Trop de tentatives\")) {\r\n                    toast.error(\"Trop de tentatives\", {\r\n                      description: \"Pour votre sécurité, veuillez attendre 5 minutes avant de réessayer.\",\r\n                      duration: 8000,\r\n                    });\r\n                  } else if (result.error.includes(\"déjà enregistré\")) {\r\n                    toast.error(\"Email déjà utilisé\", {\r\n                      description: result.error,\r\n                      duration: 6000,\r\n                    });\r\n                  } else {\r\n                    // Pour les autres erreurs, afficher un toast court\r\n                    toast.error(result.error, {\r\n                      duration: 5000,\r\n                    });\r\n                  }\r\n                } else if (result?.success) {\r\n                  // Si l'utilisateur est automatiquement confirmé et connecté\r\n                  if (result.autoConfirmed) {\r\n                    toast.success(\"Compte créé avec succès !\", {\r\n                      description: \"Vous êtes maintenant connecté. Bienvenue !\",\r\n                      duration: 3000,\r\n                    });\r\n                    // Rediriger vers la home\r\n                    setTimeout(() => {\r\n                      router.push(\"/\");\r\n                      router.refresh();\r\n                    }, 1500);\r\n                  }\r\n                  // Si l'email de confirmation est requis\r\n                  else if (result.emailSent) {\r\n                    toast.success(\"Compte créé !\", {\r\n                      description: \"Un lien de confirmation a été envoyé à votre adresse email.\",\r\n                      duration: 3000,\r\n                    });\r\n                    // Rediriger vers la page de vérification email\r\n                    setTimeout(() => {\r\n                      router.push(`/auth/check-email?email=${encodeURIComponent(email)}`);\r\n                    }, 1500);\r\n                  }\r\n                  // Cas par défaut (compte créé mais pas encore confirmé)\r\n                  else {\r\n                    toast.success(\"Compte créé avec succès !\", {\r\n                      description: result.message || \"Vous pouvez maintenant vous connecter.\",\r\n                      duration: 3000,\r\n                    });\r\n                    // Rediriger vers la page de connexion\r\n                    setTimeout(() => {\r\n                      router.push(\"/login\");\r\n                    }, 2000);\r\n                  }\r\n                }\r\n              });\r\n            }}\r\n            className=\"space-y-4\"\r\n          >\r\n            {error && (\r\n              <div className=\"rounded-xl bg-red-500/10 border border-red-500/20 p-3 text-sm text-red-400\">\r\n                {error}\r\n              </div>\r\n            )}\r\n\r\n            {/* Full Name */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"fullName\" className=\"text-white/70\">\r\n                Nom complet\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <User className=\"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-white/40\" />\r\n                <Input\r\n                  id=\"fullName\"\r\n                  name=\"fullName\"\r\n                  type=\"text\"\r\n                  placeholder=\"Oumar Diallo\"\r\n                  required\r\n                  minLength={2}\r\n                  maxLength={100}\r\n                  className={`h-12 rounded-xl border-white/10 bg-white/5 pl-10 text-white placeholder:text-white/40 focus:border-amber-500 focus:ring-amber-500 ${validationErrors.fullName ? \"border-red-500/50\" : \"\"\r\n                    }`}\r\n                />\r\n              </div>\r\n              {validationErrors.fullName && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.fullName}</p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Email */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"email\" className=\"text-white/70\">\r\n                Email\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <Mail className=\"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-white/40\" />\r\n                <Input\r\n                  id=\"email\"\r\n                  name=\"email\"\r\n                  type=\"email\"\r\n                  placeholder=\"oumar@example.com\"\r\n                  required\r\n                  className={`h-12 rounded-xl border-white/10 bg-white/5 pl-10 text-white placeholder:text-white/40 focus:border-amber-500 focus:ring-amber-500 ${validationErrors.email ? \"border-red-500/50\" : \"\"\r\n                    }`}\r\n                />\r\n              </div>\r\n              {validationErrors.email && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.email}</p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Phone */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"phone\" className=\"text-white/70\">\r\n                Téléphone\r\n              </Label>\r\n              <PhoneInput\r\n                id=\"phone\"\r\n                value={phoneValue}\r\n                onChange={(value) => {\r\n                  setPhoneValue(value);\r\n                }}\r\n                defaultCountry=\"SN\"\r\n                international\r\n                placeholder=\"Entrez votre numéro\"\r\n                className={`${validationErrors.phone ? \"border-red-500/50\" : \"\"\r\n                  }`}\r\n                required\r\n              />\r\n              {/* Input caché pour envoyer la valeur dans le FormData */}\r\n              <input\r\n                type=\"hidden\"\r\n                name=\"phone\"\r\n                value={phoneValue || \"\"}\r\n              />\r\n              {validationErrors.phone && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.phone}</p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Password */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"password\" className=\"text-white/70\">\r\n                Mot de passe\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <Lock className=\"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-white/40\" />\r\n                <Input\r\n                  id=\"password\"\r\n                  name=\"password\"\r\n                  type={showPassword ? \"text\" : \"password\"}\r\n                  placeholder=\"••••••••\"\r\n                  required\r\n                  minLength={6}\r\n                  className=\"h-12 rounded-xl border-white/10 bg-white/5 pl-10 pr-10 text-white placeholder:text-white/40 focus:border-amber-500 focus:ring-amber-500\"\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowPassword(!showPassword)}\r\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white/70\"\r\n                  aria-label={\r\n                    showPassword\r\n                      ? \"Masquer le mot de passe\"\r\n                      : \"Afficher le mot de passe\"\r\n                  }\r\n                >\r\n                  {showPassword ? (\r\n                    <EyeOff className=\"h-5 w-5\" />\r\n                  ) : (\r\n                    <Eye className=\"h-5 w-5\" />\r\n                  )}\r\n                </button>\r\n              </div>\r\n              <p className=\"text-xs text-white/50\">\r\n                Minimum 6 caractères\r\n              </p>\r\n              {validationErrors.password && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.password}</p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Confirm Password */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"confirmPassword\" className=\"text-white/70\">\r\n                Confirmer le mot de passe\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <Lock className=\"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-white/40\" />\r\n                <Input\r\n                  id=\"confirmPassword\"\r\n                  name=\"confirmPassword\"\r\n                  type={showPassword ? \"text\" : \"password\"}\r\n                  placeholder=\"••••••••\"\r\n                  required\r\n                  minLength={6}\r\n                  className=\"h-12 rounded-xl border-white/10 bg-white/5 pl-10 pr-10 text-white placeholder:text-white/40 focus:border-amber-500 focus:ring-amber-500\"\r\n                />\r\n              </div>\r\n              {validationErrors.confirmPassword && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.confirmPassword}</p>\r\n              )}\r\n            </div>\r\n\r\n            <Captcha\r\n              onVerify={(token) => {\r\n                setCaptchaToken(token);\r\n              }}\r\n              onExpire={() => {\r\n                setCaptchaToken(null);\r\n                // Le widget se réinitialise automatiquement\r\n              }}\r\n            />\r\n\r\n            {/* Submit Button */}\r\n            <Button\r\n              type=\"submit\"\r\n              disabled={isPending || !captchaToken}\r\n              className=\"mt-6 h-12 w-full rounded-xl bg-primary text-black hover:bg-primary/90 disabled:opacity-50\"\r\n            >\r\n              {isPending ? (\r\n                <>\r\n                  <svg\r\n                    className=\"mr-2 h-5 w-5 animate-spin\"\r\n                    xmlns=\"http://www.w3.org/2000/svg\"\r\n                    fill=\"none\"\r\n                    viewBox=\"0 0 24 24\"\r\n                  >\r\n                    <circle\r\n                      className=\"opacity-25\"\r\n                      cx=\"12\"\r\n                      cy=\"12\"\r\n                      r=\"10\"\r\n                      stroke=\"currentColor\"\r\n                      strokeWidth=\"4\"\r\n                    ></circle>\r\n                    <path\r\n                      className=\"opacity-75\"\r\n                      fill=\"currentColor\"\r\n                      d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\r\n                    ></path>\r\n                  </svg>\r\n                  Inscription en cours...\r\n                </>\r\n              ) : (\r\n                \"S'inscrire\"\r\n              )}\r\n            </Button>\r\n          </form>\r\n\r\n          {/* Footer Link */}\r\n          <p className=\"mt-6 text-center text-sm text-white/70\">\r\n            Déjà un compte ?{\" \"}\r\n            <Link\r\n              href=\"/login\"\r\n              className=\"font-semibold text-amber-400 hover:text-amber-300 underline-offset-4 hover:underline\"\r\n            >\r\n              Se connecter\r\n            </Link>\r\n          </p>\r\n        </div>\r\n      </motion.div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\template.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\test-supabase\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\check-env.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":37},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":21,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":36}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { config } = require(\"dotenv\");\r\nconst { resolve } = require(\"path\");\r\n\r\nconfig({ path: resolve(process.cwd(), \".env.local\") });\r\n\r\nconsole.log(\"NEXT_PUBLIC_TURNSTILE_SITE_KEY:\", process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY ? \"DEFINED\" : \"MISSING\");\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\check_schema.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":8,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js';\r\nimport dotenv from 'dotenv';\r\ndotenv.config({ path: '.env.local' });\r\n\r\nconst supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!);\r\n\r\nasync function check() {\r\n    const { data, error } = await supabase\r\n        .from('rental_transactions')\r\n        .select('amount_paid')\r\n        .limit(1);\r\n\r\n    if (error) {\r\n        console.log(\"Error:\", error.message);\r\n    } else {\r\n        console.log(\"Success! Column exists.\");\r\n    }\r\n}\r\n\r\ncheck();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\check_status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\admin-sidebar-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\admin-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\admin-topbar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentPath' is assigned a value but never used.","line":19,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Link from \"next/link\";\nimport { usePathname } from \"next/navigation\";\nimport { ChevronRight, Home, Menu } from \"lucide-react\";\nimport { UserNav } from \"@/components/layout/user-nav\";\nimport { Sheet, SheetContent, SheetTrigger } from \"@/components/ui/sheet\";\nimport { Button } from \"@/components/ui/button\";\n\nexport function AdminTopbar() {\n  const pathname = usePathname();\n\n  // Générer le fil d'ariane\n  const generateBreadcrumbs = () => {\n    const paths = pathname?.split(\"/\").filter(Boolean) || [];\n    const breadcrumbs = [{ label: \"Admin\", href: \"/admin\" }];\n\n    if (paths.length > 1) {\n      const currentPath = paths.slice(1).join(\"/\");\n      const pathLabels: Record<string, string> = {\n        biens: \"Biens\",\n        users: \"Utilisateurs\",\n        leads: \"Leads\",\n        settings: \"Paramètres\",\n        dashboard: \"Dashboard\",\n        nouveau: \"Nouveau\",\n        moderation: \"Modération\",\n        roles: \"Rôles\",\n      };\n\n      paths.slice(1).forEach((segment, index) => {\n        const href = `/${paths.slice(0, index + 2).join(\"/\")}`;\n        const label = pathLabels[segment] || segment;\n        breadcrumbs.push({ label, href });\n      });\n    }\n\n    return breadcrumbs;\n  };\n\n  const breadcrumbs = generateBreadcrumbs();\n\n  // Navigation items (dupliqué depuis AdminSidebar pour éviter la dépendance circulaire)\n  const navItems = [\n    { href: \"/admin\", label: \"Dashboard\" },\n    { href: \"/admin/dashboard\", label: \"Biens\" },\n    { href: \"/admin/moderation\", label: \"Modération\" },\n    { href: \"/admin/leads\", label: \"Leads/Messages\" },\n    { href: \"/admin/roles\", label: \"Rôles\" },\n  ];\n\n  return (\n    <header className=\"sticky top-0 z-40 flex h-16 items-center justify-between border-b border-white/10 bg-[#0b0f18]/95 px-4 backdrop-blur-sm md:px-6\">\n      {/* Mobile Menu Button */}\n      <Sheet>\n        <SheetTrigger asChild>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"md:hidden\"\n            aria-label=\"Ouvrir le menu\"\n          >\n            <Menu className=\"h-5 w-5 text-white\" />\n          </Button>\n        </SheetTrigger>\n        <SheetContent className=\"left-0 top-0 h-full w-64 max-h-full rounded-none border-r border-t-0 p-0 data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left\">\n          <div className=\"flex h-full flex-col border-r border-white/10 bg-[#0b0f18]\">\n            <div className=\"flex h-16 items-center border-b border-white/10 px-6\">\n              <Link href=\"/admin\" className=\"flex items-center gap-2\">\n                <div className=\"flex h-8 w-8 items-center justify-center rounded-lg bg-white/10\">\n                  <Home className=\"h-5 w-5 text-white\" />\n                </div>\n                <span className=\"text-lg font-semibold text-white\">Dousell Immo</span>\n              </Link>\n            </div>\n            <nav className=\"flex-1 space-y-1 px-4 py-6\">\n              {navItems.map((item) => {\n                const active = pathname === item.href || \n                  (item.href === \"/admin\" && pathname === \"/admin/dashboard\");\n                return (\n                  <Link\n                    key={item.href}\n                    href={item.href}\n                    className={`flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors ${\n                      active\n                        ? \"bg-white/10 text-white\"\n                        : \"text-white/70 hover:bg-white/5 hover:text-white\"\n                    }`}\n                  >\n                    {item.label}\n                  </Link>\n                );\n              })}\n            </nav>\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Breadcrumbs */}\n      <nav className=\"flex items-center gap-2 text-sm text-white/60\">\n        <Link\n          href=\"/\"\n          className=\"flex items-center gap-1 hover:text-white transition-colors\"\n        >\n          <Home className=\"h-4 w-4\" />\n          <span className=\"hidden sm:inline\">Accueil</span>\n        </Link>\n        {breadcrumbs.map((crumb, index) => (\n          <div key={crumb.href} className=\"flex items-center gap-2\">\n            <ChevronRight className=\"h-4 w-4\" />\n            {index === breadcrumbs.length - 1 ? (\n              <span className=\"text-white font-medium\">{crumb.label}</span>\n            ) : (\n              <Link\n                href={crumb.href}\n                className=\"hover:text-white transition-colors\"\n              >\n                {crumb.label}\n              </Link>\n            )}\n          </div>\n        ))}\n      </nav>\n\n      {/* User Nav */}\n      <div className=\"flex items-center gap-4\">\n        <UserNav />\n      </div>\n    </header>\n  );\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\dashboard-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\dashboard-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'stats' is defined but never used.","line":48,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":48,"endColumn":8}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'daysMap'. Either include it or remove the dependency array.","line":90,"column":6,"nodeType":"ArrayExpression","endLine":90,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [daysMap, timeRange]","fix":{"range":[2891,2902],"text":"[daysMap, timeRange]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useMemo, useEffect } from \"react\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { fr } from \"date-fns/locale\";\nimport {\n  Eye,\n  MessageSquare,\n  Phone,\n  MousePointerClick,\n  ArrowUpRight,\n  ExternalLink,\n} from \"lucide-react\";\n\nimport type {\n  DashboardStats,\n  RecentActivity,\n  PerformanceStats,\n} from \"@/app/admin/actions\";\nimport type { RecentProperty } from \"@/app/admin/actions\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { PerformanceChart } from \"@/components/admin/performance-chart\";\nimport { TopPropertiesTable } from \"@/components/admin/top-properties-table\";\n\ntype TimeRange = \"7d\" | \"30d\" | \"90d\";\ntype ActiveMetric = \"views\" | \"contacts\";\n\ninterface DashboardViewProps {\n  stats: DashboardStats;\n  perfStats: PerformanceStats | null;\n  recentProperties: RecentProperty[];\n  recentActivity: RecentActivity[];\n}\n\nconst statusColors: Record<string, string> = {\n  disponible: \"bg-emerald-500/20 text-emerald-300 border-emerald-500/30\",\n  \"sous-offre\": \"bg-amber-500/20 text-amber-300 border-amber-500/30\",\n  vendu: \"bg-red-500/20 text-red-300 border-red-500/30\",\n};\n\nexport function DashboardView({\n  stats,\n  perfStats: initialPerfStats,\n  recentProperties,\n  recentActivity,\n}: DashboardViewProps) {\n  const [timeRange, setTimeRange] = useState<TimeRange>(\"30d\");\n  const [activeMetric, setActiveMetric] = useState<ActiveMetric>(\"views\");\n  const [perfStats, setPerfStats] = useState<PerformanceStats | null>(initialPerfStats);\n  const [isLoading, setIsLoading] = useState(false);\n\n  // Convertir timeRange en nombre de jours\n  const daysMap: Record<TimeRange, number> = {\n    \"7d\": 7,\n    \"30d\": 30,\n    \"90d\": 90,\n  };\n\n  // Fetch les données quand le timeRange change\n  useEffect(() => {\n    const fetchPerformanceStats = async () => {\n      setIsLoading(true);\n      try {\n        const days = daysMap[timeRange];\n        const response = await fetch(`/api/admin/performance?days=${days}`);\n\n        if (!response.ok) {\n          console.error(\"Erreur lors de la récupération des statistiques\");\n          return;\n        }\n\n        const data = await response.json();\n        setPerfStats(data);\n      } catch (error) {\n        console.error(\"Erreur lors du fetch des statistiques:\", error);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    // Toujours fetch pour avoir les données à jour selon la période\n    fetchPerformanceStats();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [timeRange]);\n\n  // Calcul du taux de contact global\n  const conversionRate =\n    perfStats && perfStats.totals.views > 0\n      ? ((perfStats.totals.clicks / perfStats.totals.views) * 100).toFixed(1)\n      : \"0.0\";\n\n  // Filtrer les données selon la période\n  const filteredChartData = useMemo(() => {\n    if (!perfStats) return [];\n    return perfStats.chart;\n  }, [perfStats]);\n\n  // Filtrer et trier les top propriétés selon la métrique active\n  const filteredTopProperties = useMemo(() => {\n    if (!perfStats) return [];\n\n    const properties = [...perfStats.topProperties];\n\n    if (activeMetric === \"views\") {\n      // Trier par vues décroissantes\n      return properties.sort((a, b) => b.views - a.views).slice(0, 5);\n    } else {\n      // Trier par clics décroissants\n      return properties.sort((a, b) => b.clicks - a.clicks).slice(0, 5);\n    }\n  }, [perfStats, activeMetric]);\n\n  // Préparer les données du graphique selon la métrique active\n  const chartDataForMetric = useMemo(() => {\n    if (!filteredChartData) return [];\n\n    return filteredChartData.map((d) => ({\n      date: d.date,\n      views: d.views,\n      whatsapp: d.whatsapp ?? 0,\n      phone: d.phone ?? 0,\n    }));\n  }, [filteredChartData]);\n\n  const timeRangeOptions = [\n    { value: \"7d\", label: \"7 derniers jours\" },\n    { value: \"30d\", label: \"30 derniers jours\" },\n    { value: \"90d\", label: \"Trimestre\" },\n  ];\n\n  const timeRangeLabels: Record<TimeRange, string> = {\n    \"7d\": \"7 derniers jours\",\n    \"30d\": \"30 derniers jours\",\n    \"90d\": \"Trimestre\",\n  };\n\n  return (\n    <div className=\"space-y-8 pb-10\">\n      {/* Section Performance avec Filtre */}\n      {perfStats && (\n        <div>\n          {/* Header avec Filtre */}\n          <div className=\"mb-4 flex items-center justify-between\">\n            <h2 className=\"text-lg font-medium text-white/80\">Performance</h2>\n            <Select\n              value={timeRange}\n              onValueChange={(value) => setTimeRange(value as TimeRange)}\n              disabled={isLoading}\n            >\n              <SelectTrigger className={`w-[180px] ${isLoading ? \"opacity-50 cursor-not-allowed\" : \"\"}`}>\n                <SelectValue placeholder=\"Sélectionner une période\" />\n              </SelectTrigger>\n              <SelectContent>\n                {timeRangeOptions.map((option) => (\n                  <SelectItem key={option.value} value={option.value}>\n                    {option.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Cartes KPI Cliquables */}\n          <div className=\"grid gap-4 md:grid-cols-3\">\n            {/* Carte Vues */}\n            <Card\n              onClick={() => setActiveMetric(\"views\")}\n              className={`cursor-pointer transition-all ${activeMetric === \"views\"\n                ? \"border-blue-500/50 bg-white/10 shadow-lg shadow-blue-500/10\"\n                : \"border-white/10 bg-white/5 opacity-70 hover:opacity-100 hover:bg-white/10\"\n                }`}\n            >\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium text-white/70\">\n                  Vues Totales\n                </CardTitle>\n                <Eye\n                  className={`h-4 w-4 ${activeMetric === \"views\" ? \"text-blue-400\" : \"text-white/40\"\n                    }`}\n                />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-white\">\n                  {perfStats.totals.views.toLocaleString()}\n                </div>\n                <p className=\"text-xs text-white/50 mt-1\">Pages vues sur les annonces</p>\n              </CardContent>\n            </Card>\n\n            {/* Carte Contacts */}\n            <Card\n              onClick={() => setActiveMetric(\"contacts\")}\n              className={`cursor-pointer transition-all ${activeMetric === \"contacts\"\n                ? \"border-emerald-500/50 bg-white/10 shadow-lg shadow-emerald-500/10\"\n                : \"border-white/10 bg-white/5 opacity-70 hover:opacity-100 hover:bg-white/10\"\n                }`}\n            >\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium text-white/70\">\n                  Contacts Générés\n                </CardTitle>\n                <div className=\"flex gap-1\">\n                  <MessageSquare\n                    className={`h-4 w-4 ${activeMetric === \"contacts\"\n                      ? \"text-emerald-400\"\n                      : \"text-white/40\"\n                      }`}\n                  />\n                  <Phone\n                    className={`h-4 w-4 ${activeMetric === \"contacts\"\n                      ? \"text-emerald-400\"\n                      : \"text-white/40\"\n                      }`}\n                  />\n                </div>\n              </CardHeader>\n              <CardContent>\n                <TooltipProvider>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"text-2xl font-bold text-white cursor-help underline decoration-dotted decoration-white/40 underline-offset-4 hover:decoration-white/60 transition-colors\">\n                        {perfStats.totals.clicks.toLocaleString()}\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent\n                      side=\"top\"\n                      className=\"bg-[#0b0f18] border-white/10 shadow-lg\"\n                    >\n                      <div className=\"space-y-2 text-xs\">\n                        <div className=\"flex items-center gap-2\">\n                          <MessageSquare className=\"h-3.5 w-3.5 text-[#25D366]\" />\n                          <span className=\"text-white/90\">\n                            WhatsApp :{\" \"}\n                            <span className=\"font-semibold text-white\">\n                              {perfStats.totals.whatsappCount}\n                            </span>\n                          </span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Phone className=\"h-3.5 w-3.5 text-blue-400\" />\n                          <span className=\"text-white/90\">\n                            Appels :{\" \"}\n                            <span className=\"font-semibold text-white\">\n                              {perfStats.totals.phoneCount}\n                            </span>\n                          </span>\n                        </div>\n                      </div>\n                    </TooltipContent>\n                  </Tooltip>\n                </TooltipProvider>\n                <p className=\"text-xs text-white/50 mt-1\">Clics WhatsApp & Téléphone</p>\n              </CardContent>\n            </Card>\n\n            {/* Carte Taux de Contact */}\n            <Card className=\"border-white/10 bg-white/5\">\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium text-white/70\">\n                  Taux de Contact\n                </CardTitle>\n                <MousePointerClick className=\"h-4 w-4 text-amber-400\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-white\">{conversionRate}%</div>\n                <p className=\"text-xs text-white/50 mt-1\">Clics / Vues</p>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Graphique et Top Biens */}\n          <div className=\"grid gap-4 md:grid-cols-3 mt-4\">\n            {/* Graphique Performance Dynamique */}\n            <Card className=\"md:col-span-2 border-white/10 bg-white/5\">\n              <CardHeader>\n                <CardTitle className=\"text-white text-base flex items-center gap-2\">\n                  <span>\n                    Évolution des {activeMetric === \"views\" ? \"Vues\" : \"Contacts\"} (\n                    {timeRangeLabels[timeRange]})\n                  </span>\n                  {isLoading && (\n                    <span className=\"text-xs text-white/40 animate-pulse\">\n                      Chargement...\n                    </span>\n                  )}\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"pl-0\">\n                {isLoading ? (\n                  <div className=\"flex h-[350px] items-center justify-center text-white/40\">\n                    Chargement des données...\n                  </div>\n                ) : (\n                  <PerformanceChart data={chartDataForMetric} metric={activeMetric} />\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Top Biens Dynamique */}\n            <Card className=\"border-white/10 bg-white/5 flex flex-col\">\n              <CardHeader>\n                <CardTitle className=\"text-white text-base flex items-center justify-between\">\n                  <span>\n                    Top Biens ({activeMetric === \"views\" ? \"Vues\" : \"Contacts\"})\n                  </span>\n                  <Badge\n                    variant=\"secondary\"\n                    className=\"bg-white/10 text-white/70 hover:bg-white/20\"\n                  >\n                    {activeMetric === \"views\" ? \"Populaires\" : \"Performants\"}\n                  </Badge>\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"p-0 flex-1\">\n                <TopPropertiesTable properties={filteredTopProperties} />\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      )}\n\n      {/* Section Activité Récente & Derniers ajouts */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        {/* Activité Récente */}\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <CardTitle className=\"text-white text-lg\">Activité récente</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {recentActivity.length > 0 ? (\n                recentActivity.map((activity) => (\n                  <div\n                    key={activity.id}\n                    className=\"flex items-start gap-3 text-sm\"\n                  >\n                    <div className=\"mt-1.5 h-1.5 w-1.5 rounded-full bg-white/40\" />\n                    <div className=\"flex-1\">\n                      <p className=\"text-white/80\">{activity.message}</p>\n                      <p className=\"text-xs text-white/40 mt-0.5\">\n                        {formatDistanceToNow(activity.date, {\n                          addSuffix: true,\n                          locale: fr,\n                        })}\n                      </p>\n                    </div>\n                  </div>\n                ))\n              ) : (\n                <p className=\"text-sm text-white/50\">Aucune activité récente</p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Tableau Derniers Biens */}\n        <Card className=\"md:col-span-2 border-white/10 bg-white/5\">\n          <CardHeader className=\"flex flex-row items-center justify-between\">\n            <div>\n              <CardTitle className=\"text-white text-lg\">Derniers ajouts</CardTitle>\n            </div>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"text-white/60 hover:text-white\"\n              asChild\n            >\n              <Link href=\"/admin/biens\">\n                Tout voir <ArrowUpRight className=\"ml-1 h-4 w-4\" />\n              </Link>\n            </Button>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            {recentProperties.length > 0 ? (\n              <div className=\"overflow-x-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]\">\n                <table className=\"w-full text-left text-sm\">\n                  <thead className=\"border-b border-white/5 bg-white/5 text-xs uppercase tracking-wider text-white/60\">\n                    <tr>\n                      <th className=\"px-6 py-3\">ID</th>\n                      <th className=\"px-6 py-3\">Bien</th>\n                      <th className=\"px-6 py-3\">Prix</th>\n                      <th className=\"px-6 py-3\">Statut</th>\n                      <th className=\"px-6 py-3 text-right\">Date</th>\n                    </tr>\n                  </thead>\n                  <tbody className=\"divide-y divide-white/5\">\n                    {recentProperties.map((property) => (\n                      <tr\n                        key={property.id}\n                        className=\"transition-colors hover:bg-white/5 group\"\n                      >\n                        <td className=\"px-6 py-4 text-xs font-mono text-white/30\">\n                          #{property.id.slice(-4)}\n                        </td>\n                        <td className=\"px-6 py-4\">\n                          <Link\n                            href={`/biens/${property.id}`}\n                            target=\"_blank\"\n                            className=\"flex items-center gap-3 group/link\"\n                          >\n                            {property.image ? (\n                              <div className=\"relative h-10 w-10 overflow-hidden rounded-md transition-transform group-hover/link:scale-105\">\n                                <Image\n                                  src={property.image}\n                                  alt={property.title}\n                                  fill\n                                  sizes=\"40px\"\n                                  className=\"object-cover\"\n                                />\n                              </div>\n                            ) : (\n                              <div className=\"h-10 w-10 rounded-md bg-white/10\" />\n                            )}\n                            <div className=\"max-w-[200px]\">\n                              <div className=\"flex items-center gap-1.5\">\n                                <p className=\"font-medium text-white truncate group-hover/link:text-amber-400 transition-colors\">\n                                  {property.title}\n                                </p>\n                                <ExternalLink className=\"h-3 w-3 text-white/30 opacity-0 -translate-x-1 group-hover/link:opacity-100 group-hover/link:translate-x-0 transition-all\" />\n                              </div>\n                              {property.validationStatus === \"pending\" && (\n                                <span className=\"text-[10px] text-amber-400 block mt-0.5\">\n                                  • En attente de validation\n                                </span>\n                              )}\n                            </div>\n                          </Link>\n                        </td>\n                        <td className=\"px-6 py-4 text-white/80 whitespace-nowrap\">\n                          {new Intl.NumberFormat(\"fr-SN\", {\n                            maximumFractionDigits: 0,\n                          }).format(property.price)}{\" \"}\n                          <span className=\"text-xs text-white/40\">FCFA</span>\n                        </td>\n                        <td className=\"px-6 py-4\">\n                          <Badge\n                            variant=\"outline\"\n                            className={`${statusColors[property.status] ||\n                              \"border-white/20 text-white/60\"\n                              } border-0`}\n                          >\n                            {property.status}\n                          </Badge>\n                        </td>\n                        <td className=\"px-6 py-4 text-right text-xs text-white/50 whitespace-nowrap\">\n                          {formatDistanceToNow(property.createdAt, {\n                            addSuffix: true,\n                            locale: fr,\n                          })}\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            ) : (\n              <div className=\"py-12 text-center text-white/40\">\n                Aucun bien ajouté récemment\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\performance-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\top-properties-table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\verification-queue.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":7,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VerificationStatusBadge' is defined but never used.","line":27,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState, useTransition } from \"react\";\nimport { CheckCircle2, XCircle, FileText, ExternalLink, Loader2 } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\n\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { VerificationStatusBadge } from \"@/components/dashboard/verification-status-badge\";\nimport { getPendingVerifications, reviewVerification } from \"@/app/_actions/admin-verification\";\nimport type { VerificationRequest } from \"@/app/_actions/admin-verification\";\n\nexport function VerificationQueue() {\n  const [verifications, setVerifications] = useState<VerificationRequest[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [selectedVerification, setSelectedVerification] = useState<VerificationRequest | null>(null);\n  const [reviewDialogOpen, setReviewDialogOpen] = useState(false);\n  const [reviewAction, setReviewAction] = useState<\"approve\" | \"reject\" | null>(null);\n  const [isPending, startTransition] = useTransition();\n\n  const loadVerifications = async () => {\n    console.log(\"🔍 [VerificationQueue] Début chargement des vérifications...\");\n    setLoading(true);\n    try {\n      const result = await getPendingVerifications();\n      console.log(\"🔍 [VerificationQueue] Résultat reçu:\", result);\n      console.log(\"🔍 [VerificationQueue] Success:\", result.success);\n      console.log(\"🔍 [VerificationQueue] Data length:\", result.data?.length);\n      console.log(\"🔍 [VerificationQueue] Error:\", result.error);\n\n      if (result.success && result.data) {\n        console.log(\"✅ [VerificationQueue] Données chargées:\", result.data.length, \"vérifications\");\n        setVerifications(result.data);\n      } else {\n        console.error(\"❌ [VerificationQueue] Erreur:\", result.error);\n        toast.error(\"Erreur\", {\n          description: result.error || \"Impossible de charger les demandes.\",\n        });\n      }\n    } catch (error) {\n      console.error(\"❌ [VerificationQueue] Exception:\", error);\n      toast.error(\"Erreur\", {\n        description: \"Une erreur inattendue s'est produite.\",\n      });\n    } finally {\n      setLoading(false);\n      console.log(\"🔍 [VerificationQueue] Chargement terminé\");\n    }\n  };\n\n  useEffect(() => {\n    loadVerifications();\n  }, []);\n\n  const handleReview = (verification: VerificationRequest, action: \"approve\" | \"reject\") => {\n    setSelectedVerification(verification);\n    setReviewAction(action);\n    setReviewDialogOpen(true);\n  };\n\n  const confirmReview = () => {\n    if (!selectedVerification || !reviewAction) return;\n\n    startTransition(async () => {\n      const result = await reviewVerification(\n        selectedVerification.propertyId,\n        reviewAction === \"approve\" ? \"verified\" : \"rejected\"\n      );\n\n      if (result.success) {\n        toast.success(\n          reviewAction === \"approve\" ? \"Vérification approuvée\" : \"Vérification refusée\"\n        );\n        setReviewDialogOpen(false);\n        setSelectedVerification(null);\n        setReviewAction(null);\n        await loadVerifications();\n      } else {\n        toast.error(\"Erreur\", {\n          description: result.error || \"Une erreur est survenue.\",\n        });\n      }\n    });\n  };\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat(\"fr-FR\", {\n      maximumFractionDigits: 0,\n    }).format(price);\n  };\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString(\"fr-FR\", {\n      day: \"numeric\",\n      month: \"short\",\n      year: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <Loader2 className=\"h-6 w-6 animate-spin text-white/60\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-semibold text-white\">Vérifications en attente</h2>\n          <p className=\"mt-1 text-sm text-white/60\">\n            {verifications.length} demande{verifications.length > 1 ? \"s\" : \"\"} à traiter\n          </p>\n        </div>\n        {verifications.length > 0 && (\n          <Badge className=\"bg-amber-500/20 text-amber-300 border-amber-500/30\">\n            {verifications.length} en attente\n          </Badge>\n        )}\n      </div>\n\n      {verifications.length === 0 ? (\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 p-12 text-center\">\n          <CheckCircle2 className=\"mx-auto h-12 w-12 text-white/40 mb-4\" />\n          <p className=\"text-lg text-white/70\">Aucune vérification en attente</p>\n          <p className=\"mt-2 text-sm text-white/50\">\n            Toutes les demandes ont été traitées.\n          </p>\n        </div>\n      ) : (\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 overflow-hidden\">\n          <Table>\n            <TableHeader>\n              <TableRow className=\"border-white/10\">\n                <TableHead className=\"text-white/70\">Bien</TableHead>\n                <TableHead className=\"text-white/70\">Propriétaire</TableHead>\n                <TableHead className=\"text-white/70\">Document</TableHead>\n                <TableHead className=\"text-white/70\">Date</TableHead>\n                <TableHead className=\"text-white/70 text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {verifications.map((verification) => (\n                <TableRow key={verification.id} className=\"border-white/10\">\n                  <TableCell>\n                    <div className=\"flex items-center gap-3\">\n                      {verification.propertyImages && verification.propertyImages[0] && (\n                        <div className=\"relative h-12 w-12 rounded-lg overflow-hidden flex-shrink-0\">\n                          <Image\n                            src={verification.propertyImages[0]}\n                            alt={verification.propertyTitle}\n                            fill\n                            className=\"object-cover\"\n                            sizes=\"48px\"\n                          />\n                        </div>\n                      )}\n                      <div>\n                        <p className=\"font-medium text-white\">{verification.propertyTitle}</p>\n                        <p className=\"text-sm text-white/60\">\n                          {formatPrice(verification.propertyPrice)} FCFA\n                        </p>\n                      </div>\n                    </div>\n                  </TableCell>\n                  <TableCell>\n                    <div>\n                      <p className=\"text-white\">{verification.ownerName}</p>\n                      <p className=\"text-sm text-white/60\">{verification.ownerEmail}</p>\n                    </div>\n                  </TableCell>\n                  <TableCell>\n                    {verification.proofDocumentUrl ? (\n                      <a\n                        href={verification.proofDocumentUrl}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"inline-flex items-center gap-2 text-primary hover:underline text-sm\"\n                      >\n                        <FileText className=\"h-4 w-4\" />\n                        Voir le document\n                        <ExternalLink className=\"h-3 w-3\" />\n                      </a>\n                    ) : (\n                      <span className=\"text-white/40 text-sm\">Aucun document</span>\n                    )}\n                  </TableCell>\n                  <TableCell>\n                    <span className=\"text-white/70 text-sm\">\n                      {formatDate(verification.verificationRequestedAt)}\n                    </span>\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex items-center justify-end gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => handleReview(verification, \"approve\")}\n                        className=\"text-emerald-400 border-emerald-500/30 hover:bg-emerald-500/10\"\n                      >\n                        <CheckCircle2 className=\"h-4 w-4 mr-1\" />\n                        Approuver\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => handleReview(verification, \"reject\")}\n                        className=\"text-red-400 border-red-500/30 hover:bg-red-500/10\"\n                      >\n                        <XCircle className=\"h-4 w-4 mr-1\" />\n                        Refuser\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </div>\n      )}\n\n      {/* Dialog de confirmation */}\n      <Dialog open={reviewDialogOpen} onOpenChange={setReviewDialogOpen}>\n        <DialogContent className=\"border-white/10 bg-[#05080c] text-white\">\n          <DialogHeader>\n            <DialogTitle>\n              {reviewAction === \"approve\" ? \"Approuver la vérification\" : \"Refuser la vérification\"}\n            </DialogTitle>\n            <DialogDescription className=\"text-white/60\">\n              {reviewAction === \"approve\" ? (\n                <>\n                  Confirmez-vous l&apos;approbation de la vérification pour{\" \"}\n                  <strong>{selectedVerification?.propertyTitle}</strong> ?\n                </>\n              ) : (\n                <>\n                  Confirmez-vous le refus de la vérification pour{\" \"}\n                  <strong>{selectedVerification?.propertyTitle}</strong> ?\n                </>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setReviewDialogOpen(false);\n                setSelectedVerification(null);\n                setReviewAction(null);\n              }}\n              disabled={isPending}\n            >\n              Annuler\n            </Button>\n            <Button\n              variant={reviewAction === \"approve\" ? \"default\" : \"outline\"}\n              onClick={confirmReview}\n              disabled={isPending}\n              className={reviewAction === \"reject\" ? \"border-red-500/30 text-red-400 hover:bg-red-500/10\" : \"\"}\n            >\n              {isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Traitement...\n                </>\n              ) : reviewAction === \"approve\" ? (\n                \"Approuver\"\n              ) : (\n                \"Refuser\"\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\conditional-google-analytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\google-consent-mode.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\microsoft-clarity.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\update-consent-on-load.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\auth\\phone-missing-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\auth\\verification-success-toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\contracts\\ContractPreview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\contracts\\GenerateContractButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":53,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":53,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * Bouton de génération de contrat de bail\n * Design System: Luxe & Teranga (Dark Mode, Gold Accent)\n * Updated: Uses CMS Modal for customization\n */\n\nimport { useState } from 'react';\nimport { FileText, Download } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { downloadLeaseContract } from '@/lib/actions/contract-actions';\nimport { GenerateContractModal } from '@/components/contracts/GenerateContractModal';\nimport { toast } from 'sonner';\n\ninterface GenerateContractButtonProps {\n  leaseId: string;\n  tenantName: string;\n  existingContractUrl?: string | null;\n  variant?: 'default' | 'outline' | 'ghost';\n  size?: 'default' | 'sm' | 'lg' | 'icon';\n  className?: string;\n}\n\nexport function GenerateContractButton({\n  leaseId,\n  tenantName,\n  existingContractUrl,\n  variant = 'default',\n  size = 'default',\n  className,\n}: GenerateContractButtonProps) {\n  const [generatedUrl, setGeneratedUrl] = useState<string | null>(existingContractUrl || null);\n\n  const hasExistingContract = Boolean(generatedUrl);\n\n  const handleDownload = async () => {\n    // IMPORTANT : Toujours demander une URL signée fraîche au serveur.\n    const loadingToast = toast.loading('Préparation du téléchargement...');\n\n    try {\n      const result = await downloadLeaseContract(leaseId);\n\n      toast.dismiss(loadingToast);\n\n      if (result.success && result.url) {\n        window.open(result.url, '_blank');\n      } else {\n        toast.error('Erreur de téléchargement', {\n          description: result.error || 'Le fichier semble inaccessible',\n        });\n      }\n    } catch (error) {\n      toast.dismiss(loadingToast);\n      toast.error('Erreur technique', { description: 'Impossible de contacter le serveur' });\n    }\n  };\n\n  return (\n    <div className=\"flex gap-2\">\n      <GenerateContractModal\n        leaseId={leaseId}\n        tenantName={tenantName}\n        onSuccess={(url) => setGeneratedUrl(url)}\n      >\n        <Button\n          variant={variant}\n          size={size}\n          className={className || \"bg-[#F4C430] text-black hover:bg-[#F4C430]/90\"}\n        >\n          <FileText className=\"mr-2 h-4 w-4\" />\n          {hasExistingContract ? 'Regénérer le Contrat' : 'Générer le Contrat'}\n        </Button>\n      </GenerateContractModal>\n\n      {hasExistingContract && (\n        <Button\n          onClick={handleDownload}\n          variant=\"outline\"\n          size={size}\n          className=\"border-[#F4C430]/30 text-[#F4C430] hover:bg-[#F4C430]/10\"\n        >\n          <Download className=\"mr-2 h-4 w-4\" />\n          Télécharger\n        </Button>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\contracts\\GenerateContractModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":160,"column":121,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[7872,8030],"text":" Vous avez besoin d&apos;ajouter une clause spécifique (piscine, jardin) ou de modifier un article ? Passez en mode personnalisation.\r\n                            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[7872,8030],"text":" Vous avez besoin d&lsquo;ajouter une clause spécifique (piscine, jardin) ou de modifier un article ? Passez en mode personnalisation.\r\n                            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[7872,8030],"text":" Vous avez besoin d&#39;ajouter une clause spécifique (piscine, jardin) ou de modifier un article ? Passez en mode personnalisation.\r\n                            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[7872,8030],"text":" Vous avez besoin d&rsquo;ajouter une clause spécifique (piscine, jardin) ou de modifier un article ? Passez en mode personnalisation.\r\n                            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { DEFAULT_CONTRACT_TEXTS, ContractTexts } from '@/lib/contract-defaults';\r\nimport { generateLeaseContract } from '@/lib/actions/contract-actions';\r\nimport { toast } from \"sonner\";\r\n\r\n\r\ninterface GenerateContractModalProps {\r\n    leaseId: string;\r\n    tenantName?: string;\r\n    onSuccess?: (url: string) => void;\r\n    children?: React.ReactNode;\r\n    open?: boolean;\r\n    onOpenChange?: (open: boolean) => void;\r\n    autoOpen?: boolean;\r\n}\r\n\r\nexport function GenerateContractModal({ leaseId, tenantName, onSuccess, children, open: controlledOpen, onOpenChange: controlledOnOpenChange }: GenerateContractModalProps) {\r\n    const [internalOpen, setInternalOpen] = useState(false);\r\n    const [loading, setLoading] = useState(false);\r\n    const [mode, setMode] = useState<'standard' | 'custom'>('standard');\r\n\r\n    const isControlled = controlledOpen !== undefined;\r\n    const open = isControlled ? controlledOpen : internalOpen;\r\n    const setOpen = isControlled ? controlledOnOpenChange! : setInternalOpen;\r\n\r\n    // State local initialisé avec les textes par défaut\r\n    const [texts, setTexts] = useState<ContractTexts>(DEFAULT_CONTRACT_TEXTS);\r\n    const [customClause, setCustomClause] = useState(\"\");\r\n\r\n    const handleGenerate = async () => {\r\n        setLoading(true);\r\n        try {\r\n            // Si mode standard, on envoie customTexts vide (ou undefined) pour utiliser les défauts\r\n            // Si mode custom, on envoie les textes modifiés\r\n            const payload = mode === 'custom' ? {\r\n                ...texts,\r\n                custom_clauses: customClause\r\n            } : {}; // Vide = défauts côté serveur/générateur\r\n\r\n            const result = await generateLeaseContract({\r\n                leaseId,\r\n                customTexts: payload\r\n            });\r\n\r\n            if (result.success) {\r\n                setOpen(false);\r\n                setMode('standard'); // Reset mode\r\n                toast.success(\"Contrat généré avec succès\");\r\n                if (result.contractUrl && onSuccess) {\r\n                    onSuccess(result.contractUrl);\r\n                }\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors de la génération\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Erreur\", error);\r\n            toast.error(\"Une erreur inattendue est survenue\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // Fonction générique pour modifier un article\r\n    const handleChange = (key: keyof ContractTexts, value: string) => {\r\n        setTexts(prev => ({ ...prev, [key]: value }));\r\n    };\r\n\r\n    const handlePreview = async () => {\r\n        setLoading(true);\r\n        try {\r\n            // Preview : Standard ou Custom selon le mode\r\n            const payload = mode === 'custom' ? {\r\n                ...texts,\r\n                custom_clauses: customClause\r\n            } : {};\r\n\r\n            const result = await generateLeaseContract({\r\n                leaseId,\r\n                customTexts: payload,\r\n                preview: true // Mode preview\r\n            });\r\n\r\n            if (result.success && result.pdfBase64) {\r\n                // Conversion Base64 -> Blob -> URL\r\n                const binStr = atob(result.pdfBase64);\r\n                const len = binStr.length;\r\n                const arr = new Uint8Array(len);\r\n                for (let i = 0; i < len; i++) {\r\n                    arr[i] = binStr.charCodeAt(i);\r\n                }\r\n                const blob = new Blob([arr], { type: 'application/pdf' });\r\n                const url = URL.createObjectURL(blob);\r\n\r\n                // Pour Mobile/PWA : window.open est souvent bloqué. On force le téléchargement/ouverture via lien.\r\n                const link = document.createElement('a');\r\n                link.href = url;\r\n                link.download = `Contrat_Bail_${tenantName?.replace(/\\s+/g, '_') || 'Brouillon'}.pdf`;\r\n                document.body.appendChild(link);\r\n                link.click();\r\n                document.body.removeChild(link);\r\n\r\n                // Nettoyage après un court délai pour laisser le temps au téléchargement de démarrer\r\n                setTimeout(() => window.URL.revokeObjectURL(url), 100);\r\n            } else {\r\n                toast.error(result.error || \"Erreur de prévisualisation\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Erreur preview\", error);\r\n            toast.error(\"Erreur technique lors de la prévisualisation\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={setOpen}>\r\n            {children && (\r\n                <DialogTrigger asChild>\r\n                    {children}\r\n                </DialogTrigger>\r\n            )}\r\n            <DialogContent className={mode === 'custom' ? \"w-[95vw] sm:w-full max-w-3xl max-h-[85vh] overflow-y-auto bg-slate-900 border-slate-800 text-slate-100\" : \"w-[95vw] sm:w-full sm:max-w-md bg-slate-900 border-slate-800 text-slate-100\"}>\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"text-slate-100\">\r\n                        Générer le Contrat de Bail {tenantName ? `- ${tenantName}` : ''}\r\n                    </DialogTitle>\r\n                </DialogHeader>\r\n\r\n                {mode === 'standard' ? (\r\n                    <div className=\"space-y-4 py-4\">\r\n                        <div className=\"bg-slate-800/50 p-4 rounded-lg border border-slate-700/50 text-sm text-slate-300\">\r\n                            <p className=\"font-medium mb-2 text-white\">Génération Standard (Recommandé)</p>\r\n                            <p className=\"mb-3\">Le contrat sera généré avec les clauses juridiques standards conformes au droit sénégalais (COCC / Loi 2014) et les décrets 2023.</p>\r\n                            <Button\r\n                                variant=\"secondary\"\r\n                                size=\"sm\"\r\n                                onClick={handlePreview}\r\n                                disabled={loading}\r\n                                className=\"bg-slate-700 hover:bg-slate-600 text-slate-100 h-8 text-xs w-full sm:w-auto\"\r\n                            >\r\n                                <svg className=\"w-3 h-3 mr-2\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\r\n                                </svg>\r\n                                Prévisualiser le modèle\r\n                            </Button>\r\n                        </div>\r\n\r\n                        <div className=\"bg-blue-950/20 p-3 rounded border border-blue-900/30 flex items-start gap-3\">\r\n                            <div className=\"mt-1 bg-blue-900/30 text-blue-400 rounded-full p-1 shrink-0\">\r\n                                <svg className=\"w-3 h-3\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0\" /></svg>\r\n                            </div>\r\n                            <div className=\"text-xs text-slate-400 min-w-0 break-words\">\r\n                                <span className=\"font-semibold text-blue-400\">Option Avancée :</span> Vous avez besoin d'ajouter une clause spécifique (piscine, jardin) ou de modifier un article ? Passez en mode personnalisation.\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"space-y-6 py-4\">\r\n                        {/* SECTION 1 : Articles Standards */}\r\n                        <div className=\"space-y-4\">\r\n                            <div className=\"flex justify-between items-center border-b border-slate-800 pb-2\">\r\n                                <h3 className=\"font-semibold text-slate-200\">Clauses Standards</h3>\r\n                                <Button variant=\"ghost\" size=\"sm\" onClick={() => setMode('standard')} className=\"text-xs h-7 text-slate-400 hover:text-white hover:bg-slate-800\">Retour au Standard</Button>\r\n                            </div>\r\n\r\n                            <div className=\"grid gap-4\">\r\n                                {(Object.keys(DEFAULT_CONTRACT_TEXTS) as Array<keyof typeof DEFAULT_CONTRACT_TEXTS>).map((key) => {\r\n                                    const label = key.replace(/_/g, ' ').replace('article', 'Article').replace(/\\d+/, (match) => match + ' :');\r\n                                    return (\r\n                                        <div key={key} className=\"space-y-2\">\r\n                                            <Label className=\"text-slate-300 capitalize\">{label}</Label>\r\n                                            <Textarea\r\n                                                value={texts[key] ?? DEFAULT_CONTRACT_TEXTS[key]}\r\n                                                onChange={(e) => handleChange(key, e.target.value)}\r\n                                                className=\"min-h-[100px] resize-y bg-slate-800 border-slate-700 text-slate-200 focus:ring-blue-500 placeholder:text-slate-500 w-full\"\r\n                                            />\r\n                                        </div>\r\n                                    );\r\n                                })}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* SECTION 2 : Clauses Particulières */}\r\n                        <div className=\"space-y-4 bg-blue-950/20 p-4 rounded-lg border border-blue-900/30\">\r\n                            <h3 className=\"font-semibold text-blue-400\">Conditions Particulières (Ajout)</h3>\r\n                            <p className=\"text-xs text-blue-300\">\r\n                                Ajoutez ici des règles spécifiques (ex: Jardin, Piscine, Animaux interdits, Interdiction de fumer...).\r\n                            </p>\r\n                            <Textarea\r\n                                value={customClause}\r\n                                onChange={(e) => setCustomClause(e.target.value)}\r\n                                placeholder=\"Ex: Le locataire s'engage à entretenir la piscine...\"\r\n                                className=\"h-32 bg-slate-800 border-slate-700 text-slate-200 placeholder:text-slate-500 w-full\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                <div className=\"flex justify-end gap-3 pt-4 border-t border-slate-800\">\r\n                    {mode === 'standard' ? (\r\n                        <>\r\n                            <div className=\"mr-auto\">\r\n                                <Button variant=\"outline\" onClick={() => setMode('custom')} className=\"border-slate-700 text-slate-300 hover:bg-slate-800\">Personnaliser</Button>\r\n                            </div>\r\n                            <Button onClick={handleGenerate} disabled={loading} className=\"bg-[#F4C430] text-black hover:bg-[#F4C430]/90\">\r\n                                {loading ? \"Traitement...\" : \"Générer Standard\"}\r\n                            </Button>\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <div className=\"mr-auto\">\r\n                                <Button variant=\"ghost\" onClick={handlePreview} disabled={loading} className=\"text-blue-400 hover:text-blue-300 hover:bg-blue-950/30\">\r\n                                    Prévisualiser les modifications\r\n                                </Button>\r\n                            </div>\r\n                            <Button variant=\"outline\" onClick={() => setMode('standard')} className=\"border-slate-700 text-slate-300 hover:bg-slate-800\">Annuler</Button>\r\n                            <Button onClick={handleGenerate} disabled={loading} className=\"bg-[#F4C430] text-black hover:bg-[#F4C430]/90\">\r\n                                {loading ? \"Traitement...\" : \"Valider et Générer\"}\r\n                            </Button>\r\n                        </>\r\n                    )}\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\dashboard\\ad-certification-upload.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\dashboard\\verification-status-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\dashboard\\verification-upload-form.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'proofDocumentUrl' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":19},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":34,"column":31,"nodeType":"Identifier","endLine":34,"endColumn":39},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":35,"column":43,"nodeType":"Identifier","endLine":35,"endColumn":51},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":36,"column":41,"nodeType":"Identifier","endLine":36,"endColumn":49},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":37,"column":39,"nodeType":"Identifier","endLine":37,"endColumn":47}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport { toast } from \"sonner\";\nimport { Upload, X, FileText, Loader2, ShieldCheck } from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { uploadVerificationDoc } from \"@/app/compte/mes-biens/actions\";\n\ntype VerificationUploadFormProps = {\n  propertyId: string;\n  variant?: \"default\" | \"outline\" | \"ghost\";\n  currentStatus?: string;\n  proofDocumentUrl?: string | null;\n};\n\nexport function VerificationUploadForm({\n  propertyId,\n  variant = \"outline\",\n  currentStatus,\n  proofDocumentUrl,\n}: VerificationUploadFormProps) {\n  // Si déjà vérifié, ne rien afficher\n  if (currentStatus === 'verified') {\n    return null;\n  }\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const [isDragOver, setIsDragOver] = useState(false);\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n\n    if (e.dataTransfer.files && e.dataTransfer.files[0]) {\n      validateAndSetFile(e.dataTransfer.files[0]);\n    }\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n      validateAndSetFile(e.target.files[0]);\n    }\n  };\n\n  const validateAndSetFile = (file: File) => {\n    const allowedTypes = [\"application/pdf\", \"image/jpeg\", \"image/png\", \"image/webp\"];\n\n    if (!allowedTypes.includes(file.type)) {\n      toast.error(\"Format non supporté\", {\n        description: \"Veuillez utiliser un fichier PDF, JPG ou PNG.\"\n      });\n      return;\n    }\n\n    if (file.size > 5 * 1024 * 1024) {\n      toast.error(\"Fichier trop volumineux\", {\n        description: \"La taille maximale est de 5Mo.\"\n      });\n      return;\n    }\n\n    setSelectedFile(file);\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!selectedFile) return;\n\n    setIsUploading(true);\n    const formData = new FormData();\n    formData.append(\"file\", selectedFile);\n    formData.append(\"propertyId\", propertyId);\n\n    try {\n      const result = await uploadVerificationDoc(formData);\n\n      if (result.error) {\n        toast.error(\"Erreur d'envoi\", { description: result.error });\n      } else {\n        toast.success(\"Document envoyé !\", {\n          description: \"Votre demande de certification est en cours d'examen.\"\n        });\n        setIsOpen(false);\n        setSelectedFile(null);\n      }\n    } catch (error) {\n      console.error(error);\n      toast.error(\"Une erreur inconnue est survenue.\");\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button\n          variant={variant}\n          size=\"sm\"\n          className=\"h-8 border-[#F4C430]/50 text-[#F4C430] hover:bg-[#F4C430]/10 hover:text-[#F4C430]\"\n        >\n          <ShieldCheck className=\"mr-2 h-4 w-4\" />\n          Certifier ce bien\n        </Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-md bg-zinc-950 border-white/10 text-white\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 text-[#F4C430]\">\n            <ShieldCheck className=\"h-5 w-5\" />\n            Certification du bien\n          </DialogTitle>\n          <DialogDescription className=\"text-white/60\">\n            Téléchargez votre titre de propriété ou tout document officiel prouvant que vous êtes le propriétaire.\n            Ce document restera confidentiel.\n          </DialogDescription>\n        </DialogHeader>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6 mt-4\">\n          <div\n            className={`relative flex flex-col items-center justify-center rounded-xl border-2 border-dashed transition-all p-8\n              ${isDragOver\n                ? \"border-[#F4C430] bg-[#F4C430]/5\"\n                : \"border-white/10 bg-white/5 hover:bg-white/10\"\n              }\n              ${selectedFile ? \"border-[#F4C430]/50\" : \"\"}\n            `}\n            onDragOver={handleDragOver}\n            onDragLeave={handleDragLeave}\n            onDrop={handleDrop}\n          >\n            <input\n              type=\"file\"\n              id=\"verification-file\"\n              accept=\".pdf,.jpg,.jpeg,.png,.webp\"\n              className=\"absolute inset-0 cursor-pointer opacity-0\"\n              onChange={handleFileChange}\n              disabled={isUploading}\n            />\n\n            {selectedFile ? (\n              <div className=\"flex flex-col items-center gap-2 text-center\">\n                <div className=\"rounded-full bg-[#F4C430]/10 p-3\">\n                  <FileText className=\"h-8 w-8 text-[#F4C430]\" />\n                </div>\n                <div>\n                  <p className=\"font-medium text-white\">{selectedFile.name}</p>\n                  <p className=\"text-xs text-white/50\">\n                    {(selectedFile.size / 1024 / 1024).toFixed(2)} MB\n                  </p>\n                </div>\n                <Button\n                  type=\"button\"\n                  size=\"sm\"\n                  variant=\"ghost\"\n                  className=\"mt-2 h-8 text-red-400 hover:text-red-300 hover:bg-red-400/10\"\n                  onClick={(e) => {\n                    e.stopPropagation(); // Prevent clicking input again\n                    setSelectedFile(null);\n                  }}\n                >\n                  <X className=\"mr-2 h-3.5 w-3.5\" />\n                  Changer de fichier\n                </Button>\n              </div>\n            ) : (\n              <div className=\"flex flex-col items-center gap-2 text-center\">\n                <div className=\"rounded-full bg-white/5 p-3\">\n                  <Upload className=\"h-6 w-6 text-white/40\" />\n                </div>\n                <div>\n                  <p className=\"font-medium text-white\">\n                    Glissez votre document ici\n                  </p>\n                  <p className=\"text-xs text-white/50 mt-1\">\n                    ou cliquez pour parcourir\n                  </p>\n                </div>\n                <p className=\"text-[10px] text-white/30 uppercase tracking-widest mt-2\">\n                  PDF, JPG, PNG (Max 5MB)\n                </p>\n              </div>\n            )}\n          </div>\n\n          <div className=\"flex justify-end gap-3\">\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              onClick={() => setIsOpen(false)}\n              disabled={isUploading}\n              className=\"text-white/60 hover:text-white\"\n            >\n              Annuler\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={!selectedFile || isUploading}\n              className=\"bg-[#F4C430] text-black hover:bg-[#F4C430]/90 font-semibold\"\n            >\n              {isUploading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Envoi...\n                </>\n              ) : (\n                \"Envoyer pour certification\"\n              )}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\document\\document-selector.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadDocuments'. Either include it or remove the dependency array.","line":78,"column":8,"nodeType":"ArrayExpression","endLine":78,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [loadDocuments]","fix":{"range":[2604,2606],"text":"[loadDocuments]"}}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":439,"column":37,"nodeType":"JSXOpeningElement","endLine":443,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { FileText, Upload, Check, Loader2, Image as ImageIcon, FileIcon, Eye } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { getMyDocuments, uploadDocument } from \"@/app/compte/mes-documents/actions\";\r\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\r\n\r\ntype Document = {\r\n    id: string;\r\n    name: string;\r\n    type: string;\r\n    size: number;\r\n    url: string;\r\n    uploaded_at: string;\r\n    source: \"manual\" | \"verification\";\r\n};\r\n\r\ninterface DocumentSelectorProps {\r\n    onSelect: (document: { id: string; url: string; name: string; file_path?: string } | null) => void;\r\n    selectedDocumentId?: string;\r\n    documentType?: string;\r\n    label?: string;\r\n    description?: string;\r\n    className?: string;\r\n}\r\n\r\nconst documentTypes = [\r\n    { value: \"titre_propriete\", label: \"Titre de Propriété\" },\r\n    { value: \"bail\", label: \"Bail\" },\r\n    { value: \"cni\", label: \"CNI / Pièce d'identité\" },\r\n    { value: \"facture\", label: \"Facture\" },\r\n    { value: \"attestation\", label: \"Attestation\" },\r\n    { value: \"autre\", label: \"Autre document\" },\r\n];\r\n\r\nexport function DocumentSelector({\r\n    onSelect,\r\n    selectedDocumentId,\r\n    documentType,\r\n    label = \"Document justificatif\",\r\n    description = \"Sélectionnez un document depuis votre coffre-fort ou uploadez-en un nouveau\",\r\n    className = \"\",\r\n}: DocumentSelectorProps) {\r\n    const [documents, setDocuments] = useState<Document[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [selectedId, setSelectedId] = useState<string | undefined>(selectedDocumentId);\r\n    const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);\r\n    const [uploading, setUploading] = useState(false);\r\n    const [uploadForm, setUploadForm] = useState({\r\n        type: documentType || \"titre_propriete\",\r\n        file: null as File | null,\r\n    });\r\n    const [previewDoc, setPreviewDoc] = useState<Document | null>(null);\r\n    const [isPreviewOpen, setIsPreviewOpen] = useState(false);\r\n\r\n    useEffect(() => {\r\n        loadDocuments();\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        setSelectedId(selectedDocumentId);\r\n    }, [selectedDocumentId]);\r\n\r\n    const loadDocuments = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const result = await getMyDocuments();\r\n            if (result.success && result.data) {\r\n                const allDocs = result.data as Document[];\r\n                // Filtrer seulement les documents manuels, et par type si spécifié\r\n                const filteredDocs = documentType\r\n                    ? allDocs.filter((doc) => doc.source === \"manual\" && doc.type === documentType)\r\n                    : allDocs.filter((doc) => doc.source === \"manual\");\r\n                setDocuments(filteredDocs);\r\n            } else {\r\n                toast.error(\"Erreur lors du chargement des documents\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error loading documents:\", error);\r\n            toast.error(\"Impossible de charger les documents\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleSelectDocument = (docId: string) => {\r\n        setSelectedId(docId);\r\n        const doc = documents.find((d) => d.id === docId);\r\n        if (doc) {\r\n            onSelect({\r\n                id: doc.id,\r\n                url: doc.url,\r\n                name: doc.name,\r\n            });\r\n        }\r\n    };\r\n\r\n    const handleDeselectDocument = () => {\r\n        setSelectedId(undefined);\r\n        onSelect(null);\r\n    };\r\n\r\n    const handleUpload = async () => {\r\n        if (!uploadForm.file) {\r\n            toast.error(\"Veuillez sélectionner un fichier\");\r\n            return;\r\n        }\r\n\r\n        setUploading(true);\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append(\"file\", uploadForm.file);\r\n            formData.append(\"type\", uploadForm.type);\r\n\r\n            const result = await uploadDocument(formData);\r\n\r\n            if (result.success && result.data) {\r\n                toast.success(\"Document uploadé avec succès\");\r\n                setIsUploadDialogOpen(false);\r\n                setUploadForm({ type: documentType || \"titre_propriete\", file: null });\r\n                // Recharger la liste\r\n                await loadDocuments();\r\n                // Auto-sélectionner le nouveau document\r\n                const newDoc = result.data as { id?: string };\r\n                if (newDoc.id) {\r\n                    handleSelectDocument(newDoc.id);\r\n                }\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors de l'upload\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Upload error:\", error);\r\n            toast.error(\"Erreur lors de l'upload du document\");\r\n        } finally {\r\n            setUploading(false);\r\n        }\r\n    };\r\n\r\n    const getFileIcon = (fileName: string) => {\r\n        const ext = fileName.split(\".\").pop()?.toLowerCase();\r\n        if (ext === \"pdf\") return <FileText className=\"h-5 w-5 text-red-500\" />;\r\n        if ([\"jpg\", \"jpeg\", \"png\", \"webp\"].includes(ext || \"\"))\r\n            return <ImageIcon className=\"h-5 w-5 text-blue-500\" />;\r\n        return <FileIcon className=\"h-5 w-5 text-gray-500\" />;\r\n    };\r\n\r\n    const formatFileSize = (bytes: number) => {\r\n        if (bytes < 1024) return bytes + \" B\";\r\n        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + \" KB\";\r\n        return (bytes / (1024 * 1024)).toFixed(1) + \" MB\";\r\n    };\r\n\r\n    return (\r\n        <div className={`space-y-4 ${className}`}>\r\n            <div>\r\n                <Label className=\"text-white\">{label}</Label>\r\n                {description && <p className=\"text-sm text-white/60 mt-1\">{description}</p>}\r\n            </div>\r\n\r\n            {loading ? (\r\n                <Card className=\"p-6 bg-white/5 border-white/10\">\r\n                    <div className=\"flex items-center justify-center gap-2 text-white/60\">\r\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                        <span>Chargement des documents...</span>\r\n                    </div>\r\n                </Card>\r\n            ) : documents.length === 0 ? (\r\n                <Card className=\"p-6 bg-white/5 border-white/10 text-center\">\r\n                    <FileText className=\"h-12 w-12 text-white/30 mx-auto mb-3\" />\r\n                    <p className=\"text-white/60 mb-4\">Aucun document dans votre coffre-fort</p>\r\n                    <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\r\n                        <DialogTrigger asChild>\r\n                            <Button variant=\"outline\" className=\"mx-auto\">\r\n                                <Upload className=\"h-4 w-4 mr-2\" />\r\n                                Uploader un document\r\n                            </Button>\r\n                        </DialogTrigger>\r\n                        <DialogContent className=\"bg-[#0a0118] border-white/10\">\r\n                            <DialogHeader>\r\n                                <DialogTitle className=\"text-white\">Uploader un nouveau document</DialogTitle>\r\n                                <DialogDescription className=\"text-white/60\">\r\n                                    Ajoutez un document à votre coffre-fort (PDF, JPG, PNG, max 5 MB)\r\n                                </DialogDescription>\r\n                            </DialogHeader>\r\n                            <div className=\"space-y-4 pt-4\">\r\n                                <div>\r\n                                    <Label htmlFor=\"doc-type\" className=\"text-white\">\r\n                                        Type de document\r\n                                    </Label>\r\n                                    <Select\r\n                                        value={uploadForm.type}\r\n                                        onValueChange={(value) => setUploadForm({ ...uploadForm, type: value })}\r\n                                        disabled={!!documentType}\r\n                                    >\r\n                                        <SelectTrigger className=\"bg-white/5 border-white/10 text-white\">\r\n                                            <SelectValue />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\r\n                                            {documentTypes.map((type) => (\r\n                                                <SelectItem key={type.value} value={type.value}>\r\n                                                    {type.label}\r\n                                                </SelectItem>\r\n                                            ))}\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <Label htmlFor=\"doc-file\" className=\"text-white\">\r\n                                        Fichier\r\n                                    </Label>\r\n                                    <Input\r\n                                        id=\"doc-file\"\r\n                                        type=\"file\"\r\n                                        accept=\".pdf,.jpg,.jpeg,.png\"\r\n                                        onChange={(e) =>\r\n                                            setUploadForm({ ...uploadForm, file: e.target.files?.[0] || null })\r\n                                        }\r\n                                        className=\"bg-white/5 border-white/10 text-white cursor-pointer file:cursor-pointer\"\r\n                                    />\r\n                                    {uploadForm.file && (\r\n                                        <p className=\"text-sm text-white/60 mt-1\">\r\n                                            {uploadForm.file.name} ({formatFileSize(uploadForm.file.size)})\r\n                                        </p>\r\n                                    )}\r\n                                </div>\r\n\r\n                                <Button\r\n                                    onClick={handleUpload}\r\n                                    disabled={!uploadForm.file || uploading}\r\n                                    className=\"w-full\"\r\n                                >\r\n                                    {uploading ? (\r\n                                        <>\r\n                                            <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                                            Upload en cours...\r\n                                        </>\r\n                                    ) : (\r\n                                        <>\r\n                                            <Upload className=\"h-4 w-4 mr-2\" />\r\n                                            Uploader\r\n                                        </>\r\n                                    )}\r\n                                </Button>\r\n                            </div>\r\n                        </DialogContent>\r\n                    </Dialog>\r\n                </Card>\r\n            ) : (\r\n                <div className=\"space-y-3\">\r\n                    <RadioGroup value={selectedId} onValueChange={handleSelectDocument}>\r\n                        <div className=\"grid gap-2\">\r\n                            {documents.map((doc) => (\r\n                                <Card\r\n                                    key={doc.id}\r\n                                    className={`p-4 cursor-pointer transition-all ${selectedId === doc.id\r\n                                        ? \"bg-primary/20 border-primary\"\r\n                                        : \"bg-white/5 border-white/10 hover:bg-white/10\"\r\n                                        }`}\r\n                                    onClick={() => handleSelectDocument(doc.id)}\r\n                                >\r\n                                    <div className=\"flex items-center gap-3\">\r\n                                        <RadioGroupItem value={doc.id} id={doc.id} />\r\n                                        {getFileIcon(doc.name)}\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <p className=\"text-white font-medium truncate\">{doc.name}</p>\r\n                                            <p className=\"text-xs text-white/50\">\r\n                                                {formatFileSize(doc.size)} • {new Date(doc.uploaded_at).toLocaleDateString()}\r\n                                            </p>\r\n                                        </div>\r\n\r\n                                        {/* Preview button */}\r\n                                        <Button\r\n                                            variant=\"ghost\"\r\n                                            size=\"icon\"\r\n                                            type=\"button\"\r\n                                            onClick={(e) => {\r\n                                                e.stopPropagation();\r\n                                                if (doc.url) {\r\n                                                    setPreviewDoc(doc);\r\n                                                    setIsPreviewOpen(true);\r\n                                                } else {\r\n                                                    toast.error(\"Lien expiré, veuillez rafraîchir la page\");\r\n                                                }\r\n                                            }}\r\n                                            className=\"hover:bg-blue-500/20 text-blue-400 shrink-0\"\r\n                                            title=\"Prévisualiser le document\"\r\n                                        >\r\n                                            <Eye className=\"h-4 w-4\" />\r\n                                        </Button>\r\n\r\n                                        {selectedId === doc.id && (\r\n                                            <Check className=\"h-5 w-5 text-primary shrink-0\" />\r\n                                        )}\r\n                                    </div>\r\n                                </Card>\r\n                            ))}\r\n                        </div>\r\n                    </RadioGroup>\r\n\r\n                    <div className=\"flex gap-2\">\r\n                        <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\r\n                            <DialogTrigger asChild>\r\n                                <Button variant=\"outline\" className=\"flex-1\">\r\n                                    <Upload className=\"h-4 w-4 mr-2\" />\r\n                                    Uploader un nouveau\r\n                                </Button>\r\n                            </DialogTrigger>\r\n                            <DialogContent className=\"bg-[#0a0118] border-white/10\">\r\n                                <DialogHeader>\r\n                                    <DialogTitle className=\"text-white\">Uploader un nouveau document</DialogTitle>\r\n                                    <DialogDescription className=\"text-white/60\">\r\n                                        Ajoutez un document à votre coffre-fort (PDF, JPG, PNG, max 5 MB)\r\n                                    </DialogDescription>\r\n                                </DialogHeader>\r\n                                <div className=\"space-y-4 pt-4\">\r\n                                    <div>\r\n                                        <Label htmlFor=\"doc-type\" className=\"text-white\">\r\n                                            Type de document\r\n                                        </Label>\r\n                                        <Select\r\n                                            value={uploadForm.type}\r\n                                            onValueChange={(value) => setUploadForm({ ...uploadForm, type: value })}\r\n                                            disabled={!!documentType}\r\n                                        >\r\n                                            <SelectTrigger className=\"bg-white/5 border-white/10 text-white\">\r\n                                                <SelectValue />\r\n                                            </SelectTrigger>\r\n                                            <SelectContent>\r\n                                                {documentTypes.map((type) => (\r\n                                                    <SelectItem key={type.value} value={type.value}>\r\n                                                        {type.label}\r\n                                                    </SelectItem>\r\n                                                ))}\r\n                                            </SelectContent>\r\n                                        </Select>\r\n                                    </div>\r\n\r\n                                    <div>\r\n                                        <Label htmlFor=\"doc-file\" className=\"text-white\">\r\n                                            Fichier\r\n                                        </Label>\r\n                                        <Input\r\n                                            id=\"doc-file\"\r\n                                            type=\"file\"\r\n                                            accept=\".pdf,.jpg,.jpeg,.png\"\r\n                                            onChange={(e) =>\r\n                                                setUploadForm({ ...uploadForm, file: e.target.files?.[0] || null })\r\n                                            }\r\n                                            className=\"bg-white/5 border-white/10 text-white cursor-pointer file:cursor-pointer\"\r\n                                        />\r\n                                        {uploadForm.file && (\r\n                                            <p className=\"text-sm text-white/60 mt-1\">\r\n                                                {uploadForm.file.name} ({formatFileSize(uploadForm.file.size)})\r\n                                            </p>\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    <Button\r\n                                        onClick={handleUpload}\r\n                                        disabled={!uploadForm.file || uploading}\r\n                                        className=\"w-full\"\r\n                                    >\r\n                                        {uploading ? (\r\n                                            <>\r\n                                                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                                                Upload en cours...\r\n                                            </>\r\n                                        ) : (\r\n                                            <>\r\n                                                <Upload className=\"h-4 w-4 mr-2\" />\r\n                                                Uploader\r\n                                            </>\r\n                                        )}\r\n                                    </Button>\r\n                                </div>\r\n                            </DialogContent>\r\n                        </Dialog>\r\n\r\n                        {selectedId && (\r\n                            <Button variant=\"ghost\" onClick={handleDeselectDocument} className=\"flex-1\">\r\n                                Désélectionner\r\n                            </Button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Preview Modal */}\r\n            <Dialog open={isPreviewOpen} onOpenChange={setIsPreviewOpen}>\r\n                <DialogContent className=\"bg-[#0a0118] border-white/10 max-w-4xl max-h-[90vh] overflow-auto\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"text-white\">{previewDoc?.name}</DialogTitle>\r\n                        <DialogDescription className=\"text-white/60\">\r\n                            {previewDoc && formatFileSize(previewDoc.size)} • {previewDoc && new Date(previewDoc.uploaded_at).toLocaleDateString()}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <div className=\"mt-4\">\r\n                        {previewDoc && (\r\n                            <div className=\"w-full\">\r\n                                {previewDoc.name.toLowerCase().endsWith('.pdf') ? (\r\n                                    <div className=\"flex flex-col items-center justify-center gap-4 p-8 border-2 border-dashed border-white/20 rounded-lg bg-white/5\">\r\n                                        <FileText className=\"h-16 w-16 text-blue-400\" />\r\n                                        <p className=\"text-white text-center\">\r\n                                            Les PDFs ne peuvent pas être affichés dans le modal pour des raisons de sécurité.\r\n                                        </p>\r\n                                        <Button\r\n                                            onClick={() => {\r\n                                                window.open(previewDoc.url, '_blank');\r\n                                                setIsPreviewOpen(false);\r\n                                            }}\r\n                                            className=\"bg-blue-500 hover:bg-blue-600 text-white\"\r\n                                        >\r\n                                            Ouvrir le PDF dans un nouvel onglet\r\n                                        </Button>\r\n                                    </div>\r\n                                ) : (\r\n                                    // eslint-disable-next-line @next/next/no-img-element\r\n                                    <img\r\n                                        src={previewDoc.url}\r\n                                        alt={previewDoc.name}\r\n                                        className=\"w-full h-auto rounded-lg border border-white/10\"\r\n                                    />\r\n                                )}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\forms\\address-input-with-map.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[969,972],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[969,972],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\app-shell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\footer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\notification-bell.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used.","line":49,"column":48,"nodeType":null,"messageId":"unusedVar","endLine":49,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport {\n  Bell,\n  BellOff,\n  Info,\n  CheckCircle,\n  AlertTriangle,\n  XCircle,\n  CheckCheck,\n} from \"lucide-react\";\nimport { useRouter } from \"next/navigation\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { motion, AnimatePresence } from \"framer-motion\";\n\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { useNotifications, type Notification, type NotificationType } from \"@/hooks/use-notifications\";\nimport { markNotificationAsRead, markAllNotificationsAsRead } from \"@/app/notifications/actions\";\nimport { toast } from \"sonner\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\n\ntype NotificationBellProps = {\n  userId: string | null;\n};\n\nconst notificationIcons: Record<NotificationType, typeof Info> = {\n  info: Info,\n  success: CheckCircle,\n  warning: AlertTriangle,\n  error: XCircle,\n};\n\nconst notificationStyles: Record<NotificationType, string> = {\n  info: \"bg-blue-500/10 text-blue-400\",\n  success: \"bg-green-500/10 text-green-400\",\n  warning: \"bg-yellow-500/10 text-yellow-400\",\n  error: \"bg-red-500/10 text-red-400\",\n};\n\nexport function NotificationBell({ userId }: NotificationBellProps) {\n  const router = useRouter();\n  const { notifications, unreadCount, loading, error, refetch } = useNotifications(userId);\n  const [isOpen, setIsOpen] = useState(false);\n\n\n  const handleNotificationClick = async (notification: Notification) => {\n    // Marquer comme lu si ce n'est pas déjà fait\n    if (!notification.is_read) {\n      await markNotificationAsRead(notification.id);\n      // Le hook useNotifications mettra à jour automatiquement via Realtime\n    }\n\n    // Fermer le popover\n    setIsOpen(false);\n\n    // Rediriger vers le chemin de ressource si disponible\n    if (notification.resource_path) {\n      router.push(notification.resource_path);\n    }\n  };\n\n  const handleMarkAllAsRead = async () => {\n    const result = await markAllNotificationsAsRead();\n    if (result.error) {\n      toast.error(\"Erreur\", {\n        description: result.error,\n      });\n    } else {\n      toast.success(\"Toutes les notifications ont été marquées comme lues\");\n      // Forcer un refetch car Realtime peut ne pas déclencher un UPDATE pour chaque notification\n      // quand on marque toutes les notifications comme lues en masse\n      setTimeout(() => {\n        refetch();\n      }, 500);\n    }\n  };\n\n  const formatTimeAgo = (dateString: string) => {\n    try {\n      const result = formatDistanceToNow(new Date(dateString), {\n        addSuffix: true,\n      });\n      // Traduire les termes de base en français\n      return result\n        .replace(\"about \", \"\")\n        .replace(\"less than a minute ago\", \"à l'instant\")\n        .replace(\"minute ago\", \"minute\")\n        .replace(\"minutes ago\", \"minutes\")\n        .replace(\"hour ago\", \"heure\")\n        .replace(\"hours ago\", \"heures\")\n        .replace(\"day ago\", \"jour\")\n        .replace(\"days ago\", \"jours\")\n        .replace(\"month ago\", \"mois\")\n        .replace(\"months ago\", \"mois\")\n        .replace(\"year ago\", \"an\")\n        .replace(\"years ago\", \"ans\")\n        .replace(\" ago\", \"\");\n    } catch {\n      return \"Récemment\";\n    }\n  };\n\n  return (\n    <Popover open={isOpen} onOpenChange={setIsOpen}>\n      <PopoverTrigger asChild>\n        <button\n          className=\"relative flex items-center justify-center rounded-full p-2.5 transition-all active:scale-95 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/20\"\n          aria-label=\"Notifications\"\n          onClick={() => {\n            // Forcer un refetch quand on ouvre le popover\n            if (!isOpen) {\n              refetch();\n            }\n          }}\n        >\n          <Bell className=\"h-5 w-5 text-white\" />\n          {unreadCount > 0 && (\n            <span className=\"absolute right-0 top-0 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white animate-pulse\">\n              {unreadCount > 9 ? \"9+\" : unreadCount}\n            </span>\n          )}\n        </button>\n      </PopoverTrigger>\n      <PopoverContent\n        className=\"w-96 max-w-[90vw] p-0 rounded-2xl border border-white/10 bg-[#05080c] text-white shadow-2xl z-[100]\"\n        align=\"end\"\n        sideOffset={8}\n      >\n        <div className=\"flex flex-col\">\n          <div className=\"flex items-center justify-between border-b border-white/10 px-4 py-3\">\n            <h3 className=\"text-sm font-semibold text-white\">Notifications</h3>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              disabled={unreadCount === 0}\n              className=\"h-auto gap-1 px-2 py-1 text-xs text-white/70 hover:text-white disabled:cursor-not-allowed disabled:text-white/30\"\n              onClick={handleMarkAllAsRead}\n            >\n              <CheckCheck className=\"h-3 w-3\" />\n              Tout marquer\n            </Button>\n          </div>\n\n          <ScrollArea className=\"h-[320px] w-full rounded-b-2xl\">\n            {loading ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <div className=\"h-6 w-6 animate-spin rounded-full border-2 border-primary border-t-transparent\" />\n              </div>\n            ) : notifications.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center py-10 px-6 text-center\">\n                <BellOff className=\"mb-3 h-8 w-8 text-white/40\" />\n                <p className=\"text-sm font-medium text-white\">Vous êtes à jour</p>\n                <p className=\"text-xs text-white/50\">Revenez plus tard pour de nouvelles alertes.</p>\n              </div>\n            ) : (\n              <div className=\"divide-y divide-white/5\">\n                <AnimatePresence mode=\"popLayout\">\n                  {notifications.map((notification) => {\n                    const Icon = notificationIcons[notification.type];\n                    const iconClasses = notificationStyles[notification.type];\n\n                    return (\n                      <motion.div\n                        key={notification.id}\n                        initial={{ opacity: 0, y: 6 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        exit={{ opacity: 0, y: -6 }}\n                        className={cn(\n                          \"flex gap-4 p-4 transition-colors hover:bg-white/5 cursor-pointer relative border-b border-white/5 last:border-b-0\",\n                          !notification.is_read && \"bg-white/5\"\n                        )}\n                        onClick={() => handleNotificationClick(notification)}\n                      >\n                        <div\n                          className={cn(\n                            \"mt-1 flex h-10 w-10 shrink-0 items-center justify-center rounded-full\",\n                            iconClasses\n                          )}\n                        >\n                          <Icon className=\"h-4 w-4\" />\n                        </div>\n                        <div className=\"flex-1 min-w-0 space-y-2\">\n                          <div className=\"flex items-start justify-between gap-3\">\n                            <p className=\"text-sm font-medium leading-tight text-white\">\n                              {notification.title}\n                            </p>\n                            {!notification.is_read && (\n                              <span className=\"h-2 w-2 shrink-0 rounded-full bg-blue-500\" />\n                            )}\n                          </div>\n                          <p className=\"text-xs text-white/70 line-clamp-2\">\n                            {notification.message}\n                          </p>\n                          <p className=\"text-[10px] uppercase tracking-wide text-white/40\">\n                            {formatTimeAgo(notification.created_at)}\n                          </p>\n                        </div>\n                      </motion.div>\n                    );\n                  })}\n                </AnimatePresence>\n              </div>\n            )}\n          </ScrollArea>\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\scroll-to-top.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\user-nav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\maps\\location-picker-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":18,"column":43,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":18,"endColumn":61},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\maps\\location-picker-dialog.tsx:85:5\n  83 |\n  84 |   useEffect(() => {\n> 85 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  86 |   }, []);\n  87 |\n  88 |   useEffect(() => {","line":85,"column":5,"nodeType":null,"endLine":85,"endColumn":15},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\maps\\location-picker-dialog.tsx:90:7\n  88 |   useEffect(() => {\n  89 |     if (initialPosition) {\n> 90 |       setSelectedPosition([initialPosition.lat, initialPosition.lng]);\n     |       ^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  91 |     } else if (open && initialAddress && !initialPosition) {\n  92 |       // Si pas de position initiale mais une adresse, on essaie de géocoder\n  93 |       const geocodeAddress = async () => {","line":90,"column":7,"nodeType":null,"endLine":90,"endColumn":26}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { MapContainer, TileLayer, Marker, useMapEvents, useMap } from \"react-leaflet\";\nimport type { LatLngExpression } from \"leaflet\";\nimport { MapPin } from \"lucide-react\";\n\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\n\n// Import dynamique pour éviter les erreurs SSR\nconst L = typeof window !== \"undefined\" ? require(\"leaflet\") : null;\n\n// Fix pour les icônes Leaflet avec Next.js\nif (typeof window !== \"undefined\" && L) {\n  delete (L.Icon.Default.prototype as Record<string, unknown>)._getIconUrl;\n  L.Icon.Default.mergeOptions({\n    iconRetinaUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png\",\n    iconUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png\",\n    shadowUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png\",\n  });\n}\n\n// Coordonnées de Dakar par défaut\nconst DAKAR_CENTER: LatLngExpression = [14.7167, -17.4677];\nconst DEFAULT_ZOOM = 12;\n\ninterface LocationPickerDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onLocationSelect: (lat: number, lng: number) => void;\n  initialPosition?: { lat: number; lng: number } | null;\n  initialAddress?: string;\n  isLoading?: boolean;\n}\n\n/**\n * Composant interne pour gérer les clics sur la carte\n */\nfunction MapClickHandler({\n  onMapClick,\n}: {\n  onMapClick: (lat: number, lng: number) => void;\n}) {\n  useMapEvents({\n    click: (e) => {\n      const { lat, lng } = e.latlng;\n      onMapClick(lat, lng);\n    },\n  });\n  return null;\n}\n\n/**\n * Composant interne pour centrer la carte sur une position\n */\nfunction MapCenter({ center, zoom }: { center: LatLngExpression; zoom: number }) {\n  const map = useMap();\n  useEffect(() => {\n    map.setView(center, zoom);\n  }, [map, center, zoom]);\n  return null;\n}\n\nexport function LocationPickerDialog({\n  open,\n  onOpenChange,\n  onLocationSelect,\n  initialPosition,\n  initialAddress,\n  isLoading = false,\n}: LocationPickerDialogProps) {\n  const [mounted, setMounted] = useState(false);\n  const [selectedPosition, setSelectedPosition] = useState<LatLngExpression>(\n    initialPosition ? [initialPosition.lat, initialPosition.lng] : DAKAR_CENTER\n  );\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  useEffect(() => {\n    if (initialPosition) {\n      setSelectedPosition([initialPosition.lat, initialPosition.lng]);\n    } else if (open && initialAddress && !initialPosition) {\n      // Si pas de position initiale mais une adresse, on essaie de géocoder\n      const geocodeAddress = async () => {\n        try {\n          const response = await fetch(\n            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(\n              initialAddress\n            )}&limit=1`,\n            {\n              headers: {\n                \"User-Agent\": \"Doussel-Immo-App/1.0\",\n              },\n            }\n          );\n          if (response.ok) {\n            const data = await response.json();\n            if (data && data.length > 0) {\n              const lat = parseFloat(data[0].lat);\n              const lon = parseFloat(data[0].lon);\n              setSelectedPosition([lat, lon]);\n            }\n          }\n        } catch (error) {\n          console.warn(\"Geocoding failed for initial address:\", error);\n        }\n      };\n      geocodeAddress();\n    }\n  }, [initialPosition, initialAddress, open]);\n\n  const handleMapClick = useCallback((lat: number, lng: number) => {\n    setSelectedPosition([lat, lng]);\n  }, []);\n\n  const handleConfirm = useCallback(() => {\n    const [lat, lng] = selectedPosition as [number, number];\n    onLocationSelect(lat, lng);\n    // On ne ferme plus le dialog ici, c'est le parent qui le fera après le chargement\n    // onOpenChange(false); \n  }, [selectedPosition, onLocationSelect]);\n\n  if (!mounted) {\n    return null;\n  }\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-4xl w-[95vw] h-[85vh] flex flex-col p-0 gap-0 bg-[#0b0f18] border-white/10\">\n        <DialogHeader className=\"px-6 pt-6 pb-4\">\n          <DialogTitle className=\"text-white text-xl font-semibold\">\n            Choisir la localisation sur la carte\n          </DialogTitle>\n          <DialogDescription className=\"text-white/70\">\n            Cliquez sur la carte pour placer le marqueur, puis confirmez votre choix\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"flex-1 relative min-h-0\">\n          {mounted && (\n            <MapContainer\n              center={selectedPosition}\n              zoom={DEFAULT_ZOOM}\n              scrollWheelZoom={true}\n              className=\"h-full w-full z-0\"\n              zoomControl={true}\n              attributionControl={true}\n            >\n              <TileLayer\n                url=\"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png\"\n                attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors &copy; <a href=\"https://carto.com/attributions\">CARTO</a>'\n                subdomains=\"abcd\"\n                maxZoom={19}\n              />\n              <MapCenter center={selectedPosition} zoom={DEFAULT_ZOOM} />\n              <MapClickHandler onMapClick={handleMapClick} />\n              <Marker position={selectedPosition} />\n            </MapContainer>\n          )}\n        </div>\n\n        <div className=\"px-6 py-4 border-t border-white/10 flex items-center justify-between\">\n          <div className=\"flex items-center gap-2 text-white/70 text-sm\">\n            <MapPin className=\"h-4 w-4\" />\n            <span>\n              {Array.isArray(selectedPosition) &&\n                typeof selectedPosition[0] === \"number\" &&\n                typeof selectedPosition[1] === \"number\"\n                ? `${selectedPosition[0].toFixed(6)}, ${selectedPosition[1].toFixed(6)}`\n                : \"Position non définie\"}\n            </span>\n          </div>\n          <div className=\"flex gap-3\">\n            <Button\n              type=\"button\"\n              variant=\"secondary\"\n              onClick={() => onOpenChange(false)}\n              className=\"bg-white/5 text-white border-white/10 hover:bg-white/10\"\n            >\n              Annuler\n            </Button>\n            <Button\n              type=\"button\"\n              onClick={handleConfirm}\n              disabled={isLoading}\n              className=\"bg-amber-500 text-black hover:bg-amber-400\"\n            >\n              {isLoading ? (\n                <>\n                  <span className=\"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-black border-t-transparent\" />\n                  Chargement...\n                </>\n              ) : (\n                \"Confirmer la position\"\n              )}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\navigation\\bottom-nav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\navigation\\header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\onboarding\\RentalTour.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1190,1193],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1190,1193],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect } from 'react';\r\nimport { driver } from \"driver.js\";\r\nimport \"driver.js/dist/driver.css\";\r\nimport \"./dousell-driver-theme.css\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { HelpCircle } from \"lucide-react\";\r\n\r\ntype PageContext = 'dashboard' | 'interventions' | 'legal' | 'home';\r\n\r\ninterface RentalTourProps {\r\n    hasProperties?: boolean;\r\n    page: PageContext;\r\n}\r\n\r\nexport function RentalTour({ hasProperties = true, page }: RentalTourProps) {\r\n\r\n    useEffect(() => {\r\n        // 1. Clé unique par page pour mémoriser si le tour a été vu\r\n        const storageKey = `dousell_tour_seen_${page}`;\r\n        const tourSeen = localStorage.getItem(storageKey);\r\n\r\n        // 2. Condition de déclenchement :\r\n        // - Si jamais vu sur cette page\r\n        // - Pour 'home', on veut cibler les NOUVEAUX utilisateurs sans données (comme le dashboard)\r\n        // EDIT: On autorise le tour Dashboard même avec des propriétés pour être sûr qu'il s'affiche\r\n        const shouldRun = !tourSeen && (page === 'dashboard' || !hasProperties);\r\n\r\n        if (shouldRun) {\r\n            // Définition des étapes selon la page\r\n            let steps: any[] = [];\r\n\r\n            if (page === 'dashboard') {\r\n                steps = [\r\n                    {\r\n                        element: '#tour-stats',\r\n                        popover: {\r\n                            title: 'Bienvenue sur votre Gestion ! 👋',\r\n                            description: 'Ici, vous aurez une vue d\\'ensemble de vos loyers encaissés et taux d\\'occupation.'\r\n                        }\r\n                    },\r\n                    {\r\n                        element: '#tour-add-tenant',\r\n                        popover: {\r\n                            title: 'Gestion des Locataires 👤',\r\n                            description: 'C\\'est ici que vous créerez vos baux. Le système générera automatiquement les contrats et quittances.',\r\n                            side: \"top\",\r\n                        }\r\n                    },\r\n                    {\r\n                        element: '#tour-nav-interventions',\r\n                        popover: {\r\n                            title: 'Suivi des Travaux 🛠️',\r\n                            description: 'Cliquez ici pour gérer les signalements de vos locataires.',\r\n                            side: \"bottom\",\r\n                        }\r\n                    },\r\n                    {\r\n                        element: '#tour-nav-legal',\r\n                        popover: {\r\n                            title: 'Assistant Juridique ⚖️',\r\n                            description: 'Accédez à vos alertes légales et modèles de documents ici.',\r\n                            side: \"bottom\",\r\n                            align: 'end'\r\n                        }\r\n                    }\r\n                ];\r\n            } else if (page === 'home') {\r\n                // Détection responsive simple\r\n                const isMobile = window.innerWidth < 768; // 768px est le breakpoint 'md' de Tailwind\r\n\r\n                if (isMobile) {\r\n                    // --- VERSION MOBILE (5 Étapes avec BottomNav) ---\r\n                    steps = [\r\n                        {\r\n                            element: '#tour-home-add-mobile',\r\n                            popover: {\r\n                                title: 'Publier une Annonce 🏠',\r\n                                description: 'Cliquez sur le + pour mettre en location ou vendre un bien gratuitement.',\r\n                                side: \"bottom\",\r\n                                align: 'end'\r\n                            }\r\n                        },\r\n                        {\r\n                            element: '#tour-home-menu-mobile',\r\n                            popover: {\r\n                                title: 'Menu Principal ☰',\r\n                                description: 'Accédez à vos paramètres, notifications et profil.',\r\n                                side: \"bottom\",\r\n                                align: 'end'\r\n                            }\r\n                        },\r\n                        {\r\n                            element: '#tour-home-search',\r\n                            popover: {\r\n                                title: 'Rechercher 🔍',\r\n                                description: 'Explorez milliers d\\'annonces immobilières vérifiées au Sénégal.',\r\n                                side: \"top\"\r\n                            }\r\n                        },\r\n                        {\r\n                            element: '#tour-home-gestion',\r\n                            popover: {\r\n                                title: 'Gestion Locative 🏢',\r\n                                description: 'Gérez vos biens, loyers et locataires en toute simplicité (Gratuit).',\r\n                                side: \"top\"\r\n                            }\r\n                        },\r\n                        {\r\n                            element: '#tour-home-account',\r\n                            popover: {\r\n                                title: 'Votre Compte 👤',\r\n                                description: 'Retrouvez vos favoris, documents et informations personnelles.',\r\n                                side: \"top\"\r\n                            }\r\n                        }\r\n                    ];\r\n                } else {\r\n                    // --- VERSION DESKTOP (Interface différente) ---\r\n                    steps = [\r\n                        {\r\n                            element: '#tour-home-add-desktop',\r\n                            popover: {\r\n                                title: 'Publier une Annonce 🏠',\r\n                                description: 'Mettez en location ou vendez un bien gratuitement en un clic.',\r\n                                side: \"bottom\"\r\n                            }\r\n                        },\r\n                        {\r\n                            element: '#tour-home-nav-search-desktop',\r\n                            popover: {\r\n                                title: 'Rechercher 🔍',\r\n                                description: 'Trouvez la perle rare parmi nos annonces vérifiées.',\r\n                                side: \"bottom\"\r\n                            }\r\n                        },\r\n                        {\r\n                            element: '#tour-home-menu-desktop',\r\n                            popover: {\r\n                                title: 'Votre Espace Perso 👤',\r\n                                description: 'Gérez votre compte, vos favoris et accédez à votre Tableau de Bord de Gestion.',\r\n                                side: \"left\"\r\n                            }\r\n                        }\r\n                    ];\r\n                }\r\n            } else if (page === 'interventions') {\r\n                steps = [\r\n                    {\r\n                        element: '#tour-intervention-stats',\r\n                        popover: {\r\n                            title: 'Tableau de Bord Maintenance 🔧',\r\n                            description: 'Suivez ici l\\'état de toutes vos demandes d\\'intervention en temps réel.',\r\n                            side: \"bottom\",\r\n                            align: 'start'\r\n                        }\r\n                    },\r\n                    {\r\n                        element: '#tour-intervention-list',\r\n                        popover: {\r\n                            title: 'Liste des Signalements 📋',\r\n                            description: 'Retrouvez ici les détails des pannes signalées par vos locataires.',\r\n                            side: \"top\"\r\n                        }\r\n                    }\r\n                ];\r\n            } else if (page === 'legal') {\r\n                steps = [\r\n                    {\r\n                        element: '#tour-legal-kpi',\r\n                        popover: {\r\n                            title: 'Indicateurs de Conformité 📊',\r\n                            description: 'Surveillez vos risques juridiques et vos échéances de baux en un coup d\\'œil.',\r\n                            side: \"bottom\"\r\n                        }\r\n                    },\r\n                    {\r\n                        element: '#tour-legal-alerts',\r\n                        popover: {\r\n                            title: 'Radar des Échéances 📡',\r\n                            description: 'Le système vous alerte automatiquement 6 mois et 3 mois avant la fin d\\'un bail.',\r\n                            side: \"top\"\r\n                        }\r\n                    },\r\n                    {\r\n                        element: '#tour-legal-tools',\r\n                        popover: {\r\n                            title: 'Outils Rapides ⚡',\r\n                            description: 'Générez des quittances ou de nouveaux contrats conformes en un clic.',\r\n                            side: \"top\"\r\n                        }\r\n                    },\r\n                    {\r\n                        element: '#tour-generate-contract',\r\n                        popover: {\r\n                            title: '✨ NOUVEAU : Générateur Juridique',\r\n                            description: 'Plus besoin de Word ! Générez un contrat de bail conforme OHADA/Sénégal directement ici.',\r\n                            side: \"left\",\r\n                            align: 'center'\r\n                        }\r\n                    },\r\n                    {\r\n                        element: '#tour-legal-reference',\r\n                        popover: {\r\n                            title: 'Cadre Juridique 📚',\r\n                            description: 'Retrouvez ici les délais légaux (préavis, reconduction) et textes de loi applicables au Sénégal.',\r\n                            side: \"top\"\r\n                        }\r\n                    }\r\n                ];\r\n            }\r\n\r\n            if (steps.length > 0) {\r\n                const driverObj = driver({\r\n                    showProgress: true,\r\n                    animate: true,\r\n                    popoverClass: 'dousell-theme',\r\n                    nextBtnText: 'Suivant →',\r\n                    prevBtnText: '← Retour',\r\n                    doneBtnText: 'C\\'est compris !',\r\n                    onDestroyed: () => {\r\n                        localStorage.setItem(storageKey, 'true');\r\n                    },\r\n                    steps: steps,\r\n                    allowKeyboardControl: true,\r\n                    allowClose: false\r\n                });\r\n\r\n                setTimeout(() => {\r\n                    driverObj.drive();\r\n                }, 1000);\r\n            }\r\n        }\r\n    }, [hasProperties, page]);\r\n\r\n    const resetTour = () => {\r\n        localStorage.removeItem(`dousell_tour_seen_${page}`);\r\n        window.location.reload();\r\n    };\r\n\r\n    return (\r\n        <Button\r\n            variant=\"ghost\"\r\n            size=\"icon\"\r\n            onClick={resetTour}\r\n            className=\"fixed bottom-4 right-4 z-50 opacity-50 hover:opacity-100 bg-black/20 backdrop-blur-sm text-white border border-white/10\"\r\n            title=\"Relancer le tutoriel de cette page\"\r\n        >\r\n            <HelpCircle className=\"h-5 w-5\" />\r\n        </Button>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pdf\\PreavisPDF.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":231,"column":15,"nodeType":"JSXOpeningElement","endLine":231,"endColumn":65},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":315,"column":15,"nodeType":"JSXOpeningElement","endLine":315,"endColumn":80}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';\r\n\r\n// Types\r\ninterface PreaviseData {\r\n  // Informations bail\r\n  tenantName: string;\r\n  tenantEmail?: string;\r\n  tenantPhone?: string;\r\n  tenantAddress?: string;\r\n  propertyAddress: string;\r\n  monthlyAmount: number;\r\n  startDate: string;\r\n  endDate: string;\r\n\r\n  // Type de préavis\r\n  noticeType: 'J-180' | 'J-90'; // 6 mois ou 3 mois\r\n  noticeDate: string; // Date d'émission du préavis\r\n\r\n  // Informations propriétaire\r\n  ownerName: string;\r\n  ownerAddress: string;\r\n  ownerEmail?: string;\r\n  ownerPhone?: string;\r\n  ownerNinea?: string;\r\n  ownerLogo?: string;\r\n  ownerSignature?: string;\r\n\r\n  // Numéro unique\r\n  noticeNumber: string;\r\n}\r\n\r\n// Styles professionnels pour document juridique\r\nconst styles = StyleSheet.create({\r\n  page: {\r\n    padding: 25,\r\n    fontSize: 9,\r\n    fontFamily: 'Helvetica',\r\n    lineHeight: 1.3,\r\n  },\r\n  header: {\r\n    flexDirection: 'row',\r\n    justifyContent: 'space-between',\r\n    marginBottom: 12,\r\n    paddingBottom: 10,\r\n    borderBottomWidth: 2,\r\n    borderBottomColor: '#F4C430',\r\n  },\r\n  logo: {\r\n    width: 60,\r\n    height: 40,\r\n    objectFit: 'contain',\r\n  },\r\n  headerRight: {\r\n    textAlign: 'right',\r\n  },\r\n  companyName: {\r\n    fontSize: 11,\r\n    fontWeight: 'bold',\r\n    marginBottom: 2,\r\n  },\r\n  companyInfo: {\r\n    fontSize: 7,\r\n    color: '#666',\r\n    marginBottom: 1,\r\n  },\r\n  title: {\r\n    fontSize: 13,\r\n    fontWeight: 'bold',\r\n    textAlign: 'center',\r\n    marginTop: 15,\r\n    marginBottom: 12,\r\n    textTransform: 'uppercase',\r\n    textDecoration: 'underline',\r\n  },\r\n  subtitle: {\r\n    fontSize: 9,\r\n    textAlign: 'center',\r\n    color: '#666',\r\n    marginBottom: 15,\r\n  },\r\n  section: {\r\n    marginBottom: 12,\r\n  },\r\n  sectionTitle: {\r\n    fontSize: 10,\r\n    fontWeight: 'bold',\r\n    marginBottom: 6,\r\n    textTransform: 'uppercase',\r\n    color: '#333',\r\n  },\r\n  paragraph: {\r\n    fontSize: 9,\r\n    textAlign: 'justify',\r\n    marginBottom: 8,\r\n    lineHeight: 1.4,\r\n  },\r\n  infoBox: {\r\n    backgroundColor: '#f9f9f9',\r\n    padding: 8,\r\n    borderRadius: 4,\r\n    marginBottom: 10,\r\n    borderLeftWidth: 3,\r\n    borderLeftColor: '#F4C430',\r\n  },\r\n  infoRow: {\r\n    flexDirection: 'row',\r\n    marginBottom: 3,\r\n  },\r\n  infoLabel: {\r\n    fontSize: 8,\r\n    fontWeight: 'bold',\r\n    width: '35%',\r\n  },\r\n  infoValue: {\r\n    fontSize: 8,\r\n    width: '65%',\r\n  },\r\n  warningBox: {\r\n    backgroundColor: '#fff3cd',\r\n    padding: 8,\r\n    borderRadius: 4,\r\n    marginTop: 10,\r\n    marginBottom: 10,\r\n    borderWidth: 1,\r\n    borderColor: '#ffc107',\r\n  },\r\n  warningTitle: {\r\n    fontSize: 9,\r\n    fontWeight: 'bold',\r\n    color: '#856404',\r\n    marginBottom: 5,\r\n  },\r\n  warningText: {\r\n    fontSize: 8,\r\n    color: '#856404',\r\n    lineHeight: 1.3,\r\n  },\r\n  legalText: {\r\n    fontSize: 7,\r\n    color: '#666',\r\n    fontStyle: 'italic',\r\n    marginTop: 6,\r\n    marginBottom: 6,\r\n  },\r\n  signatureSection: {\r\n    marginTop: 20,\r\n    flexDirection: 'row',\r\n    justifyContent: 'space-between',\r\n  },\r\n  signatureBox: {\r\n    width: '45%',\r\n  },\r\n  signatureLabel: {\r\n    fontSize: 9,\r\n    fontWeight: 'bold',\r\n    marginBottom: 3,\r\n  },\r\n  signatureText: {\r\n    fontSize: 8,\r\n    marginBottom: 2,\r\n  },\r\n  signatureImage: {\r\n    width: 100,\r\n    height: 45,\r\n    marginTop: 8,\r\n    objectFit: 'contain',\r\n  },\r\n  footer: {\r\n    position: 'absolute',\r\n    bottom: 20,\r\n    left: 25,\r\n    right: 25,\r\n    textAlign: 'center',\r\n    fontSize: 6,\r\n    color: '#999',\r\n    borderTopWidth: 1,\r\n    borderTopColor: '#eee',\r\n    paddingTop: 6,\r\n  },\r\n});\r\n\r\n// Contenu des préavis selon le type\r\nconst getNoticeContent = (data: PreaviseData) => {\r\n  const isJ180 = data.noticeType === 'J-180';\r\n\r\n  return {\r\n    title: isJ180\r\n      ? 'PRÉAVIS DE CONGÉ POUR REPRISE'\r\n      : 'NOTIFICATION DE RECONDUCTION TACITE',\r\n\r\n    subject: isJ180\r\n      ? 'Notification de Congé - 6 mois avant échéance'\r\n      : 'Reconduction du bail - 3 mois avant échéance',\r\n\r\n    mainText: isJ180\r\n      ? `Par la présente, je vous notifie mon intention de ne pas renouveler le bail de location concernant le bien situé ${data.propertyAddress}, dont le contrat arrivera à échéance le ${new Date(data.endDate).toLocaleDateString('fr-FR')}.\r\n\r\nConformément aux dispositions de la loi sénégalaise n° 2014-22 du 24 février 2014 portant loi d'orientation sur l'habitat social et aux articles du Code des Obligations Civiles et Commerciales (COCC), je vous informe par la présente de ma décision de reprendre les lieux loués.\r\n\r\nCe préavis respecte le délai légal de SIX (6) MOIS avant l'échéance du bail, comme l'exige la législation en vigueur.`\r\n\r\n      : `Je vous informe que le bail de location concernant le bien situé ${data.propertyAddress} arrivera à échéance le ${new Date(data.endDate).toLocaleDateString('fr-FR')}.\r\n\r\nConformément aux dispositions de la loi sénégalaise n° 2014-22 du 24 février 2014 et aux articles du Code des Obligations Civiles et Commerciales (COCC), en l'absence de congé signifié dans les délais légaux, le bail sera automatiquement reconduit aux mêmes conditions.\r\n\r\nNous sommes dans le délai de TROIS (3) MOIS avant l'échéance, période durant laquelle vous pouvez encore manifester votre intention concernant le renouvellement du bail.`,\r\n\r\n    actionRequired: isJ180\r\n      ? `Vous êtes prié(e) de libérer les lieux au plus tard à la date d'échéance mentionnée ci-dessus, soit le ${new Date(data.endDate).toLocaleDateString('fr-FR')}.`\r\n      : `Si vous souhaitez donner congé ou négocier de nouvelles conditions, veuillez me contacter dans les meilleurs délais. À défaut, le bail sera renouvelé tacitement pour la même durée.`,\r\n\r\n    legalReference: isJ180\r\n      ? 'Article relatif au préavis de congé - Loi n° 2014-22 du 24 février 2014 & COCC Sénégal'\r\n      : 'Article relatif à la reconduction tacite - Loi n° 2014-22 du 24 février 2014 & COCC Sénégal'\r\n  };\r\n};\r\n\r\n// Document PDF\r\nconst PreaviseDocument = ({ data }: { data: PreaviseData }) => {\r\n  const content = getNoticeContent(data);\r\n  const formattedAmount = new Intl.NumberFormat('fr-FR').format(data.monthlyAmount);\r\n\r\n  return (\r\n    <Document>\r\n      <Page size=\"A4\" style={styles.page}>\r\n        {/* En-tête avec logo */}\r\n        <View style={styles.header}>\r\n          <View>\r\n            {data.ownerLogo ? (\r\n              <Image src={data.ownerLogo} style={styles.logo} />\r\n            ) : (\r\n              <Text style={styles.companyName}>{data.ownerName}</Text>\r\n            )}\r\n          </View>\r\n          <View style={styles.headerRight}>\r\n            <Text style={styles.companyName}>{data.ownerName}</Text>\r\n            <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\r\n            {data.ownerEmail && <Text style={styles.companyInfo}>{data.ownerEmail}</Text>}\r\n            {data.ownerPhone && <Text style={styles.companyInfo}>{data.ownerPhone}</Text>}\r\n            {data.ownerNinea && <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>}\r\n          </View>\r\n        </View>\r\n\r\n        {/* Numéro et date */}\r\n        <View style={{ marginBottom: 20 }}>\r\n          <Text style={{ fontSize: 9, textAlign: 'right', color: '#666' }}>\r\n            Préavis N° {data.noticeNumber}\r\n          </Text>\r\n          <Text style={{ fontSize: 9, textAlign: 'right', color: '#666' }}>\r\n            Émis le {new Date(data.noticeDate).toLocaleDateString('fr-FR')}\r\n          </Text>\r\n        </View>\r\n\r\n        {/* Destinataire */}\r\n        <View style={styles.section}>\r\n          <Text style={{ fontSize: 10, marginBottom: 5 }}>À l&apos;attention de :</Text>\r\n          <Text style={{ fontSize: 11, fontWeight: 'bold', marginBottom: 3 }}>{data.tenantName}</Text>\r\n          {data.tenantAddress && <Text style={{ fontSize: 9 }}>{data.tenantAddress}</Text>}\r\n        </View>\r\n\r\n        {/* Titre */}\r\n        <Text style={styles.title}>{content.title}</Text>\r\n        <Text style={styles.subtitle}>{content.subject}</Text>\r\n\r\n        {/* Informations du bail */}\r\n        <View style={styles.infoBox}>\r\n          <View style={styles.infoRow}>\r\n            <Text style={styles.infoLabel}>Bien loué :</Text>\r\n            <Text style={styles.infoValue}>{data.propertyAddress}</Text>\r\n          </View>\r\n          <View style={styles.infoRow}>\r\n            <Text style={styles.infoLabel}>Loyer mensuel :</Text>\r\n            <Text style={styles.infoValue}>{formattedAmount} FCFA</Text>\r\n          </View>\r\n          <View style={styles.infoRow}>\r\n            <Text style={styles.infoLabel}>Date de début :</Text>\r\n            <Text style={styles.infoValue}>{new Date(data.startDate).toLocaleDateString('fr-FR')}</Text>\r\n          </View>\r\n          <View style={styles.infoRow}>\r\n            <Text style={styles.infoLabel}>Date d&apos;échéance :</Text>\r\n            <Text style={styles.infoValue}>{new Date(data.endDate).toLocaleDateString('fr-FR')}</Text>\r\n          </View>\r\n          <View style={styles.infoRow}>\r\n            <Text style={styles.infoLabel}>Type de préavis :</Text>\r\n            <Text style={styles.infoValue}>{data.noticeType === 'J-180' ? '6 mois (Congé pour reprise)' : '3 mois (Reconduction tacite)'}</Text>\r\n          </View>\r\n        </View>\r\n\r\n        {/* Corps du préavis */}\r\n        <Text style={styles.paragraph}>{content.mainText}</Text>\r\n\r\n        {/* Action requise */}\r\n        <View style={styles.warningBox}>\r\n          <Text style={styles.warningTitle}>⚠️ ACTION REQUISE</Text>\r\n          <Text style={styles.warningText}>{content.actionRequired}</Text>\r\n        </View>\r\n\r\n        {/* Référence légale */}\r\n        <Text style={styles.legalText}>\r\n          {content.legalReference}\r\n        </Text>\r\n\r\n        {/* Formule de politesse */}\r\n        <Text style={styles.paragraph}>\r\n          Je vous prie d&apos;agréer, Madame, Monsieur, l&apos;expression de mes salutations distinguées.\r\n        </Text>\r\n\r\n        {/* Signatures */}\r\n        <View style={styles.signatureSection}>\r\n          <View style={styles.signatureBox}>\r\n            <Text style={styles.signatureLabel}>Le Propriétaire</Text>\r\n            <Text style={styles.signatureText}>{data.ownerName}</Text>\r\n            {data.ownerSignature && (\r\n              <Image src={data.ownerSignature} style={styles.signatureImage} />\r\n            )}\r\n          </View>\r\n\r\n          <View style={styles.signatureBox}>\r\n            <Text style={styles.signatureLabel}>Le Locataire (pour réception)</Text>\r\n            <Text style={styles.signatureText}>{data.tenantName}</Text>\r\n            <View style={{ height: 60, borderBottomWidth: 1, borderBottomColor: '#ddd', marginTop: 15 }} />\r\n            <Text style={{ fontSize: 8, color: '#999', marginTop: 5 }}>Signature et date</Text>\r\n          </View>\r\n        </View>\r\n\r\n        {/* Pied de page */}\r\n        <View style={styles.footer}>\r\n          <Text>Document généré automatiquement par Dousell Immo</Text>\r\n          <Text>Conforme à la loi n° 2014-22 du 24 février 2014 & Code des Obligations Civiles et Commerciales du Sénégal</Text>\r\n        </View>\r\n      </Page>\r\n    </Document>\r\n  );\r\n};\r\n\r\n// Export de la fonction de création\r\nexport const createPreavisDocument = (data: PreaviseData) => {\r\n  return <PreaviseDocument data={data} />;\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pdf\\QuittancePDF.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":231,"column":15,"nodeType":"JSXOpeningElement","endLine":231,"endColumn":65},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":315,"column":13,"nodeType":"JSXOpeningElement","endLine":315,"endColumn":73},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'QuittancePDFOld' is assigned a value but never used.","line":336,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":336,"endColumn":22},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":346,"column":15,"nodeType":"JSXOpeningElement","endLine":346,"endColumn":65},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":430,"column":13,"nodeType":"JSXOpeningElement","endLine":430,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';\n\n// Types\ninterface QuittanceData {\n  // Locataire\n  tenantName: string;\n  tenantEmail?: string;\n  tenantPhone?: string;\n  tenantAddress?: string;\n\n  // Montants\n  amount: number;\n\n  // Période\n  periodMonth: string;\n  periodStart: string;\n  periodEnd: string;\n\n  // Référence\n  receiptNumber: string;\n\n  // Propriétaire\n  ownerName: string;\n  ownerAddress: string;\n  ownerNinea?: string;\n  ownerLogo?: string;\n  ownerSignature?: string;\n\n  // Propriété\n  propertyAddress: string;\n}\n\n// Styles\nconst styles = StyleSheet.create({\n  page: {\n    padding: 40,\n    fontSize: 11,\n    fontFamily: 'Helvetica',\n    lineHeight: 1.5,\n  },\n\n  // En-tête\n  header: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 30,\n    paddingBottom: 20,\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n  },\n  logo: {\n    width: 100,\n    height: 60,\n    objectFit: 'contain',\n  },\n  headerRight: {\n    textAlign: 'right',\n  },\n  companyName: {\n    fontSize: 16,\n    fontWeight: 'bold',\n    marginBottom: 5,\n  },\n  companyInfo: {\n    fontSize: 9,\n    color: '#666',\n  },\n\n  // Titre\n  title: {\n    fontSize: 20,\n    fontWeight: 'bold',\n    textAlign: 'center',\n    marginBottom: 30,\n    textTransform: 'uppercase',\n    letterSpacing: 2,\n    backgroundColor: '#f9f9f9',\n    padding: 15,\n    border: '1px solid #eee',\n  },\n\n  // Blocs d'infos\n  infoBlock: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 30,\n  },\n  box: {\n    width: '48%',\n    padding: 15,\n    border: '1px solid #ddd',\n    borderRadius: 4,\n  },\n  boxHighlight: {\n    width: '48%',\n    padding: 15,\n    borderWidth: 1,\n    borderColor: '#F4C430',\n    borderRadius: 4,\n    backgroundColor: '#fffdf5',\n  },\n  boxTitle: {\n    fontSize: 9,\n    color: '#999',\n    textTransform: 'uppercase',\n    marginBottom: 8,\n    fontWeight: 'bold',\n  },\n  boxName: {\n    fontSize: 12,\n    fontWeight: 'bold',\n    marginBottom: 5,\n  },\n  boxText: {\n    fontSize: 10,\n    color: '#555',\n    marginBottom: 3,\n  },\n\n  // Propriété\n  propertyInfo: {\n    backgroundColor: '#f5f5f5',\n    padding: 10,\n    borderRadius: 4,\n    marginBottom: 20,\n    fontSize: 10,\n  },\n\n  // Tableau\n  table: {\n    marginTop: 20,\n    marginBottom: 30,\n  },\n  tableHeader: {\n    flexDirection: 'row',\n    backgroundColor: '#f9f9f9',\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n    paddingVertical: 10,\n    paddingHorizontal: 10,\n  },\n  tableRow: {\n    flexDirection: 'row',\n    borderBottomWidth: 1,\n    borderBottomColor: '#eee',\n    paddingVertical: 12,\n    paddingHorizontal: 10,\n  },\n  tableTotalRow: {\n    flexDirection: 'row',\n    backgroundColor: '#FFF8E1',\n    paddingVertical: 12,\n    paddingHorizontal: 10,\n    fontWeight: 'bold',\n  },\n  col1: { width: '40%', fontSize: 10 },\n  col2: { width: '30%', fontSize: 10, textAlign: 'right' },\n  col3: { width: '30%', fontSize: 10, textAlign: 'right' },\n  tableHeaderText: {\n    fontSize: 9,\n    color: '#666',\n    fontWeight: 'bold',\n    textTransform: 'uppercase',\n  },\n\n  // Texte légal\n  legalText: {\n    fontSize: 10,\n    lineHeight: 1.6,\n    marginBottom: 30,\n    textAlign: 'justify',\n  },\n\n  // Signature\n  signatureBlock: {\n    marginTop: 40,\n    alignItems: 'flex-end',\n  },\n  signatureLabel: {\n    fontSize: 10,\n    fontWeight: 'bold',\n    marginBottom: 10,\n  },\n  signature: {\n    width: 120,\n    height: 60,\n    objectFit: 'contain',\n  },\n  signaturePlaceholder: {\n    fontSize: 9,\n    color: '#ccc',\n    fontStyle: 'italic',\n    marginTop: 10,\n  },\n\n  // Footer\n  footer: {\n    position: 'absolute',\n    bottom: 30,\n    left: 40,\n    right: 40,\n    textAlign: 'center',\n    fontSize: 8,\n    color: '#999',\n    borderTopWidth: 1,\n    borderTopColor: '#eee',\n    paddingTop: 15,\n  },\n});\n\n// Export du type pour pouvoir l'utiliser ailleurs\nexport type { QuittanceData };\n\n// Fonction helper pour formater les montants\nconst formatAmount = (amount: number) => {\n  return new Intl.NumberFormat('fr-FR').format(amount);\n};\n\n// Fonction pour générer le Document PDF (pour l'API)\nexport const createQuittanceDocument = (data: QuittanceData) => {\n  const today = new Date().toLocaleDateString('fr-FR');\n\n  return (\n    <Document>\n      <Page size=\"A4\" style={styles.page}>\n        {/* En-tête */}\n        <View style={styles.header}>\n          <View>\n            {data.ownerLogo && (\n              <Image src={data.ownerLogo} style={styles.logo} />\n            )}\n            <Text style={styles.companyName}>{data.ownerName}</Text>\n            <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n            {data.ownerNinea && (\n              <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>\n            )}\n          </View>\n          <View style={styles.headerRight}>\n            <Text style={styles.companyInfo}>Quittance N°</Text>\n            <Text style={{ fontSize: 12, fontWeight: 'bold', marginBottom: 5 }}>\n              {data.receiptNumber}\n            </Text>\n            <Text style={styles.companyInfo}>Date d&apos;émission</Text>\n            <Text style={{ fontSize: 10, fontWeight: 'bold' }}>{today}</Text>\n          </View>\n        </View>\n\n        {/* Titre */}\n        <Text style={styles.title}>QUITTANCE DE LOYER</Text>\n\n        {/* Blocs d'infos */}\n        <View style={styles.infoBlock}>\n          <View style={styles.box}>\n            <Text style={styles.boxTitle}>Bailleur / Mandataire</Text>\n            <Text style={styles.boxName}>{data.ownerName}</Text>\n            <Text style={styles.boxText}>{data.ownerAddress}</Text>\n          </View>\n          <View style={styles.boxHighlight}>\n            <Text style={[styles.boxTitle, { color: '#B8860B' }]}>Locataire</Text>\n            <Text style={styles.boxName}>{data.tenantName}</Text>\n            {data.tenantAddress && (\n              <Text style={styles.boxText}>{data.tenantAddress}</Text>\n            )}\n            {data.tenantEmail && (\n              <Text style={styles.boxText}>{data.tenantEmail}</Text>\n            )}\n            {data.tenantPhone && (\n              <Text style={styles.boxText}>{data.tenantPhone}</Text>\n            )}\n          </View>\n        </View>\n\n        {/* Adresse du bien */}\n        <View style={styles.propertyInfo}>\n          <Text>\n            <Text style={{ fontWeight: 'bold' }}>Adresse du bien loué : </Text>\n            {data.propertyAddress}\n          </Text>\n        </View>\n\n        {/* Texte légal */}\n        <Text style={styles.legalText}>\n          Je soussigné(e) <Text style={{ fontWeight: 'bold' }}>{data.ownerName}</Text>, propriétaire ou mandataire du bien\n          situé au <Text style={{ fontWeight: 'bold' }}>{data.propertyAddress}</Text>, reconnais avoir reçu de{' '}\n          <Text style={{ fontWeight: 'bold' }}>{data.tenantName}</Text>, locataire dudit bien, la somme détaillée\n          ci-dessous au titre du loyer et des charges pour la période concernée.\n        </Text>\n\n        {/* Tableau */}\n        <View style={styles.table}>\n          <View style={styles.tableHeader}>\n            <Text style={[styles.col1, styles.tableHeaderText]}>Désignation</Text>\n            <Text style={[styles.col2, styles.tableHeaderText]}>Période</Text>\n            <Text style={[styles.col3, styles.tableHeaderText]}>Montant</Text>\n          </View>\n          <View style={styles.tableRow}>\n            <Text style={styles.col1}>Loyer et charges</Text>\n            <Text style={styles.col2}>Du {data.periodStart} au {data.periodEnd}</Text>\n            <Text style={styles.col3}>{formatAmount(data.amount)} FCFA</Text>\n          </View>\n          <View style={styles.tableTotalRow}>\n            <Text style={[styles.col1, { fontWeight: 'bold' }]}>TOTAL ACQUITTÉ</Text>\n            <Text style={styles.col2}></Text>\n            <Text style={[styles.col3, { fontWeight: 'bold', fontSize: 12 }]}>\n              {formatAmount(data.amount)} FCFA\n            </Text>\n          </View>\n        </View>\n\n        {/* Signature */}\n        <View style={styles.signatureBlock}>\n          <Text style={styles.signatureLabel}>Le Bailleur (Signature)</Text>\n          {data.ownerSignature ? (\n            <Image src={data.ownerSignature} style={styles.signature} />\n          ) : (\n            <Text style={styles.signaturePlaceholder}>(Signé électroniquement)</Text>\n          )}\n        </View>\n\n        {/* Footer */}\n        <Text style={styles.footer}>\n          Document généré automatiquement par Dousell Immo pour {data.ownerName}.{'\\n'}\n          Pour faire valoir ce que de droit.\n        </Text>\n      </Page>\n    </Document>\n  );\n};\n\nexport const QuittancePDF: React.FC<{ data: QuittanceData }> = ({ data }) => {\n  return createQuittanceDocument(data);\n};\n\n// Ancienne version (gardée pour compatibilité)\nconst QuittancePDFOld: React.FC<{ data: QuittanceData }> = ({ data }) => {\n  const today = new Date().toLocaleDateString('fr-FR');\n\n  return (\n    <Document>\n      <Page size=\"A4\" style={styles.page}>\n        {/* En-tête */}\n        <View style={styles.header}>\n          <View>\n            {data.ownerLogo && (\n              <Image src={data.ownerLogo} style={styles.logo} />\n            )}\n            <Text style={styles.companyName}>{data.ownerName}</Text>\n            <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n            {data.ownerNinea && (\n              <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>\n            )}\n          </View>\n          <View style={styles.headerRight}>\n            <Text style={styles.companyInfo}>Quittance N°</Text>\n            <Text style={{ fontSize: 12, fontWeight: 'bold', marginBottom: 5 }}>\n              {data.receiptNumber}\n            </Text>\n            <Text style={styles.companyInfo}>Date d&apos;émission</Text>\n            <Text style={{ fontSize: 10, fontWeight: 'bold' }}>{today}</Text>\n          </View>\n        </View>\n\n        {/* Titre */}\n        <Text style={styles.title}>QUITTANCE DE LOYER</Text>\n\n        {/* Blocs d'infos */}\n        <View style={styles.infoBlock}>\n          <View style={styles.box}>\n            <Text style={styles.boxTitle}>Bailleur / Mandataire</Text>\n            <Text style={styles.boxName}>{data.ownerName}</Text>\n            <Text style={styles.boxText}>{data.ownerAddress}</Text>\n          </View>\n          <View style={styles.boxHighlight}>\n            <Text style={[styles.boxTitle, { color: '#B8860B' }]}>Locataire</Text>\n            <Text style={styles.boxName}>{data.tenantName}</Text>\n            {data.tenantAddress && (\n              <Text style={styles.boxText}>{data.tenantAddress}</Text>\n            )}\n            {data.tenantEmail && (\n              <Text style={styles.boxText}>{data.tenantEmail}</Text>\n            )}\n            {data.tenantPhone && (\n              <Text style={styles.boxText}>{data.tenantPhone}</Text>\n            )}\n          </View>\n        </View>\n\n        {/* Adresse du bien */}\n        <View style={styles.propertyInfo}>\n          <Text>\n            <Text style={{ fontWeight: 'bold' }}>Adresse du bien loué : </Text>\n            {data.propertyAddress}\n          </Text>\n        </View>\n\n        {/* Texte légal */}\n        <Text style={styles.legalText}>\n          Je soussigné(e) <Text style={{ fontWeight: 'bold' }}>{data.ownerName}</Text>, propriétaire ou mandataire du bien\n          situé au <Text style={{ fontWeight: 'bold' }}>{data.propertyAddress}</Text>, reconnais avoir reçu de{' '}\n          <Text style={{ fontWeight: 'bold' }}>{data.tenantName}</Text>, locataire dudit bien, la somme détaillée\n          ci-dessous au titre du loyer et des charges pour la période concernée.\n        </Text>\n\n        {/* Tableau */}\n        <View style={styles.table}>\n          <View style={styles.tableHeader}>\n            <Text style={[styles.col1, styles.tableHeaderText]}>Désignation</Text>\n            <Text style={[styles.col2, styles.tableHeaderText]}>Période</Text>\n            <Text style={[styles.col3, styles.tableHeaderText]}>Montant</Text>\n          </View>\n          <View style={styles.tableRow}>\n            <Text style={styles.col1}>Loyer et charges</Text>\n            <Text style={styles.col2}>Du {data.periodStart} au {data.periodEnd}</Text>\n            <Text style={styles.col3}>{formatAmount(data.amount)} FCFA</Text>\n          </View>\n          <View style={styles.tableTotalRow}>\n            <Text style={[styles.col1, { fontWeight: 'bold' }]}>TOTAL ACQUITTÉ</Text>\n            <Text style={styles.col2}></Text>\n            <Text style={[styles.col3, { fontWeight: 'bold', fontSize: 12 }]}>\n              {formatAmount(data.amount)} FCFA\n            </Text>\n          </View>\n        </View>\n\n        {/* Signature */}\n        <View style={styles.signatureBlock}>\n          <Text style={styles.signatureLabel}>Le Bailleur (Signature)</Text>\n          {data.ownerSignature ? (\n            <Image src={data.ownerSignature} style={styles.signature} />\n          ) : (\n            <Text style={styles.signaturePlaceholder}>(Signé électroniquement)</Text>\n          )}\n        </View>\n\n        {/* Footer */}\n        <Text style={styles.footer}>\n          Document généré automatiquement par Dousell Immo pour {data.ownerName}.{'\\n'}\n          Pour faire valoir ce que de droit.\n        </Text>\n      </Page>\n    </Document>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pdf\\QuittancePDF_v2.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":201,"column":15,"nodeType":"JSXOpeningElement","endLine":201,"endColumn":65},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":293,"column":13,"nodeType":"JSXOpeningElement","endLine":293,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';\n\n// Types\ninterface QuittanceData {\n  tenantName: string;\n  tenantEmail?: string;\n  tenantPhone?: string;\n  tenantAddress?: string;\n  amount: number;\n  periodMonth: string;\n  periodStart: string;\n  periodEnd: string;\n  receiptNumber: string;\n  ownerName: string;\n  ownerAddress: string;\n  ownerNinea?: string;\n  ownerLogo?: string;\n  ownerSignature?: string;\n  propertyAddress: string;\n}\n\n// Styles compacts pour tenir sur une page\nconst styles = StyleSheet.create({\n  page: {\n    padding: 25,\n    fontSize: 9,\n    fontFamily: 'Helvetica',\n    lineHeight: 1.3,\n  },\n  header: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 10,\n    paddingBottom: 8,\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n  },\n  logo: {\n    width: 70,\n    height: 45,\n    objectFit: 'contain',\n  },\n  headerRight: {\n    textAlign: 'right',\n  },\n  companyName: {\n    fontSize: 13,\n    fontWeight: 'bold',\n    marginBottom: 3,\n  },\n  companyInfo: {\n    fontSize: 7,\n    color: '#666',\n  },\n  title: {\n    fontSize: 14,\n    fontWeight: 'bold',\n    textAlign: 'center',\n    marginBottom: 8,\n    textTransform: 'uppercase',\n    letterSpacing: 1.2,\n    backgroundColor: '#f9f9f9',\n    padding: 6,\n    border: '1px solid #eee',\n  },\n  infoBlock: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 8,\n  },\n  box: {\n    width: '48%',\n    padding: 8,\n    border: '1px solid #ddd',\n    borderRadius: 4,\n  },\n  boxHighlight: {\n    width: '48%',\n    padding: 8,\n    borderWidth: 1,\n    borderColor: '#F4C430',\n    borderRadius: 4,\n    backgroundColor: '#fffdf5',\n  },\n  boxTitle: {\n    fontSize: 7,\n    color: '#999',\n    textTransform: 'uppercase',\n    marginBottom: 5,\n    fontWeight: 'bold',\n  },\n  boxName: {\n    fontSize: 10,\n    fontWeight: 'bold',\n    marginBottom: 3,\n  },\n  boxText: {\n    fontSize: 8,\n    color: '#555',\n    marginBottom: 2,\n  },\n  propertyInfo: {\n    backgroundColor: '#f5f5f5',\n    padding: 6,\n    borderRadius: 4,\n    marginBottom: 8,\n    fontSize: 8,\n  },\n  legalText: {\n    fontSize: 8,\n    lineHeight: 1.4,\n    marginBottom: 10,\n    textAlign: 'justify',\n  },\n  table: {\n    marginTop: 8,\n    marginBottom: 10,\n  },\n  tableHeader: {\n    flexDirection: 'row',\n    backgroundColor: '#f9f9f9',\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n    paddingVertical: 5,\n    paddingHorizontal: 8,\n  },\n  tableRow: {\n    flexDirection: 'row',\n    borderBottomWidth: 1,\n    borderBottomColor: '#eee',\n    paddingVertical: 6,\n    paddingHorizontal: 8,\n  },\n  tableTotalRow: {\n    flexDirection: 'row',\n    backgroundColor: '#FFF8E1',\n    paddingVertical: 6,\n    paddingHorizontal: 8,\n    fontWeight: 'bold',\n  },\n  col1: { width: '40%', fontSize: 8 },\n  col2: { width: '30%', fontSize: 8, textAlign: 'right' },\n  col3: { width: '30%', fontSize: 8, textAlign: 'right' },\n  tableHeaderText: {\n    fontSize: 7,\n    color: '#666',\n    fontWeight: 'bold',\n    textTransform: 'uppercase',\n  },\n  signatureBlock: {\n    marginTop: 12,\n    alignItems: 'flex-end',\n  },\n  signatureLabel: {\n    fontSize: 8,\n    fontWeight: 'bold',\n    marginBottom: 5,\n  },\n  signature: {\n    width: 90,\n    height: 40,\n    objectFit: 'contain',\n  },\n  signaturePlaceholder: {\n    fontSize: 7,\n    color: '#ccc',\n    fontStyle: 'italic',\n    marginTop: 5,\n  },\n  footer: {\n    position: 'absolute',\n    bottom: 20,\n    left: 25,\n    right: 25,\n    textAlign: 'center',\n    fontSize: 6,\n    color: '#999',\n    borderTopWidth: 1,\n    borderTopColor: '#eee',\n    paddingTop: 10,\n  },\n});\n\n// Helper pour formater les montants\nconst formatAmount = (amount: number) => {\n  return new Intl.NumberFormat('fr-FR').format(amount);\n};\n\n// Fonction pour générer le Document PDF\nexport const createQuittanceDocument = (data: QuittanceData) => {\n  const today = new Date().toLocaleDateString('fr-FR');\n\n  return (\n    <Document>\n      <Page size=\"A4\" style={styles.page}>\n        {/* En-tête */}\n        <View style={styles.header}>\n          <View>\n            {data.ownerLogo && (\n              <Image src={data.ownerLogo} style={styles.logo} />\n            )}\n            <Text style={styles.companyName}>{data.ownerName}</Text>\n            {data.ownerAddress && (\n              <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n            )}\n            {data.ownerNinea && (\n              <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>\n            )}\n          </View>\n          <View style={styles.headerRight}>\n            <Text style={styles.companyInfo}>Quittance N°</Text>\n            <Text style={{ fontSize: 11, fontWeight: 'bold', marginBottom: 3 }}>\n              {data.receiptNumber}\n            </Text>\n            <Text style={styles.companyInfo}>Date d&apos;émission</Text>\n            <Text style={{ fontSize: 9, fontWeight: 'bold' }}>{today}</Text>\n          </View>\n        </View>\n\n        {/* Titre */}\n        <Text style={styles.title}>QUITTANCE DE LOYER</Text>\n\n        {/* Blocs d'infos */}\n        <View style={styles.infoBlock}>\n          <View style={styles.box}>\n            <Text style={styles.boxTitle}>Bailleur / Mandataire</Text>\n            <Text style={styles.boxName}>{data.ownerName}</Text>\n            {data.ownerAddress && (\n              <Text style={styles.boxText}>{data.ownerAddress}</Text>\n            )}\n          </View>\n          <View style={styles.boxHighlight}>\n            <Text style={[styles.boxTitle, { color: '#B8860B' }]}>Locataire</Text>\n            <Text style={styles.boxName}>{data.tenantName}</Text>\n            {data.tenantAddress && data.tenantAddress !== 'Adresse non renseignée' && (\n              <Text style={styles.boxText}>{data.tenantAddress}</Text>\n            )}\n            {data.tenantEmail && (\n              <Text style={styles.boxText}>{data.tenantEmail}</Text>\n            )}\n            {data.tenantPhone && (\n              <Text style={styles.boxText}>{data.tenantPhone}</Text>\n            )}\n          </View>\n        </View>\n\n        {/* Adresse du bien - Seulement si renseignée */}\n        {data.propertyAddress && data.propertyAddress !== 'Adresse non renseignée' && (\n          <View style={styles.propertyInfo}>\n            <Text>\n              <Text style={{ fontWeight: 'bold' }}>Adresse du bien loué : </Text>\n              {data.propertyAddress}\n            </Text>\n          </View>\n        )}\n\n        {/* Texte légal */}\n        <Text style={styles.legalText}>\n          Je soussigné(e) <Text style={{ fontWeight: 'bold' }}>{data.ownerName}</Text>, propriétaire ou mandataire\n          {data.propertyAddress && data.propertyAddress !== 'Adresse non renseignée' ? (\n            <> du bien situé au <Text style={{ fontWeight: 'bold' }}>{data.propertyAddress}</Text></>\n          ) : ''}, reconnais avoir reçu de{' '}\n          <Text style={{ fontWeight: 'bold' }}>{data.tenantName}</Text>, locataire dudit bien, la somme détaillée\n          ci-dessous au titre du loyer et des charges pour la période concernée.\n        </Text>\n\n        {/* Tableau */}\n        <View style={styles.table}>\n          <View style={styles.tableHeader}>\n            <Text style={[styles.col1, styles.tableHeaderText]}>Désignation</Text>\n            <Text style={[styles.col2, styles.tableHeaderText]}>Période</Text>\n            <Text style={[styles.col3, styles.tableHeaderText]}>Montant</Text>\n          </View>\n          <View style={styles.tableRow}>\n            <Text style={styles.col1}>Loyer et charges</Text>\n            <Text style={styles.col2}>Du {data.periodStart} au {data.periodEnd}</Text>\n            <Text style={styles.col3}>{formatAmount(data.amount)} FCFA</Text>\n          </View>\n          <View style={styles.tableTotalRow}>\n            <Text style={[styles.col1, { fontWeight: 'bold' }]}>TOTAL ACQUITTÉ</Text>\n            <Text style={styles.col2}></Text>\n            <Text style={[styles.col3, { fontWeight: 'bold', fontSize: 10 }]}>\n              {formatAmount(data.amount)} FCFA\n            </Text>\n          </View>\n        </View>\n\n        {/* Signature */}\n        <View style={styles.signatureBlock}>\n          <Text style={styles.signatureLabel}>Le Bailleur (Signature)</Text>\n          {data.ownerSignature ? (\n            <Image src={data.ownerSignature} style={styles.signature} />\n          ) : (\n            <Text style={styles.signaturePlaceholder}>(Signé électroniquement)</Text>\n          )}\n        </View>\n\n        {/* Footer */}\n        <Text style={styles.footer}>\n          Document généré automatiquement par Dousell Immo pour {data.ownerName}.{'\\n'}\n          Pour faire valoir ce que de droit.\n        </Text>\n      </Page>\n    </Document>\n  );\n};\n\n// Export du type\nexport type { QuittanceData };\n\n// Composant React pour compatibilité\nexport const QuittancePDF: React.FC<{ data: QuittanceData }> = ({ data }) => {\n  return createQuittanceDocument(data);\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\agent-card.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used.","line":5,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AGENT1_INFO' is assigned a value but never used.","line":25,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Image from \"next/image\";\r\nimport { motion } from \"framer-motion\";\r\nimport { MessageCircle, Clock, Phone, User, BadgeCheck } from \"lucide-react\";\r\nimport { format } from \"date-fns\";\r\nimport { fr } from \"date-fns/locale\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\r\nimport { analyticsEvents } from \"@/lib/analytics\";\r\nimport { AGENCY_PHONE, AGENCY_PHONE_DISPLAY } from \"@/lib/constants\";\r\nimport type { Property } from \"@/types/property\";\r\n\r\ntype AgentCardProps = {\r\n  agent: Property[\"agent\"];\r\n  owner?: Property[\"owner\"];\r\n  property?: Property;\r\n  propertyId?: string;\r\n  propertyTitle?: string;\r\n};\r\n\r\n// Informations de l'agent Mohamadou Barry (agent1) - Côté technique\r\nconst AGENT1_INFO = {\r\n  name: \"Mohamadou Barry\",\r\n  photo: \"/agent1.png\",\r\n  description: \"Co-fondateur spécialisé dans l'aspect technique et technologique de l'immobilier. Expert en plateformes digitales et solutions innovantes pour faciliter vos transactions.\",\r\n  whatsappNumber: \"+330751081579\",\r\n  phoneNumber: \"+330751081579\",\r\n  responseTime: \"Répond dans l'heure\",\r\n};\r\n\r\n// Informations de l'agent Amadou Barry (agent2) - Côté terrain\r\nconst AGENT2_INFO = {\r\n  name: \"Amadou Barry\",\r\n  photo: \"/agent2.png\",\r\n  description: \"Co-fondateur et expert terrain, spécialisé dans les visites, l'accompagnement sur le terrain et la connaissance approfondie du marché dakarois. Votre contact privilégié pour toutes vos démarches immobilières.\",\r\n  whatsappNumber: \"+221781385281\",\r\n  phoneNumber: \"+221781385281\",\r\n  responseTime: \"Répond dans l'heure\",\r\n};\r\n\r\n// Utiliser agent2 par défaut (public)\r\nconst AGENT_INFO = AGENT2_INFO;\r\n\r\n// Fonction pour obtenir les initiales d'un nom\r\nconst getInitials = (name: string): string => {\r\n  return name\r\n    .split(\" \")\r\n    .map((n) => n[0])\r\n    .join(\"\")\r\n    .toUpperCase()\r\n    .slice(0, 2);\r\n};\r\n\r\nexport const AgentCard = ({ agent, owner, property, propertyId, propertyTitle }: AgentCardProps) => {\r\n  // Si un propriétaire existe, afficher ses informations\r\n  const isOwner = !!owner && (owner.full_name || owner.phone);\r\n\r\n  // Informations à afficher\r\n  const displayName = isOwner\r\n    ? (owner.full_name || \"Propriétaire\")\r\n    : (agent?.name || AGENT_INFO.name);\r\n\r\n  const displayPhoto = isOwner && owner.avatar_url\r\n    ? owner.avatar_url\r\n    : (agent?.photo || AGENT_INFO.photo);\r\n\r\n  const displayDescription = isOwner\r\n    ? owner.role === \"agent\"\r\n      ? \"Agent immobilier professionnel\"\r\n      : \"Propriétaire particulier\"\r\n    : AGENT_INFO.description;\r\n\r\n  // Numéro de téléphone : propriétaire, agent par défaut, ou agence (fallback)\r\n  const phoneNumber = owner?.phone || property?.owner?.phone || AGENT_INFO.phoneNumber || AGENCY_PHONE;\r\n  const phoneNumberDisplay = owner?.phone || property?.owner?.phone || AGENT_INFO.phoneNumber || AGENCY_PHONE_DISPLAY;\r\n  const phoneLink = `tel:${phoneNumber}`;\r\n\r\n  // WhatsApp : utiliser le numéro du propriétaire ou de l'agent\r\n  const whatsappNumber = owner?.phone || property?.owner?.phone || AGENT_INFO.whatsappNumber;\r\n  const whatsappLink = `https://wa.me/${whatsappNumber.replace(/[^0-9]/g, \"\")}`;\r\n\r\n  // Date de création du profil\r\n  const memberSince = owner?.updated_at\r\n    ? format(new Date(owner.updated_at), \"MMMM yyyy\", { locale: fr })\r\n    : null;\r\n\r\n  // Handler pour le tracking des appels\r\n  const handlePhoneClick = () => {\r\n    if (propertyId && propertyTitle) {\r\n      analyticsEvents.contactCall(propertyId, propertyTitle);\r\n    }\r\n  };\r\n\r\n  // Handler pour le tracking WhatsApp\r\n  const handleWhatsAppClick = () => {\r\n    if (propertyId && propertyTitle) {\r\n      analyticsEvents.contactWhatsApp(propertyId, propertyTitle);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <motion.div\r\n      initial={{ opacity: 0, y: 20 }}\r\n      whileInView={{ opacity: 1, y: 0 }}\r\n      viewport={{ once: true, amount: 0.5 }}\r\n      className=\"space-y-4 rounded-3xl border border-gray-100 bg-gray-50 p-6 dark:border-white/10 dark:bg-white/5\"\r\n    >\r\n      <div className=\"flex items-start gap-4\">\r\n        <div className=\"relative h-20 w-20 shrink-0 overflow-hidden rounded-full bg-gray-200 dark:bg-white/10\">\r\n          {displayPhoto ? (\r\n            <Image\r\n              src={displayPhoto}\r\n              alt={displayName}\r\n              fill\r\n              className=\"object-cover object-[center_top]\"\r\n              quality={85}\r\n              sizes=\"80px\"\r\n            />\r\n          ) : (\r\n            <div className=\"flex h-full w-full items-center justify-center text-2xl font-semibold text-gray-600 dark:text-white/70\">\r\n              {getInitials(displayName)}\r\n            </div>\r\n          )}\r\n        </div>\r\n        <div className=\"flex flex-1 flex-col gap-2\">\r\n          <div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <h3 className=\"text-xl font-semibold text-gray-900 dark:text-white\">\r\n                {displayName}\r\n              </h3>\r\n              {owner?.is_identity_verified && (\r\n                <BadgeCheck className=\"h-5 w-5 text-amber-400\" />\r\n              )}\r\n            </div>\r\n            {owner && (\r\n              <div className=\"mt-1 flex items-center gap-2\">\r\n                <Badge\r\n                  variant={owner.role === \"agent\" ? \"default\" : \"secondary\"}\r\n                  className=\"text-xs\"\r\n                >\r\n                  {owner.role === \"agent\" ? \"Agent Pro\" : \"Particulier\"}\r\n                </Badge>\r\n              </div>\r\n            )}\r\n            <p className=\"mt-2 text-sm leading-relaxed text-gray-600 dark:text-white/70\">\r\n              {displayDescription}\r\n            </p>\r\n          </div>\r\n          {memberSince && (\r\n            <div className=\"flex items-center gap-2 text-xs text-gray-500 dark:text-white/50\">\r\n              <Clock className=\"h-3.5 w-3.5\" />\r\n              <span>Membre depuis {memberSince}</span>\r\n            </div>\r\n          )}\r\n          {!memberSince && !isOwner && (\r\n            <div className=\"flex items-center gap-2 text-xs text-gray-500 dark:text-white/50\">\r\n              <Clock className=\"h-3.5 w-3.5\" />\r\n              <span>{AGENT_INFO.responseTime}</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n      <div className=\"flex gap-3\">\r\n        <TooltipProvider>\r\n          <Tooltip>\r\n            <TooltipTrigger asChild>\r\n              <Button\r\n                asChild\r\n                variant=\"outline\"\r\n                className=\"flex-1 rounded-2xl border-gray-200 text-sm font-semibold text-gray-900 hover:bg-gray-100 dark:border-white/20 dark:text-white dark:hover:bg-white/10\"\r\n                onClick={handlePhoneClick}\r\n                data-property-id={propertyId}\r\n                data-property-title={propertyTitle}\r\n                data-category=\"contact\"\r\n                data-label=\"Phone\"\r\n              >\r\n                <a\r\n                  href={phoneLink}\r\n                  className=\"flex items-center justify-center gap-2\"\r\n                >\r\n                  <Phone className=\"h-4 w-4\" />\r\n                  Appeler\r\n                </a>\r\n              </Button>\r\n            </TooltipTrigger>\r\n            <TooltipContent>\r\n              <p>{phoneNumberDisplay}</p>\r\n            </TooltipContent>\r\n          </Tooltip>\r\n        </TooltipProvider>\r\n        <Button\r\n          asChild\r\n          className=\"flex-1 rounded-2xl bg-[#25D366] text-sm font-semibold text-white hover:bg-[#20BD5A] dark:bg-[#25D366] dark:hover:bg-[#20BD5A]\"\r\n          onClick={handleWhatsAppClick}\r\n          data-property-id={propertyId}\r\n          data-property-title={propertyTitle}\r\n          data-category=\"contact\"\r\n          data-label=\"WhatsApp\"\r\n        >\r\n          <a\r\n            href={whatsappLink}\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            className=\"flex items-center justify-center gap-2\"\r\n          >\r\n            <MessageCircle className=\"h-4 w-4\" />\r\n            WhatsApp\r\n          </a>\r\n        </Button>\r\n      </div>\r\n    </motion.div>\r\n  );\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\booking-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\contact-bar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\cost-simulator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\gallery-grid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\listing-image-carousel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-card.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":16,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport type { MouseEvent } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Bookmark, Bed, Bath, Square, MapPin } from \"lucide-react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { VerifiedBadge } from \"@/components/ui/verified-badge\";\r\nimport { ListingImageCarousel } from \"@/components/property/listing-image-carousel\";\r\nimport { cn, formatCurrency } from \"@/lib/utils\";\r\nimport { hapticFeedback } from \"@/lib/haptic\";\r\nimport { useFavoritesStore } from \"@/store/use-store\";\r\nimport type { Property } from \"@/types/property\";\r\nimport Link from \"next/link\";\r\n\r\ntype PropertyCardProps = {\r\n  property: Property;\r\n  className?: string;\r\n  variant?: \"vertical\" | \"horizontal\";\r\n};\r\n\r\nexport const PropertyCard = ({\r\n  property,\r\n  className,\r\n  variant = \"vertical\",\r\n}: PropertyCardProps) => {\r\n  const router = useRouter();\r\n  const { addFavorite, removeFavorite, isFavorite } = useFavoritesStore();\r\n  const favorite = isFavorite(property.id);\r\n\r\n  const toggleFavorite = (event: MouseEvent) => {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    hapticFeedback.light();\r\n    if (favorite) {\r\n      removeFavorite(property.id);\r\n      toast.success(\"Retiré des favoris\", { description: property.title });\r\n    } else {\r\n      addFavorite(property);\r\n      hapticFeedback.success();\r\n      toast.success(\"Ajouté aux favoris ✨\", { description: property.title });\r\n    }\r\n  };\r\n\r\n  const handleCardClick = (event: MouseEvent) => {\r\n    // Ne pas naviguer si le clic vient du carousel, du bouton favori, ou d'un lien externe\r\n    const target = event.target as HTMLElement;\r\n    if (\r\n      target.closest('[data-carousel]') ||\r\n      target.closest('button[aria-label=\"Enregistrer\"]') ||\r\n      (target.closest('a') && !target.closest('a[href^=\"/biens/\"]'))\r\n    ) {\r\n      return;\r\n    }\r\n    // Permettre la navigation même si on clique sur le bouton \"Découvrir\"\r\n    router.push(`/biens/${property.id}`);\r\n  };\r\n\r\n  if (variant === \"horizontal\") {\r\n    return (\r\n      <motion.article\r\n        layout\r\n        whileHover={{ scale: 1.01 }}\r\n        whileTap={{ scale: 0.99 }}\r\n        transition={{\r\n          type: \"spring\",\r\n          stiffness: 400,\r\n          damping: 20,\r\n        }}\r\n        className={cn(\r\n          \"group relative flex min-w-[280px] items-center gap-4 rounded-[24px] border border-white/10 bg-background p-3 text-white transition-all hover:shadow-lg hover:shadow-primary/10 hover:border-primary/30 isolate\",\r\n          className\r\n        )}\r\n      >\r\n        <div\r\n          className=\"absolute inset-0 z-10 cursor-pointer\"\r\n          onClick={handleCardClick}\r\n          aria-label={`Voir ${property.title}`}\r\n          role=\"button\"\r\n          tabIndex={0}\r\n          onKeyDown={(e) => {\r\n            if (e.key === 'Enter' || e.key === ' ') {\r\n              e.preventDefault();\r\n              router.push(`/biens/${property.id}`);\r\n            }\r\n          }}\r\n        />\r\n        <div className=\"relative h-24 w-24 overflow-hidden rounded-2xl z-20\" data-carousel style={{ pointerEvents: 'auto' }}>\r\n          <ListingImageCarousel\r\n            images={property.images}\r\n            alt={property.title}\r\n            className=\"h-full w-full\"\r\n          />\r\n          <div className=\"absolute bottom-2 left-2 rounded-full bg-black/70 px-2 py-0.5 text-[10px] font-semibold\">\r\n            {formatCurrency(property.price)}\r\n          </div>\r\n        </div>\r\n        <div className=\"relative z-20 flex flex-1 min-w-0 flex-col gap-1\">\r\n          <p className=\"flex items-center gap-1 text-[11px] text-white/60 truncate\">\r\n            <MapPin className=\"h-3 w-3 flex-shrink-0\" />\r\n            <span className=\"truncate\">{property.location.city}</span>\r\n          </p>\r\n          <h3 className=\"truncate text-sm font-semibold flex items-center gap-2\" title={property.title}>\r\n            {property.title}\r\n            {property.verification_status === \"verified\" && (\r\n              <VerifiedBadge variant=\"icon\" size=\"sm\" showTooltip={false} />\r\n            )}\r\n          </h3>\r\n          <p className=\"truncate text-[11px] text-white/50\" title={property.location.landmark}>\r\n            {property.location.landmark}\r\n          </p>\r\n          <div className=\"flex items-center gap-3 text-[11px] text-white/70\">\r\n            <span className=\"inline-flex items-center gap-1\">\r\n              <Bed className=\"h-3.5 w-3.5\" />\r\n              {property.specs.bedrooms} ch\r\n            </span>\r\n            <span className=\"inline-flex items-center gap-1\">\r\n              <Square className=\"h-3.5 w-3.5\" />\r\n              {property.specs.surface} m²\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </motion.article>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <motion.article\r\n      layout\r\n      whileHover={{ y: -6, scale: 1.01 }}\r\n      whileTap={{ scale: 0.99 }}\r\n      transition={{\r\n        type: \"spring\",\r\n        stiffness: 300,\r\n        damping: 20,\r\n      }}\r\n      className={cn(\r\n        // Mobile: largeur fixe pour scroll horizontal\r\n        \"group relative flex w-72 flex-none flex-col overflow-hidden rounded-[28px] bg-background border border-white/10 p-3 text-white transition-all hover:shadow-xl hover:shadow-primary/10 hover:border-primary/30 isolate\",\r\n        // Desktop: dans une grille, la largeur est gérée par la grille CSS automatiquement\r\n        className\r\n      )}\r\n    >\r\n      <div\r\n        className=\"relative aspect-[4/3] w-full overflow-hidden rounded-[24px] z-10\"\r\n        data-carousel\r\n        style={{ pointerEvents: 'auto' }}\r\n        onClick={(e) => {\r\n          // Empêcher la propagation du clic vers le div cliquable de la carte\r\n          e.stopPropagation();\r\n        }}\r\n      >\r\n        <ListingImageCarousel\r\n          images={property.images}\r\n          alt={property.title}\r\n          className=\"h-full w-full\"\r\n        />\r\n        <div className=\"absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent\" />\r\n        <div className=\"absolute left-4 top-4 flex flex-wrap items-center gap-2\">\r\n          {property.verification_status === \"verified\" && (\r\n            <VerifiedBadge variant=\"pill\" className=\"shadow-lg\" />\r\n          )}\r\n          {property.featured && (\r\n            <span className=\"rounded-full bg-primary px-3 py-1 text-xs font-bold text-black shadow-lg\">\r\n              Sponsorisé\r\n            </span>\r\n          )}\r\n          {property.exclusive && (\r\n            <span className=\"rounded-full bg-black border-2 border-primary px-3 py-1 text-xs font-semibold text-primary\">\r\n              Exclusivité\r\n            </span>\r\n          )}\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          aria-label=\"Enregistrer\"\r\n          onClick={toggleFavorite}\r\n          className={`absolute right-4 top-4 z-20 inline-flex h-10 w-10 items-center justify-center rounded-full bg-black/40 text-white transition hover:bg-black/80 ${favorite ? \"text-amber-300\" : \"\"\r\n            }`}\r\n          style={{ pointerEvents: 'auto' }}\r\n        >\r\n          <Bookmark className={`h-5 w-5 ${favorite ? \"fill-current\" : \"\"}`} />\r\n        </button>\r\n        <div className=\"absolute bottom-4 left-4 rounded-full bg-black/80 backdrop-blur-sm px-4 py-2 border border-primary/30\">\r\n          <p className=\"text-sm font-bold text-primary\">{formatCurrency(property.price)}</p>\r\n        </div>\r\n      </div>\r\n      <div className=\"relative z-20 space-y-3 px-1 pb-1 pt-4 pointer-events-none\">\r\n        <div>\r\n          <p className=\"flex items-center gap-1.5 text-xs text-white/60 mb-1\">\r\n            <MapPin className=\"h-3.5 w-3.5 text-primary\" />\r\n            {property.location.city}\r\n          </p>\r\n          <h3 className=\"line-clamp-2 text-lg font-bold tracking-tight leading-tight mb-1\">\r\n            {property.title}\r\n          </h3>\r\n          <p className=\"text-xs text-white/50 line-clamp-1\">{property.location.landmark}</p>\r\n        </div>\r\n        <div className=\"flex items-center gap-4 text-xs text-white/70\">\r\n          <span className=\"inline-flex items-center gap-1.5\">\r\n            <Bed className=\"h-4 w-4 text-primary/80\" />\r\n            <span className=\"font-medium\">{property.specs.bedrooms}</span>\r\n          </span>\r\n          <span className=\"inline-flex items-center gap-1.5\">\r\n            <Bath className=\"h-4 w-4 text-primary/80\" />\r\n            <span className=\"font-medium\">{property.specs.bathrooms}</span>\r\n          </span>\r\n          <span className=\"inline-flex items-center gap-1.5\">\r\n            <Square className=\"h-4 w-4 text-primary/80\" />\r\n            <span className=\"font-medium\">{property.specs.surface}m²</span>\r\n          </span>\r\n        </div>\r\n        <div className=\"flex flex-wrap gap-2 text-[11px] text-white/60\">\r\n          <span className=\"rounded-full border border-white/10 bg-background px-3 py-1\">\r\n            {property.details.type}\r\n          </span>\r\n          {property.specs.dpe && (\r\n            <span className=\"rounded-full border border-white/10 bg-background px-3 py-1\">\r\n              DPE {property.specs.dpe}\r\n            </span>\r\n          )}\r\n        </div>\r\n        <div className=\"pt-2 pointer-events-auto\">\r\n          <Button\r\n            variant=\"secondary\"\r\n            className=\"w-full justify-between rounded-2xl bg-primary text-black hover:bg-primary/90 font-semibold transition-all hover:-translate-y-0.5 hover:shadow-lg hover:shadow-primary/20\"\r\n            onClick={(e) => {\r\n              e.stopPropagation();\r\n              router.push(`/biens/${property.id}`);\r\n            }}\r\n          >\r\n            Découvrir\r\n            <span aria-hidden>→</span>\r\n          </Button>\r\n        </div>\r\n      </div>\r\n      {/* Zone cliquable uniquement sur la partie inférieure (sous le carousel) */}\r\n      <div\r\n        className=\"absolute bottom-0 left-0 right-0 z-5 cursor-pointer\"\r\n        style={{\r\n          top: 'calc(100% * 0.65)', // Après le carousel (aspect 4/3 + padding ≈ 65% de la hauteur)\r\n          pointerEvents: 'auto'\r\n        }}\r\n        onClick={handleCardClick}\r\n        aria-label={`Voir ${property.title}`}\r\n        role=\"button\"\r\n        tabIndex={0}\r\n        onKeyDown={(e) => {\r\n          if (e.key === 'Enter' || e.key === ' ') {\r\n            e.preventDefault();\r\n            router.push(`/biens/${property.id}`);\r\n          }\r\n        }}\r\n      />\r\n    </motion.article>\r\n  );\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-detail-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isPaidService' is assigned a value but never used.","line":292,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":292,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useMemo, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { toast } from \"sonner\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  ArrowLeft,\r\n  Heart,\r\n  BatteryCharging,\r\n  Droplets,\r\n  Shield,\r\n  BadgeCheck,\r\n  Wifi,\r\n  Wind,\r\n  Car,\r\n  MapPin,\r\n  Star,\r\n  Home,\r\n  Bed,\r\n  Bath,\r\n  LayoutGrid,\r\n} from \"lucide-react\";\r\nimport Image from \"next/image\";\r\n\r\nimport { GalleryGrid } from \"@/components/property/gallery-grid\";\r\nimport { BookingCard } from \"@/components/property/booking-card\";\r\nimport { ShareButton } from \"@/components/property/share-button\";\r\nimport { ContactBar } from \"@/components/property/contact-bar\";\r\nimport { StaticMap } from \"@/components/property/static-map\";\r\nimport { SimilarProperties } from \"@/components/property/similar-properties\";\r\nimport { ReviewForm } from \"@/components/property/review-form\";\r\nimport { ReviewItem } from \"@/components/property/review-item\";\r\nimport { AgentCard } from \"@/components/property/agent-card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Breadcrumbs } from \"@/components/ui/breadcrumbs\";\r\nimport { useFavoritesStore } from \"@/store/use-store\";\r\nimport { formatCurrency } from \"@/lib/utils\";\r\nimport { incrementView } from \"@/services/propertyService\";\r\nimport type { Property } from \"@/types/property\";\r\nimport type { Review, ReviewStats } from \"@/services/reviewService\";\r\n\r\ntype PropertyDetailViewProps = {\r\n  property: Property;\r\n  similar: Property[];\r\n  shareUrl: string;\r\n  reviews?: Review[];\r\n  reviewStats?: ReviewStats;\r\n};\r\n\r\nexport const PropertyDetailView = ({\r\n  property,\r\n  similar,\r\n  shareUrl,\r\n  reviews = [],\r\n  reviewStats,\r\n}: PropertyDetailViewProps) => {\r\n  const router = useRouter();\r\n  const { addFavorite, removeFavorite, isFavorite } = useFavoritesStore();\r\n  const favorite = isFavorite(property.id);\r\n\r\n  // Tracker la vue de la page (compteur incrémental optimisé)\r\n  useEffect(() => {\r\n    void incrementView(property.id);\r\n  }, [property.id]);\r\n\r\n  const breadcrumbItems = useMemo(() => {\r\n    const transaction = property.transaction ?? \"vente\";\r\n    const categoryLabel = transaction === \"location\" ? \"Louer\" : \"Acheter\";\r\n    const city = property.location.city || \"Dakar\";\r\n\r\n    return [\r\n      { label: \"Accueil\", href: \"/\" },\r\n      {\r\n        label: categoryLabel,\r\n        href: `/recherche?category=${encodeURIComponent(transaction)}`,\r\n      },\r\n      {\r\n        label: city,\r\n        href: `/recherche?city=${encodeURIComponent(city)}`,\r\n      },\r\n      { label: property.title },\r\n    ];\r\n  }, [property]);\r\n\r\n  const toggleFavorite = () => {\r\n    if (favorite) {\r\n      removeFavorite(property.id);\r\n      toast.success(\"Retiré des favoris\", { description: property.title });\r\n    } else {\r\n      addFavorite(property);\r\n      toast.success(\"Ajouté aux favoris ✨\", { description: property.title });\r\n    }\r\n  };\r\n\r\n  const highlights = [\r\n    {\r\n      icon: BatteryCharging,\r\n      title: \"Groupe Électrogène\",\r\n      subtitle: \"Couverture totale\",\r\n      active: property.details.hasBackupGenerator,\r\n    },\r\n    {\r\n      icon: Droplets,\r\n      title: \"Réservoir d'eau\",\r\n      subtitle: \"Surpresseur inclus\",\r\n      active: property.details.hasWaterTank,\r\n    },\r\n    {\r\n      icon: Shield,\r\n      title: \"Sécurité 24/7\",\r\n      subtitle: \"Gardiennage\",\r\n      active: property.details.security,\r\n    },\r\n  ].filter((h) => h.active);\r\n\r\n  const amenities = [\r\n    { icon: Wifi, label: \"Wi-Fi\", active: true },\r\n    { icon: Wind, label: \"Climatisation\", active: true },\r\n    { icon: Car, label: \"Parking\", active: !!property.details.parking },\r\n    {\r\n      icon: BatteryCharging,\r\n      label: \"Groupe électrogène\",\r\n      active: property.details.hasBackupGenerator,\r\n    },\r\n    {\r\n      icon: Droplets,\r\n      label: \"Réservoir d'eau\",\r\n      active: property.details.hasWaterTank,\r\n    },\r\n    { icon: Shield, label: \"Sécurité\", active: property.details.security },\r\n  ].filter((a) => a.active);\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-white pb-32 text-gray-900 dark:bg-[#05080c] dark:text-white md:pb-40\">\r\n      {/* Mobile: Gallery avec overlay */}\r\n      <div className=\"relative md:hidden\">\r\n        <GalleryGrid\r\n          propertyId={property.id}\r\n          title={property.title}\r\n          images={property.images}\r\n        />\r\n        <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-b from-black/40 via-transparent to-black/60\" />\r\n        <div className=\"absolute left-4 right-4 top-4 z-20 flex items-center justify-between\">\r\n          <Button\r\n            variant=\"secondary\"\r\n            size=\"icon\"\r\n            className=\"pointer-events-auto h-12 w-12 rounded-full bg-black/50 text-white backdrop-blur-md\"\r\n            onClick={() => router.back()}\r\n          >\r\n            <ArrowLeft className=\"h-5 w-5\" />\r\n          </Button>\r\n          <div className=\"flex gap-2\">\r\n            <motion.button\r\n              onClick={toggleFavorite}\r\n              className=\"inline-flex h-12 w-12 items-center justify-center rounded-full bg-black/50 text-white backdrop-blur-md\"\r\n              animate={{ scale: favorite ? [1, 1.2, 1] : 1 }}\r\n            >\r\n              <Heart className={`h-5 w-5 ${favorite ? \"fill-white\" : \"\"}`} />\r\n            </motion.button>\r\n            <ShareButton\r\n              property={property}\r\n              shareUrl={shareUrl}\r\n              variant=\"icon\"\r\n              className=\"h-12 w-12 rounded-full bg-black/50 text-white backdrop-blur-md hover:bg-black/70\"\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Desktop: Gallery sans overlay */}\r\n      <div className=\"hidden md:block\">\r\n        <div className=\"relative\">\r\n          <GalleryGrid\r\n            propertyId={property.id}\r\n            title={property.title}\r\n            images={property.images}\r\n          />\r\n          <div className=\"absolute left-6 right-6 top-6 z-20 flex items-center justify-between\">\r\n            <Button\r\n              variant=\"secondary\"\r\n              size=\"icon\"\r\n              className=\"h-12 w-12 rounded-full bg-white/90 text-gray-900 backdrop-blur-md hover:bg-white\"\r\n              onClick={() => router.back()}\r\n            >\r\n              <ArrowLeft className=\"h-5 w-5\" />\r\n            </Button>\r\n            <div className=\"flex gap-2\">\r\n              <motion.button\r\n                onClick={toggleFavorite}\r\n                className=\"inline-flex h-12 w-12 items-center justify-center rounded-full bg-white/90 text-gray-900 backdrop-blur-md hover:bg-white\"\r\n                animate={{ scale: favorite ? [1, 1.2, 1] : 1 }}\r\n              >\r\n                <Heart\r\n                  className={`h-5 w-5 ${favorite ? \"fill-red-500 text-red-500\" : \"\"}`}\r\n                />\r\n              </motion.button>\r\n              <ShareButton\r\n                property={property}\r\n                shareUrl={shareUrl}\r\n                variant=\"icon\"\r\n                className=\"h-12 w-12 rounded-full bg-white/90 text-gray-900 backdrop-blur-md hover:bg-white\"\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main Content */}\r\n      <div className=\"mx-auto max-w-7xl px-4 pt-8 md:px-6 lg:grid lg:grid-cols-3 lg:gap-12\">\r\n        {/* Colonne Gauche (Infos - span-2) */}\r\n        <div className=\"lg:col-span-2\">\r\n          {/* Header */}\r\n          <div className=\"mb-6 space-y-3\">\r\n            <Breadcrumbs items={breadcrumbItems} />\r\n            <div className=\"mb-2 flex items-center gap-3\">\r\n              <span className=\"rounded-full bg-amber-500/15 px-4 py-1 text-xs font-semibold uppercase tracking-wider text-amber-500\">\r\n                {property.details.type}\r\n              </span>\r\n              {property.status && (\r\n                <span className=\"rounded-full bg-emerald-500/15 px-4 py-1 text-xs font-semibold uppercase tracking-wider text-emerald-500\">\r\n                  {property.status}\r\n                </span>\r\n              )}\r\n            </div>\r\n            <h1 className=\"text-3xl font-semibold text-gray-900 dark:text-white md:text-4xl\">\r\n              {property.title}\r\n            </h1>\r\n            <div className=\"mt-3 space-y-1\">\r\n              <div className=\"flex items-center gap-2 text-gray-600 dark:text-white/60\">\r\n                <MapPin className=\"h-4 w-4\" />\r\n                <span>\r\n                  {property.location.address || property.location.city}\r\n                  {property.location.landmark && `, ${property.location.landmark}`}\r\n                </span>\r\n              </div>\r\n              {property.location.address && (\r\n                <p className=\"text-sm text-gray-500 dark:text-white/50\">\r\n                  {property.location.city}\r\n                </p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Spécifications principales */}\r\n          <div className=\"mb-6 grid grid-cols-2 gap-4 sm:grid-cols-4\">\r\n            <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-4 text-center dark:border-white/10 dark:bg-white/5\">\r\n              <div className=\"mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-white text-gray-900 dark:bg-white/10 dark:text-white\">\r\n                <Home className=\"h-5 w-5\" />\r\n              </div>\r\n              <p className=\"text-2xl font-bold text-gray-900 dark:text-white\">\r\n                {property.specs.surface}m²\r\n              </p>\r\n              <p className=\"text-xs text-gray-600 dark:text-white/60\">Surface</p>\r\n            </div>\r\n            <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-4 text-center dark:border-white/10 dark:bg-white/5\">\r\n              <div className=\"mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-white text-gray-900 dark:bg-white/10 dark:text-white\">\r\n                <LayoutGrid className=\"h-5 w-5\" />\r\n              </div>\r\n              <p className=\"text-2xl font-bold text-gray-900 dark:text-white\">\r\n                {property.specs.rooms}\r\n              </p>\r\n              <p className=\"text-xs text-gray-600 dark:text-white/60\">Pièces</p>\r\n            </div>\r\n            <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-4 text-center dark:border-white/10 dark:bg-white/5\">\r\n              <div className=\"mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-white text-gray-900 dark:bg-white/10 dark:text-white\">\r\n                <Bed className=\"h-5 w-5\" />\r\n              </div>\r\n              <p className=\"text-2xl font-bold text-gray-900 dark:text-white\">\r\n                {property.specs.bedrooms}\r\n              </p>\r\n              <p className=\"text-xs text-gray-600 dark:text-white/60\">Chambres</p>\r\n            </div>\r\n            <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-4 text-center dark:border-white/10 dark:bg-white/5\">\r\n              <div className=\"mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-white text-gray-900 dark:bg-white/10 dark:text-white\">\r\n                <Bath className=\"h-5 w-5\" />\r\n              </div>\r\n              <p className=\"text-2xl font-bold text-gray-900 dark:text-white\">\r\n                {property.specs.bathrooms}\r\n              </p>\r\n              <p className=\"text-xs text-gray-600 dark:text-white/60\">Salles d&apos;eau</p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Infos Agent (Hôte) */}\r\n          <div className=\"mb-8 flex items-center gap-4 border-b border-gray-200 pb-6 dark:border-white/10\">\r\n            {(() => {\r\n              // Logique d'affichage selon les règles métier :\r\n              // - Si on a les données du propriétaire (owner + téléphone) -> Afficher le propriétaire\r\n              // - Sinon -> Afficher l'agence par défaut\r\n\r\n              const isPaidService = property.service_type === \"boost_visibilite\";\r\n\r\n              // Données de l'agence (Agent 2 par défaut)\r\n              const agencyName = \"Agence Dousell\";\r\n              const agencyPhoto = \"/agent2.png\";\r\n              const agencyPhone = \"+221781385281\";\r\n\r\n              // Téléphone : contact_phone spécifique à l'annonce, sinon téléphone du profil\r\n              const ownerPhone = property.contact_phone || property.owner?.phone;\r\n\r\n              // Afficher le propriétaire si on a ses données ET un téléphone\r\n              // (même si service_type n'est pas défini)\r\n              const showOwner = property.owner && ownerPhone;\r\n\r\n              const displayName = showOwner && property.owner?.full_name\r\n                ? property.owner.full_name\r\n                : agencyName;\r\n              // Photo : Si propriétaire -> avatar du propriétaire (ou null pour initiales)\r\n              //         Sinon -> photo de l'agence\r\n              const displayPhoto = showOwner\r\n                ? property.owner?.avatar_url || null  // null déclenche l'affichage des initiales\r\n                : agencyPhoto;\r\n              const displayPhone = showOwner ? ownerPhone : agencyPhone;\r\n\r\n              return (\r\n                <>\r\n                  <div className=\"relative h-16 w-16 overflow-hidden rounded-full\">\r\n                    {displayPhoto ? (\r\n                      <Image\r\n                        src={displayPhoto}\r\n                        alt={displayName || \"Agent\"}\r\n                        fill\r\n                        className=\"object-cover\"\r\n                        sizes=\"64px\"\r\n                      />\r\n                    ) : (\r\n                      <div className=\"flex h-full w-full items-center justify-center bg-gray-200 text-xl font-bold text-gray-600 dark:bg-white/20 dark:text-white/80\">\r\n                        {(displayName || \"A\").charAt(0).toUpperCase()}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                  <div className=\"flex-1\">\r\n                    <p className=\"text-sm text-gray-600 dark:text-white/60\">\r\n                      Proposé par\r\n                    </p>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <p className=\"font-semibold text-gray-900 dark:text-white\">\r\n                        {displayName}\r\n                      </p>\r\n                      {showOwner && property.owner?.is_identity_verified && (\r\n                        <div className=\"flex items-center\" title=\"Identité vérifiée\">\r\n                          <BadgeCheck className=\"h-4 w-4 text-white fill-blue-500\" />\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    {displayPhone && (\r\n                      <p className=\"text-sm text-gray-500 dark:text-white/50\">\r\n                        {displayPhone}\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                </>\r\n              );\r\n            })()}\r\n          </div>\r\n\r\n          {/* Highlights (Dakar Specs) */}\r\n          {highlights.length > 0 && (\r\n            <div className=\"mb-8 grid gap-4 sm:grid-cols-3\">\r\n              {highlights.map((highlight, index) => {\r\n                const Icon = highlight.icon;\r\n                return (\r\n                  <div key={index} className=\"flex items-center gap-3\">\r\n                    <div className=\"flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-gray-100 dark:bg-white/10\">\r\n                      <Icon className=\"h-6 w-6 text-gray-700 dark:text-white\" />\r\n                    </div>\r\n                    <div>\r\n                      <p className=\"font-semibold text-gray-900 dark:text-white\">\r\n                        {highlight.title}\r\n                      </p>\r\n                      <p className=\"text-sm text-gray-600 dark:text-white/60\">\r\n                        {highlight.subtitle}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n\r\n          {/* Description */}\r\n          <div className=\"mb-8\">\r\n            <h2 className=\"mb-3 text-xl font-semibold text-gray-900 dark:text-white\">\r\n              À propos de ce logement\r\n            </h2>\r\n            <p className=\"text-gray-700 dark:text-white/80 leading-relaxed\">\r\n              {property.description}\r\n            </p>\r\n          </div>\r\n\r\n          {/* Détails techniques */}\r\n          {(property.details.year || property.details.heating || property.details.charges || property.details.parking) && (\r\n            <div className=\"mb-8 rounded-xl border border-gray-200 bg-gray-50 p-6 dark:border-white/10 dark:bg-white/5\">\r\n              <h2 className=\"mb-4 text-xl font-semibold text-gray-900 dark:text-white\">\r\n                Détails techniques\r\n              </h2>\r\n              <dl className=\"grid gap-4 sm:grid-cols-2\">\r\n                {property.details.year && (\r\n                  <div>\r\n                    <dt className=\"text-xs uppercase tracking-widest text-gray-400 dark:text-white/50\">\r\n                      Année de construction\r\n                    </dt>\r\n                    <dd className=\"mt-1 text-sm font-semibold text-gray-900 dark:text-white\">\r\n                      {property.details.year}\r\n                    </dd>\r\n                  </div>\r\n                )}\r\n                {property.details.heating && (\r\n                  <div>\r\n                    <dt className=\"text-xs uppercase tracking-widest text-gray-400 dark:text-white/50\">\r\n                      Chauffage / Climatisation\r\n                    </dt>\r\n                    <dd className=\"mt-1 text-sm font-semibold text-gray-900 dark:text-white\">\r\n                      {property.details.heating}\r\n                    </dd>\r\n                  </div>\r\n                )}\r\n                {property.details.charges && (\r\n                  <div>\r\n                    <dt className=\"text-xs uppercase tracking-widest text-gray-400 dark:text-white/50\">\r\n                      Charges mensuelles\r\n                    </dt>\r\n                    <dd className=\"mt-1 text-sm font-semibold text-gray-900 dark:text-white\">\r\n                      {formatCurrency(property.details.charges)}\r\n                    </dd>\r\n                  </div>\r\n                )}\r\n                {property.details.taxeFonciere && (\r\n                  <div>\r\n                    <dt className=\"text-xs uppercase tracking-widest text-gray-400 dark:text-white/50\">\r\n                      Taxe foncière annuelle\r\n                    </dt>\r\n                    <dd className=\"mt-1 text-sm font-semibold text-gray-900 dark:text-white\">\r\n                      {formatCurrency(property.details.taxeFonciere)}\r\n                    </dd>\r\n                  </div>\r\n                )}\r\n                {property.details.parking && (\r\n                  <div>\r\n                    <dt className=\"text-xs uppercase tracking-widest text-gray-400 dark:text-white/50\">\r\n                      Parking\r\n                    </dt>\r\n                    <dd className=\"mt-1 text-sm font-semibold text-gray-900 dark:text-white\">\r\n                      {property.details.parking}\r\n                    </dd>\r\n                  </div>\r\n                )}\r\n                <div>\r\n                  <dt className=\"text-xs uppercase tracking-widest text-gray-400 dark:text-white/50\">\r\n                    Performance énergétique\r\n                  </dt>\r\n                  <dd className=\"mt-1\">\r\n                    <span className={`inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${property.specs.dpe === \"A\" ? \"bg-green-500/20 text-green-500\" :\r\n                      property.specs.dpe === \"B\" ? \"bg-blue-500/20 text-blue-500\" :\r\n                        property.specs.dpe === \"C\" ? \"bg-yellow-500/20 text-yellow-500\" :\r\n                          property.specs.dpe === \"D\" ? \"bg-orange-500/20 text-orange-500\" :\r\n                            \"bg-red-500/20 text-red-500\"\r\n                      }`}>\r\n                      DPE {property.specs.dpe}\r\n                    </span>\r\n                  </dd>\r\n                </div>\r\n              </dl>\r\n            </div>\r\n          )}\r\n\r\n          {/* Équipements */}\r\n          <div className=\"mb-8\">\r\n            <h2 className=\"mb-4 text-xl font-semibold text-gray-900 dark:text-white\">\r\n              Ce que propose ce logement\r\n            </h2>\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              {amenities.map((amenity, index) => {\r\n                const Icon = amenity.icon;\r\n                return (\r\n                  <div key={index} className=\"flex items-center gap-3\">\r\n                    <Icon className=\"h-5 w-5 text-gray-600 dark:text-white/60\" />\r\n                    <span className=\"text-sm text-gray-700 dark:text-white/80\">\r\n                      {amenity.label}\r\n                    </span>\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Disponibilité */}\r\n          <div className=\"mb-8\">\r\n            <h2 className=\"mb-2 text-xl font-semibold text-gray-900 dark:text-white\">\r\n              Disponibilité\r\n            </h2>\r\n            <p className=\"text-gray-700 dark:text-white/80\">\r\n              {property.disponibilite || \"Disponible immédiatement\"}\r\n            </p>\r\n          </div>\r\n\r\n          {/* Proximités */}\r\n          {property.proximites && (\r\n            <div className=\"mb-8\">\r\n              <h2 className=\"mb-4 text-xl font-semibold text-gray-900 dark:text-white\">\r\n                À proximité\r\n              </h2>\r\n              <div className=\"grid gap-4 md:grid-cols-3\">\r\n                {property.proximites.transports && property.proximites.transports.length > 0 && (\r\n                  <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-4 dark:border-white/10 dark:bg-white/5\">\r\n                    <h3 className=\"mb-2 text-sm font-semibold text-gray-900 dark:text-white\">\r\n                      Transports\r\n                    </h3>\r\n                    <ul className=\"space-y-1\">\r\n                      {property.proximites.transports.map((transport, index) => (\r\n                        <li key={index} className=\"text-sm text-gray-600 dark:text-white/70\">\r\n                          • {transport}\r\n                        </li>\r\n                      ))}\r\n                    </ul>\r\n                  </div>\r\n                )}\r\n                {property.proximites.ecoles && property.proximites.ecoles.length > 0 && (\r\n                  <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-4 dark:border-white/10 dark:bg-white/5\">\r\n                    <h3 className=\"mb-2 text-sm font-semibold text-gray-900 dark:text-white\">\r\n                      Écoles\r\n                    </h3>\r\n                    <ul className=\"space-y-1\">\r\n                      {property.proximites.ecoles.map((ecole, index) => (\r\n                        <li key={index} className=\"text-sm text-gray-600 dark:text-white/70\">\r\n                          • {ecole}\r\n                        </li>\r\n                      ))}\r\n                    </ul>\r\n                  </div>\r\n                )}\r\n                {property.proximites.commerces && property.proximites.commerces.length > 0 && (\r\n                  <div className=\"rounded-xl border border-gray-200 bg-gray-50 p-4 dark:border-white/10 dark:bg-white/5\">\r\n                    <h3 className=\"mb-2 text-sm font-semibold text-gray-900 dark:text-white\">\r\n                      Commerces\r\n                    </h3>\r\n                    <ul className=\"space-y-1\">\r\n                      {property.proximites.commerces.map((commerce, index) => (\r\n                        <li key={index} className=\"text-sm text-gray-600 dark:text-white/70\">\r\n                          • {commerce}\r\n                        </li>\r\n                      ))}\r\n                    </ul>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Colonne Droite (Booking Card - span-1) */}\r\n        <div className=\"lg:col-span-1\">\r\n          <BookingCard property={property} />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Bas de Page (Full Width) */}\r\n      <div className=\"mx-auto mt-16 max-w-7xl px-4 md:px-6\">\r\n        {/* Reviews */}\r\n        <div className=\"mb-12 border-t border-gray-200 pt-12 dark:border-white/10\">\r\n          <div className=\"mb-6 flex items-center gap-2\">\r\n            <Star className=\"h-5 w-5 fill-amber-400 text-amber-400\" />\r\n            <span className=\"text-lg font-semibold text-gray-900 dark:text-white\">\r\n              {reviewStats && reviewStats.total_reviews > 0\r\n                ? reviewStats.average_rating.toFixed(1)\r\n                : \"0.0\"}\r\n            </span>\r\n            <span className=\"text-gray-600 dark:text-white/60\">\r\n              ({reviewStats?.total_reviews || 0}{\" \"}\r\n              {reviewStats?.total_reviews === 1 ? \"avis\" : \"avis\"})\r\n            </span>\r\n          </div>\r\n\r\n          {/* Formulaire pour ajouter un avis */}\r\n          <div className=\"mb-8 rounded-xl border border-gray-200 bg-gray-50 p-6 dark:border-white/10 dark:bg-white/5\">\r\n            <h3 className=\"mb-4 text-lg font-semibold text-gray-900 dark:text-white\">\r\n              Laisser un avis\r\n            </h3>\r\n            <ReviewForm propertyId={property.id} />\r\n          </div>\r\n\r\n          {/* Liste des avis */}\r\n          {reviews && reviews.length > 0 ? (\r\n            <div className=\"space-y-6\">\r\n              {reviews.map((review) => (\r\n                <ReviewItem key={review.id} review={review} propertyId={property.id} />\r\n              ))}\r\n            </div>\r\n          ) : (\r\n            <p className=\"text-center text-sm text-gray-500 dark:text-white/50\">\r\n              Aucun avis pour le moment. Soyez le premier à laisser un avis !\r\n            </p>\r\n          )}\r\n        </div>\r\n\r\n        {/* Map */}\r\n        <div className=\"mb-12\">\r\n          <h2 className=\"mb-4 text-2xl font-semibold text-gray-900 dark:text-white\">\r\n            Où se situe le logement\r\n          </h2>\r\n          <StaticMap\r\n            coords={property.location.coords}\r\n            city={property.location.city}\r\n            address={property.location.address}\r\n            landmark={property.location.landmark}\r\n          />\r\n        </div>\r\n\r\n        {/* Propriétaire / Agent Profile */}\r\n        <div className=\"mb-12 border-t border-gray-200 pt-12 dark:border-white/10\">\r\n          <h2 className=\"mb-6 text-2xl font-semibold text-gray-900 dark:text-white\">\r\n            {property.owner ? \"Proposé par\" : \"Faites connaissance avec Agence Dousell\"}\r\n          </h2>\r\n          <AgentCard\r\n            agent={property.agent}\r\n            owner={property.owner}\r\n            property={property}\r\n            propertyId={property.id}\r\n            propertyTitle={property.title}\r\n          />\r\n        </div>\r\n\r\n        {/* Similar Properties */}\r\n        <SimilarProperties properties={similar} />\r\n      </div>\r\n\r\n      {/* Contact Bar Mobile */}\r\n      <ContactBar property={property} />\r\n    </div>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-gallery.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-info.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\proximities-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\review-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\review-item.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'propertyId' is defined but never used.","line":17,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useTransition } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { ThumbsUp, ThumbsDown, Star } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport Image from \"next/image\";\n\nimport { toggleReviewReaction } from \"@/services/reviewReactionService\";\nimport type { Review } from \"@/services/reviewService\";\n\ntype ReviewItemProps = {\n  review: Review;\n  propertyId: string;\n};\n\nconst ReviewItem = ({ review, propertyId }: ReviewItemProps) => {\n  const router = useRouter();\n  const [isPending, startTransition] = useTransition();\n  const [localLikes, setLocalLikes] = useState(review.likes_count || 0);\n  const [localDislikes, setLocalDislikes] = useState(review.dislikes_count || 0);\n  const [localUserReaction, setLocalUserReaction] = useState<\n    \"like\" | \"dislike\" | null\n  >(review.user_reaction || null);\n\n  const handleReaction = (reactionType: \"like\" | \"dislike\") => {\n    // Sauvegarder l'état précédent pour rollback en cas d'erreur\n    const previousLikes = localLikes;\n    const previousDislikes = localDislikes;\n    const previousUserReaction = localUserReaction;\n\n    // Optimistic update immédiat\n    if (localUserReaction === reactionType) {\n      // Si l'utilisateur clique sur la même réaction, on la supprime\n      if (reactionType === \"like\") {\n        setLocalLikes(Math.max(0, localLikes - 1));\n      } else {\n        setLocalDislikes(Math.max(0, localDislikes - 1));\n      }\n      setLocalUserReaction(null);\n    } else if (localUserReaction) {\n      // Si l'utilisateur change de réaction\n      if (localUserReaction === \"like\") {\n        setLocalLikes(Math.max(0, localLikes - 1));\n        setLocalDislikes(localDislikes + 1);\n      } else {\n        setLocalDislikes(Math.max(0, localDislikes - 1));\n        setLocalLikes(localLikes + 1);\n      }\n      setLocalUserReaction(reactionType);\n    } else {\n      // Nouvelle réaction\n      if (reactionType === \"like\") {\n        setLocalLikes(localLikes + 1);\n      } else {\n        setLocalDislikes(localDislikes + 1);\n      }\n      setLocalUserReaction(reactionType);\n    }\n\n    // Appel serveur\n    startTransition(async () => {\n      const result = await toggleReviewReaction(review.id, reactionType);\n\n      if (!result.success) {\n        // Rollback en cas d'erreur\n        setLocalLikes(previousLikes);\n        setLocalDislikes(previousDislikes);\n        setLocalUserReaction(previousUserReaction);\n        toast.error(result.error || \"Erreur lors de la réaction\");\n      } else {\n        // Rafraîchir la page pour synchroniser avec le serveur\n        // Le serveur revalide déjà via revalidatePath, mais on force un refresh\n        router.refresh();\n      }\n    });\n  };\n\n  return (\n    <div className=\"flex gap-4\">\n      <div className=\"relative h-12 w-12 shrink-0 overflow-hidden rounded-full bg-gray-200 dark:bg-white/20\">\n        {review.user_photo ? (\n          <Image\n            src={review.user_photo}\n            alt={review.user_name}\n            fill\n            className=\"object-cover\"\n            sizes=\"48px\"\n          />\n        ) : (\n          <div className=\"flex h-full w-full items-center justify-center text-sm font-semibold text-gray-600 dark:text-white/80\">\n            {review.user_name.charAt(0).toUpperCase()}\n          </div>\n        )}\n      </div>\n      <div className=\"flex-1\">\n        <div className=\"mb-1 flex items-center gap-2\">\n          <span className=\"font-semibold text-gray-900 dark:text-white\">\n            {review.user_name}\n          </span>\n          <div className=\"flex\">\n            {[...Array(5)].map((_, i) => (\n              <Star\n                key={i}\n                className={`h-4 w-4 ${\n                  i < review.rating\n                    ? \"fill-amber-400 text-amber-400\"\n                    : \"fill-gray-300 text-gray-300 dark:fill-gray-600 dark:text-gray-600\"\n                }`}\n              />\n            ))}\n          </div>\n          <span className=\"ml-auto text-xs text-gray-500 dark:text-white/50\">\n            {new Date(review.created_at).toLocaleDateString(\"fr-FR\", {\n              year: \"numeric\",\n              month: \"long\",\n              day: \"numeric\",\n            })}\n          </span>\n        </div>\n        {review.comment && (\n          <p className=\"mb-3 text-sm text-gray-600 dark:text-white/60\">\n            {review.comment}\n          </p>\n        )}\n\n        {/* Boutons Like/Dislike */}\n        <div className=\"flex items-center gap-4\">\n          <button\n            onClick={() => handleReaction(\"like\")}\n            disabled={isPending}\n            className={`flex items-center gap-1 rounded-full px-3 py-1 text-xs transition ${\n              localUserReaction === \"like\"\n                ? \"bg-amber-500/20 text-amber-500\"\n                : \"bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-white/10 dark:text-white/60 dark:hover:bg-white/20\"\n            }`}\n          >\n            <ThumbsUp className={`h-3.5 w-3.5 ${localUserReaction === \"like\" ? \"fill-current\" : \"\"}`} />\n            <span>{localLikes}</span>\n          </button>\n          <button\n            onClick={() => handleReaction(\"dislike\")}\n            disabled={isPending}\n            className={`flex items-center gap-1 rounded-full px-3 py-1 text-xs transition ${\n              localUserReaction === \"dislike\"\n                ? \"bg-red-500/20 text-red-500\"\n                : \"bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-white/10 dark:text-white/60 dark:hover:bg-white/20\"\n            }`}\n          >\n            <ThumbsDown className={`h-3.5 w-3.5 ${localUserReaction === \"dislike\" ? \"fill-current\" : \"\"}`} />\n            <span>{localDislikes}</span>\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport { ReviewItem };\nexport default ReviewItem;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\share-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":93,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":93,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Share2, Copy, Check, MessageCircle } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { formatCurrency } from \"@/lib/utils\";\r\nimport type { Property } from \"@/types/property\";\r\n\r\ntype ShareButtonProps = {\r\n  property: Property;\r\n  shareUrl: string;\r\n  variant?: \"default\" | \"icon\" | \"full\";\r\n  className?: string;\r\n};\r\n\r\n/**\r\n * Génère un texte accrocheur pour le partage WhatsApp\r\n */\r\nfunction generateWhatsAppText(property: Property, url: string): string {\r\n  const district = (property.location as { district?: string }).district ||\r\n    property.location.landmark ||\r\n    property.location.city;\r\n  const formattedPrice = formatCurrency(property.price);\r\n\r\n  return `🏡 *${property.title}*\r\n📍 ${district}\r\n💰 ${formattedPrice} FCFA\r\n\r\nRegarde ça : ${url}`;\r\n}\r\n\r\n/**\r\n * Détecte si on est sur mobile\r\n */\r\nfunction isMobile(): boolean {\r\n  if (typeof window === \"undefined\") return false;\r\n  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\r\n    navigator.userAgent\r\n  ) || window.innerWidth < 768;\r\n}\r\n\r\n/**\r\n * Composant de partage WhatsApp optimisé pour le marché local\r\n * \r\n * - Génère un texte accrocheur avec emojis\r\n * - Utilise whatsapp:// sur mobile et web.whatsapp.com sur desktop\r\n * - Fallback avec copie du lien\r\n */\r\nexport function ShareButton({\r\n  property,\r\n  shareUrl,\r\n  variant = \"default\",\r\n  className,\r\n}: ShareButtonProps) {\r\n  const [copied, setCopied] = useState(false);\r\n\r\n  const handleShare = async () => {\r\n    // 1. Essayer l'API Native de partage (Mobile Experience)\r\n    if (navigator.share) {\r\n      try {\r\n        await navigator.share({\r\n          title: property.title,\r\n          text: `Découvre ce bien à ${property.location.city} : ${property.title}`,\r\n          url: shareUrl,\r\n        });\r\n        toast.success(\"Partagé avec succès !\");\r\n        return;\r\n      } catch (error) {\r\n        // Ignorer l'erreur si l'utilisateur annule le partage (AbortError)\r\n        if ((error as Error).name !== \"AbortError\") {\r\n          console.error(\"Error sharing:\", error);\r\n        } else {\r\n          return; // Stop ici si annulé\r\n        }\r\n      }\r\n    }\r\n\r\n    // 2. Fallback : WhatsApp (Desktop ou si API non dispo)\r\n    const text = generateWhatsAppText(property, shareUrl);\r\n    const encodedText = encodeURIComponent(text);\r\n\r\n    // Utiliser le bon protocole selon la plateforme\r\n    const whatsappUrl = isMobile()\r\n      ? `whatsapp://send?text=${encodedText}`\r\n      : `https://web.whatsapp.com/send?text=${encodedText}`;\r\n\r\n    // Essayer d'ouvrir WhatsApp\r\n    try {\r\n      window.open(whatsappUrl, \"_blank\");\r\n      toast.success(\"Ouverture de WhatsApp...\");\r\n    } catch (error) {\r\n      // Fallback final : copier le texte\r\n      handleCopy();\r\n    }\r\n  };\r\n\r\n  const handleCopy = async () => {\r\n    const text = generateWhatsAppText(property, shareUrl);\r\n\r\n    try {\r\n      if (navigator.clipboard) {\r\n        await navigator.clipboard.writeText(text);\r\n      } else {\r\n        // Fallback pour les navigateurs plus anciens\r\n        const textarea = document.createElement(\"textarea\");\r\n        textarea.value = text;\r\n        textarea.style.position = \"fixed\";\r\n        textarea.style.opacity = \"0\";\r\n        document.body.appendChild(textarea);\r\n        textarea.select();\r\n        document.execCommand(\"copy\");\r\n        document.body.removeChild(textarea);\r\n      }\r\n\r\n      setCopied(true);\r\n      toast.success(\"Lien copié ! Partagez-le sur WhatsApp\");\r\n\r\n      setTimeout(() => setCopied(false), 2000);\r\n    } catch (error) {\r\n      console.error(\"Error copying to clipboard:\", error);\r\n      toast.error(\"Impossible de copier le lien\");\r\n    }\r\n  };\r\n\r\n  if (variant === \"icon\") {\r\n    return (\r\n      <Button\r\n        variant=\"secondary\"\r\n        size=\"icon\"\r\n        onClick={handleShare}\r\n        className={className}\r\n        aria-label=\"Partager\"\r\n      >\r\n        <Share2 className=\"h-5 w-5\" />\r\n      </Button>\r\n    );\r\n  }\r\n\r\n  if (variant === \"full\") {\r\n    return (\r\n      <div className={`flex gap-2 ${className}`}>\r\n        <Button\r\n          onClick={handleShare}\r\n          className=\"flex-1 rounded-full bg-[#25D366] text-white hover:bg-[#20ba58]\"\r\n        >\r\n          <MessageCircle className=\"mr-2 h-4 w-4\" />\r\n          Partager sur WhatsApp\r\n        </Button>\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"icon\"\r\n          onClick={handleCopy}\r\n          className=\"rounded-full\"\r\n          aria-label=\"Copier le lien\"\r\n        >\r\n          {copied ? (\r\n            <Check className=\"h-4 w-4 text-emerald-500\" />\r\n          ) : (\r\n            <Copy className=\"h-4 w-4\" />\r\n          )}\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Variant default\r\n  return (\r\n    <Button\r\n      onClick={handleShare}\r\n      variant=\"secondary\"\r\n      className={`rounded-full ${className}`}\r\n    >\r\n      <MessageCircle className=\"mr-2 h-4 w-4\" />\r\n      Partager\r\n      <Button\r\n        variant=\"ghost\"\r\n        size=\"icon\"\r\n        onClick={(e) => {\r\n          e.stopPropagation();\r\n          handleCopy();\r\n        }}\r\n        className=\"ml-2 h-6 w-6 rounded-full\"\r\n        aria-label=\"Copier le lien\"\r\n      >\r\n        {copied ? (\r\n          <Check className=\"h-3 w-3 text-emerald-500\" />\r\n        ) : (\r\n          <Copy className=\"h-3 w-3\" />\r\n        )}\r\n      </Button>\r\n    </Button>\r\n  );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\similar-properties.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\static-map.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ExternalLink' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":22},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\static-map.tsx:36:7\n  34 |   useEffect(() => {\n  35 |     if (!hasValidCoords) {\n> 36 |       setMapUrl(null);\n     |       ^^^^^^^^^ Avoid calling setState() directly within an effect\n  37 |       return;\n  38 |     }\n  39 |","line":36,"column":7,"nodeType":null,"endLine":36,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Image from \"next/image\";\nimport { ExternalLink, MapPin, Navigation } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\nimport { useState, useEffect, useMemo } from \"react\";\n\nimport { Button } from \"@/components/ui/button\";\n\ntype StaticMapProps = {\n  coords: { lat: number; lng: number };\n  city: string;\n  address?: string;\n  landmark?: string;\n};\n\nexport const StaticMap = ({ coords, city, address, landmark }: StaticMapProps) => {\n  const [mapUrl, setMapUrl] = useState<string | null>(null);\n  const [mapError, setMapError] = useState(false);\n  \n  // Vérifier si les coordonnées sont valides\n  const hasValidCoords = useMemo(() => {\n    return coords.lat !== 0 && coords.lng !== 0 && \n           !isNaN(coords.lat) && !isNaN(coords.lng) &&\n           coords.lat >= -90 && coords.lat <= 90 &&\n           coords.lng >= -180 && coords.lng <= 180;\n  }, [coords.lat, coords.lng]);\n\n  const mapsLink = hasValidCoords \n    ? `https://www.google.com/maps?q=${coords.lat},${coords.lng}`\n    : `https://www.google.com/maps/search/${encodeURIComponent(city + (address ? `, ${address}` : \"\"))}`;\n  \n  // Construire l'URL de la carte avec CartoDB Dark Matter (comme la carte principale)\n  useEffect(() => {\n    if (!hasValidCoords) {\n      setMapUrl(null);\n      return;\n    }\n\n    const mapboxToken = process.env.NEXT_PUBLIC_MAPBOX_TOKEN;\n    const googleApiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_KEY;\n    \n    if (mapboxToken) {\n      // Utiliser Mapbox avec style dark (comme la carte principale)\n      const mapboxMapUrl = `https://api.mapbox.com/styles/v1/mapbox/dark-v11/static/pin-s+3B82F6(${coords.lng},${coords.lat})/${coords.lng},${coords.lat},15/800x400@2x?access_token=${mapboxToken}`;\n      setMapUrl(mapboxMapUrl);\n    } else if (googleApiKey) {\n      // Utiliser Google Maps Static API avec un style sombre\n      const googleMapUrl = new URL(\"https://maps.googleapis.com/maps/api/staticmap\");\n      googleMapUrl.searchParams.set(\"center\", `${coords.lat},${coords.lng}`);\n      googleMapUrl.searchParams.set(\"zoom\", \"15\");\n      googleMapUrl.searchParams.set(\"size\", \"800x400\");\n      googleMapUrl.searchParams.set(\"scale\", \"2\");\n      googleMapUrl.searchParams.set(\"format\", \"jpg\");\n      googleMapUrl.searchParams.set(\"maptype\", \"roadmap\");\n      \n      // Style sombre pour correspondre au thème\n      googleMapUrl.searchParams.set(\n        \"style\",\n        \"feature:all|element:labels|visibility:simplified|feature:poi|visibility:off|feature:road|element:labels|visibility:off|feature:water|color:0x1a1a2e|feature:landscape|color:0x16213e\"\n      );\n      \n      // Marqueur personnalisé\n      googleMapUrl.searchParams.set(\n        \"markers\",\n        `color:0x3B82F6|size:mid|${coords.lat},${coords.lng}`\n      );\n      \n      googleMapUrl.searchParams.set(\"key\", googleApiKey);\n      setMapUrl(googleMapUrl.toString());\n    }\n  }, [coords.lat, coords.lng, hasValidCoords]);\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      whileInView={{ opacity: 1, y: 0 }}\n      viewport={{ once: true, amount: 0.4 }}\n      className=\"space-y-4 rounded-3xl border border-gray-100 bg-gray-50 p-6 dark:border-white/10 dark:bg-white/5\"\n    >\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n        <div className=\"flex-1\">\n          <p className=\"text-xs uppercase tracking-[0.3em] text-gray-500 dark:text-white/50\">\n            LOCALISATION\n          </p>\n          <h3 className=\"mt-1 text-2xl font-semibold text-gray-900 dark:text-white\">\n            {city}\n          </h3>\n          {address && (\n            <p className=\"mt-1 flex items-center gap-2 text-sm text-gray-600 dark:text-white/70\">\n              <MapPin className=\"h-4 w-4 shrink-0\" />\n              <span>{address}</span>\n            </p>\n          )}\n          {landmark && (\n            <p className=\"mt-1 text-sm text-gray-500 dark:text-white/60\">\n              {landmark}\n            </p>\n          )}\n        </div>\n        <Button\n          variant=\"secondary\"\n          className=\"shrink-0 rounded-2xl border border-gray-200 bg-white text-sm font-medium text-gray-900 hover:bg-gray-100 dark:border-white/20 dark:bg-transparent dark:text-white dark:hover:bg-white/10\"\n          asChild\n        >\n          <a href={mapsLink} target=\"_blank\" rel=\"noreferrer\" className=\"flex items-center gap-2\">\n            <Navigation className=\"h-4 w-4\" />\n            Ouvrir Maps\n          </a>\n        </Button>\n      </div>\n      \n      <div className=\"relative h-64 w-full overflow-hidden rounded-2xl border border-gray-200 bg-gray-100 dark:border-white/10 dark:bg-gray-900\">\n        {hasValidCoords && mapUrl && !mapError ? (\n          <>\n            <Image\n              src={mapUrl}\n              alt={`Carte de ${city}`}\n              fill\n              className=\"object-cover\"\n              sizes=\"(max-width: 768px) 100vw, 800px\"\n              quality={90}\n              onError={() => setMapError(true)}\n              priority={false}\n            />\n            {/* Marqueur personnalisé au centre */}\n            <div className=\"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2\">\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 animate-ping rounded-full bg-blue-500/30\" />\n                <div className=\"relative h-8 w-8 rounded-full bg-blue-500 shadow-lg ring-2 ring-white dark:ring-gray-900\" />\n                <div className=\"absolute left-1/2 top-1/2 h-3 w-3 -translate-x-1/2 -translate-y-1/2 rounded-full bg-white\" />\n              </div>\n            </div>\n            {/* Coordonnées en bas à droite */}\n            <div className=\"absolute bottom-3 right-3 rounded-lg bg-black/70 px-3 py-1.5 text-xs font-mono text-white/90 backdrop-blur-sm\">\n              {coords.lat.toFixed(6)}, {coords.lng.toFixed(6)}\n            </div>\n          </>\n        ) : (\n          <div className=\"flex h-full w-full flex-col items-center justify-center bg-gradient-to-br from-gray-100 via-gray-50 to-gray-100 p-6 dark:from-gray-800 dark:via-gray-900 dark:to-gray-800\">\n            <div className=\"mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-gray-200 dark:bg-white/10\">\n              <MapPin className=\"h-8 w-8 text-gray-400 dark:text-white/30\" />\n            </div>\n            <div className=\"text-center\">\n              <p className=\"text-sm font-medium text-gray-600 dark:text-white/60\">\n                {hasValidCoords ? \"Carte non disponible\" : \"Coordonnées non disponibles\"}\n              </p>\n              <p className=\"mt-1 text-xs text-gray-500 dark:text-white/40\">\n                {hasValidCoords \n                  ? 'Cliquez sur \"Ouvrir Maps\" pour voir la localisation'\n                  : 'Les coordonnées GPS ne sont pas configurées pour ce bien'}\n              </p>\n            </div>\n          </div>\n        )}\n      </div>\n    </motion.div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\providers\\splash-provider.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Children' is defined but never used.","line":3,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":39},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\providers\\splash-provider.tsx:48:9\n  46 |       if (hasShown) {\n  47 |         removeSplashBlocker();\n> 48 |         setShowSplash(false);\n     |         ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  49 |         setIsReady(true);\n  50 |         return;\n  51 |       }","line":48,"column":9,"nodeType":null,"endLine":48,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, Children, Fragment } from \"react\";\nimport { AnimatePresence } from \"framer-motion\";\nimport { SplashScreen } from \"@/components/ui/splash-screen\";\n\nconst SPLASH_DURATION = 2500; // ms - durée totale avant fade out\nconst SESSION_KEY = \"doussel_splash_shown\";\n\ninterface SplashProviderProps {\n  children: React.ReactNode | React.ReactNode[];\n  /** Si true, affiche le splash à chaque visite (pas seulement la première) */\n  showEveryVisit?: boolean;\n  /** Durée personnalisée en ms */\n  duration?: number;\n}\n\n/**\n * Supprime le blocker HTML créé par le script inline\n */\nconst removeSplashBlocker = () => {\n  const blocker = document.getElementById(\"splash-blocker\");\n  if (blocker) {\n    blocker.remove();\n  }\n  document.documentElement.style.overflow = \"\";\n};\n\n/**\n * SplashProvider - Gère l'affichage du splash screen au chargement\n * \n * Structure stable pour éviter les warnings de key dans Next.js App Router\n */\nexport const SplashProvider = ({\n  children,\n  showEveryVisit = false,\n  duration = SPLASH_DURATION,\n}: SplashProviderProps) => {\n  const [showSplash, setShowSplash] = useState(true);\n  const [isReady, setIsReady] = useState(false);\n\n  useEffect(() => {\n    // Vérifier sessionStorage pour éviter de re-montrer le splash\n    if (!showEveryVisit) {\n      const hasShown = sessionStorage.getItem(SESSION_KEY);\n      if (hasShown) {\n        removeSplashBlocker();\n        setShowSplash(false);\n        setIsReady(true);\n        return;\n      }\n    }\n\n    // Supprimer le blocker HTML - React prend le relais\n    removeSplashBlocker();\n    setIsReady(true);\n    \n    // Bloquer le scroll pendant le splash\n    document.body.style.overflow = \"hidden\";\n    \n    // Timer pour masquer le splash\n    const timer = setTimeout(() => {\n      setShowSplash(false);\n      document.body.style.overflow = \"\";\n      \n      // Marquer comme affiché pour cette session\n      if (!showEveryVisit) {\n        sessionStorage.setItem(SESSION_KEY, \"true\");\n      }\n    }, duration);\n\n    return () => {\n      clearTimeout(timer);\n      document.body.style.overflow = \"\";\n    };\n  }, [duration, showEveryVisit]);\n\n  // Structure stable - un seul wrapper pour éviter les warnings de key dans Next.js App Router\n  return (\n    <>\n      {/* Splash Screen avec AnimatePresence */}\n      {showSplash && isReady && (\n        <AnimatePresence mode=\"wait\">\n          <SplashScreen key=\"splash-screen\" />\n        </AnimatePresence>\n      )}\n      \n      {/* Contenu principal - toujours rendu mais caché si splash visible */}\n      <div\n        key=\"main-content\"\n        style={{\n          opacity: showSplash ? 0 : 1,\n          pointerEvents: showSplash ? \"none\" : \"auto\",\n          transition: \"opacity 0.4s ease-out\",\n        }}\n      >\n        {children}\n      </div>\n      \n      {/* Écran noir de fallback avant hydratation */}\n      {!isReady && (\n        <div key=\"fallback-black\" className=\"fixed inset-0 z-[9999] bg-black\" />\n      )}\n    </>\n  );\n};\n\nexport default SplashProvider;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\providers\\suppress-hydration-warning.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\install-prompt.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\install-prompt.tsx:49:5\n  47 |   useEffect(() => {\n  48 |     // Check if already installed\n> 49 |     setIsInstalled(isStandalone());\n     |     ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  50 |\n  51 |     // Detect platform\n  52 |     setPlatform(detectPlatform());","line":49,"column":5,"nodeType":null,"endLine":49,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'deferredPrompt'. Either include it or remove the dependency array.","line":113,"column":6,"nodeType":"ArrayExpression","endLine":113,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [deferredPrompt, platform]","fix":{"range":[3643,3653],"text":"[deferredPrompt, platform]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { Download, X, Share2 } from \"lucide-react\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport { toast } from \"sonner\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\ntype BeforeInstallPromptEvent = Event & {\r\n  prompt: () => Promise<void>;\r\n  userChoice: Promise<{ outcome: \"accepted\" | \"dismissed\" }>;\r\n};\r\n\r\ntype Platform = \"ios\" | \"android\" | \"other\";\r\n\r\nfunction detectPlatform(): Platform {\r\n  if (typeof window === \"undefined\") return \"other\";\r\n\r\n  const userAgent = window.navigator.userAgent.toLowerCase();\r\n  const isIOS = /iphone|ipad|ipod/.test(userAgent);\r\n  const isAndroid = /android/.test(userAgent);\r\n\r\n  if (isIOS) return \"ios\";\r\n  if (isAndroid) return \"android\";\r\n  return \"other\";\r\n}\r\n\r\nfunction isStandalone(): boolean {\r\n  if (typeof window === \"undefined\") return false;\r\n  const nav = window.navigator as { standalone?: boolean };\r\n  return (\r\n    window.matchMedia(\"(display-mode: standalone)\").matches ||\r\n    nav.standalone === true ||\r\n    document.referrer.includes(\"android-app://\")\r\n  );\r\n}\r\n\r\nexport function InstallPrompt() {\r\n  const [deferredPrompt, setDeferredPrompt] =\r\n    useState<BeforeInstallPromptEvent | null>(null);\r\n  const [isVisible, setIsVisible] = useState(false);\r\n  const [isInstalled, setIsInstalled] = useState(false);\r\n  const [platform, setPlatform] = useState<Platform>(\"other\");\r\n  const [showIOSInstructions, setShowIOSInstructions] = useState(false);\r\n\r\n  useEffect(() => {\r\n    // Check if already installed\r\n    setIsInstalled(isStandalone());\r\n\r\n    // Detect platform\r\n    setPlatform(detectPlatform());\r\n\r\n    // Check if user dismissed recently\r\n    const checkDismissed = () => {\r\n      const dismissed = localStorage.getItem(\"pwa-install-dismissed\");\r\n      if (dismissed) {\r\n        const dismissedDate = new Date(dismissed);\r\n        const daysSinceDismissed =\r\n          (Date.now() - dismissedDate.getTime()) / (1000 * 60 * 60 * 24);\r\n        // Show again after 1 day instead of 7 days\r\n        if (daysSinceDismissed < 1) {\r\n          return false;\r\n        }\r\n      }\r\n      return true;\r\n    };\r\n\r\n    // Handle beforeinstallprompt (Android/Chrome)\r\n    const handleBeforeInstallPrompt = (e: Event) => {\r\n      e.preventDefault();\r\n      if (checkDismissed() && !isStandalone()) {\r\n        setDeferredPrompt(e as BeforeInstallPromptEvent);\r\n        setIsVisible(true);\r\n      }\r\n    };\r\n\r\n    // For iOS, show prompt after a delay if not installed\r\n    if (platform === \"ios\" && !isStandalone() && checkDismissed()) {\r\n      // Show iOS prompt after 3 seconds on mobile\r\n      const timer = setTimeout(() => {\r\n        if (window.innerWidth <= 768) {\r\n          setIsVisible(true);\r\n        }\r\n      }, 3000);\r\n      return () => clearTimeout(timer);\r\n    }\r\n\r\n    // For Android/Chrome, listen for beforeinstallprompt\r\n    if (platform !== \"ios\") {\r\n      window.addEventListener(\"beforeinstallprompt\", handleBeforeInstallPrompt);\r\n\r\n      // Fallback: Show prompt on mobile Android after delay if no beforeinstallprompt\r\n      const fallbackTimer = setTimeout(() => {\r\n        if (\r\n          platform === \"android\" &&\r\n          window.innerWidth <= 768 &&\r\n          !isStandalone() &&\r\n          checkDismissed()\r\n        ) {\r\n          // Check if deferredPrompt was set in the meantime\r\n          if (!deferredPrompt) {\r\n            setIsVisible(true);\r\n          }\r\n        }\r\n      }, 5000);\r\n\r\n      return () => {\r\n        window.removeEventListener(\"beforeinstallprompt\", handleBeforeInstallPrompt);\r\n        clearTimeout(fallbackTimer);\r\n      };\r\n    }\r\n  }, [platform]);\r\n\r\n  const handleInstall = async () => {\r\n    if (platform === \"ios\") {\r\n      setShowIOSInstructions(true);\r\n      return;\r\n    }\r\n\r\n    // Android/Chrome: Use native prompt if available\r\n    if (deferredPrompt) {\r\n      try {\r\n        deferredPrompt.prompt();\r\n        const { outcome } = await deferredPrompt.userChoice;\r\n\r\n        if (outcome === \"accepted\") {\r\n          toast.success(\"Installation en cours...\");\r\n          setIsVisible(false);\r\n          setDeferredPrompt(null);\r\n        } else {\r\n          toast.info(\"Installation annulée\");\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Error during install:\", error);\r\n        toast.error(\"Erreur lors de l'installation\");\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Fallback: Show instructions for manual installation\r\n    if (platform === \"android\") {\r\n      toast.info(\"Utilisez le menu de votre navigateur pour installer l'app\");\r\n      handleDismiss();\r\n    }\r\n  };\r\n\r\n  const handleDismiss = () => {\r\n    setIsVisible(false);\r\n    setShowIOSInstructions(false);\r\n    // Store dismissal in localStorage to avoid showing again for 1 day\r\n    localStorage.setItem(\r\n      \"pwa-install-dismissed\",\r\n      new Date().toISOString()\r\n    );\r\n  };\r\n\r\n  if (isInstalled) {\r\n    return null;\r\n  }\r\n\r\n  // iOS Instructions Modal\r\n  if (showIOSInstructions) {\r\n    return (\r\n      <AnimatePresence>\r\n        <motion.div\r\n          initial={{ opacity: 0 }}\r\n          animate={{ opacity: 1 }}\r\n          exit={{ opacity: 0 }}\r\n          className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm\"\r\n          onClick={handleDismiss}\r\n        >\r\n          <motion.div\r\n            initial={{ scale: 0.9, opacity: 0 }}\r\n            animate={{ scale: 1, opacity: 1 }}\r\n            exit={{ scale: 0.9, opacity: 0 }}\r\n            onClick={(e) => e.stopPropagation()}\r\n            className=\"w-full max-w-md rounded-3xl border border-white/10 bg-[#0b0f18] p-6 shadow-2xl\"\r\n          >\r\n            <div className=\"mb-4 flex items-center justify-between\">\r\n              <h3 className=\"text-lg font-semibold text-white\">\r\n                Installer sur iOS\r\n              </h3>\r\n              <button\r\n                onClick={handleDismiss}\r\n                className=\"text-white/50 hover:text-white\"\r\n                aria-label=\"Fermer\"\r\n              >\r\n                <X className=\"h-5 w-5\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"space-y-4 text-sm text-white/80\">\r\n              <div className=\"flex gap-3\">\r\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-white/10 text-lg font-bold text-white\">\r\n                  1\r\n                </div>\r\n                <div>\r\n                  <p className=\"font-semibold text-white\">Appuyez sur le bouton Partager</p>\r\n                  <p className=\"text-xs text-white/60\">En bas de l&apos;écran (icône carrée avec flèche)</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex gap-3\">\r\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-white/10 text-lg font-bold text-white\">\r\n                  2\r\n                </div>\r\n                <div>\r\n                  <p className=\"font-semibold text-white\">Sélectionnez &quot;Sur l&apos;écran d&apos;accueil&quot;</p>\r\n                  <p className=\"text-xs text-white/60\">Faites défiler si nécessaire</p>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex gap-3\">\r\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-white/10 text-lg font-bold text-white\">\r\n                  3\r\n                </div>\r\n                <div>\r\n                  <p className=\"font-semibold text-white\">Confirmez l&apos;installation</p>\r\n                  <p className=\"text-xs text-white/60\">L&apos;app apparaîtra sur votre écran d&apos;accueil</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <Button\r\n              className=\"mt-6 w-full rounded-full\"\r\n              onClick={handleDismiss}\r\n            >\r\n              J&apos;ai compris\r\n            </Button>\r\n          </motion.div>\r\n        </motion.div>\r\n      </AnimatePresence>\r\n    );\r\n  }\r\n\r\n  // Main install prompt\r\n  if (!isVisible) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <AnimatePresence>\r\n      <motion.div\r\n        key=\"install-prompt-banner\"\r\n        initial={{ y: 100, opacity: 0 }}\r\n        animate={{ y: 0, opacity: 1 }}\r\n        exit={{ y: 100, opacity: 0 }}\r\n        className=\"fixed inset-x-4 bottom-20 z-50 md:bottom-4 md:left-auto md:right-4 md:w-96\"\r\n      >\r\n        <div className=\"rounded-2xl border border-white/10 bg-[#0b0f18]/95 p-4 shadow-2xl backdrop-blur-xl\">\r\n          <div className=\"flex items-start gap-3\">\r\n            <div className=\"flex-1\">\r\n              <h3 className=\"text-sm font-semibold text-white\">\r\n                Installer Dousell Immo\r\n              </h3>\r\n              <p className=\"mt-1 text-xs text-white/70\">\r\n                Ajoutez l&apos;app à votre écran d&apos;accueil pour un accès\r\n                rapide\r\n              </p>\r\n            </div>\r\n            <button\r\n              onClick={handleDismiss}\r\n              className=\"text-white/50 hover:text-white\"\r\n              aria-label=\"Fermer\"\r\n            >\r\n              <X className=\"h-4 w-4\" />\r\n            </button>\r\n          </div>\r\n          <div className=\"mt-4 flex gap-2\">\r\n            <Button\r\n              variant=\"secondary\"\r\n              size=\"sm\"\r\n              className=\"flex-1 rounded-full border border-white/10 bg-white/5 text-white\"\r\n              onClick={handleDismiss}\r\n            >\r\n              Plus tard\r\n            </Button>\r\n            <Button\r\n              size=\"sm\"\r\n              className=\"flex-1 rounded-full\"\r\n              onClick={handleInstall}\r\n            >\r\n              {platform === \"ios\" ? (\r\n                <>\r\n                  <Share2 className=\"mr-2 h-4 w-4\" />\r\n                  Installer\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Download className=\"mr-2 h-4 w-4\" />\r\n                  Installer\r\n                </>\r\n              )}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </motion.div>\r\n    </AnimatePresence>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\push-notifications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\service-worker-register.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\create-alert-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":5,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { Bell, X, Loader2 } from \"lucide-react\";\r\nimport { useForm } from \"react-hook-form\";\r\nimport { zodResolver } from \"@hookform/resolvers/zod\";\r\nimport * as z from \"zod\";\r\n\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { toast } from \"sonner\";\r\nimport { createSearchAlert } from \"@/app/compte/alertes/actions\";\r\nimport type { PropertyFilters } from \"@/services/propertyService\";\r\n\r\nconst alertSchema = z.object({\r\n  name: z\r\n    .string()\r\n    .min(3, \"Le nom doit contenir au moins 3 caractères\")\r\n    .max(50, \"Le nom ne peut pas dépasser 50 caractères\"),\r\n});\r\n\r\ntype AlertFormData = z.infer<typeof alertSchema>;\r\n\r\ninterface CreateAlertDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  filters: PropertyFilters;\r\n}\r\n\r\nexport function CreateAlertDialog({\r\n  open,\r\n  onOpenChange,\r\n  filters,\r\n}: CreateAlertDialogProps) {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n  const {\r\n    register,\r\n    handleSubmit,\r\n    formState: { errors },\r\n    reset,\r\n  } = useForm<AlertFormData>({\r\n    resolver: zodResolver(alertSchema),\r\n    defaultValues: {\r\n      name: \"\",\r\n    },\r\n  });\r\n\r\n  const onSubmit = async (data: AlertFormData) => {\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      const result = await createSearchAlert({\r\n        name: data.name,\r\n        filters,\r\n      });\r\n\r\n      if (result.error) {\r\n        toast.error(\"Erreur\", {\r\n          description: result.error,\r\n        });\r\n        return;\r\n      }\r\n\r\n      toast.success(\"Alerte créée\", {\r\n        description: `Votre alerte \"${data.name}\" a été créée avec succès.`,\r\n      });\r\n\r\n      reset();\r\n      onOpenChange(false);\r\n\r\n      // Si on était sur la page de recherche avec ?alert=create, rediriger vers les alertes\r\n      if (searchParams.get(\"alert\") === \"create\") {\r\n        router.push(\"/compte/alertes\");\r\n        router.refresh();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error creating alert:\", error);\r\n      toast.error(\"Erreur\", {\r\n        description: \"Une erreur inattendue s'est produite\",\r\n      });\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const formatFilters = () => {\r\n    const parts: string[] = [];\r\n    // Utiliser 'q' pour la recherche textuelle (location)\r\n    const filtersWithQ = filters as { q?: string; location?: string; category?: string; city?: string; type?: string; minPrice?: number; maxPrice?: number; rooms?: number; bedrooms?: number; hasBackupGenerator?: boolean; hasWaterTank?: boolean };\r\n    const searchQuery = filtersWithQ.q || filters.location;\r\n    if (searchQuery && searchQuery.trim()) {\r\n      parts.push(searchQuery.trim());\r\n    }\r\n    if (filters.category) {\r\n      parts.push(filters.category === \"vente\" ? \"Achat\" : \"Location\");\r\n    }\r\n    if (filters.city) {\r\n      parts.push(filters.city);\r\n    }\r\n    if (filters.type) {\r\n      parts.push(filters.type);\r\n    }\r\n    if (filters.minPrice || filters.maxPrice) {\r\n      const priceRange = [\r\n        filters.minPrice ? `${filters.minPrice.toLocaleString()} FCFA` : \"\",\r\n        filters.maxPrice ? `${filters.maxPrice.toLocaleString()} FCFA` : \"\",\r\n      ]\r\n        .filter(Boolean)\r\n        .join(\" - \");\r\n      if (priceRange) {\r\n        parts.push(priceRange);\r\n      }\r\n    }\r\n    if (filters.rooms) {\r\n      parts.push(`${filters.rooms} pièce${filters.rooms > 1 ? \"s\" : \"\"}`);\r\n    }\r\n    if (filters.bedrooms) {\r\n      parts.push(`${filters.bedrooms} chambre${filters.bedrooms > 1 ? \"s\" : \"\"}`);\r\n    }\r\n    if (filters.hasBackupGenerator) {\r\n      parts.push(\"Groupe électrogène\");\r\n    }\r\n    if (filters.hasWaterTank) {\r\n      parts.push(\"Citerne d'eau\");\r\n    }\r\n    return parts.length > 0 ? parts.join(\", \") : \"Tous les biens (aucun filtre)\";\r\n  };\r\n\r\n  const hasActiveFilters = (() => {\r\n    // Vérifier si au moins un filtre a une valeur significative\r\n    const filtersWithQ = filters as { q?: string; location?: string; category?: string; city?: string; type?: string; minPrice?: number; maxPrice?: number };\r\n    return !!(\r\n      (filtersWithQ.q && filtersWithQ.q.trim()) ||\r\n      filters.location ||\r\n      filters.category ||\r\n      filters.city ||\r\n      filters.type ||\r\n      filters.minPrice ||\r\n      filters.maxPrice ||\r\n      filters.rooms ||\r\n      filters.bedrooms ||\r\n      filters.hasBackupGenerator ||\r\n      filters.hasWaterTank\r\n    );\r\n  })();\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-md border-white/10 bg-[#05080c] text-white\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2 text-xl\">\r\n            <Bell className=\"h-5 w-5 text-amber-500\" />\r\n            Créer une alerte de recherche\r\n          </DialogTitle>\r\n          <DialogDescription className=\"text-white/60\">\r\n            Recevez une notification quand de nouveaux biens correspondent à vos\r\n            critères de recherche.\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\r\n          {/* Nom de l'alerte */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"name\" className=\"text-white\">\r\n              Nom de l&apos;alerte\r\n            </Label>\r\n            <Input\r\n              id=\"name\"\r\n              {...register(\"name\")}\r\n              placeholder=\"Ex: Appartement à Dakar\"\r\n              className=\"border-white/10 bg-white/5 text-white placeholder:text-white/40 focus-visible:ring-white/20\"\r\n              disabled={isSubmitting}\r\n            />\r\n            {errors.name && (\r\n              <p className=\"text-sm text-red-400\">{errors.name.message}</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* Critères de recherche */}\r\n          <div className=\"space-y-2\">\r\n            <Label className=\"text-white\">Critères de recherche</Label>\r\n            <div className=\"rounded-lg border border-white/10 bg-white/5 p-4\">\r\n              <p className=\"text-sm text-white/80\">{formatFilters()}</p>\r\n              {!hasActiveFilters && (\r\n                <p className=\"mt-2 text-xs text-white/50 italic\">\r\n                  Vous recevrez une notification pour tous les nouveaux biens publiés.\r\n                </p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Boutons */}\r\n          <div className=\"flex gap-3 pt-2\">\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"ghost\"\r\n              onClick={() => {\r\n                reset();\r\n                onOpenChange(false);\r\n              }}\r\n              disabled={isSubmitting}\r\n              className=\"flex-1 border border-white/10 text-white hover:bg-white/10\"\r\n            >\r\n              Annuler\r\n            </Button>\r\n            <Button\r\n              type=\"submit\"\r\n              disabled={isSubmitting}\r\n              className=\"flex-1 bg-amber-500 text-black hover:bg-amber-600\"\r\n            >\r\n              {isSubmitting ? (\r\n                <>\r\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                  Création...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Bell className=\"mr-2 h-4 w-4\" />\r\n                  Créer l&apos;alerte\r\n                </>\r\n              )}\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\filter-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\map-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":17,"column":43,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":17,"endColumn":61},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":18,"column":60,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":18,"endColumn":92},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MarkerCluster' is assigned a value but never used.","line":62,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":62,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'children' is defined but never used.","line":62,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":62,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'size' is assigned a value but never used.","line":85,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":85,"endColumn":25},{"ruleId":"react/display-name","severity":2,"message":"Component definition is missing display name","line":108,"column":21,"nodeType":"CallExpression","messageId":"noDisplayName","endLine":211,"endColumn":3},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'onRedirect' is defined but never used.","line":112,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":112,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":165,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":165,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setMounted' is assigned a value but never used.","line":217,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":217,"endColumn":31}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport \"leaflet/dist/leaflet.css\";\nimport \"leaflet.markercluster/dist/MarkerCluster.css\";\nimport \"leaflet.markercluster/dist/MarkerCluster.Default.css\";\n\nimport { useEffect, useMemo, useState, useCallback, memo } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { MapContainer, TileLayer, Marker, useMap } from \"react-leaflet\";\nimport type { LatLngExpression, DivIcon } from \"leaflet\";\n\nimport { PropertyCard } from \"@/components/property/property-card\";\nimport { Button } from \"@/components/ui/button\";\nimport type { Property } from \"@/types/property\";\n\n// Import dynamique pour éviter les erreurs SSR\nconst L = typeof window !== \"undefined\" ? require(\"leaflet\") : null;\nconst MarkerClusterGroup = typeof window !== \"undefined\" ? require(\"leaflet.markercluster\") : null;\n\n// Fix pour les icônes Leaflet avec Next.js\nif (typeof window !== \"undefined\" && L) {\n    delete (L.Icon.Default.prototype as Record<string, unknown>)._getIconUrl;\n    L.Icon.Default.mergeOptions({\n        iconRetinaUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png\",\n        iconUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png\",\n        shadowUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png\",\n    });\n}\n\ntype MapViewProps = {\n    properties: Property[];\n    showCarousel?: boolean;\n};\n\n// Coordonnées de Dakar par défaut\nconst DAKAR_CENTER: LatLngExpression = [14.7167, -17.4677];\nconst DEFAULT_ZOOM = 11;\n\n// Formatage du prix en format court (ex: \"1.5M\", \"500k\")\nconst formatPrice = (price: number): string => {\n    if (price >= 1_000_000) {\n        const millions = price / 1_000_000;\n        return `${millions % 1 === 0 ? millions : millions.toFixed(1)}M`;\n    }\n    if (price >= 1_000) {\n        const thousands = price / 1_000;\n        return `${thousands % 1 === 0 ? thousands : thousands.toFixed(1)}k`;\n    }\n    return price.toString();\n};\n\n// Composant pour centrer la carte automatiquement\nconst MapCenter = ({ center, zoom }: { center: LatLngExpression; zoom: number }) => {\n    const map = useMap();\n    useEffect(() => {\n        map.setView(center, zoom);\n    }, [map, center, zoom]);\n    return null;\n};\n\n// Composant de clustering pour les marqueurs\nconst MarkerCluster = ({ children }: { children: React.ReactNode }) => {\n    const map = useMap();\n\n    useEffect(() => {\n        if (!L || !MarkerClusterGroup) return;\n\n        // Créer un groupe de clusters avec une configuration optimisée\n        const cluster = new L.MarkerClusterGroup({\n            maxClusterRadius: 60, // Rayon de clustering réduit pour plus de précision\n            spiderfyOnMaxZoom: true,\n            showCoverageOnHover: false,\n            zoomToBoundsOnClick: true,\n            disableClusteringAtZoom: 17, // Désactiver le clustering en très gros zoom\n            iconCreateFunction: (cluster: { getChildCount: () => number }) => {\n                const count = cluster.getChildCount();\n                let size = \"small\";\n                let className = \"marker-cluster-small\";\n\n                if (count > 10) {\n                    size = \"medium\";\n                    className = \"marker-cluster-medium\";\n                }\n                if (count > 20) {\n                    size = \"large\";\n                    className = \"marker-cluster-large\";\n                }\n\n                return L.divIcon({\n                    html: `<div class=\"cluster-pill ${className}\"><span>${count}</span></div>`,\n                    className: \"custom-cluster-icon\",\n                    iconSize: L.point(50, 50),\n                });\n            },\n        });\n\n        map.addLayer(cluster);\n\n        return () => {\n            map.removeLayer(cluster);\n        };\n    }, [map]);\n\n    return null;\n};\n\n// Composant de marqueur personnalisé avec prix - Optimisé avec memo\nconst PriceMarker = memo(({\n    property,\n    isActive,\n    onClick,\n    onRedirect,\n}: {\n    property: Property;\n    isActive: boolean;\n    onClick: () => void;\n    onRedirect: () => void;\n}) => {\n    const position: LatLngExpression = useMemo(() => [\n        property.location.coords.lat,\n        property.location.coords.lng,\n    ], [property.location.coords.lat, property.location.coords.lng]);\n\n    // Créer une icône HTML personnalisée pour le prix\n    const icon = useMemo(() => {\n        if (typeof window === \"undefined\" || !L) return undefined;\n\n        const priceText = formatPrice(property.price);\n        const isVerified = property.verification_status === \"verified\";\n\n        // Style doré pour les biens vérifiés\n        const verifiedClass = isVerified\n            ? \"bg-[#F4C430] text-black border-2 border-white shadow-[0_0_15px_rgba(244,196,48,0.5)]\"\n            : \"bg-primary text-primary-foreground\";\n\n        // Style actif (cliqué)\n        const activeClass = isActive\n            ? \"scale-110 bg-white text-black z-50 border-white\"\n            : verifiedClass;\n\n        // Z-index supérieur pour les biens vérifiés\n        const zIndex = isActive ? 1000 : (isVerified ? 100 : 1);\n\n        return L.divIcon({\n            className: \"custom-price-marker\",\n            html: `\n        <div class=\"price-pill ${activeClass} inline-flex items-center justify-center rounded-full px-3 py-1.5 text-xs font-bold shadow-md transition-all duration-200 cursor-pointer\" style=\"font-size: 12px; min-width: 50px; white-space: nowrap; z-index: ${zIndex};\">\n          ${isVerified ? '<span style=\"margin-right: 4px\">🛡️</span>' : ''}${priceText}\n        </div>\n      `,\n            iconSize: [isVerified ? 90 : 80, 28],\n            iconAnchor: [isVerified ? 45 : 40, 14],\n            popupAnchor: [0, -14],\n        }) as DivIcon;\n    }, [property.price, property.verification_status, isActive]);\n\n    if (!icon) return null;\n\n    return (\n        <Marker\n            position={position}\n            icon={icon}\n            zIndexOffset={property.verification_status === \"verified\" ? 100 : 0}\n            eventHandlers={{\n                click: (e) => {\n                    // Simple clic : faire défiler vers la carte dans le carousel\n                    onClick();\n                },\n                mouseover: (e) => {\n                    const target = e.target;\n                    const element = target?.getElement();\n                    if (element) {\n                        const pill = element.querySelector(\".price-pill\");\n                        if (pill && !isActive) {\n                            // Effet hover sans casser le style verified\n                            const currentBg = property.verification_status === \"verified\" ? \"bg-[#F4C430]\" : \"bg-primary\";\n                            const currentText = property.verification_status === \"verified\" ? \"text-black\" : \"text-primary-foreground\";\n\n                            pill.classList.remove(currentBg, currentText);\n                            pill.classList.add(\"bg-white\", \"text-black\", \"scale-105\");\n                        }\n                    }\n                },\n                mouseout: (e) => {\n                    const target = e.target;\n                    const element = target?.getElement();\n                    if (element) {\n                        const pill = element.querySelector(\".price-pill\");\n                        if (pill && !isActive) {\n                            pill.classList.remove(\"bg-white\", \"text-black\", \"scale-105\");\n\n                            if (property.verification_status === \"verified\") {\n                                pill.classList.add(\"bg-[#F4C430]\", \"text-black\");\n                            } else {\n                                pill.classList.add(\"bg-primary\", \"text-primary-foreground\");\n                            }\n                        }\n                    }\n                },\n            }}\n        />\n    );\n}, (prevProps, nextProps) => {\n    // Custom comparator pour éviter re-renders inutiles\n    return (\n        prevProps.property.id === nextProps.property.id &&\n        prevProps.isActive === nextProps.isActive &&\n        prevProps.property.price === nextProps.property.price &&\n        prevProps.property.verification_status === nextProps.property.verification_status\n    );\n});\n\nexport const MapView = ({ properties, showCarousel = true }: MapViewProps) => {\n    const router = useRouter();\n    const [activeId, setActiveId] = useState<string | undefined>(properties[0]?.id);\n    const [mapEnabled, setMapEnabled] = useState(true);\n    const [mounted, setMounted] = useState(true); // Déjà monté si ce composant client s'exécute\n\n    // Filtrer les propriétés qui ont des coordonnées valides\n    const propertiesWithCoords = useMemo(\n        () => {\n            const valid = properties.filter(\n                (p) =>\n                    p.location?.coords &&\n                    p.location.coords.lat !== 0 &&\n                    p.location.coords.lng !== 0\n            );\n            return valid;\n        },\n        [properties]\n    );\n\n    // Calculer le centre de la carte (moyenne des coordonnées ou Dakar par défaut)\n    const mapCenter = useMemo<LatLngExpression>(() => {\n        if (propertiesWithCoords.length === 0) return DAKAR_CENTER;\n\n        const center = propertiesWithCoords.reduce(\n            (acc, property) => {\n                acc.lat += property.location.coords.lat;\n                acc.lng += property.location.coords.lng;\n                return acc;\n            },\n            { lat: 0, lng: 0 }\n        );\n        center.lat /= propertiesWithCoords.length;\n        center.lng /= propertiesWithCoords.length;\n\n        return [center.lat, center.lng];\n    }, [propertiesWithCoords]);\n\n    // Gestion de l'activation de la carte selon le contexte\n    useEffect(() => {\n        if (typeof window === \"undefined\") return;\n\n        const enableBasedOnContext = () => {\n            const isMobile = window.matchMedia(\"(max-width: 768px)\").matches;\n            const saveData =\n                typeof navigator !== \"undefined\"\n                    ? (navigator as Navigator & {\n                        connection?: { saveData?: boolean };\n                    }).connection?.saveData\n                    : undefined;\n            // Sur desktop, activer par défaut. Sur mobile, permettre l'activation manuelle\n            setMapEnabled(!isMobile && !saveData);\n        };\n\n        enableBasedOnContext();\n\n        const media = window.matchMedia(\"(max-width: 768px)\");\n        const handler = () => enableBasedOnContext();\n        media.addEventListener(\"change\", handler);\n        return () => media.removeEventListener(\"change\", handler);\n    }, []);\n\n    const handleMarkerClick = useCallback((propertyId: string) => {\n        setActiveId(propertyId);\n        // Scroll vers la carte correspondante dans le carousel\n        setTimeout(() => {\n            const element = document.getElementById(`property-${propertyId}`);\n            if (element) {\n                element.scrollIntoView({ behavior: \"smooth\", block: \"nearest\", inline: \"center\" });\n            }\n        }, 100);\n    }, []);\n\n    const handleMarkerRedirect = useCallback((propertyId: string) => {\n        // Rediriger vers la page de détail du bien\n        router.push(`/biens/${propertyId}`);\n    }, [router]);\n\n    if (!mounted) {\n        return (\n            <div className=\"flex h-[70vh] items-center justify-center rounded-[32px] border border-white/10 bg-white/5 text-white/70\">\n                Chargement de la carte…\n            </div>\n        );\n    }\n\n    if (properties.length === 0) {\n        return (\n            <div className=\"flex h-[70vh] items-center justify-center rounded-[32px] border border-white/10 bg-white/5 text-white/70\">\n                Aucun bien ne correspond à ta recherche.\n            </div>\n        );\n    }\n\n    if (propertiesWithCoords.length === 0) {\n        return (\n            <div className=\"flex h-[70vh] items-center justify-center rounded-[32px] border border-white/10 bg-white/5 text-white/70\">\n                <div className=\"text-center\">\n                    <p className=\"mb-2\">Aucune coordonnée disponible pour afficher la carte.</p>\n                    <p className=\"text-sm text-white/50\">\n                        Les biens n&apos;ont pas de localisation géographique.\n                    </p>\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"relative h-[70vh] w-full overflow-hidden rounded-[32px] border border-white/10 bg-black/20\">\n            {mapEnabled ? (\n                <MapContainer\n                    center={mapCenter}\n                    zoom={DEFAULT_ZOOM}\n                    scrollWheelZoom={false} // Désactiver le zoom molette pour ne pas gêner le scroll\n                    className=\"h-full w-full rounded-[32px] z-0\"\n                    style={{ height: \"100%\", width: \"100%\", zIndex: 0 }}\n                    zoomControl={true}\n                    attributionControl={false}\n                >\n                    {/* TileLayer CartoDB Dark Matter */}\n                    <TileLayer\n                        url=\"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png\"\n                        attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors &copy; <a href=\"https://carto.com/attributions\">CARTO</a>'\n                        subdomains=\"abcd\"\n                        maxZoom={19}\n                    />\n\n                    {/* Centrer la carte */}\n                    <MapCenter center={mapCenter} zoom={DEFAULT_ZOOM} />\n\n                    {/* Marqueurs avec prix */}\n                    {propertiesWithCoords.map((property) => (\n                        <PriceMarker\n                            key={property.id}\n                            property={property}\n                            isActive={property.id === activeId}\n                            onClick={() => handleMarkerClick(property.id)}\n                            onRedirect={() => handleMarkerRedirect(property.id)}\n                        />\n                    ))}\n                </MapContainer>\n            ) : (\n                <div className=\"flex h-full flex-col items-center justify-center gap-3 text-center text-white/70\">\n                    <p>Mode économie de données activé sur mobile.</p>\n                    <Button\n                        className=\"rounded-full px-4 py-2 hover:bg-primary/90\"\n                        onClick={() => {\n                            console.log(\"🔄 Activation manuelle de la carte\");\n                            setMapEnabled(true);\n                        }}\n                    >\n                        Charger la carte\n                    </Button>\n                </div>\n            )}\n\n            {/* Carousel des biens en bas - Optimisé: affiche seulement les 10 premiers + actif */}\n            {showCarousel && propertiesWithCoords.length > 0 && (\n                <div className=\"pointer-events-none absolute inset-x-0 bottom-4 px-4 z-10\">\n                    <div className=\"pointer-events-auto scrollbar-hide flex gap-3 overflow-x-auto pb-2\">\n                        {propertiesWithCoords.slice(0, 15).map((property) => (\n                            <div\n                                key={`mini-${property.id}`}\n                                id={`property-${property.id}`}\n                                onClick={() => {\n                                    // Rediriger vers la page de détail du bien\n                                    handleMarkerRedirect(property.id);\n                                }}\n                                className=\"min-w-[280px] cursor-pointer flex-shrink-0\"\n                            >\n                                <PropertyCard\n                                    property={property}\n                                    variant=\"horizontal\"\n                                    className={\n                                        property.id === activeId\n                                            ? \"bg-[#F4C430]/15 border-[#F4C430] shadow-[0_0_15px_rgba(244,196,48,0.15)] transition-all duration-300\"\n                                            : \"bg-neutral-900/60 backdrop-blur-md border border-white/10 hover:bg-neutral-900/80 transition-all duration-300\"\n                                    }\n                                />\n                            </div>\n                        ))}\n                        {propertiesWithCoords.length > 15 && (\n                            <div className=\"min-w-[280px] flex-shrink-0 flex items-center justify-center rounded-[28px] border border-white/10 bg-white/5 p-6 text-center text-white/70\">\n                                <p className=\"text-sm\">+{propertiesWithCoords.length - 15} autres biens</p>\n                            </div>\n                        )}\n                    </div>\n                </div>\n            )}\n\n            {/* Styles CSS pour la carte Leaflet */}\n            <style jsx global>{`\n        .leaflet-container {\n          background: #1a1a1a;\n        }\n        .custom-price-marker {\n          background: transparent !important;\n          border: none !important;\n        }\n        .price-pill {\n          user-select: none;\n          pointer-events: none;\n        }\n        .leaflet-control-zoom {\n          border: none;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);\n          margin-bottom: 200px;\n        }\n        .leaflet-control-zoom a {\n          background-color: rgba(255, 255, 255, 0.1);\n          color: white;\n          border: 1px solid rgba(255, 255, 255, 0.2);\n        }\n        .leaflet-control-zoom a:hover {\n          background-color: rgba(255, 255, 255, 0.2);\n        }\n        .leaflet-control-attribution {\n          background-color: rgba(0, 0, 0, 0.5);\n          color: rgba(255, 255, 255, 0.7);\n          font-size: 10px;\n        }\n        .leaflet-control-attribution a {\n          color: rgba(255, 255, 255, 0.8);\n        }\n        /* Styles pour les clusters */\n        .custom-cluster-icon {\n          background: transparent !important;\n          border: none !important;\n        }\n        .cluster-pill {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          width: 50px;\n          height: 50px;\n          border-radius: 50%;\n          font-weight: bold;\n          color: white;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n          transition: all 0.2s ease;\n        }\n        .cluster-pill:hover {\n          transform: scale(1.1);\n        }\n        .marker-cluster-small {\n          background: linear-gradient(135deg, #F4C430 0%, #D4A028 100%);\n          border: 2px solid rgba(255, 255, 255, 0.3);\n        }\n        .marker-cluster-medium {\n          background: linear-gradient(135deg, #D4A028 0%, #B48820 100%);\n          border: 2px solid rgba(255, 255, 255, 0.4);\n          width: 60px;\n          height: 60px;\n        }\n        .marker-cluster-large {\n          background: linear-gradient(135deg, #B48820 0%, #947018 100%);\n          border: 2px solid rgba(255, 255, 255, 0.5);\n          width: 70px;\n          height: 70px;\n          font-size: 18px;\n        }\n      `}</style>\n        </div>\n    );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\quick-search.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\search-experience.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'filters' and 'setFilters'. Either include them or remove the dependency array.","line":79,"column":6,"nodeType":"ArrayExpression","endLine":79,"endColumn":28,"suggestions":[{"desc":"Update the dependencies array to be: [debouncedSearchQuery, filters, setFilters]","fix":{"range":[3061,3083],"text":"[debouncedSearchQuery, filters, setFilters]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback, useMemo } from \"react\";\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport dynamic from \"next/dynamic\";\r\nimport { Filter, Map, Search as SearchIcon, Bell } from \"lucide-react\";\r\n\r\nimport { PropertyCard } from \"@/components/property/property-card\";\r\nimport { FilterDrawer } from \"@/components/search/filter-drawer\";\r\nimport { CreateAlertDialog } from \"@/components/search/create-alert-dialog\";\r\nimport { EmptyState } from \"@/components/ui/empty-state\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { useAuth } from \"@/hooks/use-auth\";\r\nimport { useDebounce } from \"@/hooks/use-debounce\";\r\nimport type { Property } from \"@/types/property\";\r\nimport { hasActiveFilters } from \"@/lib/search-filters\";\r\nimport { useSearchFilters } from \"@/hooks/use-search-filters\";\r\nimport { getProperties, type PropertyFilters } from \"@/services/propertyService\";\r\n\r\nconst MapView = dynamic(\r\n  () => import(\"@/components/search/map-view\").then((mod) => mod.MapView),\r\n  {\r\n    ssr: false,\r\n    loading: () => (\r\n      <div className=\"flex h-[70vh] items-center justify-center rounded-[32px] border border-white/10 bg-white/5 text-white/70\">\r\n        Chargement de la carte…\r\n      </div>\r\n    ),\r\n  }\r\n);\r\n\r\ntype SearchExperienceProps = {\r\n  initialFilters: PropertyFilters;\r\n  initialResults: Property[];\r\n};\r\n\r\nexport const SearchExperience = ({\r\n  initialFilters,\r\n  initialResults,\r\n}: SearchExperienceProps) => {\r\n  const searchParams = useSearchParams();\r\n  const { user } = useAuth();\r\n  const { filters, setFilters } = useSearchFilters(initialFilters);\r\n  const [view, setView] = useState<\"list\" | \"map\">(\"list\");\r\n  const [drawerOpen, setDrawerOpen] = useState(false);\r\n  const [alertDialogOpen, setAlertDialogOpen] = useState(false);\r\n  const [results, setResults] = useState<Property[]>(initialResults);\r\n  const [isSearching, setIsSearching] = useState(false);\r\n  const [searchQuery, setSearchQuery] = useState(filters.q ?? \"\");\r\n\r\n  // Debounce de la recherche textuelle (500ms)\r\n  const debouncedSearchQuery = useDebounce(searchQuery, 500);\r\n\r\n  const activeFilters = hasActiveFilters(filters);\r\n\r\n  // Ouvrir le dialog de création d'alerte si ?alert=create est présent\r\n  useEffect(() => {\r\n    const shouldOpenAlert = searchParams.get(\"alert\") === \"create\" && !!user;\r\n    if (shouldOpenAlert) {\r\n      // Utiliser setTimeout pour éviter setState synchrone dans useEffect\r\n      setTimeout(() => setAlertDialogOpen(true), 0);\r\n    }\r\n  }, [searchParams, user]);\r\n\r\n  // Effet pour appliquer la recherche debouncée\r\n  useEffect(() => {\r\n    if (debouncedSearchQuery !== filters.q) {\r\n      const searchFilters = async () => {\r\n        setIsSearching(true);\r\n        const nextFilters = { ...filters, q: debouncedSearchQuery || undefined };\r\n        setFilters(nextFilters);\r\n        const data = await getProperties(nextFilters);\r\n        setResults(data);\r\n        setIsSearching(false);\r\n      };\r\n      searchFilters();\r\n    }\r\n  }, [debouncedSearchQuery]); // Exclure filters et setFilters des dépendances pour éviter les boucles\r\n\r\n  const applyFilters = useCallback(async (nextFilters: PropertyFilters) => {\r\n    setIsSearching(true);\r\n    setFilters(nextFilters);\r\n    const data = await getProperties(nextFilters);\r\n    setResults(data);\r\n    setIsSearching(false);\r\n  }, [setFilters]);\r\n\r\n  // Mémoiser le nombre de résultats\r\n  const resultCount = useMemo(() => results.length, [results.length]);\r\n\r\n  return (\r\n    <div className=\"relative space-y-6 pb-32\">\r\n      <div className=\"rounded-[28px] border border-white/5 bg-black/40 p-4 backdrop-blur-xl\">\r\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\r\n          <div className=\"flex flex-1 items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-2\">\r\n            <SearchIcon className={`h-5 w-5 ${isSearching ? \"text-primary animate-pulse\" : \"text-white/50\"}`} />\r\n            <Input\r\n              value={searchQuery}\r\n              onChange={(event) => setSearchQuery(event.target.value)}\r\n              placeholder=\"Ville ou code postal\"\r\n              className=\"border-none bg-transparent p-0 text-white placeholder:text-white/50 focus-visible:ring-0\"\r\n            />\r\n          </div>\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"secondary\"\r\n            className=\"rounded-2xl border border-white/10 bg-white/10 text-white\"\r\n            onClick={() => setDrawerOpen(true)}\r\n          >\r\n            <Filter className=\"mr-2 h-4 w-4\" />\r\n            Filtres\r\n            {activeFilters && (\r\n              <span className=\"ml-2 rounded-full bg-primary px-2 py-0.5 text-xs font-semibold text-primary-foreground\">\r\n                ●\r\n              </span>\r\n            )}\r\n          </Button>\r\n          {user && (\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"secondary\"\r\n              className=\"rounded-2xl border border-white/10 bg-white/10 text-white\"\r\n              onClick={() => setAlertDialogOpen(true)}\r\n            >\r\n              <Bell className=\"mr-2 h-4 w-4\" />\r\n              Créer une alerte\r\n            </Button>\r\n          )}\r\n        </div>\r\n        <p className=\"mt-3 text-sm text-white/60\">\r\n          {isSearching ? (\r\n            <span className=\"animate-pulse\">Recherche en cours...</span>\r\n          ) : (\r\n            <>{resultCount} bien{resultCount > 1 ? \"s\" : \"\"} trouvé{resultCount > 1 ? \"s\" : \"\"}</>\r\n          )}\r\n        </p>\r\n      </div>\r\n\r\n      {view === \"list\" ? (\r\n        results.length === 0 ? (\r\n          <EmptyState\r\n            title=\"Aucun bien ne correspond à vos critères.\"\r\n            description={\r\n              activeFilters\r\n                ? \"Essayez de modifier vos critères de recherche ou de réinitialiser les filtres pour voir plus de résultats.\"\r\n                : \"Nous ajoutons régulièrement de nouveaux biens. Revenez bientôt pour découvrir les dernières offres !\"\r\n            }\r\n            actionLabel={activeFilters ? \"Réinitialiser les filtres\" : undefined}\r\n            onAction={\r\n              activeFilters\r\n                ? () => {\r\n                    const clearedFilters: PropertyFilters = {};\r\n                    setFilters(clearedFilters);\r\n                    applyFilters(clearedFilters);\r\n                  }\r\n                : undefined\r\n            }\r\n            variant=\"default\"\r\n          />\r\n        ) : (\r\n          <div className=\"grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 [&>*]:w-full\">\r\n            {results.map((property) => (\r\n              <PropertyCard key={property.id} property={property} />\r\n            ))}\r\n          </div>\r\n        )\r\n      ) : (\r\n        <MapView properties={results} />\r\n      )}\r\n\r\n      <Button\r\n        type=\"button\"\r\n        className=\"fixed bottom-28 right-6 z-30 rounded-full px-5 py-3 shadow-xl md:bottom-8\"\r\n        onClick={() => setView((prev) => (prev === \"list\" ? \"map\" : \"list\"))}\r\n      >\r\n        {view === \"list\" ? (\r\n          <>\r\n            <Map className=\"mr-2 h-4 w-4\" /> Vue carte\r\n          </>\r\n        ) : (\r\n          <>\r\n            <SearchIcon className=\"mr-2 h-4 w-4\" /> Vue liste\r\n          </>\r\n        )}\r\n      </Button>\r\n\r\n      <FilterDrawer\r\n        open={drawerOpen}\r\n        onOpenChange={setDrawerOpen}\r\n        filters={filters}\r\n        onApply={applyFilters}\r\n      />\r\n\r\n      {user && (\r\n        <CreateAlertDialog\r\n          open={alertDialogOpen}\r\n          onOpenChange={setAlertDialogOpen}\r\n          filters={filters}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\sections\\hero.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\sections\\new-properties.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\sections\\property-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\seo\\JsonLd.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\breadcrumbs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\captcha.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\command.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":26,"column":11,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":26,"endColumn":29,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[715,766],"text":"type CommandDialogProps = DialogProps"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\ninterface CommandDialogProps extends DialogProps {}\n\nconst CommandDialog = ({ children, ...props }: CommandDialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b border-white/10 px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50 text-white\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm text-white outline-none placeholder:text-white/50 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm text-white/50\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm text-white outline-none aria-selected:bg-white/10 aria-selected:text-white data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\cookie-consent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\empty-state.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\info-tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\input-otp.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\input.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[261,264],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[261,264],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport * as React from \"react\";\nimport { motion } from \"framer-motion\";\n\nimport { cn } from \"@/lib/utils\";\n\nexport type InputProps = Omit<\n  React.InputHTMLAttributes<HTMLInputElement>,\n  \"onDrag\" | \"onDragStart\" | \"onDragEnd\"\n> & { whileFocus?: any };\n\nexport const Input = React.forwardRef<HTMLInputElement, InputProps>(\n  ({ className, type = \"text\", ...props }, ref) => {\n    return (\n      <motion.input\n        type={type}\n        className={cn(\n          \"flex h-12 w-full rounded-2xl border border-white/10 bg-white/5 px-4 text-[16px] text-white transition-all duration-200 placeholder:text-white/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/40 focus-visible:border-white/30\",\n          className\n        )}\n        ref={ref}\n        whileFocus={{\n          scale: 1.01,\n        }}\n        transition={{\n          type: \"spring\",\n          stiffness: 400,\n          damping: 30,\n        }}\n        {...(props as React.ComponentPropsWithoutRef<typeof motion.input>)}\n      />\n    );\n  }\n);\nInput.displayName = \"Input\";\n\n\n\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\loader-blueprint.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\motion-wrapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\optimized-image.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\otp-input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\phone-input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\splash-screen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\stagger-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\toggle-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\touchable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\verified-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\wizard\\estimation-wizard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\config\\roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\constants\\coordinates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\constants\\senegal.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\data\\properties.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\debug-property.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\listing-approved-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\listing-rejected-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\listing-submitted-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\verification-email.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Img' is defined but never used.","line":10,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  Html,\r\n  Head,\r\n  Body,\r\n  Container,\r\n  Section,\r\n  Text,\r\n  Button,\r\n  Hr,\r\n  Img,\r\n} from \"@react-email/components\";\r\n\r\ninterface VerificationEmailProps {\r\n  userName: string;\r\n  verificationUrl: string;\r\n}\r\n\r\nexport function VerificationEmail({\r\n  userName,\r\n  verificationUrl,\r\n}: VerificationEmailProps) {\r\n  return (\r\n    <Html lang=\"fr\">\r\n      <Head />\r\n      <Body style={main}>\r\n        <Container style={container}>\r\n          <Section style={header}>\r\n            <Text style={logo}>Doussel Immo</Text>\r\n            <Text style={tagline}>Votre partenaire immobilier à Dakar</Text>\r\n          </Section>\r\n\r\n          <Section style={content}>\r\n            <Text style={title}>Bienvenue sur Doussel Immo ! 👋</Text>\r\n\r\n            <Text style={text}>\r\n              Bonjour <strong>{userName}</strong>,\r\n            </Text>\r\n\r\n            <Text style={text}>\r\n              Merci de vous être inscrit sur Doussel Immo. Pour finaliser votre\r\n              inscription et accéder à toutes les fonctionnalités, veuillez\r\n              confirmer votre adresse email en cliquant sur le bouton ci-dessous.\r\n            </Text>\r\n\r\n            <Section style={buttonContainer}>\r\n              <Button style={button} href={verificationUrl}>\r\n                Confirmer mon email\r\n              </Button>\r\n            </Section>\r\n\r\n            <Text style={text}>\r\n              Si le bouton ne fonctionne pas, copiez et collez ce lien dans votre\r\n              navigateur :\r\n            </Text>\r\n\r\n            <Text style={link}>{verificationUrl}</Text>\r\n\r\n            <Hr style={hr} />\r\n\r\n            <Text style={footer}>\r\n              Ce lien est valide pendant 24 heures. Si vous n&apos;avez pas créé de\r\n              compte sur Doussel Immo, vous pouvez ignorer cet email.\r\n            </Text>\r\n\r\n            <Text style={footer}>\r\n              Pour toute question, contactez-nous à{\" \"}\r\n              <a href=\"mailto:support@dousell-immo.app\" style={linkStyle}>\r\n                support@dousell-immo.app\r\n              </a>\r\n            </Text>\r\n          </Section>\r\n\r\n          <Section style={footerSection}>\r\n            <Text style={footerText}>\r\n              <strong>Doussel Immo</strong>\r\n            </Text>\r\n            <Text style={footerText}>Dakar, Sénégal</Text>\r\n            <Text style={footerText}>\r\n              © {new Date().getFullYear()} Doussel Immo. Tous droits réservés.\r\n            </Text>\r\n          </Section>\r\n        </Container>\r\n      </Body>\r\n    </Html>\r\n  );\r\n}\r\n\r\n// Styles\r\nconst main = {\r\n  backgroundColor: \"#05080c\",\r\n  fontFamily:\r\n    '-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Ubuntu,sans-serif',\r\n};\r\n\r\nconst container = {\r\n  backgroundColor: \"#ffffff\",\r\n  margin: \"0 auto\",\r\n  padding: \"0\",\r\n  marginBottom: \"64px\",\r\n  maxWidth: \"600px\",\r\n  borderRadius: \"8px\",\r\n  overflow: \"hidden\",\r\n};\r\n\r\nconst header = {\r\n  backgroundColor: \"#f59e0b\",\r\n  padding: \"32px 40px\",\r\n  textAlign: \"center\" as const,\r\n};\r\n\r\nconst logo = {\r\n  color: \"#ffffff\",\r\n  fontSize: \"28px\",\r\n  fontWeight: \"bold\",\r\n  margin: \"0 0 8px 0\",\r\n};\r\n\r\nconst tagline = {\r\n  color: \"#ffffff\",\r\n  fontSize: \"14px\",\r\n  margin: \"0\",\r\n  opacity: 0.9,\r\n};\r\n\r\nconst content = {\r\n  padding: \"40px\",\r\n};\r\n\r\nconst title = {\r\n  color: \"#05080c\",\r\n  fontSize: \"24px\",\r\n  fontWeight: \"bold\",\r\n  margin: \"0 0 24px 0\",\r\n};\r\n\r\nconst text = {\r\n  color: \"#333333\",\r\n  fontSize: \"16px\",\r\n  lineHeight: \"24px\",\r\n  margin: \"0 0 16px 0\",\r\n};\r\n\r\nconst buttonContainer = {\r\n  textAlign: \"center\" as const,\r\n  margin: \"32px 0\",\r\n};\r\n\r\nconst button = {\r\n  backgroundColor: \"#f59e0b\",\r\n  borderRadius: \"6px\",\r\n  color: \"#ffffff\",\r\n  fontSize: \"16px\",\r\n  fontWeight: \"bold\",\r\n  textDecoration: \"none\",\r\n  textAlign: \"center\" as const,\r\n  display: \"inline-block\",\r\n  padding: \"14px 32px\",\r\n};\r\n\r\nconst link = {\r\n  color: \"#f59e0b\",\r\n  fontSize: \"14px\",\r\n  wordBreak: \"break-all\" as const,\r\n  margin: \"16px 0\",\r\n};\r\n\r\nconst linkStyle = {\r\n  color: \"#f59e0b\",\r\n  textDecoration: \"underline\",\r\n};\r\n\r\nconst hr = {\r\n  borderColor: \"#e5e7eb\",\r\n  margin: \"32px 0\",\r\n};\r\n\r\nconst footer = {\r\n  color: \"#666666\",\r\n  fontSize: \"14px\",\r\n  lineHeight: \"20px\",\r\n  margin: \"16px 0 0 0\",\r\n};\r\n\r\nconst footerSection = {\r\n  backgroundColor: \"#f9fafb\",\r\n  padding: \"24px 40px\",\r\n  textAlign: \"center\" as const,\r\n};\r\n\r\nconst footerText = {\r\n  color: \"#666666\",\r\n  fontSize: \"12px\",\r\n  margin: \"4px 0\",\r\n};\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\visit-request-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-cookie-consent.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-debounce.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-scroll-position.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-search-filters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-user-roles.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'payload' is defined but never used.","line":144,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":144,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState, useCallback } from \"react\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport type { RealtimeChannel } from \"@supabase/supabase-js\";\n\nexport type UserRole = \"admin\" | \"moderateur\" | \"agent\" | \"superadmin\";\n\n/**\n * Hook pour gérer les rôles utilisateur avec Supabase Realtime\n */\nexport function useUserRoles(userId: string | null) {\n  const [roles, setRoles] = useState<UserRole[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const fetchRoles = useCallback(async () => {\n    if (!userId) {\n      setRoles([]);\n      setLoading(false);\n      return;\n    }\n\n    try {\n      const supabase = createClient();\n\n      // Vérifier que l'utilisateur est bien authentifié\n      const {\n        data: { user },\n        error: authError,\n      } = await supabase.auth.getUser();\n\n      if (authError || !user) {\n        console.warn(\"User not authenticated, skipping roles fetch\");\n        setRoles([]);\n        setLoading(false);\n        return;\n      }\n\n      // Récupérer les rôles de l'utilisateur\n      // Essayer d'abord la fonction RPC (bypass RLS)\n      const { data: rpcData, error: rpcError } = await supabase.rpc(\"get_user_roles\", {\n        target_user_id: userId,\n      });\n\n      if (!rpcError && rpcData && Array.isArray(rpcData)) {\n        // Si la fonction RPC existe et retourne des données (même si vide)\n        const userRoles = rpcData as UserRole[];\n        setRoles(userRoles);\n        setError(null);\n        setLoading(false);\n        return;\n      }\n\n      // Si la fonction RPC n'existe pas, logger un avertissement\n      if (rpcError && (rpcError.code === \"42883\" || rpcError.message?.includes(\"does not exist\") || rpcError.message?.includes(\"function\"))) {\n        console.warn(\"⚠️ useUserRoles - Fonction RPC get_user_roles n'existe pas. Utilisation du fallback pour:\", userId);\n      } else if (rpcError) {\n        console.warn(\"⚠️ useUserRoles - Erreur RPC get_user_roles:\", rpcError);\n      }\n\n      // Fallback: Requête directe\n      const { data, error: fetchError } = await supabase\n        .from(\"user_roles\")\n        .select(\"role\")\n        .eq(\"user_id\", userId);\n\n      if (fetchError) {\n        // Si la table n'existe pas encore, on ignore silencieusement\n        if (\n          fetchError.code === \"PGRST116\" || \n          fetchError.code === \"42P01\" ||\n          fetchError.code === \"PGRST301\" ||\n          fetchError.message?.includes(\"does not exist\") ||\n          fetchError.message?.includes(\"relation\") ||\n          fetchError.message?.includes(\"permission denied\") ||\n          fetchError.message?.includes(\"row-level security\") ||\n          Object.keys(fetchError).length === 0 // Erreur vide (probablement RLS)\n        ) {\n          // Si l'erreur est vide ou indique que la table n'existe pas, retourner un tableau vide\n          console.warn(\"⚠️ user_roles table may not exist or RLS is blocking access. Error:\", {\n            code: fetchError.code,\n            message: fetchError.message,\n            keys: Object.keys(fetchError),\n          });\n          setRoles([]);\n          setError(null);\n          setLoading(false);\n          return;\n        }\n        \n        // Pour les autres erreurs, logger mais ne pas bloquer\n        console.warn(\"⚠️ Erreur lors de la récupération des rôles:\", {\n          code: fetchError.code,\n          message: fetchError.message,\n          details: fetchError.details,\n        });\n        setRoles([]);\n        setError(null);\n        setLoading(false);\n        return;\n      }\n\n      const userRoles = (data?.map((r) => r.role as UserRole) || []) as UserRole[];\n      setRoles(userRoles);\n      setError(null);\n    } catch (err) {\n      console.error(\"Error fetching user roles:\", err);\n      setError(err instanceof Error ? err.message : \"Erreur inconnue\");\n      setRoles([]);\n    } finally {\n      setLoading(false);\n    }\n  }, [userId]);\n\n  useEffect(() => {\n    if (!userId) {\n      setLoading(false);\n      return;\n    }\n\n    // Récupération initiale\n    fetchRoles();\n\n    // Configurer Supabase Realtime pour écouter les changements de rôles\n    let channel: RealtimeChannel | null = null;\n    let subscribed = false; // Utiliser une variable dans la portée du useEffect\n\n    const setupRealtime = () => {\n      try {\n        const supabase = createClient();\n        \n        // S'abonner aux changements sur la table user_roles pour cet utilisateur\n        channel = supabase\n          .channel(`user_roles:${userId}`)\n          .on(\n            \"postgres_changes\",\n            {\n              event: \"*\", // INSERT, UPDATE, DELETE\n              schema: \"public\",\n              table: \"user_roles\",\n              filter: `user_id=eq.${userId}`,\n            },\n            (payload) => {\n              // Rafraîchir les rôles quand un changement est détecté\n              fetchRoles();\n            }\n          )\n          .subscribe((status) => {\n            if (status === \"SUBSCRIBED\") {\n              subscribed = true;\n              // Abonnement réussi - pas besoin de logger\n            } else if (status === \"CHANNEL_ERROR\" && !subscribed) {\n              // Ne logger l'erreur que si on n'a jamais réussi à s'abonner\n              // (évite les faux positifs lors des états transitoires)\n              console.warn(\"⚠️ Impossible de s'abonner aux changements de rôles. Realtime peut ne pas être activé pour la table user_roles.\");\n            }\n          });\n      } catch (err) {\n        console.warn(\"Erreur lors de la configuration Realtime pour les rôles:\", err);\n        // Ne pas bloquer l'application si Realtime n'est pas disponible\n      }\n    };\n\n    setupRealtime();\n\n    // Nettoyer l'abonnement au démontage\n    return () => {\n      if (channel) {\n        const supabase = createClient();\n        supabase.removeChannel(channel);\n      }\n    };\n  }, [userId, fetchRoles]);\n\n  return { roles, loading, error, refetch: fetchRoles };\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\actions\\contract-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ContractCustomTexts' is defined but never used.","line":12,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4549,4552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4549,4552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":113,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":116,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4597,4600],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4597,4600],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4667,4670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4667,4670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4709,4712],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4709,4712],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":135,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4783,4786],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4783,4786],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":135,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4806,4809],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4806,4809],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":209,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7276,7279],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7276,7279],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":209,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7296,7299],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7296,7299],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":365,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":365,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11962,11965],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11962,11965],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":365,"column":113,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":365,"endColumn":116,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12010,12013],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12010,12013],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":366,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":366,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12074,12077],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12074,12077],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":367,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":367,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12219,12222],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12219,12222],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":367,"column":153,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":367,"endColumn":156,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12328,12331],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12328,12331],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\n/**\n * Server Actions pour la génération de contrats de bail\n * Conforme aux règles Doussel Immo (CLAUDE.md)\n */\n\nimport { createClient as createServerClient } from '@/utils/supabase/server';\n// import { getCurrentUser } from '@/lib/auth'; // Deprecated in Server Actions\nimport { generateLeasePDF, uploadPDFToStorage } from '@/lib/pdf-generator';\nimport { ContractData } from '@/lib/contract-template';\nimport { ContractCustomTexts } from '@/lib/contract-defaults';\nimport { z, ZodError } from 'zod'; // Import ZodError\nimport { revalidatePath } from 'next/cache';\nimport { differenceInMonths, addDays } from 'date-fns';\n\n// Schéma de validation Zod pour la génération de contrat\nconst GenerateContractSchema = z.object({\n  leaseId: z.string().uuid('ID de bail invalide'),\n  includeWatermark: z.boolean().optional(),\n  watermarkText: z.string().optional(),\n  customTexts: z.any().optional(),\n  preview: z.boolean().optional(),\n});\n\ntype GenerateContractInput = z.infer<typeof GenerateContractSchema>;\n\ninterface GenerateContractResult {\n  success: boolean;\n  contractUrl?: string;\n  pdfBase64?: string;\n  error?: string;\n}\n\n/**\n * Génère un contrat de bail PDF à partir d'un lease ID\n */\nexport async function generateLeaseContract(\n  input: GenerateContractInput\n): Promise<GenerateContractResult> {\n  try {\n    // 1. Validation des données\n    const validated = GenerateContractSchema.parse(input);\n    const { leaseId, includeWatermark = false, watermarkText = 'BROUILLON', customTexts = {}, preview = false } = validated;\n\n    // 2. Vérification de l'utilisateur\n    const supabase = await createServerClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n      return { success: false, error: 'Non authentifié' };\n    }\n\n    // 3. Récupérer les données du bail et profil propriétaire\n    // const supabase = await createServerClient(); // Déjà créé plus haut\n\n    const { data: lease, error: leaseError } = await supabase\n      .from('leases')\n      .select(`\n        id,\n        owner_id,\n        property_id,\n        tenant_name,\n        tenant_email,\n        tenant_phone,\n        monthly_amount,\n        start_date,\n        end_date,\n        billing_day,\n        property_address,\n        properties (\n          id,\n          title,\n          location,\n          description,\n          property_type\n        )\n      `)\n      .eq('id', leaseId)\n      .single();\n\n    if (leaseError || !lease) {\n      console.error(\"Erreur récupération bail:\", leaseError);\n      return {\n        success: false,\n        error: leaseError ? `Erreur technique: ${leaseError.message}` : 'Bail introuvable (ID inconnu)'\n      };\n    }\n\n    // 4. Vérifier que l'utilisateur est bien le propriétaire\n    if (lease.owner_id !== user.id) {\n      return { success: false, error: 'Non autorisé: vous n\\'êtes pas le propriétaire de ce bail' };\n    }\n\n    // 5. Récupérer les informations du propriétaire\n    const { data: profile, error: profileError } = await supabase\n      .from('profiles')\n      .select('full_name, phone, company_name, company_address, company_phone, company_email, company_ninea, logo_url, signature_url')\n      .eq('id', user.id)\n      .single();\n\n    if (profileError || !profile) {\n      console.error(\"Erreur récupération profil:\", profileError);\n      return {\n        success: false,\n        error: profileError ? `Erreur technique profil: ${profileError.message}` : 'Profil propriétaire introuvable'\n      };\n    }\n\n    // Extraction nom/prénom depuis full_name\n    const fullName = profile.full_name || '';\n    const firstName = fullName.split(' ')[0] || '';\n    const lastName = fullName.split(' ').slice(1).join(' ') || '';\n\n    // 6. Mapper les données vers le format ContractData\n    const contractData: ContractData = {\n      landlord: {\n        firstName: firstName,\n        lastName: lastName,\n        address: profile.company_address || 'Adresse non spécifiée',\n        phone: profile.company_phone || profile.phone || '', // Priorité tel pro\n        email: profile.company_email || user.email || '', // Priorité email pro\n        companyName: profile.company_name || undefined,\n        ninea: profile.company_ninea || undefined,\n      },\n      tenant: {\n        firstName: lease.tenant_name?.split(' ')[0] || 'Prénom',\n        lastName: lease.tenant_name?.split(' ').slice(1).join(' ') || 'Nom',\n        phone: lease.tenant_phone || '',\n        email: lease.tenant_email || undefined,\n      },\n      property: {\n        address: lease.property_address || (lease.properties as any)?.location?.address || (lease.properties as any)?.location?.city || '',\n        description: (lease.properties as any)?.description || (lease.properties as any)?.title || 'Non spécifié',\n        propertyType: (lease.properties as any)?.property_type as any || undefined,\n      },\n      lease: {\n        monthlyRent: Number(lease.monthly_amount),\n        securityDeposit: Number(lease.monthly_amount) * 2, // Par défaut 2 mois (max légal)\n        depositMonths: 2,\n        startDate: new Date(lease.start_date),\n        duration: lease.end_date\n          ? differenceInMonths(addDays(new Date(lease.end_date), 1), new Date(lease.start_date))\n          : 12, // Défaut 12 mois si pas de date de fin\n        billingDay: lease.billing_day || 5,\n      },\n      signatures: {\n        landlordSignatureUrl: profile.signature_url || undefined,\n        signatureDate: new Date(),\n        signatureCity: 'Dakar', // À rendre configurable\n      },\n    };\n\n    // 7. Générer le PDF\n    const pdfResult = await generateLeasePDF(contractData, customTexts, {\n      includeWatermark,\n      watermarkText: includeWatermark ? watermarkText : undefined,\n      logoUrl: profile.logo_url || undefined,\n    });\n\n    if (!pdfResult.success || !pdfResult.pdfBytes) {\n      return { success: false, error: pdfResult.error || 'Erreur génération PDF' };\n    }\n\n    // SI MODE PREVIEW: Retourner le base64 sans uploader\n    if (preview) {\n      const base64 = Buffer.from(pdfResult.pdfBytes).toString('base64');\n      return {\n        success: true,\n        pdfBase64: base64\n      };\n    }\n\n    // 8. Upload vers Supabase Storage\n    // IMPORTANT: Le chemin DOIT commencer par user.id pour passer la RLS\n    const filename = `${user.id}/contract-${leaseId}.pdf`;\n    const uploadResult = await uploadPDFToStorage(pdfResult.pdfBytes, filename, supabase);\n\n    if (!uploadResult.success) {\n      return { success: false, error: uploadResult.error || 'Erreur upload PDF' };\n    }\n\n    // 9. Mettre à jour le lease avec l'URL du contrat\n    const { error: updateError } = await supabase\n      .from('leases')\n      .update({ lease_pdf_url: uploadResult.url })\n      .eq('id', leaseId);\n\n    if (updateError) {\n      console.error('Erreur mise à jour lease:', updateError);\n      // On continue quand même, le PDF est généré\n    }\n\n    // 10. Revalidation\n    revalidatePath('/compte/(gestion)/locataires');\n    revalidatePath(`/compte/(gestion)/locataires/${leaseId}`);\n\n    return {\n      success: true,\n      contractUrl: uploadResult.url,\n    };\n\n  } catch (error) {\n    console.error('Erreur generateLeaseContract:', error);\n\n    if (error instanceof ZodError) {\n      return {\n        success: false,\n        error: `Validation échouée: ${(error as any).issues.map((e: any) => e.message).join(', ')}`\n      };\n    }\n\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n\n/**\n * Télécharge le contrat existant d'un bail\n */\nexport async function downloadLeaseContract(leaseId: string): Promise<{\n  success: boolean;\n  url?: string;\n  error?: string;\n}> {\n  try {\n    // 1. Vérification de l'utilisateur\n    const supabase = await createServerClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n      return { success: false, error: 'Non authentifié' };\n    }\n\n    // 2. Récupérer le bail\n    // const supabase = await createServerClient(); // Déjà créé\n    const { data: lease, error } = await supabase\n      .from('leases')\n      .select('id, owner_id, lease_pdf_url')\n      .eq('id', leaseId)\n      .single();\n\n    if (error || !lease) {\n      return { success: false, error: 'Bail introuvable' };\n    }\n\n    // 3. Vérifier les permissions\n    if (lease.owner_id !== user.id) {\n      return { success: false, error: 'Non autorisé' };\n    }\n\n    // 4. Vérifier qu'un contrat existe\n    if (!lease.lease_pdf_url) {\n      return { success: false, error: 'Aucun contrat généré pour ce bail' };\n    }\n\n    // Extraction du chemin du fichier depuis l'URL ou reconstruction\n    const filePath = `${user.id}/contract-${leaseId}.pdf`;\n\n    // Générer une URL signée temporaire (valide 60 secondes)\n    const { data: signedData, error: signedError } = await supabase\n      .storage\n      .from('lease-contracts')\n      .createSignedUrl(filePath, 60);\n\n    if (signedError || !signedData) {\n      console.error('Erreur signed URL:', signedError);\n      return { success: false, error: 'Erreur lors de la génération du lien sécurisé' };\n    }\n\n    return {\n      success: true,\n      url: signedData.signedUrl,\n    };\n\n  } catch (error) {\n    console.error('Erreur downloadLeaseContract:', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n\n/**\n * Récupère les données d'un bail pour prévisualisation avant génération\n */\nexport async function getLeaseDataForContract(leaseId: string): Promise<{\n  success: boolean;\n  data?: ContractData;\n  error?: string;\n}> {\n  try {\n    const supabase = await createServerClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n      return { success: false, error: 'Non authentifié' };\n    }\n\n    // const supabase = await createServerClient(); // Déjà créé\n\n    const { data: lease, error: leaseError } = await supabase\n      .from('leases')\n      .select(`\n        id,\n        owner_id,\n        tenant_name,\n        tenant_email,\n        tenant_phone,\n        monthly_amount,\n        start_date,\n        end_date,\n        billing_day,\n        property_address,\n        properties (\n          title,\n          location,\n          description,\n          property_type\n        )\n      `)\n      .eq('id', leaseId)\n      .single();\n\n    if (leaseError || !lease || lease.owner_id !== user.id) {\n      return { success: false, error: 'Bail introuvable ou non autorisé' };\n    }\n\n    const { data: profile, error: profileError } = await supabase\n      .from('profiles')\n      .select('full_name, phone, company_name, company_address, company_phone, company_email, company_ninea, logo_url, signature_url')\n      .eq('id', user.id)\n      .single();\n\n    // Note: si erreur profil, on continue peut-être avec defaults? Pour l'instant on garde la logique stricte mais avec message clair.\n    if (profileError || !profile) {\n      // On peut retourner success:false ou juste des données vides pour le landlord\n      console.error(\"Erreur warning profil:\", profileError);\n    }\n\n    const fullName = profile?.full_name || '';\n    const firstName = fullName.split(' ')[0] || '';\n    const lastName = fullName.split(' ').slice(1).join(' ') || '';\n\n    const contractData: ContractData = {\n      landlord: {\n        firstName: firstName,\n        lastName: lastName,\n        address: profile?.company_address || 'Adresse non spécifiée',\n        phone: profile?.company_phone || profile?.phone || '',\n        email: profile?.company_email || user.email || '',\n        companyName: profile?.company_name || undefined,\n        ninea: profile?.company_ninea || undefined,\n      },\n      tenant: {\n        firstName: lease.tenant_name?.split(' ')[0] || '',\n        lastName: lease.tenant_name?.split(' ').slice(1).join(' ') || '',\n        phone: lease.tenant_phone || '',\n        email: lease.tenant_email || undefined,\n      },\n      property: {\n        address: lease.property_address || (lease.properties as any)?.location?.address || (lease.properties as any)?.location || '',\n        description: (lease.properties as any)?.description || (Array.isArray(lease.properties) ? lease.properties[0]?.description : '') || '',\n        propertyType: (lease.properties as any)?.property_type || (Array.isArray(lease.properties) ? lease.properties[0]?.property_type : undefined) as any,\n      },\n      lease: {\n        monthlyRent: Number(lease.monthly_amount),\n        securityDeposit: Number(lease.monthly_amount) * 2,\n        depositMonths: 2,\n        startDate: new Date(lease.start_date),\n        duration: 12,\n        billingDay: lease.billing_day || 5,\n      },\n      signatures: {\n        signatureDate: new Date(),\n        signatureCity: 'Dakar',\n      },\n    };\n\n    return {\n      success: true,\n      data: contractData,\n    };\n\n  } catch (error) {\n    console.error('Erreur getLeaseDataForContract:', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\admin-auth.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'redirect' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\nimport { redirect } from \"next/navigation\";\nimport { requireAnyRole, type UserRole } from \"@/lib/permissions\";\n\n/**\n * Authorized admin email (fallback pour compatibilité)\n */\nconst AUTHORIZED_ADMIN_EMAIL = \"barrymohamadou98@gmail.com\";\n\n/**\n * Vérifie si un utilisateur a un rôle spécifique\n */\nasync function hasRole(userId: string, role: UserRole): Promise<boolean> {\n  try {\n    const supabase = await createClient();\n    const { data, error } = await supabase\n      .from(\"user_roles\")\n      .select(\"id\")\n      .eq(\"user_id\", userId)\n      .eq(\"role\", role)\n      .single();\n\n    if (error || !data) {\n      return false;\n    }\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Check if the current user is authorized to access admin routes\n * Redirects to /compte if not authorized\n * \n * @deprecated Utilisez requireAnyRole() à la place pour un système de permissions plus flexible\n */\nexport async function requireAdmin() {\n  // Utiliser requireAnyRole pour la compatibilité\n  return await requireAnyRole([\"admin\", \"superadmin\"]);\n}\n\n/**\n * Check if the current user is an admin (without redirecting)\n * Useful for conditional rendering\n */\nexport async function isAdmin(): Promise<boolean> {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return false;\n  }\n\n  // Vérifier d'abord via les rôles\n  const isAdminViaRole = await hasRole(user.id, \"admin\");\n  \n  // Fallback sur l'email pour compatibilité\n  const isAdminViaEmail = user.email?.toLowerCase() === AUTHORIZED_ADMIN_EMAIL.toLowerCase();\n\n  return isAdminViaRole || isAdminViaEmail;\n}\n\n/**\n * Check if the current user is a moderator\n */\nexport async function isModerator(): Promise<boolean> {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return false;\n  }\n\n  return await hasRole(user.id, \"moderateur\");\n}\n\n/**\n * Check if the current user has a specific role\n */\nexport async function userHasRole(role: UserRole): Promise<boolean> {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return false;\n  }\n\n  return await hasRole(user.id, role);\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\analytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\contract-defaults.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\contract-template.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'landlordName' is assigned a value but never used.","line":126,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":126,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tenantName' is assigned a value but never used.","line":127,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":127,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Modèle de Contrat de Bail conforme au Droit Sénégalais\n * Références légales :\n * - Code des Obligations Civiles et Commerciales (COCC)\n * - Décret 2023 sur la baisse des loyers et la caution\n * - Loi 2024 sur les baux d'habitation\n *\n * OHADA : Pour les baux commerciaux uniquement\n */\n\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\n\nexport interface ContractData {\n  // Informations Bailleur (Propriétaire)\n  landlord: {\n    firstName: string;\n    lastName: string;\n    birthDate?: string;\n    birthPlace?: string;\n    address: string;\n    phone: string;\n    email?: string;\n    companyName?: string; // Si société\n    ninea?: string; // Numéro d'identification fiscale Sénégal\n  };\n\n  // Informations Locataire (Preneur)\n  tenant: {\n    firstName: string;\n    lastName: string;\n    birthDate?: string;\n    birthPlace?: string;\n    address?: string;\n    phone: string;\n    email?: string;\n    nationalId?: string; // CNI ou Passeport\n  };\n\n  // Informations sur le Bien\n  property: {\n    address: string;\n    description: string; // Ex: \"2 chambres, 1 salon, 1 cuisine, 1 salle de bain\"\n    propertyType?: 'appartement' | 'maison' | 'villa' | 'studio' | 'bureau';\n    floor?: string;\n    buildingName?: string;\n  };\n\n  // Termes du Bail\n  lease: {\n    monthlyRent: number; // En FCFA\n    securityDeposit: number; // Caution (max 2 mois selon loi)\n    depositMonths: number; // Nombre de mois de caution (généralement 1 ou 2)\n    startDate: Date;\n    duration: number; // En mois (généralement 12 ou 36)\n    billingDay: number; // Jour de paiement (ex: 5)\n    charges?: number; // Charges mensuelles séparées\n    paymentMethod?: string; // \"Virement bancaire\", \"Espèces\", etc.\n  };\n\n  // Signatures\n  signatures: {\n    landlordSignatureUrl?: string;\n    tenantSignatureUrl?: string;\n    signatureDate: Date;\n    signatureCity: string;\n  };\n\n  // Clauses additionnelles (optionnel)\n  additionalClauses?: string[];\n}\n\n/**\n * Nettoie le texte pour compatibilité PDF (supprime accents et caractères spéciaux)\n */\nfunction cleanTextForPDF(text: string): string {\n  return text\n    // Espaces Unicode (insécables, fins, etc.) → espace normal\n    // Nettoyage des espaces Unicode mais conservation des accents (WinAnsi supporté par PDF)\n    .replace(/[\\u00A0\\u2000-\\u200B\\u202F\\u205F\\u3000]/g, ' ')\n    // On ne remplace PLUS les accents car Helvetica (WinAnsi) les supporte\n    // .replace(/[àâä]/g, 'a') ...\n\n    // Guillemets et apostrophes (WinAnsi ne supporte pas toujours les guillemets typographiques)\n    .replace(/«/g, '\"')\n    .replace(/»/g, '\"')\n    .replace(/'/g, \"'\")\n    .replace(/'/g, \"'\")\n    // Tirets\n    .replace(/–/g, '-')\n    .replace(/—/g, '-')\n    // Box drawing characters (═, │, ┌, etc.)\n    .replace(/[═│┌┐└┘├┤┬┴┼─]/g, '=')\n    .replace(/…/g, '...')\n    // Emojis\n    .replace(/[🇸🇳💰🔒📍🏠✓⛔📋]/g, '')\n    .replace(/°/g, ' degres ');\n}\n\n/**\n * Génère le texte complet du contrat de bail\n */\n/**\n * Génère le texte complet du contrat de bail\n * @param includeHeaderParties Si false, renvoie uniquement le corps du contrat (Articles) pour mise en page PDF avancée\n */\nexport function generateContractText(data: ContractData, forPdf = false, includeHeaderParties = true): string {\n  const {\n    landlord,\n    tenant,\n    property,\n    lease,\n    signatures,\n    additionalClauses = []\n  } = data;\n\n  const startDateStr = format(lease.startDate, 'dd MMMM yyyy', { locale: fr });\n  const endDate = new Date(lease.startDate);\n  endDate.setMonth(endDate.getMonth() + lease.duration);\n  const endDateStr = format(endDate, 'dd MMMM yyyy', { locale: fr });\n  const signatureDateStr = format(signatures.signatureDate, 'dd MMMM yyyy', { locale: fr });\n\n  const rentFormatted = lease.monthlyRent.toLocaleString('fr-SN');\n  const depositFormatted = lease.securityDeposit.toLocaleString('fr-SN');\n\n  const landlordName = landlord.companyName || `${landlord.firstName} ${landlord.lastName}`;\n  const tenantName = `${tenant.firstName} ${tenant.lastName}`;\n\n  let text = '';\n\n  if (includeHeaderParties) {\n    text += `\n================================================================\n                    CONTRAT DE BAIL A USAGE D'HABITATION\n                          Republique du Senegal\n================================================================\n\n\nENTRE LES SOUSSIGNES :\n\n\nLE BAILLEUR (Propriétaire) :\n\n${landlord.companyName ? `Société : ${landlord.companyName}` : ''}\n${landlord.companyName && landlord.ninea ? `NINEA : ${landlord.ninea}` : ''}\n${!landlord.companyName ? `M./Mme : ${landlord.firstName} ${landlord.lastName}` : ''}\n${landlord.birthDate && landlord.birthPlace ? `Né(e) le ${landlord.birthDate} à ${landlord.birthPlace}` : ''}\nDemeurant à : ${landlord.address}\nTéléphone : ${landlord.phone}\n${landlord.email ? `Email : ${landlord.email}` : ''}\n\nCi-après dénommé « LE BAILLEUR »\n\nD'UNE PART,\n\n\nET :\n\n\nLE PRENEUR (Locataire) :\n\nM./Mme : ${tenant.firstName} ${tenant.lastName}\n${tenant.birthDate && tenant.birthPlace ? `Né(e) le ${tenant.birthDate} à ${tenant.birthPlace}` : ''}\n${tenant.nationalId ? `Pièce d'identité N° : ${tenant.nationalId}` : ''}\nTéléphone : ${tenant.phone}\n${tenant.email ? `Email : ${tenant.email}` : ''}\n\nCi-après dénommé « LE PRENEUR »\n\nD'AUTRE PART,\n\n\nIL A ETE CONVENU ET ARRETE CE QUI SUIT :\n  `;\n  }\n\n  // CORPS DU CONTRAT (ARTICLES)\n  text += `\nARTICLE 1 : DESIGNATION DES LIEUX\nLe BAILLEUR donne en location au PRENEUR les locaux à usage d'habitation dont la désignation suit :\nAdresse : ${property.address}\nType : ${property.propertyType || \"Logement\"}\nDescription : ${property.description}\n${property.floor ? `Étage : ${property.floor}` : ''}\n${property.buildingName ? `Immeuble : ${property.buildingName}` : ''}\n\nARTICLE 2 : DUREE DU BAIL\nLe présent bail est consenti et accepté pour une durée de ${lease.duration} mois, commençant à courir le ${startDateStr} pour se terminer le ${endDateStr}.\nIl se renouvellera ensuite par tacite reconduction, faute de congé donné par l'une des parties par lettre recommandée avec accusé de réception ou par acte extrajudiciaire au moins 6 mois avant l'expiration du bail (selon la loi en vigueur).\n\nARTICLE 3 : LOYER ET PAIEMENT\nLe présent bail est consenti et accepté moyennant un loyer mensuel de ${rentFormatted} FCFA.\nLe loyer est payable d'avance le ${lease.billingDay} de chaque mois. A chaque paiement, le BAILLEUR ou son représentant remettra une quittance au PRENEUR.\n\nARTICLE 4 : CAUTIONNEMENT\nÀ titre de garantie de l'exécution de ses obligations, le PRENEUR verse ce jour entre les mains du BAILLEUR, qui le reconnaît et lui en donne quittance, la somme de ${depositFormatted} FCFA représentant ${lease.depositMonths} mois de loyer.\nCette somme ne sera pas productrice d'intérêts et sera remboursée en fin de bail, déduction faite des sommes dont le PRENEUR pourrait être débiteur envers le BAILLEUR. Elle ne pourra en aucun cas s'imputer sur le dernier mois de loyer.\n\nARTICLE 5 : OBLIGATIONS DU PRENEUR\nLe PRENEUR est tenu des obligations suivantes :\n1. Payer le loyer aux termes convenus.\n2. User des lieux en « bon père de famille » et suivant la destination prévue au contrat (habitation).\n3. Ne pas céder le bail, ni sous-louer les lieux sans l'accord écrit du BAILLEUR.\n4. Répondre des dégradations et pertes qui surviennent pendant sa jouissance.\n5. Ne faire aucune transformation des lieux sans l'accord écrit du BAILLEUR.\n6. Laisser exécuter dans les lieux les travaux urgents nécessaires.\n\nARTICLE 6 : OBLIGATIONS DU BAILLEUR\nLe BAILLEUR est tenu des obligations suivantes :\n1. Délivrer au PRENEUR le logement en bon état d'usage et de réparation.\n2. Assurer au PRENEUR la jouissance paisible des lieux pendant la durée du bail.\n3. Entretenir les locaux en état de servir à l'usage prévu et y faire toutes les réparations nécessaires, autres que locatives.\n4. Délivrer gratuitement une quittance au PRENEUR.\n\nARTICLE 7 : RESILIATION\nLe présent bail pourra être résilié de plein droit, un mois après un commandement de payer resté infructueux, en cas de défaut de paiement d'un seul terme de loyer à son échéance, ou en cas d'inexécution de l'une des clauses du bail.\n\n${additionalClauses.length > 0 ? `\nARTICLE 8 : CLAUSES PARTICULIERES\n${additionalClauses.map((clause, index) => `${index + 1}. ${clause}`).join('\\n')}\n` : ''}\n\nARTICLE ${additionalClauses.length > 0 ? 9 : 8} : ELECTION DE DOMICILE / LITIGES\nPour l'exécution des présentes et leurs suites, les parties font élection de domicile :\n- Le BAILLEUR en son domicile sus-indiqué (ou au cabinet de son gestionnaire).\n- Le PRENEUR dans les lieux loués.\n\nTout litige relatif à l'interprétation ou à l'exécution du présent contrat sera de la compétence exclusive des Tribunaux de Dakar (Sénégal).\n\nFait à Dakar, le ${signatureDateStr}\nEn autant d'exemplaires que de parties.\n`;\n\n  if (forPdf) {\n    return cleanTextForPDF(text);\n  }\n\n  return text;\n}\n\n/**\n * Valide les données du contrat avant génération\n */\nexport function validateContractData(data: ContractData): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n\n  // Validation Bailleur\n  if (!data.landlord.firstName && !data.landlord.companyName) {\n    errors.push(\"Le nom du bailleur ou la raison sociale est requis\");\n  }\n  if (!data.landlord.address) {\n    errors.push(\"L'adresse du bailleur est requise\");\n  }\n  if (!data.landlord.phone) {\n    errors.push(\"Le téléphone du bailleur est requis\");\n  }\n\n  // Validation Locataire\n  if (!data.tenant.firstName || !data.tenant.lastName) {\n    errors.push(\"Le nom complet du locataire est requis\");\n  }\n  if (!data.tenant.phone) {\n    errors.push(\"Le téléphone du locataire est requis\");\n  }\n\n  // Validation Bien\n  if (!data.property.address) {\n    errors.push(\"L'adresse du bien est requise\");\n  }\n  if (!data.property.description) {\n    errors.push(\"La description du bien est requise\");\n  }\n\n  // Validation Bail\n  if (!data.lease.monthlyRent || data.lease.monthlyRent <= 0) {\n    errors.push(\"Le montant du loyer est requis et doit être positif\");\n  }\n  if (!data.lease.securityDeposit || data.lease.securityDeposit < 0) {\n    errors.push(\"Le montant de la caution est requis\");\n  }\n  // Vérification légale : max 2 mois de caution\n  if (data.lease.securityDeposit > data.lease.monthlyRent * 2) {\n    errors.push(\"La caution ne peut excéder 2 mois de loyer (loi sénégalaise)\");\n  }\n  if (!data.lease.startDate) {\n    errors.push(\"La date de début du bail est requise\");\n  }\n  if (!data.lease.duration || data.lease.duration <= 0) {\n    errors.push(\"La durée du bail est requise\");\n  }\n\n  // Validation Signatures\n  if (!data.signatures.signatureCity) {\n    errors.push(\"Le lieu de signature est requis\");\n  }\n  if (!data.signatures.signatureDate) {\n    errors.push(\"La date de signature est requise\");\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\email-confirmation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\finance.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isWithinInterval' is defined but never used.","line":40,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'startOfMonth' is defined but never used.","line":40,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":53},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'endOfMonth' is defined but never used.","line":40,"column":55,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'parseISO' is defined but never used.","line":40,"column":67,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":75},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAfter' is defined but never used.","line":40,"column":77,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":84}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { SupabaseClient } from \"@supabase/supabase-js\";\r\n\r\n/**\r\n * ╔══════════════════════════════════════════════════════════════════════════╗\r\n * ║                        FINANCE GUARD - KPI ENGINE                         ║\r\n * ║                       Moteur de calcul financier                          ║\r\n * ╚══════════════════════════════════════════════════════════════════════════╝\r\n *\r\n * RESPONSABILITÉS :\r\n * 1. Calcul des KPIs financiers (Attendu, Encaissé, Taux de recouvrement)\r\n * 2. Comptage des statuts (Payé, En attente, En retard)\r\n * 3. Validation des données (doublon email, cohérence)\r\n *\r\n * RÈGLES MÉTIER :\r\n * - Source de vérité pour \"Attendu\" : Table LEASES (baux actifs)\r\n * - Source de vérité pour \"Encaissé\" : Table RENTAL_TRANSACTIONS (amount_paid)\r\n * - Statut \"En retard\" : Déterminé par billing_day (synchronisé avec UI)\r\n *\r\n * SYNCHRONISATION UI ↔ BACKEND ↔ KPIs :\r\n * ✓ UI affiche \"Retard\" si currentDay > billing_day\r\n * ✓ KPIs comptent \"overdue\" si currentDay > billing_day\r\n * ✓ Relances envoyées si daysOverdue >= 5\r\n *\r\n * CRÉATION AUTOMATIQUE DE TRANSACTIONS (MAJ: 2025-12-28) :\r\n * ✓ Lors de l'ajout d'un nouveau locataire via createNewLease()\r\n * ✓ Transaction créée automatiquement pour le mois EN COURS (dynamique)\r\n * ✓ Champs: period_month (actuel), period_year (actuel), reminder_sent: false\r\n * ✓ Exemple: Locataire ajouté le 28/12/2025 → Transaction Décembre 2025 créée\r\n * ✓ Impact: Cron peut traiter ce locataire dès le lendemain\r\n *\r\n * COMPATIBILITÉ :\r\n * - Gère l'absence de la colonne amount_paid (fallback sur amount_due)\r\n * - Supporte les paiements partiels (amount_paid < amount_due)\r\n * - Gère les lignes virtuelles (baux sans transaction)\r\n *\r\n * @version 2.1 - Création auto transactions + Documentation\r\n * @date 2025-12-28\r\n */\r\n\r\nimport { isSameMonth, isWithinInterval, startOfMonth, endOfMonth, parseISO, isAfter } from 'date-fns';\r\n\r\nexport interface FinancialKPIs {\r\n    totalExpected: number;  // Basé sur les baux actifs (monthly_amount)\r\n    totalCollected: number; // Basé sur les versements réels (amount_paid ou amount_due si paid)\r\n    collectionRate: number; // Taux de recouvrement en % (Collected / Expected * 100)\r\n    occupancyRate: number;  // Taux d'occupation financier (Placeholder pour future implémentation)\r\n    pendingCount: number;   // Nombre de loyers en attente (status != 'paid' && !overdue)\r\n    overdueCount: number;   // Nombre de loyers en retard (status != 'paid' && currentDay > billing_day)\r\n    paidCount: number;      // Nombre de loyers payés (status === 'paid')\r\n}\r\n\r\n// Interfaces minimales pour découplage\r\nexport interface LeaseInput {\r\n    id: string;\r\n    monthly_amount: number;\r\n    status: string; // 'active' | 'terminated' | 'pending' usually (string from DB)\r\n    start_date: string | null;\r\n    billing_day: number; // Used for overdue calculation\r\n}\r\n\r\nexport interface TransactionInput {\r\n    id: string; // Pour unicité\r\n    lease_id: string;\r\n    amount_due: number;\r\n    amount_paid?: number | null; // La clé du correctif (peut être null/undefined)\r\n    status: string; // 'pending' | 'paid' | 'overdue' etc.\r\n    period_date?: string | Date; // Date de référence \"due_date\" ou période\r\n    created_at?: string;\r\n}\r\n\r\n/**\r\n * Calcule les KPI financiers pour un mois donné\r\n * Source de vérité : Lease (Bail) pour le dû, Transaction pour l'encaissé.\r\n */\r\nexport function calculateFinancials(\r\n    leases: LeaseInput[],\r\n    transactions: TransactionInput[],\r\n    targetDate: Date\r\n): FinancialKPIs {\r\n\r\n    let totalExpected = 0;\r\n    let totalCollected = 0;\r\n\r\n    let paidCount = 0;\r\n    let pendingCount = 0;\r\n    let overdueCount = 0;\r\n\r\n    const currentDay = new Date().getDate();\r\n    const isTargetMonthCurrent = isSameMonth(new Date(), targetDate);\r\n\r\n    // 1. Itération sur les BAUX (Source de vérité pour l'Attendu)\r\n    leases.forEach(lease => {\r\n        // On considère un bail actif s'il est statut 'active'\r\n        // (Pour être plus précis, on pourrait vérifier les dates start/end par rapport au mois cible)\r\n        if (lease.status === 'active') {\r\n\r\n            // Règle 1 : L'attendu vient du bail\r\n            const monthlyRent = Number(lease.monthly_amount) || 0;\r\n            totalExpected += monthlyRent;\r\n\r\n            // 2. Chercher la transaction correspondante pour ce bail ce mois-ci\r\n            // On cherche une transaction liée à ce lease_id, dans le mois cible.\r\n            // Note: Les transactions n'ont pas forcément une \"due_date\" parfaite en base,\r\n            // souvent on filtre les transactions passées en argument car elles ont déjà été filtrées par mois.\r\n            // Ici on va assumer que `transactions` contient TOUTES les transactions du mois cible.\r\n            const leaseTransaction = transactions.find(t => t.lease_id === lease.id);\r\n\r\n            if (leaseTransaction) {\r\n                // Règle 2 : On prend ce qui a été RÉELLEMENT payé\r\n                // Priorité 1: amount_paid (si la colonne existe)\r\n                // Priorité 2: amount_due si status='paid' (fallback pour compatibilité)\r\n                // Priorité 3: 0 (non payé)\r\n                let paidAmount = 0;\r\n                if (leaseTransaction.status === 'paid') {\r\n                    // Si marqué comme payé, utiliser amount_paid (ou amount_due en fallback)\r\n                    paidAmount = Number(leaseTransaction.amount_paid) || Number(leaseTransaction.amount_due) || 0;\r\n                } else {\r\n                    // Si non payé (pending/overdue), amount_paid pourrait être un acompte partiel\r\n                    paidAmount = Number(leaseTransaction.amount_paid) || 0;\r\n                }\r\n                totalCollected += paidAmount;\r\n\r\n                // Comptage des statuts - SYNCHRONISÉ AVEC L'UI\r\n                // L'UI vérifie le billing_day pour déterminer si c'est en retard\r\n                if (leaseTransaction.status === 'paid') {\r\n                    paidCount++;\r\n                } else {\r\n                    // Pour les transactions non payées (pending, overdue, etc.)\r\n                    // On vérifie si le billing_day est dépassé dans le mois courant\r\n                    const billingDay = lease.billing_day || 5;\r\n                    if (isTargetMonthCurrent && currentDay > billingDay) {\r\n                        overdueCount++;\r\n                    } else {\r\n                        pendingCount++;\r\n                    }\r\n                }\r\n            } else {\r\n                // 3. Pas de transaction = \"En attente\" virtuelle (ou retard)\r\n                // \"Revenus Fantômes\" gérés ici : on ajoute au totalExpected (déjà fait plus haut),\r\n                // et on considère comme non payé (collected += 0).\r\n\r\n                // Déterminer si c'est \"Pending\" ou \"Overdue\" (Retard)\r\n                // Si on est dans le mois courant et que le jour de facturation est passé, c'est un retard.\r\n                const billingDay = lease.billing_day || 5;\r\n                if (isTargetMonthCurrent && currentDay > billingDay) {\r\n                    overdueCount++;\r\n                } else {\r\n                    pendingCount++;\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n    // Calcul des ratios\r\n    const collectionRate = totalExpected > 0\r\n        ? Math.round((totalCollected / totalExpected) * 100)\r\n        : 0;\r\n\r\n    return {\r\n        totalExpected,\r\n        totalCollected,\r\n        collectionRate,\r\n        occupancyRate: 0,\r\n        pendingCount,\r\n        overdueCount,\r\n        paidCount\r\n    };\r\n}\r\n\r\n/**\r\n * Calcule le statut d'affichage d'une transaction (synchronisé avec l'UI)\r\n *\r\n * @param transactionStatus - Statut en base de données\r\n * @param billingDay - Jour de facturation (défaut: 5)\r\n * @param isCurrentMonth - Si on regarde le mois en cours\r\n * @returns 'paid' | 'pending' | 'overdue'\r\n */\r\nexport function calculateDisplayStatus(\r\n    transactionStatus: string,\r\n    billingDay: number = 5,\r\n    isCurrentMonth: boolean = true\r\n): 'paid' | 'pending' | 'overdue' {\r\n    if (transactionStatus === 'paid') {\r\n        return 'paid';\r\n    }\r\n\r\n    // Pour les transactions non payées, vérifier si en retard\r\n    const currentDay = new Date().getDate();\r\n    if (isCurrentMonth && currentDay > billingDay) {\r\n        return 'overdue';\r\n    }\r\n\r\n    return 'pending';\r\n}\r\n\r\n/**\r\n * PILIER 2 : Le Gardien (Write-Security)\r\n * Vérifie strictement si un email est déjà utilisé pour un bail ACTIF\r\n */\r\nexport async function validateTenantCreation(\r\n    email: string,\r\n    supabaseClient: SupabaseClient,\r\n    ownerId: string\r\n): Promise<{ valid: boolean; error?: string }> {\r\n    if (!email) return { valid: true }; // Pas d'email, pas de conflit\r\n\r\n    const { data: existingLeases, error } = await supabaseClient\r\n        .from('leases')\r\n        .select('id, tenant_name')\r\n        .eq('owner_id', ownerId)\r\n        .ilike('tenant_email', email.trim())\r\n        .neq('status', 'terminated') // On ignore les anciens baux résiliés\r\n        .limit(1);\r\n\r\n    if (error) {\r\n        console.error(\"FinanceGuard Error:\", error);\r\n        return { valid: false, error: \"Erreur de vérification des doublons\" };\r\n    }\r\n\r\n    if (existingLeases && existingLeases.length > 0) {\r\n        return {\r\n            valid: false,\r\n            error: `L'adresse email choisie est déjà utilisée par \"${existingLeases[0].tenant_name}\". Veuillez en choisir une autre.`\r\n        };\r\n    }\r\n\r\n    return { valid: true };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\geocoding.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\gtm.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'GTMEvent' is defined but never used.","line":1,"column":6,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"type GTMEvent = {\r\n    event: string;\r\n    [key: string]: unknown;\r\n};\r\n\r\ndeclare global {\r\n    interface Window {\r\n        dataLayer?: Record<string, unknown>[];\r\n    }\r\n}\r\n\r\nexport const sendGTMEvent = (eventName: string, data?: object) => {\r\n    if (typeof window !== 'undefined' && window.dataLayer) {\r\n        window.dataLayer.push({\r\n            event: eventName,\r\n            ...data,\r\n        });\r\n    } else {\r\n        console.log(`[GTM] Event Fired (Dev): ${eventName}`, data);\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\haptic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hibp-client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hibp.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\invoice.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":36,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PDFDocument, rgb, StandardFonts, PDFFont } from \"pdf-lib\";\nimport fontkit from '@pdf-lib/fontkit';\nimport fs from 'fs';\nimport path from 'path';\n\ninterface InvoiceData {\n  invoiceNumber: string;\n  date: Date;\n  clientName: string;\n  clientEmail: string;\n  items: {\n    description: string;\n    amount: number;\n  }[];\n  total: number;\n}\n\n// Fonction utilitaire pour nettoyer le texte\n// Emojis are now allowed!\nfunction sanitizeText(text: string): string {\n  if (!text) return \"\";\n  try {\n    const str = String(text);\n    // Replace ALL Unicode spaces (including non-breaking spaces) with normal space\n    // This includes: \\u00A0 (NBSP), \\u2000-\\u200B (various spaces), \\u202F (narrow NBSP), \\u205F (medium mathematical space), \\u3000 (ideographic space)\n    let cleaned = str.replace(/[\\u00A0\\u2000-\\u200B\\u202F\\u205F\\u3000\\uFEFF]/g, \" \");\n    \n    // Normalize multiple spaces to single space\n    cleaned = cleaned.replace(/\\s+/g, \" \");\n\n    // Remove only control characters that might break PDF (0x00-0x1F except tabs/newlines)\n    // keep emojis and other chars\n    cleaned = cleaned.replace(/[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F]/g, \"\");\n\n    return cleaned.trim();\n  } catch (e) {\n    return \"\";\n  }\n}\n\nexport async function generateInvoicePdf(data: InvoiceData): Promise<Buffer> {\n  try {\n    const pdfDoc = await PDFDocument.create();\n    pdfDoc.registerFontkit(fontkit);\n\n    const page = pdfDoc.addPage([595, 842]); // A4\n    const { width, height } = page.getSize();\n    const boldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);\n    const regularFont = await pdfDoc.embedFont(StandardFonts.Helvetica);\n\n    // Load Emoji Font\n    let emojiFont: PDFFont | undefined;\n    try {\n      // Try public/fonts first, then fallback to node_modules if needed (local dev)\n      const fontsDir = path.join(process.cwd(), 'public', 'fonts');\n      // We will look for NotoEmoji-Regular.ttf or similar\n      const fontPath = path.join(fontsDir, 'NotoEmoji-Regular.woff2');\n      const fontBytes = fs.readFileSync(fontPath);\n      emojiFont = await pdfDoc.embedFont(fontBytes);\n    } catch (e) {\n      console.warn(\"Could not load Emoji font, falling back to standard fonts:\", e);\n    }\n\n    const margin = 50;\n    let yPosition = height - 80;\n\n    // --- LOGO INTEGRATION (TEXT BASED) ---\n    const goldColor = rgb(251 / 255, 191 / 255, 36 / 255);\n    const blackColor = rgb(0, 0, 0);\n\n    // Main Title: DOUSSEL IMMO\n    page.drawText(\"DOUSSEL\", { x: margin, y: yPosition, size: 28, font: boldFont, color: blackColor });\n    const textWidth = boldFont.widthOfTextAtSize(\"DOUSSEL\", 28);\n    page.drawText(\" IMMO\", { x: margin + textWidth, y: yPosition, size: 28, font: boldFont, color: blackColor });\n\n    yPosition -= 20;\n\n    // Slogan\n    page.drawText(\"Votre partenaire immobilier de confiance\", { x: margin, y: yPosition, size: 10, font: regularFont, color: blackColor });\n\n    yPosition -= 30;\n\n    // Separator\n    page.drawLine({ start: { x: margin, y: yPosition }, end: { x: width - margin, y: yPosition }, thickness: 2, color: goldColor });\n    yPosition -= 40;\n\n    // --- INVOICE DETAILS ---\n    const rightX = width - margin;\n    page.drawText(\"FACTURE N°\", { x: rightX - 120, y: yPosition, size: 10, font: regularFont, color: rgb(0, 0, 0) });\n    yPosition -= 15;\n    page.drawText(sanitizeText(data.invoiceNumber), { x: rightX - 120, y: yPosition, size: 10, font: boldFont, color: rgb(0, 0, 0) });\n    yPosition -= 20;\n    page.drawText(\"Date d'emission\", { x: rightX - 120, y: yPosition, size: 10, font: regularFont, color: rgb(0, 0, 0) });\n    yPosition -= 15;\n    page.drawText(data.date.toLocaleDateString(\"fr-FR\"), { x: rightX - 120, y: yPosition, size: 10, font: regularFont, color: rgb(0, 0, 0) });\n\n    // --- CLIENT DETAILS ---\n    yPosition = height - 200;\n    page.drawText(\"FACTURE A\", { x: margin, y: yPosition, size: 10, font: regularFont, color: rgb(0, 0, 0) });\n    yPosition -= 15;\n    page.drawText(sanitizeText(data.clientName), { x: margin, y: yPosition, size: 10, font: boldFont, color: rgb(0, 0, 0) });\n    yPosition -= 15;\n    page.drawText(sanitizeText(data.clientEmail), { x: margin, y: yPosition, size: 10, font: regularFont, color: rgb(0, 0, 0) });\n\n    // --- TABLE ---\n    yPosition -= 60;\n    const tableTop = yPosition;\n    page.drawRectangle({ x: margin, y: tableTop - 25, width: width - 2 * margin, height: 25, color: rgb(0.96, 0.96, 0.96), borderColor: rgb(0, 0, 0), borderWidth: 1 });\n    page.drawText(\"DESCRIPTION\", { x: margin + 10, y: tableTop - 17, size: 10, font: boldFont, color: rgb(0, 0, 0) });\n    page.drawText(\"MONTANT\", { x: width - margin - 100, y: tableTop - 17, size: 10, font: boldFont, color: rgb(0, 0, 0) });\n\n    yPosition = tableTop - 50;\n    data.items.forEach((item) => {\n      // Use fallback font for description to support emojis\n      const description = sanitizeText(item.description);\n      const options: { x: number; y: number; size: number; font: PDFFont; color: ReturnType<typeof rgb> } = { x: margin + 10, y: yPosition, size: 10, font: regularFont, color: rgb(0, 0, 0) };\n\n      if (emojiFont) {\n        options.font = regularFont; // pdf-lib automatic fallback is not that simple, we need to handle it or use a font that supports both?\n        // Actually, pdf-lib doesn't support automatic fallback easily without complex logic.\n        // BUT, if we use the emoji font as the primary font for the description, it might look weird for normal text (monochrome).\n        // However, for this task, the goal is to SHOW emojis.\n        // Let's try to use emojiFont if we detect emojis, or just use `fallback` feature if available? No.\n        // Simplest hack: Use the emoji font for the whole description line if it contains emojis?\n        // Or better: NotoEmoji contains standard chars too?\n\n        // NotoEmoji-Regular is a monochrome font that has standard glyphs too usually.\n        // Let's safe-guard: if descriptions have emojis, use emojiFont.\n        // Regex for emoji:\n        if (/\\p{Emoji}/u.test(description)) {\n          options.font = emojiFont;\n        }\n      }\n\n      page.drawText(description, options);\n\n      // Nettoyer le montant formaté pour éviter les espaces insécables\n      page.drawText(sanitizeText(`${item.amount.toLocaleString(\"fr-SN\")} FCFA`), { x: width - margin - 100, y: yPosition, size: 10, font: regularFont, color: rgb(0, 0, 0) });\n      yPosition -= 25;\n    });\n\n    // Total\n    yPosition -= 10;\n    page.drawLine({ start: { x: margin, y: yPosition }, end: { x: width - margin, y: yPosition }, thickness: 1, color: rgb(0, 0, 0) });\n    yPosition -= 25;\n    page.drawText(\"TOTAL NET A PAYER\", { x: width - margin - 250, y: yPosition, size: 12, font: boldFont, color: rgb(0, 0, 0) });\n    // Nettoyer le total formaté pour éviter les espaces insécables\n    page.drawText(sanitizeText(`${data.total.toLocaleString(\"fr-SN\")} FCFA`), { x: width - margin - 100, y: yPosition, size: 12, font: boldFont, color: rgb(0, 0, 0) });\n\n    // Footer\n    const footerY = 50;\n    page.drawText(\"Doussel Immo - Dakar, Senegal - Support: +221 77 138 52 81 - Email: contact@doussel-immo.com\", { x: margin, y: footerY, size: 8, font: regularFont, color: rgb(0, 0, 0) });\n\n    const pdfBytes = await pdfDoc.save();\n    return Buffer.from(pdfBytes);\n  } catch (error) {\n    console.error(\"Error generating invoice PDF:\", error);\n    throw error;\n  }\n}\n\n\n\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\lease-expiration-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\logo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\mail-gmail.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\mail-supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\mail.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'fromName' is assigned a value but never used.","line":35,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user_id' is assigned a value but never used.","line":36,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sendEmail as sendEmailGmail, sendInvoiceEmail as sendInvoiceEmailGmail, getAdminEmail as getAdminEmailGmail } from \"./mail-gmail\";\r\nimport { render } from \"@react-email/render\";\r\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\r\nimport React from \"react\";\r\n\r\nconst ADMIN_EMAIL = process.env.ADMIN_EMAIL || \"barrymohamadou98@gmail.com\";\r\nconst SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\nconst ADMIN_ROLES = [\"admin\", \"moderateur\", \"superadmin\"];\r\n\r\ntype SendEmailOptions = {\r\n  to: string | string[];\r\n  subject: string;\r\n  react?: React.ReactElement;\r\n  html?: string;\r\n  from?: string; // Conservé pour compatibilité\r\n  fromName?: string;\r\n  user_id?: string | null;\r\n  attachments?: Array<{\r\n    filename: string;\r\n    content: Buffer | string;\r\n    contentType?: string;\r\n  }>;\r\n};\r\n\r\n/**\r\n * Fonction générique pour envoyer des emails via Gmail (Nodemailer)\r\n * Utilise GMAIL_USER et GMAIL_APP_PASSWORD depuis les variables d'environnement\r\n */\r\nexport async function sendEmail({\r\n  to,\r\n  subject,\r\n  react,\r\n  html,\r\n  fromName = \"Dousell Immo\",\r\n  user_id = null,\r\n  attachments,\r\n}: SendEmailOptions) {\r\n  // Si react est fourni, le convertir en HTML\r\n  let emailHtml = html;\r\n  if (react && !html) {\r\n    emailHtml = await render(react);\r\n  }\r\n\r\n  return sendEmailGmail({\r\n    to,\r\n    subject,\r\n    html: emailHtml,\r\n    attachments,\r\n  });\r\n}\r\n\r\n/**\r\n * Fonction pour envoyer une facture par email\r\n * @param to - Adresse email du destinataire\r\n * @param clientName - Nom du client\r\n * @param pdfBuffer - Buffer du PDF de la facture\r\n * @param invoiceNumber - Numéro de facture (optionnel)\r\n * @param amount - Montant de la facture (optionnel)\r\n */\r\nexport async function sendInvoiceEmail({\r\n  to,\r\n  clientName,\r\n  pdfBuffer,\r\n  invoiceNumber,\r\n  amount,\r\n}: {\r\n  to: string;\r\n  clientName: string;\r\n  pdfBuffer: Buffer;\r\n  invoiceNumber?: string;\r\n  amount?: number;\r\n}) {\r\n  return sendInvoiceEmailGmail({\r\n    to,\r\n    clientName,\r\n    pdfBuffer,\r\n    invoiceNumber,\r\n    amount,\r\n  });\r\n}\r\n\r\n/**\r\n * Email de l'admin (pour les notifications)\r\n */\r\nexport function getAdminEmail() {\r\n  return getAdminEmailGmail() || ADMIN_EMAIL;\r\n}\r\n\r\n/**\r\n * Retourne la liste des emails des admins et modérateurs pour les notifications critiques.\r\n * Fallback sur l'email admin principal si la configuration service role n'est pas disponible.\r\n */\r\nexport async function getAdminNotificationEmails(): Promise<string[]> {\r\n  const fallback = [getAdminEmail()].filter(Boolean);\r\n\r\n  if (!SUPABASE_URL || !SERVICE_ROLE_KEY) {\r\n    console.warn(\"⚠️ Impossible de récupérer les emails des admins/modérateurs sans SUPABASE_SERVICE_ROLE_KEY\");\r\n    return fallback;\r\n  }\r\n\r\n  try {\r\n    const supabase = createSupabaseClient(SUPABASE_URL, SERVICE_ROLE_KEY);\r\n\r\n    const { data: roleRows, error: roleError } = await supabase\r\n      .from(\"user_roles\")\r\n      .select(\"user_id, role\")\r\n      .in(\"role\", ADMIN_ROLES);\r\n\r\n    if (roleError) {\r\n      console.error(\"❌ Erreur lors de la récupération des rôles admin/modérateur:\", roleError);\r\n      return fallback;\r\n    }\r\n\r\n    const userIds = Array.from(\r\n      new Set<string>(\r\n        (roleRows ?? [])\r\n          .map((row) => row.user_id)\r\n          .filter((id): id is string => Boolean(id))\r\n      )\r\n    );\r\n\r\n    if (userIds.length === 0) {\r\n      console.warn(\"⚠️ Aucun utilisateur avec un rôle admin/modérateur trouvé.\");\r\n      return fallback;\r\n    }\r\n\r\n    const uniqueEmails = new Set<string>(fallback);\r\n    const perPage = 200;\r\n    let page = 1;\r\n    let fetchedAll = false;\r\n\r\n    while (!fetchedAll) {\r\n      const { data, error } = await supabase.auth.admin.listUsers({\r\n        page,\r\n        perPage,\r\n      });\r\n\r\n      if (error) {\r\n        console.error(\"❌ Erreur lors de la récupération des utilisateurs admin/modérateur:\", error);\r\n        break;\r\n      }\r\n\r\n      const users = data?.users ?? [];\r\n      users.forEach((user) => {\r\n        if (user.email && userIds.includes(user.id)) {\r\n          uniqueEmails.add(user.email.toLowerCase());\r\n        }\r\n      });\r\n\r\n      fetchedAll = !users.length || users.length < perPage || uniqueEmails.size >= userIds.length;\r\n      page += 1;\r\n    }\r\n\r\n    return Array.from(uniqueEmails);\r\n  } catch (error) {\r\n    console.error(\"❌ Erreur inattendue dans getAdminNotificationEmails:\", error);\r\n    return fallback;\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\notifications-helpers.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getUserRoles' is defined but never used.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fonctions utilitaires pour les notifications\n */\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\nimport { getUserRoles } from \"@/lib/permissions\";\nimport { notifyUser } from \"./notifications\";\nimport { getAdminEmail } from \"@/lib/mail\";\nimport type { NotificationType } from \"@/hooks/use-notifications\";\n\n/**\n * Récupère tous les IDs des utilisateurs avec un rôle spécifique\n */\nexport async function getUsersWithRoles(roles: string[]): Promise<string[]> {\n  try {\n    // TOUJOURS utiliser le service role client si disponible pour bypasser RLS\n    let supabase;\n    if (process.env.SUPABASE_SERVICE_ROLE_KEY) {\n      supabase = createSupabaseClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.SUPABASE_SERVICE_ROLE_KEY\n      );\n      console.log(\"🔑 Utilisation du service role client pour getUsersWithRoles\");\n    } else {\n      supabase = await createClient();\n      console.warn(\"⚠️ SUPABASE_SERVICE_ROLE_KEY non défini, utilisation du client normal (peut être bloqué par RLS)\");\n    }\n    \n    // Récupérer tous les user_id qui ont au moins un des rôles demandés\n    const { data, error } = await supabase\n      .from(\"user_roles\")\n      .select(\"user_id, role\")\n      .in(\"role\", roles);\n\n    if (error) {\n      console.error(\"❌ Error fetching users with roles:\", {\n        code: error.code,\n        message: error.message,\n        details: error.details,\n      });\n      return [];\n    }\n\n    // Retourner les user_id uniques\n    const userIds = new Set<string>();\n    data?.forEach((row) => {\n      if (row.user_id) {\n        userIds.add(row.user_id);\n      }\n    });\n\n    console.log(`✅ ${userIds.size} utilisateurs trouvés avec les rôles: ${roles.join(\", \")}`, {\n      userIds: Array.from(userIds),\n      roles: data?.map(r => ({ user_id: r.user_id, role: r.role }))\n    });\n\n    // Ajouter l'admin principal même s'il n'a pas de rôle dans user_roles (fallback)\n    const adminEmail = getAdminEmail();\n    if (process.env.SUPABASE_SERVICE_ROLE_KEY) {\n      try {\n        const adminClient = createSupabaseClient(\n          process.env.NEXT_PUBLIC_SUPABASE_URL!,\n          process.env.SUPABASE_SERVICE_ROLE_KEY\n        );\n        const { data: adminUsers } = await adminClient.auth.admin.listUsers();\n        const admin = adminUsers?.users.find(\n          (user) => user.email?.toLowerCase() === adminEmail.toLowerCase()\n        );\n        if (admin && !userIds.has(admin.id)) {\n          userIds.add(admin.id);\n          console.log(`✅ Admin principal ajouté: ${admin.id} (${admin.email})`);\n        }\n      } catch (adminError) {\n        console.warn(\"⚠️ Impossible de récupérer l'admin principal:\", adminError);\n      }\n    } else {\n      console.warn(\"⚠️ SUPABASE_SERVICE_ROLE_KEY non défini, impossible d'ajouter l'admin principal\");\n    }\n\n    return Array.from(userIds);\n  } catch (error) {\n    console.error(\"❌ Error in getUsersWithRoles:\", error);\n    return [];\n  }\n}\n\n/**\n * Notifie tous les modérateurs et admins\n */\nexport async function notifyModeratorsAndAdmins({\n  type,\n  title,\n  message,\n  resourcePath,\n}: {\n  type: NotificationType;\n  title: string;\n  message: string;\n  resourcePath?: string;\n}): Promise<{ success: boolean; notified: number; errors: string[] }> {\n  const errors: string[] = [];\n  let notified = 0;\n\n  try {\n    console.log(\"🔍 notifyModeratorsAndAdmins appelé avec:\", { type, title, message, resourcePath });\n    \n    // Récupérer tous les admins, modérateurs et superadmins\n    const userIds = await getUsersWithRoles([\"admin\", \"moderateur\", \"superadmin\"]);\n\n    console.log(`📬 Notification à ${userIds.length} modérateurs/admins`, { userIds });\n\n    if (userIds.length === 0) {\n      console.warn(\"⚠️ Aucun modérateur/admin trouvé. Vérifiez que les rôles sont bien assignés dans user_roles.\");\n      // Ne pas retourner une erreur, juste logger un avertissement\n      return { success: true, notified: 0, errors: [] };\n    }\n\n    // Notifier chaque utilisateur\n    for (const userId of userIds) {\n      try {\n        console.log(`📤 Envoi de notification à ${userId}...`);\n        await notifyUser({\n          userId,\n          type,\n          title,\n          message,\n          resourcePath,\n        });\n        notified++;\n        console.log(`✅ Notification envoyée à ${userId}`);\n      } catch (error) {\n        const errorMsg = error instanceof Error ? error.message : \"Erreur inconnue\";\n        errors.push(`User ${userId}: ${errorMsg}`);\n        console.error(`❌ Erreur lors de la notification pour ${userId}:`, error);\n      }\n    }\n\n    console.log(`✅ notifyModeratorsAndAdmins terminé: ${notified}/${userIds.length} notifications envoyées`);\n    return { success: errors.length === 0, notified, errors };\n  } catch (error) {\n    console.error(\"❌ Erreur dans notifyModeratorsAndAdmins:\", error);\n    return {\n      success: false,\n      notified,\n      errors: [error instanceof Error ? error.message : \"Erreur inconnue\"],\n    };\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\notifications.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'rpcErr' is defined but never used.","line":81,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":81,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\nimport type { NotificationType } from \"@/hooks/use-notifications\";\nimport { getAdminEmail } from \"@/lib/mail\";\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\n\ntype NotifyUserParams = {\n  userId: string;\n  type: NotificationType;\n  title: string;\n  message: string;\n  resourcePath?: string;\n};\n\ntype NotifyAdminParams = {\n  type: NotificationType;\n  title: string;\n  message: string;\n  resourcePath?: string;\n};\n\n/**\n * Notifier un utilisateur\n * @param params - Paramètres de la notification\n */\nexport async function notifyUser({\n  userId,\n  type,\n  title,\n  message,\n  resourcePath,\n}: NotifyUserParams) {\n  try {\n    // Utiliser le service role client si disponible pour bypasser RLS\n    const notificationClient = process.env.SUPABASE_SERVICE_ROLE_KEY\n      ? createSupabaseClient(\n          process.env.NEXT_PUBLIC_SUPABASE_URL!,\n          process.env.SUPABASE_SERVICE_ROLE_KEY\n        )\n      : await createClient();\n\n    // Essayer d'abord avec l'insertion directe\n    const { data, error } = await notificationClient\n      .from(\"notifications\")\n      .insert({\n        user_id: userId,\n        type,\n        title,\n        message,\n        resource_path: resourcePath || null,\n      })\n      .select()\n      .single();\n\n    if (error) {\n      // Si l'insertion échoue (RLS bloqué), essayer avec la fonction RPC\n      if (error.code === \"42501\" || error.message?.includes(\"permission denied\") || error.message?.includes(\"policy\")) {\n        console.warn(\"⚠️ RLS bloque l'insertion directe, tentative avec RPC create_notification\");\n        \n        try {\n          const supabase = await createClient();\n          const { data: rpcData, error: rpcError } = await supabase.rpc(\"create_notification\", {\n            p_user_id: userId,\n            p_type: type,\n            p_title: title,\n            p_message: message,\n            p_resource_path: resourcePath || null,\n          });\n\n          if (rpcError) {\n            // Si la fonction RPC n'existe pas, on continue avec l'erreur originale\n            if (rpcError.code === \"42883\" || rpcError.message?.includes(\"does not exist\")) {\n              console.warn(\"⚠️ Fonction create_notification n'existe pas. Exécutez docs/create-notification-function.sql\");\n              throw error; // Relancer l'erreur originale\n            }\n            console.error(\"❌ Error creating notification via RPC:\", rpcError);\n            throw rpcError;\n          }\n\n          console.log(\"✅ Notification créée via RPC avec succès:\", rpcData);\n          return { success: true, notificationId: rpcData };\n        } catch (rpcErr) {\n          // Si RPC échoue aussi, relancer l'erreur originale\n          throw error;\n        }\n      }\n\n      console.error(\"❌ Error creating user notification:\", error);\n      console.error(\"Détails:\", JSON.stringify(error, null, 2));\n      throw error;\n    }\n\n    console.log(\"✅ Notification créée avec succès:\", data?.id);\n    return { success: true, notificationId: data?.id };\n  } catch (error) {\n    console.error(\"❌ Erreur inattendue dans notifyUser:\", error);\n    throw error;\n  }\n}\n\n/**\n * Notifier l'admin\n * @param params - Paramètres de la notification\n */\nexport async function notifyAdmin({\n  type,\n  title,\n  message,\n  resourcePath,\n}: NotifyAdminParams) {\n  try {\n    const supabase = await createClient();\n    const adminEmail = getAdminEmail();\n    console.log(\"🔍 Recherche de l'admin avec l'email:\", adminEmail);\n\n    // Utiliser NEXT_PUBLIC_ADMIN_ID si disponible, sinon chercher par email\n    let adminUserId: string | null = process.env.NEXT_PUBLIC_ADMIN_ID || null;\n\n    if (adminUserId) {\n      console.log(\"✅ Admin ID trouvé via NEXT_PUBLIC_ADMIN_ID:\", adminUserId);\n    } else {\n      // Essayer d'abord avec le service role client si disponible\n      if (process.env.SUPABASE_SERVICE_ROLE_KEY) {\n        try {\n          console.log(\"🔑 Tentative avec service role client...\");\n          const serviceClient = createSupabaseClient(\n            process.env.NEXT_PUBLIC_SUPABASE_URL!,\n            process.env.SUPABASE_SERVICE_ROLE_KEY\n          );\n\n          const { data: adminUsers, error: userError } = await serviceClient.auth.admin.listUsers();\n          \n          if (userError) {\n            console.error(\"❌ Erreur lors de la récupération des users:\", userError);\n          } else if (adminUsers) {\n            const admin = adminUsers.users.find(\n              (user) => user.email?.toLowerCase() === adminEmail.toLowerCase()\n            );\n            if (admin) {\n              adminUserId = admin.id;\n              console.log(\"✅ Admin trouvé via service role:\", adminUserId);\n            } else {\n              console.warn(\"⚠️ Admin non trouvé dans la liste des users\");\n            }\n          }\n        } catch (error) {\n          console.warn(\"⚠️ Erreur avec service role client:\", error);\n        }\n      }\n\n      // Si on n'a pas trouvé avec le service role, utiliser la fonction SQL\n      if (!adminUserId) {\n        console.log(\"🔍 Tentative avec fonction SQL get_admin_user_id...\");\n        const { data, error: rpcError } = await supabase.rpc(\"get_admin_user_id\", {\n          admin_email: adminEmail,\n        });\n\n        if (rpcError) {\n          console.error(\"❌ Erreur RPC get_admin_user_id:\", rpcError);\n          // Si la fonction n'existe pas, on peut essayer une requête directe\n          if (rpcError.code === \"42883\" || rpcError.message?.includes(\"does not exist\")) {\n            console.warn(\"⚠️ La fonction get_admin_user_id n'existe pas. Veuillez appliquer la migration SQL.\");\n          }\n        } else if (data) {\n          adminUserId = data;\n          console.log(\"✅ Admin trouvé via fonction SQL:\", adminUserId);\n        }\n      }\n    }\n\n    if (!adminUserId) {\n      const errorMsg = `Admin user with email ${adminEmail} not found. Vérifiez que la migration SQL a été appliquée et que l'admin existe dans auth.users.`;\n      console.error(\"❌\", errorMsg);\n      return { success: false, error: errorMsg };\n    }\n\n    // Créer la notification avec le service role client si disponible pour bypasser RLS\n    const notificationClient = process.env.SUPABASE_SERVICE_ROLE_KEY\n      ? createSupabaseClient(\n          process.env.NEXT_PUBLIC_SUPABASE_URL!,\n          process.env.SUPABASE_SERVICE_ROLE_KEY\n        )\n      : supabase;\n\n    console.log(\"📝 Création de la notification pour l'admin:\", adminUserId);\n    const { data, error } = await notificationClient.from(\"notifications\").insert({\n      user_id: adminUserId,\n      type,\n      title,\n      message,\n      resource_path: resourcePath || null,\n    }).select();\n\n    if (error) {\n      console.error(\"❌ Erreur lors de la création de la notification:\", error);\n      console.error(\"Détails:\", JSON.stringify(error, null, 2));\n      return { success: false, error: error.message || \"Erreur inconnue\" };\n    }\n\n    console.log(\"✅ Notification créée avec succès:\", data?.[0]?.id);\n    return { success: true, notificationId: data?.[0]?.id };\n  } catch (error) {\n    console.error(\"❌ Erreur inattendue dans notifyAdmin:\", error);\n    return { \n      success: false, \n      error: error instanceof Error ? error.message : \"Erreur inconnue\" \n    };\n  }\n}\n\n/**\n * @deprecated Utilisez notifyUser à la place\n */\nexport async function createNotification(\n  userId: string,\n  type: NotificationType,\n  title: string,\n  message: string,\n  link?: string\n) {\n  return notifyUser({\n    userId,\n    type,\n    title,\n    message,\n    resourcePath: link,\n  });\n}\n\n/**\n * Créer une notification pour l'admin\n * @param notificationType - Type de notification (pour déterminer le type de notification)\n * @param title - Titre de la notification\n * @param message - Message de la notification\n * @param propertyId - ID du bien (optionnel, pour créer le lien)\n */\nexport async function createAdminNotification(\n  notificationType: \"new_property\" | \"property_approved\" | \"property_rejected\" | \"payment_received\",\n  title: string,\n  message: string,\n  propertyId?: string\n) {\n  const supabase = await createClient();\n  const adminEmail = getAdminEmail();\n\n  // Trouver l'ID de l'utilisateur admin en utilisant la fonction SQL ou le service role\n  let adminUserId: string | null = null;\n\n  // Essayer d'abord avec le service role client si disponible\n  if (process.env.SUPABASE_SERVICE_ROLE_KEY) {\n    try {\n      const serviceClient = createSupabaseClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.SUPABASE_SERVICE_ROLE_KEY\n      );\n\n      const { data: adminUsers, error: userError } = await serviceClient.auth.admin.listUsers();\n      \n      if (!userError && adminUsers) {\n        const admin = adminUsers.users.find(\n          (user) => user.email?.toLowerCase() === adminEmail.toLowerCase()\n        );\n        if (admin) {\n          adminUserId = admin.id;\n        }\n      }\n    } catch (error) {\n      console.warn(\"Could not use service role client:\", error);\n    }\n  }\n\n  // Si on n'a pas trouvé avec le service role, utiliser la fonction SQL\n  if (!adminUserId) {\n    const { data, error: rpcError } = await supabase.rpc(\"get_admin_user_id\", {\n      admin_email: adminEmail,\n    });\n\n    if (!rpcError && data) {\n      adminUserId = data;\n    }\n  }\n\n  if (!adminUserId) {\n    console.warn(`Admin user with email ${adminEmail} not found`);\n    return { success: false, error: \"Admin user not found\" };\n  }\n\n  // Déterminer le type de notification et le lien\n  let type: NotificationType = \"info\";\n  let link: string | undefined;\n\n  switch (notificationType) {\n    case \"new_property\":\n      type = \"info\";\n      link = propertyId ? `/admin/moderation?property=${propertyId}` : \"/admin/moderation\";\n      break;\n    case \"property_approved\":\n      type = \"success\";\n      link = propertyId ? `/biens/${propertyId}` : undefined;\n      break;\n    case \"property_rejected\":\n      type = \"warning\";\n      link = propertyId ? `/admin/biens/${propertyId}` : \"/admin/moderation\";\n      break;\n    case \"payment_received\":\n      type = \"success\";\n      link = propertyId ? `/admin/biens/${propertyId}` : \"/admin/dashboard\";\n      break;\n  }\n\n  // Créer la notification avec le service role client si disponible pour bypasser RLS\n  const notificationClient = process.env.SUPABASE_SERVICE_ROLE_KEY\n    ? createSupabaseClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.SUPABASE_SERVICE_ROLE_KEY\n      )\n    : supabase;\n\n  const { error } = await notificationClient.from(\"notifications\").insert({\n    user_id: adminUserId,\n    type,\n    title,\n    message,\n    resource_path: link || null,\n  });\n\n  if (error) {\n    console.error(\"Error creating admin notification:\", error);\n    return { success: false, error: error.message };\n  }\n\n  return { success: true };\n}\n\n/**\n * Exemples d'utilisation :\n * \n * // Notification de bien approuvé\n * await createNotification(\n *   userId,\n *   'success',\n *   'Bien approuvé',\n *   'Votre bien \"Villa à Dakar\" a été approuvé et est maintenant visible.',\n *   '/biens/123'\n * );\n * \n * // Notification de visite planifiée\n * await createNotification(\n *   userId,\n *   'info',\n *   'Visite planifiée',\n *   'Une visite a été planifiée pour votre bien le 15 janvier à 14h.',\n *   '/compte/mes-biens'\n * );\n * \n * // Notification d'erreur\n * await createNotification(\n *   userId,\n *   'error',\n *   'Erreur de paiement',\n *   'Le paiement de votre annonce n\\'a pas pu être traité. Veuillez réessayer.'\n * );\n */\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\paydunya.ts","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":276,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":276,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Configuration et utilitaires PayDunya\n * Documentation: https://developers.paydunya.com/doc/FR/http_json\n */\n\nexport type PayDunyaMode = \"test\" | \"live\";\n\nexport interface PayDunyaConfig {\n  masterKey: string;\n  privateKey: string;\n  token: string;\n  mode: PayDunyaMode;\n}\n\nexport interface PayDunyaInvoiceItem {\n  name: string;\n  quantity: number;\n  unit_price: number;\n  total_price: number;\n  description?: string;\n}\n\nexport interface PayDunyaInvoice {\n  invoice: {\n    items: PayDunyaInvoiceItem[];\n    total_amount: number;\n    description: string;\n    taxes?: Record<string, number>;\n  };\n  store: {\n    name: string;\n    tagline?: string;\n    postal_address?: string;\n    phone?: string;\n    logo_url?: string;\n    website_url?: string;\n  };\n  actions: {\n    cancel_url: string;\n    return_url: string;\n    callback_url?: string;\n  };\n  custom_data?: Record<string, unknown>;\n}\n\nexport interface PayDunyaInvoiceResponse {\n  response_code: string;\n  response_text: string;\n  description: string;\n  token: string;\n  response_url?: string;\n  response_code_detail?: string;\n}\n\nexport interface PayDunyaWebhookPayload {\n  invoice: {\n    token: string;\n    status: \"completed\" | \"pending\" | \"cancelled\";\n    total_amount: number;\n    description: string;\n    items: PayDunyaInvoiceItem[];\n  };\n  customer: {\n    name?: string;\n    email?: string;\n    phone?: string;\n  };\n  custom_data?: Record<string, unknown>;\n}\n\n/**\n * Configuration PayDunya depuis les variables d'environnement\n */\nexport function getPayDunyaConfig(): PayDunyaConfig {\n  const masterKey = process.env.PAYDUNYA_MASTER_KEY;\n  const privateKey = process.env.PAYDUNYA_PRIVATE_KEY;\n  const token = process.env.PAYDUNYA_TOKEN;\n  const mode = (process.env.PAYDUNYA_MODE || \"test\") as PayDunyaMode;\n\n  if (!masterKey || !privateKey || !token) {\n    throw new Error(\n      \"PayDunya configuration manquante. Vérifiez PAYDUNYA_MASTER_KEY, PAYDUNYA_PRIVATE_KEY et PAYDUNYA_TOKEN dans .env\"\n    );\n  }\n\n  return {\n    masterKey,\n    privateKey,\n    token,\n    mode,\n  };\n}\n\n/**\n * URL de base de l'API PayDunya selon le mode\n */\nconst PAYDUNYA_API_BASE: Record<PayDunyaMode, string> = {\n  test: \"https://app.paydunya.com/sandbox-api/v1\",\n  live: \"https://app.paydunya.com/api/v1\",\n};\n\nconst PAYDUNYA_CHECKOUT_BASE: Record<PayDunyaMode, string> = {\n  test: \"https://app.paydunya.com/sandbox-checkout-invoice\",\n  live: \"https://app.paydunya.com/checkout-invoice\",\n};\n\nexport function getPayDunyaApiBaseUrl(mode: PayDunyaMode): string {\n  return PAYDUNYA_API_BASE[mode];\n}\n\nexport function getPayDunyaCheckoutBaseUrl(mode: PayDunyaMode): string {\n  return PAYDUNYA_CHECKOUT_BASE[mode];\n}\n\n/**\n * Créer une facture PayDunya\n */\nexport async function createPayDunyaInvoice(\n  invoice: PayDunyaInvoice\n): Promise<PayDunyaInvoiceResponse> {\n  const config = getPayDunyaConfig();\n  const baseUrl = getPayDunyaApiBaseUrl(config.mode);\n  const url = `${baseUrl}/checkout-invoice/create`;\n\n  const response = await fetch(url, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"PAYDUNYA-MASTER-KEY\": config.masterKey,\n      \"PAYDUNYA-PRIVATE-KEY\": config.privateKey,\n      \"PAYDUNYA-TOKEN\": config.token,\n    },\n    body: JSON.stringify(invoice),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Erreur PayDunya (${response.status}): ${errorText}`\n    );\n  }\n\n  const data = await response.json();\n  \n  if (data.response_code !== \"00\") {\n    throw new Error(\n      `Erreur PayDunya: ${data.response_text} - ${data.description}`\n    );\n  }\n\n  return data;\n}\n\n/**\n * Vérifier le statut d'une facture PayDunya\n */\nexport async function checkPayDunyaInvoiceStatus(\n  token: string\n): Promise<PayDunyaInvoiceResponse> {\n  const config = getPayDunyaConfig();\n  const baseUrl = getPayDunyaApiBaseUrl(config.mode);\n  const url = `${baseUrl}/checkout-invoice/confirm/${token}`;\n\n  const response = await fetch(url, {\n    method: \"GET\",\n    headers: {\n      \"PAYDUNYA-MASTER-KEY\": config.masterKey,\n      \"PAYDUNYA-PRIVATE-KEY\": config.privateKey,\n      \"PAYDUNYA-TOKEN\": config.token,\n    },\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Erreur PayDunya (${response.status}): ${errorText}`\n    );\n  }\n\n  return await response.json();\n}\n\n/**\n * URL de redirection vers le checkout PayDunya\n */\nexport function getPayDunyaCheckoutUrl(token: string, mode: PayDunyaMode): string {\n  const baseUrl = getPayDunyaCheckoutBaseUrl(mode);\n  // En sandbox, l'URL fournie par PayDunya est sandbox-checkout-invoice\n  if (mode === \"test\") {\n    return `${baseUrl}?token=${token}`;\n  }\n  return `${baseUrl}?token=${token}`;\n}\n\n/**\n * Initialiser un paiement \"Boost annonce\"\n */\nexport async function initializePayment(\n  propertyId: string,\n  title: string,\n  price = 5000\n) {\n  const config = getPayDunyaConfig();\n  const baseUrl = getPayDunyaApiBaseUrl(config.mode);\n  const url = `${baseUrl}/checkout-invoice/create`;\n\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL || \"https://dousel-immo.vercel.app\";\n  const callbackUrl =\n    process.env.PAYDUNYA_CALLBACK_URL ||\n    process.env.NGROK_CALLBACK_URL ||\n    `${appUrl}/api/webhooks/paydunya`;\n\n  const payload = {\n    invoice: {\n      total_amount: price,\n      description: `Boost annonce : ${title}`,\n    },\n    store: {\n      name: \"Doussel Immo\",\n      tagline: \"Immobilier Dakar\",\n      website_url:\n        process.env.NEXT_PUBLIC_APP_URL || \"https://doussel-immo.vercel.app\",\n    },\n    custom_data: {\n      property_id: propertyId,\n    },\n    actions: {\n      return_url: `${appUrl}/compte/mes-biens?status=success`,\n      cancel_url: `${appUrl}/compte/mes-biens?status=cancel`,\n      callback_url: callbackUrl,\n    },\n  };\n\n  const response = await fetch(url, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"PAYDUNYA-MASTER-KEY\": config.masterKey,\n      \"PAYDUNYA-PRIVATE-KEY\": config.privateKey,\n      \"PAYDUNYA-TOKEN\": config.token,\n    },\n    body: JSON.stringify(payload),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Erreur PayDunya (${response.status}): ${errorText}`\n    );\n  }\n\n  const data = await response.json();\n\n  if (data.response_code !== \"00\") {\n    throw new Error(\n      `Erreur PayDunya: ${data.response_text} - ${data.description}`\n    );\n  }\n\n  return {\n    token: data.token,\n    redirectUrl: getPayDunyaCheckoutUrl(data.token, config.mode),\n    raw: data,\n  };\n}\n\n/**\n * Valider la signature HMAC d'un webhook PayDunya\n */\nexport function validatePayDunyaWebhook(\n  payload: string,\n  signature: string\n): boolean {\n  try {\n    const config = getPayDunyaConfig();\n    const crypto = require(\"crypto\");\n    const expectedSignature = crypto\n      .createHmac(\"sha256\", config.privateKey)\n      .update(payload)\n      .digest(\"hex\");\n\n    // Comparaison sécurisée des signatures\n    if (signature.length !== expectedSignature.length) {\n      return false;\n    }\n\n    return crypto.timingSafeEqual(\n      Buffer.from(signature, \"hex\"),\n      Buffer.from(expectedSignature, \"hex\")\n    );\n  } catch (error) {\n    console.error(\"Erreur lors de la validation de la signature:\", error);\n    return false;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\pdf-generator-helper.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[551,554],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[551,554],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[571,574],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[571,574],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[748,751],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[748,751],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { ContractData } from './contract-template';\r\nimport { format } from 'date-fns';\r\nimport { fr } from 'date-fns/locale';\r\n\r\n/**\r\n * Remplace les placeholders dans le texte par les valeurs du contrat\r\n * Format supporté: {{objet.propriete}} ou {{objet.sous_objet.propriete}}\r\n * Ex: {{tenant.firstName}}, {{lease.monthlyRent}}\r\n */\r\nexport function replacePlaceholders(template: string, data: ContractData): string {\r\n    if (!template) return '';\r\n\r\n    // Fonction récursive pour accéder aux propriétés imbriquées\r\n    const getValue = (obj: any, path: string): any => {\r\n        return path.split('.').reduce((acc, part) => acc && acc[part], obj);\r\n    };\r\n\r\n    // Formatage spécial pour certains champs\r\n    const formatValue = (value: any, key: string): string => {\r\n        if (value instanceof Date) {\r\n            return format(value, 'dd MMMM yyyy', { locale: fr });\r\n        }\r\n\r\n        if (typeof value === 'number') {\r\n            // Format monétaire pour les champs liés à l'argent\r\n            if (key.toLowerCase().includes('rent') ||\r\n                key.toLowerCase().includes('amount') ||\r\n                key.toLowerCase().includes('price') ||\r\n                key.toLowerCase().includes('deposit') ||\r\n                key.toLowerCase().includes('charges')) {\r\n                return value.toLocaleString('fr-FR');\r\n            }\r\n            return value.toString();\r\n        }\r\n\r\n        return value || '';\r\n    };\r\n\r\n    // Remplacement des patterns {{...}}\r\n    return template.replace(/\\{\\{([^}]+)\\}\\}/g, (match, key) => {\r\n        const trimmedKey = key.trim();\r\n        const value = getValue(data, trimmedKey);\r\n\r\n        // Si la valeur existe, on la formate, sinon on laisse une chaine vide (ou le placeholder pour debug)\r\n        if (value !== undefined && value !== null) {\r\n            return formatValue(value, trimmedKey);\r\n        }\r\n\r\n        // Cas spéciaux calculés\r\n        if (trimmedKey === 'lease.totalRent') {\r\n            const rent = data.lease.monthlyRent || 0;\r\n            const charges = data.lease.charges || 0;\r\n            return formatValue(rent + charges, 'totalRent');\r\n        }\r\n\r\n        if (trimmedKey === 'landlord.fullName') {\r\n            if (data.landlord.companyName) return data.landlord.companyName;\r\n            return `${data.landlord.firstName} ${data.landlord.lastName}`;\r\n        }\r\n\r\n        if (trimmedKey === 'tenant.fullName') {\r\n            return `${data.tenant.firstName} ${data.tenant.lastName}`;\r\n        }\r\n\r\n        return ''; // Ou `[${trimmedKey}]` pour voir les manquants\r\n    });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\pdf-generator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'generateContractText' is defined but never used.","line":13,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'format' is defined but never used.","line":16,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'fr' is defined but never used.","line":17,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":295,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":295,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'page' is defined but never used.","line":488,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":488,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pageNum' is defined but never used.","line":488,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":488,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'width' is defined but never used.","line":488,"column":53,"nodeType":null,"messageId":"unusedVar","endLine":488,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'font' is defined but never used.","line":488,"column":68,"nodeType":null,"messageId":"unusedVar","endLine":488,"endColumn":72},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":585,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":585,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18876,18879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18876,18879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":587,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":587,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19049,19052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19049,19052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":608,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":608,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19625,19628],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19625,19628],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":624,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":624,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20007,20010],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20007,20010],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":627,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":627,"endColumn":17}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Générateur de PDF pour Contrats de Bail\n * Utilise pdf-lib pour créer des PDFs professionnels\n *\n * Features:\n * - Mise en page professionnelle avec marges\n * - Support des signatures numériques (images)\n * - Logo du propriétaire\n * - Conformité visuelle Sénégal\n */\n\nimport { PDFDocument, rgb, StandardFonts, PDFFont, PDFPage, degrees } from 'pdf-lib';\nimport { generateContractText, ContractData, validateContractData } from './contract-template';\nimport { DEFAULT_CONTRACT_TEXTS, ContractCustomTexts } from './contract-defaults';\nimport { replacePlaceholders } from './pdf-generator-helper';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\n\nconst COLORS = {\n  primary: rgb(0.2, 0.2, 0.6),\n  secondary: rgb(0.4, 0.4, 0.4),\n  text: rgb(0, 0, 0),\n  lightGray: rgb(0.95, 0.95, 0.95),\n  mediumGray: rgb(0.8, 0.8, 0.8),\n};\n\ninterface PDFGenerationOptions {\n  includeWatermark?: boolean;\n  watermarkText?: string;\n  logoUrl?: string;\n}\n\ninterface PDFGenerationResult {\n  success: boolean;\n  pdfBytes?: Uint8Array;\n  error?: string;\n}\n\n/**\n * Génère un PDF de contrat de bail à partir des données\n */\n/**\n * Génère un PDF de contrat de bail à partir des données\n */\nexport async function generateLeasePDF(\n  data: ContractData,\n  customTexts: ContractCustomTexts = {},\n  options: PDFGenerationOptions = {}\n): Promise<PDFGenerationResult> {\n  try {\n    // 1. Validation des données\n    const validation = validateContractData(data);\n    if (!validation.valid) {\n      return {\n        success: false,\n        error: `Données invalides: ${validation.errors.join(', ')}`\n      };\n    }\n\n    // 2. Créer un nouveau document PDF\n    const pdfDoc = await PDFDocument.create();\n\n    // 3. Charger les polices\n    const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);\n    const fontRegular = await pdfDoc.embedFont(StandardFonts.Helvetica);\n\n    // 4. Contenu du contrat (Header, Parties, Articles via CMS)\n    await addContractContent(pdfDoc, data, customTexts, fontRegular, fontBold, options);\n\n    // 6. Signatures intégrées dans addContractContent\n\n    // 7. Ajouter le watermark si demandé (brouillon, etc.)\n    if (options.includeWatermark && options.watermarkText) {\n      await addWatermark(pdfDoc, options.watermarkText);\n    }\n\n    // 8. Sauvegarder et retourner\n    const pdfBytes = await pdfDoc.save();\n\n    return {\n      success: true,\n      pdfBytes\n    };\n\n  } catch (error) {\n    console.error('Erreur génération PDF:', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n\n/**\n * Ajoute le contenu structuré du contrat : Header, Grille Parties, Articles\n */\nasync function addContractContent(\n  pdfDoc: PDFDocument,\n  data: ContractData,\n  customTexts: ContractCustomTexts,\n  fontRegular: PDFFont,\n  fontBold: PDFFont,\n  options: PDFGenerationOptions\n): Promise<void> {\n  const pageWidth = 595.28; // A4 width\n  const pageHeight = 841.89; // A4 height\n  const margin = 50;\n\n  // Création de la première page\n  let currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n  let currentY = pageHeight - margin;\n\n  // --- 1. HEADER (Logo + Titre) ---\n  currentY = await drawHeader(pdfDoc, currentPage, data, options, currentY, pageWidth, margin, fontBold);\n\n  // --- 2. PARTIES (Grille Bailleur / Locataire) ---\n  currentY = drawPartiesGrid(currentPage, data, currentY, pageWidth, margin, fontRegular, fontBold);\n\n  // Espace après la grille\n  currentY -= 30;\n\n  // --- 3. CORPS (Articles CMS) ---\n  const lineSpacing = 14;\n  const maxWidth = pageWidth - (2 * margin);\n\n  // Fusion des textes\n  const finalTexts = { ...DEFAULT_CONTRACT_TEXTS, ...customTexts };\n\n  const articles = [\n    { title: \"ARTICLE 1 : OBJET DU BAIL ET DESCRIPTION DU BIEN\", content: finalTexts.article_1_objet },\n    { title: \"ARTICLE 2 : DESTINATION DES LIEUX\", content: finalTexts.article_2_destination },\n    { title: \"ARTICLE 3 : DURÉE DU BAIL\", content: finalTexts.article_3_duree },\n    { title: \"ARTICLE 4 : LOYER\", content: finalTexts.article_4_loyer },\n    { title: \"ARTICLE 5 : CHARGES ET CONSOMMATIONS\", content: finalTexts.article_5_charges },\n    { title: \"ARTICLE 6 : DÉPÔT DE GARANTIE (CAUTION)\", content: finalTexts.article_6_caution },\n    { title: \"ARTICLE 7 : OBLIGATIONS DU PRENEUR\", content: finalTexts.article_7_obligations_preneur },\n    { title: \"ARTICLE 8 : OBLIGATIONS DU BAILLEUR\", content: finalTexts.article_8_obligations_bailleur },\n    { title: \"ARTICLE 9 : RÉSILIATION ET PRÉAVIS\", content: finalTexts.article_9_resiliation },\n    { title: \"ARTICLE 10 : CLAUSE RÉSOLUTOIRE\", content: finalTexts.article_10_clause_resolutoire },\n    { title: \"ARTICLE 11 : ÉLECTION DE DOMICILE ET JURIDICTION COMPÉTENTE\", content: finalTexts.article_11_election_domicile },\n    { title: \"ARTICLE 12 : FRAIS ET EXEMPLAIRES\", content: finalTexts.article_12_frais },\n  ];\n\n  // Titre introductif\n  currentPage.drawText(\"IL A ETE CONVENU ET ARRETE CE QUI SUIT :\", {\n    x: margin,\n    y: currentY,\n    size: 10,\n    font: fontBold,\n    color: COLORS.text,\n  });\n  currentY -= (lineSpacing * 2);\n\n  // Boucle de rendu des articles\n  for (const art of articles) {\n    // Vérif nouvelle page (avec marge de sécurité)\n    if (currentY < 100) {\n      drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n      currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n      currentY = pageHeight - margin;\n    }\n\n    // Titre de l'article\n    currentPage.drawText(art.title, { x: margin, y: currentY, size: 11, font: fontBold, color: COLORS.text });\n\n    // Soulignage du titre\n    const titleWidth = fontBold.widthOfTextAtSize(art.title, 11);\n    currentPage.drawLine({\n      start: { x: margin, y: currentY - 2 },\n      end: { x: margin + titleWidth, y: currentY - 2 },\n      thickness: 1,\n      color: COLORS.text,\n    });\n\n    currentY -= 15;\n\n    // Remplacement des variables\n    const contentWithVars = replacePlaceholders(art.content || \"\", data);\n\n    // Contenu (Wrappé)\n    const lines = wrapText(contentWithVars, fontRegular, 10, maxWidth);\n    for (const line of lines) {\n      // Vérif saut de page intra-article\n      if (currentY < margin + 20) {\n        drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n        currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n        currentY = pageHeight - margin;\n      }\n\n      currentPage.drawText(line, { x: margin, y: currentY, size: 10, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });\n      currentY -= lineSpacing;\n    }\n    currentY -= 15; // Espace entre articles\n  }\n\n  // --- CLAUSES PARTICULIÈRES (AJOUT) ---\n  if (customTexts.custom_clauses && customTexts.custom_clauses.trim() !== \"\") {\n    if (currentY < 100) {\n      drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n      currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n      currentY = pageHeight - margin;\n    }\n\n    const customTitle = \"CONDITIONS PARTICULIÈRES\";\n    currentPage.drawText(customTitle, { x: margin, y: currentY, size: 11, font: fontBold, color: COLORS.text });\n\n    const cw = fontBold.widthOfTextAtSize(customTitle, 11);\n    currentPage.drawLine({\n      start: { x: margin, y: currentY - 2 },\n      end: { x: margin + cw, y: currentY - 2 },\n      thickness: 1,\n      color: COLORS.text,\n    });\n\n    currentY -= 15;\n\n    const lines = wrapText(customTexts.custom_clauses, fontRegular, 10, maxWidth);\n    for (const line of lines) {\n      if (currentY < margin + 20) {\n        drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n        currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n        currentY = pageHeight - margin;\n      }\n      currentPage.drawText(line, { x: margin, y: currentY, size: 10, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });\n      currentY -= lineSpacing;\n    }\n    currentY -= 20;\n  }\n\n  // --- SECTION SIGNATURES ---\n  // On s'assure d'avoir assez de place (150px min), sinon nouvelle page\n  if (currentY < 150) {\n    drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n    currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n    currentY = pageHeight - margin;\n  }\n\n  currentY -= 30; // Petit espace avant la zone\n\n  // Titre de section\n  currentPage.drawText(\"SIGNATURES\", { x: margin, y: currentY, size: 12, font: fontBold, color: COLORS.primary });\n  currentPage.drawLine({\n    start: { x: margin, y: currentY - 5 },\n    end: { x: pageWidth - margin, y: currentY - 5 },\n    thickness: 1,\n    color: COLORS.primary // Primary color\n  });\n\n  currentY -= 40; // Espace sous la ligne\n\n  // --- COLONNE GAUCHE : BAILLEUR ---\n  const leftColX = margin;\n  currentPage.drawText(\"LE BAILLEUR (Propriétaire)\", { x: leftColX, y: currentY, size: 10, font: fontBold, color: COLORS.primary });\n  currentPage.drawText(\"Lu et approuvé\", { x: leftColX, y: currentY - 15, size: 9, font: fontRegular, color: COLORS.secondary });\n\n  // Signature Bailleur\n  if (data.signatures.landlordSignatureUrl) {\n    try {\n      const sigImage = await fetchAndEmbedImage(pdfDoc, data.signatures.landlordSignatureUrl);\n      if (sigImage) {\n        const sigWidth = 120;\n        const sigHeight = 60;\n        const scaledDims = sigImage.scale(sigWidth / sigImage.width);\n        currentPage.drawImage(sigImage, {\n          x: leftColX,\n          y: currentY - 80,\n          width: Math.min(scaledDims.width, sigWidth),\n          height: Math.min(scaledDims.height, sigHeight),\n        });\n      }\n    } catch (e) { console.warn(\"Erreur signature bailleur\", e); }\n  }\n\n\n  // --- COLONNE DROITE : PRENEUR ---\n  const rightColX = pageWidth / 2 + 20; // On commence après le milieu\n  currentPage.drawText(\"LE PRENEUR (Locataire)\", { x: rightColX, y: currentY, size: 10, font: fontBold, color: COLORS.primary });\n  currentPage.drawText(\"Lu et approuvé\", { x: rightColX, y: currentY - 15, size: 9, font: fontRegular, color: COLORS.secondary });\n\n  // Signature Preneur\n  if (data.signatures.tenantSignatureUrl) {\n    try {\n      const sigImage = await fetchAndEmbedImage(pdfDoc, data.signatures.tenantSignatureUrl);\n      if (sigImage) {\n        const sigWidth = 120;\n        const sigHeight = 60;\n        const scaledDims = sigImage.scale(sigWidth / sigImage.width);\n        currentPage.drawImage(sigImage, {\n          x: rightColX,\n          y: currentY - 80,\n          width: Math.min(scaledDims.width, sigWidth),\n          height: Math.min(scaledDims.height, sigHeight),\n        });\n      }\n    } catch (e) {\n      console.warn(\"Pas de signature locataire chargée\");\n    }\n  }\n\n\n  // Footer pour la dernière page\n  drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n\n  // Mettre à jour les numéros de page\n  const totalPages = pdfDoc.getPageCount();\n  const pages = pdfDoc.getPages();\n  pages.forEach((page, idx) => {\n    page.drawText(`Page ${idx + 1} sur ${totalPages}`, {\n      x: pageWidth - margin - 80,\n      y: 30,\n      size: 9,\n      font: fontRegular,\n      color: COLORS.secondary,\n    });\n\n    page.drawLine({\n      start: { x: margin, y: 45 },\n      end: { x: pageWidth - margin, y: 45 },\n      thickness: 0.5,\n      color: COLORS.mediumGray,\n    });\n  });\n}\n\n// --- HELPERS VISUELS ---\n\n/** Dessine l'en-tête avec Logo et Titre Encadré (Empilés) */\nasync function drawHeader(\n  pdfDoc: PDFDocument,\n  page: PDFPage,\n  data: ContractData,\n  options: PDFGenerationOptions,\n  startY: number,\n  pageWidth: number,\n  margin: number,\n  fontBold: PDFFont\n): Promise<number> {\n  let currentY = startY;\n\n  // 1. Logo à Gauche (s'il existe)\n  if (options.logoUrl) {\n    try {\n      const logoImage = await fetchAndEmbedImage(pdfDoc, options.logoUrl);\n      if (logoImage) {\n        const logoHeight = 40;\n        const logoDims = logoImage.scale(logoHeight / logoImage.height);\n        page.drawImage(logoImage, {\n          x: margin, // Gauche\n          y: currentY - logoHeight,\n          width: logoDims.width,\n          height: logoDims.height,\n        });\n\n        // On descend le curseur Y sous le logo + marge\n        currentY -= (logoHeight + 20);\n      }\n    } catch (e) { console.warn(\"Erreur logo\", e); }\n  }\n\n  // 2. Titre Centré et Encadré (Sous le logo)\n  const title = \"CONTRAT DE BAIL A USAGE D'HABITATION\";\n  const subTitle = \"République du Sénégal\";\n  const textSize = 14;\n  const titleWidth = fontBold.widthOfTextAtSize(title, textSize);\n  const boxWidth = titleWidth + 40;\n  const boxHeight = 50;\n  const boxX = (pageWidth - boxWidth) / 2;\n  const boxY = currentY - boxHeight; // Positionné par rapport au nouveau currentY\n\n  // Fond gris léger\n  page.drawRectangle({\n    x: boxX,\n    y: boxY,\n    width: boxWidth,\n    height: boxHeight,\n    color: COLORS.lightGray,\n    borderColor: COLORS.mediumGray,\n    borderWidth: 1,\n  });\n\n  // Texte Titre\n  page.drawText(title, {\n    x: (pageWidth - titleWidth) / 2,\n    y: boxY + 25,\n    size: textSize,\n    font: fontBold,\n    color: COLORS.primary, // Primary Color\n  });\n\n  // Sous-titre\n  const subSize = 10;\n  const subWidth = fontBold.widthOfTextAtSize(subTitle, subSize);\n  page.drawText(subTitle, {\n    x: (pageWidth - subWidth) / 2,\n    y: boxY + 10,\n    size: subSize,\n    font: fontBold,\n    color: COLORS.secondary,\n  });\n\n  return boxY - 30; // Espace après header\n}\n\n/** Dessine la Grille des Parties (Bailleur / Preneur) */\nfunction drawPartiesGrid(\n  page: PDFPage,\n  data: ContractData,\n  startY: number,\n  pageWidth: number,\n  margin: number,\n  fontRegular: PDFFont,\n  fontBold: PDFFont\n): number {\n  const { landlord, tenant } = data;\n  const boxHeight = 160;\n  const colWidth = (pageWidth - (2 * margin) - 10) / 2; // -10 pour gap au milieu\n  const col1X = margin;\n  const col2X = margin + colWidth + 10;\n\n  // Fond global gris très clair pour la zone\n  page.drawRectangle({\n    x: margin,\n    y: startY - boxHeight,\n    width: pageWidth - (2 * margin),\n    height: boxHeight,\n    color: rgb(0.97, 0.97, 0.97),\n    borderColor: rgb(0.9, 0.9, 0.9),\n    borderWidth: 1,\n  }); // Erreur possible si boxHeight trop petit pour le contenu, on assume A4 fixe\n\n  let textY = startY - 20;\n\n  // --- COLONNE 1 : BAILLEUR ---\n  page.drawText(\"LE BAILLEUR\", { x: col1X + 10, y: textY, size: 10, font: fontBold, color: rgb(0.2, 0.2, 0.6) });\n  textY -= 15;\n\n  const lLines = [\n    landlord.companyName ? `Société : ${landlord.companyName}` : `M./Mme : ${landlord.firstName} ${landlord.lastName}`,\n    landlord.companyName && landlord.ninea ? `NINEA : ${landlord.ninea}` : '',\n    `Adresse : ${landlord.address}`,\n    `Tel : ${landlord.phone}`,\n    landlord.email ? `Email : ${landlord.email}` : ''\n  ].filter(l => l);\n\n  let lY = textY;\n  for (const l of lLines) {\n    // Wrap si nécessaire (adresse longue)\n    const wrapped = wrapText(l, fontRegular, 9, colWidth - 20);\n    for (const wL of wrapped) {\n      page.drawText(wL, { x: col1X + 10, y: lY, size: 9, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });\n      lY -= 12;\n    }\n  }\n\n  // --- COLONNE 2 : PRENEUR ---\n  textY = startY - 20; // Reset Y pour colonne 2\n  page.drawText(\"LE PRENEUR\", { x: col2X + 10, y: textY, size: 10, font: fontBold, color: rgb(0.2, 0.2, 0.6) });\n  textY -= 15;\n\n  const tLines = [\n    `M./Mme : ${tenant.firstName} ${tenant.lastName}`,\n    tenant.nationalId ? `CNI / Passeport : ${tenant.nationalId}` : '',\n    `Tel : ${tenant.phone}`,\n    tenant.email ? `Email : ${tenant.email}` : ''\n  ].filter(l => l);\n\n  let tY = textY;\n  for (const l of tLines) {\n    const wrapped = wrapText(l, fontRegular, 9, colWidth - 20);\n    for (const wL of wrapped) {\n      page.drawText(wL, { x: col2X + 10, y: tY, size: 9, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });\n      tY -= 12;\n    }\n  }\n\n  // Ligne verticale de séparation\n  page.drawLine({\n    start: { x: margin + colWidth + 5, y: startY - 10 },\n    end: { x: margin + colWidth + 5, y: startY - boxHeight + 10 },\n    color: rgb(0.8, 0.8, 0.8),\n    thickness: 1\n  });\n\n  return startY - boxHeight; // Retourne la nouvelle position Y\n}\n\n/** Helper simple pour footer temporaire (avant override final) */\nfunction drawFooter(page: PDFPage, pageNum: number, width: number, font: PDFFont) {\n  // Vide intentionnellement ou simple placeholder, le vrai est fait à la fin\n}\n\n\n/**\n * Wrapper le texte pour qu'il tienne dans la largeur maximale, en respectant les sauts de ligne\n */\nfunction wrapText(text: string, font: PDFFont, fontSize: number, maxWidth: number): string[] {\n  // 1. Normaliser les sauts de ligne et ASSAINIR le texte (Char non supportés par WinAnsi - ex 0x202f)\n  const normalizedText = text\n    .replace(/\\r\\n/g, '\\n')\n    .replace(/\\r/g, '\\n')\n    // Espace incésable étroit (0x202f) et autres espaces bizarres -> espace simple\n    .replace(/[\\u00A0\\u2000-\\u200B\\u202F\\u205F\\u3000]/g, ' ')\n    // Guillemets et apostrophes\n    .replace(/[«»“”]/g, '\"')\n    .replace(/[‘’]/g, \"'\")\n    // Tirets\n    .replace(/[–—]/g, '-')\n    // Points de suspension\n    .replace(/…/g, '...');\n\n  // 2. Découper en paragraphes\n  const paragraphs = normalizedText.split('\\n');\n  const allLines: string[] = [];\n\n  for (const paragraph of paragraphs) {\n    if (paragraph.trim() === '') {\n      // Conserver les sauts de ligne vides (paragraphes vides)\n      // On ajoute une ligne vide si ce n'est pas la toute première (évite marge top excessive)\n      // mais ici on veut respecter le format user.\n      allLines.push('');\n      continue;\n    }\n\n    const words = paragraph.split(' ');\n    let currentLine = '';\n\n    for (const word of words) {\n      const testLine = currentLine ? `${currentLine} ${word}` : word;\n      const width = font.widthOfTextAtSize(testLine, fontSize);\n\n      if (width <= maxWidth) {\n        currentLine = testLine;\n      } else {\n        if (currentLine) {\n          allLines.push(currentLine);\n        }\n        currentLine = word;\n      }\n    }\n\n    if (currentLine) {\n      allLines.push(currentLine);\n    }\n  }\n\n  return allLines.length > 0 ? allLines : [''];\n}\n\n/**\n * Ajoute les signatures sur la dernière page\n */\n\n\n/**\n * Ajoute un watermark (filigrane) sur toutes les pages\n */\nasync function addWatermark(pdfDoc: PDFDocument, text: string): Promise<void> {\n  const pages = pdfDoc.getPages();\n  const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);\n\n  pages.forEach(page => {\n    const { width, height } = page.getSize();\n    page.drawText(text, {\n      x: width / 2 - 100,\n      y: height / 2,\n      size: 60,\n      font: font,\n      color: rgb(0.9, 0.9, 0.9),\n      opacity: 0.3,\n      rotate: degrees(-45), // Utiliser degrees() de pdf-lib\n    });\n  });\n}\n\n/**\n * Récupère et embed une image depuis une URL\n */\nasync function fetchAndEmbedImage(pdfDoc: PDFDocument, imageUrl: string) {\n  try {\n    const response = await fetch(imageUrl);\n    const imageBytes = await response.arrayBuffer();\n\n    // Déterminer le type d'image\n    if (imageUrl.toLowerCase().endsWith('.png')) {\n      return await pdfDoc.embedPng(new Uint8Array(imageBytes) as any);\n    } else if (imageUrl.toLowerCase().endsWith('.jpg') || imageUrl.toLowerCase().endsWith('.jpeg')) {\n      return await pdfDoc.embedJpg(new Uint8Array(imageBytes) as any);\n    } else {\n      console.warn('Format d\\'image non supporté:', imageUrl);\n      return null;\n    }\n  } catch (err) {\n    console.error('Erreur chargement image:', err);\n    return null;\n  }\n}\n\n/**\n * Sauvegarde le PDF en fichier (pour Node.js)\n */\nexport async function savePDFToFile(pdfBytes: Uint8Array, filename: string): Promise<void> {\n  if (typeof window === 'undefined') {\n    // Environnement Node.js\n    const fs = await import('fs');\n    fs.writeFileSync(filename, pdfBytes);\n  } else {\n    // Environnement navigateur\n    const blob = new Blob([pdfBytes as any], { type: 'application/pdf' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    link.click();\n    URL.revokeObjectURL(url);\n  }\n}\n\n/**\n * Upload le PDF vers Supabase Storage\n */\nexport async function uploadPDFToStorage(\n  pdfBytes: Uint8Array,\n  filename: string,\n  supabaseClient: any\n): Promise<{ success: boolean; url?: string; error?: string }> {\n  try {\n    const { data, error } = await supabaseClient.storage\n      .from('lease-contracts') // Bucket à créer dans Supabase\n      .upload(filename, pdfBytes, {\n        contentType: 'application/pdf',\n        upsert: true\n      });\n\n    if (error) {\n      return { success: false, error: error.message };\n    }\n\n    // Obtenir l'URL publique\n    const { data: urlData } = supabaseClient.storage\n      .from('lease-contracts')\n      .getPublicUrl(filename);\n\n    return {\n      success: true,\n      url: urlData.publicUrl\n    };\n\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\reminders-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":186,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":186,"endColumn":93,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[7454,7538],"text":"// @ts-expect-error - Le type sendEmail accepte cc mais TypeScript ne le voit pas toujours"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { SupabaseClient } from \"@supabase/supabase-js\";\r\nimport { differenceInDays } from \"date-fns\";\r\nimport { sendEmail } from \"@/lib/mail\";\r\n\r\n// Types\r\nexport interface ReminderResult {\r\n    count: number;\r\n    message: string;\r\n    errors?: Error[];\r\n}\r\n\r\n/**\r\n * Core logic to process reminders.\r\n * Accepts a Supabase client (either User scoped or Admin scoped).\r\n */\r\nexport async function internalProcessReminders(supabase: SupabaseClient): Promise<ReminderResult> {\r\n    console.log(\"🕵️ Recherche des impayés de +5 jours...\");\r\n\r\n    const today = new Date();\r\n\r\n    // Fetch ALL unpaid transactions that haven't been reminded yet\r\n    // We'll calculate the actual due date using billing_day and filter in code\r\n    // This ensures we respect the billing_day configured in the UI modal\r\n    const { data: transactions, error } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(`\r\n      id,\r\n      amount_due,\r\n      status,\r\n      period_month,\r\n      period_year,\r\n      period_start,\r\n      reminder_sent,\r\n      leases (\r\n        id,\r\n        billing_day,\r\n        tenant_email,\r\n        tenant_name,\r\n        property_id,\r\n        owner_id\r\n      )\r\n    `)\r\n        .neq(\"status\", \"paid\") // Not paid\r\n        .eq(\"reminder_sent\", false) // Not reminded\r\n        // Only fetch recent transactions (current year and previous year)\r\n        .gte(\"period_year\", today.getFullYear() - 1);\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching transactions:\", error);\r\n        return { count: 0, message: \"Erreur lors de la récupération des transactions.\", errors: [error] };\r\n    }\r\n\r\n    console.log(`Found ${transactions?.length || 0} candidate transactions from DB.`);\r\n\r\n    if (!transactions || transactions.length === 0) {\r\n        return { count: 0, message: \"Aucun paiement en retard détecté.\" };\r\n    }\r\n\r\n    let emailsSent = 0;\r\n    const errors: Error[] = [];\r\n\r\n    for (const tx of transactions) {\r\n        console.log(`Checking transaction ${tx.id}: Status=${tx.status}, Period=${tx.period_month}/${tx.period_year}`);\r\n\r\n        const lease = tx.leases;\r\n        // Handle case where lease might be an array or null\r\n        // Supabase can return array for relations depending on schema checks/client version\r\n        const leaseData = Array.isArray(lease) ? lease[0] : lease;\r\n\r\n        if (!leaseData) {\r\n            console.log(`-> Skipped: No lease data found.`);\r\n            continue;\r\n        }\r\n\r\n        const billingDay = leaseData.billing_day || 5;\r\n        const periodYear = tx.period_year;\r\n        const periodMonth = tx.period_month;\r\n\r\n        let dueDate: Date;\r\n        try {\r\n            // Month in Date constructor is 0-indexed (0=Jan, 11=Dec)\r\n            dueDate = new Date(periodYear, periodMonth - 1, billingDay);\r\n        } catch (e) {\r\n            console.warn(`-> Skipped: Invalid date for tx ${tx.id}`, e);\r\n            continue;\r\n        }\r\n\r\n        const daysOverdue = differenceInDays(today, dueDate);\r\n        console.log(`-> Due Date: ${dueDate.toISOString().split('T')[0]}, Days Overdue: ${daysOverdue}`);\r\n\r\n        // \"Relance Automatique J+5\": Trigger if 5 or more days have passed since due date.\r\n        if (daysOverdue >= 5) {\r\n            if (leaseData.tenant_email) {\r\n                try {\r\n                    // Récupérer l'email du propriétaire\r\n                    let ownerEmail: string | undefined;\r\n                    if (leaseData.owner_id) {\r\n                        const { data: ownerData } = await supabase.auth.admin.getUserById(leaseData.owner_id);\r\n                        ownerEmail = ownerData?.user?.email;\r\n                    }\r\n\r\n                    await sendReminderEmail(\r\n                        leaseData.tenant_email,\r\n                        leaseData.tenant_name || \"Locataire\",\r\n                        tx.amount_due,\r\n                        dueDate,\r\n                        ownerEmail // Ajout du CC propriétaire\r\n                    );\r\n\r\n                    const { error: updateError } = await supabase\r\n                        .from(\"rental_transactions\")\r\n                        .update({ reminder_sent: true })\r\n                        .eq(\"id\", tx.id);\r\n\r\n                    if (updateError) {\r\n                        console.error(`Failed to update tx ${tx.id}`, updateError);\r\n                        errors.push(updateError instanceof Error ? updateError : new Error(JSON.stringify(updateError)));\r\n                    } else {\r\n                        emailsSent++;\r\n                    }\r\n                } catch (err) {\r\n                    console.error(`Failed to send email to ${leaseData.tenant_email}`, err);\r\n                    errors.push(err instanceof Error ? err : new Error(String(err)));\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return {\r\n        count: emailsSent,\r\n        message: `${emailsSent} relances envoyées avec succès.`,\r\n        errors: errors.length > 0 ? errors : undefined\r\n    };\r\n}\r\n\r\n/**\r\n * Real Email Sender using project's existing mailer\r\n */\r\nasync function sendReminderEmail(email: string, name: string, amount: number, date: Date, ownerEmail?: string) {\r\n    const formattedDate = date.toLocaleDateString(\"fr-FR\", { year: 'numeric', month: 'long', day: 'numeric' });\r\n    const formattedAmount = amount.toLocaleString(\"fr-SN\");\r\n\r\n    const emailHtml = `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <style>\r\n        body { font-family: sans-serif; line-height: 1.6; color: #333; }\r\n        .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n        .header { background-color: #f8f9fa; padding: 20px; text-align: center; border-bottom: 3px solid #dc3545; }\r\n        .content { padding: 30px 20px; }\r\n        .button { background-color: #dc3545; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-top: 15px; }\r\n        .footer { font-size: 12px; color: #666; text-align: center; margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px; }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"container\">\r\n        <div class=\"header\">\r\n          <h2>Rappel de paiement</h2>\r\n        </div>\r\n        <div class=\"content\">\r\n          <p>Bonjour <strong>${name}</strong>,</p>\r\n          <p>Sauf erreur de notre part, nous n'avons pas encore reçu le règlement de votre loyer d'un montant de <strong>${formattedAmount} FCFA</strong>, dont l'échéance était le <strong>${formattedDate}</strong>.</p>\r\n          <p>Nous vous remercions de bien vouloir régulariser votre situation dans les meilleurs délais.</p>\r\n          <p>Si vous avez déjà effectué ce paiement, merci de ne pas tenir compte de ce message.</p>\r\n        </div>\r\n        <div class=\"footer\">\r\n          <p>Ceci est un message automatique envoyé par Doussel Immo.</p>\r\n          ${ownerEmail ? '<p style=\"color: #999; margin-top: 10px;\">Copie envoyée au propriétaire pour information.</p>' : ''}\r\n        </div>\r\n      </div>\r\n    </body>\r\n    </html>\r\n  `;\r\n\r\n    console.log(`📧 Sending Late Reminder to: ${email}${ownerEmail ? ` (CC: ${ownerEmail})` : ''}`);\r\n\r\n    // Préparer les destinataires\r\n    const recipients: string | string[] = email;\r\n    const ccRecipients: string[] | undefined = ownerEmail ? [ownerEmail] : undefined;\r\n\r\n    await sendEmail({\r\n        to: recipients,\r\n        subject: `Rappel : Retard de paiement - Loyer du ${formattedDate}`,\r\n        html: emailHtml,\r\n        // @ts-ignore - Le type sendEmail accepte cc mais TypeScript ne le voit pas toujours\r\n        cc: ccRecipients,\r\n    });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\schemas\\propertySchema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\schemas\\visit-request.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\search-filters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\supabase-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\supabase-client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\turnstile.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\public\\sw.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\add-amount-paid-column.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":18,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey, {\n    auth: {\n        autoRefreshToken: false,\n        persistSession: false\n    }\n});\n\nasync function addAmountPaidColumn() {\n    console.log(\"🔧 === ADDING amount_paid COLUMN ===\\n\");\n\n    try {\n        // Exécuter la requête SQL directement\n        const { data, error } = await supabase.rpc('exec_sql', {\n            sql_query: `\n                ALTER TABLE rental_transactions\n                ADD COLUMN IF NOT EXISTS amount_paid INTEGER DEFAULT 0;\n\n                COMMENT ON COLUMN rental_transactions.amount_paid IS 'Montant réellement payé (en FCFA)';\n            `\n        });\n\n        if (error) {\n            console.error(\"❌ Error:\", error);\n            console.log(\"\\n⚠️  La fonction exec_sql n'existe peut-être pas.\");\n            console.log(\"Veuillez exécuter cette commande SQL manuellement dans Supabase Dashboard:\");\n            console.log(\"\\n```sql\");\n            console.log(\"ALTER TABLE rental_transactions\");\n            console.log(\"ADD COLUMN IF NOT EXISTS amount_paid INTEGER DEFAULT 0;\");\n            console.log(\"\\nCOMMENT ON COLUMN rental_transactions.amount_paid IS 'Montant réellement payé (en FCFA)';\");\n            console.log(\"```\\n\");\n            return;\n        }\n\n        console.log(\"✅ Column added successfully!\");\n    } catch (err) {\n        console.error(\"❌ Error:\", err);\n        console.log(\"\\n📋 MIGRATION SQL À EXÉCUTER MANUELLEMENT:\");\n        console.log(\"─────────────────────────────────────────\");\n        console.log(\"ALTER TABLE rental_transactions\");\n        console.log(\"ADD COLUMN IF NOT EXISTS amount_paid INTEGER DEFAULT 0;\");\n        console.log(\"\\nCOMMENT ON COLUMN rental_transactions.amount_paid IS 'Montant réellement payé (en FCFA)';\");\n        console.log(\"─────────────────────────────────────────\\n\");\n    }\n}\n\naddAmountPaidColumn().catch(console.error);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\add-end-date-column.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'columns' is assigned a value but never used.","line":41,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3673,3676],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3673,3676],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script: Ajouter la colonne end_date à la table leases\r\n * Requis pour les alertes de fin de bail (J-180 et J-90)\r\n */\r\n\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport dotenv from 'dotenv';\r\n\r\n// Charger les variables d'environnement\r\ndotenv.config({ path: '.env.local' });\r\n\r\nconst SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nasync function addEndDateColumn() {\r\n    console.log('🔧 Ajout de la colonne end_date à la table leases...');\r\n\r\n    const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {\r\n        auth: {\r\n            autoRefreshToken: false,\r\n            persistSession: false\r\n        }\r\n    });\r\n\r\n    try {\r\n        // 1. Ajouter la colonne end_date\r\n        const { error: alterError } = await supabase.rpc('exec_sql', {\r\n            query: `\r\n                ALTER TABLE leases\r\n                ADD COLUMN IF NOT EXISTS end_date DATE;\r\n\r\n                COMMENT ON COLUMN leases.end_date IS 'Date de fin prévue du bail. Utilisée pour les alertes J-180 (6 mois) et J-90 (3 mois) conformément au droit sénégalais.';\r\n            `\r\n        });\r\n\r\n        if (alterError) {\r\n            // Si la fonction RPC n'existe pas, on utilise une approche alternative\r\n            console.log('⚠️  La fonction RPC exec_sql n\\'existe pas. Utilisation d\\'une approche alternative...');\r\n\r\n            // Vérifier si la colonne existe déjà\r\n            const { data: columns, error: checkError } = await supabase\r\n                .from('leases')\r\n                .select('*')\r\n                .limit(1);\r\n\r\n            if (checkError) {\r\n                throw new Error(`Erreur lors de la vérification: ${checkError.message}`);\r\n            }\r\n\r\n            console.log('✅ La table leases est accessible.');\r\n            console.log('ℹ️  Veuillez exécuter manuellement cette commande SQL dans l\\'éditeur Supabase:');\r\n            console.log('\\n--- SQL à exécuter ---');\r\n            console.log(`\r\nALTER TABLE leases\r\nADD COLUMN IF NOT EXISTS end_date DATE;\r\n\r\nCOMMENT ON COLUMN leases.end_date IS 'Date de fin prévue du bail. Utilisée pour les alertes J-180 (6 mois) et J-90 (3 mois) conformément au droit sénégalais.';\r\n\r\nCREATE INDEX IF NOT EXISTS idx_leases_end_date_status\r\nON leases(end_date, status)\r\nWHERE status = 'active' AND end_date IS NOT NULL;\r\n            `);\r\n            console.log('----------------------\\n');\r\n\r\n            return;\r\n        }\r\n\r\n        // 2. Créer l'index\r\n        const { error: indexError } = await supabase.rpc('exec_sql', {\r\n            query: `\r\n                CREATE INDEX IF NOT EXISTS idx_leases_end_date_status\r\n                ON leases(end_date, status)\r\n                WHERE status = 'active' AND end_date IS NOT NULL;\r\n            `\r\n        });\r\n\r\n        if (indexError) {\r\n            console.warn('⚠️  Impossible de créer l\\'index (peut déjà exister)');\r\n        }\r\n\r\n        console.log('✅ Colonne end_date ajoutée avec succès !');\r\n\r\n        // 3. Vérifier les baux existants\r\n        const { data: leases, error: leasesError } = await supabase\r\n            .from('leases')\r\n            .select('id, tenant_name, end_date')\r\n            .eq('status', 'active')\r\n            .limit(5);\r\n\r\n        if (leasesError) {\r\n            console.error('❌ Erreur lors de la vérification des baux:', leasesError.message);\r\n        } else {\r\n            console.log(`\\n📋 ${leases?.length || 0} baux actifs trouvés (aperçu)`);\r\n            if (leases && leases.length > 0) {\r\n                console.log('ℹ️  Pensez à définir une end_date pour vos baux actifs.');\r\n            }\r\n        }\r\n\r\n    } catch (error: any) {\r\n        console.error('❌ Erreur:', error.message);\r\n        process.exit(1);\r\n    }\r\n}\r\n\r\naddEndDateColumn();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\analyze-all-unpaid.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\apply-email-verification-migration.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'columns' is assigned a value but never used.","line":34,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'checkError' is assigned a value but never used.","line":34,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour appliquer la migration de vérification d'email\r\n * Usage: npx tsx scripts/apply-email-verification-migration.ts\r\n */\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport * as dotenv from \"dotenv\";\r\n\r\n// Charger .env.local\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nif (!supabaseUrl || !serviceRoleKey) {\r\n    console.error(\"❌ Variables d'environnement manquantes:\");\r\n    console.error(\"   NEXT_PUBLIC_SUPABASE_URL:\", supabaseUrl ? \"✅\" : \"❌\");\r\n    console.error(\"   SUPABASE_SERVICE_ROLE_KEY:\", serviceRoleKey ? \"✅\" : \"❌\");\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, serviceRoleKey, {\r\n    auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false,\r\n    },\r\n});\r\n\r\nasync function applyMigration() {\r\n    console.log(\"🔄 Application de la migration email_verification...\\n\");\r\n\r\n    try {\r\n        // Vérifier si les colonnes existent déjà\r\n        const { data: columns, error: checkError } = await supabase\r\n            .from(\"profiles\")\r\n            .select(\"*\")\r\n            .limit(0);\r\n\r\n        // Si pas d'erreur, la table existe. On tente d'ajouter les colonnes\r\n        // via RPC ou une query directe (nécessite la fonction rpc)\r\n\r\n        // Alternative: utiliser l'API REST admin pour exécuter du SQL\r\n        // Malheureusement Supabase JS client ne supporte pas directement les ALTER TABLE\r\n        // Il faut le faire via le Dashboard ou via supabase db push\r\n\r\n        console.log(\"⚠️  Ne peut pas exécuter ALTER TABLE directement via l'API.\");\r\n        console.log(\"\\n📋 Veuillez exécuter ce SQL dans le Dashboard Supabase:\");\r\n        console.log(\"   1. Allez sur https://supabase.com/dashboard\");\r\n        console.log(\"   2. Sélectionnez votre projet\");\r\n        console.log(\"   3. Allez dans 'SQL Editor'\");\r\n        console.log(\"   4. Copiez-collez le SQL suivant:\\n\");\r\n        console.log(\"─\".repeat(60));\r\n        console.log(`\r\n-- Migration: Add email verification columns to profiles\r\nALTER TABLE public.profiles\r\nADD COLUMN IF NOT EXISTS email_verification_token VARCHAR(255) DEFAULT NULL,\r\nADD COLUMN IF NOT EXISTS email_verification_expires TIMESTAMPTZ DEFAULT NULL;\r\n\r\n-- Index pour recherche rapide\r\nCREATE INDEX IF NOT EXISTS idx_profiles_email_verification_token \r\nON public.profiles(email_verification_token) \r\nWHERE email_verification_token IS NOT NULL;\r\n    `);\r\n        console.log(\"─\".repeat(60));\r\n        console.log(\"\\n   5. Cliquez sur 'Run' pour exécuter\");\r\n        console.log(\"\\n✅ Une fois fait, la fonctionnalité d'email sera opérationnelle!\");\r\n\r\n    } catch (error) {\r\n        console.error(\"❌ Erreur:\", error);\r\n    }\r\n}\r\n\r\napplyMigration();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\apply-migration-end-date.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updated' is assigned a value but never used.","line":70,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":70,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":93,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3480,3483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3480,3483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour appliquer la migration end_date directement\r\n * Usage: npx tsx scripts/apply-migration-end-date.ts\r\n */\r\n\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nif (!supabaseUrl || !supabaseServiceKey) {\r\n  console.error('❌ Variables d\\'environnement manquantes');\r\n  console.error('Assurez-vous que NEXT_PUBLIC_SUPABASE_URL et SUPABASE_SERVICE_ROLE_KEY sont définis');\r\n  process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\nasync function applyMigration() {\r\n  console.log('🔧 Application de la migration end_date...\\n');\r\n\r\n  try {\r\n    // 1. Ajouter la colonne end_date\r\n    console.log('1️⃣ Ajout de la colonne end_date...');\r\n    const { error: alterError } = await supabase.rpc('exec_sql', {\r\n      sql: `\r\n        ALTER TABLE leases\r\n        ADD COLUMN IF NOT EXISTS end_date DATE;\r\n\r\n        COMMENT ON COLUMN leases.end_date IS 'Date de fin prévue du bail. Utilisée pour les alertes J-180 (6 mois) et J-90 (3 mois) conformément au droit sénégalais.';\r\n      `\r\n    });\r\n\r\n    if (alterError && !alterError.message?.includes('already exists')) {\r\n      throw alterError;\r\n    }\r\n    console.log('✅ Colonne end_date ajoutée\\n');\r\n\r\n    // 2. Créer l'index\r\n    console.log('2️⃣ Création de l\\'index...');\r\n    const { error: indexError } = await supabase.rpc('exec_sql', {\r\n      sql: `\r\n        CREATE INDEX IF NOT EXISTS idx_leases_end_date_status\r\n        ON leases(end_date, status)\r\n        WHERE status = 'active' AND end_date IS NOT NULL;\r\n      `\r\n    });\r\n\r\n    if (indexError && !indexError.message?.includes('already exists')) {\r\n      throw indexError;\r\n    }\r\n    console.log('✅ Index créé\\n');\r\n\r\n    // 3. Vérifier que la colonne existe\r\n    console.log('3️⃣ Vérification...');\r\n    const { data: columns, error: checkError } = await supabase\r\n      .from('information_schema.columns')\r\n      .select('column_name, data_type')\r\n      .eq('table_name', 'leases')\r\n      .eq('column_name', 'end_date');\r\n\r\n    if (checkError) {\r\n      console.warn('⚠️  Impossible de vérifier (pas grave):', checkError.message);\r\n    } else if (columns && columns.length > 0) {\r\n      console.log('✅ Colonne confirmée:', columns[0]);\r\n    }\r\n\r\n    // 4. Remplir automatiquement les end_date (durée par défaut: 2 ans)\r\n    console.log('\\n4️⃣ Calcul automatique des dates de fin (2 ans par défaut)...');\r\n    const { data: updated, error: updateError } = await supabase.rpc('exec_sql', {\r\n      sql: `\r\n        UPDATE leases\r\n        SET end_date = start_date + INTERVAL '2 years'\r\n        WHERE end_date IS NULL\r\n          AND start_date IS NOT NULL\r\n          AND status = 'active';\r\n      `\r\n    });\r\n\r\n    if (updateError && !updateError.message?.includes('not found')) {\r\n      console.warn('⚠️  Mise à jour automatique échouée (normal si pas de fonction exec_sql)');\r\n      console.log('   Vous devrez remplir manuellement via le formulaire ou SQL Editor');\r\n    } else {\r\n      console.log('✅ Dates de fin calculées automatiquement\\n');\r\n    }\r\n\r\n    console.log('\\n🎉 Migration terminée avec succès!\\n');\r\n    console.log('📝 Prochaines étapes:');\r\n    console.log('   1. Vérifier dans Supabase Dashboard → Table leases');\r\n    console.log('   2. Remplir les end_date manquantes via le formulaire');\r\n    console.log('   3. Tester l\\'Assistant Juridique\\n');\r\n\r\n  } catch (error: any) {\r\n    console.error('\\n❌ Erreur lors de la migration:', error.message);\r\n    console.error('\\n💡 Solution alternative:');\r\n    console.error('   Ouvrir Supabase Dashboard → SQL Editor');\r\n    console.error('   Copier le contenu de: scripts/apply-end-date-migration.sql');\r\n    console.error('   Exécuter le script manuellement\\n');\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\napplyMigration();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\apply-rental-migration.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabase' is assigned a value but never used.","line":25,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour appliquer la migration des nouveaux champs rental_transactions\r\n *\r\n * Ajoute: period_start, period_end, tenant_id\r\n *\r\n * Usage:\r\n *   npx tsx scripts/apply-rental-migration.ts\r\n */\r\n\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport * as dotenv from 'dotenv';\r\nimport * as path from 'path';\r\nimport * as fs from 'fs';\r\n\r\ndotenv.config({ path: path.resolve(process.cwd(), '.env.local') });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n    console.error('❌ Variables d\\'environnement manquantes');\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function applyMigration() {\r\n    console.log('\\n🔧 APPLICATION DE LA MIGRATION - Nouveaux champs rental_transactions\\n');\r\n\r\n    // Lire le fichier de migration\r\n    const migrationPath = path.resolve(process.cwd(), 'supabase/migrations/20251227000000_add_rental_transaction_fields.sql');\r\n    const migrationSQL = fs.readFileSync(migrationPath, 'utf-8');\r\n\r\n    console.log('📄 Migration SQL chargée depuis:', migrationPath);\r\n    console.log('\\n━'.repeat(80));\r\n    console.log('CONTENU DE LA MIGRATION:');\r\n    console.log('━'.repeat(80));\r\n    console.log(migrationSQL);\r\n    console.log('━'.repeat(80));\r\n\r\n    console.log('\\n⚠️  IMPORTANT: Vous devez exécuter cette migration manuellement via Supabase Dashboard');\r\n    console.log('\\nÉtapes:');\r\n    console.log('1. Allez sur https://supabase.com/dashboard/project/YOUR_PROJECT/sql');\r\n    console.log('2. Copiez le contenu ci-dessus');\r\n    console.log('3. Collez dans l\\'éditeur SQL');\r\n    console.log('4. Cliquez sur \"Run\"');\r\n\r\n    console.log('\\n📋 OU utilisez cette commande curl:\\n');\r\n\r\n    const curlCommand = `curl -X POST \"${supabaseUrl}/rest/v1/rpc/exec_sql\" \\\\\r\n  -H \"apikey: ${supabaseKey}\" \\\\\r\n  -H \"Content-Type: application/json\" \\\\\r\n  -d '${JSON.stringify({ query: migrationSQL })}'`;\r\n\r\n    console.log(curlCommand);\r\n\r\n    console.log('\\n✨ Une fois la migration appliquée, testez le Cron avec:');\r\n    console.log('npm run test:cron-rentals\\n');\r\n}\r\n\r\napplyMigration().catch((error) => {\r\n    console.error('❌ Erreur:', error);\r\n    process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\apply-storage-policies.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'applySQLMigration' is defined but never used.","line":24,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":28,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour appliquer les Storage Policies (RLS) via l'API Supabase\n * Alternative à `supabase db push` quand le CLI n'est pas configuré\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { config } from \"dotenv\";\nimport { readFileSync } from \"fs\";\nimport { join } from \"path\";\n\n// Charger les variables d'environnement\nconfig({ path: \".env.local\" });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error(\"❌ Variables d'environnement manquantes\");\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function applySQLMigration(sqlContent: string) {\n  // L'API Supabase JavaScript ne permet pas d'exécuter du SQL arbitraire\n  // On doit utiliser l'API REST de Supabase (postgres-meta)\n\n  const { data, error } = await supabase.rpc('exec_sql', {\n    sql: sqlContent\n  });\n\n  if (error) {\n    // Si la fonction RPC n'existe pas, on utilise une autre méthode\n    console.error(\"❌ Impossible d'exécuter le SQL via RPC\");\n    console.error(\"Erreur:\", error.message);\n    return false;\n  }\n\n  return true;\n}\n\nasync function main() {\n  console.log(\"🔧 Application des Storage Policies pour verification-docs\\n\");\n\n  // Lire le fichier de migration\n  const migrationPath = join(\n    process.cwd(),\n    \"supabase\",\n    \"migrations\",\n    \"20250101_storage_policies_verification_docs.sql\"\n  );\n\n  let sqlContent: string;\n  try {\n    sqlContent = readFileSync(migrationPath, \"utf-8\");\n    console.log(\"✅ Migration SQL chargée:\", migrationPath);\n  } catch (error) {\n    console.error(\"❌ Impossible de lire le fichier de migration\");\n    console.error(error);\n    process.exit(1);\n  }\n\n  console.log(\"\\n📝 Contenu de la migration:\\n\");\n  console.log(\"=\".repeat(80));\n  console.log(sqlContent);\n  console.log(\"=\".repeat(80));\n\n  console.log(\"\\n⚠️  IMPORTANT: L'API Supabase JavaScript ne permet pas d'exécuter du SQL directement.\");\n  console.log(\"📋 Veuillez suivre ces étapes manuellement:\\n\");\n\n  console.log(\"1️⃣ Ouvrir le Dashboard Supabase:\");\n  console.log(\"   \" + supabaseUrl.replace(\"/rest/v1\", \"\"));\n  console.log(\"\\n2️⃣ Aller dans 'SQL Editor'\");\n  console.log(\"\\n3️⃣ Créer une 'New Query'\");\n  console.log(\"\\n4️⃣ Copier-coller le contenu de la migration (affiché ci-dessus)\");\n  console.log(\"\\n5️⃣ Cliquer sur 'Run' (ou F5)\");\n  console.log(\"\\n6️⃣ Vérifier que les 3 policies sont créées avec succès\\n\");\n\n  console.log(\"✨ Ou utilisez cette commande si vous préférez copier depuis le fichier:\");\n  console.log(`   cat \"${migrationPath}\" | pbcopy   # macOS`);\n  console.log(`   cat \"${migrationPath}\" | xclip -selection clipboard   # Linux`);\n  console.log(`   Get-Content \"${migrationPath}\" | Set-Clipboard   # Windows PowerShell\\n`);\n\n  // Alternative: Afficher les commandes individuelles\n  console.log(\"\\n💡 Alternative: Exécuter les commandes une par une:\\n\");\n\n  const policies = [\n    {\n      name: \"Users can upload to own folder\",\n      operation: \"INSERT\",\n      sql: `\nCREATE POLICY \"Users can upload to own folder\"\nON storage.objects\nFOR INSERT\nTO authenticated\nWITH CHECK (\n  bucket_id = 'verification-docs'\n  AND (storage.foldername(name))[1] = auth.uid()::text\n);`\n    },\n    {\n      name: \"Users can view own files or admins can view all\",\n      operation: \"SELECT\",\n      sql: `\nCREATE POLICY \"Users can view own files or admins can view all\"\nON storage.objects\nFOR SELECT\nTO authenticated\nUSING (\n  bucket_id = 'verification-docs'\n  AND (\n    (storage.foldername(name))[1] = auth.uid()::text\n    OR\n    EXISTS (\n      SELECT 1\n      FROM user_roles\n      WHERE user_id = auth.uid()\n        AND role IN ('admin', 'superadmin', 'moderateur')\n    )\n  )\n);`\n    },\n    {\n      name: \"Users can delete own files\",\n      operation: \"DELETE\",\n      sql: `\nCREATE POLICY \"Users can delete own files\"\nON storage.objects\nFOR DELETE\nTO authenticated\nUSING (\n  bucket_id = 'verification-docs'\n  AND (storage.foldername(name))[1] = auth.uid()::text\n);`\n    }\n  ];\n\n  policies.forEach((policy, index) => {\n    console.log(`\\n${\"─\".repeat(80)}`);\n    console.log(`POLICY ${index + 1}: ${policy.name} (${policy.operation})`);\n    console.log(\"─\".repeat(80));\n    console.log(policy.sql);\n  });\n\n  console.log(\"\\n\\n✅ Une fois les policies créées, testez l'upload depuis l'interface web!\");\n  console.log(\"🔍 Pour vérifier: Storage > verification-docs > Policies\\n\");\n}\n\nmain().catch(console.error);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-all-months.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":48,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1367,1370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1367,1370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@supabase/supabase-js\";\r\nimport { differenceInDays } from \"date-fns\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n    auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n    }\r\n});\r\n\r\nasync function checkAllMonths() {\r\n    console.log(\"🔍 === CHECKING ALL TRANSACTIONS (ALL MONTHS) ===\\n\");\r\n\r\n    const today = new Date();\r\n\r\n    // Get ALL transactions regardless of payment status\r\n    const { data: allTx, error } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(`\r\n            id,\r\n            amount_due,\r\n            status,\r\n            period_month,\r\n            period_year,\r\n            period_start,\r\n            reminder_sent,\r\n            leases (\r\n                billing_day,\r\n                tenant_name,\r\n                property_address,\r\n                owner_id\r\n            )\r\n        `)\r\n        .order(\"period_year\", { ascending: false })\r\n        .order(\"period_month\", { ascending: false });\r\n\r\n    if (error) {\r\n        console.error(\"❌ Error:\", error);\r\n        return;\r\n    }\r\n\r\n    console.log(`📊 Total transactions: ${allTx?.length || 0}\\n`);\r\n\r\n    // Group by status\r\n    const byStatus: Record<string, any[]> = {};\r\n    allTx?.forEach(tx => {\r\n        const status = tx.status || 'unknown';\r\n        if (!byStatus[status]) byStatus[status] = [];\r\n        byStatus[status].push(tx);\r\n    });\r\n\r\n    console.log(\"📊 By Status:\");\r\n    Object.entries(byStatus).forEach(([status, txs]) => {\r\n        console.log(`   ${status}: ${txs.length}`);\r\n    });\r\n\r\n    console.log(\"\\n🔍 Looking for 200k and 58 Rue de Mouzaïa...\\n\");\r\n\r\n    const mouzaia = allTx?.filter(tx => {\r\n        const lease = Array.isArray(tx.leases) ? tx.leases[0] : tx.leases;\r\n        return lease?.property_address?.toLowerCase().includes('mouzaïa') ||\r\n               lease?.property_address?.toLowerCase().includes('mouzaia');\r\n    });\r\n\r\n    if (mouzaia && mouzaia.length > 0) {\r\n        console.log(`Found ${mouzaia.length} transactions for Mouzaïa:\\n`);\r\n        for (const tx of mouzaia) {\r\n            const lease = Array.isArray(tx.leases) ? tx.leases[0] : tx.leases;\r\n            const billingDay = lease?.billing_day || 5;\r\n            const dueDate = new Date(tx.period_year, tx.period_month - 1, billingDay);\r\n            const daysOverdue = differenceInDays(today, dueDate);\r\n\r\n            console.log(`   TX ${tx.id}`);\r\n            console.log(`      Amount: ${tx.amount_due?.toLocaleString()} FCFA`);\r\n            console.log(`      Period: ${tx.period_month}/${tx.period_year}`);\r\n            console.log(`      Status: ${tx.status}`);\r\n            console.log(`      Days overdue: ${daysOverdue}`);\r\n            console.log(`      Reminded: ${tx.reminder_sent}`);\r\n            console.log(`      Property: ${lease?.property_address}\\n`);\r\n        }\r\n    }\r\n\r\n    // Check for 200k amounts\r\n    const largeAmounts = allTx?.filter(tx => tx.amount_due && tx.amount_due >= 180000);\r\n\r\n    if (largeAmounts && largeAmounts.length > 0) {\r\n        console.log(`\\nFound ${largeAmounts.length} transactions >= 180k:\\n`);\r\n        for (const tx of largeAmounts) {\r\n            const lease = Array.isArray(tx.leases) ? tx.leases[0] : tx.leases;\r\n            console.log(`   ${tx.amount_due?.toLocaleString()} FCFA - ${tx.period_month}/${tx.period_year} - ${tx.status}`);\r\n            console.log(`      ${lease?.property_address || 'N/A'}\\n`);\r\n        }\r\n    }\r\n}\r\n\r\ncheckAllMonths().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-coords.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-email-confirmation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-email-verification-columns.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":27,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour vérifier si les colonnes de vérification d'email existent\r\n * Usage: npx tsx scripts/check-email-verification-columns.ts\r\n */\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport * as dotenv from \"dotenv\";\r\n\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nasync function check() {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n    if (!supabaseUrl || !serviceRoleKey) {\r\n        console.error(\"❌ Variables d'environnement manquantes\");\r\n        process.exit(1);\r\n    }\r\n\r\n    const supabase = createClient(supabaseUrl, serviceRoleKey, {\r\n        auth: { autoRefreshToken: false, persistSession: false },\r\n    });\r\n\r\n    console.log(\"🔍 Vérification des colonnes de vérification d'email...\\n\");\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from(\"profiles\")\r\n            .select(\"email_verification_token, email_verification_expires\")\r\n            .limit(1);\r\n\r\n        if (error) {\r\n            console.log(\"❌ Colonnes manquantes!\");\r\n            console.log(\"   Erreur:\", error.message);\r\n            console.log(\"\\n📋 Veuillez exécuter ce SQL dans Supabase Dashboard > SQL Editor:\\n\");\r\n            console.log(`\r\nALTER TABLE public.profiles\r\nADD COLUMN IF NOT EXISTS email_verification_token VARCHAR(255) DEFAULT NULL,\r\nADD COLUMN IF NOT EXISTS email_verification_expires TIMESTAMPTZ DEFAULT NULL;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_profiles_email_verification_token \r\nON public.profiles(email_verification_token) \r\nWHERE email_verification_token IS NOT NULL;\r\n      `);\r\n        } else {\r\n            console.log(\"✅ Colonnes email_verification_* présentes!\");\r\n            console.log(\"   Le système d'email de confirmation est prêt.\");\r\n        }\r\n    } catch (err) {\r\n        console.error(\"❌ Erreur:\", err);\r\n    }\r\n}\r\n\r\ncheck();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-homepage-images.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'type' is defined but never used.","line":32,"column":61,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":72,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":72,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2667,2670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2667,2670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":99,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":99,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":137,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4168,4171],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4168,4171],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4382,4385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4382,4385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour vérifier spécifiquement les images des propriétés affichées sur la home page\r\n * et les remplacer si elles sont cassées\r\n * \r\n * Usage: npm run check-homepage-images\r\n */\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport * as dotenv from \"dotenv\";\r\n\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nconst PEXELS_API_KEY = \"3eFVqLX19mBYTUVCMxhpPH156xmJ8K5ccP5TBwH5R2h90pHMmgb638AS\";\r\nconst PEXELS_API_URL = \"https://api.pexels.com/v1/search\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n  console.error(\"❌ Variables d'environnement manquantes\");\r\n  process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey, {\r\n  auth: {\r\n    autoRefreshToken: false,\r\n    persistSession: false,\r\n    detectSessionInUrl: false,\r\n  },\r\n});\r\n\r\nconst getSearchQuery = (title: string, description: string, type?: string): string => {\r\n  const text = `${title} ${description}`.toLowerCase();\r\n  \r\n  if (text.includes(\"terrain\") || text.includes(\"land\")) {\r\n    return \"empty land plot construction\";\r\n  }\r\n  if (text.includes(\"villa\") || text.includes(\"maison\") || text.includes(\"house\")) {\r\n    return \"modern white villa exterior\";\r\n  }\r\n  if (text.includes(\"appartement\") || text.includes(\"apartment\")) {\r\n    return \"modern apartment interior\";\r\n  }\r\n  if (text.includes(\"studio\")) {\r\n    return \"studio apartment interior design\";\r\n  }\r\n  if (text.includes(\"bureau\") || text.includes(\"office\")) {\r\n    return \"modern office space\";\r\n  }\r\n  if (text.includes(\"piscine\") || text.includes(\"pool\")) {\r\n    return \"luxury house with pool\";\r\n  }\r\n  \r\n  return \"modern real estate property\";\r\n};\r\n\r\nasync function checkImageExists(url: string): Promise<boolean> {\r\n  try {\r\n    const response = await fetch(url, {\r\n      method: \"HEAD\",\r\n      signal: AbortSignal.timeout(5000),\r\n    });\r\n    \r\n    if (response.ok && response.status === 200) {\r\n      const contentType = response.headers.get(\"content-type\");\r\n      if (contentType && !contentType.startsWith(\"image/\")) {\r\n        return false;\r\n      }\r\n      return true;\r\n    }\r\n    return false;\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchPexelsImages(query: string, count: number = 3): Promise<string[]> {\r\n  try {\r\n    const response = await fetch(`${PEXELS_API_URL}?query=${encodeURIComponent(query)}&per_page=${count}`, {\r\n      headers: {\r\n        Authorization: PEXELS_API_KEY,\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      return [];\r\n    }\r\n\r\n    const data = await response.json();\r\n    const images = data.photos?.map((photo: any) => {\r\n      const url = photo.src?.large || photo.src?.original || photo.src?.medium;\r\n      if (url && typeof url === \"string\") {\r\n        return url.startsWith(\"http\") ? url : `https:${url}`;\r\n      }\r\n      return null;\r\n    }).filter((url: string | null): url is string => url !== null && url.length > 0) || [];\r\n    \r\n    return images;\r\n  } catch (error) {\r\n    return [];\r\n  }\r\n}\r\n\r\nasync function checkHomepageImages() {\r\n  console.log(\"🔍 Vérification des images des propriétés de la home page...\\n\");\r\n\r\n  // Récupérer les propriétés comme sur la home page\r\n  const [locations, ventes, terrains] = await Promise.all([\r\n    // Locations à Dakar\r\n    supabase\r\n      .from(\"properties\")\r\n      .select(\"id, title, description, images, details, location\")\r\n      .eq(\"category\", \"location\")\r\n      .eq(\"location->>city\", \"Dakar\")\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(8),\r\n    \r\n    // Ventes (exclut terrains)\r\n    supabase\r\n      .from(\"properties\")\r\n      .select(\"id, title, description, images, details, location\")\r\n      .eq(\"category\", \"vente\")\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(20),\r\n    \r\n    // Terrains\r\n    supabase\r\n      .from(\"properties\")\r\n      .select(\"id, title, description, images, details, location\")\r\n      .eq(\"category\", \"vente\")\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(20),\r\n  ]);\r\n\r\n  // Filtrer comme sur la home page\r\n  const ventesFiltered = (ventes.data || []).filter(\r\n    (p: any) =>\r\n      p.details?.type === \"Maison\" ||\r\n      p.details?.type === \"Appartement\" ||\r\n      p.details?.type === \"Studio\"\r\n  ).slice(0, 8);\r\n\r\n  const terrainsFiltered = (terrains.data || []).filter(\r\n    (p: any) =>\r\n      p.details?.type?.toLowerCase().includes(\"terrain\") ||\r\n      p.title?.toLowerCase().includes(\"terrain\") ||\r\n      p.description?.toLowerCase().includes(\"terrain\")\r\n  ).slice(0, 8);\r\n\r\n  const allProperties = [\r\n    ...(locations.data || []),\r\n    ...ventesFiltered,\r\n    ...terrainsFiltered,\r\n  ];\r\n\r\n  console.log(`📦 ${allProperties.length} propriétés trouvées sur la home page\\n`);\r\n\r\n  let updated = 0;\r\n  let totalBroken = 0;\r\n\r\n  for (const property of allProperties) {\r\n    const images = property.images as string[] | null;\r\n    \r\n    if (!images || !Array.isArray(images) || images.length === 0) {\r\n      continue;\r\n    }\r\n\r\n    console.log(`🔄 Vérification: ${property.title}`);\r\n    console.log(`   ${images.length} image(s) à vérifier`);\r\n\r\n    const brokenIndices: number[] = [];\r\n    \r\n    for (let i = 0; i < images.length; i++) {\r\n      const img = images[i];\r\n      if (!img || typeof img !== \"string\" || img.length === 0) {\r\n        brokenIndices.push(i);\r\n        continue;\r\n      }\r\n      \r\n      const exists = await checkImageExists(img);\r\n      if (!exists) {\r\n        brokenIndices.push(i);\r\n        console.log(`   ❌ Image ${i + 1} cassée: ${img.substring(0, 60)}...`);\r\n      }\r\n    }\r\n\r\n    if (brokenIndices.length === 0) {\r\n      console.log(`   ✅ Toutes les images sont valides\\n`);\r\n      continue;\r\n    }\r\n\r\n    totalBroken += brokenIndices.length;\r\n    console.log(`   ⚠️ ${brokenIndices.length} image(s) cassée(s) détectée(s)`);\r\n\r\n    const searchQuery = getSearchQuery(\r\n      property.title || \"\",\r\n      property.description || \"\",\r\n      property.details?.type\r\n    );\r\n\r\n    console.log(`   🔍 Recherche Pexels: \"${searchQuery}\"`);\r\n\r\n    const newImages = await fetchPexelsImages(searchQuery, brokenIndices.length);\r\n\r\n    if (newImages.length === 0) {\r\n      console.log(`   ⚠️ Aucune image Pexels trouvée\\n`);\r\n      continue;\r\n    }\r\n\r\n    const updatedImages = images.map((img, index) => {\r\n      if (brokenIndices.includes(index)) {\r\n        const pexelsImage = newImages[brokenIndices.indexOf(index) % newImages.length];\r\n        if (pexelsImage) {\r\n          console.log(`   ✅ Remplacement image ${index + 1} par Pexels`);\r\n          return pexelsImage;\r\n        }\r\n      }\r\n      return img;\r\n    }).filter((img) => img && typeof img === \"string\" && img.length > 0);\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"properties\")\r\n      .update({ images: updatedImages })\r\n      .eq(\"id\", property.id);\r\n\r\n    if (updateError) {\r\n      console.error(`   ❌ Erreur lors de la mise à jour:`, updateError);\r\n    } else {\r\n      console.log(`   ✅ ${brokenIndices.length} image(s) remplacée(s)\\n`);\r\n      updated++;\r\n    }\r\n\r\n    await new Promise((resolve) => setTimeout(resolve, 1000));\r\n  }\r\n\r\n  console.log(`\\n✨ Terminé!`);\r\n  console.log(`   📊 ${updated} propriétés mises à jour`);\r\n  console.log(`   📊 ${totalBroken} image(s) cassée(s) remplacée(s)`);\r\n}\r\n\r\ncheckHomepageImages()\r\n  .then(() => {\r\n    console.log(\"\\n🎉 Script terminé avec succès\");\r\n    process.exit(0);\r\n  })\r\n  .catch((error) => {\r\n    console.error(\"\\n❌ Erreur fatale:\", error);\r\n    process.exit(1);\r\n  });\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-late-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-manifest.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":8,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":8,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":9,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":9,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":175,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":175,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":176,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":176,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'iconsPath' is assigned a value but never used.","line":179,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":179,"endColumn":16}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Script de vérification du manifest.json\r\n * Usage: node scripts/check-manifest.js\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst manifestPath = path.join(__dirname, '..', 'public', 'manifest.json');\r\nconst iconsPath = path.join(__dirname, '..', 'public', 'icons');\r\n\r\nconsole.log('🔍 Vérification du manifest.json...\\n');\r\n\r\n// 1. Vérifier que le fichier existe\r\nif (!fs.existsSync(manifestPath)) {\r\n  console.error('❌ Le fichier manifest.json n\\'existe pas !');\r\n  console.error(`   Chemin attendu: ${manifestPath}`);\r\n  process.exit(1);\r\n}\r\n\r\n// 2. Lire et parser le JSON\r\nlet manifest;\r\ntry {\r\n  const content = fs.readFileSync(manifestPath, 'utf8');\r\n  manifest = JSON.parse(content);\r\n  console.log('✅ JSON valide\\n');\r\n} catch (error) {\r\n  console.error('❌ Erreur de syntaxe JSON:', error.message);\r\n  process.exit(1);\r\n}\r\n\r\n// 3. Vérifier les propriétés essentielles\r\nconst checks = [\r\n  {\r\n    name: 'name',\r\n    value: manifest.name,\r\n    required: true,\r\n    message: 'Nom de l\\'application',\r\n  },\r\n  {\r\n    name: 'short_name',\r\n    value: manifest.short_name,\r\n    required: true,\r\n    message: 'Nom court (max 12 caractères)',\r\n    validate: (val) => val.length <= 12,\r\n  },\r\n  {\r\n    name: 'start_url',\r\n    value: manifest.start_url,\r\n    required: true,\r\n    message: 'URL de démarrage',\r\n  },\r\n  {\r\n    name: 'display',\r\n    value: manifest.display,\r\n    required: true,\r\n    expected: 'standalone',\r\n    message: 'Mode d\\'affichage (doit être \"standalone\")',\r\n  },\r\n  {\r\n    name: 'background_color',\r\n    value: manifest.background_color,\r\n    required: true,\r\n    expected: '#05080c',\r\n    message: 'Couleur de fond (doit être #05080c pour éviter les bords blancs)',\r\n  },\r\n  {\r\n    name: 'theme_color',\r\n    value: manifest.theme_color,\r\n    required: true,\r\n    expected: '#05080c',\r\n    message: 'Couleur du thème',\r\n  },\r\n  {\r\n    name: 'icons',\r\n    value: manifest.icons,\r\n    required: true,\r\n    message: 'Icônes (doit être un tableau)',\r\n    validate: (val) => Array.isArray(val) && val.length >= 2,\r\n  },\r\n];\r\n\r\nlet hasErrors = false;\r\n\r\nconsole.log('📋 Vérification des propriétés :\\n');\r\n\r\nchecks.forEach((check) => {\r\n  if (check.required && !manifest[check.name]) {\r\n    console.error(`❌ ${check.name}: MANQUANT - ${check.message}`);\r\n    hasErrors = true;\r\n    return;\r\n  }\r\n\r\n  if (check.expected && manifest[check.name] !== check.expected) {\r\n    console.error(\r\n      `❌ ${check.name}: \"${manifest[check.name]}\" (attendu: \"${check.expected}\") - ${check.message}`\r\n    );\r\n    hasErrors = true;\r\n    return;\r\n  }\r\n\r\n  if (check.validate && !check.validate(manifest[check.name])) {\r\n    console.error(`❌ ${check.name}: VALIDATION ÉCHOUÉE - ${check.message}`);\r\n    hasErrors = true;\r\n    return;\r\n  }\r\n\r\n  console.log(`✅ ${check.name}: ${JSON.stringify(manifest[check.name])}`);\r\n});\r\n\r\n// 4. Vérifier les icônes\r\nconsole.log('\\n🖼️  Vérification des icônes :\\n');\r\n\r\nif (manifest.icons && Array.isArray(manifest.icons)) {\r\n  const requiredSizes = ['192x192', '512x512'];\r\n  const foundSizes = [];\r\n\r\n  manifest.icons.forEach((icon, index) => {\r\n    const iconPath = path.join(__dirname, '..', 'public', icon.src);\r\n    const exists = fs.existsSync(iconPath);\r\n\r\n    if (!exists) {\r\n      console.error(`❌ Icône ${index + 1}: Fichier introuvable - ${icon.src}`);\r\n      hasErrors = true;\r\n    } else {\r\n      console.log(`✅ Icône ${index + 1}: ${icon.src} (${icon.sizes})`);\r\n    }\r\n\r\n    if (icon.sizes) {\r\n      foundSizes.push(icon.sizes);\r\n    }\r\n\r\n    // Vérifier purpose\r\n    if (icon.purpose && icon.purpose !== 'any') {\r\n      console.warn(\r\n        `⚠️  Icône ${index + 1}: purpose=\"${icon.purpose}\" (recommandé: \"any\" pour éviter les bords blancs)`\r\n      );\r\n    }\r\n  });\r\n\r\n  // Vérifier que toutes les tailles requises sont présentes\r\n  requiredSizes.forEach((size) => {\r\n    if (!foundSizes.includes(size)) {\r\n      console.error(`❌ Taille d'icône manquante: ${size}`);\r\n      hasErrors = true;\r\n    }\r\n  });\r\n} else {\r\n  console.error('❌ Aucune icône trouvée dans le manifest');\r\n  hasErrors = true;\r\n}\r\n\r\n// 5. Résumé\r\nconsole.log('\\n' + '='.repeat(50));\r\nif (hasErrors) {\r\n  console.error('\\n❌ Le manifest.json contient des erreurs. Corrigez-les avant de déployer.\\n');\r\n  process.exit(1);\r\n} else {\r\n  console.log('\\n✅ Le manifest.json est correct !\\n');\r\n  console.log('📱 Prochaines étapes :');\r\n  console.log('   1. Testez avec Lighthouse (Chrome DevTools > Lighthouse > PWA)');\r\n  console.log('   2. Vérifiez sur mobile (iOS Safari et Android Chrome)');\r\n  console.log('   3. Utilisez PWA Builder : https://www.pwabuilder.com/\\n');\r\n  process.exit(0);\r\n}\r\n\r\n\r\n/**\r\n * Script de vérification du manifest.json\r\n * Usage: node scripts/check-manifest.js\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst manifestPath = path.join(__dirname, '..', 'public', 'manifest.json');\r\nconst iconsPath = path.join(__dirname, '..', 'public', 'icons');\r\n\r\nconsole.log('🔍 Vérification du manifest.json...\\n');\r\n\r\n// 1. Vérifier que le fichier existe\r\nif (!fs.existsSync(manifestPath)) {\r\n  console.error('❌ Le fichier manifest.json n\\'existe pas !');\r\n  console.error(`   Chemin attendu: ${manifestPath}`);\r\n  process.exit(1);\r\n}\r\n\r\n// 2. Lire et parser le JSON\r\nlet manifest;\r\ntry {\r\n  const content = fs.readFileSync(manifestPath, 'utf8');\r\n  manifest = JSON.parse(content);\r\n  console.log('✅ JSON valide\\n');\r\n} catch (error) {\r\n  console.error('❌ Erreur de syntaxe JSON:', error.message);\r\n  process.exit(1);\r\n}\r\n\r\n// 3. Vérifier les propriétés essentielles\r\nconst checks = [\r\n  {\r\n    name: 'name',\r\n    value: manifest.name,\r\n    required: true,\r\n    message: 'Nom de l\\'application',\r\n  },\r\n  {\r\n    name: 'short_name',\r\n    value: manifest.short_name,\r\n    required: true,\r\n    message: 'Nom court (max 12 caractères)',\r\n    validate: (val) => val.length <= 12,\r\n  },\r\n  {\r\n    name: 'start_url',\r\n    value: manifest.start_url,\r\n    required: true,\r\n    message: 'URL de démarrage',\r\n  },\r\n  {\r\n    name: 'display',\r\n    value: manifest.display,\r\n    required: true,\r\n    expected: 'standalone',\r\n    message: 'Mode d\\'affichage (doit être \"standalone\")',\r\n  },\r\n  {\r\n    name: 'background_color',\r\n    value: manifest.background_color,\r\n    required: true,\r\n    expected: '#05080c',\r\n    message: 'Couleur de fond (doit être #05080c pour éviter les bords blancs)',\r\n  },\r\n  {\r\n    name: 'theme_color',\r\n    value: manifest.theme_color,\r\n    required: true,\r\n    expected: '#05080c',\r\n    message: 'Couleur du thème',\r\n  },\r\n  {\r\n    name: 'icons',\r\n    value: manifest.icons,\r\n    required: true,\r\n    message: 'Icônes (doit être un tableau)',\r\n    validate: (val) => Array.isArray(val) && val.length >= 2,\r\n  },\r\n];\r\n\r\nlet hasErrors = false;\r\n\r\nconsole.log('📋 Vérification des propriétés :\\n');\r\n\r\nchecks.forEach((check) => {\r\n  if (check.required && !manifest[check.name]) {\r\n    console.error(`❌ ${check.name}: MANQUANT - ${check.message}`);\r\n    hasErrors = true;\r\n    return;\r\n  }\r\n\r\n  if (check.expected && manifest[check.name] !== check.expected) {\r\n    console.error(\r\n      `❌ ${check.name}: \"${manifest[check.name]}\" (attendu: \"${check.expected}\") - ${check.message}`\r\n    );\r\n    hasErrors = true;\r\n    return;\r\n  }\r\n\r\n  if (check.validate && !check.validate(manifest[check.name])) {\r\n    console.error(`❌ ${check.name}: VALIDATION ÉCHOUÉE - ${check.message}`);\r\n    hasErrors = true;\r\n    return;\r\n  }\r\n\r\n  console.log(`✅ ${check.name}: ${JSON.stringify(manifest[check.name])}`);\r\n});\r\n\r\n// 4. Vérifier les icônes\r\nconsole.log('\\n🖼️  Vérification des icônes :\\n');\r\n\r\nif (manifest.icons && Array.isArray(manifest.icons)) {\r\n  const requiredSizes = ['192x192', '512x512'];\r\n  const foundSizes = [];\r\n\r\n  manifest.icons.forEach((icon, index) => {\r\n    const iconPath = path.join(__dirname, '..', 'public', icon.src);\r\n    const exists = fs.existsSync(iconPath);\r\n\r\n    if (!exists) {\r\n      console.error(`❌ Icône ${index + 1}: Fichier introuvable - ${icon.src}`);\r\n      hasErrors = true;\r\n    } else {\r\n      console.log(`✅ Icône ${index + 1}: ${icon.src} (${icon.sizes})`);\r\n    }\r\n\r\n    if (icon.sizes) {\r\n      foundSizes.push(icon.sizes);\r\n    }\r\n\r\n    // Vérifier purpose\r\n    if (icon.purpose && icon.purpose !== 'any') {\r\n      console.warn(\r\n        `⚠️  Icône ${index + 1}: purpose=\"${icon.purpose}\" (recommandé: \"any\" pour éviter les bords blancs)`\r\n      );\r\n    }\r\n  });\r\n\r\n  // Vérifier que toutes les tailles requises sont présentes\r\n  requiredSizes.forEach((size) => {\r\n    if (!foundSizes.includes(size)) {\r\n      console.error(`❌ Taille d'icône manquante: ${size}`);\r\n      hasErrors = true;\r\n    }\r\n  });\r\n} else {\r\n  console.error('❌ Aucune icône trouvée dans le manifest');\r\n  hasErrors = true;\r\n}\r\n\r\n// 5. Résumé\r\nconsole.log('\\n' + '='.repeat(50));\r\nif (hasErrors) {\r\n  console.error('\\n❌ Le manifest.json contient des erreurs. Corrigez-les avant de déployer.\\n');\r\n  process.exit(1);\r\n} else {\r\n  console.log('\\n✅ Le manifest.json est correct !\\n');\r\n  console.log('📱 Prochaines étapes :');\r\n  console.log('   1. Testez avec Lighthouse (Chrome DevTools > Lighthouse > PWA)');\r\n  console.log('   2. Vérifiez sur mobile (iOS Safari et Android Chrome)');\r\n  console.log('   3. Utilisez PWA Builder : https://www.pwabuilder.com/\\n');\r\n  process.exit(0);\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-property-owner.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-property.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-reminders-logic.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1135,1138],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1135,1138],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createAdminClient } from '../lib/supabase-admin';\nimport { differenceInDays } from 'date-fns';\n\nasync function checkRemindersLogic() {\n    const supabase = createAdminClient();\n    const today = new Date();\n\n    console.log('\\n=== DIAGNOSTIC RELANCES J+5 ===\\n');\n    console.log('Date actuelle:', today.toISOString());\n    console.log('Jour du mois:', today.getDate());\n\n    // Récupérer toutes les transactions non payées de Décembre 2025\n    const { data: transactions, error } = await supabase\n        .from('rental_transactions')\n        .select(`\n            id,\n            period_month,\n            period_year,\n            status,\n            reminder_sent,\n            leases (\n                tenant_name,\n                tenant_email,\n                billing_day,\n                monthly_amount\n            )\n        `)\n        .eq('period_month', 12)\n        .eq('period_year', 2025)\n        .neq('status', 'paid');\n\n    if (error) {\n        console.error('Erreur:', error);\n        return;\n    }\n\n    console.log(`\\nTransactions non payées trouvées: ${transactions.length}\\n`);\n\n    transactions.forEach((trans: any) => {\n        const billingDay = trans.leases?.billing_day || 5;\n        const dueDate = new Date(2025, 11, billingDay); // Décembre 2025\n        const daysOverdue = differenceInDays(today, dueDate);\n\n        console.log('---');\n        console.log('Locataire:', trans.leases?.tenant_name);\n        console.log('Email:', trans.leases?.tenant_email);\n        console.log('Montant:', trans.leases?.monthly_amount, 'FCFA');\n        console.log('Jour de facturation:', billingDay);\n        console.log('Date d\\'échéance:', dueDate.toISOString().split('T')[0]);\n        console.log('Jours de retard:', daysOverdue);\n        console.log('Statut:', trans.status);\n        console.log('Relance déjà envoyée?', trans.reminder_sent);\n\n        // Vérifier si devrait recevoir une relance\n        if (daysOverdue >= 5 && !trans.reminder_sent && trans.leases?.tenant_email) {\n            console.log('✅ DEVRAIT RECEVOIR RELANCE');\n        } else {\n            console.log('❌ PAS DE RELANCE:');\n            if (daysOverdue < 5) console.log('   - Pas encore J+5');\n            if (trans.reminder_sent) console.log('   - Relance déjà envoyée');\n            if (!trans.leases?.tenant_email) console.log('   - Email manquant');\n        }\n    });\n\n    console.log('\\n=== FIN DIAGNOSTIC ===\\n');\n}\n\ncheckRemindersLogic();\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-signup-issues.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":212,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":212,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script de vérification des problèmes potentiels dans le parcours d'inscription\n * Usage: npx tsx scripts/check-signup-issues.ts\n */\n\nimport { config } from \"dotenv\";\nimport { resolve } from \"path\";\nimport { readFileSync, existsSync } from \"fs\";\n\n// Charger les variables d'environnement\nconst envResult = config({ path: resolve(process.cwd(), \".env.local\") });\n\nif (envResult.error) {\n  console.warn(\"⚠️  Impossible de charger .env.local:\", envResult.error.message);\n}\n\nconst colors = {\n  reset: \"\\x1b[0m\",\n  green: \"\\x1b[32m\",\n  red: \"\\x1b[31m\",\n  yellow: \"\\x1b[33m\",\n  cyan: \"\\x1b[36m\",\n};\n\nfunction log(message: string, color: keyof typeof colors = \"reset\") {\n  console.log(`${colors[color]}${message}${colors.reset}`);\n}\n\nfunction logIssue(issue: string, severity: \"error\" | \"warning\" | \"info\") {\n  const icon = severity === \"error\" ? \"❌\" : severity === \"warning\" ? \"⚠️\" : \"ℹ️\";\n  const color = severity === \"error\" ? \"red\" : severity === \"warning\" ? \"yellow\" : \"cyan\";\n  log(`${icon} ${issue}`, color);\n}\n\nasync function checkSignupIssues() {\n  console.log(\"\\n\" + \"=\".repeat(60));\n  log(\"🔍 VÉRIFICATION DES PROBLÈMES POTENTIELS\", \"cyan\");\n  console.log(\"=\".repeat(60) + \"\\n\");\n\n  const issues: Array<{ severity: \"error\" | \"warning\" | \"info\"; message: string }> = [];\n\n  // 1. Vérifier les fichiers critiques\n  log(\"1. Vérification des fichiers critiques\", \"cyan\");\n  const criticalFiles = [\n    \"app/register/page.tsx\",\n    \"app/auth/actions.ts\",\n    \"app/auth/callback/route.ts\",\n    \"lib/mail-gmail.ts\",\n  ];\n\n  for (const file of criticalFiles) {\n    if (existsSync(file)) {\n      log(`   ✅ ${file}`, \"green\");\n    } else {\n      issues.push({ severity: \"error\", message: `Fichier manquant: ${file}` });\n      logIssue(`Fichier manquant: ${file}`, \"error\");\n    }\n  }\n\n  // 2. Vérifier les imports dans app/register/page.tsx\n  log(\"\\n2. Vérification des imports\", \"cyan\");\n  try {\n    const registerContent = readFileSync(\"app/register/page.tsx\", \"utf-8\");\n    \n    const requiredImports = [\n      \"signup\",\n      \"resendConfirmationEmail\",\n      \"PhoneInput\",\n      \"Captcha\",\n    ];\n\n    for (const imp of requiredImports) {\n      if (registerContent.includes(imp)) {\n        log(`   ✅ Import ${imp}`, \"green\");\n      } else {\n        issues.push({ severity: \"error\", message: `Import manquant: ${imp}` });\n        logIssue(`Import manquant: ${imp}`, \"error\");\n      }\n    }\n\n    // Vérifier la gestion de emailSent\n    if (registerContent.includes(\"emailSent\") && registerContent.includes(\"setEmailSent\")) {\n      log(`   ✅ Gestion de emailSent`, \"green\");\n    } else {\n      issues.push({ severity: \"warning\", message: \"Gestion de emailSent incomplète\" });\n      logIssue(\"Gestion de emailSent incomplète\", \"warning\");\n    }\n  } catch (error) {\n    issues.push({ severity: \"error\", message: `Erreur lecture app/register/page.tsx: ${error}` });\n    logIssue(`Erreur lecture app/register/page.tsx: ${error}`, \"error\");\n  }\n\n  // 3. Vérifier app/auth/actions.ts\n  log(\"\\n3. Vérification de app/auth/actions.ts\", \"cyan\");\n  try {\n    const actionsContent = readFileSync(\"app/auth/actions.ts\", \"utf-8\");\n    \n    const requiredFunctions = [\n      \"export async function signup\",\n      \"export async function resendConfirmationEmail\",\n      \"sendVerificationEmailGmail\",\n    ];\n\n    for (const func of requiredFunctions) {\n      if (actionsContent.includes(func)) {\n        log(`   ✅ Fonction trouvée: ${func.split(\" \")[3]}`, \"green\");\n      } else {\n        issues.push({ severity: \"error\", message: `Fonction manquante: ${func}` });\n        logIssue(`Fonction manquante: ${func}`, \"error\");\n      }\n    }\n\n    // Vérifier la gestion de emailConfirmationRequired\n    if (actionsContent.includes(\"emailConfirmationRequired\")) {\n      log(`   ✅ Gestion de emailConfirmationRequired`, \"green\");\n    } else {\n      issues.push({ severity: \"warning\", message: \"Gestion de emailConfirmationRequired manquante\" });\n      logIssue(\"Gestion de emailConfirmationRequired manquante\", \"warning\");\n    }\n  } catch (error) {\n    issues.push({ severity: \"error\", message: `Erreur lecture app/auth/actions.ts: ${error}` });\n    logIssue(`Erreur lecture app/auth/actions.ts: ${error}`, \"error\");\n  }\n\n  // 4. Vérifier app/auth/callback/route.ts\n  log(\"\\n4. Vérification de app/auth/callback/route.ts\", \"cyan\");\n  try {\n    const callbackContent = readFileSync(\"app/auth/callback/route.ts\", \"utf-8\");\n    \n    if (callbackContent.includes(\"exchangeCodeForSession\")) {\n      log(`   ✅ exchangeCodeForSession utilisé`, \"green\");\n    } else {\n      issues.push({ severity: \"error\", message: \"exchangeCodeForSession manquant dans callback\" });\n      logIssue(\"exchangeCodeForSession manquant dans callback\", \"error\");\n    }\n\n    if (callbackContent.includes(\"GET\")) {\n      log(`   ✅ Route GET définie`, \"green\");\n    } else {\n      issues.push({ severity: \"error\", message: \"Route GET manquante dans callback\" });\n      logIssue(\"Route GET manquante dans callback\", \"error\");\n    }\n  } catch (error) {\n    issues.push({ severity: \"error\", message: `Erreur lecture app/auth/callback/route.ts: ${error}` });\n    logIssue(`Erreur lecture app/auth/callback/route.ts: ${error}`, \"error\");\n  }\n\n  // 5. Vérifier les variables d'environnement\n  log(\"\\n5. Vérification des variables d'environnement\", \"cyan\");\n  const requiredEnvVars = [\n    \"NEXT_PUBLIC_SUPABASE_URL\",\n    \"NEXT_PUBLIC_SUPABASE_ANON_KEY\",\n    \"GMAIL_USER\",\n    \"GMAIL_APP_PASSWORD\",\n  ];\n\n  const optionalEnvVars = [\n    \"SUPABASE_SERVICE_ROLE_KEY\",\n    \"NEXT_PUBLIC_APP_URL\",\n    \"NEXT_PUBLIC_TURNSTILE_SITE_KEY\",\n  ];\n\n  for (const envVar of requiredEnvVars) {\n    if (process.env[envVar]) {\n      log(`   ✅ ${envVar}`, \"green\");\n    } else {\n      issues.push({ severity: \"error\", message: `Variable d'environnement manquante: ${envVar}` });\n      logIssue(`Variable d'environnement manquante: ${envVar}`, \"error\");\n    }\n  }\n\n  for (const envVar of optionalEnvVars) {\n    if (process.env[envVar]) {\n      log(`   ✅ ${envVar} (optionnel)`, \"green\");\n    } else {\n      issues.push({ severity: \"warning\", message: `Variable d'environnement optionnelle manquante: ${envVar}` });\n      logIssue(`Variable d'environnement optionnelle manquante: ${envVar}`, \"warning\");\n    }\n  }\n\n  // 6. Vérifier que Supabase Auth est utilisé correctement\n  log(\"\\n6. Vérification de l'utilisation de Supabase Auth\", \"cyan\");\n  try {\n    const actionsContent = readFileSync(\"app/auth/actions.ts\", \"utf-8\");\n    \n    if (actionsContent.includes(\"supabase.auth.signUp\")) {\n      log(`   ✅ signUp utilise Supabase Auth standard`, \"green\");\n    } else {\n      issues.push({ severity: \"error\", message: \"signUp ne utilise pas Supabase Auth standard\" });\n      logIssue(\"signUp ne utilise pas Supabase Auth standard\", \"error\");\n    }\n\n    if (actionsContent.includes(\"supabase.auth.resend\")) {\n      log(`   ✅ resendConfirmationEmail utilise Supabase Auth standard`, \"green\");\n    } else {\n      issues.push({ severity: \"warning\", message: \"resendConfirmationEmail ne utilise pas Supabase Auth standard\" });\n      logIssue(\"resendConfirmationEmail ne utilise pas Supabase Auth standard\", \"warning\");\n    }\n  } catch (error) {\n    issues.push({ severity: \"error\", message: `Erreur lecture app/auth/actions.ts: ${error}` });\n    logIssue(`Erreur lecture app/auth/actions.ts: ${error}`, \"error\");\n  }\n\n  // 7. Vérifier emails/verification-email.tsx (optionnel, peut être supprimé si non utilisé)\n  log(\"\\n7. Vérification du template d'email (optionnel)\", \"cyan\");\n  try {\n    if (existsSync(\"emails/verification-email.tsx\")) {\n      log(`   ℹ️  Template d'email personnalisé présent (optionnel)`, \"cyan\");\n    } else {\n      log(`   ✅ Pas de template personnalisé (Supabase gère les emails via SMTP)`, \"green\");\n    }\n  } catch (error) {\n    // Ignorer, ce n'est pas critique\n  }\n\n  // Résumé\n  console.log(\"\\n\" + \"=\".repeat(60));\n  log(\"📊 RÉSUMÉ\", \"cyan\");\n  console.log(\"=\".repeat(60));\n\n  const errors = issues.filter(i => i.severity === \"error\");\n  const warnings = issues.filter(i => i.severity === \"warning\");\n  const infos = issues.filter(i => i.severity === \"info\");\n\n  if (errors.length === 0 && warnings.length === 0) {\n    log(\"\\n✅ Aucun problème détecté !\", \"green\");\n    log(\"   Le parcours d'inscription semble correctement configuré.\", \"green\");\n  } else {\n    if (errors.length > 0) {\n      log(`\\n❌ ${errors.length} erreur(s) critique(s) détectée(s):`, \"red\");\n      errors.forEach(issue => log(`   - ${issue.message}`, \"red\"));\n    }\n    if (warnings.length > 0) {\n      log(`\\n⚠️  ${warnings.length} avertissement(s):`, \"yellow\");\n      warnings.forEach(issue => log(`   - ${issue.message}`, \"yellow\"));\n    }\n  }\n\n  if (infos.length > 0) {\n    log(`\\nℹ️  ${infos.length} information(s):`, \"cyan\");\n    infos.forEach(issue => log(`   - ${issue.message}`, \"cyan\"));\n  }\n\n  console.log(\"\\n\" + \"=\".repeat(60));\n  log(\"💡 Prochaines étapes:\", \"cyan\");\n  log(\"   1. Corrigez les erreurs critiques\", \"yellow\");\n  log(\"   2. Vérifiez les avertissements\", \"yellow\");\n  log(\"   3. Exécutez: npm run test:signup\", \"yellow\");\n  log(\"   4. Testez manuellement sur http://localhost:3000/register\", \"yellow\");\n  console.log(\"=\".repeat(60) + \"\\n\");\n\n  process.exit(errors.length > 0 ? 1 : 0);\n}\n\ncheckSignupIssues().catch((error) => {\n  log(`\\n❌ Erreur fatale: ${error}`, \"red\");\n  if (error instanceof Error && error.stack) {\n    console.error(error.stack);\n  }\n  process.exit(1);\n});\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-status-logic.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'differenceInDays' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@supabase/supabase-js\";\r\nimport { differenceInDays } from \"date-fns\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n    auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n    }\r\n});\r\n\r\nasync function checkStatusLogic() {\r\n    console.log(\"🔍 === STATUS LOGIC CHECK ===\\n\");\r\n\r\n    const today = new Date();\r\n    const currentDay = today.getDate();\r\n    const selectedMonth = 12;\r\n    const selectedYear = 2025;\r\n    const isCurrentMonth = selectedMonth === (today.getMonth() + 1) && selectedYear === today.getFullYear();\r\n\r\n    console.log(`Today: ${today.toISOString().split('T')[0]}`);\r\n    console.log(`Current Day: ${currentDay}`);\r\n    console.log(`Is Current Month: ${isCurrentMonth}\\n`);\r\n\r\n    // Get active leases\r\n    const { data: leases } = await supabase\r\n        .from(\"leases\")\r\n        .select(\"*\")\r\n        .eq(\"status\", \"active\");\r\n\r\n    // Get December transactions\r\n    const { data: transactions } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(\"*\")\r\n        .eq(\"period_month\", selectedMonth)\r\n        .eq(\"period_year\", selectedYear);\r\n\r\n    console.log(\"=== STATUS SELON L'UI ===\\n\");\r\n\r\n    let uiPaid = 0;\r\n    let uiPending = 0;\r\n    let uiOverdue = 0;\r\n\r\n    leases?.forEach(lease => {\r\n        const tx = transactions?.find(t => t.lease_id === lease.id);\r\n\r\n        let displayStatus: 'paid' | 'pending' | 'overdue';\r\n\r\n        if (tx) {\r\n            // Transaction exists - use its status\r\n            if (tx.status === 'paid') {\r\n                displayStatus = 'paid';\r\n            } else {\r\n                // For pending transactions, check if overdue\r\n                const billingDay = lease.billing_day || 5;\r\n                if (isCurrentMonth && currentDay > billingDay) {\r\n                    displayStatus = 'overdue';\r\n                } else {\r\n                    displayStatus = 'pending';\r\n                }\r\n            }\r\n        } else {\r\n            // No transaction - virtual row\r\n            const billingDay = lease.billing_day || 5;\r\n            if (isCurrentMonth && currentDay > billingDay) {\r\n                displayStatus = 'overdue';\r\n            } else {\r\n                displayStatus = 'pending';\r\n            }\r\n        }\r\n\r\n        console.log(`${lease.tenant_name} - ${lease.property_address || 'N/A'}`);\r\n        console.log(`  Billing Day: ${lease.billing_day || 5}`);\r\n        console.log(`  DB Status: ${tx?.status || 'NO TRANSACTION'}`);\r\n        console.log(`  UI Display Status: ${displayStatus}`);\r\n        console.log(`  Amount: ${lease.monthly_amount.toLocaleString()} FCFA\\n`);\r\n\r\n        if (displayStatus === 'paid') uiPaid++;\r\n        else if (displayStatus === 'overdue') uiOverdue++;\r\n        else uiPending++;\r\n    });\r\n\r\n    console.log(\"=== SUMMARY ===\");\r\n    console.log(`UI should show:`);\r\n    console.log(`  ✅ Payés: ${uiPaid}`);\r\n    console.log(`  ⏳ En attente: ${uiPending}`);\r\n    console.log(`  🔴 En retard: ${uiOverdue}\\n`);\r\n\r\n    // Expected from screenshot\r\n    console.log(`Screenshot shows:`);\r\n    console.log(`  ✅ Payés: 1 (vert)`);\r\n    console.log(`  ⏳ En attente: 3 (jaune)`);\r\n    console.log(`  🔴 En retard: 2 (rouge)`);\r\n}\r\n\r\ncheckStatusLogic().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-touba.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1350,1353],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1350,1353],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour vérifier les annonces de Touba et leurs coordonnées\r\n */\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport * as dotenv from \"dotenv\";\r\nimport { resolve } from \"path\";\r\n\r\n// Charger les variables d'environnement\r\ndotenv.config({ path: resolve(process.cwd(), \".env.local\") });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n  console.error(\"❌ Variables d'environnement Supabase manquantes\");\r\n  process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function checkTouba() {\r\n  console.log(\"🔍 Recherche des annonces pour Touba...\\n\");\r\n\r\n  // Rechercher toutes les annonces contenant \"Touba\" dans la ville\r\n  const { data, error } = await supabase\r\n    .from(\"properties\")\r\n    .select(\"id, title, location, validation_status, status\")\r\n    .or(\"location->>city.ilike.%Touba%,location->>address.ilike.%Touba%\");\r\n\r\n  if (error) {\r\n    console.error(\"❌ Erreur Supabase:\", error);\r\n    return;\r\n  }\r\n\r\n  if (!data || data.length === 0) {\r\n    console.log(\"ℹ️ Aucune annonce trouvée pour Touba\");\r\n    return;\r\n  }\r\n\r\n  console.log(`✅ ${data.length} annonce(s) trouvée(s) pour Touba:\\n`);\r\n\r\n  for (const property of data) {\r\n    const location = property.location as any;\r\n    const coords = location?.coords || { lat: 0, lng: 0 };\r\n    const city = location?.city || \"N/A\";\r\n    const address = location?.address || \"N/A\";\r\n\r\n    console.log(`📋 ${property.title}`);\r\n    console.log(`   ID: ${property.id}`);\r\n    console.log(`   Ville: ${city}`);\r\n    console.log(`   Adresse: ${address}`);\r\n    console.log(\r\n      `   Coordonnées: ${coords.lat}, ${coords.lng} ${\r\n        coords.lat === 0 && coords.lng === 0 ? \"❌ (0,0 - INVALIDE)\" : \"\"\r\n      }`\r\n    );\r\n    console.log(\r\n      `   Statut: ${property.validation_status} / ${property.status}`\r\n    );\r\n    console.log(\"\");\r\n  }\r\n}\r\n\r\ncheckTouba()\r\n  .then(() => {\r\n    console.log(\"✅ Vérification terminée\");\r\n    process.exit(0);\r\n  })\r\n  .catch((error) => {\r\n    console.error(\"❌ Erreur:\", error);\r\n    process.exit(1);\r\n  });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\clean-test-data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\compare-ui-vs-db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\count-properties.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":18,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@supabase/supabase-js\";\r\nimport * as dotenv from \"dotenv\";\r\nimport { resolve } from \"path\";\r\n\r\ndotenv.config({ path: resolve(process.cwd(), \".env.local\") });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nif (!supabaseUrl || !supabaseServiceKey) {\r\n  console.error(\"❌ Variables d'environnement manquantes\");\r\n  process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\nasync function main() {\r\n  const { data, count, error } = await supabase\r\n    .from(\"properties\")\r\n    .select(\"id\", { count: \"exact\" })\r\n    .eq(\"validation_status\", \"approved\")\r\n    .eq(\"status\", \"disponible\");\r\n\r\n  if (error) {\r\n    console.error(\"❌ Erreur:\", error);\r\n    return;\r\n  }\r\n\r\n  console.log(`📊 Total propriétés approuvées et disponibles: ${count}`);\r\n}\r\n\r\nmain();\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\create-missing-december-transactions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\create-test-late-payment.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":34,"column":5,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":34,"endColumn":18,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[1170,1183],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js';\r\nimport dotenv from 'dotenv';\r\n\r\ndotenv.config({ path: '.env.local' });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nif (!supabaseUrl || !supabaseServiceKey) {\r\n    console.error('❌ Erreur: Variables d\\'environnement manquantes.');\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\nasync function createTestCase() {\r\n    console.log('🧪 Création d\\'un cas de test pour les relances...');\r\n\r\n    // 1. Trouver une transaction de Décembre 2025\r\n    const { data: transactions, error } = await supabase\r\n        .from('rental_transactions')\r\n        .select('id, status, period_month, period_year, leases(tenant_name, tenant_email)')\r\n        .eq('period_month', 12)\r\n        .eq('period_year', 2025)\r\n        .limit(1);\r\n\r\n    if (error || !transactions || transactions.length === 0) {\r\n        console.error('❌ Aucune transaction trouvée pour Décembre 2025');\r\n        return;\r\n    }\r\n\r\n    const testTx = transactions[0];\r\n    console.log(`📝 Transaction trouvée: ${testTx.id}`);\r\n    // @ts-ignore\r\n    console.log(`   Locataire: ${testTx.leases?.tenant_name}`);\r\n    console.log(`   Statut actuel: ${testTx.status}`);\r\n\r\n    // 2. Modifier le statut en \"pending\" (en attente) pour simuler un impayé\r\n    const { error: updateError } = await supabase\r\n        .from('rental_transactions')\r\n        .update({\r\n            status: 'pending',\r\n            reminder_sent: false\r\n        })\r\n        .eq('id', testTx.id);\r\n\r\n    if (updateError) {\r\n        console.error('❌ Erreur lors de la mise à jour:', updateError);\r\n        return;\r\n    }\r\n\r\n    console.log('✅ Transaction modifiée avec succès !');\r\n    console.log('   Nouveau statut: pending (en attente)');\r\n    console.log('   reminder_sent: false');\r\n    console.log('\\n🚀 Vous pouvez maintenant lancer:');\r\n    console.log('   npx tsx scripts/manual-trigger-reminders.ts');\r\n}\r\n\r\ncreateTestCase();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-email-verification.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sampleProfile' is assigned a value but never used.","line":29,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour diagnostiquer la vérification d'email\r\n * Usage: npx tsx scripts/debug-email-verification.ts [token]\r\n */\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport * as dotenv from \"dotenv\";\r\n\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nif (!supabaseUrl || !serviceRoleKey) {\r\n    console.error(\"❌ Variables d'environnement manquantes\");\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, serviceRoleKey, {\r\n    auth: { autoRefreshToken: false, persistSession: false },\r\n});\r\n\r\nasync function diagnose(token?: string) {\r\n    console.log(\"🔍 Diagnostic de la vérification d'email\\n\");\r\n    console.log(\"─\".repeat(60));\r\n\r\n    // 1. Vérifier les colonnes\r\n    console.log(\"\\n1️⃣ Vérification des colonnes...\");\r\n    const { data: sampleProfile, error: colError } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, email_verification_token, email_verification_expires\")\r\n        .limit(1);\r\n\r\n    if (colError) {\r\n        console.error(\"❌ Erreur: Les colonnes n'existent pas!\");\r\n        console.error(\"   Message:\", colError.message);\r\n        console.error(\"\\n   → Exécutez la migration SQL dans Supabase Dashboard\");\r\n        return;\r\n    }\r\n    console.log(\"✅ Colonnes présentes\");\r\n\r\n    // 2. Lister les tokens existants\r\n    console.log(\"\\n2️⃣ Tokens de vérification existants:\");\r\n    const { data: profiles, error: listError } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, full_name, email_verification_token, email_verification_expires\")\r\n        .not(\"email_verification_token\", \"is\", null);\r\n\r\n    if (listError) {\r\n        console.error(\"❌ Erreur:\", listError.message);\r\n        return;\r\n    }\r\n\r\n    if (profiles && profiles.length > 0) {\r\n        for (const p of profiles) {\r\n            console.log(`\\n   📧 ${p.full_name || \"N/A\"}`);\r\n            console.log(`      ID: ${p.id}`);\r\n            console.log(`      Token: ${p.email_verification_token}`);\r\n            console.log(`      Expire: ${p.email_verification_expires}`);\r\n\r\n            const isExpired = new Date(p.email_verification_expires) < new Date();\r\n            console.log(`      Statut: ${isExpired ? \"❌ EXPIRÉ\" : \"✅ VALIDE\"}`);\r\n        }\r\n    } else {\r\n        console.log(\"   ⚠️ Aucun token en attente de vérification\");\r\n    }\r\n\r\n    // 3. Rechercher un token spécifique\r\n    if (token) {\r\n        console.log(\"\\n3️⃣ Recherche du token spécifique:\");\r\n        console.log(`   Token: ${token}`);\r\n\r\n        const { data: found, error: findError } = await supabase\r\n            .from(\"profiles\")\r\n            .select(\"id, full_name, email_verification_token, email_verification_expires\")\r\n            .eq(\"email_verification_token\", token)\r\n            .single();\r\n\r\n        if (findError) {\r\n            console.log(\"   ❌ Token non trouvé dans la base de données!\");\r\n            console.log(\"   Erreur:\", findError.message);\r\n        } else {\r\n            console.log(\"   ✅ Token trouvé!\");\r\n            console.log(`   Utilisateur: ${found.full_name} (${found.id})`);\r\n        }\r\n    }\r\n\r\n    // 4. Vérifier les utilisateurs non confirmés\r\n    console.log(\"\\n4️⃣ Utilisateurs non confirmés:\");\r\n    const { data: { users }, error: usersError } = await supabase.auth.admin.listUsers({\r\n        page: 1,\r\n        perPage: 10,\r\n    });\r\n\r\n    if (usersError) {\r\n        console.error(\"❌ Erreur:\", usersError.message);\r\n        return;\r\n    }\r\n\r\n    const unconfirmed = users?.filter(u => !u.email_confirmed_at) || [];\r\n    if (unconfirmed.length > 0) {\r\n        for (const u of unconfirmed.slice(0, 5)) {\r\n            console.log(`\\n   📧 ${u.email}`);\r\n            console.log(`      ID: ${u.id}`);\r\n            console.log(`      Créé: ${u.created_at}`);\r\n        }\r\n    } else {\r\n        console.log(\"   ✅ Tous les utilisateurs sont confirmés\");\r\n    }\r\n\r\n    console.log(\"\\n\" + \"─\".repeat(60));\r\n    console.log(\"✅ Diagnostic terminé\\n\");\r\n}\r\n\r\n// Récupérer le token depuis les arguments\r\nconst token = process.argv[2];\r\ndiagnose(token);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-kidira.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":58},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":29}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { createClient } = require('@supabase/supabase-js');\nconst dotenv = require('dotenv');\nconst path = require('path');\n\nconsole.log(\"Script JS starting...\");\n\ndotenv.config({ path: path.resolve(process.cwd(), '.env.local') });\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL,\n  process.env.SUPABASE_SERVICE_ROLE_KEY\n);\n\nasync function run() {\n  console.log(\"Searching for Kidira...\");\n  \n  const { data: properties, error } = await supabase\n    .from('properties')\n    .select('id, title, location');\n\n  if (error) {\n    console.error(\"Error:\", error);\n    return;\n  }\n\n  const kidira = properties.filter(p => {\n    const s = JSON.stringify(p.location || {}).toLowerCase();\n    return s.includes('kidira');\n  });\n\n  console.log(`Found ${kidira.length} properties mentioning Kidira.`);\n  \n  kidira.forEach(p => {\n    console.log(`- [${p.id}] ${p.title}`);\n    console.log(`  Location:`, p.location);\n    console.log(`  Coords:`, p.location?.coords);\n  });\n}\n\nrun();","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-relations.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":69,"column":17,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":69,"endColumn":30,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[2473,2486],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js';\r\nimport dotenv from 'dotenv';\r\n\r\ndotenv.config({ path: '.env.local' });\r\n\r\nconst supabase = createClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n\r\nasync function inspectData() {\r\n    console.log(\"🕵️ --- DÉBUT DE L'INSPECTION DES RELATIONS ---\\n\");\r\n\r\n    // On récupère TOUTES les transactions non payées pour voir les liens\r\n    // Structure adaptée à ton schéma réel (leases contient directement tenant_name, tenant_email)\r\n    const { data: transactions, error } = await supabase\r\n        .from('rental_transactions')\r\n        .select(`\r\n      id,\r\n      amount_due,\r\n      status,\r\n      period_start,\r\n      period_month,\r\n      period_year,\r\n      reminder_sent,\r\n      lease_id,\r\n      leases (\r\n        id,\r\n        tenant_name,\r\n        tenant_email,\r\n        tenant_phone,\r\n        monthly_amount,\r\n        billing_day,\r\n        owner_id,\r\n        property_id\r\n      )\r\n    `)\r\n        .neq('status', 'paid'); // On regarde ceux qui posent problème (non payés)\r\n\r\n    if (error) {\r\n        console.error(\"❌ Erreur SQL:\", error);\r\n        return;\r\n    }\r\n\r\n    console.log(`🔎 ${transactions.length} transactions trouvées (Non Payées). Analyse en cours...\\n`);\r\n\r\n    if (transactions.length === 0) {\r\n        console.log(\"✅ Aucune transaction impayée trouvée. Tout est à jour !\");\r\n        return;\r\n    }\r\n\r\n    transactions.forEach((tx, index) => {\r\n        console.log(`📝 DOSSIER #${index + 1}`);\r\n        console.log(`   ├─ Transaction ID : ${tx.id}`);\r\n        console.log(`   ├─ Montant        : ${tx.amount_due} FCFA`);\r\n        console.log(`   ├─ Statut         : ${tx.status}`);\r\n        console.log(`   ├─ Période        : ${tx.period_month}/${tx.period_year}`);\r\n        console.log(`   ├─ Date Début     : ${tx.period_start || 'NULL ⚠️'}`);\r\n        console.log(`   ├─ Relance envoyée: ${tx.reminder_sent ? 'OUI ✅' : 'NON ❌'}`);\r\n\r\n        // Vérification du BAIL\r\n        if (!tx.leases) {\r\n            console.log(`   ❌ ERREUR CRITIQUE: Aucun bail lié (leases est null)`);\r\n            console.log(`   └─ Cette transaction est orpheline !`);\r\n        } else if (Array.isArray(tx.leases)) {\r\n            console.log(`   ⚠️ ATTENTION: 'leases' est un TABLEAU (Taille: ${tx.leases.length})`);\r\n            console.log(`   └─ Cause probable: Mauvaise configuration de la relation FK`);\r\n            if (tx.leases.length > 0) {\r\n                // @ts-ignore\r\n                const firstLease = tx.leases[0];\r\n                console.log(`   └─ Premier bail: ${firstLease.tenant_name} (${firstLease.tenant_email})`);\r\n            }\r\n        } else {\r\n            // Cas normal : leases est un objet unique\r\n            const lease = tx.leases;\r\n            console.log(`   ├─ LIEN Bail ID   : ${lease.id}`);\r\n            console.log(`   ├─ Montant bail   : ${lease.monthly_amount} FCFA`);\r\n            console.log(`   ├─ Jour paiement  : ${lease.billing_day || 5}`);\r\n            console.log(`   ├─ Owner ID       : ${lease.owner_id || 'NULL ⚠️'}`);\r\n            console.log(`   └─ 👤 LOCATAIRE :`);\r\n            console.log(`       ├─ Nom   : ${lease.tenant_name}`);\r\n            console.log(`       ├─ Email : ${lease.tenant_email || 'Pas d\\'email ⚠️'}`);\r\n            console.log(`       └─ Tél   : ${lease.tenant_phone || 'Pas de téléphone'}`);\r\n        }\r\n        console.log(\"-----------------------------------------------------------\\n\");\r\n    });\r\n\r\n    console.log(\"\\n🎯 RÉSUMÉ DE L'ANALYSE:\");\r\n    console.log(`   Total transactions impayées : ${transactions.length}`);\r\n    const withEmail = transactions.filter(t => {\r\n        const lease = Array.isArray(t.leases) ? t.leases[0] : t.leases;\r\n        return lease?.tenant_email;\r\n    }).length;\r\n    console.log(`   Avec email valide           : ${withEmail}`);\r\n    console.log(`   Sans email (non relançables): ${transactions.length - withEmail}`);\r\n\r\n    const withPeriodStart = transactions.filter(t => t.period_start).length;\r\n    console.log(`   Avec period_start rempli    : ${withPeriodStart}`);\r\n    console.log(`   Sans period_start (bug)     : ${transactions.length - withPeriodStart}`);\r\n}\r\n\r\ninspectData();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-reminders-issue.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'serviceError' is assigned a value but never used.","line":135,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":135,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@supabase/supabase-js\";\r\nimport { differenceInDays } from \"date-fns\";\r\n\r\n// Initialize Supabase admin client\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n    auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n    }\r\n});\r\n\r\nasync function debugReminders() {\r\n    console.log(\"🔍 === DEBUG REMINDERS SYSTEM ===\\n\");\r\n\r\n    const today = new Date();\r\n    console.log(`📅 Today: ${today.toISOString()}\\n`);\r\n\r\n    const gracePeriodLimit = new Date();\r\n    gracePeriodLimit.setDate(today.getDate() - 5);\r\n    const gracePeriodLimitIso = gracePeriodLimit.toISOString();\r\n\r\n    console.log(`⏰ Grace Period Limit (today - 5 days): ${gracePeriodLimitIso}\\n`);\r\n\r\n    // 1. Check if reminder_sent column exists\r\n    console.log(\"1️⃣ Checking table structure...\");\r\n    const { data: columns, error: columnsError } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(\"*\")\r\n        .limit(1);\r\n\r\n    if (columnsError) {\r\n        console.error(\"❌ Error fetching table:\", columnsError);\r\n        return;\r\n    }\r\n\r\n    if (columns && columns.length > 0) {\r\n        const firstRow = columns[0];\r\n        const hasReminderSent = 'reminder_sent' in firstRow;\r\n        console.log(`✅ Column 'reminder_sent' exists: ${hasReminderSent}`);\r\n        if (!hasReminderSent) {\r\n            console.log(\"⚠️  WARNING: Column 'reminder_sent' is MISSING! Run migration first.\");\r\n        }\r\n        console.log(\"\");\r\n    }\r\n\r\n    // 2. Get ALL transactions (unpaid + late)\r\n    console.log(\"2️⃣ Fetching ALL unpaid transactions...\");\r\n    const { data: allUnpaid, error: allError } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(`\r\n            id,\r\n            amount_due,\r\n            status,\r\n            period_month,\r\n            period_year,\r\n            period_start,\r\n            reminder_sent,\r\n            leases (\r\n                id,\r\n                billing_day,\r\n                tenant_email,\r\n                tenant_name,\r\n                property_id,\r\n                owner_id\r\n            )\r\n        `)\r\n        .neq(\"status\", \"paid\");\r\n\r\n    if (allError) {\r\n        console.error(\"❌ Error:\", allError);\r\n        return;\r\n    }\r\n\r\n    console.log(`📊 Total unpaid transactions: ${allUnpaid?.length || 0}\\n`);\r\n\r\n    // 3. Filter manually to understand which ones should trigger reminders\r\n    console.log(\"3️⃣ Analyzing each transaction:\\n\");\r\n\r\n    let shouldSendReminder = 0;\r\n    let alreadyReminded = 0;\r\n    let notOverdueYet = 0;\r\n    let noLeaseData = 0;\r\n\r\n    if (allUnpaid) {\r\n        for (const tx of allUnpaid) {\r\n            const lease = Array.isArray(tx.leases) ? tx.leases[0] : tx.leases;\r\n\r\n            if (!lease) {\r\n                console.log(`❌ TX ${tx.id} - No lease data`);\r\n                noLeaseData++;\r\n                continue;\r\n            }\r\n\r\n            const billingDay = lease.billing_day || 5;\r\n            const dueDate = new Date(tx.period_year, tx.period_month - 1, billingDay);\r\n            const daysOverdue = differenceInDays(today, dueDate);\r\n\r\n            const reminderSentValue = tx.reminder_sent ?? false;\r\n\r\n            console.log(`📋 TX ${tx.id}:`);\r\n            console.log(`   Status: ${tx.status}`);\r\n            console.log(`   Period: ${tx.period_month}/${tx.period_year}`);\r\n            console.log(`   Due Date: ${dueDate.toISOString().split('T')[0]}`);\r\n            console.log(`   Days Overdue: ${daysOverdue}`);\r\n            console.log(`   Reminder Sent: ${reminderSentValue}`);\r\n            console.log(`   Tenant Email: ${lease.tenant_email || 'N/A'}`);\r\n\r\n            if (daysOverdue >= 5) {\r\n                if (reminderSentValue) {\r\n                    console.log(`   ⚠️  Already reminded\\n`);\r\n                    alreadyReminded++;\r\n                } else {\r\n                    console.log(`   ✅ SHOULD SEND REMINDER\\n`);\r\n                    shouldSendReminder++;\r\n                }\r\n            } else {\r\n                console.log(`   ⏳ Not overdue enough yet\\n`);\r\n                notOverdueYet++;\r\n            }\r\n        }\r\n    }\r\n\r\n    console.log(\"\\n📊 === SUMMARY ===\");\r\n    console.log(`Total unpaid: ${allUnpaid?.length || 0}`);\r\n    console.log(`Should send reminder: ${shouldSendReminder}`);\r\n    console.log(`Already reminded: ${alreadyReminded}`);\r\n    console.log(`Not overdue yet (<5 days): ${notOverdueYet}`);\r\n    console.log(`No lease data: ${noLeaseData}`);\r\n\r\n    // 4. Test the actual query used by the service\r\n    console.log(\"\\n4️⃣ Testing exact service query...\");\r\n    const { data: serviceQuery, error: serviceError } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(`\r\n            id,\r\n            amount_due,\r\n            status,\r\n            period_month,\r\n            period_year,\r\n            period_start,\r\n            reminder_sent,\r\n            leases (\r\n                id,\r\n                billing_day,\r\n                tenant_email,\r\n                tenant_name,\r\n                property_id,\r\n                owner_id\r\n            )\r\n        `)\r\n        .neq(\"status\", \"paid\")\r\n        .eq(\"reminder_sent\", false)\r\n        .lte(\"period_start\", gracePeriodLimitIso)\r\n        .gte(\"period_year\", today.getFullYear() - 1);\r\n\r\n    console.log(`Query returned: ${serviceQuery?.length || 0} transactions`);\r\n\r\n    if (serviceQuery && serviceQuery.length > 0) {\r\n        console.log(\"\\n✅ Transactions that would be processed:\");\r\n        serviceQuery.forEach(tx => {\r\n            const lease = Array.isArray(tx.leases) ? tx.leases[0] : tx.leases;\r\n            console.log(`   - TX ${tx.id}: ${tx.period_month}/${tx.period_year}, Email: ${lease?.tenant_email || 'N/A'}`);\r\n        });\r\n    } else {\r\n        console.log(\"\\n❌ NO transactions match the service query criteria!\");\r\n        console.log(\"\\nPossible reasons:\");\r\n        console.log(\"1. reminder_sent column might be NULL instead of false\");\r\n        console.log(\"2. period_start might be NULL or incorrect\");\r\n        console.log(\"3. Migration not applied yet\");\r\n    }\r\n}\r\n\r\ndebugReminders().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-yahya.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\delete-future-transactions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\diagnose-digital-safe.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tableData' is assigned a value but never used.","line":29,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'verifications' is assigned a value but never used.","line":98,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":98,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script de diagnostic pour le Digital Safe\n * Vérifie l'état de la configuration Supabase (table, bucket, policies)\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { config } from \"dotenv\";\n\n// Charger les variables d'environnement\nconfig({ path: \".env.local\" });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error(\"❌ Variables d'environnement manquantes:\");\n  console.error(\"   - NEXT_PUBLIC_SUPABASE_URL:\", !!supabaseUrl);\n  console.error(\"   - SUPABASE_SERVICE_ROLE_KEY:\", !!supabaseServiceKey);\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function main() {\n  console.log(\"🔍 Diagnostic du Digital Safe\\n\");\n\n  // 1. Vérifier si la table user_documents existe\n  console.log(\"1️⃣ Vérification de la table 'user_documents'...\");\n  const { data: tableData, error: tableError } = await supabase\n    .from(\"user_documents\")\n    .select(\"*\", { count: \"exact\", head: true });\n\n  if (tableError) {\n    console.error(\"   ❌ Table 'user_documents' n'existe pas\");\n    console.error(\"   Erreur:\", tableError.message);\n    console.log(\"\\n   👉 Solution: Exécuter la migration SQL\");\n    console.log(\"      Option 1 (Dashboard): Aller dans SQL Editor > Coller le contenu de migrations/20250101_digital_safe.sql\");\n    console.log(\"      Option 2 (CLI): cd supabase && npx supabase db push\\n\");\n  } else {\n    console.log(\"   ✅ Table 'user_documents' existe\");\n  }\n\n  // 2. Vérifier si le bucket verification-docs existe\n  console.log(\"\\n2️⃣ Vérification du bucket 'verification-docs'...\");\n  const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();\n\n  if (bucketsError) {\n    console.error(\"   ❌ Impossible de lister les buckets\");\n    console.error(\"   Erreur:\", bucketsError.message);\n  } else {\n    const verificationBucket = buckets.find((b) => b.id === \"verification-docs\");\n    if (verificationBucket) {\n      console.log(\"   ✅ Bucket 'verification-docs' existe\");\n      console.log(\"      - Public:\", verificationBucket.public ? \"Oui ⚠️\" : \"Non (Privé) ✅\");\n      console.log(\"      - Created:\", new Date(verificationBucket.created_at).toLocaleDateString());\n    } else {\n      console.error(\"   ❌ Bucket 'verification-docs' n'existe pas\");\n      console.log(\"\\n   👉 Solution: Créer le bucket dans le Dashboard Supabase\");\n      console.log(\"      Storage > New Bucket:\");\n      console.log(\"      - Name: verification-docs\");\n      console.log(\"      - Public: NON (Privé)\");\n      console.log(\"      - File size limit: 5242880 (5 MB)\");\n      console.log(\"      - Allowed MIME types: application/pdf, image/jpeg, image/png\\n\");\n    }\n  }\n\n  // 3. Tester un upload simple (si le bucket existe)\n  const verificationBucket = buckets?.find((b) => b.id === \"verification-docs\");\n  if (verificationBucket) {\n    console.log(\"\\n3️⃣ Test d'upload dans le bucket...\");\n    const testFileName = `test/diagnostic_${Date.now()}.txt`;\n    const testContent = \"Test Digital Safe\";\n\n    const { data: uploadData, error: uploadError } = await supabase.storage\n      .from(\"verification-docs\")\n      .upload(testFileName, testContent, {\n        contentType: \"text/plain\",\n      });\n\n    if (uploadError) {\n      console.error(\"   ❌ Upload échoué\");\n      console.error(\"   Erreur:\", uploadError.message);\n      console.log(\"\\n   👉 Possible causes:\");\n      console.log(\"      - Storage Policies (RLS) non configurées\");\n      console.log(\"      - Permissions insuffisantes\");\n    } else {\n      console.log(\"   ✅ Upload réussi\");\n      console.log(\"      - Path:\", uploadData.path);\n\n      // Nettoyer le fichier de test\n      await supabase.storage.from(\"verification-docs\").remove([testFileName]);\n      console.log(\"      - Fichier de test supprimé\");\n    }\n  }\n\n  // 4. Vérifier les documents de certification (ad_verifications)\n  console.log(\"\\n4️⃣ Vérification de la table 'ad_verifications'...\");\n  const { data: verifications, error: verificationsError } = await supabase\n    .from(\"ad_verifications\")\n    .select(\"*\", { count: \"exact\", head: true });\n\n  if (verificationsError) {\n    console.error(\"   ❌ Table 'ad_verifications' n'existe pas ou erreur\");\n    console.error(\"   Erreur:\", verificationsError.message);\n  } else {\n    console.log(\"   ✅ Table 'ad_verifications' existe\");\n  }\n\n  // Récapitulatif\n  console.log(\"\\n\" + \"=\".repeat(60));\n  console.log(\"📊 RÉCAPITULATIF\");\n  console.log(\"=\".repeat(60));\n\n  const allGood = !tableError && verificationBucket && !verificationsError;\n\n  if (allGood) {\n    console.log(\"✅ Tous les composants du Digital Safe sont opérationnels!\");\n    console.log(\"\\n👉 Prochaines étapes:\");\n    console.log(\"   1. Configurer les Storage Policies (RLS) si pas déjà fait\");\n    console.log(\"   2. Tester l'upload depuis l'interface web\");\n  } else {\n    console.log(\"⚠️  Configuration incomplète. Suivez les solutions ci-dessus.\");\n  }\n\n  console.log(\"\\n\");\n}\n\nmain().catch(console.error);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\diagnose-email.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\diagnose-proof-docs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\diagnose-reminders.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":36,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":36,"endColumn":22,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[894,907],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createAdminClient } from \"../lib/supabase-admin\";\r\nimport dotenv from \"dotenv\";\r\n\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n    console.log(\"🕵️ DIAGNOSING TRANSACTIONS...\");\r\n\r\n    const supabase = createAdminClient();\r\n\r\n    // Fetch last 10 transactions without strict filters\r\n    const { data: transactions, error } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(`\r\n      id,\r\n      amount_due,\r\n      status,\r\n      period_month,\r\n      period_year,\r\n      period_start,\r\n      reminder_sent,\r\n      created_at,\r\n      leases ( tenant_name )\r\n    `)\r\n        .order('created_at', { ascending: false })\r\n        .limit(10);\r\n\r\n    if (error) {\r\n        console.error(\"Error:\", error);\r\n        return;\r\n    }\r\n\r\n    console.log(`Found ${transactions?.length} recent transactions:`);\r\n\r\n    transactions?.forEach(tx => {\r\n        // @ts-ignore\r\n        const tenantName = tx.leases?.tenant_name || \"Unknown\";\r\n        console.log(`\\nID: ${tx.id} | Tenant: ${tenantName}`);\r\n        console.log(`   Status: ${tx.status}`);\r\n        console.log(`   Reminder Sent: ${tx.reminder_sent}`);\r\n        console.log(`   Period: ${tx.period_month}/${tx.period_year}`);\r\n        console.log(`   Period Start: ${tx.period_start} (Type: ${typeof tx.period_start})`);\r\n    });\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\download-font.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":31},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":29}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const https = require('https');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst urls = [\r\n    'https://github.com/googlefonts/noto-fonts/raw/main/hinted/ttf/NotoEmoji/NotoEmoji-Regular.ttf',\r\n    'https://raw.githubusercontent.com/googlefonts/noto-fonts/main/hinted/ttf/NotoEmoji/NotoEmoji-Regular.ttf',\r\n    'https://github.com/googlefonts/noto-emoji/raw/main/fonts/NotoEmoji-Regular.ttf'\r\n];\r\n\r\nconst dest = path.join(process.cwd(), 'public', 'fonts', 'NotoEmoji-Regular.ttf');\r\nconst file = fs.createWriteStream(dest);\r\n\r\nfunction download(index) {\r\n    if (index >= urls.length) {\r\n        console.error('All URLs failed.');\r\n        fs.unlink(dest, () => { });\r\n        return;\r\n    }\r\n\r\n    const url = urls[index];\r\n    console.log(`Trying ${url}...`);\r\n\r\n    https.get(url, (response) => {\r\n        if (response.statusCode === 200) {\r\n            response.pipe(file);\r\n            file.on('finish', () => {\r\n                file.close(() => {\r\n                    console.log('Download completed successfully.');\r\n                });\r\n            });\r\n        } else if (response.statusCode === 302 || response.statusCode === 301) {\r\n            const newUrl = response.headers.location;\r\n            console.log(`Redirecting to ${newUrl}...`);\r\n            https.get(newUrl, (res2) => {\r\n                if (res2.statusCode === 200) {\r\n                    res2.pipe(file);\r\n                    file.on('finish', () => {\r\n                        file.close(() => {\r\n                            console.log('Download completed successfully (redirect).');\r\n                        });\r\n                    });\r\n                } else {\r\n                    console.log(`Failed with ${res2.statusCode}, trying next...`);\r\n                    download(index + 1);\r\n                }\r\n            }).on('error', (err) => {\r\n                console.error(`Error redirect: ${err.message}, trying next...`);\r\n                download(index + 1);\r\n            });\r\n        } else {\r\n            console.log(`Failed with ${response.statusCode}, trying next...`);\r\n            download(index + 1);\r\n        }\r\n    }).on('error', (err) => {\r\n        console.error(`Error: ${err.message}, trying next...`);\r\n        download(index + 1);\r\n    });\r\n}\r\n\r\ndownload(0);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\extract-logo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fetch-pexels-images.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1704,1707],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1704,1707],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1785,1788],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1785,1788],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from \"fs\";\n\nconst API_KEY = process.env.PEXELS_API_KEY;\nif (!API_KEY) {\n  console.error(\"Missing PEXELS_API_KEY environment variable.\");\n  process.exit(1);\n}\n\nconst targets = [\n  { title: \"Superbe F4 Moderne avec Piscine - Zone Almadies\", query: \"luxury modern living room pool\" },\n  { title: \"Appartement F3 Spacieux et Accessible - Mermoz\", query: \"cozy apartment interior bright\" },\n  { title: \"Villa d'Architecte R+1 avec Rooftop - Les Mamelles\", query: \"modern white villa rooftop\" },\n  { title: \"Studio Chic & Meublé Tout Inclus - Dakar Plateau\", query: \"modern studio apartment interior\" },\n  { title: \"Terrain d'Angle 300m² - Pôle Urbain Diamniadio\", query: \"empty land plot aerial\" },\n  { title: \"Plateau de Bureaux 150m² - Façade VDN\", query: \"modern open space office\" },\n  { title: \"F3 Pieds dans l'eau - Virage\", query: \"ocean view apartment balcony\" },\n  { title: \"Immeuble R+3 à Rénover - Sicap Liberté\", query: \"apartment building facade\" },\n  { title: \"Villa de Charme 3 Chambres avec Piscine Privée - Saly\", query: \"tropical villa pool\" },\n  { title: \"F4 de Prestige - Résidence Diplomatique Point E\", query: \"luxury apartment marble\" }\n];\n\nconst headers = { Authorization: API_KEY };\n\nasync function run() {\n  const results: Record<string, string[]> = {};\n\n  for (const target of targets) {\n    const url = new URL(\"https://api.pexels.com/v1/search\");\n    url.searchParams.set(\"query\", target.query);\n    url.searchParams.set(\"per_page\", \"6\");\n    const response = await fetch(url, { headers });\n    if (!response.ok) {\n      console.error(\"Pexels request failed for:\", response.status, response.statusText);\n      continue;\n    }\n    const data = (await response.json()) as any;\n    const urls = (data?.photos ?? [])\n      .slice(0, 3)\n      .map((photo: any) => photo?.src?.large2x || photo?.src?.original)\n      .filter(Boolean);\n    results[target.title] = urls;\n    console.log(\"Fetched photos for\", target.title);\n  }\n\n  fs.mkdirSync(\"scripts/output\", { recursive: true });\n  fs.writeFileSync(\"scripts/output/pexels-images.json\", JSON.stringify(results, null, 2));\n  console.log(\"Saved scripts/output/pexels-images.json\");\n}\n\nrun().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\find-200k-transaction.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\find-property-by-ref.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-broken-images.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'type' is defined but never used.","line":39,"column":61,"nodeType":null,"messageId":"unusedVar","endLine":39,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":98,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":98,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3977,3980],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3977,3980],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'imageChecks' is assigned a value but never used.","line":175,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":175,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":203,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":203,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6521,6524],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6521,6524],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour identifier et remplacer les images cassées par des images Pexels\n * Vérifie chaque image et remplace celles qui retournent 404 ou erreur\n * \n * Usage: npm run fix-images\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport * as dotenv from \"dotenv\";\n\n// Charger les variables d'environnement\ndotenv.config({ path: \".env.local\" });\n\nconst PEXELS_API_KEY = \"3eFVqLX19mBYTUVCMxhpPH156xmJ8K5ccP5TBwH5R2h90pHMmgb638AS\";\nconst PEXELS_API_URL = \"https://api.pexels.com/v1/search\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseKey) {\n  console.error(\"❌ Variables d'environnement manquantes:\");\n  console.error(\"   NEXT_PUBLIC_SUPABASE_URL:\", supabaseUrl ? \"✓\" : \"✗\");\n  console.error(\"   SUPABASE_SERVICE_ROLE_KEY:\", supabaseKey ? \"✓\" : \"✗\");\n  console.error(\"\\n💡 Pour les scripts de maintenance, vous DEVEZ utiliser SUPABASE_SERVICE_ROLE_KEY\");\n  console.error(\"   Cette clé se trouve dans votre dashboard Supabase → Settings → API → service_role key\");\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false,\n    detectSessionInUrl: false,\n    storage: undefined,\n  },\n});\n\n// Mots-clés de recherche Pexels basés sur le type de bien\nconst getSearchQuery = (title: string, description: string, type?: string): string => {\n  const text = `${title} ${description}`.toLowerCase();\n  \n  if (text.includes(\"terrain\") || text.includes(\"land\")) {\n    return \"empty land plot construction\";\n  }\n  if (text.includes(\"villa\") || text.includes(\"maison\") || text.includes(\"house\")) {\n    return \"modern white villa exterior\";\n  }\n  if (text.includes(\"appartement\") || text.includes(\"apartment\")) {\n    return \"modern apartment interior\";\n  }\n  if (text.includes(\"studio\")) {\n    return \"studio apartment interior design\";\n  }\n  if (text.includes(\"bureau\") || text.includes(\"office\")) {\n    return \"modern office space\";\n  }\n  if (text.includes(\"piscine\") || text.includes(\"pool\")) {\n    return \"luxury house with pool\";\n  }\n  \n  return \"modern real estate property\";\n};\n\n// Vérifier si une image est accessible\nasync function checkImageExists(url: string): Promise<boolean> {\n  try {\n    // Essayer d'abord avec HEAD (plus rapide)\n    const headResponse = await fetch(url, {\n      method: \"HEAD\",\n      signal: AbortSignal.timeout(5000),\n    });\n    \n    if (headResponse.ok && headResponse.status === 200) {\n      // Vérifier aussi le Content-Type pour s'assurer que c'est bien une image\n      const contentType = headResponse.headers.get(\"content-type\");\n      if (contentType && !contentType.startsWith(\"image/\")) {\n        console.log(`   ⚠️ URL ne pointe pas vers une image: ${contentType}`);\n        return false;\n      }\n      return true;\n    }\n    \n    // Si HEAD échoue, essayer GET avec un petit chunk pour vérifier\n    const getResponse = await fetch(url, {\n      method: \"GET\",\n      signal: AbortSignal.timeout(5000),\n      headers: {\n        Range: \"bytes=0-1024\", // Récupérer seulement les premiers 1KB\n      },\n    });\n    \n    if (getResponse.ok) {\n      const contentType = getResponse.headers.get(\"content-type\");\n      return contentType ? contentType.startsWith(\"image/\") : true;\n    }\n    \n    return false;\n  } catch (error) {\n    // Si c'est une erreur de timeout ou réseau, considérer comme cassé\n    return false;\n  }\n}\n\n// Récupérer des images depuis Pexels\nasync function fetchPexelsImages(query: string, count: number = 3): Promise<string[]> {\n  try {\n    const response = await fetch(`${PEXELS_API_URL}?query=${encodeURIComponent(query)}&per_page=${count}`, {\n      headers: {\n        Authorization: PEXELS_API_KEY,\n      },\n    });\n\n    if (!response.ok) {\n      console.error(`   ⚠️ Erreur Pexels API: ${response.statusText}`);\n      return [];\n    }\n\n    const data = await response.json();\n    const images = data.photos?.map((photo: any) => {\n      const url = photo.src?.large || photo.src?.original || photo.src?.medium;\n      if (url && typeof url === \"string\") {\n        return url.startsWith(\"http\") ? url : `https:${url}`;\n      }\n      return null;\n    }).filter((url: string | null): url is string => url !== null && url.length > 0) || [];\n    \n    if (images.length > 0) {\n      console.log(`   ✅ ${images.length} images Pexels trouvées`);\n    }\n    return images;\n  } catch (error) {\n    console.error(`   ❌ Erreur lors de la récupération des images Pexels:`, error);\n    return [];\n  }\n}\n\n// Identifier et remplacer les images cassées\nasync function fixBrokenImages() {\n  console.log(\"🔍 Recherche des propriétés avec des images...\");\n\n  // Récupérer toutes les propriétés\n  const { data: properties, error } = await supabase\n    .from(\"properties\")\n    .select(\"id, title, description, images, details\");\n\n  if (error) {\n    console.error(\"❌ Erreur lors de la récupération des propriétés:\", error);\n    return;\n  }\n\n  if (!properties || properties.length === 0) {\n    console.log(\"ℹ️ Aucune propriété trouvée\");\n    return;\n  }\n\n  console.log(`📦 ${properties.length} propriétés trouvées\\n`);\n\n  let updated = 0;\n  let skipped = 0;\n  let totalBroken = 0;\n\n  for (const property of properties) {\n    const images = property.images as string[] | null;\n    \n    if (!images || !Array.isArray(images) || images.length === 0) {\n      skipped++;\n      continue;\n    }\n\n    console.log(`\\n🔄 Vérification: ${property.title}`);\n    console.log(`   ${images.length} image(s) à vérifier`);\n\n    // Vérifier chaque image\n    const brokenIndices: number[] = [];\n    const imageChecks = await Promise.all(\n      images.map(async (img, index) => {\n        if (!img || typeof img !== \"string\" || img.length === 0) {\n          brokenIndices.push(index);\n          return false;\n        }\n        const exists = await checkImageExists(img);\n        if (!exists) {\n          brokenIndices.push(index);\n          console.log(`   ❌ Image ${index + 1} cassée: ${img.substring(0, 60)}...`);\n        }\n        return exists;\n      })\n    );\n\n    if (brokenIndices.length === 0) {\n      console.log(`   ✅ Toutes les images sont valides`);\n      skipped++;\n      continue;\n    }\n\n    totalBroken += brokenIndices.length;\n    console.log(`   ⚠️ ${brokenIndices.length} image(s) cassée(s) détectée(s)`);\n\n    // Générer une requête de recherche basée sur le bien\n    const searchQuery = getSearchQuery(\n      property.title || \"\",\n      property.description || \"\",\n      (property.details as any)?.type\n    );\n\n    console.log(`   🔍 Recherche Pexels: \"${searchQuery}\"`);\n\n    // Récupérer de nouvelles images depuis Pexels\n    const newImages = await fetchPexelsImages(searchQuery, brokenIndices.length);\n\n    if (newImages.length === 0) {\n      console.log(`   ⚠️ Aucune image Pexels trouvée, conservation des images existantes`);\n      skipped++;\n      continue;\n    }\n\n    // Remplacer les images cassées par les nouvelles images Pexels\n    const updatedImages = images.map((img, index) => {\n      if (brokenIndices.includes(index)) {\n        const pexelsImage = newImages[brokenIndices.indexOf(index) % newImages.length];\n        if (pexelsImage) {\n          console.log(`   ✅ Remplacement image ${index + 1} par Pexels`);\n          return pexelsImage;\n        }\n      }\n      return img;\n    }).filter((img) => img && typeof img === \"string\" && img.length > 0);\n\n    // Mettre à jour dans Supabase\n    const { error: updateError } = await supabase\n      .from(\"properties\")\n      .update({ images: updatedImages })\n      .eq(\"id\", property.id);\n\n    if (updateError) {\n      console.error(`   ❌ Erreur lors de la mise à jour:`, updateError);\n    } else {\n      console.log(`   ✅ ${brokenIndices.length} image(s) remplacée(s)`);\n      updated++;\n    }\n\n    // Attendre un peu pour éviter de surcharger l'API Pexels\n    await new Promise((resolve) => setTimeout(resolve, 1000));\n  }\n\n  console.log(`\\n✨ Terminé!`);\n  console.log(`   📊 ${updated} propriétés mises à jour`);\n  console.log(`   📊 ${totalBroken} image(s) cassée(s) remplacée(s)`);\n  console.log(`   ⏭️  ${skipped} propriétés ignorées (pas d'images cassées)`);\n}\n\n// Exécuter le script\nfixBrokenImages()\n  .then(() => {\n    console.log(\"\\n🎉 Script terminé avec succès\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"\\n❌ Erreur fatale:\", error);\n    process.exit(1);\n  });\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-identity-certification-scope.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-touba-coords.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1312,1315],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1312,1315],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour corriger les coordonnées de l'annonce de Touba\r\n */\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport * as dotenv from \"dotenv\";\r\nimport { resolve } from \"path\";\r\nimport { smartGeocode } from \"../lib/geocoding\";\r\n\r\n// Charger les variables d'environnement\r\ndotenv.config({ path: resolve(process.cwd(), \".env.local\") });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n  console.error(\"❌ Variables d'environnement Supabase manquantes\");\r\n  process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function fixTouba() {\r\n  console.log(\"🔍 Recherche et correction de l'annonce de Touba...\\n\");\r\n\r\n  // Rechercher l'annonce de Touba\r\n  const { data, error } = await supabase\r\n    .from(\"properties\")\r\n    .select(\"id, title, location\")\r\n    .or(\"location->>city.ilike.%Touba%,location->>address.ilike.%Touba%\");\r\n\r\n  if (error) {\r\n    console.error(\"❌ Erreur Supabase:\", error);\r\n    return;\r\n  }\r\n\r\n  if (!data || data.length === 0) {\r\n    console.log(\"ℹ️ Aucune annonce trouvée pour Touba\");\r\n    return;\r\n  }\r\n\r\n  for (const property of data) {\r\n    const location = property.location as any;\r\n    const currentCoords = location?.coords || { lat: 0, lng: 0 };\r\n    const address = location?.address || \"\";\r\n    const district = location?.district || \"\";\r\n    const city = location?.city || \"\";\r\n\r\n    console.log(`📋 Traitement: ${property.title}`);\r\n    console.log(`   Adresse actuelle: ${address}`);\r\n    console.log(`   Quartier: ${district}`);\r\n    console.log(`   Ville: ${city}`);\r\n    console.log(`   Coordonnées actuelles: ${currentCoords.lat}, ${currentCoords.lng}`);\r\n\r\n    // Utiliser smartGeocode pour obtenir les bonnes coordonnées\r\n    // Si la ville est \"Kafrine\" mais l'adresse est \"Touba\", on doit corriger\r\n    const geocodeAddress = address;\r\n    const geocodeDistrict = district;\r\n    let geocodeCity = city;\r\n\r\n    // Si l'adresse est \"Touba\" mais la ville est \"Kafrine\", on corrige la ville\r\n    if (address.toLowerCase().includes(\"touba\") && city.toLowerCase().includes(\"kafrine\")) {\r\n      console.log(\"   ⚠️ Détection: Adresse = Touba mais Ville = Kafrine (incorrect)\");\r\n      console.log(\"   ✅ Correction: Utilisation de 'Touba' comme ville\");\r\n      geocodeCity = \"Touba\";\r\n    }\r\n\r\n    console.log(`\\n   🔄 Géocodage avec: address=\"${geocodeAddress}\", district=\"${geocodeDistrict}\", city=\"${geocodeCity}\"`);\r\n\r\n    const newCoords = await smartGeocode(geocodeAddress, geocodeDistrict, geocodeCity);\r\n\r\n    console.log(`   ✅ Nouvelles coordonnées: ${newCoords.lat}, ${newCoords.lng}`);\r\n\r\n    // Mettre à jour dans Supabase\r\n    const updatedLocation = {\r\n      ...location,\r\n      coords: newCoords,\r\n      // Corriger aussi la ville si nécessaire\r\n      city: geocodeCity !== city ? geocodeCity : city,\r\n    };\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"properties\")\r\n      .update({\r\n        location: updatedLocation,\r\n      })\r\n      .eq(\"id\", property.id);\r\n\r\n    if (updateError) {\r\n      console.error(`   ❌ Erreur lors de la mise à jour: ${updateError.message}`);\r\n    } else {\r\n      console.log(`   ✅ Coordonnées mises à jour avec succès !\\n`);\r\n    }\r\n  }\r\n}\r\n\r\nfixTouba()\r\n  .then(() => {\r\n    console.log(\"✅ Correction terminée\");\r\n    process.exit(0);\r\n  })\r\n  .catch((error) => {\r\n    console.error(\"❌ Erreur:\", error);\r\n    process.exit(1);\r\n  });\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-transaction-dates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\generate-pwa-icons.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":11,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":11,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":12,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":12,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":29,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":29,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":30,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":30,"endColumn":19}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour générer les icônes PWA (PNG) depuis le SVG\r\n * \r\n * Usage:\r\n *   npm run generate-icons\r\n * \r\n * Ou directement:\r\n *   node scripts/generate-pwa-icons.js\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst SVG_PATH = path.join(__dirname, '../public/icons/icon.svg');\r\nconst OUTPUT_DIR = path.join(__dirname, '../public/icons');\r\n\r\n// Fonction pour convertir SVG en PNG (méthode simple avec sharp si disponible)\r\nasync function generateIcons() {\r\n  try {\r\n    // Vérifier si le SVG existe\r\n    if (!fs.existsSync(SVG_PATH)) {\r\n      console.error('❌ Erreur: Le fichier icon.svg n\\'existe pas à:', SVG_PATH);\r\n      process.exit(1);\r\n    }\r\n\r\n    // Vérifier si sharp est disponible\r\n    let sharp;\r\n    try {\r\n      sharp = require('sharp');\r\n    } catch (error) {\r\n      console.error('❌ Erreur: Le package \"sharp\" n\\'est pas installé.');\r\n      console.error('\\n📦 Installation requise:');\r\n      console.error('   npm install sharp --save-dev');\r\n      console.error('\\n💡 Alternatives:');\r\n      console.error('   1. Utilisez un outil en ligne (CloudConvert, Convertio)');\r\n      console.error('   2. Utilisez ImageMagick: magick convert public/icons/icon.svg -resize 192x192 public/icons/icon-192.png');\r\n      console.error('\\n📖 Voir docs/GENERER-ICONES-PWA.md pour plus d\\'options');\r\n      process.exit(1);\r\n    }\r\n\r\n    // Lire le SVG\r\n    const svg = fs.readFileSync(SVG_PATH);\r\n\r\n    console.log('🎨 Génération des icônes PWA...\\n');\r\n\r\n    // Générer icon-192.png\r\n    await sharp(svg)\r\n      .resize(192, 192, {\r\n        fit: 'contain',\r\n        background: { r: 5, g: 8, b: 12, alpha: 1 }, // #05080c\r\n      })\r\n      .png()\r\n      .toFile(path.join(OUTPUT_DIR, 'icon-192.png'));\r\n\r\n    console.log('✅ icon-192.png généré (192x192 px)');\r\n\r\n    // Générer icon-512.png\r\n    await sharp(svg)\r\n      .resize(512, 512, {\r\n        fit: 'contain',\r\n        background: { r: 5, g: 8, b: 12, alpha: 1 }, // #05080c\r\n      })\r\n      .png()\r\n      .toFile(path.join(OUTPUT_DIR, 'icon-512.png'));\r\n\r\n    console.log('✅ icon-512.png généré (512x512 px)');\r\n\r\n    console.log('\\n🎉 Icônes PWA générées avec succès !');\r\n    console.log('\\n📋 Prochaines étapes:');\r\n    console.log('   1. Vérifiez que les fichiers sont dans public/icons/');\r\n    console.log('   2. Testez dans Chrome DevTools (F12 → Application → Manifest)');\r\n    console.log('   3. Testez l\\'installation PWA');\r\n\r\n  } catch (error) {\r\n    console.error('❌ Erreur lors de la génération des icônes:', error.message);\r\n    console.error('\\n💡 Voir docs/GENERER-ICONES-PWA.md pour d\\'autres méthodes');\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Exécuter\r\ngenerateIcons();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\link-audit.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\nconst path = require('path');\n\nconst targetDirs = ['app', 'components'];\nconst exts = new Set(['.ts', '.tsx']);\n\nconst listFiles = (dir) => {\n  let results = [];\n  const entries = fs.readdirSync(dir, { withFileTypes: true });\n  for (const entry of entries) {\n    if (entry.name === 'node_modules' || entry.name.startsWith('.')) continue;\n    const fullPath = path.join(dir, entry.name);\n    if (entry.isDirectory()) {\n      results = results.concat(listFiles(fullPath));\n    } else if (exts.has(path.extname(entry.name))) {\n      results.push(fullPath);\n    }\n  }\n  return results;\n};\n\nconst files = targetDirs.flatMap((dir) => (fs.existsSync(dir) ? listFiles(dir) : []));\n\nconst hrefRegex = /href\\s*=\\s*(?:\\{\\s*)?([\"'`])([^\"'`]+)\\1/gm;\nconst hrefTemplateRegex = /href\\s*=\\s*\\{\\s*`([^`]+)`\\s*\\}/gm;\nconst pushRegex = /router\\.push\\(\\s*(?:\\{\\s*)?([\"'`])([^\"'`]+)\\1/gm;\nconst pushTemplateRegex = /router\\.push\\(\\s*`([^`]+)`\\s*\\)/gm;\n\nconst references = new Map();\n\nconst addRef = (file, value, type) => {\n  if (!value.startsWith('/')) return;\n  const clean = value.split(/\\s/)[0];\n  if (!references.has(clean)) {\n    references.set(clean, []);\n  }\n  references.get(clean).push({ file: file.replace(process.cwd() + path.sep, ''), type, raw: value });\n};\n\nfiles.forEach((file) => {\n  const content = fs.readFileSync(file, 'utf8');\n  let match;\n  while ((match = hrefRegex.exec(content)) !== null) {\n    addRef(file, match[2], 'href');\n  }\n  while ((match = hrefTemplateRegex.exec(content)) !== null) {\n    addRef(file, match[1], 'href-template');\n  }\n  while ((match = pushRegex.exec(content)) !== null) {\n    addRef(file, match[2], 'router.push');\n  }\n  while ((match = pushTemplateRegex.exec(content)) !== null) {\n    addRef(file, match[1], 'router.push-template');\n  }\n});\n\nconst listPageFiles = (dir) => {\n  let results = [];\n  const entries = fs.readdirSync(dir, { withFileTypes: true });\n  for (const entry of entries) {\n    if (entry.name === 'node_modules' || entry.name.startsWith('.')) continue;\n    const fullPath = path.join(dir, entry.name);\n    if (entry.isDirectory()) {\n      results = results.concat(listPageFiles(fullPath));\n    } else if (entry.name === 'page.tsx') {\n      results.push(fullPath);\n    }\n  }\n  return results;\n};\n\nconst pageFiles = fs.existsSync('app') ? listPageFiles('app') : [];\nconst routePatterns = pageFiles.map((file) => {\n  const rel = path.relative('app', file).replace(/\\\\/g, '/');\n  const routePath = '/' + rel.replace(/\\/page\\.tsx$/, '').replace(/page\\.tsx$/, '');\n  const normalized = routePath === '/' ? '/' : routePath.replace(/\\/+/, '/');\n  const patternStr = '^' + normalized\n    .replace(/\\(.*?\\)\\//g, '')\n    .replace(/\\[\\.\\.\\.([^\\]]+)\\]/g, '(.+)')\n    .replace(/\\[([^\\]]+)\\]/g, '([^/]+)')\n    .replace(/\\//g, '\\\\/') + '$';\n  return { route: normalized === '' ? '/' : normalized, regex: new RegExp(patternStr) };\n});\n\nconst routeExists = (value) => {\n  const pathWithoutQuery = value.split('?')[0];\n  return routePatterns.some(({ regex }) => regex.test(pathWithoutQuery));\n};\n\nconst unresolved = [];\nfor (const [value, refs] of references.entries()) {\n  const hasTemplate = value.includes('${');\n  let testValue = value;\n  if (hasTemplate) {\n    testValue = value.replace(/\\$\\{[^}]+\\}/g, 'placeholder');\n  }\n  if (!routeExists(testValue)) {\n    unresolved.push({ value, refs });\n  }\n}\n\nfs.writeFileSync('link-audit.json', JSON.stringify({ totalReferences: references.size, unresolved }, null, 2));\nconsole.log('Audit saved to link-audit.json with', unresolved.length, 'unresolved references.');\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\list-all-tenants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\manual-trigger-reminders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\refactor-invoice.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'newBlock' is assigned a value but never used.","line":41,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as fs from 'fs';\r\nimport * as path from 'path';\r\n\r\nconst invoicePath = path.join(process.cwd(), 'lib', 'invoice.ts');\r\nlet content = fs.readFileSync(invoicePath, 'utf8');\r\n\r\n// 1. Add Import if not present\r\nif (!content.includes('import { logoBase64 } from \"./logo\";')) {\r\n    content = 'import { logoBase64 } from \"./logo\";\\n' + content;\r\n}\r\n\r\n// 2. Remove the massive inline definition\r\n// We look for: const logoBase64 = \"...\"\r\n// And replace it with a comment or nothing, relying on the import.\r\n// However, the import is at the top scope, but the variable was defined inside the function.\r\n// So we need to remove the 'const logoBase64 = ...' line entirely so it uses the top-level import.\r\n// OR, we can just rename the local variable if we want to be safe, but using the import is better.\r\n\r\n// Regex to match: const logoBase64 = \".*\";\r\n// Since the string is huge, we should be careful. It ends with \";\r\n// We can match `const logoBase64 = \"` until `\";`\r\nconst regex = /const logoBase64 = \"[^\"]+\";/;\r\nif (regex.test(content)) {\r\n    content = content.replace(regex, '// Used imported logoBase64');\r\n    console.log('Replaced inline logoBase64 definition.');\r\n} else {\r\n    // Fallback: maybe it was injected differently or I can't match it easily with regex due to size/chars.\r\n    // Let's try to find the start and end markers I used before.\r\n    const startMarker = '// Embed Base64 Logo directly to avoid file path issues in production/serverless';\r\n    const endMarker = 'const logoImageBytes = Buffer.from(logoBase64, \\'base64\\');';\r\n\r\n    const startIndex = content.indexOf(startMarker);\r\n    const endIndex = content.indexOf(endMarker);\r\n\r\n    if (startIndex !== -1 && endIndex !== -1) {\r\n        // We want to keep the start marker and the end marker line (which uses the var),\r\n        // but remove the definition in between.\r\n        // The definition is: const logoBase64 = \"...\";\r\n\r\n        // Let's just replace the whole block with a clean version.\r\n        const newBlock = `\r\n      // Embed Base64 Logo directly to avoid file path issues in production/serverless\r\n      // const logoBase64 is imported from ./logo\r\n      `;\r\n\r\n        // We need to be careful not to delete 'const logoImageBytes...'\r\n        // My previous injection was:\r\n        // const logoBase64 = \"${logoBase64}\";\r\n        // const logoImageBytes = Buffer.from(logoBase64, 'base64');\r\n\r\n        // So I will replace from `const logoBase64 = \"` to the line before `const logoImageBytes`\r\n\r\n        // Actually, simpler approach:\r\n        // Just replace the specific line `const logoBase64 = \"...\";` \r\n        // But regex might fail on 700KB line.\r\n\r\n        // Let's find the line starting with `const logoBase64 = \"`\r\n        const lines = content.split('\\n');\r\n        const newLines = lines.map(line => {\r\n            if (line.trim().startsWith('const logoBase64 = \"')) {\r\n                return '      // Using imported logoBase64';\r\n            }\r\n            return line;\r\n        });\r\n        content = newLines.join('\\n');\r\n        console.log('Replaced inline logoBase64 line.');\r\n    }\r\n}\r\n\r\nfs.writeFileSync(invoicePath, content);\r\nconsole.log('Updated lib/invoice.ts');\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\replace-unsplash-with-pexels.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'type' is defined but never used.","line":46,"column":61,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":65},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3124,3127],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3124,3127],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":156,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5269,5272],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5269,5272],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour remplacer les images Unsplash cassées par des images Pexels\n * Utilise l'API Pexels pour générer de nouvelles images basées sur le type de bien\n * \n * Usage: npm run replace-images\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport * as dotenv from \"dotenv\";\n\n// Charger les variables d'environnement\ndotenv.config({ path: \".env.local\" });\n\nconst PEXELS_API_KEY = \"3eFVqLX19mBYTUVCMxhpPH156xmJ8K5ccP5TBwH5R2h90pHMmgb638AS\";\nconst PEXELS_API_URL = \"https://api.pexels.com/v1/search\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n// Pour les scripts de maintenance, on DOIT utiliser la service role key pour bypasser RLS\n// L'anon key ne fonctionnera pas car elle nécessite une session d'authentification\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl) {\n  console.error(\"❌ Variable d'environnement manquante: NEXT_PUBLIC_SUPABASE_URL\");\n  process.exit(1);\n}\n\nif (!supabaseKey) {\n  console.error(\"❌ Variable d'environnement manquante: SUPABASE_SERVICE_ROLE_KEY\");\n  console.error(\"\\n💡 Pour les scripts de maintenance, vous DEVEZ utiliser SUPABASE_SERVICE_ROLE_KEY\");\n  console.error(\"   Cette clé se trouve dans votre dashboard Supabase → Settings → API → service_role key\");\n  process.exit(1);\n}\n\n// Créer le client avec la service role key pour bypasser RLS\n// Configuration pour un script de maintenance (pas d'auth nécessaire)\nconst supabase = createClient(supabaseUrl, supabaseKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false,\n    detectSessionInUrl: false,\n    storage: undefined, // Désactiver le stockage de session\n  },\n});\n\n// Mots-clés de recherche Pexels basés sur le type de bien\nconst getSearchQuery = (title: string, description: string, type?: string): string => {\n  const text = `${title} ${description}`.toLowerCase();\n  \n  if (text.includes(\"terrain\") || text.includes(\"land\")) {\n    return \"empty land plot construction\";\n  }\n  if (text.includes(\"villa\") || text.includes(\"maison\") || text.includes(\"house\")) {\n    return \"modern white villa exterior\";\n  }\n  if (text.includes(\"appartement\") || text.includes(\"apartment\")) {\n    return \"modern apartment interior\";\n  }\n  if (text.includes(\"studio\")) {\n    return \"studio apartment interior design\";\n  }\n  if (text.includes(\"bureau\") || text.includes(\"office\")) {\n    return \"modern office space\";\n  }\n  if (text.includes(\"piscine\") || text.includes(\"pool\")) {\n    return \"luxury house with pool\";\n  }\n  \n  return \"modern real estate property\";\n};\n\n// Récupérer des images depuis Pexels\nasync function fetchPexelsImages(query: string, count: number = 3): Promise<string[]> {\n  try {\n    const response = await fetch(`${PEXELS_API_URL}?query=${encodeURIComponent(query)}&per_page=${count}`, {\n      headers: {\n        Authorization: PEXELS_API_KEY,\n      },\n    });\n\n    if (!response.ok) {\n      console.error(`Erreur Pexels API: ${response.statusText}`);\n      return [];\n    }\n\n    const data = await response.json();\n    // Utiliser les URLs Pexels directement (format: https://images.pexels.com/photos/...)\n    const images = data.photos?.map((photo: any) => {\n      // Préférer 'large' pour une bonne qualité sans être trop lourd\n      // Format attendu: https://images.pexels.com/photos/ID/pexels-photo-ID.jpeg?auto=compress&cs=tinysrgb&w=1260\n      const url = photo.src?.large || photo.src?.original || photo.src?.medium;\n      if (url && typeof url === 'string') {\n        // S'assurer que l'URL est complète\n        return url.startsWith('http') ? url : `https:${url}`;\n      }\n      return null;\n    }).filter((url: string | null): url is string => url !== null && url.length > 0) || [];\n    \n    if (images.length > 0) {\n      console.log(`   ✅ ${images.length} images Pexels trouvées`);\n    }\n    return images;\n  } catch (error) {\n    console.error(`Erreur lors de la récupération des images Pexels:`, error);\n    return [];\n  }\n}\n\n// Remplacer les images Unsplash par des images Pexels\nasync function replaceUnsplashImages() {\n  console.log(\"🔍 Recherche des propriétés avec des images Unsplash...\");\n\n  // Récupérer toutes les propriétés\n  const { data: properties, error } = await supabase\n    .from(\"properties\")\n    .select(\"id, title, description, images, details\");\n\n  if (error) {\n    console.error(\"❌ Erreur lors de la récupération des propriétés:\", error);\n    return;\n  }\n\n  if (!properties || properties.length === 0) {\n    console.log(\"ℹ️ Aucune propriété trouvée\");\n    return;\n  }\n\n  console.log(`📦 ${properties.length} propriétés trouvées`);\n\n  let updated = 0;\n  let skipped = 0;\n\n  for (const property of properties) {\n    const images = property.images as string[] | null;\n    \n    if (!images || !Array.isArray(images) || images.length === 0) {\n      skipped++;\n      continue;\n    }\n\n    // Vérifier si des images Unsplash sont présentes\n    const hasUnsplash = images.some((img) => \n      typeof img === \"string\" && img.includes(\"unsplash.com\")\n    );\n\n    if (!hasUnsplash) {\n      skipped++;\n      continue;\n    }\n\n    console.log(`\\n🔄 Traitement de: ${property.title}`);\n\n    // Générer une requête de recherche basée sur le bien\n    const searchQuery = getSearchQuery(\n      property.title || \"\",\n      property.description || \"\",\n      (property.details as any)?.type\n    );\n\n    console.log(`   Recherche Pexels: \"${searchQuery}\"`);\n\n    // Récupérer de nouvelles images depuis Pexels\n    const newImages = await fetchPexelsImages(searchQuery, images.length);\n\n    if (newImages.length === 0) {\n      console.log(`   ⚠️ Aucune image Pexels trouvée, conservation des images existantes`);\n      skipped++;\n      continue;\n    }\n\n    // Remplacer les images Unsplash par les nouvelles images Pexels\n    const updatedImages = images.map((img, index) => {\n      if (typeof img === \"string\" && img.includes(\"unsplash.com\")) {\n        const pexelsImage = newImages[index % newImages.length];\n        if (pexelsImage && typeof pexelsImage === \"string\" && pexelsImage.length > 0) {\n          return pexelsImage;\n        }\n        // Si pas d'image Pexels disponible, garder l'original (sera remplacé plus tard)\n        return img;\n      }\n      return img;\n    }).filter((img) => img && typeof img === \"string\" && img.length > 0); // Filtrer les images vides\n\n    // Mettre à jour dans Supabase\n    const { error: updateError } = await supabase\n      .from(\"properties\")\n      .update({ images: updatedImages })\n      .eq(\"id\", property.id);\n\n    if (updateError) {\n      console.error(`   ❌ Erreur lors de la mise à jour:`, updateError);\n    } else {\n      console.log(`   ✅ ${updatedImages.length} images mises à jour`);\n      updated++;\n    }\n\n    // Attendre un peu pour éviter de surcharger l'API Pexels\n    await new Promise((resolve) => setTimeout(resolve, 1000));\n  }\n\n  console.log(`\\n✨ Terminé! ${updated} propriétés mises à jour, ${skipped} ignorées`);\n}\n\n// Exécuter le script\nreplaceUnsplashImages()\n  .then(() => {\n    console.log(\"\\n🎉 Script terminé avec succès\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"\\n❌ Erreur fatale:\", error);\n    process.exit(1);\n  });\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\repro-real-data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\reset-reminder-flags.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1339,1342],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1339,1342],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2254,2257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2254,2257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Script pour réinitialiser les flags reminder_sent\n// Utilise le client admin pour bypasser RLS\n\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseKey) {\n    console.error('❌ Variables d\\'environnement manquantes');\n    console.log('Ajoutez dans votre terminal:');\n    console.log('export NEXT_PUBLIC_SUPABASE_URL=\"https://xxx.supabase.co\"');\n    console.log('export SUPABASE_SERVICE_ROLE_KEY=\"eyJxxx...\"');\n    process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey, {\n    auth: {\n        autoRefreshToken: false,\n        persistSession: false\n    }\n});\n\nasync function resetReminderFlags() {\n    console.log('\\n=== RESET REMINDER FLAGS ===\\n');\n\n    // 1. Vérifier l'état actuel\n    const { data: before, error: beforeError } = await supabase\n        .from('rental_transactions')\n        .select('id, period_month, period_year, status, reminder_sent, leases(tenant_name)')\n        .eq('period_month', 12)\n        .eq('period_year', 2025)\n        .neq('status', 'paid');\n\n    if (beforeError) {\n        console.error('Erreur:', beforeError);\n        return;\n    }\n\n    console.log(`Transactions non payées trouvées: ${before.length}\\n`);\n    before.forEach((tx: any) => {\n        console.log(`- ${tx.leases?.tenant_name || 'Inconnu'}: reminder_sent = ${tx.reminder_sent}`);\n    });\n\n    // 2. Reset tous les flags reminder_sent à false\n    const { error: updateError } = await supabase\n        .from('rental_transactions')\n        .update({ reminder_sent: false })\n        .eq('period_month', 12)\n        .eq('period_year', 2025)\n        .neq('status', 'paid');\n\n    if (updateError) {\n        console.error('\\n❌ Erreur lors du reset:', updateError);\n        return;\n    }\n\n    console.log('\\n✅ Flags reminder_sent réinitialisés avec succès!');\n\n    // 3. Vérifier le résultat\n    const { data: after } = await supabase\n        .from('rental_transactions')\n        .select('id, reminder_sent, leases(tenant_name)')\n        .eq('period_month', 12)\n        .eq('period_year', 2025)\n        .neq('status', 'paid');\n\n    console.log('\\nÉtat après reset:');\n    after?.forEach((tx: any) => {\n        console.log(`- ${tx.leases?.tenant_name || 'Inconnu'}: reminder_sent = ${tx.reminder_sent}`);\n    });\n\n    console.log('\\n=== TERMINÉ ===\\n');\n}\n\nresetReminderFlags();\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\resize-desktop-screenshot.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":12,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":12,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":13,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":13,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":30,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":30,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":31,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":19}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour recadrer le screenshot desktop à 1879x817px\r\n * \r\n * Ce script utilise Sharp pour recadrer l'image à la taille correcte\r\n * qui respecte le ratio PWA de 2.3:1\r\n * \r\n * Usage:\r\n *   npm install sharp --save-dev\r\n *   node scripts/resize-desktop-screenshot.js\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst INPUT_PATH = path.join(__dirname, '../public/screenshots/desktop-home.png');\r\nconst OUTPUT_PATH = path.join(__dirname, '../public/screenshots/desktop-home.png');\r\nconst TEMP_PATH = path.join(__dirname, '../public/screenshots/desktop-home-temp.png');\r\n\r\nasync function resizeScreenshot() {\r\n  try {\r\n    // Vérifier si l'image existe\r\n    if (!fs.existsSync(INPUT_PATH)) {\r\n      console.error('❌ Erreur: Le fichier desktop-home.png n\\'existe pas à:', INPUT_PATH);\r\n      process.exit(1);\r\n    }\r\n\r\n    // Vérifier si sharp est disponible\r\n    let sharp;\r\n    try {\r\n      sharp = require('sharp');\r\n    } catch (error) {\r\n      console.error('❌ Erreur: Le package \"sharp\" n\\'est pas installé.');\r\n      console.error('\\n📦 Installation requise:');\r\n      console.error('   npm install sharp --save-dev');\r\n      console.error('\\n💡 Alternative manuelle:');\r\n      console.error('   1. Ouvrez desktop-home.png dans un éditeur d\\'images');\r\n      console.error('   2. Recadrez à 1879x817px');\r\n      console.error('   3. Sauvegardez');\r\n      process.exit(1);\r\n    }\r\n\r\n    console.log('🖼️  Recadrage du screenshot desktop...\\n');\r\n\r\n    // Recadrer l'image à 1879x817px (utiliser un fichier temporaire)\r\n    await sharp(INPUT_PATH)\r\n      .resize(1879, 817, {\r\n        fit: 'cover', // Couvre la zone (peut couper un peu)\r\n        position: 'center', // Centre l'image\r\n      })\r\n      .png()\r\n      .toFile(TEMP_PATH);\r\n\r\n    // Remplacer l'ancien fichier par le nouveau\r\n    fs.unlinkSync(INPUT_PATH);\r\n    fs.renameSync(TEMP_PATH, OUTPUT_PATH);\r\n\r\n    console.log('✅ Screenshot recadré avec succès !');\r\n    console.log('   Taille: 1879x817px');\r\n    console.log('   Ratio: 2.3:1 ✅');\r\n    console.log('\\n📋 Prochaines étapes:');\r\n    console.log('   1. Vérifiez dans Chrome DevTools → Application → Manifest');\r\n    console.log('   2. L\\'avertissement de mismatch devrait disparaître');\r\n    console.log('   3. L\\'erreur de ratio est déjà résolue');\r\n\r\n  } catch (error) {\r\n    console.error('❌ Erreur lors du recadrage:', error.message);\r\n    console.error('\\n💡 Voir docs/SOLUTION-SCREENSHOT-DESKTOP.md pour d\\'autres méthodes');\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Exécuter\r\nresizeScreenshot();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\restore-december-rentals.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\run-migration-rental-fields.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\run-migration.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'profiles' is assigned a value but never used.","line":80,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":80,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'leases' is assigned a value but never used.","line":91,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Script pour exécuter les migrations Supabase\r\n// Exécuter avec: npx tsx scripts/run-migration.ts\r\n\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport * as dotenv from 'dotenv';\r\n\r\ndotenv.config({ path: '.env.local' });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nif (!supabaseUrl || !supabaseServiceKey) {\r\n    console.error('❌ Variables SUPABASE manquantes dans .env.local');\r\n    console.log('Requis: NEXT_PUBLIC_SUPABASE_URL et SUPABASE_SERVICE_ROLE_KEY');\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n    auth: { persistSession: false }\r\n});\r\n\r\nasync function runMigration() {\r\n    console.log('🚀 Exécution des migrations...\\n');\r\n\r\n    // Migration 1: Ajout colonnes à profiles\r\n    console.log('📦 Migration: Ajout colonnes branding à profiles...');\r\n    const { error: error1 } = await supabase.rpc('exec_sql', {\r\n        sql: `\r\n            ALTER TABLE profiles \r\n            ADD COLUMN IF NOT EXISTS company_name TEXT,\r\n            ADD COLUMN IF NOT EXISTS company_address TEXT,\r\n            ADD COLUMN IF NOT EXISTS company_phone TEXT,\r\n            ADD COLUMN IF NOT EXISTS company_email TEXT,\r\n            ADD COLUMN IF NOT EXISTS company_ninea TEXT,\r\n            ADD COLUMN IF NOT EXISTS logo_url TEXT,\r\n            ADD COLUMN IF NOT EXISTS signature_url TEXT;\r\n        `\r\n    });\r\n\r\n    if (error1) {\r\n        // Try direct approach\r\n        const columns = [\r\n            { name: 'company_name', type: 'TEXT' },\r\n            { name: 'company_address', type: 'TEXT' },\r\n            { name: 'company_phone', type: 'TEXT' },\r\n            { name: 'company_email', type: 'TEXT' },\r\n            { name: 'company_ninea', type: 'TEXT' },\r\n            { name: 'logo_url', type: 'TEXT' },\r\n            { name: 'signature_url', type: 'TEXT' }\r\n        ];\r\n\r\n        for (const col of columns) {\r\n            await supabase.from('profiles').select(col.name).limit(1).catch(() => {\r\n                console.log(`   Colonne ${col.name} à ajouter manuellement`);\r\n            });\r\n        }\r\n    }\r\n    console.log('   ✅ Profiles prêt\\n');\r\n\r\n    // Migration 2: Ajout colonnes à leases\r\n    console.log('📦 Migration: Ajout colonnes à leases...');\r\n    const { error: error2 } = await supabase.rpc('exec_sql', {\r\n        sql: `\r\n            ALTER TABLE leases \r\n            ADD COLUMN IF NOT EXISTS property_address TEXT,\r\n            ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW(),\r\n            ADD COLUMN IF NOT EXISTS tenant_email TEXT,\r\n            ADD COLUMN IF NOT EXISTS billing_day INTEGER DEFAULT 5;\r\n        `\r\n    });\r\n\r\n    if (error2) {\r\n        console.log('   ⚠️ RPC non disponible, vérification directe...');\r\n    }\r\n    console.log('   ✅ Leases prêt\\n');\r\n\r\n    // Test de lecture\r\n    console.log('🔍 Vérification des tables...');\r\n\r\n    const { data: profiles, error: pErr } = await supabase\r\n        .from('profiles')\r\n        .select('id, company_name, logo_url')\r\n        .limit(1);\r\n\r\n    if (pErr) {\r\n        console.log('   ❌ Profiles:', pErr.message);\r\n    } else {\r\n        console.log('   ✅ Table profiles OK');\r\n    }\r\n\r\n    const { data: leases, error: lErr } = await supabase\r\n        .from('leases')\r\n        .select('id, property_address, tenant_email')\r\n        .limit(1);\r\n\r\n    if (lErr) {\r\n        console.log('   ❌ Leases:', lErr.message);\r\n        console.log('\\n⚠️ Exécutez manuellement ce SQL dans Supabase Dashboard:\\n');\r\n        console.log(`\r\nALTER TABLE leases \r\nADD COLUMN IF NOT EXISTS property_address TEXT,\r\nADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW(),\r\nADD COLUMN IF NOT EXISTS tenant_email TEXT,\r\nADD COLUMN IF NOT EXISTS billing_day INTEGER DEFAULT 5;\r\n        `);\r\n    } else {\r\n        console.log('   ✅ Table leases OK');\r\n    }\r\n\r\n    console.log('\\n✨ Migration terminée!');\r\n}\r\n\r\nrunMigration().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\scan-ui.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'path' is defined but never used.","line":2,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'fs';\r\nimport path from 'path';\r\nimport { glob } from 'glob'; // Assurez-vous d'avoir 'glob' (npm i glob)\r\n\r\nconst FORBIDDEN_PATTERNS = [\r\n    { regex: /#[0-9A-Fa-f]{6}/g, message: \"⚠️ Couleur Hex brute détectée. Utilisez les variables Tailwind (bg-primary, etc).\" },\r\n    { regex: /\\bvh\\b/g, message: \"⚠️ Unité 'vh' détectée. Utilisez 'dvh' pour le mobile.\" },\r\n    { regex: /bg-white(?!\\/)/g, message: \"⚠️ 'bg-white' détecté. Dousell est Dark Mode only.\" }\r\n];\r\n\r\nasync function scan() {\r\n    const files = await glob('app/**/*.tsx', { ignore: 'node_modules/**' });\r\n    let hasError = false;\r\n\r\n    files.forEach(file => {\r\n        const content = fs.readFileSync(file, 'utf-8');\r\n        FORBIDDEN_PATTERNS.forEach(pattern => {\r\n            if (pattern.regex.test(content)) {\r\n                // Exception pour le fichier de config ou globals\r\n                if (file.includes('tailwind.config') || file.includes('globals.css')) return;\r\n\r\n                // Exception pour les couleurs hex dans les SVG (attribut fill) et metadata\r\n                if (pattern.regex.source.includes('#[0-9A-Fa-f]{6}')) {\r\n                    const lines = content.split('\\n');\r\n                    let hasViolation = false;\r\n                    lines.forEach(line => {\r\n                        if (/#[0-9A-Fa-f]{6}/.test(line)) {\r\n                            // Ignorer si c'est dans un SVG fill ou dans metadata\r\n                            if (!line.includes('fill=') && !line.includes('themeColor')) {\r\n                                hasViolation = true;\r\n                            }\r\n                        }\r\n                    });\r\n                    if (!hasViolation) return;\r\n                }\r\n\r\n                console.error(`❌ [DESIGN VIOLATION] dans ${file}: ${pattern.message}`);\r\n                hasError = true;\r\n            }\r\n        });\r\n    });\r\n\r\n    if (hasError) process.exit(1);\r\n    console.log(\"✅ Design System Check: OK (Teranga Style respecté)\");\r\n}\r\n\r\nscan();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\setup-storage-policies.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabase' is assigned a value but never used.","line":20,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour créer les Storage Policies (RLS) sur le bucket verification-docs\n * À exécuter APRÈS avoir créé le bucket dans le Dashboard Supabase\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { config } from \"dotenv\";\n\n// Charger les variables d'environnement\nconfig({ path: \".env.local\" });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error(\"❌ Variables d'environnement manquantes\");\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function main() {\n  console.log(\"🔧 Configuration des Storage Policies pour verification-docs\\n\");\n\n  // Les policies doivent être créées via SQL car l'API Supabase ne permet pas\n  // de créer des policies directement\n  console.log(\"📝 Exécutez les commandes SQL suivantes dans le Dashboard Supabase:\");\n  console.log(\"   Storage > verification-docs > Policies > New Policy\\n\");\n\n  console.log(\"=\" + \"=\".repeat(79));\n  console.log(\"POLICY 1: Upload (INSERT)\");\n  console.log(\"=\" + \"=\".repeat(79));\n  console.log(`\nCREATE POLICY \"Users can upload to own folder\"\nON storage.objects\nFOR INSERT\nWITH CHECK (\n  bucket_id = 'verification-docs'\n  AND (storage.foldername(name))[1] = auth.uid()::text\n);\n  `);\n\n  console.log(\"=\" + \"=\".repeat(79));\n  console.log(\"POLICY 2: Téléchargement/Lecture (SELECT)\");\n  console.log(\"=\" + \"=\".repeat(79));\n  console.log(`\nCREATE POLICY \"Users can view own files or admins can view all\"\nON storage.objects\nFOR SELECT\nUSING (\n  bucket_id = 'verification-docs'\n  AND (\n    (storage.foldername(name))[1] = auth.uid()::text\n    OR\n    EXISTS (\n      SELECT 1\n      FROM user_roles\n      WHERE user_id = auth.uid()\n        AND role IN ('admin', 'superadmin', 'moderateur')\n    )\n  )\n);\n  `);\n\n  console.log(\"=\" + \"=\".repeat(79));\n  console.log(\"POLICY 3: Suppression (DELETE)\");\n  console.log(\"=\" + \"=\".repeat(79));\n  console.log(`\nCREATE POLICY \"Users can delete own files\"\nON storage.objects\nFOR DELETE\nUSING (\n  bucket_id = 'verification-docs'\n  AND (storage.foldername(name))[1] = auth.uid()::text\n);\n  `);\n\n  console.log(\"\\n\" + \"=\".repeat(80));\n  console.log(\"📋 INSTRUCTIONS\");\n  console.log(\"=\".repeat(80));\n  console.log(\"1. Allez dans le Dashboard Supabase\");\n  console.log(\"2. Storage > verification-docs > Policies\");\n  console.log(\"3. Cliquez sur 'New Policy'\");\n  console.log(\"4. Copiez-collez chaque policy ci-dessus (3 policies au total)\");\n  console.log(\"5. Cliquez sur 'Save' pour chaque policy\");\n  console.log(\"\\n✅ Une fois fait, testez l'upload depuis l'interface web!\");\n  console.log(\"\\n\");\n}\n\nmain().catch(console.error);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-auth-flow.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-contract-generation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-cron-monthly-rentals.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-db-connection.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":66,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":66,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":90,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":90,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { config } from \"dotenv\";\nimport { createClient } from \"@supabase/supabase-js\";\n\n// Charger les variables d'environnement\nconfig({ path: \".env.local\" });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nconsole.log(\"🔍 Test de connexion à Supabase...\\n\");\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error(\"❌ Variables d'environnement manquantes:\");\n  console.error(\"   - NEXT_PUBLIC_SUPABASE_URL:\", supabaseUrl ? \"✓\" : \"✗\");\n  console.error(\"   - SUPABASE_SERVICE_ROLE_KEY:\", supabaseServiceKey ? \"✓\" : \"✗\");\n  process.exit(1);\n}\n\nconsole.log(\"📋 Configuration:\");\nconsole.log(`   URL: ${supabaseUrl}`);\nconsole.log(`   Service Key: ${supabaseServiceKey.substring(0, 20)}...`);\nconsole.log(\"\");\n\n// Créer le client Supabase avec la clé service (accès complet)\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function testConnection() {\n  try {\n    // Test 1: Récupérer les tables du schéma public\n    console.log(\"📊 Test 1: Récupération de la liste des tables publiques...\");\n\n    const { data: tables, error: tablesError } = await supabase\n      .from(\"information_schema.tables\")\n      .select(\"table_name\")\n      .eq(\"table_schema\", \"public\")\n      .order(\"table_name\");\n\n    if (tablesError) {\n      // Si information_schema n'est pas accessible, on teste avec une table connue\n      console.log(\"⚠️  information_schema non accessible, test avec une table connue...\");\n\n      const { count, error: propertiesError } = await supabase\n        .from(\"properties\")\n        .select(\"*\", { count: \"exact\", head: true });\n\n      if (propertiesError) {\n        throw new Error(`Erreur lors du test sur 'properties': ${propertiesError.message}`);\n      }\n\n      console.log(\"✅ Connexion réussie !\");\n      console.log(`   Table 'properties' accessible (${count} entrées)`);\n\n      // Essayer d'autres tables communes\n      const commonTables = [\"users\", \"user_roles\", \"notifications\", \"reviews\", \"visit_requests\"];\n      console.log(\"\\n📋 Test des tables principales:\");\n\n      for (const tableName of commonTables) {\n        try {\n          const { count: tableCount, error } = await supabase\n            .from(tableName)\n            .select(\"*\", { count: \"exact\", head: true });\n\n          if (!error) {\n            console.log(`   ✓ ${tableName.padEnd(20)} - ${tableCount} entrées`);\n          }\n        } catch (err) {\n          console.log(`   ✗ ${tableName.padEnd(20)} - non accessible`);\n        }\n      }\n    } else {\n      console.log(\"✅ Connexion réussie !\");\n      console.log(`\\n📋 Tables publiques trouvées (${tables?.length || 0}):`);\n\n      if (tables && tables.length > 0) {\n        tables.forEach((table: { table_name: string }) => {\n          console.log(`   - ${table.table_name}`);\n        });\n\n        // Test de comptage sur chaque table\n        console.log(\"\\n📊 Nombre d'entrées par table:\");\n        for (const table of tables) {\n          try {\n            const { count, error } = await supabase\n              .from(table.table_name)\n              .select(\"*\", { count: \"exact\", head: true });\n\n            if (!error) {\n              console.log(`   ${table.table_name.padEnd(30)} - ${count} entrées`);\n            }\n          } catch (err) {\n            console.log(`   ${table.table_name.padEnd(30)} - erreur`);\n          }\n        }\n      } else {\n        console.log(\"   Aucune table trouvée dans le schéma public\");\n      }\n    }\n\n    console.log(\"\\n🎉 Base de données opérationnelle !\");\n    return true;\n\n  } catch (error) {\n    console.error(\"\\n❌ Erreur lors du test de connexion:\");\n    console.error(\"   \", error instanceof Error ? error.message : String(error));\n    return false;\n  }\n}\n\ntestConnection()\n  .then((success) => {\n    process.exit(success ? 0 : 1);\n  })\n  .catch((err) => {\n    console.error(\"💥 Erreur fatale:\", err);\n    process.exit(1);\n  });\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-email-invoice.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'fs' is defined but never used.","line":4,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'path' is defined but never used.","line":5,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { generateInvoicePdf } from \"../lib/invoice\";\r\nimport { sendEmail } from \"../lib/mail\";\r\nimport { ListingApprovedEmail } from \"../emails/listing-approved-email\";\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport dotenv from \"dotenv\";\r\n\r\n// Load env vars\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n    console.log(\"Starting test email send...\");\r\n\r\n    const userEmail = \"mb3186802@gmail.com\";\r\n\r\n    // 1. Generate Invoice\r\n    const invoiceData = {\r\n        invoiceNumber: \"TEST-INV-001\",\r\n        date: new Date(),\r\n        clientName: \"Mohamadou Barry\",\r\n        clientEmail: userEmail,\r\n        items: [\r\n            {\r\n                description: \"Boost Visibilité - Annonce : Test Property\",\r\n                amount: 1500,\r\n            },\r\n        ],\r\n        total: 1500,\r\n    };\r\n\r\n    console.log(\"Generating PDF...\");\r\n    const pdfBuffer = await generateInvoicePdf(invoiceData);\r\n\r\n    if (!pdfBuffer) {\r\n        console.error(\"Failed to generate PDF\");\r\n        return;\r\n    }\r\n    console.log(\"PDF generated, size:\", pdfBuffer.length);\r\n\r\n    // 2. Send Email\r\n    console.log(\"Sending email...\");\r\n\r\n    const result = await sendEmail({\r\n        to: userEmail,\r\n        subject: \"TEST: Votre annonce est en ligne (avec facture)\",\r\n        react: ListingApprovedEmail({\r\n            propertyTitle: \"Appartement Test Dakar\",\r\n            propertyUrl: \"https://dousell-immo.app/biens/test\",\r\n            isPaid: true,\r\n            invoiceNumber: \"TEST-INV-001\",\r\n            hasInvoice: true,\r\n            propertyType: \"Appartement\",\r\n            transactionType: \"Location\",\r\n            price: 150000,\r\n            region: \"Dakar\",\r\n            city: \"Plateau\",\r\n            address: \"123 Rue de Test\",\r\n            paymentAmount: 1500,\r\n            serviceName: \"Boost Visibilité\",\r\n        }),\r\n        attachments: [\r\n            {\r\n                filename: \"Facture-TEST-INV-001.pdf\",\r\n                content: pdfBuffer,\r\n                contentType: \"application/pdf\",\r\n            },\r\n        ],\r\n    });\r\n\r\n    if (result.error) {\r\n        console.error(\"Error sending email:\", result.error);\r\n    } else {\r\n        console.log(\"Email sent successfully!\", result.data);\r\n    }\r\n}\r\n\r\nmain().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-email.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-invoice-gen.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-invoice-repro.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":53,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1763,1766],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1763,1766],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { generateInvoicePdf } from \"../lib/invoice\";\r\nimport { sendEmail } from \"../lib/mail\";\r\nimport fs from \"fs\";\r\nimport dotenv from \"dotenv\";\r\n\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nasync function main() {\r\n    console.log(\"🚀 Starting invoice test with emojis...\");\r\n\r\n    try {\r\n        // 1. Generate Invoice PDF\r\n        console.log(\"📄 Generating PDF...\");\r\n        const invoiceData = {\r\n            invoiceNumber: \"TEST-INV-EMOJI\",\r\n            date: new Date(),\r\n            clientName: \"Test User\",\r\n            clientEmail: \"test@example.com\",\r\n            items: [\r\n                {\r\n                    description: \"Test Item with Emoji 🏠✨\",\r\n                    amount: 5000,\r\n                },\r\n            ],\r\n            total: 5000,\r\n        };\r\n\r\n        const pdfBuffer = await generateInvoicePdf(invoiceData);\r\n        console.log(`✅ PDF generated. Size: ${pdfBuffer.length} bytes`);\r\n\r\n        // Save to disk to verify\r\n        fs.writeFileSync(\"test-invoice-emoji.pdf\", pdfBuffer);\r\n        console.log(\"💾 Saved to test-invoice-emoji.pdf\");\r\n\r\n        // 2. Send Email\r\n        console.log(\"📧 Sending email...\");\r\n        const result = await sendEmail({\r\n            to: process.env.GMAIL_USER || \"barrymohamadou98@gmail.com\",\r\n            subject: \"Test Facture (Repro Script) - Avec Pièce Jointe\",\r\n            html: \"<p>Ceci est un test de génération de facture avec emojis et pièce jointe.</p>\",\r\n            attachments: [\r\n                {\r\n                    filename: \"test-invoice-emoji.pdf\",\r\n                    content: pdfBuffer,\r\n                    contentType: \"application/pdf\",\r\n                },\r\n            ],\r\n        });\r\n\r\n        console.log(\"✅ Email result:\", result);\r\n\r\n    } catch (error: any) {\r\n        console.error(\"❌ Error:\", error);\r\n        fs.writeFileSync(\"error.txt\", error.stack || String(error));\r\n    }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-lease-expirations.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[939,942],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[939,942],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script de test: Vérifier le système d'alertes de fin de bail\r\n * Usage: npx tsx scripts/test-lease-expirations.ts\r\n */\r\n\r\nimport { checkLeaseExpirations } from '@/lib/lease-expiration-service';\r\nimport dotenv from 'dotenv';\r\n\r\n// Charger les variables d'environnement\r\ndotenv.config({ path: '.env.local' });\r\n\r\nasync function testLeaseExpirations() {\r\n    console.log('🧪 Test du système d\\'alertes de fin de bail...\\n');\r\n\r\n    try {\r\n        const result = await checkLeaseExpirations();\r\n\r\n        console.log('\\n📊 Résultats:');\r\n        console.log(`   - Alertes envoyées: ${result.count}`);\r\n        console.log(`   - Message: ${result.message}`);\r\n\r\n        if (result.errors && result.errors.length > 0) {\r\n            console.log(`   - Erreurs: ${result.errors.length}`);\r\n            console.error('   Détails des erreurs:', result.errors);\r\n        }\r\n\r\n        console.log('\\n✅ Test terminé !');\r\n\r\n    } catch (error: any) {\r\n        console.error('❌ Erreur lors du test:', error.message);\r\n        console.error(error);\r\n        process.exit(1);\r\n    }\r\n}\r\n\r\ntestLeaseExpirations();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-n8n-webhook.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-new-reminders-logic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-notifications.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'readFileSync' is defined but never used.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'healthCheck' is assigned a value but never used.","line":40,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'notifications' is assigned a value but never used.","line":51,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":51,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script de diagnostic pour les notifications\r\n * \r\n * Usage: npx tsx scripts/test-notifications.ts\r\n */\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport dotenv from \"dotenv\";\r\nimport { readFileSync } from \"fs\";\r\nimport { join } from \"path\";\r\n\r\n// Charger les variables d'environnement\r\ndotenv.config({ path: join(process.cwd(), \".env.local\") });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\nconst adminEmail = process.env.ADMIN_EMAIL || \"barrymohamadou98@gmail.com\";\r\n\r\nasync function testNotifications() {\r\n  console.log(\"🔍 Diagnostic des notifications\\n\");\r\n\r\n  // 1. Vérifier les variables d'environnement\r\n  console.log(\"1️⃣ Vérification des variables d'environnement:\");\r\n  console.log(\"   - NEXT_PUBLIC_SUPABASE_URL:\", supabaseUrl ? \"✅ Défini\" : \"❌ Manquant\");\r\n  console.log(\"   - NEXT_PUBLIC_SUPABASE_ANON_KEY:\", supabaseAnonKey ? \"✅ Défini\" : \"❌ Manquant\");\r\n  console.log(\"   - SUPABASE_SERVICE_ROLE_KEY:\", supabaseServiceRoleKey ? \"✅ Défini\" : \"⚠️ Non défini (optionnel)\");\r\n  console.log(\"   - ADMIN_EMAIL:\", adminEmail);\r\n  console.log(\"   - NEXT_PUBLIC_ADMIN_ID:\", process.env.NEXT_PUBLIC_ADMIN_ID || \"⚠️ Non défini (optionnel)\");\r\n  console.log(\"\");\r\n\r\n  if (!supabaseUrl || !supabaseAnonKey) {\r\n    console.error(\"❌ Variables d'environnement manquantes. Arrêt du diagnostic.\");\r\n    process.exit(1);\r\n  }\r\n\r\n  // 2. Vérifier la connexion Supabase\r\n  console.log(\"2️⃣ Test de connexion Supabase:\");\r\n  const supabase = createClient(supabaseUrl, supabaseAnonKey);\r\n  const { data: healthCheck, error: healthError } = await supabase.from(\"properties\").select(\"id\").limit(1);\r\n  \r\n  if (healthError) {\r\n    console.error(\"   ❌ Erreur de connexion:\", healthError.message);\r\n  } else {\r\n    console.log(\"   ✅ Connexion Supabase OK\");\r\n  }\r\n  console.log(\"\");\r\n\r\n  // 3. Vérifier si la table notifications existe\r\n  console.log(\"3️⃣ Vérification de la table notifications:\");\r\n  const { data: notifications, error: notificationsError } = await supabase\r\n    .from(\"notifications\")\r\n    .select(\"id\")\r\n    .limit(1);\r\n\r\n  if (notificationsError) {\r\n    if (notificationsError.code === \"PGRST116\" || notificationsError.message?.includes(\"does not exist\")) {\r\n      console.error(\"   ❌ La table 'notifications' n'existe pas !\");\r\n      console.error(\"   📝 Action requise: Appliquez la migration SQL:\");\r\n      console.error(\"      supabase/migrations/20250128_create_notifications.sql\");\r\n    } else {\r\n      console.error(\"   ❌ Erreur:\", notificationsError.message);\r\n    }\r\n  } else {\r\n    console.log(\"   ✅ Table 'notifications' existe\");\r\n  }\r\n  console.log(\"\");\r\n\r\n  // 4. Vérifier la fonction get_admin_user_id\r\n  console.log(\"4️⃣ Vérification de la fonction get_admin_user_id:\");\r\n  const { data: adminId, error: rpcError } = await supabase.rpc(\"get_admin_user_id\", {\r\n    admin_email: adminEmail,\r\n  });\r\n\r\n  if (rpcError) {\r\n    if (rpcError.code === \"42883\" || rpcError.message?.includes(\"does not exist\")) {\r\n      console.error(\"   ❌ La fonction 'get_admin_user_id' n'existe pas !\");\r\n      console.error(\"   📝 Action requise: Appliquez la migration SQL:\");\r\n      console.error(\"      supabase/migrations/20250128_get_admin_user_id.sql\");\r\n    } else {\r\n      console.error(\"   ❌ Erreur:\", rpcError.message);\r\n    }\r\n  } else if (adminId) {\r\n    console.log(\"   ✅ Fonction existe et retourne l'ID:\", adminId);\r\n  } else {\r\n    console.warn(\"   ⚠️ Fonction existe mais aucun admin trouvé avec l'email:\", adminEmail);\r\n  }\r\n  console.log(\"\");\r\n\r\n  // 5. Chercher l'admin avec service role (si disponible)\r\n  if (supabaseServiceRoleKey) {\r\n    console.log(\"5️⃣ Recherche de l'admin avec service role:\");\r\n    try {\r\n      const serviceClient = createClient(supabaseUrl, supabaseServiceRoleKey);\r\n      const { data: adminUsers, error: userError } = await serviceClient.auth.admin.listUsers();\r\n      \r\n      if (userError) {\r\n        console.error(\"   ❌ Erreur:\", userError.message);\r\n      } else if (adminUsers) {\r\n        const admin = adminUsers.users.find(\r\n          (user) => user.email?.toLowerCase() === adminEmail.toLowerCase()\r\n        );\r\n        if (admin) {\r\n          console.log(\"   ✅ Admin trouvé:\", admin.id);\r\n          console.log(\"   💡 Vous pouvez ajouter dans .env.local:\");\r\n          console.log(`      NEXT_PUBLIC_ADMIN_ID=${admin.id}`);\r\n        } else {\r\n          console.warn(\"   ⚠️ Aucun admin trouvé avec l'email:\", adminEmail);\r\n          console.log(\"   📋 Utilisateurs disponibles:\");\r\n          adminUsers.users.slice(0, 5).forEach((user) => {\r\n            console.log(`      - ${user.email} (${user.id})`);\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"   ❌ Erreur:\", error instanceof Error ? error.message : String(error));\r\n    }\r\n    console.log(\"\");\r\n  }\r\n\r\n  // 6. Vérifier Resend\r\n  console.log(\"6️⃣ Vérification de Resend:\");\r\n  const resendKey = process.env.RESEND_API_KEY;\r\n  if (resendKey) {\r\n    console.log(\"   ✅ RESEND_API_KEY est défini\");\r\n  } else {\r\n    console.warn(\"   ⚠️ RESEND_API_KEY n'est pas défini - Les emails ne seront pas envoyés\");\r\n    console.log(\"   📝 Pour activer les emails, ajoutez dans .env.local:\");\r\n    console.log(\"      RESEND_API_KEY=votre-clé-resend\");\r\n  }\r\n  console.log(\"\");\r\n\r\n  // 7. Résumé\r\n  console.log(\"📋 Résumé:\");\r\n  console.log(\"   - Table notifications:\", notificationsError ? \"❌\" : \"✅\");\r\n  console.log(\"   - Fonction get_admin_user_id:\", rpcError ? \"❌\" : \"✅\");\r\n  console.log(\"   - Resend configuré:\", resendKey ? \"✅\" : \"⚠️\");\r\n  console.log(\"\");\r\n  console.log(\"💡 Prochaines étapes:\");\r\n  if (notificationsError) {\r\n    console.log(\"   1. Appliquez la migration: supabase/migrations/20250128_create_notifications.sql\");\r\n  }\r\n  if (rpcError) {\r\n    console.log(\"   2. Appliquez la migration: supabase/migrations/20250128_get_admin_user_id.sql\");\r\n  }\r\n  if (!resendKey) {\r\n    console.log(\"   3. Configurez RESEND_API_KEY pour activer les emails\");\r\n  }\r\n  if (supabaseServiceRoleKey && !process.env.NEXT_PUBLIC_ADMIN_ID) {\r\n    console.log(\"   4. (Optionnel) Ajoutez NEXT_PUBLIC_ADMIN_ID pour améliorer les performances\");\r\n  }\r\n}\r\n\r\ntestNotifications().catch(console.error);\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-otp-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-signup-flow.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'healthCheck' is assigned a value but never used.","line":135,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":135,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script de test du parcours d'inscription complet\n * Usage: npx tsx scripts/test-signup-flow.ts\n * \n * Ce script teste :\n * 1. Validation des champs\n * 2. Vérification HIBP\n * 3. Vérification Turnstile (simulée)\n * 4. Création du compte Supabase\n * 5. Envoi de l'email de vérification Gmail\n */\n\nimport { config } from \"dotenv\";\nimport { resolve } from \"path\";\n\n// Charger les variables d'environnement\nconst envResult = config({ path: resolve(process.cwd(), \".env.local\") });\n\nif (envResult.error) {\n  console.warn(\"⚠️  Impossible de charger .env.local:\", envResult.error.message);\n}\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { checkPasswordHIBPServer } from \"../app/actions/check-hibp\";\n\n// Couleurs pour la console\nconst colors = {\n  reset: \"\\x1b[0m\",\n  green: \"\\x1b[32m\",\n  red: \"\\x1b[31m\",\n  yellow: \"\\x1b[33m\",\n  blue: \"\\x1b[34m\",\n  cyan: \"\\x1b[36m\",\n};\n\nfunction log(message: string, color: keyof typeof colors = \"reset\") {\n  console.log(`${colors[color]}${message}${colors.reset}`);\n}\n\nfunction logSection(title: string) {\n  console.log(\"\\n\" + \"=\".repeat(60));\n  log(title, \"cyan\");\n  console.log(\"=\".repeat(60));\n}\n\nfunction logTest(name: string, passed: boolean, details?: string) {\n  const icon = passed ? \"✅\" : \"❌\";\n  const color = passed ? \"green\" : \"red\";\n  log(`${icon} ${name}`, color);\n  if (details) {\n    console.log(`   ${details}`);\n  }\n}\n\nasync function testSignupFlow() {\n  logSection(\"🧪 TEST DU PARCOURS D'INSCRIPTION COMPLET\");\n\n  // Configuration\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  const gmailUser = process.env.GMAIL_USER;\n  const gmailPassword = process.env.GMAIL_APP_PASSWORD;\n\n  // Test 1: Vérification des variables d'environnement\n  logSection(\"1. Vérification de la configuration\");\n\n  const envChecks = [\n    { name: \"NEXT_PUBLIC_SUPABASE_URL\", value: supabaseUrl, required: true },\n    { name: \"NEXT_PUBLIC_SUPABASE_ANON_KEY\", value: supabaseAnonKey, required: true },\n    { name: \"SUPABASE_SERVICE_ROLE_KEY\", value: supabaseServiceKey, required: false },\n    { name: \"GMAIL_USER\", value: gmailUser, required: true },\n    { name: \"GMAIL_APP_PASSWORD\", value: gmailPassword ? \"***\" : undefined, required: true },\n  ];\n\n  let envValid = true;\n  for (const check of envChecks) {\n    const passed = check.value !== undefined;\n    if (check.required && !passed) {\n      envValid = false;\n    }\n    logTest(\n      check.name,\n      passed || !check.required,\n      check.required && !passed ? \"⚠️  REQUIS\" : check.value ? \"✅ Défini\" : \"⚠️  Optionnel\"\n    );\n  }\n\n  if (!envValid) {\n    log(\"\\n❌ Configuration incomplète. Corrigez les variables manquantes.\", \"red\");\n    process.exit(1);\n  }\n\n  // Test 2: Validation des champs\n  logSection(\"2. Validation des champs du formulaire\");\n\n  const testData = {\n    email: `test-${Date.now()}@example.com`,\n    password: \"TestPassword123!\",\n    fullName: \"Test User\",\n    phone: \"+221771234567\",\n  };\n\n  logTest(\"Email valide\", /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(testData.email));\n  logTest(\"Mot de passe (min 6 caractères)\", testData.password.length >= 6);\n  logTest(\"Nom complet (min 2 caractères)\", testData.fullName.trim().length >= 2);\n  logTest(\"Téléphone (format international)\", /^\\+?\\d{8,15}$/.test(testData.phone.replace(/\\D/g, \"\")));\n\n  // Test 3: Vérification HIBP\n  logSection(\"3. Vérification HIBP (Have I Been Pwned)\");\n\n  try {\n    const hibpResult = await checkPasswordHIBPServer(\"password123\");\n    logTest(\n      \"HIBP - Mot de passe compromis détecté\",\n      hibpResult.success && hibpResult.breached === true,\n      hibpResult.breached ? \"✅ Détection fonctionne\" : \"⚠️  Non compromis (normal pour ce test)\"\n    );\n\n    const hibpResult2 = await checkPasswordHIBPServer(testData.password);\n    logTest(\n      \"HIBP - Mot de passe sécurisé\",\n      hibpResult2.success && hibpResult2.breached === false,\n      hibpResult2.breached ? \"⚠️  Compromis\" : \"✅ Sécurisé\"\n    );\n  } catch (error) {\n    logTest(\"HIBP - Service disponible\", false, `Erreur: ${error instanceof Error ? error.message : \"Unknown\"}`);\n  }\n\n  // Test 4: Connexion Supabase\n  logSection(\"4. Connexion à Supabase\");\n\n  try {\n    const supabase = createClient(supabaseUrl!, supabaseAnonKey!);\n    const { data: healthCheck, error: healthError } = await supabase.from(\"properties\").select(\"id\").limit(1);\n\n    logTest(\n      \"Connexion Supabase\",\n      !healthError,\n      healthError ? `Erreur: ${healthError.message}` : \"✅ Connecté\"\n    );\n  } catch (error) {\n    logTest(\"Connexion Supabase\", false, `Erreur: ${error instanceof Error ? error.message : \"Unknown\"}`);\n  }\n\n  // Test 5: Test d'inscription (simulation)\n  logSection(\"5. Simulation d'inscription\");\n\n  try {\n    const supabase = createClient(supabaseUrl!, supabaseAnonKey!);\n    const appUrl = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\";\n    const emailRedirectTo = `${appUrl}/auth/callback?next=/`;\n\n    log(`📧 Tentative d'inscription avec: ${testData.email}`);\n\n    const { data, error } = await supabase.auth.signUp({\n      email: testData.email,\n      password: testData.password,\n      options: {\n        data: {\n          full_name: testData.fullName,\n          phone: testData.phone,\n        },\n        emailRedirectTo,\n      },\n    });\n\n    if (error) {\n      logTest(\"Inscription Supabase\", false, `Erreur: ${error.message}`);\n      \n      if (error.message.includes(\"already registered\")) {\n        log(\"   ℹ️  L'email existe déjà (normal si le test a déjà été exécuté)\", \"yellow\");\n      }\n    } else {\n      logTest(\"Inscription Supabase\", true, `User ID: ${data.user?.id || \"N/A\"}`);\n      logTest(\"Session créée\", !!data.session, data.session ? \"Auto-confirm activé\" : \"Email confirmation requis\");\n\n      // Test 6: Envoi email de vérification\n      if (data.user && !data.session) {\n        logSection(\"6. Email de vérification\");\n        log(\"✅ Supabase enverra automatiquement l'email via SMTP configuré\", \"green\");\n        log(`📧 Email sera envoyé à: ${testData.email}`, \"cyan\");\n        log(\"   Vérifiez votre boîte de réception pour confirmer.\", \"yellow\");\n      } else {\n        log(\"⚠️  Email de vérification non nécessaire (auto-confirm activé)\", \"yellow\");\n      }\n\n      // Nettoyage : Supprimer le compte de test si créé\n      if (data.user && supabaseServiceKey) {\n        logSection(\"7. Nettoyage (suppression du compte de test)\");\n\n        try {\n          const adminClient = createClient(supabaseUrl!, supabaseServiceKey, {\n            auth: {\n              autoRefreshToken: false,\n              persistSession: false,\n            },\n          });\n\n          const { error: deleteError } = await adminClient.auth.admin.deleteUser(data.user.id);\n\n          logTest(\n            \"Suppression du compte de test\",\n            !deleteError,\n            deleteError ? `Erreur: ${deleteError.message}` : \"✅ Compte supprimé\"\n          );\n        } catch {\n          log(\"⚠️  Impossible de supprimer le compte de test\", \"yellow\");\n        }\n      }\n    }\n  } catch (error) {\n    logTest(\"Inscription Supabase\", false, `Erreur: ${error instanceof Error ? error.message : \"Unknown\"}`);\n  }\n\n  // Résumé\n  logSection(\"📊 RÉSUMÉ\");\n  log(\"✅ Tous les tests de configuration ont été exécutés.\", \"green\");\n  log(\"📧 Vérifiez votre boîte email si un compte de test a été créé.\", \"cyan\");\n}\n\n// Exécuter les tests\ntestSignupFlow().catch(console.error);","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-supabase-connection.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":6,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":6,"endColumn":18},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":8,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":8,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'authData' is assigned a value but never used.","line":56,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":56,"endColumn":27}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script de test pour vérifier la connexion à Supabase\r\n * Usage: node scripts/test-supabase-connection.js\r\n */\r\n\r\nrequire(\"dotenv\").config({ path: \".env.local\" });\r\n\r\nconst { createClient } = require(\"@supabase/supabase-js\");\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\nconsole.log(\"🔍 Vérification de la connexion Supabase...\\n\");\r\n\r\n// Vérifier les variables d'environnement\r\nif (!supabaseUrl) {\r\n  console.error(\"❌ ERREUR: NEXT_PUBLIC_SUPABASE_URL n'est pas défini dans .env.local\");\r\n  process.exit(1);\r\n}\r\n\r\nif (!supabaseAnonKey) {\r\n  console.error(\"❌ ERREUR: NEXT_PUBLIC_SUPABASE_ANON_KEY n'est pas défini dans .env.local\");\r\n  process.exit(1);\r\n}\r\n\r\nconsole.log(\"✅ Variables d'environnement trouvées:\");\r\nconsole.log(`   URL: ${supabaseUrl}`);\r\nconsole.log(`   Key: ${supabaseAnonKey.substring(0, 20)}...\\n`);\r\n\r\n// Créer le client Supabase\r\nconst supabase = createClient(supabaseUrl, supabaseAnonKey);\r\n\r\n// Tester la connexion\r\nasync function testConnection() {\r\n  try {\r\n    console.log(\"🔄 Test de connexion à Supabase...\\n\");\r\n\r\n    // Test 1: Vérifier que la table properties existe\r\n    console.log(\"1️⃣ Test: Vérification de la table 'properties'...\");\r\n    const { data: properties, error: propertiesError } = await supabase\r\n      .from(\"properties\")\r\n      .select(\"id\")\r\n      .limit(1);\r\n\r\n    if (propertiesError) {\r\n      console.error(`   ❌ Erreur: ${propertiesError.message}`);\r\n      console.error(`   Code: ${propertiesError.code}`);\r\n      console.error(`   Détails: ${JSON.stringify(propertiesError, null, 2)}`);\r\n      return false;\r\n    }\r\n\r\n    console.log(`   ✅ Table 'properties' accessible (${properties?.length || 0} résultat(s))\\n`);\r\n\r\n    // Test 2: Vérifier l'authentification\r\n    console.log(\"2️⃣ Test: Vérification de l'authentification...\");\r\n    const { data: authData, error: authError } = await supabase.auth.getSession();\r\n\r\n    if (authError) {\r\n      console.log(`   ⚠️  Aucune session active (normal si non connecté)`);\r\n    } else {\r\n      console.log(`   ✅ Service d'authentification opérationnel`);\r\n    }\r\n    console.log();\r\n\r\n    // Test 3: Vérifier le storage\r\n    console.log(\"3️⃣ Test: Vérification du storage 'properties'...\");\r\n    const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();\r\n\r\n    if (bucketsError) {\r\n      console.error(`   ❌ Erreur: ${bucketsError.message}`);\r\n    } else {\r\n      const propertiesBucket = buckets?.find((b) => b.name === \"properties\");\r\n      if (propertiesBucket) {\r\n        console.log(`   ✅ Bucket 'properties' trouvé`);\r\n      } else {\r\n        console.log(`   ⚠️  Bucket 'properties' non trouvé (peut être créé plus tard)`);\r\n      }\r\n    }\r\n    console.log();\r\n\r\n    console.log(\"✅ Tous les tests sont passés ! La connexion Supabase fonctionne.\\n\");\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"❌ Erreur lors du test:\", error.message);\r\n    console.error(error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Exécuter les tests\r\ntestConnection()\r\n  .then((success) => {\r\n    if (success) {\r\n      console.log(\"🎉 Connexion Supabase validée !\");\r\n      process.exit(0);\r\n    } else {\r\n      console.log(\"❌ Des erreurs ont été détectées. Vérifiez votre configuration.\");\r\n      process.exit(1);\r\n    }\r\n  })\r\n  .catch((error) => {\r\n    console.error(\"❌ Erreur fatale:\", error);\r\n    process.exit(1);\r\n  });\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-verification-docs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\update-coordinates.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":88,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":88,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour mettre à jour les coordonnées GPS des annonces existantes\n * Usage: npx tsx scripts/update-coordinates.ts\n * \n * Utilise smartGeocode pour garantir qu'on trouve toujours des coordonnées\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport * as dotenv from \"dotenv\";\nimport { resolve } from \"path\";\n\n// Charger les variables d'environnement\ndotenv.config({ path: resolve(process.cwd(), \".env.local\") });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error(\"❌ Les variables d'environnement Supabase sont manquantes.\");\n  process.exit(1);\n}\n\n// Créer un client Supabase avec les droits admin (service role)\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\n// Importer smartGeocode (on doit utiliser une version compatible avec le script)\n// Pour éviter les problèmes d'import ESM/CJS, on va recréer la logique ici\nimport { findInDictionary, DEFAULT_COORDINATES } from \"../constants/coordinates\";\n\n// Version améliorée du géocodage avec retry automatique\nasync function getCoordinates(query: string, retries: number = 2): Promise<{ lat: number; lng: number } | null> {\n  if (!query || !query.trim()) return null;\n\n  const cleanQuery = query.trim().replace(/\\s+/g, \" \").replace(/,\\s*$/, \"\").replace(/,\\s*Sénégal\\s*$/i, \", Sénégal\");\n  \n  if (cleanQuery.length < 3 || cleanQuery.toLowerCase() === \"sénégal\") return null;\n\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    try {\n      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(\n        cleanQuery\n      )}&countrycodes=sn&limit=1&addressdetails=1`;\n\n      const headers = {\n        \"User-Agent\": \"Doussel-Immo-Script/1.0\",\n        \"Accept-Language\": \"fr\",\n      };\n\n      const response = await fetch(url, { headers });\n\n      if (response.status === 429) {\n        const waitTime = (attempt + 1) * 2000;\n        console.warn(`   ⚠️ Rate limit, attente ${waitTime}ms...`);\n        await new Promise((resolve) => setTimeout(resolve, waitTime));\n        continue;\n      }\n\n      if (!response.ok) {\n        if (attempt < retries) {\n          await new Promise((resolve) => setTimeout(resolve, 1000 * (attempt + 1)));\n          continue;\n        }\n        return null;\n      }\n\n      const data = await response.json();\n      if (data && data.length > 0) {\n        const lat = parseFloat(data[0].lat);\n        const lng = parseFloat(data[0].lon);\n        if (!isNaN(lat) && !isNaN(lng) && lat >= 12.0 && lat <= 16.7 && lng >= -17.5 && lng <= -11.3) {\n          return { lat, lng };\n        }\n      }\n\n      // Si aucun résultat et qu'on a encore des tentatives, simplifier la requête\n      if (attempt < retries && cleanQuery.includes(\",\")) {\n        const parts = cleanQuery.split(\",\");\n        if (parts.length > 1) {\n          const simplified = parts.slice(-2).join(\",\").trim();\n          if (simplified !== cleanQuery) {\n            console.log(`   🔄 Réessai avec: ${simplified}`);\n            return getCoordinates(simplified, retries - attempt - 1);\n          }\n        }\n      }\n\n      return null;\n    } catch (error) {\n      if (attempt < retries) {\n        await new Promise((resolve) => setTimeout(resolve, 1000 * (attempt + 1)));\n        continue;\n      }\n      return null;\n    }\n  }\n  return null;\n}\n\n/**\n * Géocodage intelligent par \"Triangulation\" - GARANTIT toujours un résultat\n * Version locale pour le script (utilise findInDictionary importé)\n */\nasync function smartGeocodeLocal(\n  address?: string,\n  district?: string,\n  city?: string\n): Promise<{ lat: number; lng: number }> {\n  const cleanAddress = address?.trim() || \"\";\n  const cleanDistrict = district?.trim() || \"\";\n  const cleanCity = city?.trim() || \"\";\n\n  // Niveau 1 : Adresse complète\n  if (cleanAddress && cleanDistrict && cleanCity) {\n    const cleanAddr = cleanAddress.split(',')[0].split(' - ')[0].substring(0, 50);\n    const fullQuery = `${cleanAddr}, ${cleanDistrict}, ${cleanCity}, Sénégal`;\n    const result = await getCoordinates(fullQuery, 1);\n    if (result) {\n      console.log(`   ✅ Niveau 1 (adresse complète)`);\n      return result;\n    }\n  }\n\n  // Niveau 2 : Quartier + Ville\n  if (cleanDistrict && cleanCity) {\n    const districtQuery = `${cleanDistrict}, ${cleanCity}, Sénégal`;\n    const result = await getCoordinates(districtQuery, 1);\n    if (result) {\n      console.log(`   ✅ Niveau 2 (quartier + ville)`);\n      return result;\n    }\n  }\n\n  // Niveau 3 : Ville seule\n  if (cleanCity) {\n    const cityQuery = `${cleanCity}, Sénégal`;\n    const result = await getCoordinates(cityQuery, 1);\n    if (result) {\n      console.log(`   ✅ Niveau 3 (ville)`);\n      return result;\n    }\n  }\n\n  // Niveau 4 : Dictionnaire local (avec correspondance approximative)\n  if (cleanCity) {\n    const dictResult = findInDictionary(cleanCity);\n    if (dictResult) {\n      console.log(`   ✅ Niveau 4 (dictionnaire - ville: ${cleanCity})`);\n      return dictResult;\n    }\n  }\n\n  if (cleanDistrict) {\n    const dictResult = findInDictionary(cleanDistrict);\n    if (dictResult) {\n      console.log(`   ✅ Niveau 4 (dictionnaire - quartier: ${cleanDistrict})`);\n      return dictResult;\n    }\n  }\n\n  // Niveau 5 : Fallback absolu - Dakar\n  console.warn(`   ⚠️  Fallback absolu (Dakar) pour: ${cleanAddress}, ${cleanDistrict}, ${cleanCity}`);\n  return DEFAULT_COORDINATES;\n}\n\nasync function main() {\n  console.log(\"🚀 Démarrage de la mise à jour des coordonnées (smartGeocode - garantit toujours un résultat)...\");\n\n  // 1. Récupérer toutes les propriétés\n  const { data: properties, error } = await supabase\n    .from(\"properties\")\n    .select(\"id, title, location\");\n\n  if (error) {\n    console.error(\"❌ Erreur lors de la récupération des propriétés:\", error);\n    return;\n  }\n\n  console.log(`📦 ${properties.length} propriétés trouvées.`);\n\n  let updatedCount = 0;\n  let skippedCount = 0;\n  let failedCount = 0;\n\n  // 2. Itérer sur chaque propriété\n  for (const property of properties) {\n    const location = property.location;\n    \n    // Vérifier si les coordonnées sont valides (non nulles)\n    const currentLat = location?.coords?.lat || 0;\n    const currentLng = location?.coords?.lng || 0;\n    \n    // On ne saute que si on a déjà des coordonnées valides ET qu'on ne force pas le refresh\n    // Ici on re-scan tout pour être sûr\n    // const hasValidCoords = currentLat !== 0 && currentLng !== 0;\n    // if (hasValidCoords) { ... }\n\n    console.log(`\\n📍 Traitement de : ${property.title} (${property.id})`);\n    console.log(`   Actuel : ${currentLat}, ${currentLng}`);\n    \n    const city = location?.city || \"\";\n    const district = location?.district || \"\";\n    const address = location?.address || \"\";\n\n    // Utiliser smartGeocode (version locale dans le script)\n    // Cette fonction garantit TOUJOURS un résultat\n    const coords = await smartGeocodeLocal(address, district, city);\n    \n    // smartGeocode garantit TOUJOURS un résultat, donc coords n'est jamais null\n    const isDifferent = Math.abs(coords.lat - currentLat) > 0.0001 || Math.abs(coords.lng - currentLng) > 0.0001;\n    \n    // Si on était à 0,0 c'est forcément différent et on veut update\n    if (isDifferent) {\n      const updatedLocation = {\n        ...location,\n        coords: {\n          lat: coords.lat,\n          lng: coords.lng\n        }\n      };\n\n      const { error: updateError } = await supabase\n        .from(\"properties\")\n        .update({ location: updatedLocation })\n        .eq(\"id\", property.id);\n\n      if (updateError) {\n        console.error(`   ❌ Erreur update : ${updateError.message}`);\n        failedCount++;\n      } else {\n        console.log(`   ✅ Mis à jour : ${coords.lat}, ${coords.lng}`);\n        updatedCount++;\n      }\n    } else {\n      console.log(\"   ⏭️  Identique, pas de mise à jour.\");\n      skippedCount++;\n    }\n\n    // Pause pour respecter le rate limiting de Nominatim (1 req/s recommandé)\n    await new Promise((resolve) => setTimeout(resolve, 1100));\n  }\n\n  console.log(\"\\n\\n🎉 Terminé !\");\n  console.log(`- Mis à jour : ${updatedCount}`);\n  console.log(`- Ignorés (déjà valides) : ${skippedCount}`);\n  console.log(`- Échecs : ${failedCount}`);\n}\n\nmain();","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-current-state.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sqError' is assigned a value but never used.","line":96,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":96,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@supabase/supabase-js\";\r\nimport { differenceInDays } from \"date-fns\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n    auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n    }\r\n});\r\n\r\nasync function verifyState() {\r\n    console.log(\"🔍 === CURRENT STATE VERIFICATION ===\\n\");\r\n\r\n    const today = new Date();\r\n    console.log(`📅 Today: ${today.toISOString().split('T')[0]}`);\r\n    console.log(`📅 Today full: ${today.toISOString()}\\n`);\r\n\r\n    // Get all unpaid transactions for December 2025\r\n    const { data: decTransactions, error } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(`\r\n            id,\r\n            amount_due,\r\n            status,\r\n            period_month,\r\n            period_year,\r\n            period_start,\r\n            reminder_sent,\r\n            leases (\r\n                id,\r\n                billing_day,\r\n                tenant_email,\r\n                tenant_name,\r\n                property_address\r\n            )\r\n        `)\r\n        .eq(\"period_month\", 12)\r\n        .eq(\"period_year\", 2025)\r\n        .neq(\"status\", \"paid\");\r\n\r\n    if (error) {\r\n        console.error(\"❌ Error:\", error);\r\n        return;\r\n    }\r\n\r\n    console.log(`📊 Unpaid December 2025 transactions: ${decTransactions?.length || 0}\\n`);\r\n\r\n    if (decTransactions && decTransactions.length > 0) {\r\n        for (const tx of decTransactions) {\r\n            const lease = Array.isArray(tx.leases) ? tx.leases[0] : tx.leases;\r\n\r\n            if (!lease) {\r\n                console.log(`❌ TX ${tx.id} - No lease data\\n`);\r\n                continue;\r\n            }\r\n\r\n            const billingDay = lease.billing_day || 5;\r\n            const dueDate = new Date(tx.period_year, tx.period_month - 1, billingDay);\r\n            const daysOverdue = differenceInDays(today, dueDate);\r\n\r\n            console.log(`📋 Transaction ${tx.id}`);\r\n            console.log(`   Montant: ${tx.amount_due?.toLocaleString()} FCFA`);\r\n            console.log(`   Locataire: ${lease.tenant_name}`);\r\n            console.log(`   Bien: ${lease.property_address}`);\r\n            console.log(`   Email: ${lease.tenant_email || 'N/A'}`);\r\n            console.log(`   Billing Day: ${billingDay}`);\r\n            console.log(`   Due Date: ${dueDate.toISOString().split('T')[0]}`);\r\n            console.log(`   Period Start (DB): ${tx.period_start || 'NULL'}`);\r\n            console.log(`   Days Overdue: ${daysOverdue}`);\r\n            console.log(`   Reminder Sent: ${tx.reminder_sent}`);\r\n            console.log(`   Status: ${tx.status}`);\r\n\r\n            if (daysOverdue >= 5) {\r\n                console.log(`   ✅ SHOULD BE REMINDED (${daysOverdue} days >= 5)`);\r\n            } else if (daysOverdue >= 1) {\r\n                console.log(`   ⚠️  OVERDUE but < 5 days (showing red in UI)`);\r\n            } else {\r\n                console.log(`   ⏳ Not overdue yet`);\r\n            }\r\n            console.log(\"\");\r\n        }\r\n    }\r\n\r\n    // Check the actual query that reminders-service.ts uses\r\n    console.log(\"\\n🔍 === TESTING ACTUAL SERVICE QUERY ===\\n\");\r\n\r\n    const gracePeriodLimit = new Date();\r\n    gracePeriodLimit.setDate(today.getDate() - 5);\r\n    const gracePeriodLimitIso = gracePeriodLimit.toISOString();\r\n\r\n    console.log(`Grace Period Limit: ${gracePeriodLimitIso}\\n`);\r\n\r\n    const { data: serviceQuery, error: sqError } = await supabase\r\n        .from(\"rental_transactions\")\r\n        .select(`\r\n            id,\r\n            amount_due,\r\n            status,\r\n            period_month,\r\n            period_year,\r\n            period_start,\r\n            reminder_sent,\r\n            leases (\r\n                id,\r\n                billing_day,\r\n                tenant_email,\r\n                tenant_name\r\n            )\r\n        `)\r\n        .neq(\"status\", \"paid\")\r\n        .eq(\"reminder_sent\", false)\r\n        .lte(\"period_start\", gracePeriodLimitIso)\r\n        .gte(\"period_year\", today.getFullYear() - 1);\r\n\r\n    console.log(`Service query would return: ${serviceQuery?.length || 0} transactions`);\r\n\r\n    if (serviceQuery && serviceQuery.length > 0) {\r\n        console.log(\"\\nTransactions that would be processed:\");\r\n        serviceQuery.forEach(tx => {\r\n            const lease = Array.isArray(tx.leases) ? tx.leases[0] : tx.leases;\r\n            console.log(`   - ${tx.amount_due?.toLocaleString()} FCFA (${tx.period_month}/${tx.period_year})`);\r\n            console.log(`     period_start: ${tx.period_start}`);\r\n            console.log(`     billing_day: ${lease?.billing_day || 5}\\n`);\r\n        });\r\n    }\r\n}\r\n\r\nverifyState().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-kpis-calculation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-otp-fix.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-storage-policies.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1263,1266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1263,1266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2047,2050],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2047,2050],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour vérifier que les Storage Policies sont bien appliquées\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { config } from \"dotenv\";\n\n// Charger les variables d'environnement\nconfig({ path: \".env.local\" });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error(\"❌ Variables d'environnement manquantes\");\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function main() {\n  console.log(\"🔍 Vérification des Storage Policies pour verification-docs\\n\");\n\n  // Requête pour lister les policies sur storage.objects\n  const { data: policies, error } = await supabase.rpc(\"exec_sql\", {\n    sql: `\n      SELECT\n        polname as policy_name,\n        polcmd as policy_command,\n        CASE polcmd\n          WHEN 'r' THEN 'SELECT'\n          WHEN 'a' THEN 'INSERT'\n          WHEN 'w' THEN 'UPDATE'\n          WHEN 'd' THEN 'DELETE'\n          ELSE 'ALL'\n        END as operation\n      FROM pg_policy\n      WHERE polrelid = 'storage.objects'::regclass\n      AND polname LIKE '%verification-docs%' OR polname LIKE '%Users can%'\n      ORDER BY polname;\n    `,\n  }) as any;\n\n  if (error) {\n    console.log(\"⚠️  Impossible de lister les policies via RPC\");\n    console.log(\"   Vérification manuelle requise dans le Dashboard Supabase\\n\");\n\n    console.log(\"📝 Pour vérifier manuellement:\");\n    console.log(\"   1. Ouvrir: \" + supabaseUrl.replace(\"/rest/v1\", \"\") + \"/storage/buckets/verification-docs\");\n    console.log(\"   2. Cliquer sur 'Policies'\");\n    console.log(\"   3. Vérifier que vous voyez ces 3 policies:\\n\");\n\n    console.log(\"   ✅ Policy 1: 'Users can upload to own folder' (INSERT)\");\n    console.log(\"   ✅ Policy 2: 'Users can view own files or admins can view all' (SELECT)\");\n    console.log(\"   ✅ Policy 3: 'Users can delete own files' (DELETE)\\n\");\n\n    return;\n  }\n\n  console.log(\"✅ Policies trouvées:\\n\");\n  policies.forEach((policy: any) => {\n    console.log(`   - ${policy.policy_name} (${policy.operation})`);\n  });\n\n  console.log(\"\\n🎯 Prochaine étape:\");\n  console.log(\"   Testez l'upload depuis l'interface web:\");\n  console.log(\"   1. Connectez-vous à Dousell Immo\");\n  console.log(\"   2. Allez dans 'Compte' > 'Mes Documents'\");\n  console.log(\"   3. Cliquez sur 'Ajouter un document'\");\n  console.log(\"   4. Uploadez un PDF ou une image (< 5 MB)\");\n  console.log(\"   5. ✅ Le document devrait apparaître dans la liste\\n\");\n}\n\nmain().catch(console.error);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\homeService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\propertyService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\reviewReactionService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\reviewService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\store\\use-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\supabase\\functions\\hibp-password-check\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\types\\dom-to-image-more.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\types\\property.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\update_invoice_logo.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst logoBase64 = fs.readFileSync('logo.txt', 'utf8').trim();\r\nconst invoicePath = path.join('lib', 'invoice.ts');\r\nlet content = fs.readFileSync(invoicePath, 'utf8');\r\n\r\nconst newCode = `    // --- LOGO INTEGRATION ---\r\n    try {\r\n      // Embed Base64 Logo directly to avoid file path issues in production/serverless\r\n      const logoBase64 = \"${logoBase64}\";\r\n      const logoImageBytes = Buffer.from(logoBase64, 'base64');\r\n      const logoImage = await pdfDoc.embedPng(logoImageBytes);\r\n      const logoDims = logoImage.scale(0.25);\r\n\r\n      page.drawImage(logoImage, {\r\n        x: margin,\r\n        y: height - 80 - logoDims.height,\r\n        width: logoDims.width,\r\n        height: logoDims.height,\r\n      });\r\n      yPosition = height - 100 - logoDims.height;\r\n    } catch (e) {\r\n      console.warn(\"Logo loading failed:\", e);\r\n      \r\n      // Fallback Text\r\n      const goldColor = rgb(251 / 255, 191 / 255, 36 / 255);\r\n      const blackColor = rgb(0, 0, 0);\r\n      page.drawText(\"DOUSSEL\", { x: margin, y: yPosition, size: 28, font: boldFont, color: blackColor });\r\n      const textWidth = boldFont.widthOfTextAtSize(\"DOUSSEL\", 28);\r\n      page.drawText(\"IMMO\", { x: margin + textWidth + 8, y: yPosition, size: 28, font: boldFont, color: goldColor });\r\n      yPosition -= 30;\r\n    }`;\r\n\r\n// Replace the try-catch block for logo loading\r\n// We look for the start of the try block and the end of the catch block\r\nconst startMarker = '// --- LOGO INTEGRATION ---';\r\nconst endMarker = '    // Separator';\r\n\r\nconst startIndex = content.indexOf(startMarker);\r\nconst endIndex = content.indexOf(endMarker);\r\n\r\nif (startIndex !== -1 && endIndex !== -1) {\r\n    const before = content.substring(0, startIndex);\r\n    const after = content.substring(endIndex);\r\n    const finalContent = before + newCode + '\\n\\n' + after;\r\n    fs.writeFileSync(invoicePath, finalContent);\r\n    console.log('Successfully injected logo base64 into lib/invoice.ts');\r\n} else {\r\n    console.error('Could not find markers to replace content');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\utils\\supabase\\admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\utils\\supabase\\client.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isLocalhost' is assigned a value but never used.","line":20,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { createBrowserClient } from \"@supabase/ssr\";\r\n\r\nexport function createClient() {\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\n  if (!supabaseUrl || !supabaseAnonKey) {\r\n    console.error(\r\n      \"❌ Supabase credentials are missing. Please check your .env.local file.\"\r\n    );\r\n    throw new Error(\r\n      \"Supabase credentials are missing. Define NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in your .env.local file.\"\r\n    );\r\n  }\r\n\r\n  // Utilisation de la nouvelle API qui gère automatiquement les cookies PKCE\r\n  // Note: Ne pas définir le domaine en développement local (localhost)\r\n  const isLocalhost = typeof window !== 'undefined' &&\r\n    (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');\r\n\r\n  return createBrowserClient(supabaseUrl, supabaseAnonKey);\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\utils\\supabase\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\utils\\supabase\\server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]