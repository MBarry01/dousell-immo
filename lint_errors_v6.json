[{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\__tests__\\integration\\auth.helper.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\__tests__\\integration\\optimistic-update.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\__tests__\\integration\\realtime-sync.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\__tests__\\integration\\temporary-debt.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\a-propos\\a-propos-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\a-propos\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\actions\\check-hibp-server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\actions\\check-hibp.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\actions\\reminders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\agence\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\admin\\performance\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\auth\\check-verification\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\auth\\verify-email\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\cache-metrics\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\clear-cache\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\cron\\generate-monthly-rentals\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\cron\\lease-expirations\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\cron\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\debug\\documents\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\debug\\types\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\documents\\lease\\[id]\\route.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\documents\\receipt\\[id]\\route.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\kkiapay\\confirm\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\kkiapay\\webhook\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6150,6153],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6150,6153],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getKKiaPayConfig, type KKiaPayWebhookPayload } from \"@/lib/kkiapay\";\nimport { _createClient } from \"@/utils/supabase/server\";\nimport { sendEmail } from \"@/lib/mail\";\nimport { invalidateRentalCaches } from \"@/lib/cache/invalidation\";\nimport { invalidateCacheBatch } from \"@/lib/cache/cache-aside\";\n\n/**\n * Webhook KKiaPay pour les notifications serveur-√†-serveur\n * URL √† configurer dans le dashboard KKiaPay: https://votredomaine.com/api/kkiapay/webhook\n */\nexport async function POST(request: Request) {\n  try {\n    const signature = request.headers.get(\"x-kkiapay-signature\");\n    const secret = request.headers.get(\"x-kkiapay-secret\");\n    const rawBody = await request.text();\n\n    // Log pour debugging\n    console.log(\"üì• Webhook KKiaPay re√ßu:\", {\n      hasSignature: !!signature,\n      hasSecret: !!secret,\n      bodyLength: rawBody.length,\n    });\n\n    // KKiaPay peut envoyer soit x-kkiapay-signature soit x-kkiapay-secret\n    const receivedSecret = signature || secret;\n\n    const isProduction = process.env.NODE_ENV === \"production\";\n\n    // V√©rifier le secret\n    const config = getKKiaPayConfig();\n    const secretFromEnv = config.secret;\n\n    if (isProduction && !receivedSecret) {\n      console.error(\"Webhook KKiaPay: Authentification manquante en production\");\n      return Response.json(\n        { error: \"Authentification requise\" },\n        { status: 401 }\n      );\n    }\n\n    if (receivedSecret && receivedSecret !== secretFromEnv) {\n      console.error(\"Webhook KKiaPay: Secret invalide\");\n      return Response.json(\n        { error: \"Secret invalide\" },\n        { status: 401 }\n      );\n    }\n\n    if (!receivedSecret && !isProduction) {\n      console.warn(\"‚ö†Ô∏è Webhook KKiaPay re√ßu sans authentification (mode test)\");\n    }\n\n    const payload: KKiaPayWebhookPayload = JSON.parse(rawBody);\n\n    console.log(\"‚úÖ Webhook KKiaPay valid√©:\", {\n      transactionId: payload.transactionId,\n      status: payload.status,\n      amount: payload.amount,\n      metadata: payload.metadata,\n    });\n\n    // G√©rer uniquement les paiements r√©ussis\n    if (payload.status === \"SUCCESS\") {\n      const metadata = payload.metadata as {\n        type?: string;\n        lease_id?: string;\n        period_month?: number;\n        period_year?: number;\n      } | undefined;\n\n      // V√©rifier si c'est un paiement de loyer\n      if (metadata?.type === \"rent\" && metadata.lease_id && metadata.period_month && metadata.period_year) {\n        // Utiliser un client admin pour les op√©rations de webhook (fiabilit√©)\n        const { createClient: createSupabaseAdmin } = await import('@supabase/supabase-js');\n        const supabaseAdmin = createSupabaseAdmin(\n          process.env.NEXT_PUBLIC_SUPABASE_URL!,\n          process.env.SUPABASE_SERVICE_ROLE_KEY!\n        );\n\n        // R√©cup√©rer infos du bail\n        const { data: lease } = await supabaseAdmin\n          .from(\"leases\")\n          .select(\"tenant_email, tenant_name, monthly_amount, owner_id, property_address, owner:profiles(email, full_name, company_address, address)\")\n          .eq(\"id\", metadata.lease_id)\n          .single();\n\n        if (!lease) {\n          console.error(\"‚ùå Webhook KKiaPay: Bail introuvable\", metadata.lease_id);\n          return Response.json({ success: true });\n        }\n\n        // Marquer le loyer comme pay√©\n        const { data: updatedTx, error: rentError } = await supabaseAdmin\n          .from(\"rental_transactions\")\n          .update({\n            status: \"paid\",\n            paid_at: new Date().toISOString(),\n            payment_ref: payload.transactionId,\n            payment_method: \"kkiapay\",\n          })\n          .eq(\"lease_id\", metadata.lease_id)\n          .eq(\"period_month\", metadata.period_month)\n          .eq(\"period_year\", metadata.period_year)\n          .select('id')\n          .single();\n\n        if (rentError || !updatedTx) {\n          console.error(\"Erreur maj loyer:\", rentError);\n        } else {\n          console.log(`‚úÖ Loyer pay√© via KKiaPay webhook: Bail ${metadata.lease_id}`);\n\n          // --- G√âN√âRATION ET STOCKAGE QUITTANCE PDF ---\n          try {\n            const { createQuittanceDocument } = await import('@/components/pdf/QuittancePDF_v2');\n            const { renderToStream } = await import('@react-pdf/renderer'); // Corrected import for renderToStream\n            const { storeDocumentInGED } = await import('@/lib/ged-utils');\n\n            const owner = lease.owner as { email?: string; full_name?: string; company_address?: string; address?: string } | undefined;\n\n            const receiptData = {\n              leaseId: metadata.lease_id,\n              tenantName: lease.tenant_name,\n              tenantEmail: lease.tenant_email,\n              amount: lease.monthly_amount,\n              periodMonth: `${String(metadata.period_month).padStart(2, '0')}/${metadata.period_year}`,\n              periodStart: new Date(metadata.period_year, metadata.period_month - 1, 1).toLocaleDateString('fr-FR'),\n              periodEnd: new Date(metadata.period_year, metadata.period_month, 0).toLocaleDateString('fr-FR'),\n              receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\n              ownerName: owner?.full_name || 'Propri√©taire',\n              ownerEmail: owner?.email,\n              ownerAddress: owner?.company_address || owner?.address || 'Adresse non renseign√©e',\n              propertyAddress: lease.property_address || 'Adresse non renseign√©e'\n            };\n\n            const pdfDocument = createQuittanceDocument(receiptData);\n            // ReactPDF might be a module with named exports or default depending on how it's built.\n            // But usually renderToStream is a top level export or on the default instance.\n            // If the previous code was require('@react-pdf/renderer'), it got the module.\n            // If typical usage is import { renderToStream } ...\n            // Let's assume renderToStream is available on the module (or default)\n            const stream = await renderToStream(pdfDocument);\n            const chunks: Uint8Array[] = [];\n            const pdfBuffer = await new Promise<Buffer>((resolve, reject) => {\n              stream.on('data', (chunk: any) => chunks.push(chunk));\n              stream.on('end', () => resolve(Buffer.concat(chunks)));\n              stream.on('error', reject);\n            });\n\n            await storeDocumentInGED({\n              userId: lease.owner_id,\n              fileBuffer: new Uint8Array(pdfBuffer),\n              fileName: `Quittance_${receiptData.receiptNumber}_KKIA_${lease.tenant_name.replace(/\\s+/g, '_')}.pdf`,\n              bucketName: 'receipts',\n              documentType: 'quittance',\n              metadata: {\n                leaseId: metadata.lease_id,\n                transactionId: updatedTx.id,\n                tenantName: lease.tenant_name,\n                description: `Quittance - ${receiptData.periodMonth} - ${lease.tenant_name}`\n              }\n            }, supabaseAdmin);\n            console.log(\"‚úÖ Quittance PDF g√©n√©r√©e et stock√©e via utility (KKiaPay)\");\n\n          } catch (pdfError) {\n            console.error(\"‚ùå Erreur g√©n√©ration PDF Quittance KKiaPay:\", pdfError);\n          }\n          // -------------------------------------------\n\n          // Invalidation du cache\n          if (lease?.owner_id) {\n            await invalidateRentalCaches(lease.owner_id, metadata.lease_id, {\n              invalidateLeases: true,\n              invalidateTransactions: true,\n              invalidateStats: true,\n            });\n          }\n\n          if (lease?.tenant_email) {\n            await invalidateCacheBatch([\n              `tenant_dashboard:${lease.tenant_email}`,\n              `tenant_payments:${metadata.lease_id}`,\n            ], \"rentals\");\n          }\n\n          // Envoyer email de confirmation\n          if (lease && lease.tenant_email) {\n            const subject = `Re√ßu de paiement - Loyer ${metadata.period_month}/${metadata.period_year}`;\n            const amountFmt = lease.monthly_amount?.toLocaleString(\"fr-FR\");\n\n            const html = `\n              <h1>Paiement re√ßu !</h1>\n              <p>Bonjour ${lease.tenant_name || \"Locataire\"},</p>\n              <p>Nous confirmons la r√©ception de votre paiement de <strong>${amountFmt} FCFA</strong> pour le loyer de <strong>${metadata.period_month}/${metadata.period_year}</strong>.</p>\n              <p>R√©f√©rence de transaction: <code>${payload.transactionId}</code></p>\n              <p>Votre quittance est d√©sormais disponible dans votre espace locataire.</p>\n              <br/>\n              <p>Cordialement,<br/>L'√©quipe Doussel Immo</p>\n            `;\n\n            await sendEmail({\n              to: lease.tenant_email,\n              subject,\n              html,\n            });\n\n            // Notification propri√©taire\n            const owner = lease.owner as { email?: string; full_name?: string } | undefined;\n            if (owner?.email) {\n              await sendEmail({\n                to: owner.email,\n                subject: `[Paiement] Loyer re√ßu - ${lease.tenant_name}`,\n                html: `<p>Le locataire ${lease.tenant_name} a r√©gl√© son loyer de ${amountFmt} FCFA via KKiaPay.</p><p>R√©f√©rence: ${payload.transactionId}</p>`,\n              });\n            }\n          }\n        }\n      }\n    } else if (payload.status === \"FAILED\") {\n      console.warn(\"‚ùå Paiement KKiaPay √©chou√©:\", {\n        transactionId: payload.transactionId,\n        metadata: payload.metadata,\n      });\n    }\n\n    // Toujours retourner 200 pour confirmer la r√©ception\n    return Response.json({ success: true });\n  } catch (error) {\n    console.error(\"Erreur lors du traitement du webhook KKiaPay:\", error);\n    return Response.json(\n      { error: \"Erreur de traitement\" },\n      { status: 200 } // Retourner 200 pour √©viter les retries excessifs\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\paydunya-api\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\paydunya\\confirm\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\paydunya\\create-invoice\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'customData' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":49,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":49,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createPayDunyaInvoice, getPayDunyaCheckoutUrl, getPayDunyaConfig } from \"@/lib/paydunya\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { getBaseUrl } from \"@/lib/utils\";\n\nexport async function POST(request: Request) {\n  try {\n    const supabase = await createClient();\n\n    // V√©rifier l'authentification\n    const {\n      data: { user },\n      error: userError,\n    } = await supabase.auth.getUser();\n\n    if (userError || !user) {\n      return Response.json(\n        { error: \"Non authentifi√©\" },\n        { status: 401 }\n      );\n    }\n\n    const body = await request.json();\n    const { serviceType, description, propertyId, returnUrl, cancelUrl } = body;\n\n    if (!serviceType || !description) {\n      return Response.json(\n        { error: \"Type de service et description requis\" },\n        { status: 400 }\n      );\n    }\n\n    let amount = 0;\n    let service: { name: string; price: number; code: string } | null = null;\n    let customData: Record<string, unknown> = {};\n\n    if (serviceType === \"rent_payment\") {\n      // Pour le loyer, le montant est variable et vient du body\n      const requestedAmount = Number(body.amount);\n      if (!requestedAmount || requestedAmount <= 0) {\n        return Response.json(\n          { error: \"Montant invalide pour le paiement du loyer\" },\n          { status: 400 }\n        );\n      }\n      amount = requestedAmount;\n      service = { name: description, price: amount, code: \"rent_payment\" };\n\n      // Custom data sp√©cifique pour le loyer\n      customData = {\n        lease_id: propertyId, // propertyId sert de leaseId dans ce contexte\n        type: \"rent_payment\",\n      };\n    } else {\n      // Pour les autres services, on r√©cup√®re le prix depuis la base de donn√©es\n      const { data: dbService, error: serviceError } = await supabase\n        .from(\"services\")\n        .select(\"*\")\n        .eq(\"code\", serviceType)\n        .single();\n\n      if (serviceError || !dbService) {\n        console.error(\"Erreur r√©cup√©ration service:\", serviceError);\n        return Response.json(\n          { error: \"Service invalide ou introuvable\" },\n          { status: 400 }\n        );\n      }\n      amount = dbService.price;\n      service = dbService;\n\n      _customData = {\n        property_id: propertyId || null,\n        type: \"listing_payment\",\n        service_code: dbService.code,\n      };\n    }\n\n    // Si le montant est 0, on ne cr√©e pas de facture PayDunya (ou on g√®re diff√©remment)\n    // Mais ici on suppose que cette route est appel√©e pour payer.\n    // Si c'est gratuit, le frontend ne devrait pas appeler cette route de paiement.\n\n    const config = getPayDunyaConfig();\n\n    const baseUrl = getBaseUrl();\n    const callbackUrl =\n      process.env.PAYDUNYA_CALLBACK_URL || `${baseUrl}/api/paydunya/webhook`;\n\n    // TypeScript check\n    if (!service) {\n      return Response.json(\n        { error: \"Erreur interne: Service non d√©fini\" },\n        { status: 500 }\n      );\n    }\n\n    // Cr√©er la facture PayDunya\n    const invoice = await createPayDunyaInvoice({\n      invoice: {\n        items: [\n          {\n            name: service.name, // Utiliser le nom du service officiel\n            quantity: 1,\n            unit_price: amount,\n            total_price: amount,\n            description: description, // Garder la description personnalis√©e (ex: \"Diffusion Simple - Titre\")\n          },\n        ],\n        total_amount: amount,\n        description,\n      },\n      store: {\n        name: \"Dousell Immo\",\n        tagline: \"Votre partenaire immobilier √† Dakar\",\n        phone: \"+221 77 138 52 81\", // Num√©ro mis √† jour\n        website_url: baseUrl,\n      },\n      actions: {\n        cancel_url: cancelUrl || `${baseUrl}/compte/deposer?payment=canceled`,\n        return_url: returnUrl || `${baseUrl}/compte/deposer?payment=success`,\n        callback_url: callbackUrl,\n      },\n      custom_data: {\n        user_id: user.id,\n        property_id: propertyId || null,\n        type: \"listing_payment\",\n        service_code: service.code, // On garde une trace du code service\n      },\n    });\n\n    // Retourner l'URL de redirection\n    let checkoutUrl = invoice.response_url;\n\n    // PayDunya renvoie parfois l'URL dans 'response_text'\n    if (!checkoutUrl && invoice.response_text && invoice.response_text.startsWith(\"http\")) {\n      checkoutUrl = invoice.response_text;\n    }\n\n    if (!checkoutUrl) {\n      checkoutUrl = getPayDunyaCheckoutUrl(invoice.token, config.mode);\n    }\n\n    return Response.json({\n      success: true,\n      token: invoice.token,\n      checkout_url: checkoutUrl,\n    });\n  } catch (error) {\n    console.error(\"Erreur lors de la cr√©ation de la facture PayDunya:\", error);\n    return Response.json(\n      {\n        error: error instanceof Error ? error.message : \"Erreur lors de la cr√©ation de la facture\",\n      },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\paydunya\\opr\\charge\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\paydunya\\opr\\create\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\paydunya\\webhook\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\properties\\categories\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\properties\\featured\\route.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[415,418],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[415,418],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\property-stats\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\reset-reminders\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\save-receipt\\route.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\send-notice\\route.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\send-receipt\\route.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\test-reminders\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\api\\user\\roles\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\auth-code-error\\auth-code-error-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\auth-code-error\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\callback\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":48,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1892,1895],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1892,1895],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\nimport { NextResponse } from \"next/server\";\nimport { getSmartRedirectPath } from \"@/lib/auth-redirect\";\n\nexport async function GET(request: Request) {\n  // 1. On r√©cup√®re l'URL actuelle (que ce soit localhost ou vercel)\n  const { searchParams, origin } = new URL(request.url);\n  const code = searchParams.get(\"code\");\n  const token_hash = searchParams.get(\"token_hash\");\n  const type = searchParams.get(\"type\"); // email, signup, recovery, etc.\n  const error = searchParams.get(\"error\");\n  const errorDescription = searchParams.get(\"error_description\");\n  const next = searchParams.get(\"next\"); // Peut √™tre null, on utilisera la redirection intelligente\n\n  // Log pour d√©bugger\n  console.log(\"üîç Auth Callback Debug:\", {\n    code: code ? \"‚úì pr√©sent\" : \"‚úó manquant\",\n    token_hash: token_hash ? \"‚úì pr√©sent\" : \"‚úó manquant\",\n    type,\n    error,\n    errorDescription,\n    next,\n    origin,\n  });\n\n  // Si Google renvoie une erreur dans les query params\n  if (error) {\n    console.error(\"‚ùå OAuth Error from Google:\", {\n      error,\n      errorDescription,\n    });\n    // Rediriger vers la page d'erreur avec un message sp√©cifique\n    const errorUrl = new URL(`${origin}/auth/auth-code-error`);\n    if (errorDescription) {\n      errorUrl.searchParams.set(\"reason\", decodeURIComponent(errorDescription));\n    }\n    return NextResponse.redirect(errorUrl.toString());\n  }\n\n  const supabase = await createClient();\n\n  // FLUX 1 : V√©rification Email via Token Hash (Email Confirmation)\n  // üí° C'est ce flux qui permet le cross-browser (clic sur mobile, ouverture sur PC)\n  if (token_hash && type) {\n    console.log(\"üîê Email confirmation flow (token_hash) - Cross-browser compatible\");\n    try {\n      const { data, error: verifyError } = await supabase.auth.verifyOtp({\n        type: type === 'email' || type === 'signup' ? 'email' : type as any,\n        token_hash,\n      });\n\n      if (verifyError) {\n        console.error(\"‚ùå Error verifying OTP:\", verifyError);\n        const errorUrl = new URL(`${origin}/auth/auth-code-error`);\n        errorUrl.searchParams.set(\"reason\", verifyError.message);\n        return NextResponse.redirect(errorUrl.toString());\n      }\n\n      if (data.session) {\n        console.log(\"‚úÖ Email verified, session created\");\n        // Utiliser la redirection intelligente avec le param√®tre next si fourni\n        const smartRedirect = await getSmartRedirectPath(next || undefined);\n        return NextResponse.redirect(`${origin}${smartRedirect}${smartRedirect.includes('?') ? '&' : '?'}verified=true`);\n      }\n\n      console.error(\"‚ùå No session after OTP verification\");\n      return NextResponse.redirect(`${origin}/auth/auth-code-error`);\n    } catch (err) {\n      console.error(\"‚ùå Unexpected error in OTP verification:\", err);\n      return NextResponse.redirect(`${origin}/auth/auth-code-error`);\n    }\n  }\n\n  // FLUX 2 : OAuth/PKCE Flow (Google, Magic Link avec Code)\n  if (!code) {\n    console.error(\"‚ùå No authorization code or token_hash received\");\n    return NextResponse.redirect(`${origin}/auth/auth-code-error`);\n  }\n\n  // √âchanger le code pour une session\n  try {\n    const { data, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);\n\n    if (exchangeError) {\n      console.error(\"‚ùå Error exchanging code for session:\", exchangeError);\n      // Rediriger vers la page d'erreur avec le d√©tail de l'erreur\n      const errorUrl = new URL(`${origin}/auth/auth-code-error`);\n      errorUrl.searchParams.set(\"reason\", exchangeError.message);\n      return NextResponse.redirect(errorUrl.toString());\n    }\n\n    if (data.session) {\n      console.log(\"‚úÖ Session cr√©√©e avec succ√®s\");\n      console.log(\"üë§ Utilisateur connect√©:\", data.user?.email);\n\n      // Si c'est une v√©rification d'email (type=signup), rediriger vers la home avec un message de succ√®s\n      const isEmailVerification = searchParams.get(\"type\") === \"signup\" ||\n        searchParams.get(\"type\") === \"email\";\n\n      if (isEmailVerification) {\n        console.log(\"‚úÖ Email v√©rifi√© - redirection intelligente\");\n        const smartRedirect = await getSmartRedirectPath();\n        return NextResponse.redirect(`${origin}${smartRedirect}?verified=true`);\n      }\n\n      // Sinon, utiliser la redirection intelligente\n      // Si un next est sp√©cifi√© explicitement, l'utiliser\n      if (next) {\n        const redirectUrl = `${origin}${next}`;\n        console.log(\"üîÄ Redirecting to explicit next:\", redirectUrl);\n        return NextResponse.redirect(redirectUrl);\n      }\n\n      // Sinon, d√©terminer la bonne route selon le type d'utilisateur\n      const smartRedirect = await getSmartRedirectPath();\n      console.log(\"üîÄ Smart redirect to:\", smartRedirect);\n      return NextResponse.redirect(`${origin}${smartRedirect}`);\n    }\n\n    // Si pas de session apr√®s √©change r√©ussi, erreur\n    console.error(\"‚ùå No session after successful exchange\");\n    return NextResponse.redirect(`${origin}/auth/auth-code-error`);\n  } catch (err) {\n    console.error(\"‚ùå Unexpected error in callback:\", err);\n    return NextResponse.redirect(`${origin}/auth/auth-code-error`);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\check-email\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\check-email\\check-email-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\check-email\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\confirm\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1803,1806],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1803,1806],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\nimport { NextResponse } from \"next/server\";\n\n/**\n * Route pour confirmer un email via token\n * Alternative au PKCE pour √©viter les erreurs \"code verifier not found\"\n */\nexport async function GET(request: Request) {\n  const { searchParams, origin } = new URL(request.url);\n\n  // Supabase peut envoyer soit token_hash (nouveau) soit code (ancien)\n  const token_hash = searchParams.get(\"token_hash\");\n  const code = searchParams.get(\"code\");\n  const type = searchParams.get(\"type\");\n  const next = searchParams.get(\"next\") ?? \"/\";\n\n  console.log(\"üîç Auth Confirm Debug:\", {\n    token_hash: token_hash ? \"‚úì pr√©sent\" : \"‚úó manquant\",\n    code: code ? \"‚úì pr√©sent\" : \"‚úó manquant\",\n    type,\n    next,\n    origin,\n  });\n\n  try {\n    const supabase = await createClient();\n\n    // Si on a un code (ancien format), utiliser exchangeCodeForSession\n    if (code) {\n      console.log(\"üìù Utilisation de exchangeCodeForSession avec code\");\n      const { data, error } = await supabase.auth.exchangeCodeForSession(code);\n\n      if (error) {\n        console.error(\"‚ùå Error exchanging code:\", error);\n        return NextResponse.redirect(\n          `${origin}/auth/auth-code-error?reason=${encodeURIComponent(error.message)}`\n        );\n      }\n\n      if (data.session) {\n        console.log(\"‚úÖ Session cr√©√©e avec succ√®s via code\");\n        const redirectUrl = next ? `${origin}${next}` : `${origin}/?verified=true`;\n        return NextResponse.redirect(redirectUrl);\n      }\n    }\n\n    // Si on a un token_hash (nouveau format), utiliser verifyOtp\n    if (token_hash && type) {\n      console.log(\"üìù Utilisation de verifyOtp avec token_hash\");\n      const { error } = await supabase.auth.verifyOtp({\n        token_hash: token_hash as string,\n        type: type as any,\n      });\n\n      if (error) {\n        console.error(\"‚ùå Error verifying token:\", error);\n        return NextResponse.redirect(\n          `${origin}/auth/auth-code-error?reason=${encodeURIComponent(error.message)}`\n        );\n      }\n\n      // Important: Rafra√Æchir la session pour s'assurer que les cookies sont bien d√©finis\n      const { data: { session }, error: sessionError } = await supabase.auth.getSession();\n\n      if (sessionError || !session) {\n        console.error(\"‚ùå Session non √©tablie apr√®s v√©rification:\", sessionError);\n        return NextResponse.redirect(\n          `${origin}/auth/auth-code-error?reason=Echec de creation de session`\n        );\n      }\n\n      console.log(\"‚úÖ Email v√©rifi√© avec succ√®s via token_hash - Session active:\", session.user.email);\n      // Redirection\n      const redirectUrl = next ? `${origin}${next}` : `${origin}/`;\n      return NextResponse.redirect(redirectUrl);\n    }\n\n    // Si aucun token valide\n    console.error(\"‚ùå No valid token provided\");\n    return NextResponse.redirect(\n      `${origin}/auth/auth-code-error?reason=Token manquant ou invalide`\n    );\n  } catch (err) {\n    console.error(\"‚ùå Unexpected error in confirm:\", err);\n    return NextResponse.redirect(\n      `${origin}/auth/auth-code-error?reason=Erreur inattendue`\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\google\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\magic-verify\\magic-verify-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\magic-verify\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\signout\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\verified\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\verify-email\\page.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\verify-email\\page.tsx:21:13\n  19 |     useEffect(() => {\n  20 |         if (!token) {\n> 21 |             setStatus(\"error\");\n     |             ^^^^^^^^^ Avoid calling setState() directly within an effect\n  22 |             setErrorMessage(\"Lien de v√©rification invalide. Le token est manquant.\");\n  23 |         }\n  24 |     }, [token]);","line":21,"column":13,"nodeType":null,"endLine":21,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, Suspense } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Mail, CheckCircle, XCircle, Loader2, ArrowLeft } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nfunction VerifyEmailContent() {\r\n    const router = useRouter();\r\n    const searchParams = useSearchParams();\r\n    const token = searchParams.get(\"token\");\r\n\r\n    const [status, setStatus] = useState<\"idle\" | \"loading\" | \"success\" | \"error\">(\"idle\");\r\n    const [errorMessage, setErrorMessage] = useState<string>(\"\");\r\n\r\n    // Si pas de token, afficher une erreur\r\n    useEffect(() => {\r\n        if (!token) {\r\n            setStatus(\"error\");\r\n            setErrorMessage(\"Lien de v√©rification invalide. Le token est manquant.\");\r\n        }\r\n    }, [token]);\r\n\r\n    const handleVerify = async () => {\r\n        if (!token) return;\r\n\r\n        setStatus(\"loading\");\r\n\r\n        try {\r\n            const response = await fetch(\"/api/auth/verify-email\", {\r\n                method: \"POST\",\r\n                headers: {\r\n                    \"Content-Type\": \"application/json\",\r\n                },\r\n                body: JSON.stringify({ token }),\r\n            });\r\n\r\n            const data = await response.json();\r\n\r\n            if (!response.ok || !data.success) {\r\n                setStatus(\"error\");\r\n                setErrorMessage(data.error || \"Erreur lors de la v√©rification\");\r\n                return;\r\n            }\r\n\r\n            setStatus(\"success\");\r\n        } catch (error) {\r\n            console.error(\"Erreur:\", error);\r\n            setStatus(\"error\");\r\n            setErrorMessage(\"Erreur de connexion. Veuillez r√©essayer.\");\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-background via-background to-black px-4 py-12\">\r\n            <motion.div\r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                transition={{ duration: 0.5 }}\r\n                className=\"w-full max-w-md\"\r\n            >\r\n                {/* Back Button */}\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    className=\"mb-6 -ml-2 text-white/70 hover:text-white\"\r\n                    asChild\r\n                >\r\n                    <Link href=\"/\">\r\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n                        Retour\r\n                    </Link>\r\n                </Button>\r\n\r\n                {/* Card */}\r\n                <div className=\"rounded-2xl border border-white/10 bg-white/5 p-8 backdrop-blur-xl md:bg-white/10\">\r\n                    {/* Icon */}\r\n                    <div className=\"mb-6 flex justify-center\">\r\n                        <div className={`flex h-20 w-20 items-center justify-center rounded-full ${status === \"success\"\r\n                                ? \"bg-green-500/20\"\r\n                                : status === \"error\"\r\n                                    ? \"bg-red-500/20\"\r\n                                    : \"bg-amber-500/20\"\r\n                            }`}>\r\n                            {status === \"success\" ? (\r\n                                <motion.div\r\n                                    initial={{ scale: 0 }}\r\n                                    animate={{ scale: 1 }}\r\n                                    transition={{ type: \"spring\", duration: 0.5 }}\r\n                                >\r\n                                    <CheckCircle className=\"h-10 w-10 text-green-500\" />\r\n                                </motion.div>\r\n                            ) : status === \"error\" ? (\r\n                                <XCircle className=\"h-10 w-10 text-red-500\" />\r\n                            ) : status === \"loading\" ? (\r\n                                <Loader2 className=\"h-10 w-10 text-amber-500 animate-spin\" />\r\n                            ) : (\r\n                                <Mail className=\"h-10 w-10 text-amber-500\" />\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Content */}\r\n                    <div className=\"text-center space-y-4\">\r\n                        <h1 className=\"text-2xl font-bold text-white\">\r\n                            {status === \"success\"\r\n                                ? \"‚úÖ Email v√©rifi√© !\"\r\n                                : status === \"error\"\r\n                                    ? \"‚ùå Erreur de v√©rification\"\r\n                                    : status === \"loading\"\r\n                                        ? \"‚è≥ V√©rification en cours...\"\r\n                                        : \"üìß V√©rification de votre email\"}\r\n                        </h1>\r\n\r\n                        <p className=\"text-white/70\">\r\n                            {status === \"success\" ? (\r\n                                \"Votre compte a √©t√© activ√© avec succ√®s ! Vous pouvez maintenant vous connecter.\"\r\n                            ) : status === \"error\" ? (\r\n                                errorMessage\r\n                            ) : status === \"loading\" ? (\r\n                                \"Veuillez patienter pendant que nous v√©rifions votre compte...\"\r\n                            ) : (\r\n                                \"Cliquez sur le bouton ci-dessous pour confirmer votre adresse email et activer votre compte.\"\r\n                            )}\r\n                        </p>\r\n\r\n                        {/* Action Button */}\r\n                        <div className=\"pt-4\">\r\n                            {status === \"idle\" && token && (\r\n                                <Button\r\n                                    onClick={handleVerify}\r\n                                    className=\"w-full h-12 rounded-xl bg-primary text-black hover:bg-primary/90\"\r\n                                >\r\n                                    ‚úÖ V√©rifier mon email\r\n                                </Button>\r\n                            )}\r\n\r\n                            {status === \"success\" && (\r\n                                <Button\r\n                                    onClick={() => router.push(\"/login\")}\r\n                                    className=\"w-full h-12 rounded-xl bg-green-500 text-white hover:bg-green-600\"\r\n                                >\r\n                                    üöÄ Se connecter\r\n                                </Button>\r\n                            )}\r\n\r\n                            {status === \"error\" && (\r\n                                <div className=\"space-y-3\">\r\n                                    <Button\r\n                                        onClick={() => router.push(\"/register\")}\r\n                                        className=\"w-full h-12 rounded-xl bg-primary text-black hover:bg-primary/90\"\r\n                                    >\r\n                                        Cr√©er un nouveau compte\r\n                                    </Button>\r\n                                    <Button\r\n                                        variant=\"outline\"\r\n                                        onClick={() => router.push(\"/login\")}\r\n                                        className=\"w-full h-12 rounded-xl border-white/20 text-white hover:bg-white/10\"\r\n                                    >\r\n                                        Se connecter\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n\r\n                            {status === \"loading\" && (\r\n                                <Button\r\n                                    disabled\r\n                                    className=\"w-full h-12 rounded-xl bg-gray-600 text-gray-400\"\r\n                                >\r\n                                    <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\r\n                                    V√©rification...\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </motion.div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default function VerifyEmailPage() {\r\n    return (\r\n        <Suspense fallback={\r\n            <div className=\"flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-background via-background to-black px-4 py-12\">\r\n                <div className=\"flex flex-col items-center gap-4\">\r\n                    <Loader2 className=\"h-10 w-10 text-amber-500 animate-spin\" />\r\n                    <p className=\"text-white/70\">Chargement...</p>\r\n                </div>\r\n            </div>\r\n        }>\r\n            <VerifyEmailContent />\r\n        </Suspense>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\verify-email\\verify-email-client.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\verify-email\\verify-email-client.tsx:21:13\n  19 |     useEffect(() => {\n  20 |         if (!token) {\n> 21 |             setStatus(\"error\");\n     |             ^^^^^^^^^ Avoid calling setState() directly within an effect\n  22 |             setErrorMessage(\"Lien de v√©rification invalide. Le token est manquant.\");\n  23 |         }\n  24 |     }, [token]);","line":21,"column":13,"nodeType":null,"endLine":21,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Mail, CheckCircle, XCircle, Loader2, ArrowLeft } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nexport default function VerifyEmailContent() {\r\n    const router = useRouter();\r\n    const searchParams = useSearchParams();\r\n    const token = searchParams.get(\"token\");\r\n\r\n    const [status, setStatus] = useState<\"idle\" | \"loading\" | \"success\" | \"error\">(\"idle\");\r\n    const [errorMessage, setErrorMessage] = useState<string>(\"\");\r\n\r\n    // Si pas de token, afficher une erreur\r\n    useEffect(() => {\r\n        if (!token) {\r\n            setStatus(\"error\");\r\n            setErrorMessage(\"Lien de v√©rification invalide. Le token est manquant.\");\r\n        }\r\n    }, [token]);\r\n\r\n    const handleVerify = async () => {\r\n        if (!token) return;\r\n\r\n        setStatus(\"loading\");\r\n\r\n        try {\r\n            const response = await fetch(\"/api/auth/verify-email\", {\r\n                method: \"POST\",\r\n                headers: {\r\n                    \"Content-Type\": \"application/json\",\r\n                },\r\n                body: JSON.stringify({ token }),\r\n            });\r\n\r\n            const data = await response.json();\r\n\r\n            if (!response.ok || !data.success) {\r\n                setStatus(\"error\");\r\n                setErrorMessage(data.error || \"Erreur lors de la v√©rification\");\r\n                return;\r\n            }\r\n\r\n            setStatus(\"success\");\r\n        } catch (error) {\r\n            console.error(\"Erreur:\", error);\r\n            setStatus(\"error\");\r\n            setErrorMessage(\"Erreur de connexion. Veuillez r√©essayer.\");\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-background via-background to-black px-4 py-12\">\r\n            <motion.div\r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                transition={{ duration: 0.5 }}\r\n                className=\"w-full max-w-md\"\r\n            >\r\n                {/* Back Button */}\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    className=\"mb-6 -ml-2 text-white/70 hover:text-white\"\r\n                    asChild\r\n                >\r\n                    <Link href=\"/\">\r\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n                        Retour\r\n                    </Link>\r\n                </Button>\r\n\r\n                {/* Card */}\r\n                <div className=\"rounded-2xl border border-white/10 bg-white/5 p-8 backdrop-blur-xl md:bg-white/10\">\r\n                    {/* Icon */}\r\n                    <div className=\"mb-6 flex justify-center\">\r\n                        <div className={`flex h-20 w-20 items-center justify-center rounded-full ${status === \"success\"\r\n                                ? \"bg-green-500/20\"\r\n                                : status === \"error\"\r\n                                    ? \"bg-red-500/20\"\r\n                                    : \"bg-amber-500/20\"\r\n                            }`}>\r\n                            {status === \"success\" ? (\r\n                                <motion.div\r\n                                    initial={{ scale: 0 }}\r\n                                    animate={{ scale: 1 }}\r\n                                    transition={{ type: \"spring\", duration: 0.5 }}\r\n                                >\r\n                                    <CheckCircle className=\"h-10 w-10 text-green-500\" />\r\n                                </motion.div>\r\n                            ) : status === \"error\" ? (\r\n                                <XCircle className=\"h-10 w-10 text-red-500\" />\r\n                            ) : status === \"loading\" ? (\r\n                                <Loader2 className=\"h-10 w-10 text-amber-500 animate-spin\" />\r\n                            ) : (\r\n                                <Mail className=\"h-10 w-10 text-amber-500\" />\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Content */}\r\n                    <div className=\"text-center space-y-4\">\r\n                        <h1 className=\"text-2xl font-bold text-white\">\r\n                            {status === \"success\"\r\n                                ? \"‚úÖ Email v√©rifi√© !\"\r\n                                : status === \"error\"\r\n                                    ? \"‚ùå Erreur de v√©rification\"\r\n                                    : status === \"loading\"\r\n                                        ? \"‚è≥ V√©rification en cours...\"\r\n                                        : \"üìß V√©rification de votre email\"}\r\n                        </h1>\r\n\r\n                        <p className=\"text-white/70\">\r\n                            {status === \"success\" ? (\r\n                                \"Votre compte a √©t√© activ√© avec succ√®s ! Vous pouvez maintenant vous connecter.\"\r\n                            ) : status === \"error\" ? (\r\n                                errorMessage\r\n                            ) : status === \"loading\" ? (\r\n                                \"Veuillez patienter pendant que nous v√©rifions votre compte...\"\r\n                            ) : (\r\n                                \"Cliquez sur le bouton ci-dessous pour confirmer votre adresse email et activer votre compte.\"\r\n                            )}\r\n                        </p>\r\n\r\n                        {/* Action Button */}\r\n                        <div className=\"pt-4\">\r\n                            {status === \"idle\" && token && (\r\n                                <Button\r\n                                    onClick={handleVerify}\r\n                                    className=\"w-full h-12 rounded-xl bg-primary text-black hover:bg-primary/90\"\r\n                                >\r\n                                    ‚úÖ V√©rifier mon email\r\n                                </Button>\r\n                            )}\r\n\r\n                            {status === \"success\" && (\r\n                                <Button\r\n                                    onClick={() => router.push(\"/login\")}\r\n                                    className=\"w-full h-12 rounded-xl bg-green-500 text-white hover:bg-green-600\"\r\n                                >\r\n                                    üöÄ Se connecter\r\n                                </Button>\r\n                            )}\r\n\r\n                            {status === \"error\" && (\r\n                                <div className=\"space-y-3\">\r\n                                    <Button\r\n                                        onClick={() => router.push(\"/register\")}\r\n                                        className=\"w-full h-12 rounded-xl bg-primary text-black hover:bg-primary/90\"\r\n                                    >\r\n                                        Cr√©er un nouveau compte\r\n                                    </Button>\r\n                                    <Button\r\n                                        variant=\"outline\"\r\n                                        onClick={() => router.push(\"/login\")}\r\n                                        className=\"w-full h-12 rounded-xl border-white/20 text-white hover:bg-white/10\"\r\n                                    >\r\n                                        Se connecter\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n\r\n                            {status === \"loading\" && (\r\n                                <Button\r\n                                    disabled\r\n                                    className=\"w-full h-12 rounded-xl bg-gray-600 text-gray-400\"\r\n                                >\r\n                                    <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\r\n                                    V√©rification...\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </motion.div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\auth\\verify-recovery\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1799,1802],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1799,1802],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState, Suspense } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\nimport { Loader2, AlertCircle } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nfunction VerifyRecoveryContent() {\r\n    const router = useRouter();\r\n    const searchParams = useSearchParams();\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [_isProcessing, setIsProcessing] = useState(true);\r\n\r\n    useEffect(() => {\r\n        const exchangeCode = async () => {\r\n            const code = searchParams.get(\"code\");\r\n            const next = searchParams.get(\"next\") || \"/compte/reset-password\";\r\n\r\n            if (!code) {\r\n                setError(\"Le lien de r√©cup√©ration est invalide ou a expir√©.\");\r\n                setIsProcessing(false);\r\n                return;\r\n            }\r\n\r\n            try {\r\n                const supabase = createClient();\r\n                console.log(\"üìù Client-side exchange for recovery code...\");\r\n\r\n                const { error } = await supabase.auth.exchangeCodeForSession(code);\r\n\r\n                if (error) {\r\n                    console.error(\"‚ùå Exchange error:\", error);\r\n                    setError(error.message);\r\n                    toast.error(\"√âchec de la r√©cup√©ration de session\");\r\n                    setIsProcessing(false);\r\n                    return;\r\n                }\r\n\r\n                console.log(\"‚úÖ Session established on client!\");\r\n                toast.success(\"Session √©tablie !\");\r\n\r\n                // Redirection vers la page de changement de mot de passe\r\n                router.push(next);\r\n                router.refresh();\r\n            } catch (err: any) {\r\n                console.error(\"‚ùå Unexpected error:\", err);\r\n                setError(\"Une erreur inattendue est survenue lors de la v√©rification.\");\r\n                setIsProcessing(false);\r\n            }\r\n        };\r\n\r\n        exchangeCode();\r\n    }, [searchParams, router]);\r\n\r\n    return (\r\n        <div className=\"flex h-screen w-full flex-col items-center justify-center bg-[#05080c] text-white p-4\">\r\n            <div className=\"max-w-md w-full bg-slate-900/50 border border-white/5 rounded-2xl p-8 backdrop-blur-xl shadow-2xl text-center space-y-6\">\r\n                {error ? (\r\n                    <div className=\"space-y-6 animate-in fade-in zoom-in-95 duration-500\">\r\n                        <div className=\"flex justify-center\">\r\n                            <div className=\"bg-red-500/10 p-4 rounded-full ring-1 ring-red-500/20\">\r\n                                <AlertCircle className=\"h-10 w-10 text-red-500\" />\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <h1 className=\"text-2xl font-bold\">Erreur de v√©rification</h1>\r\n                            <p className=\"text-white/50 text-sm leading-relaxed\">\r\n                                {error === \"PKCE code verifier not found in storage.\"\r\n                                    ? \"La session de s√©curit√© a expir√©. Veuillez recommencer la demande de r√©initialisation depuis le m√™me navigateur.\"\r\n                                    : error}\r\n                            </p>\r\n                        </div>\r\n                        <div className=\"pt-4 space-y-3\">\r\n                            <Button\r\n                                onClick={() => router.push(\"/reset-password\")}\r\n                                className=\"w-full bg-primary text-black font-bold h-11\"\r\n                            >\r\n                                Refaire une demande\r\n                            </Button>\r\n                            <Button\r\n                                variant=\"ghost\"\r\n                                onClick={() => router.push(\"/login\")}\r\n                                className=\"w-full text-white/50 hover:text-white\"\r\n                            >\r\n                                Retour √† la connexion\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"space-y-6\">\r\n                        <div className=\"flex justify-center\">\r\n                            <Loader2 className=\"h-12 w-12 animate-spin text-primary\" />\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <h1 className=\"text-xl font-semibold italic\">Authentification en cours...</h1>\r\n                            <p className=\"text-white/40 text-sm\">\r\n                                Veuillez patienter pendant que nous s√©curisons votre acc√®s.\r\n                            </p>\r\n                        </div>\r\n                        {/* Fallback auto-redirect link just in case */}\r\n                        <div className=\"text-[10px] text-white/10 pt-8 italic\">\r\n                            PKCE Verification Flow (Client-Side)\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction VerifyRecoveryFallback() {\r\n    return (\r\n        <div className=\"flex h-screen items-center justify-center bg-[#05080c]\">\r\n            <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default function VerifyRecoveryPage() {\r\n    return (\r\n        <Suspense fallback={<VerifyRecoveryFallback />}>\r\n            <VerifyRecoveryContent />\r\n        </Suspense>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\biens\\[id]\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\biens\\[id]\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\biens\\[id]\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\biens\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\biens\\ext\\[id]\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\biens\\ext\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\bienvenue\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\bienvenue\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\blog\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\carrieres\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\contact\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\estimation\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\favoris\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\investissement\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\legal\\cgu\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\legal\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\legal\\privacy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\location\\[city]\\[type]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\location\\[city]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[983,986],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[983,986],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Metadata } from \"next\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { getProperties, getActiveCities } from \"@/services/propertyService\";\r\nimport { getSimilarListings } from \"@/services/gatewayService\";\r\nimport { slugify, unslugify } from \"@/lib/slugs\";\r\nimport ProgrammaticPageTemplate from \"@/components/seo/ProgrammaticPageTemplate\";\r\n\r\n// ISR: Update every hour\r\nexport const revalidate = 3600;\r\nexport const dynamicParams = true;\r\n\r\ninterface PageProps {\r\n    params: Promise<{\r\n        city: string;\r\n    }>;\r\n}\r\n\r\nconst capitalize = (text: string) =>\r\n    text.charAt(0).toUpperCase() + text.slice(1);\r\n\r\n// 1. Generate Static Params (Rentals ONLY)\r\nexport async function generateStaticParams() {\r\n    const { data: combinations, error } = await supabase\r\n        .rpc('get_active_cities_and_types', { min_count: 1, target_transaction_type: 'location' });\r\n\r\n    if (error || !combinations) return [];\r\n\r\n    const uniqueCities = new Set(combinations.map((c: any) => slugify(c.city)));\r\n    return Array.from(uniqueCities).map((city) => ({\r\n        city: city,\r\n    }));\r\n}\r\n\r\n// 2. Metadata Generator\r\nexport async function generateMetadata({ params }: PageProps): Promise<Metadata> {\r\n    const { city } = await params;\r\n    const displayCity = capitalize(unslugify(city));\r\n\r\n    return {\r\n        title: `Immobilier √† louer √† ${displayCity} : Toutes les annonces`,\r\n        description: `D√©couvrez toutes les locations disponibles √† ${displayCity}. Appartements, villas, studios v√©rifi√©s par Doussel Immo.`,\r\n    };\r\n}\r\n\r\n// 3. Page Component\r\nexport default async function RentalCityPage({ params }: PageProps) {\r\n    const { city } = await params;\r\n    const searchCity = unslugify(city);\r\n\r\n    const properties = await getProperties({\r\n        citySlug: city,\r\n        category: 'location', // Strict Filter\r\n        status: \"disponible\",\r\n        limit: 50,\r\n    });\r\n\r\n    const displayCity = capitalize(searchCity);\r\n\r\n    // Determines the correct city name to search for (using real DB value if possible)\r\n    const cityName = properties.length > 0 ? properties[0].location.city : displayCity;\r\n\r\n    const similarProperties = await getSimilarListings({\r\n        transactionType: 'location',\r\n        city: cityName,\r\n        excludeIds: properties.map(p => p.id),\r\n        limit: 6\r\n    });\r\n\r\n    const activeCities = await getActiveCities();\r\n\r\n    return (\r\n        <ProgrammaticPageTemplate\r\n            mode=\"location\"\r\n            city={city}\r\n            displayCity={displayCity}\r\n            properties={properties}\r\n            similarProperties={similarProperties}\r\n            nearbyCities={activeCities}\r\n        />\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\location\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\login\\login-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\notifications\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\offline\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\planifier-visite\\actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\planifier-visite\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\planifier-visite\\planifier-visite-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\recherche\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\recherche\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\register\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\register\\register-client.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\register\\register-client.tsx:64:11\n  62 |         const phoneNumber = parsePhoneNumber(phoneValue);\n  63 |         if (phoneNumber && phoneNumber.country) {\n> 64 |           setSelectedCountry(phoneNumber.country as RPNInput.Country);\n     |           ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  65 |         }\n  66 |       } catch (_e) {\n  67 |         // Ignorer les erreurs de d√©tection de pays (num√©ro invalide, etc.)","line":64,"column":11,"nodeType":null,"endLine":64,"endColumn":29}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useTransition, useEffect } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  User,\r\n  Mail,\r\n  Lock,\r\n  Eye,\r\n  EyeOff,\r\n  ArrowLeft,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport * as RPNInput from \"react-phone-number-input\";\r\nimport { getCountryCallingCode } from \"react-phone-number-input\";\r\nimport { parsePhoneNumber } from \"libphonenumber-js\";\r\nimport flags from \"react-phone-number-input/flags\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { PhoneInput } from \"@/components/ui/phone-input\";\r\nimport { Captcha } from \"@/components/ui/captcha\";\r\nimport { signup } from \"@/app/(vitrine)/auth/actions\";\r\n\r\nexport default function RegisterContent() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const plan = searchParams.get(\"plan\") || \"starter\";\r\n  const [isPending, startTransition] = useTransition();\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [phoneValue, setPhoneValue] = useState<RPNInput.Value | undefined>(undefined);\r\n  const [selectedCountry, setSelectedCountry] = useState<RPNInput.Country>(\"SN\");\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [captchaToken, setCaptchaToken] = useState<string | null>(null);\r\n  const [validationErrors, setValidationErrors] = useState<{\r\n    fullName?: string;\r\n    email?: string;\r\n    phone?: string;\r\n    password?: string;\r\n    confirmPassword?: string;\r\n  }>({});\r\n\r\n  // Fonction pour obtenir le drapeau et l'indicatif du pays\r\n  const getCountryInfo = (country: RPNInput.Country | undefined) => {\r\n    if (!country) {\r\n      return { Flag: null, callingCode: \"\" };\r\n    }\r\n    const Flag = flags[country];\r\n    const callingCode = getCountryCallingCode(country);\r\n    return { Flag, callingCode };\r\n  };\r\n\r\n  const { Flag: _SelectedFlag, _callingCode } = getCountryInfo(selectedCountry);\r\n\r\n  // Synchroniser le pays s√©lectionn√© avec la valeur du t√©l√©phone\r\n  useEffect(() => {\r\n    if (phoneValue && typeof phoneValue === \"string\") {\r\n      try {\r\n        const phoneNumber = parsePhoneNumber(phoneValue);\r\n        if (phoneNumber && phoneNumber.country) {\r\n          setSelectedCountry(phoneNumber.country as RPNInput.Country);\r\n        }\r\n      } catch (_e) {\r\n        // Ignorer les erreurs de d√©tection de pays (num√©ro invalide, etc.)\r\n      }\r\n    }\r\n  }, [phoneValue]);\r\n\r\n  const handleGoogleSignIn = () => {\r\n    // Utiliser une route API pour Google OAuth (meilleure gestion des cookies PKCE)\r\n    window.location.href = \"/auth/google\";\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-background via-background to-black px-4 py-12\">\r\n      <motion.div\r\n        initial={{ opacity: 0, y: 20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        transition={{ duration: 0.5 }}\r\n        className=\"w-full max-w-md\"\r\n      >\r\n        {/* Back Button */}\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          className=\"mb-6 -ml-2 text-white/70 hover:text-white\"\r\n          asChild\r\n        >\r\n          <Link href=\"/\">\r\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n            Retour\r\n          </Link>\r\n        </Button>\r\n\r\n        {/* Card */}\r\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur-xl md:bg-white/10\">\r\n          {/* Header */}\r\n          <div className=\"mb-8 text-center\">\r\n            <Link href=\"/\" className=\"inline-block\">\r\n              <h1 className=\"text-2xl font-bold text-white\">Dousell Immo</h1>\r\n            </Link>\r\n            <h2 className=\"mt-4 text-2xl font-semibold text-white\">\r\n              Cr√©er un compte\r\n            </h2>\r\n            <p className=\"mt-2 text-sm text-white/70\">\r\n              Acc√©dez aux meilleures offres de Dakar\r\n            </p>\r\n          </div>\r\n\r\n          {/* Social Login */}\r\n          <div className=\"mb-6 space-y-3\">\r\n            <form action={handleGoogleSignIn}>\r\n              <Button\r\n                type=\"submit\"\r\n                variant=\"secondary\"\r\n                disabled={isPending}\r\n                className=\"w-full rounded-xl border border-gray-200 bg-white text-black hover:bg-gray-100\"\r\n              >\r\n                <svg\r\n                  className=\"mr-2 h-5 w-5\"\r\n                  viewBox=\"0 0 24 24\"\r\n                  fill=\"none\"\r\n                  xmlns=\"http://www.w3.org/2000/svg\"\r\n                >\r\n                  <path\r\n                    d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\"\r\n                    fill=\"#4285F4\"\r\n                  />\r\n                  <path\r\n                    d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\"\r\n                    fill=\"#34A853\"\r\n                  />\r\n                  <path\r\n                    d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\"\r\n                    fill=\"#FBBC05\"\r\n                  />\r\n                  <path\r\n                    d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\"\r\n                    fill=\"#EA4335\"\r\n                  />\r\n                </svg>\r\n                {isPending ? \"Connexion...\" : \"Continuer avec Google\"}\r\n              </Button>\r\n            </form>\r\n          </div>\r\n\r\n          {/* Separator */}\r\n          <div className=\"relative mb-6\">\r\n            <div className=\"absolute inset-0 flex items-center\">\r\n              <div className=\"w-full border-t border-white/10\"></div>\r\n            </div>\r\n            <div className=\"relative flex justify-center text-xs uppercase\">\r\n              <span className=\"bg-white/5 px-2 text-white/50\">ou</span>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Form */}\r\n          <form\r\n            action={async (formData: FormData) => {\r\n              setError(null);\r\n              setValidationErrors({});\r\n\r\n              if (!captchaToken) {\r\n                toast.error(\"Veuillez compl√©ter la v√©rification anti-robot\");\r\n                return;\r\n              }\r\n\r\n              formData.append(\"turnstileToken\", captchaToken);\r\n              formData.append(\"plan\", plan);\r\n\r\n              // Validation c√¥t√© client\r\n              const fullName = formData.get(\"fullName\") as string;\r\n              const email = formData.get(\"email\") as string;\r\n              const phone = formData.get(\"phone\") as string;\r\n              const password = formData.get(\"password\") as string;\r\n              const confirmPassword = formData.get(\"confirmPassword\") as string;\r\n\r\n              const errors: typeof validationErrors = {};\r\n\r\n              if (!fullName || fullName.trim().length < 2) {\r\n                errors.fullName = \"Le nom complet doit contenir au moins 2 caract√®res\";\r\n              }\r\n\r\n              if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\r\n                errors.email = \"Adresse email invalide\";\r\n              }\r\n\r\n              // Validation du t√©l√©phone (format international)\r\n              // On assouplit la v√©rification pour √©viter les faux positifs bloquants\r\n              if (!phone) {\r\n                errors.phone = \"Num√©ro de t√©l√©phone requis\";\r\n              } else {\r\n                // On v√©rifie juste qu'il y a assez de chiffres\r\n                const phoneDigits = phone.replace(/\\D/g, \"\");\r\n                if (phoneDigits.length < 8) {\r\n                  errors.phone = \"Num√©ro de t√©l√©phone invalide (trop court)\";\r\n                }\r\n              }\r\n\r\n              if (!password || password.length < 6) {\r\n                errors.password = \"Le mot de passe doit contenir au moins 6 caract√®res\";\r\n              }\r\n\r\n              if (password !== confirmPassword) {\r\n                errors.confirmPassword = \"Les mots de passe ne correspondent pas\";\r\n              }\r\n\r\n              if (Object.keys(errors).length > 0) {\r\n                setValidationErrors(errors);\r\n                toast.error(\"Veuillez corriger les erreurs dans le formulaire\");\r\n                return;\r\n              }\r\n\r\n              // La v√©rification HIBP se fait maintenant c√¥t√© serveur dans la Server Action signup()\r\n              // Cela √©vite les probl√®mes CORS et am√©liore la s√©curit√©\r\n\r\n              startTransition(async () => {\r\n                const result = await signup(formData);\r\n                console.log(\"üìã R√©sultat signup:\", result); // Log pour debugging\r\n                if (result?.error) {\r\n                  setError(result.error);\r\n                  console.error(\"üî¥ Erreur affich√©e √† l'utilisateur:\", result.error);\r\n                  // Afficher un toast uniquement pour les erreurs critiques (pas de duplication avec la bo√Æte d'erreur)\r\n                  // Le toast est plus visible et dispara√Æt automatiquement\r\n                  if (result.error.includes(\"Trop de tentatives\")) {\r\n                    toast.error(\"Trop de tentatives\", {\r\n                      description: \"Pour votre s√©curit√©, veuillez attendre 5 minutes avant de r√©essayer.\",\r\n                      duration: 8000,\r\n                    });\r\n                  } else if (result.error.includes(\"d√©j√† enregistr√©\")) {\r\n                    toast.error(\"Email d√©j√† utilis√©\", {\r\n                      description: result.error,\r\n                      duration: 6000,\r\n                    });\r\n                  } else {\r\n                    // Pour les autres erreurs, afficher un toast court\r\n                    toast.error(result.error, {\r\n                      duration: 5000,\r\n                    });\r\n                  }\r\n                } else if (result?.success) {\r\n                  // Si l'utilisateur est automatiquement confirm√© et connect√©\r\n                  if (result.autoConfirmed) {\r\n                    toast.success(\"Compte cr√©√© avec succ√®s !\", {\r\n                      description: \"Vous √™tes maintenant connect√©. Bienvenue !\",\r\n                      duration: 3000,\r\n                    });\r\n                    // Rediriger vers la vitrine avec le modal de bienvenue\r\n                    setTimeout(() => {\r\n                      router.push(\"/?welcome=true\");\r\n                      router.refresh();\r\n                    }, 1500);\r\n                  }\r\n                  // Si l'email de confirmation est requis\r\n                  else if (result.emailSent) {\r\n                    toast.success(\"Compte cr√©√© !\", {\r\n                      description: \"Un lien de confirmation a √©t√© envoy√© √† votre adresse email.\",\r\n                      duration: 3000,\r\n                    });\r\n                    // Rediriger vers la page de v√©rification email\r\n                    setTimeout(() => {\r\n                      router.push(`/auth/check-email?email=${encodeURIComponent(email)}`);\r\n                    }, 1500);\r\n                  }\r\n                  // Cas par d√©faut (compte cr√©√© mais pas encore confirm√©)\r\n                  else {\r\n                    toast.success(\"Compte cr√©√© avec succ√®s !\", {\r\n                      description: result.message || \"Vous pouvez maintenant vous connecter.\",\r\n                      duration: 3000,\r\n                    });\r\n                    // Rediriger vers la page de connexion\r\n                    setTimeout(() => {\r\n                      router.push(\"/login\");\r\n                    }, 2000);\r\n                  }\r\n                }\r\n              });\r\n            }}\r\n            className=\"space-y-4\"\r\n          >\r\n            {error && (\r\n              <div className=\"rounded-xl bg-red-500/10 border border-red-500/20 p-3 text-sm text-red-400\">\r\n                {error}\r\n              </div>\r\n            )}\r\n\r\n            {/* Full Name */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"fullName\" className=\"text-white/70\" required>\r\n                Nom complet\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <User className=\"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-white/40\" />\r\n                <Input\r\n                  id=\"fullName\"\r\n                  name=\"fullName\"\r\n                  type=\"text\"\r\n                  placeholder=\"Oumar Diallo\"\r\n                  required\r\n                  minLength={2}\r\n                  maxLength={100}\r\n                  className={`h-12 rounded-xl border-white/10 bg-white/5 pl-10 text-white placeholder:text-white/40 focus:border-amber-500 focus:ring-amber-500 ${validationErrors.fullName ? \"border-red-500/50\" : \"\"\r\n                    }`}\r\n                />\r\n              </div>\r\n              {validationErrors.fullName && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.fullName}</p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Email */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"email\" className=\"text-white/70\" required>\r\n                Email\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <Mail className=\"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-white/40\" />\r\n                <Input\r\n                  id=\"email\"\r\n                  name=\"email\"\r\n                  type=\"email\"\r\n                  placeholder=\"oumar@example.com\"\r\n                  required\r\n                  className={`h-12 rounded-xl border-white/10 bg-white/5 pl-10 text-white placeholder:text-white/40 focus:border-amber-500 focus:ring-amber-500 ${validationErrors.email ? \"border-red-500/50\" : \"\"\r\n                    }`}\r\n                />\r\n              </div>\r\n              {validationErrors.email && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.email}</p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Phone */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"phone\" className=\"text-white/70\" required>\r\n                T√©l√©phone\r\n              </Label>\r\n              <PhoneInput\r\n                id=\"phone\"\r\n                value={phoneValue}\r\n                onChange={(value) => {\r\n                  setPhoneValue(value);\r\n                }}\r\n                defaultCountry=\"SN\"\r\n                international\r\n                placeholder=\"Entrez votre num√©ro\"\r\n                className={`${validationErrors.phone ? \"border-red-500/50\" : \"\"\r\n                  }`}\r\n                required\r\n              />\r\n              {/* Input cach√© pour envoyer la valeur dans le FormData */}\r\n              <input\r\n                type=\"hidden\"\r\n                name=\"phone\"\r\n                value={phoneValue || \"\"}\r\n              />\r\n              {validationErrors.phone && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.phone}</p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Password */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"password\" className=\"text-white/70\" required>\r\n                Mot de passe\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <Lock className=\"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-white/40\" />\r\n                <Input\r\n                  id=\"password\"\r\n                  name=\"password\"\r\n                  type={showPassword ? \"text\" : \"password\"}\r\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                  required\r\n                  minLength={6}\r\n                  className=\"h-12 rounded-xl border-white/10 bg-white/5 pl-10 pr-10 text-white placeholder:text-white/40 focus:border-amber-500 focus:ring-amber-500\"\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowPassword(!showPassword)}\r\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white/70\"\r\n                  aria-label={\r\n                    showPassword\r\n                      ? \"Masquer le mot de passe\"\r\n                      : \"Afficher le mot de passe\"\r\n                  }\r\n                >\r\n                  {showPassword ? (\r\n                    <EyeOff className=\"h-5 w-5\" />\r\n                  ) : (\r\n                    <Eye className=\"h-5 w-5\" />\r\n                  )}\r\n                </button>\r\n              </div>\r\n              <p className=\"text-xs text-white/50\">\r\n                Minimum 6 caract√®res\r\n              </p>\r\n              {validationErrors.password && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.password}</p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Confirm Password */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"confirmPassword\" className=\"text-white/70\" required>\r\n                Confirmer le mot de passe\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <Lock className=\"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-white/40\" />\r\n                <Input\r\n                  id=\"confirmPassword\"\r\n                  name=\"confirmPassword\"\r\n                  type={showPassword ? \"text\" : \"password\"}\r\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                  required\r\n                  minLength={6}\r\n                  className=\"h-12 rounded-xl border-white/10 bg-white/5 pl-10 pr-10 text-white placeholder:text-white/40 focus:border-amber-500 focus:ring-amber-500\"\r\n                />\r\n              </div>\r\n              {validationErrors.confirmPassword && (\r\n                <p className=\"text-xs text-red-400\">{validationErrors.confirmPassword}</p>\r\n              )}\r\n            </div>\r\n\r\n            <Captcha\r\n              onVerify={(token) => {\r\n                setCaptchaToken(token);\r\n              }}\r\n              onExpire={() => {\r\n                setCaptchaToken(null);\r\n                // Le widget se r√©initialise automatiquement\r\n              }}\r\n            />\r\n\r\n            {/* Submit Button */}\r\n            <Button\r\n              type=\"submit\"\r\n              disabled={isPending || !captchaToken}\r\n              className=\"mt-6 h-12 w-full rounded-xl bg-primary text-black hover:bg-primary/90 disabled:opacity-50\"\r\n            >\r\n              {isPending ? (\r\n                <>\r\n                  <svg\r\n                    className=\"mr-2 h-5 w-5 animate-spin\"\r\n                    xmlns=\"http://www.w3.org/2000/svg\"\r\n                    fill=\"none\"\r\n                    viewBox=\"0 0 24 24\"\r\n                  >\r\n                    <circle\r\n                      className=\"opacity-25\"\r\n                      cx=\"12\"\r\n                      cy=\"12\"\r\n                      r=\"10\"\r\n                      stroke=\"currentColor\"\r\n                      strokeWidth=\"4\"\r\n                    ></circle>\r\n                    <path\r\n                      className=\"opacity-75\"\r\n                      fill=\"currentColor\"\r\n                      d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\r\n                    ></path>\r\n                  </svg>\r\n                  Inscription en cours...\r\n                </>\r\n              ) : (\r\n                \"S'inscrire\"\r\n              )}\r\n            </Button>\r\n          </form>\r\n\r\n          {/* Footer Link */}\r\n          <p className=\"mt-6 text-center text-sm text-white/70\">\r\n            D√©j√† un compte ?{\" \"}\r\n            <Link\r\n              href=\"/login\"\r\n              className=\"font-semibold text-amber-400 hover:text-amber-300 underline-offset-4 hover:underline\"\r\n            >\r\n              Se connecter\r\n            </Link>\r\n          </p>\r\n        </div>\r\n      </motion.div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\reset-password\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2355,2358],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2355,2358],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useTransition, Suspense } from \"react\";\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport { toast } from \"sonner\";\r\nimport Link from \"next/link\";\r\nimport Image from \"next/image\";\r\nimport { Mail, ArrowLeft, Loader2, CheckCircle2 } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Captcha } from \"@/components/ui/captcha\";\r\n\r\nfunction ResetPasswordRequestContent() {\r\n    const searchParams = useSearchParams();\r\n    const [isPending, startTransition] = useTransition();\r\n    const [isSent, setIsSent] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [captchaToken, setCaptchaToken] = useState<string | null>(null);\r\n\r\n    const explicitRedirect = searchParams.get(\"redirect\");\r\n\r\n    const handleSubmit = async (formData: FormData) => {\r\n        setError(null);\r\n        if (!captchaToken) {\r\n            toast.error(\"Veuillez compl√©ter la v√©rification anti-robot\");\r\n            return;\r\n        }\r\n\r\n        const email = formData.get(\"email\") as string;\r\n\r\n        startTransition(async () => {\r\n            try {\r\n                // Initialisation c√¥t√© client pour que le PKCE verifier soit bien stock√© dans le navigateur\r\n                const { createClient } = await import(\"@/utils/supabase/client\");\r\n                const supabase = createClient();\r\n                const appUrl = window.location.origin;\r\n\r\n                const nextPath = explicitRedirect\r\n                    ? `/compte/reset-password?redirect=${encodeURIComponent(explicitRedirect)}`\r\n                    : `/compte/reset-password`;\r\n\r\n                const redirectTo = `${appUrl}/auth/verify-recovery?next=${encodeURIComponent(nextPath)}`;\r\n\r\n                const { error } = await supabase.auth.resetPasswordForEmail(email.trim().toLowerCase(), {\r\n                    redirectTo,\r\n                    captchaToken: captchaToken || undefined,\r\n                });\r\n\r\n                if (error) {\r\n                    setError(error.message);\r\n                    toast.error(error.message);\r\n                } else {\r\n                    setIsSent(true);\r\n                    toast.success(\"Email envoy√© !\");\r\n                }\r\n            } catch (err: any) {\r\n                setError(err.message || \"Une erreur est survenue\");\r\n                toast.error(\"Une erreur est survenue\");\r\n            }\r\n        });\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex h-screen overflow-hidden bg-[#05080c] text-white\">\r\n            {/* C√¥t√© Gauche : Formulaire */}\r\n            <div className=\"w-full lg:w-1/2 h-full overflow-y-auto flex flex-col items-center justify-start py-12 px-4 lg:px-12 xl:px-24\">\r\n                <div className=\"absolute inset-0 overflow-hidden pointer-events-none opacity-20\">\r\n                    <div className=\"absolute -left-20 -top-20 h-[500px] w-[500px] rounded-full bg-primary/5 blur-[120px]\" />\r\n                </div>\r\n\r\n                <div className=\"relative z-10 w-full max-w-md space-y-8 my-auto\">\r\n                    <div className=\"flex justify-start\">\r\n                        <Button\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            className=\"text-white/50 hover:text-white hover:bg-white/5\"\r\n                            asChild\r\n                        >\r\n                            <Link href=\"/login\">\r\n                                <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n                                Retour √† la connexion\r\n                            </Link>\r\n                        </Button>\r\n                    </div>\r\n\r\n                    <div className=\"w-full space-y-8 relative group\">\r\n                        <div className=\"mb-10 text-center\">\r\n                            <Link href=\"/\" className=\"inline-block mb-6 lg:hidden\">\r\n                                <Image\r\n                                    src=\"/Logo.svg\"\r\n                                    alt=\"Dousell Immo\"\r\n                                    width={160}\r\n                                    height={48}\r\n                                    className=\"h-10 w-auto\"\r\n                                    priority\r\n                                />\r\n                            </Link>\r\n                            <h1 className=\"text-3xl font-bold tracking-tight text-white\">\r\n                                Mot de passe oubli√©\r\n                            </h1>\r\n                            <p className=\"mt-3 text-sm text-white/50\">\r\n                                Entrez votre email pour recevoir un lien de r√©initialisation.\r\n                            </p>\r\n                        </div>\r\n\r\n                        {isSent ? (\r\n                            <div className=\"space-y-6 text-center animate-in fade-in zoom-in-95 duration-500\">\r\n                                <div className=\"flex justify-center\">\r\n                                    <div className=\"rounded-full bg-green-500/10 p-3 ring-1 ring-green-500/20\">\r\n                                        <CheckCircle2 className=\"h-12 w-12 text-green-500\" />\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"space-y-2\">\r\n                                    <h3 className=\"text-xl font-semibold\">V√©rifiez vos emails</h3>\r\n                                    <p className=\"text-white/50 text-sm\">\r\n                                        Un lien de r√©initialisation a √©t√© envoy√© √† votre adresse email.\r\n                                        Il expirera dans quelques minutes.\r\n                                    </p>\r\n                                </div>\r\n                                <Button\r\n                                    variant=\"outline\"\r\n                                    className=\"w-full h-12 rounded-xl border-white/10 bg-white/5 text-white hover:bg-white/10\"\r\n                                    asChild\r\n                                >\r\n                                    <Link href=\"/login\">Retour √† la connexion</Link>\r\n                                </Button>\r\n                            </div>\r\n                        ) : (\r\n                            <form action={handleSubmit} className=\"space-y-6\">\r\n                                {error && (\r\n                                    <div className=\"rounded-xl bg-red-500/10 border border-red-500/20 p-4 text-sm text-red-400 animate-in fade-in slide-in-from-top-2\">\r\n                                        {error}\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div className=\"space-y-2\">\r\n                                    <Label htmlFor=\"email\" className=\"text-sm font-medium text-white/70\">\r\n                                        Email\r\n                                    </Label>\r\n                                    <div className=\"relative group\">\r\n                                        <Mail className=\"absolute left-3.5 top-1/2 h-5 w-5 -translate-y-1/2 text-white/30 transition-colors group-focus-within:text-primary\" />\r\n                                        <Input\r\n                                            id=\"email\"\r\n                                            name=\"email\"\r\n                                            type=\"email\"\r\n                                            placeholder=\"votre@email.com\"\r\n                                            required\r\n                                            className=\"h-12 w-full rounded-xl border-white/5 bg-white/[0.03] pl-11 text-white placeholder:text-white/20 focus:border-primary/50 focus:ring-primary/20 transition-all outline-none\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <Captcha\r\n                                    onVerify={(token) => setCaptchaToken(token)}\r\n                                    onExpire={() => setCaptchaToken(null)}\r\n                                />\r\n\r\n                                <Button\r\n                                    type=\"submit\"\r\n                                    disabled={isPending || !captchaToken}\r\n                                    className=\"h-12 w-full rounded-xl bg-primary text-black font-bold hover:bg-primary/90 transition-all active:scale-[0.98] shadow-lg shadow-primary/20\"\r\n                                >\r\n                                    {isPending ? (\r\n                                        <div className=\"flex items-center justify-center gap-2\">\r\n                                            <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                                            Envoi en cours...\r\n                                        </div>\r\n                                    ) : (\r\n                                        \"Envoyer le lien\"\r\n                                    )}\r\n                                </Button>\r\n                            </form>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* C√¥t√© Droit : Panel Branding */}\r\n            <div className=\"hidden lg:relative lg:flex lg:w-1/2 h-full overflow-hidden bg-[#0A0F16]\">\r\n                <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\r\n                    <div className=\"absolute -right-20 -bottom-20 h-[600px] w-[600px] rounded-full bg-accent/20 blur-[150px]\" />\r\n                    <div className=\"absolute left-1/4 top-1/4 h-[400px] w-[400px] rounded-full bg-primary/10 blur-[120px]\" />\r\n                </div>\r\n\r\n                <div className=\"relative z-10 flex flex-col items-center justify-center w-full px-12 text-center\">\r\n                    <div className=\"mb-12 p-5 rounded-[2.5rem] bg-white/5 backdrop-blur-3xl border border-white/10 shadow-2xl animate-in zoom-in-95 duration-700\">\r\n                        <Image\r\n                            src=\"/Logo.svg\"\r\n                            alt=\"Dousell Immo\"\r\n                            width={240}\r\n                            height={72}\r\n                            className=\"h-20 w-auto\"\r\n                            priority\r\n                        />\r\n                    </div>\r\n\r\n                    <h2 className=\"text-5xl font-extrabold tracking-tight text-white mb-8 leading-tight\">\r\n                        S√©curisez votre <span className=\"text-primary\">acc√®s</span> <br />\r\n                        en toute <span className=\"italic font-serif text-accent\">simplicit√©.</span>\r\n                    </h2>\r\n\r\n                    <p className=\"text-xl text-white/50 max-w-lg mb-16 leading-relaxed\">\r\n                        La protection de vos donn√©es est notre priorit√©. R√©initialisez votre mot de passe en quelques secondes.\r\n                    </p>\r\n                </div>\r\n                <div className=\"absolute inset-x-0 bottom-0 top-0 bg-gradient-to-t from-black/60 via-transparent to-transparent pointer-events-none\" />\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction ResetPasswordFallback() {\r\n    return (\r\n        <div className=\"flex min-h-screen flex-col items-center justify-center bg-[#05080c]\">\r\n            <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default function ResetPasswordRequestPage() {\r\n    return (\r\n        <Suspense fallback={<ResetPasswordFallback />}>\r\n            <ResetPasswordRequestContent />\r\n        </Suspense>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\syndic\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\template.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\vente\\[city]\\[type]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\vente\\[city]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[978,981],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[978,981],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Metadata } from \"next\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { getProperties, getActiveCities } from \"@/services/propertyService\";\r\nimport { getSimilarListings } from \"@/services/gatewayService\";\r\nimport { slugify, unslugify } from \"@/lib/slugs\";\r\nimport ProgrammaticPageTemplate from \"@/components/seo/ProgrammaticPageTemplate\";\r\n\r\n// ISR: Update every hour\r\nexport const revalidate = 3600;\r\nexport const dynamicParams = true;\r\n\r\ninterface PageProps {\r\n    params: Promise<{\r\n        city: string;\r\n    }>;\r\n}\r\n\r\nconst capitalize = (text: string) =>\r\n    text.charAt(0).toUpperCase() + text.slice(1);\r\n\r\n// 1. Generate Static Params (Sales ONLY)\r\nexport async function generateStaticParams() {\r\n    const { data: combinations, error } = await supabase\r\n        .rpc('get_active_cities_and_types', { min_count: 1, target_transaction_type: 'vente' });\r\n\r\n    if (error || !combinations) return [];\r\n\r\n    const uniqueCities = new Set(combinations.map((c: any) => slugify(c.city)));\r\n    return Array.from(uniqueCities).map((city) => ({\r\n        city: city,\r\n    }));\r\n}\r\n\r\n// 2. Metadata Generator\r\nexport async function generateMetadata({ params }: PageProps): Promise<Metadata> {\r\n    const { city } = await params;\r\n    const displayCity = capitalize(unslugify(city));\r\n\r\n    return {\r\n        title: `Immobilier √† vendre √† ${displayCity} : Toutes les annonces`,\r\n        description: `Trouvez votre bien immobilier √† acheter √† ${displayCity}. Appartements, villas et terrains √† vendre avec Doussel Immo.`,\r\n    };\r\n}\r\n\r\n// 3. Page Component\r\nexport default async function SaleCityPage({ params }: PageProps) {\r\n    const { city } = await params;\r\n    const searchCity = unslugify(city);\r\n\r\n    const properties = await getProperties({\r\n        citySlug: city,\r\n        category: 'vente', // Strict Filter\r\n        status: \"disponible\",\r\n        limit: 50,\r\n    });\r\n\r\n    const displayCity = capitalize(searchCity);\r\n\r\n    // Determines the correct city name to search for\r\n    const cityName = properties.length > 0 ? properties[0].location.city : displayCity;\r\n\r\n    const similarProperties = await getSimilarListings({\r\n        transactionType: 'vente',\r\n        city: cityName,\r\n        excludeIds: properties.map(p => p.id),\r\n        limit: 6\r\n    });\r\n\r\n    const activeCities = await getActiveCities();\r\n\r\n    return (\r\n        <ProgrammaticPageTemplate\r\n            mode=\"vente\"\r\n            city={city}\r\n            displayCity={displayCity}\r\n            properties={properties}\r\n            similarProperties={similarProperties}\r\n            nearbyCities={activeCities}\r\n        />\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(vitrine)\\vente\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\components\\ThemedComponents.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2066,2069],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2066,2069],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useTheme } from \"@/components/theme-provider\";\nimport { ReactNode } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\n/**\n * Wrapper pour une page compl√®te - applique les couleurs de texte\n */\nexport function ThemedPage({ children, className = \"\" }: { children: ReactNode; className?: string }) {\n    const { isDark } = useTheme();\n\n    return (\n        <div className={cn(\n            \"space-y-6\",\n            isDark ? 'text-white' : 'text-gray-900',\n            className\n        )}>\n            {children}\n        </div>\n    );\n}\n\n/**\n * Card avec background et bordures adapt√©s au th√®me\n */\nexport function ThemedCard({\n    children,\n    className = \"\",\n    hover = false\n}: {\n    children: ReactNode;\n    className?: string;\n    hover?: boolean;\n}) {\n    const { isDark } = useTheme();\n\n    return (\n        <div className={cn(\n            \"border rounded-xl\",\n            isDark\n                ? 'bg-slate-900 border-slate-800'\n                : 'bg-white border-gray-200',\n            hover && (isDark ? 'hover:bg-slate-800' : 'hover:bg-gray-50'),\n            \"transition-colors\",\n            className\n        )}>\n            {children}\n        </div>\n    );\n}\n\n/**\n * Texte avec variantes de couleur selon le th√®me\n */\nexport function ThemedText({\n    children,\n    variant = \"primary\",\n    className = \"\",\n    as: Component = \"span\"\n}: {\n    children: ReactNode;\n    variant?: \"primary\" | \"secondary\" | \"muted\";\n    className?: string;\n    as?: \"span\" | \"p\" | \"h1\" | \"h2\" | \"h3\" | \"h4\" | \"div\";\n}) {\n    const { isDark } = useTheme();\n\n    const colorClasses = {\n        primary: isDark ? 'text-white' : 'text-gray-900',\n        secondary: isDark ? 'text-white/80' : 'text-gray-700',\n        muted: isDark ? 'text-white/60' : 'text-gray-500'\n    };\n\n    return (\n        <Component className={cn(colorClasses[variant], className)}>\n            {children}\n        </Component>\n    );\n}\n\n/**\n * Empty State avec th√®me adapt√©\n */\nexport function ThemedEmptyState({\n    icon: Icon,\n    title,\n    description,\n    action\n}: {\n    icon: any;\n    title: string;\n    description: string;\n    action?: ReactNode;\n}) {\n    const { isDark } = useTheme();\n\n    return (\n        <ThemedCard className=\"p-12 text-center\">\n            <div className={cn(\n                \"w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4\",\n                isDark ? 'bg-slate-800' : 'bg-gray-100'\n            )}>\n                <Icon className={cn(\n                    \"w-8 h-8\",\n                    isDark ? 'text-slate-600' : 'text-gray-400'\n                )} />\n            </div>\n            <ThemedText as=\"h3\" variant=\"primary\" className=\"text-lg font-medium mb-2\">\n                {title}\n            </ThemedText>\n            <ThemedText as=\"p\" variant=\"muted\" className=\"text-sm max-w-md mx-auto mb-6\">\n                {description}\n            </ThemedText>\n            {action}\n        </ThemedCard>\n    );\n}\n\n/**\n * Badge avec couleur de fond adapt√©e au th√®me\n */\nexport function ThemedBadge({\n    children,\n    variant = \"default\",\n    className = \"\"\n}: {\n    children: ReactNode;\n    variant?: \"default\" | \"success\" | \"warning\" | \"danger\";\n    className?: string;\n}) {\n    const { isDark } = useTheme();\n\n    const variantClasses = {\n        default: isDark\n            ? 'bg-slate-500/20 text-slate-300'\n            : 'bg-gray-200 text-gray-700',\n        success: isDark\n            ? 'bg-emerald-500/20 text-emerald-300'\n            : 'bg-emerald-100 text-emerald-700',\n        warning: isDark\n            ? 'bg-amber-500/20 text-amber-300'\n            : 'bg-amber-100 text-amber-700',\n        danger: isDark\n            ? 'bg-red-500/20 text-red-300'\n            : 'bg-red-100 text-red-700'\n    };\n\n    return (\n        <span className={cn(\n            \"inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium\",\n            variantClasses[variant],\n            className\n        )}>\n            {children}\n        </span>\n    );\n}\n\n/**\n * Header de section avec titre et action\n */\nexport function ThemedSectionHeader({\n    title,\n    subtitle,\n    action\n}: {\n    title: string;\n    subtitle?: string;\n    action?: ReactNode;\n}) {\n    return (\n        <div className=\"flex items-center justify-between\">\n            <div>\n                <ThemedText as=\"h1\" variant=\"primary\" className=\"text-2xl font-semibold\">\n                    {title}\n                </ThemedText>\n                {subtitle && (\n                    <ThemedText as=\"p\" variant=\"muted\" className=\"text-sm mt-1\">\n                        {subtitle}\n                    </ThemedText>\n                )}\n            </div>\n            {action && <div className=\"flex gap-2\">{action}</div>}\n        </div>\n    );\n}\n\n/**\n * Alert/Message box avec th√®me adapt√©\n */\nexport function ThemedAlert({\n    children,\n    variant = \"info\",\n    className = \"\"\n}: {\n    children: ReactNode;\n    variant?: \"info\" | \"success\" | \"warning\" | \"error\";\n    className?: string;\n}) {\n    const { isDark } = useTheme();\n\n    const variantClasses = {\n        info: isDark\n            ? 'bg-blue-500/10 border-blue-500/30 text-blue-300'\n            : 'bg-blue-50 border-blue-200 text-blue-700',\n        success: isDark\n            ? 'bg-green-500/10 border-green-500/30 text-green-300'\n            : 'bg-green-50 border-green-200 text-green-700',\n        warning: isDark\n            ? 'bg-amber-500/10 border-amber-500/30 text-amber-300'\n            : 'bg-amber-50 border-amber-200 text-amber-700',\n        error: isDark\n            ? 'bg-red-500/10 border-red-500/30 text-red-300'\n            : 'bg-red-50 border-red-200 text-red-700'\n    };\n\n    return (\n        <div className={cn(\n            \"border rounded-xl p-4\",\n            variantClasses[variant],\n            className\n        )}>\n            {children}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\documents-legaux\\LegalPageClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1001,1004],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1001,1004],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { AlertTriangle, CheckCircle, FileText, Clock, BookOpen } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { format } from \"date-fns\";\nimport { fr } from \"date-fns/locale\";\nimport { DecisionModal } from \"./components/DecisionModal\";\nimport { CreateContractDialog } from \"./components/CreateContractDialog\";\nimport { CreateReceiptDialog } from \"./components/CreateReceiptDialog\";\nimport { useTheme } from \"@/components/theme-provider\";\nimport type { LeaseAlert } from \"./actions\";\n\ninterface Lease {\n    id: string;\n    tenant_name: string;\n    tenant_email?: string;\n    tenant_phone?: string;\n    property_address: string;\n    monthly_amount: number;\n    lease_pdf_url?: string | null;\n}\n\ninterface LegalPageClientProps {\n    stats: {\n        activeLeases: number;\n        upcomingRenewals: number;\n        legalRisks: number;\n    };\n    alerts: LeaseAlert[];\n    leases: Lease[];\n    userEmail?: string;\n    profile: any;\n}\n\nexport function LegalPageClient({ stats, alerts, leases, userEmail, profile }: LegalPageClientProps) {\n    const { isDark } = useTheme();\n\n    return (\n        <div className={`min-h-screen ${isDark ? 'bg-slate-950' : 'bg-gray-50'}`}>\n            <div className=\"w-full mx-auto px-4 md:px-6 py-8 space-y-8 animate-in fade-in duration-500\">\n\n                {/* SECTION 1 : EN-T√äTE */}\n                <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\n                    <div>\n                        <h1 className={`text-3xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                            Assistant Juridique\n                        </h1>\n                        <p className={`mt-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            Conformit√© Loi 2014 &amp; COCC S√©n√©gal üá∏üá≥\n                        </p>\n                    </div>\n                </div>\n\n                {/* SECTION 2 : LES KPI */}\n                <div id=\"tour-legal-kpi\" className=\"grid gap-4 md:grid-cols-3\">\n                    <Card className={isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}>\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                            <CardTitle className={`text-sm font-medium ${isDark ? 'text-slate-200' : 'text-gray-700'}`}>\n                                Baux Actifs\n                            </CardTitle>\n                            <FileText className=\"h-4 w-4 text-blue-500\" />\n                        </CardHeader>\n                        <CardContent>\n                            <div className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                {stats.activeLeases}\n                            </div>\n                            <p className={`text-xs ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                Tous enregistr√©s\n                            </p>\n                        </CardContent>\n                    </Card>\n\n                    <Card className={`relative overflow-hidden ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                        {stats.upcomingRenewals > 0 && (\n                            <div className=\"absolute top-0 right-0 w-1 h-full bg-orange-500\" />\n                        )}\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                            <CardTitle className={`text-sm font-medium ${isDark ? 'text-slate-200' : 'text-gray-700'}`}>\n                                Renouvellements (3 mois)\n                            </CardTitle>\n                            <Clock className=\"h-4 w-4 text-orange-500\" />\n                        </CardHeader>\n                        <CardContent>\n                            <div className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                {stats.upcomingRenewals}\n                            </div>\n                            <p className=\"text-xs text-orange-400\">\n                                {stats.upcomingRenewals > 0 ? 'Tacite reconduction approche' : 'Aucune √©ch√©ance proche'}\n                            </p>\n                        </CardContent>\n                    </Card>\n\n                    <Card className={isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}>\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                            <CardTitle className={`text-sm font-medium ${isDark ? 'text-slate-200' : 'text-gray-700'}`}>\n                                Risque Juridique\n                            </CardTitle>\n                            <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n                        </CardHeader>\n                        <CardContent>\n                            <div className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                {stats.legalRisks}\n                            </div>\n                            <p className={`text-xs ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                Aucun contentieux en cours\n                            </p>\n                        </CardContent>\n                    </Card>\n                </div>\n\n                {/* SECTION 3 : LE RADAR DES √âCH√âANCES */}\n                <div id=\"tour-legal-alerts\" className=\"space-y-4\">\n                    <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                        Radar des √âch√©ances\n                    </h2>\n                    <div className={`rounded-lg border overflow-hidden ${isDark ? 'border-slate-800 bg-black/50' : 'border-gray-200 bg-white'\n                        }`}>\n                        {alerts.length > 0 ? (\n                            <div className=\"overflow-x-auto\">\n                                <table className=\"w-full text-sm text-left min-w-[600px]\">\n                                    <thead className={`font-medium border-b ${isDark\n                                        ? 'bg-slate-900/50 text-slate-400 border-slate-800'\n                                        : 'bg-gray-50 text-gray-600 border-gray-200'\n                                        }`}>\n                                        <tr>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Locataire & Bien</th>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">√âch√©ance</th>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Type d&apos;alerte</th>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Statut</th>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 text-right whitespace-nowrap\">Action</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody className={`divide-y ${isDark ? 'divide-slate-800' : 'divide-gray-200'}`}>\n                                        {alerts.map((alert) => (\n                                            <tr\n                                                key={alert.id}\n                                                className={`transition-colors group ${isDark ? 'hover:bg-slate-900/50' : 'hover:bg-gray-50'\n                                                    }`}\n                                            >\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\n                                                    <div className={`font-medium whitespace-nowrap ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                                        {alert.tenant_name}\n                                                    </div>\n                                                    <div className={`text-xs max-w-[150px] md:max-w-none truncate ${isDark ? 'text-slate-500' : 'text-gray-500'\n                                                        }`}>\n                                                        {alert.property_address}\n                                                    </div>\n                                                </td>\n                                                <td className={`px-4 md:px-6 py-3 md:py-4 whitespace-nowrap ${isDark ? 'text-slate-300' : 'text-gray-700'\n                                                    }`}>\n                                                    {format(new Date(alert.end_date), 'dd MMM yyyy', { locale: fr })}\n                                                </td>\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\n                                                    <div className=\"flex items-center gap-2\">\n                                                        <span className={`w-2 h-2 rounded-full flex-shrink-0 ${alert.alert_type === 'J-180'\n                                                            ? 'bg-orange-500'\n                                                            : 'bg-blue-500'\n                                                            }`} />\n                                                        <span className={`text-xs md:text-sm whitespace-nowrap ${isDark ? 'text-slate-300' : 'text-gray-700'\n                                                            }`}>\n                                                            {alert.alert_type === 'J-180' ? 'Cong√© (6 mois)' : 'Reconduction (3 mois)'}\n                                                        </span>\n                                                    </div>\n                                                </td>\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\n                                                    <div className={`flex items-center gap-2 text-xs md:text-sm whitespace-nowrap ${isDark ? 'text-slate-400' : 'text-gray-600'\n                                                        }`}>\n                                                        <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${alert.status === 'sent' ? 'bg-green-500' : 'bg-amber-500'\n                                                            }`} />\n                                                        {alert.status === 'sent' ? 'Envoy√©' : 'En attente'}\n                                                    </div>\n                                                </td>\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4 text-right\">\n                                                    <DecisionModal alert={alert} />\n                                                </td>\n                                            </tr>\n                                        ))}\n                                    </tbody>\n                                </table>\n                            </div>\n                        ) : (\n                            <div className=\"px-6 py-12 text-center\">\n                                <CheckCircle className=\"w-12 h-12 text-green-500 mx-auto mb-3\" />\n                                <p className={`font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>\n                                    Aucune √©ch√©ance dans les 6 prochains mois\n                                </p>\n                                <p className={`text-sm mt-1 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                    Tous vos baux sont √† jour\n                                </p>\n                            </div>\n                        )}\n                    </div>\n                </div>\n\n                {/* SECTION 4 : G√âN√âRATEUR RAPIDE */}\n                <div id=\"tour-legal-tools\" className=\"grid gap-6 md:grid-cols-2\">\n                    <CreateReceiptDialog leases={leases} userEmail={userEmail} profile={profile} />\n                    <CreateContractDialog leases={leases} />\n                </div>\n\n                {/* R√©f√©rence juridique */}\n                <div id=\"tour-legal-reference\" className={`p-6 rounded-lg border ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'\n                    }`}>\n                    <h2 className={`text-lg font-semibold mb-4 flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'\n                        }`}>\n                        <BookOpen className=\"w-5 h-5 text-green-500\" />\n                        Cadre Juridique de R√©f√©rence\n                    </h2>\n                    <div className=\"grid gap-4 md:grid-cols-2\">\n                        <div>\n                            <h3 className={`text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>\n                                Textes applicables :\n                            </h3>\n                            <ul className={`space-y-1 text-sm ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                                <li>‚Ä¢ COCC (Code des Obligations Civiles et Commerciales)</li>\n                                <li>‚Ä¢ D√©cret de 2014 sur la baisse des loyers</li>\n                                <li>‚Ä¢ Loi de r√©gulation 2024</li>\n                                <li>‚Ä¢ Droit OHADA (usage commercial)</li>\n                            </ul>\n                        </div>\n                        <div>\n                            <h3 className={`text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>\n                                D√©lais cl√©s :\n                            </h3>\n                            <ul className={`space-y-1 text-sm ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                                <li>‚Ä¢ <span className=\"text-red-500 font-semibold\">6 mois</span> : Pr√©avis propri√©taire (cong√© pour reprise)</li>\n                                <li>‚Ä¢ <span className=\"text-yellow-500 font-semibold\">3 mois</span> : N√©gociation avant tacite reconduction</li>\n                                <li>‚Ä¢ <span className=\"text-blue-500 font-semibold\">2 mois</span> : Pr√©avis locataire (r√©sidentiel)</li>\n                                <li>‚Ä¢ <span className=\"text-purple-500 font-semibold\">1 mois</span> : Pr√©avis locataire (meubl√©)</li>\n                            </ul>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\documents-legaux\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\documents-legaux\\components\\CreateContractDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\documents-legaux\\components\\CreateReceiptDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[938,941],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[938,941],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { FileText, _CheckCircle, _Search } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogHeader,\n    DialogTitle,\n    DialogTrigger,\n} from '@/components/ui/dialog';\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\";\nimport { ReceiptModal } from '@/app/(workspace)/gestion/components/ReceiptModal';\nimport { _cn } from '@/lib/utils';\nimport { _createClient } from '@/utils/supabase/client';\nimport { useTheme } from \"@/components/theme-provider\";\n\ninterface Lease {\n    id: string;\n    tenant_name: string;\n    tenant_email?: string;\n    tenant_phone?: string;\n    property_address: string;\n    monthly_amount: number;\n}\n\ninterface CreateReceiptDialogProps {\n    leases: Lease[];\n    userEmail?: string;\n    profile?: any;\n}\n\nexport function CreateReceiptDialog({ leases, userEmail, profile }: CreateReceiptDialogProps) {\n    const { isDark } = useTheme();\n    const [isOpen, setIsOpen] = useState(false);\n    const [selectedLeaseId, setSelectedLeaseId] = useState<string>('');\n    const [month, setMonth] = useState<string>(new Date().getMonth() + 1 + '');\n    const [year, setYear] = useState<string>(new Date().getFullYear() + '');\n    const [amount, setAmount] = useState<string>('');\n\n    // State for the preview modal\n    const [showPreview, setShowPreview] = useState(false);\n\n    const selectedLease = leases.find(l => l.id === selectedLeaseId);\n\n    const handleLeaseChange = (leaseId: string) => {\n        const lease = leases.find(l => l.id === leaseId);\n        setSelectedLeaseId(leaseId);\n        if (lease) {\n            setAmount(lease.monthly_amount.toString());\n        }\n    };\n\n    const handleGenerate = () => {\n        if (!selectedLease || !amount) return;\n        setShowPreview(true);\n    };\n\n    const periodMonth = parseInt(month).toString().padStart(2, '0');\n\n    // Construct data for ReceiptModal\n    const receiptData = selectedLease ? {\n        leaseId: selectedLease.id,\n        tenant: {\n            tenant_name: selectedLease.tenant_name,\n            email: selectedLease.tenant_email,\n            phone: selectedLease.tenant_phone,\n            address: selectedLease.property_address\n        },\n        property_address: selectedLease.property_address,\n        amount: parseInt(amount),\n        month: periodMonth,\n        year: parseInt(year),\n        userEmail: userEmail,\n        profile: profile\n    } : null;\n\n    return (\n        <>\n            <Dialog open={isOpen} onOpenChange={setIsOpen}>\n                <DialogTrigger asChild>\n                    <button className={`w-full text-left p-6 rounded-xl border transition-all group outline-none focus:ring-2 focus:ring-blue-500/50 cursor-pointer ${isDark\n                        ? 'border-slate-800 bg-gradient-to-br from-slate-900 to-black hover:border-slate-700'\n                        : 'border-gray-200 bg-white hover:border-gray-300 hover:shadow-sm'\n                        }`}>\n                        <div className={`h-10 w-10 rounded-lg flex items-center justify-center mb-4 transition-colors ${isDark ? 'bg-slate-800 group-hover:bg-slate-700' : 'bg-gray-100 group-hover:bg-gray-200'\n                            }`}>\n                            <FileText className={`h-5 w-5 ${isDark ? 'text-white' : 'text-gray-700'}`} />\n                        </div>\n                        <h3 className={`text-lg font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>G√©n√©rer une Quittance</h3>\n                        <p className={`text-sm mt-2 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>Cr√©er manuellement une quittance pour un paiement hors plateforme.</p>\n                    </button>\n                </DialogTrigger>\n                <DialogContent className={`sm:max-w-md ${isDark ? 'bg-slate-900 border-slate-800 text-slate-100' : 'bg-white border-gray-200 text-gray-900'}`}>\n                    <DialogHeader>\n                        <DialogTitle className={`flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                            <FileText className=\"h-5 w-5 text-blue-500\" />\n                            G√©n√©rateur de Quittance\n                        </DialogTitle>\n                        <DialogDescription className={isDark ? 'text-slate-400' : 'text-gray-600'}>\n                            Cr√©ez une quittance pour un locataire existant.\n                        </DialogDescription>\n                    </DialogHeader>\n\n                    <div className=\"space-y-4 py-4\">\n                        <div className=\"space-y-2\">\n                            <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Locataire & Bien</label>\n                            <Select value={selectedLeaseId} onValueChange={handleLeaseChange}>\n                                <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                    <SelectValue placeholder=\"S√©lectionner un bail...\" />\n                                </SelectTrigger>\n                                <SelectContent className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-white border-gray-200 text-gray-900'}>\n                                    {leases.length === 0 ? (\n                                        <div className={`py-6 text-center text-sm ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                            Aucun bail actif trouv√©\n                                        </div>\n                                    ) : (\n                                        leases.map((lease) => (\n                                            <SelectItem key={lease.id} value={lease.id} className={isDark ? 'focus:bg-slate-700 focus:text-slate-100' : 'focus:bg-gray-100 focus:text-gray-900'}>\n                                                <span className=\"font-medium\">{lease.tenant_name}</span>\n                                            </SelectItem>\n                                        ))\n                                    )}\n                                </SelectContent>\n                            </Select>\n                            {selectedLease && (\n                                <p className={`text-xs ml-1 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                    {selectedLease.property_address}\n                                </p>\n                            )}\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"space-y-2\">\n                                <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Mois</label>\n                                <Select value={month} onValueChange={setMonth}>\n                                    <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                        <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-white border-gray-200 text-gray-900'}>\n                                        {Array.from({ length: 12 }, (_, i) => i + 1).map((m) => (\n                                            <SelectItem key={m} value={m.toString()}>\n                                                {new Date(0, m - 1).toLocaleString('fr-FR', { month: 'long' })}\n                                            </SelectItem>\n                                        ))}\n                                    </SelectContent>\n                                </Select>\n                            </div>\n                            <div className=\"space-y-2\">\n                                <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Ann√©e</label>\n                                <Select value={year} onValueChange={setYear}>\n                                    <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                        <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-white border-gray-200 text-gray-900'}>\n                                        {[year, (parseInt(year) - 1).toString(), (parseInt(year) + 1).toString()].sort().map((y) => (\n                                            <SelectItem key={y} value={y}>{y}</SelectItem>\n                                        ))}\n                                    </SelectContent>\n                                </Select>\n                            </div>\n                        </div>\n\n                        <div className=\"space-y-2\">\n                            <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Montant (FCFA)</label>\n                            <input\n                                type=\"number\"\n                                value={amount}\n                                onChange={(e) => setAmount(e.target.value)}\n                                className={`w-full border rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 outline-none ${isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-gray-50 border-gray-300 text-gray-900'\n                                    }`}\n                            />\n                        </div>\n\n                        <div className=\"pt-2\">\n                            <Button\n                                onClick={handleGenerate}\n                                disabled={!selectedLease || !amount}\n                                className=\"w-full bg-blue-600 hover:bg-blue-700 text-white\"\n                            >\n                                Pr√©visualiser la Quittance\n                            </Button>\n                        </div>\n                    </div>\n                </DialogContent>\n            </Dialog>\n\n            {receiptData && (\n                <ReceiptModal\n                    isOpen={showPreview}\n                    onClose={() => setShowPreview(false)}\n                    data={receiptData}\n                />\n            )}\n        </>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\documents-legaux\\components\\DecisionModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\documents-legaux\\components\\GenerateNoticeButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\documents-legaux\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\[id]\\pdf\\PDFPreview.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1130,1133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1130,1133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3592,3595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3592,3595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3618,3621],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3618,3621],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":154,"column":29,"nodeType":"JSXOpeningElement","endLine":158,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":232,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9850,9853],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9850,9853],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":253,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":253,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11382,11385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11382,11385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":311,"column":37,"nodeType":"JSXOpeningElement","endLine":311,"endColumn":142},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":322,"column":37,"nodeType":"JSXOpeningElement","endLine":322,"endColumn":145},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":338,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":338,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16802,16805],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16802,16805],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":339,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16865,16868],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16865,16868],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":343,"column":49,"nodeType":"JSXOpeningElement","endLine":347,"endColumn":51}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { ArrowLeft, Loader2, Printer, Check } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { toast } from 'sonner';\nimport { getInventoryReportById, getAgencyBranding } from '../../actions';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\nimport { useTheme } from \"@/components/theme-provider\";\n\ninterface PDFPageProps {\n    reportId: string;\n}\n\n// ... (CONDITION_MAP can be kept inside or outside, assuming it was outside in previous version)\nconst CONDITION_MAP: Record<string, { short: string; label: string }> = {\n    'bon': { short: 'TB', label: 'Tr√®s Bon' },\n    'moyen': { short: 'B', label: 'Bon' },\n    'mauvais': { short: 'M', label: 'Moyen' },\n    'absent': { short: 'D', label: 'D√©grad√©/Absent' },\n};\n\nexport function PDFPreview({ reportId }: PDFPageProps) {\n    const { isDark } = useTheme();\n    const router = useRouter();\n    const [_loading, setLoading] = useState(true);\n    const [report, setReport] = useState<any>(null);\n    const [agencyBranding, setAgencyBranding] = useState<{ name: string | null, logo: string | null } | null>(null);\n    const printRef = useRef<HTMLDivElement>(null);\n\n    useEffect(() => {\n        const loadData = async () => {\n            const [reportResult, brandingResult] = await Promise.all([\n                getInventoryReportById(reportId),\n                getAgencyBranding()\n            ]);\n\n            if (reportResult.error) {\n                toast.error(reportResult.error);\n                router.push('/etats-lieux');\n                return;\n            }\n\n            if (reportResult.data?.status !== 'signed') {\n                toast.error('Le rapport doit √™tre sign√© avant de g√©n√©rer le PDF');\n                router.push(`/etats-lieux/${reportId}/sign`);\n                return;\n            }\n\n            if (brandingResult && !('error' in brandingResult)) {\n                setAgencyBranding({\n                    name: brandingResult.agency_name,\n                    logo: brandingResult.logo_url\n                });\n            }\n\n            setReport(reportResult.data);\n            setLoading(false);\n        };\n\n        loadData();\n    }, [reportId, router]);\n\n    const handlePrint = () => {\n        window.print();\n    };\n\n    const getCityFromAddress = (address: string | undefined) => {\n        if (!address) return null;\n        // Try comma split first (Standard format: Address, City)\n        if (address.includes(',')) {\n            const part = address.split(',').pop()?.trim();\n            if (part && part.length > 2) return part;\n        }\n\n        // Contextual Fallbacks for Senegal\n        const lower = address.toLowerCase();\n        if (lower.includes('dakar')) return 'Dakar';\n        if (lower.includes('saly')) return 'Saly';\n        if (lower.includes('thies') || lower.includes('thi√®s')) return 'Thi√®s';\n        if (lower.includes('saint-louis')) return 'Saint-Louis';\n        if (lower.includes('mbour')) return 'Mbour';\n\n        return null;\n    };\n\n    if (!report) {\n        return (\n            <div className=\"flex items-center justify-center min-h-[50vh]\">\n                <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\n            </div>\n        );\n    }\n\n    const reportDate = report?.report_date ? new Date(report.report_date) : new Date();\n    const _signedDate = report?.signed_at ? new Date(report.signed_at) : new Date();\n\n    const hasPhotos = report?.rooms?.some((r: any) => r.items?.some((i: any) => i.photos?.length > 0));\n\n    return (\n        <div className={`min-h-screen p-6 print:p-0 print:bg-white ${isDark ? 'bg-slate-950' : 'bg-gray-100'}`}>\n            <style jsx global>{`\n                @media print {\n                    body * {\n                        visibility: hidden;\n                    }\n                    #printable-content, #printable-content * {\n                        visibility: visible;\n                    }\n                    #printable-content {\n                        position: absolute;\n                        left: 0;\n                        top: 0;\n                        width: 100% !important;\n                        max-width: 100% !important;\n                        box-sizing: border-box !important;\n                        margin: 0 !important;\n                        padding: 15mm !important; /* Standard A4 Matrix */\n                    }\n                    /* Ensure images are printed */\n                    img {\n                        -webkit-print-color-adjust: exact;\n                        print-color-adjust: exact;\n                    }\n                }\n            `}</style>\n\n            {/* Header Actions - Hidden on print */}\n            <div className=\"max-w-4xl mx-auto mb-6 flex justify-between items-center print:hidden\">\n                <Link href=\"/etats-lieux\" className={`flex items-center gap-2 transition-colors ${isDark ? 'text-slate-400 hover:text-white' : 'text-gray-500 hover:text-gray-900'}`}>\n                    <ArrowLeft className=\"w-4 h-4\" /> Retour\n                </Link>\n                <Button onClick={handlePrint} className=\"bg-[#F4C430] hover:bg-[#D4A420] text-black\">\n                    <Printer className=\"w-4 h-4 mr-2\" />\n                    Imprimer / Enregistrer PDF\n                </Button>\n            </div>\n\n            {/* A4 Page Preview */}\n            <div\n                id=\"printable-content\"\n                ref={printRef}\n                className=\"bg-white text-black rounded-xl p-8 print:p-6 print:rounded-none max-w-4xl mx-auto print:max-w-none text-sm shadow-2xl print:shadow-none\"\n                style={{ fontFamily: 'Arial, sans-serif' }}\n            >\n                {/* Agency Header - Realigned Right */}\n                <div className=\"hidden print:flex justify-between items-start border-b border-black pb-4 mb-4\">\n                    {/* Logo (Left) */}\n                    <div className=\"w-1/3\">\n                        {agencyBranding?.logo && (\n                            <img\n                                src={agencyBranding.logo}\n                                alt=\"Logo Agence\"\n                                className=\"h-16 w-auto object-contain object-left\"\n                            />\n                        )}\n                    </div>\n\n                    {/* Agency Name & Type (Right) */}\n                    <div className=\"w-2/3 text-right\">\n                        <p className=\"font-bold text-xl uppercase tracking-tight\">\n                            {agencyBranding?.name || 'DOUSSEL IMMO'}\n                        </p>\n                        <p className=\"text-xs text-gray-600 mb-2\">\n                            Gestion Locative & Immobili√®re\n                        </p>\n                        <div className=\"inline-block border border-gray-400 px-3 py-1 mt-1\">\n                            <p className=\"font-bold text-sm uppercase\">\n                                {report?.type === 'entry' ? \"√âtat des Lieux d&apos;Entr√©e\" : \"√âtat des Lieux de Sortie\"}\n                            </p>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Document Subtitle (Replaces old Title Header) */}\n                <div className=\"bg-gray-100 text-center py-2 mb-6 border-y border-gray-300\">\n                    <h2 className=\"font-bold uppercase tracking-wide text-xs\">\n                        Constat contradictoire de l&apos;√©tat du logement\n                    </h2>\n                </div>\n\n                {/* Property Description */}\n                <p className=\"font-semibold mb-4 text-sm\">\n                    {report?.type === 'entry' ? \"ENTR√âE\" : \"SORTIE\"} du locataire pour le logement sis √† :<br />\n                    <span className=\"font-normal\">{report?.lease?.property_address}</span>\n                </p>\n\n                {/* Date and Info Row */}\n                <div className=\"mb-6 space-y-2\">\n                    <p>\n                        <strong>Date du constat :</strong>{' '}\n                        <span className=\"border-b border-black inline-block min-w-[200px]\">\n                            {format(reportDate, 'd MMMM yyyy', { locale: fr })}\n                        </span>\n                    </p>\n\n                    <p>\n                        <strong>Locataire :</strong>{' '}\n                        <span className=\"border-b border-black inline-block min-w-[200px]\">\n                            {report?.lease?.tenant_name}\n                        </span>\n                    </p>\n                </div>\n\n                {/* Meter Readings */}\n                <div className=\"mb-6 flex flex-wrap gap-x-8 gap-y-2\">\n                    <p>\n                        <strong>Relev√© compteur √©lectricit√© :</strong>{' '}\n                        <span className=\"border-b border-black inline-block min-w-[80px] text-center\">\n                            {report?.meter_readings?.electricity || '______'}\n                        </span>{' '}\n                        kWh\n                    </p>\n                    <p>\n                        <strong>Relev√© compteur eau :</strong>{' '}\n                        <span className=\"border-b border-black inline-block min-w-[80px] text-center\">\n                            {report?.meter_readings?.water || '______'}\n                        </span>{' '}\n                        m¬≥\n                    </p>\n                </div>\n\n                {/* Legend */}\n                <div className=\"mb-4 text-xs bg-gray-50 p-2 rounded\">\n                    <strong>L√©gende :</strong> TB = Tr√®s Bon | B = Bon | M = Moyen | D = D√©grad√©/Absent\n                </div>\n\n                {/* Rooms Tables */}\n                {report?.rooms?.map((room: any, roomIndex: number) => (\n                    <div key={roomIndex} className=\"mb-6 break-inside-avoid\">\n                        <h3 className=\"font-bold bg-gray-100 border border-gray-300 px-3 py-2 uppercase text-sm\">\n                            {room.name}\n                        </h3>\n                        <table className=\"w-full border-collapse border border-gray-300\">\n                            <thead>\n                                <tr className=\"bg-gray-50\">\n                                    <th className=\"border border-gray-300 px-2 py-1 text-left font-medium w-1/3\">\n                                        √âl√©ment\n                                    </th>\n                                    <th className=\"border border-gray-300 px-1 py-1 text-center font-medium w-8\">TB</th>\n                                    <th className=\"border border-gray-300 px-1 py-1 text-center font-medium w-8\">B</th>\n                                    <th className=\"border border-gray-300 px-1 py-1 text-center font-medium w-8\">M</th>\n                                    <th className=\"border border-gray-300 px-1 py-1 text-center font-medium w-8\">D</th>\n                                    <th className=\"border border-gray-300 px-2 py-1 text-left font-medium\">\n                                        Commentaires\n                                    </th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                {room.items?.map((item: any, itemIndex: number) => {\n                                    const conditionData = CONDITION_MAP[item.condition] || { short: '' };\n                                    return (\n                                        <tr key={itemIndex}>\n                                            <td className=\"border border-gray-300 px-2 py-1\">{item.name}</td>\n                                            <td className=\"border border-gray-300 px-1 py-1 text-center\">\n                                                {conditionData.short === 'TB' ? '‚úì' : ''}\n                                            </td>\n                                            <td className=\"border border-gray-300 px-1 py-1 text-center\">\n                                                {conditionData.short === 'B' ? '‚úì' : ''}\n                                            </td>\n                                            <td className=\"border border-gray-300 px-1 py-1 text-center\">\n                                                {conditionData.short === 'M' ? '‚úì' : ''}\n                                            </td>\n                                            <td className=\"border border-gray-300 px-1 py-1 text-center\">\n                                                {conditionData.short === 'D' ? '‚úì' : ''}\n                                            </td>\n                                            <td className=\"border border-gray-300 px-2 py-1 text-xs text-gray-600\">\n                                                {item.comment || ''}\n                                            </td>\n                                        </tr>\n                                    );\n                                })}\n                            </tbody>\n                        </table>\n                    </div>\n                ))}\n\n                {/* Commentaires Contradictoires */}\n                <div className=\"mb-6\">\n                    <h3 className=\"font-bold uppercase mb-2\">Commentaires Contradictoires :</h3>\n                    <div className=\"border border-gray-300 min-h-[60px] p-2 text-sm\">\n                        {report?.general_comments || ''}\n                    </div>\n                </div>\n\n                {/* Signatures Section - Atomic Block to prevent splitting */}\n                <div className=\"mt-8 pt-4 break-inside-avoid bg-white\">\n                    <div className=\"flex justify-between items-end mb-8\">\n                        <div>\n                            <p className=\"mb-4 font-bold\">\n                                Clefs remises au nombre de : <span className=\"border-b border-black inline-block w-16\"></span>\n                            </p>\n                            <p className=\"font-bold\">\n                                Fait √† : <span className=\"border-b border-black inline-block w-32 px-2 text-center\">{getCityFromAddress(report?.lease?.property_address) || '....................'}</span>\n                                , le {format(new Date(), 'd MMMM yyyy', { locale: fr })}\n                            </p>\n                        </div>\n                    </div>\n\n                    <div className=\"border-t border-black my-4\"></div>\n\n                    <div className=\"grid grid-cols-2 gap-16 mt-8\">\n                        <div className=\"text-center\">\n                            <p className=\"font-bold mb-4\">Le Bailleur (ou son mandataire)</p>\n                            <div className=\"h-32 border border-gray-200 rounded flex flex-col items-center justify-center bg-gray-50 relative\">\n                                <p className=\"text-[10px] text-gray-400 absolute top-2\">Lu et approuv√©</p>\n                                {report?.owner_signature ? (\n                                    <img src={report.owner_signature} alt=\"Signature Proprio\" className=\"h-full w-auto object-contain p-2\" />\n                                ) : (\n                                    <p className=\"text-xs text-gray-400 italic mt-4\">(En attente)</p>\n                                )}\n                            </div>\n                        </div>\n                        <div className=\"text-center\">\n                            <p className=\"font-bold mb-4\">Le(s) Locataire(s)</p>\n                            <div className=\"h-32 border border-gray-200 rounded flex flex-col items-center justify-center bg-gray-50 relative\">\n                                <p className=\"text-[10px] text-gray-400 absolute top-2\">Lu et approuv√©</p>\n                                {report?.tenant_signature ? (\n                                    <img src={report.tenant_signature} alt=\"Signature Locataire\" className=\"h-full w-auto object-contain p-2\" />\n                                ) : (\n                                    <p className=\"text-xs text-gray-400 italic mt-4\">(En attente)</p>\n                                )}\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Photo Appendix */}\n                {hasPhotos && (\n                    <div className=\"break-before-page mt-8\">\n                        <h2 className=\"text-sm font-bold uppercase border-b border-black pb-2 mb-4\">\n                            Annexe : Photos de l&apos;√âtat des Lieux\n                        </h2>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                            {report?.rooms?.map((room: any) =>\n                                room.items?.map((item: any) =>\n                                    item.photos?.map((photoUrl: string, index: number) => (\n                                        <div key={`${room.name}-${item.name}-${index}`} className=\"border border-gray-200 p-2 break-inside-avoid bg-white\">\n                                            <div className=\"aspect-video w-full bg-gray-50 mb-2 overflow-hidden flex items-center justify-center rounded\">\n                                                <img\n                                                    src={photoUrl}\n                                                    alt={`${item.name} - ${room.name}`}\n                                                    className=\"w-full h-full object-contain\"\n                                                />\n                                            </div>\n                                            <div className=\"px-1\">\n                                                <p className=\"text-xs font-bold truncate\">{room.name} - {item.name}</p>\n                                                <p className=\"text-[10px] text-gray-500\">Photo n¬∞{index + 1}</p>\n                                            </div>\n                                        </div>\n                                    ))\n                                )\n                            )}\n                        </div>\n                    </div>\n                )}\n\n                {/* Footer */}\n                <div className=\"mt-8 pt-4 border-t border-gray-200 flex justify-between text-xs text-gray-400\">\n                    <span>Document g√©n√©r√© par {agencyBranding?.name || 'Doussel Immo'}</span>\n                    <span>R√©f: {report?.id?.slice(0, 8)}</span>\n                </div>\n            </div>\n\n            {/* Success Banner - Hidden on print */}\n            <div className=\"bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 flex items-center gap-3 print:hidden\">\n                <Check className=\"w-5 h-5 text-emerald-400\" />\n                <p className={`text-sm ${isDark ? 'text-emerald-300' : 'text-emerald-600'}`}>\n                    √âtat des lieux sign√©. Cliquez sur &quot;Imprimer&quot; puis &quot;Enregistrer en PDF&quot; pour t√©l√©charger.\n                </p>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\[id]\\pdf\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\[id]\\sign\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\components\\DeleteInventoryButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\components\\EtatsLieuxContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":103,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":106,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[640,643],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[640,643],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1029,1032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1029,1032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Link from 'next/link';\nimport { Plus, FileText, CheckCircle, Clock, Edit, ArrowLeft, Printer } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\nimport { DeleteInventoryButton } from './DeleteInventoryButton';\nimport {\n    ThemedPage,\n    ThemedCard,\n    ThemedText,\n    ThemedEmptyState,\n    ThemedBadge,\n    ThemedAlert\n} from '../../components/ThemedComponents';\nimport { useTheme } from \"@/components/theme-provider\";\n\nconst statusConfig: Record<string, { label: string; variant: \"default\" | \"warning\" | \"success\"; icon: any }> = {\n    'draft': { label: 'Brouillon', variant: 'default', icon: Edit },\n    'completed': { label: 'Compl√©t√©', variant: 'warning', icon: Clock },\n    'signed': { label: 'Sign√©', variant: 'success', icon: CheckCircle },\n};\n\nconst typeLabels: Record<string, string> = {\n    'entry': 'Entr√©e',\n    'exit': 'Sortie',\n};\n\nexport function EtatsLieuxContent({ reports, error }: { reports: any[]; error: string | null }) {\n    const { isDark } = useTheme();\n\n    return (\n        <ThemedPage>\n            {/* Header */}\n            <div className=\"flex items-center justify-between gap-2\">\n                <div className=\"flex items-center gap-2 sm:gap-3 min-w-0\">\n                    <Link\n                        href=\"/gestion-locative\"\n                        className={`transition-colors shrink-0 ${isDark\n                            ? 'text-white/60 hover:text-white'\n                            : 'text-gray-500 hover:text-gray-900'\n                            }`}\n                    >\n                        <ArrowLeft className=\"w-5 h-5\" />\n                    </Link>\n                    <div className=\"min-w-0\">\n                        <ThemedText as=\"h1\" variant=\"primary\" className=\"text-lg sm:text-2xl font-semibold truncate\">\n                            √âtats des Lieux\n                        </ThemedText>\n                        <ThemedText as=\"p\" variant=\"muted\" className=\"text-sm\">\n                            {reports.length} rapport{reports.length !== 1 ? 's' : ''}\n                        </ThemedText>\n                    </div>\n                </div>\n                <div className=\"flex gap-1.5 sm:gap-2 shrink-0\">\n                    <div id=\"tour-edl-pdf\">\n                        <Button\n                            asChild\n                            size=\"sm\"\n                            variant=\"outline\"\n                            className={isDark\n                                ? 'border-slate-700 text-slate-300 hover:bg-slate-800 px-2 sm:px-3'\n                                : 'border-gray-300 text-gray-700 hover:bg-gray-100 px-2 sm:px-3'\n                            }\n                        >\n                            <Link href=\"/etats-lieux/formulaire-vierge\">\n                                <Printer className=\"w-4 h-4 sm:mr-2\" />\n                                <span className=\"hidden sm:inline\">PDF Vierge</span>\n                            </Link>\n                        </Button>\n                    </div>\n                    <div id=\"tour-edl-new\">\n                        <Button asChild size=\"sm\" className={`px-2 sm:px-3 ${isDark ? \"bg-[#F4C430] hover:bg-[#D4A420] text-black\" : \"bg-slate-900 hover:bg-slate-800 text-white\"}`}>\n                            <Link href=\"/etats-lieux/new\">\n                                <Plus className=\"w-4 h-4 sm:mr-2\" />\n                                <span className=\"hidden sm:inline\">Nouveau</span>\n                            </Link>\n                        </Button>\n                    </div>\n                </div>\n            </div>\n\n            {/* List */}\n            <div id=\"tour-edl-list\">\n                {error ? (\n                    <ThemedAlert variant=\"error\">\n                        Erreur: {error}\n                    </ThemedAlert>\n                ) : reports.length === 0 ? (\n                    <ThemedEmptyState\n                        icon={FileText}\n                        title=\"Aucun √©tat des lieux\"\n                        description=\"Cr√©ez votre premier √©tat des lieux pour documenter l'√©tat du bien √† l'entr√©e ou √† la sortie du locataire.\"\n                        action={\n                            <Button asChild className={isDark ? \"bg-[#F4C430] hover:bg-[#D4A420] text-black\" : \"bg-slate-900 hover:bg-slate-800 text-white\"}>\n                                <Link href=\"/etats-lieux/new\">\n                                    <Plus className=\"w-4 h-4 mr-2\" />\n                                    Cr√©er un √©tat des lieux\n                                </Link>\n                            </Button>\n                        }\n                    />\n                ) : (\n                    <div className=\"grid gap-3\">\n                        {reports.map((report, _index) => {\n                            const status = statusConfig[report.status] || statusConfig['draft'];\n                            const StatusIcon = status.icon;\n\n                            return (\n                                <ThemedCard\n                                    key={report.id}\n                                    hover\n                                    className=\"p-4 flex items-start justify-between gap-4 group\"\n                                >\n                                    <Link\n                                        href={`/etats-lieux/${report.id}`}\n                                        className=\"flex-1 min-w-0 flex items-start justify-between gap-4\"\n                                    >\n                                        <div className=\"flex-1 min-w-0\">\n                                            <div className=\"flex items-center gap-2 mb-1\">\n                                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${report.type === 'entry'\n                                                    ? isDark\n                                                        ? 'bg-blue-500/20 text-blue-300'\n                                                        : 'bg-blue-100 text-blue-700'\n                                                    : isDark\n                                                        ? 'bg-orange-500/20 text-orange-300'\n                                                        : 'bg-slate-100 text-slate-700'\n                                                    }`}>\n                                                    {typeLabels[report.type]}\n                                                </span>\n                                                <ThemedBadge variant={status.variant}>\n                                                    <StatusIcon className=\"w-3 h-3\" />\n                                                    {status.label}\n                                                </ThemedBadge>\n                                            </div>\n\n                                            <ThemedText as=\"h3\" variant=\"primary\" className=\"font-medium truncate\">\n                                                {report.lease?.property_address || 'Adresse non renseign√©e'}\n                                            </ThemedText>\n                                            <ThemedText as=\"p\" variant=\"muted\" className=\"text-sm\">\n                                                {report.lease?.tenant_name || 'Locataire'}\n                                            </ThemedText>\n                                        </div>\n\n                                        <div className=\"text-right text-xs\">\n                                            <ThemedText variant=\"muted\">\n                                                {format(new Date(report.report_date), 'd MMM yyyy', { locale: fr })}\n                                            </ThemedText>\n                                            {report.signed_at && (\n                                                <p className={`mt-1 ${isDark ? 'text-emerald-400' : 'text-emerald-600'\n                                                    }`}>\n                                                    Sign√© le {format(new Date(report.signed_at), 'd MMM', { locale: fr })}\n                                                </p>\n                                            )}\n                                        </div>\n                                    </Link>\n\n                                    <div className={`pl-2 border-l self-stretch flex items-center ${isDark ? 'border-slate-800' : 'border-gray-200'\n                                        }`}>\n                                        <DeleteInventoryButton id={report.id} />\n                                    </div>\n                                </ThemedCard>\n                            );\n                        })}\n                    </div>\n                )}\n            </div>\n        </ThemedPage>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\components\\InventoryEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1515,1518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1515,1518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":43,"column":8,"nodeType":"ArrayExpression","endLine":43,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport, reportId]","fix":{"range":[2009,2019],"text":"[loadReport, reportId]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":392,"column":57,"nodeType":"JSXOpeningElement","endLine":396,"endColumn":59}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { ArrowLeft, Save, Check, ChevronDown, ChevronUp, Camera, Trash2, Plus, Loader2, Zap, Droplets, Flame, Pen } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { toast } from 'sonner';\nimport { getInventoryReportById, updateInventoryReport, uploadInventoryPhoto } from '../actions';\nimport { type Room, type RoomItem, type MeterReadings } from '../types';\nimport { useTheme } from \"@/components/theme-provider\";\n\nconst CONDITION_OPTIONS = [\n    { value: 'bon', label: 'Bon', color: 'bg-emerald-500/20 text-emerald-400 border-emerald-500' },\n    { value: 'moyen', label: 'Moyen', color: 'bg-amber-500/20 text-amber-400 border-amber-500' },\n    { value: 'mauvais', label: 'Mauvais', color: 'bg-red-500/20 text-red-400 border-red-500' },\n    { value: 'absent', label: 'Absent', color: 'bg-slate-500/20 text-slate-400 border-slate-500' },\n];\n\ninterface InventoryEditorProps {\n    reportId: string;\n}\n\nexport function InventoryEditor({ reportId }: InventoryEditorProps) {\n    const { isDark } = useTheme();\n    const router = useRouter();\n    const [loading, setLoading] = useState(true);\n    const [saving, setSaving] = useState(false);\n    const [uploadingPhoto, setUploadingPhoto] = useState(false);\n    const [report, setReport] = useState<any>(null);\n    const fileInputRef = useRef<HTMLInputElement>(null);\n    const [uploadTarget, setUploadTarget] = useState<{ roomIndex: number, itemIndex: number } | null>(null);\n\n    const [rooms, setRooms] = useState<Room[]>([]);\n    const [meterReadings, setMeterReadings] = useState<MeterReadings>({});\n    const [generalComments, setGeneralComments] = useState('');\n    const [expandedRoom, setExpandedRoom] = useState<number | null>(0);\n\n    useEffect(() => {\n        loadReport();\n    }, [reportId]);\n\n    const loadReport = async () => {\n        const result = await getInventoryReportById(reportId);\n        if (result.error) {\n            toast.error(result.error);\n            router.push('/etats-lieux');\n            return;\n        }\n\n        setReport(result.data);\n        setRooms(result.data?.rooms || []);\n        setMeterReadings(result.data?.meter_readings || {});\n        setGeneralComments(result.data?.general_comments || '');\n        setLoading(false);\n    };\n\n    const handleSave = async (markComplete = false) => {\n        setSaving(true);\n\n        const result = await updateInventoryReport(reportId, {\n            rooms,\n            meter_readings: meterReadings,\n            general_comments: generalComments,\n            status: markComplete ? 'completed' : 'draft'\n        });\n\n        if (result.error) {\n            toast.error(result.error);\n        } else {\n            toast.success(markComplete ? '√âtat des lieux compl√©t√© !' : 'Enregistr√©');\n            if (markComplete) {\n                router.push('/etats-lieux');\n            }\n        }\n\n        setSaving(false);\n    };\n\n    const handlePhotoClick = (roomIndex: number, itemIndex: number) => {\n        setUploadTarget({ roomIndex, itemIndex });\n        fileInputRef.current?.click();\n    };\n\n    const handlePhotoFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\n        const file = e.target.files?.[0];\n        if (!file || !uploadTarget) return;\n\n        setUploadingPhoto(true);\n        const { roomIndex, itemIndex } = uploadTarget;\n\n        try {\n            const formData = new FormData();\n            formData.append('file', file);\n\n            const result = await uploadInventoryPhoto(file, reportId);\n\n            if (result.error || !result.url) {\n                toast.error(result.error || \"Erreur upload\");\n            } else {\n                const newRooms = [...rooms];\n                const currentPhotos = newRooms[roomIndex].items[itemIndex].photos || [];\n                newRooms[roomIndex].items[itemIndex].photos = [...currentPhotos, result.url];\n                setRooms(newRooms);\n                toast.success(\"Photo ajout√©e\");\n            }\n        } catch (error) {\n            console.error(error);\n            toast.error(\"Erreur technique lors de l'upload\");\n        } finally {\n            setUploadingPhoto(false);\n            setUploadTarget(null);\n            if (fileInputRef.current) fileInputRef.current.value = '';\n        }\n    };\n\n    const removePhoto = (roomIndex: number, itemIndex: number, photoIndex: number) => {\n        const newRooms = [...rooms];\n        const photos = [...(newRooms[roomIndex].items[itemIndex].photos || [])];\n        photos.splice(photoIndex, 1);\n        newRooms[roomIndex].items[itemIndex].photos = photos;\n        setRooms(newRooms);\n    };\n\n    const updateItemCondition = (roomIndex: number, itemIndex: number, condition: string) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].items[itemIndex].condition = condition as RoomItem['condition'];\n        setRooms(newRooms);\n    };\n\n    const updateItemComment = (roomIndex: number, itemIndex: number, comment: string) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].items[itemIndex].comment = comment;\n        setRooms(newRooms);\n    };\n\n    const addRoom = () => {\n        const newRoom: Room = {\n            name: `Pi√®ce ${rooms.length + 1}`,\n            items: [\n                { name: 'Sol', condition: '', comment: '', photos: [] },\n                { name: 'Murs', condition: '', comment: '', photos: [] },\n                { name: 'Plafond', condition: '', comment: '', photos: [] },\n            ]\n        };\n        setRooms([...rooms, newRoom]);\n        setExpandedRoom(rooms.length);\n    };\n\n    const removeRoom = (roomIndex: number) => {\n        const newRooms = rooms.filter((_, i) => i !== roomIndex);\n        setRooms(newRooms);\n        setExpandedRoom(null);\n    };\n\n    const addItemToRoom = (roomIndex: number) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].items.push({\n            name: 'Nouvel √©l√©ment',\n            condition: '',\n            comment: '',\n            photos: []\n        });\n        setRooms(newRooms);\n    };\n\n    const updateRoomName = (roomIndex: number, name: string) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].name = name;\n        setRooms(newRooms);\n    };\n\n    const updateItemName = (roomIndex: number, itemIndex: number, name: string) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].items[itemIndex].name = name;\n        setRooms(newRooms);\n    };\n\n    if (loading) {\n        return (\n            <div className=\"flex items-center justify-center min-h-[50vh]\">\n                <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\n            </div>\n        );\n    }\n\n    const completedItems = rooms.reduce((acc, room) =>\n        acc + room.items.filter(item => item.condition).length, 0\n    );\n    const totalItems = rooms.reduce((acc, room) => acc + room.items.length, 0);\n    const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;\n\n    return (\n        <div className=\"space-y-6 pb-24\">\n            {/* Header */}\n            <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                    <Link href=\"/etats-lieux\" className={`transition-colors ${isDark ? 'text-white/60 hover:text-white' : 'text-gray-500 hover:text-gray-900'}`}>\n                        <ArrowLeft className=\"w-5 h-5\" />\n                    </Link>\n                    <div>\n                        <h1 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                            √âtat des lieux {report?.type === 'entry' ? \"d&apos;entr√©e\" : 'de sortie'}\n                        </h1>\n                        <p className={`text-sm ${isDark ? 'text-white/60' : 'text-gray-600'}`}>\n                            {report?.lease?.property_address} ‚Ä¢ {report?.lease?.tenant_name}\n                        </p>\n                    </div>\n                </div>\n            </div>\n\n            {/* On-site Instructions */}\n            <div className=\"bg-blue-500/10 border border-blue-500/30 rounded-xl p-4\">\n                <p className=\"text-sm text-blue-400 font-medium mb-1\">\n                    üìã Mode Contradictoire Recommand√©\n                </p>\n                <p className=\"text-xs text-blue-300/80\">\n                    Ce constat doit √™tre rempli <strong>sur place</strong> avec le locataire pr√©sent.\n                    Visitez chaque pi√®ce ensemble et convenez de l&apos;√©tat avant de noter.\n                </p>\n            </div>\n\n            {/* Progress Bar */}\n            <div className={`border rounded-xl p-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <div className=\"flex items-center justify-between mb-2\">\n                    <span className={`text-sm ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>Progression</span>\n                    <span className={`text-sm font-medium ${isDark ? 'text-[#F4C430]' : 'text-slate-900'}`}>{progress}%</span>\n                </div>\n                <div className={`h-2 rounded-full overflow-hidden ${isDark ? 'bg-slate-800' : 'bg-gray-200'}`}>\n                    <div\n                        className={`h-full transition-all duration-300 ${isDark ? 'bg-[#F4C430]' : 'bg-slate-900'}`}\n                        style={{ width: `${progress}%` }}\n                    />\n                </div>\n                <p className={`text-xs mt-2 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>{completedItems}/{totalItems} √©l√©ments √©valu√©s</p>\n            </div>\n\n            {/* Meter Readings */}\n            <div className={`border rounded-xl p-4 space-y-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <h2 className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>Relev√©s de compteurs</h2>\n                <div className=\"grid grid-cols-3 gap-3\">\n                    <div>\n                        <label className={`flex items-center gap-1 text-xs mb-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            <Zap className=\"w-3 h-3\" /> √âlectricit√©\n                        </label>\n                        <Input\n                            type=\"number\"\n                            value={meterReadings.electricity || ''}\n                            onChange={(e) => setMeterReadings({ ...meterReadings, electricity: parseInt(e.target.value) || undefined })}\n                            placeholder=\"kWh\"\n                            className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-300 shadow-sm text-gray-900'}\n                        />\n                    </div>\n                    <div>\n                        <label className={`flex items-center gap-1 text-xs mb-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            <Droplets className=\"w-3 h-3\" /> Eau\n                        </label>\n                        <Input\n                            type=\"number\"\n                            value={meterReadings.water || ''}\n                            onChange={(e) => setMeterReadings({ ...meterReadings, water: parseInt(e.target.value) || undefined })}\n                            placeholder=\"m¬≥\"\n                            className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-300 shadow-sm text-gray-900'}\n                        />\n                    </div>\n                    <div>\n                        <label className={`flex items-center gap-1 text-xs mb-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            <Flame className=\"w-3 h-3\" /> Gaz\n                        </label>\n                        <Input\n                            type=\"number\"\n                            value={meterReadings.gas || ''}\n                            onChange={(e) => setMeterReadings({ ...meterReadings, gas: parseInt(e.target.value) || undefined })}\n                            placeholder=\"m¬≥\"\n                            className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-300 shadow-sm text-gray-900'}\n                        />\n                    </div>\n                </div>\n            </div>\n\n            {/* Rooms */}\n            <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                    <h2 className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>Pi√®ces</h2>\n                    <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={addRoom}\n                        className={isDark ? \"text-[#F4C430] hover:text-[#F4C430]\" : \"text-slate-900 hover:text-slate-700\"}\n                    >\n                        <Plus className=\"w-4 h-4 mr-1\" /> Ajouter\n                    </Button>\n                </div>\n\n                {rooms.map((room, roomIndex) => (\n                    <div key={roomIndex} className={`border rounded-xl overflow-hidden ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                        {/* Room Header */}\n                        <button\n                            onClick={() => setExpandedRoom(expandedRoom === roomIndex ? null : roomIndex)}\n                            className=\"w-full flex items-center justify-between p-4 text-left\"\n                        >\n                            <div className=\"flex items-center gap-3\">\n                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-medium ${isDark ? 'bg-[#F4C430]/20 text-[#F4C430]' : 'bg-slate-100 text-slate-900'}`}>\n                                    {roomIndex + 1}\n                                </div>\n                                <div>\n                                    <p className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>{room.name}</p>\n                                    <p className={`text-xs ${isDark ? 'text-slate-400' : 'text-gray-500'}`}>\n                                        {room.items.filter(i => i.condition).length}/{room.items.length} √©l√©ments\n                                    </p>\n                                </div>\n                            </div>\n                            {expandedRoom === roomIndex ? (\n                                <ChevronUp className={`w-5 h-5 ${isDark ? 'text-slate-400' : 'text-gray-400'}`} />\n                            ) : (\n                                <ChevronDown className={`w-5 h-5 ${isDark ? 'text-slate-400' : 'text-gray-400'}`} />\n                            )}\n                        </button>\n\n                        {/* Room Content */}\n                        {expandedRoom === roomIndex && (\n                            <div className={`border-t p-4 space-y-4 ${isDark ? 'border-slate-800' : 'border-gray-200'}`}>\n                                {/* Room Name Edit */}\n                                <div className=\"flex items-center gap-2\">\n                                    <Input\n                                        value={room.name}\n                                        onChange={(e) => updateRoomName(roomIndex, e.target.value)}\n                                        className={`text-sm ${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-400 shadow-sm text-gray-900'}`}\n                                        placeholder=\"Nom de la pi√®ce\"\n                                    />\n                                    <Button\n                                        variant=\"ghost\"\n                                        size=\"sm\"\n                                        onClick={() => removeRoom(roomIndex)}\n                                        className=\"text-red-400 hover:text-red-300\"\n                                    >\n                                        <Trash2 className=\"w-4 h-4\" />\n                                    </Button>\n                                </div>\n\n                                {/* Items */}\n                                {room.items.map((item, itemIndex) => (\n                                    <div key={itemIndex} className={`rounded-lg p-3 space-y-2 ${isDark ? 'bg-slate-800/50' : 'bg-gray-50 border border-gray-200'}`}>\n                                        <Input\n                                            value={item.name}\n                                            onChange={(e) => updateItemName(roomIndex, itemIndex, e.target.value)}\n                                            className={`border-none p-0 font-medium text-sm h-auto focus-visible:ring-0 ${isDark ? 'bg-transparent text-white' : 'bg-transparent text-gray-900'}`}\n                                        />\n\n                                        {/* Condition Buttons */}\n                                        <div className=\"flex gap-1 items-center\">\n                                            {CONDITION_OPTIONS.map((option) => (\n                                                <button\n                                                    key={option.value}\n                                                    onClick={() => updateItemCondition(roomIndex, itemIndex, option.value)}\n                                                    className={`px-2 py-1 rounded text-xs font-medium border transition-all ${item.condition === option.value\n                                                        ? option.color\n                                                        : isDark\n                                                            ? 'bg-slate-700/50 text-slate-400 border-slate-600 hover:border-slate-500'\n                                                            : 'bg-gray-200 text-gray-600 border-gray-300 hover:border-gray-400'\n                                                        }`}\n                                                >\n                                                    {option.label}\n                                                </button>\n                                            ))}\n                                            <button\n                                                onClick={() => handlePhotoClick(roomIndex, itemIndex)}\n                                                disabled={uploadingPhoto}\n                                                className={`ml-1 p-1.5 rounded transition-all border ${(item.photos?.length || 0) > 0\n                                                    ? 'bg-blue-500/20 text-blue-400 border-blue-500'\n                                                    : isDark\n                                                        ? 'bg-slate-700/50 text-slate-400 border-slate-600 hover:text-white'\n                                                        : 'bg-gray-200 text-gray-500 border-gray-300 hover:text-gray-700'\n                                                    }`}\n                                                title=\"Ajouter une photo\"\n                                            >\n                                                {uploadingPhoto && uploadTarget?.roomIndex === roomIndex && uploadTarget?.itemIndex === itemIndex ? (\n                                                    <Loader2 className=\"w-3.5 h-3.5 animate-spin\" />\n                                                ) : (\n                                                    <Camera className=\"w-3.5 h-3.5\" />\n                                                )}\n                                            </button>\n                                        </div>\n\n                                        {/* Photos Preview */}\n                                        {item.photos && item.photos.length > 0 && (\n                                            <div className=\"flex gap-2 overflow-x-auto py-1\">\n                                                {item.photos.map((photo, pIndex) => (\n                                                    <div key={pIndex} className=\"relative group shrink-0\">\n                                                        <img\n                                                            src={photo}\n                                                            alt=\"√âtat\"\n                                                            className=\"h-12 w-12 object-cover rounded border border-slate-600\"\n                                                        />\n                                                        <button\n                                                            onClick={() => removePhoto(roomIndex, itemIndex, pIndex)}\n                                                            className=\"absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                                        >\n                                                            <Trash2 className=\"w-2 h-2\" />\n                                                        </button>\n                                                    </div>\n                                                ))}\n                                            </div>\n                                        )}\n\n                                        {/* Comment */}\n                                        <Input\n                                            value={item.comment}\n                                            onChange={(e) => updateItemComment(roomIndex, itemIndex, e.target.value)}\n                                            placeholder=\"Commentaire (optionnel)\"\n                                            className={`text-xs h-8 ${isDark ? 'bg-slate-700/50 border-slate-600 text-white' : 'bg-white border-gray-400 shadow-sm text-gray-900'}`}\n                                        />\n                                    </div>\n                                ))}\n\n                                {/* Add Item */}\n                                <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => addItemToRoom(roomIndex)}\n                                    className={`w-full border border-dashed ${isDark ? 'text-slate-400 hover:text-white border-slate-700' : 'text-gray-500 hover:text-gray-700 border-gray-300'}`}\n                                >\n                                    <Plus className=\"w-4 h-4 mr-1\" /> Ajouter un √©l√©ment\n                                </Button>\n                            </div>\n                        )}\n                    </div>\n                ))}\n            </div>\n\n            {/* General Comments */}\n            <div className={`border rounded-xl p-4 space-y-3 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <h2 className={`font-medium flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                    <Pen className={`w-4 h-4 ${isDark ? 'text-[#F4C430]' : 'text-slate-900'}`} />\n                    Observations g√©n√©rales\n                </h2>\n                <Textarea\n                    value={generalComments}\n                    onChange={(e) => setGeneralComments(e.target.value)}\n                    placeholder=\"Remarques g√©n√©rales sur l'√©tat du logement...\"\n                    className={`min-h-[100px] ${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-400 shadow-sm text-gray-900'}`}\n                />\n            </div>\n\n            {/* Fixed Bottom Bar */}\n            <div className=\"fixed bottom-0 left-0 right-0 p-4 transform transition-all bg-transparent\">\n                <div className=\"max-w-3xl mx-auto flex gap-3\">\n                    <Button\n                        variant=\"outline\"\n                        onClick={() => handleSave(false)}\n                        disabled={saving}\n                        className={isDark ? 'flex-1 border-slate-700 bg-slate-800 hover:bg-slate-700 text-white' : 'flex-1 border-gray-400 bg-white shadow-sm hover:bg-gray-50 text-gray-900'}\n                    >\n                        {saving ? <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> : <Save className=\"w-4 h-4 mr-2\" />}\n                        Enregistrer\n                    </Button>\n\n                    {report?.status === 'completed' || report?.status === 'signed' ? (\n                        <Button\n                            asChild\n                            className={`flex-1 ${isDark ? 'bg-[#F4C430] hover:bg-[#D4A420] text-black' : 'bg-slate-900 text-white hover:bg-slate-800'}`}\n                        >\n                            <Link href={`/etats-lieux/${reportId}/sign`}>\n                                <Check className=\"w-4 h-4 mr-2\" />\n                                Signatures\n                            </Link>\n                        </Button>\n                    ) : (\n                        <Button\n                            onClick={() => handleSave(true)}\n                            disabled={saving || progress < 100}\n                            className={`flex-1 ${isDark ? 'bg-[#F4C430] hover:bg-[#D4A420] text-black' : 'bg-slate-900 text-white hover:bg-slate-800'}`}\n                        >\n                            <Check className=\"w-4 h-4 mr-2\" />\n                            {progress < 100 ? `Terminer (${progress}%)` : 'Terminer'}\n                        </Button>\n                    )}\n                </div>\n            </div>\n\n            <input\n                type=\"file\"\n                ref={fileInputRef}\n                className=\"hidden\"\n                accept=\"image/*\"\n                onChange={handlePhotoFileChange}\n            />\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\components\\SignatureCanvas.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\components\\SignaturePage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[849,852],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[849,852],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { ArrowLeft, FileText, Loader2, Check, Download, UserCheck } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { toast } from 'sonner';\nimport { getInventoryReportById, signInventoryReport, getOwnerSignature } from '../actions';\nimport { SignatureCanvas } from '../components/SignatureCanvas';\nimport { useTheme } from \"@/components/theme-provider\";\n\ninterface SignaturePageProps {\n    reportId: string;\n}\n\nexport function SignaturePage({ reportId }: SignaturePageProps) {\n    const { isDark } = useTheme();\n    const router = useRouter();\n    const [loading, setLoading] = useState(true);\n    const [saving, setSaving] = useState(false);\n    const [report, setReport] = useState<any>(null);\n    const [savedOwnerSignature, setSavedOwnerSignature] = useState<string | null>(null);\n\n    const [ownerSignature, setOwnerSignature] = useState('');\n    const [tenantSignature, setTenantSignature] = useState('');\n\n    useEffect(() => {\n        const loadReport = async () => {\n            // Fetch report and owner's saved signature in parallel\n            const [reportResult, signatureResult] = await Promise.all([\n                getInventoryReportById(reportId),\n                getOwnerSignature()\n            ]);\n\n            if (reportResult.error) {\n                toast.error(reportResult.error);\n                router.push('/etats-lieux');\n                return;\n            }\n\n            setReport(reportResult.data);\n\n            // If report already has signatures, use them\n            if (reportResult.data?.owner_signature) {\n                setOwnerSignature(reportResult.data.owner_signature);\n            } else if (signatureResult.signature_url) {\n                // Otherwise use saved signature from profile\n                setOwnerSignature(signatureResult.signature_url);\n                setSavedOwnerSignature(signatureResult.signature_url);\n            }\n\n            setTenantSignature(reportResult.data?.tenant_signature || '');\n            setLoading(false);\n        };\n\n        loadReport();\n    }, [reportId, router]);\n\n    const handleSign = async () => {\n        if (!ownerSignature || !tenantSignature) {\n            toast.error('Les deux signatures sont requises');\n            return;\n        }\n\n        setSaving(true);\n\n        const result = await signInventoryReport(reportId, {\n            owner_signature: ownerSignature,\n            tenant_signature: tenantSignature\n        });\n\n        if (result.error) {\n            toast.error(result.error);\n        } else {\n            toast.success('√âtat des lieux sign√© !');\n            router.push(`/etats-lieux/${reportId}/pdf`);\n        }\n\n        setSaving(false);\n    };\n\n    if (loading) {\n        return (\n            <div className=\"flex items-center justify-center min-h-[50vh]\">\n                <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\n            </div>\n        );\n    }\n\n    const isAlreadySigned = report?.status === 'signed';\n\n    return (\n        <div className=\"space-y-6 pb-8\">\n            {/* Header */}\n            <div className=\"flex items-center gap-4\">\n                <Link href={`/etats-lieux/${reportId}`} className={`transition-colors ${isDark ? 'text-white/60 hover:text-white' : 'text-gray-500 hover:text-gray-900'}`}>\n                    <ArrowLeft className=\"w-5 h-5\" />\n                </Link>\n                <div>\n                    <h1 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>Signatures</h1>\n                    <p className={`text-sm ${isDark ? 'text-white/60' : 'text-gray-600'}`}>\n                        {report?.lease?.property_address} ‚Ä¢ {report?.lease?.tenant_name}\n                    </p>\n                </div>\n            </div>\n\n            {isAlreadySigned ? (\n                <div className=\"bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6 text-center\">\n                    <Check className=\"w-12 h-12 text-emerald-400 mx-auto mb-3\" />\n                    <h3 className={`text-lg font-medium mb-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>Document sign√©</h3>\n                    <p className={`text-sm mb-4 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                        Cet √©tat des lieux a √©t√© sign√© le {new Date(report.signed_at).toLocaleDateString('fr-FR')}\n                    </p>\n                    <Button asChild className=\"bg-[#F4C430] hover:bg-[#D4A420] text-black\">\n                        <Link href={`/etats-lieux/${reportId}/pdf`}>\n                            <Download className=\"w-4 h-4 mr-2\" />\n                            T√©l√©charger le PDF\n                        </Link>\n                    </Button>\n                </div>\n            ) : (\n                <>\n                    {/* Info */}\n                    <div className=\"bg-[#F4C430]/10 border border-[#F4C430]/30 rounded-xl p-4\">\n                        <p className=\"text-sm text-[#F4C430]\">\n                            <FileText className=\"w-4 h-4 inline mr-2\" />\n                            Votre signature est pr√©-remplie. Le locataire signe sur place lors de l&apos;√©tat des lieux.\n                        </p>\n                    </div>\n\n                    {/* Owner Signature */}\n                    <div className={`border rounded-xl p-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                        {savedOwnerSignature && ownerSignature === savedOwnerSignature && (\n                            <div className=\"flex items-center gap-2 text-emerald-400 text-sm mb-3 bg-emerald-500/10 rounded-lg px-3 py-2\">\n                                <UserCheck className=\"w-4 h-4\" />\n                                ‚úÖ Signature import√©e depuis votre configuration\n                            </div>\n                        )}\n                        <SignatureCanvas\n                            label=\"‚úçÔ∏è Signature du Propri√©taire (ou mandataire)\"\n                            existingSignature={ownerSignature}\n                            onSave={setOwnerSignature}\n                        />\n                    </div>\n\n                    {/* Tenant Signature */}\n                    <div className={`border rounded-xl p-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                        <div className=\"flex items-center gap-2 text-blue-400 text-sm mb-3 bg-blue-500/10 rounded-lg px-3 py-2\">\n                            <FileText className=\"w-4 h-4\" />\n                            üëá Passez l&apos;appareil au locataire pour signature\n                        </div>\n                        <SignatureCanvas\n                            label=\"‚úçÔ∏è Signature du Locataire\"\n                            existingSignature={tenantSignature}\n                            onSave={setTenantSignature}\n                        />\n                    </div>\n\n                    {/* Sign Button */}\n                    <Button\n                        onClick={handleSign}\n                        disabled={saving || !ownerSignature || !tenantSignature}\n                        className=\"w-full h-12 bg-[#F4C430] hover:bg-[#D4A420] text-black font-semibold\"\n                    >\n                        {saving ? (\n                            <>\n                                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                                Validation...\n                            </>\n                        ) : (\n                            <>\n                                <Check className=\"w-4 h-4 mr-2\" />\n                                Valider et G√©n√©rer le PDF\n                            </>\n                        )}\n                    </Button>\n                </>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\components\\ThemedPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\formulaire-vierge\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":114,"column":29,"nodeType":"JSXOpeningElement","endLine":118,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useRef, useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport { ArrowLeft, Printer, FileText, Building, Check } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { PROPERTY_TEMPLATES, PROPERTY_TYPE_LABELS, type PropertyType } from '../types';\nimport { getAgencyBranding } from '../actions';\n\nconst PROPERTY_ICONS: Record<PropertyType, string> = {\n    'chambre': 'üõèÔ∏è',\n    'studio': 'üè†',\n    'f2': 'üè¢',\n    'f3': 'üè¢',\n    'f4': 'üè¢',\n    'villa': 'üè°',\n    'custom': '‚öôÔ∏è',\n};\n\n// Map items to string for the blank form\nconst getRoomItems = (type: PropertyType) => {\n    const rooms = PROPERTY_TEMPLATES[type] || PROPERTY_TEMPLATES['f2'];\n    return rooms.map(room => ({\n        name: room.name,\n        items: room.items.map(item => item.name)\n    }));\n};\n\nexport default function BlankPDFPage() {\n    const printRef = useRef<HTMLDivElement>(null);\n    const [selectedType, setSelectedType] = useState<PropertyType>('f2');\n    const [agencyBranding, setAgencyBranding] = useState<{ name: string | null, logo: string | null } | null>(null);\n\n    useEffect(() => {\n        const fetchBranding = async () => {\n            const result = await getAgencyBranding();\n            if (result && !('error' in result)) {\n                setAgencyBranding({\n                    name: result.agency_name,\n                    logo: result.logo_url\n                });\n            }\n        };\n        fetchBranding();\n    }, []);\n\n    const handlePrint = () => {\n        window.print();\n    };\n\n    const rooms = getRoomItems(selectedType);\n\n    return (\n        <div className=\"space-y-6\">\n            {/* Header - Hidden on print */}\n            <div className=\"flex items-center justify-between print:hidden\">\n                <div className=\"flex items-center gap-4\">\n                    <Link href=\"/etats-lieux\" className=\"text-white/60 hover:text-white transition-colors\">\n                        <ArrowLeft className=\"w-5 h-5\" />\n                    </Link>\n                    <div>\n                        <h1 className=\"text-xl font-semibold text-white\">Formulaire Vierge</h1>\n                        <p className=\"text-sm text-white/60\">√âtat des lieux √† imprimer</p>\n                    </div>\n                </div>\n                <Button onClick={handlePrint} className=\"bg-[#F4C430] hover:bg-[#D4A420] text-black\">\n                    <Printer className=\"w-4 h-4 mr-2\" />\n                    Imprimer / T√©l√©charger PDF\n                </Button>\n            </div>\n\n            {/* Type Selector - Hidden on print */}\n            <div className=\"bg-slate-900 border border-slate-800 rounded-xl p-4 print:hidden space-y-3\">\n                <div className=\"flex items-center gap-2 text-white font-medium\">\n                    <Building className=\"w-4 h-4 text-[#F4C430]\" />\n                    <span>Choisir le type de bien pour le mod√®le :</span>\n                </div>\n                <div className=\"flex flex-wrap gap-2\">\n                    {(Object.keys(PROPERTY_TYPE_LABELS) as PropertyType[]).map((type) => (\n                        <button\n                            key={type}\n                            onClick={() => setSelectedType(type)}\n                            className={`flex items-center gap-2 px-3 py-2 rounded-lg border text-sm transition-all ${selectedType === type\n                                ? 'bg-[#F4C430] border-[#F4C430] text-black font-medium'\n                                : 'bg-slate-800 border-slate-700 text-slate-300 hover:border-slate-600'\n                                }`}\n                        >\n                            <span>{PROPERTY_ICONS[type]}</span>\n                            {PROPERTY_TYPE_LABELS[type]}\n                            {selectedType === type && <Check className=\"w-3 h-3 ml-1\" />}\n                        </button>\n                    ))}\n                </div>\n                <div className=\"bg-blue-500/10 border border-blue-500/30 rounded-lg p-3\">\n                    <p className=\"text-sm text-blue-400\">\n                        <FileText className=\"w-4 h-4 inline mr-2\" />\n                        Le formulaire ci-dessous s&apos;adapte automatiquement au type de bien s√©lectionn√© ({PROPERTY_TYPE_LABELS[selectedType]}).\n                    </p>\n                </div>\n            </div>\n\n            {/* PDF Content - Blank Professional Template */}\n            <div\n                id=\"print-content\"\n                ref={printRef}\n                className=\"bg-white text-black rounded-xl p-6 print:p-0 print:rounded-none max-w-4xl mx-auto print:max-w-none text-xs print:w-full print:absolute print:top-0 print:left-0\"\n                style={{ fontFamily: 'Arial, sans-serif' }}\n            >\n                {/* Agency Header (Visible on print) */}\n                <div className=\"hidden print:flex justify-between items-start border-b border-black pb-4 mb-4\">\n                    {/* Logo √† gauche */}\n                    <div className=\"w-1/3\">\n                        {agencyBranding?.logo && (\n                            <img\n                                src={agencyBranding.logo}\n                                alt=\"Logo Agence\"\n                                className=\"h-16 w-auto object-contain object-left\"\n                            />\n                        )}\n                    </div>\n\n                    {/* Informations √† droite */}\n                    <div className=\"w-2/3 text-right\">\n                        <p className=\"font-bold text-xl uppercase tracking-tight\">\n                            {agencyBranding?.name || 'DOUSSEL IMMO'}\n                        </p>\n                        <p className=\"text-xs text-gray-600 mb-2\">\n                            Gestion Locative & Immobili√®re\n                        </p>\n                        <div className=\"inline-block border border-gray-400 px-3 py-1 mt-1\">\n                            <p className=\"font-bold text-sm uppercase\">{PROPERTY_TYPE_LABELS[selectedType]}</p>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Title Header */}\n                <div className=\"bg-gray-200 text-center py-2 mb-6 border-y border-gray-400\">\n                    <h1 className=\"text-lg font-bold uppercase tracking-widest\">\n                        √âtat des Lieux et Inventaire\n                    </h1>\n                </div>\n\n                {/* Property Info - Blank fields */}\n                <div className=\"mb-6 space-y-3 text-sm\">\n                    <p>\n                        <strong>Type :</strong>{' '}\n                        <span className=\"inline-block mr-4\">‚òê Entr√©e</span>\n                        <span className=\"inline-block\">‚òê Sortie</span>\n                    </p>\n                    <p>\n                        <strong>Adresse du bien :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '350px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                    <p>\n                        <strong>Nom du locataire :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '250px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                    <p>\n                        <strong>Date de l&apos;√©tat des lieux :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '150px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                </div>\n\n                {/* Meter Readings */}\n                <div className=\"mb-4 flex flex-wrap gap-x-6 text-sm\">\n                    <p>\n                        <strong>Compteur √©lectricit√© :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '80px' }}>\n                            &nbsp;\n                        </span>{' '}\n                        kWh\n                    </p>\n                    <p>\n                        <strong>Compteur eau :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '80px' }}>\n                            &nbsp;\n                        </span>{' '}\n                        m¬≥\n                    </p>\n                </div>\n\n                {/* Legend */}\n                <div className=\"mb-3 text-xs bg-gray-100 p-2\">\n                    <strong>L√©gende :</strong> TB = Tr√®s Bon | B = Bon | M = Moyen | D = D√©grad√©/Absent\n                </div>\n\n                {/* Rooms Tables */}\n                {rooms.map((room, roomIndex) => (\n                    <div key={roomIndex} className=\"mb-4 break-inside-avoid\">\n                        <h3 className=\"font-bold bg-gray-200 border border-gray-400 px-2 py-1 uppercase text-xs\">\n                            {room.name}\n                        </h3>\n                        <table className=\"w-full border-collapse border border-gray-400 text-xs\">\n                            <thead>\n                                <tr className=\"bg-gray-100\">\n                                    <th className=\"border border-gray-400 px-2 py-1 text-left font-medium\" style={{ width: '30%' }}>\n                                        √âl√©ment\n                                    </th>\n                                    <th className=\"border border-gray-400 px-1 py-1 text-center font-medium\" style={{ width: '8%' }}>TB</th>\n                                    <th className=\"border border-gray-400 px-1 py-1 text-center font-medium\" style={{ width: '8%' }}>B</th>\n                                    <th className=\"border border-gray-400 px-1 py-1 text-center font-medium\" style={{ width: '8%' }}>M</th>\n                                    <th className=\"border border-gray-400 px-1 py-1 text-center font-medium\" style={{ width: '8%' }}>D</th>\n                                    <th className=\"border border-gray-400 px-2 py-1 text-left font-medium\">\n                                        Commentaires\n                                    </th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                {room.items.map((item, itemIndex) => (\n                                    <tr key={itemIndex}>\n                                        <td className=\"border border-gray-400 px-2 py-1\">{item}</td>\n                                        <td className=\"border border-gray-400 px-1 py-1 text-center\">‚òê</td>\n                                        <td className=\"border border-gray-400 px-1 py-1 text-center\">‚òê</td>\n                                        <td className=\"border border-gray-400 px-1 py-1 text-center\">‚òê</td>\n                                        <td className=\"border border-gray-400 px-1 py-1 text-center\">‚òê</td>\n                                        <td className=\"border border-gray-400 px-2 py-1\">&nbsp;</td>\n                                    </tr>\n                                ))}\n                            </tbody>\n                        </table>\n                    </div>\n                ))}\n\n                {/* Inventaire Section */}\n                <div className=\"mb-4 break-inside-avoid\">\n                    <h3 className=\"font-bold uppercase mb-2 text-sm\">Inventaire du mobilier :</h3>\n                    <table className=\"w-full border-collapse border border-gray-400 text-xs\">\n                        <tbody>\n                            {[1, 2, 3, 4, 5, 6, 7, 8].map((i) => (\n                                <tr key={i}>\n                                    <td className=\"border border-gray-400 px-2 py-2\">&nbsp;</td>\n                                </tr>\n                            ))}\n                        </tbody>\n                    </table>\n                </div>\n\n                {/* Commentaires Contradictoires */}\n                <div className=\"mb-4\">\n                    <h3 className=\"font-bold uppercase mb-2 text-sm\">Commentaires Contradictoires :</h3>\n                    <div className=\"border border-gray-400 min-h-[50px] p-2\">&nbsp;</div>\n                </div>\n\n                {/* Keys and Final Info */}\n                <div className=\"mb-4 space-y-2 text-sm\">\n                    <p>\n                        <strong>Clefs remises au nombre de :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '40px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                    <p>\n                        <strong>Fait √† :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '120px' }}>\n                            &nbsp;\n                        </span>\n                        , le{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '120px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                </div>\n\n                {/* Signatures Section */}\n                <div className=\"grid grid-cols-2 gap-6 mt-6 pt-4 border-t border-gray-400\">\n                    <div className=\"text-center\">\n                        <p className=\"font-bold mb-1 text-sm\">Le Bailleur (ou son mandataire)</p>\n                        <p className=\"text-xs text-gray-500 mb-2\">Lu et approuv√©</p>\n                        <div className=\"border border-gray-400 h-20\">&nbsp;</div>\n                    </div>\n                    <div className=\"text-center\">\n                        <p className=\"font-bold mb-1 text-sm\">Le(s) Locataire(s)</p>\n                        <p className=\"text-xs text-gray-500 mb-2\">Lu et approuv√©</p>\n                        <div className=\"border border-gray-400 h-20\">&nbsp;</div>\n                    </div>\n                </div>\n\n                {/* Footer */}\n                <div className=\"mt-6 pt-2 border-t border-gray-200 text-center text-xs text-gray-400\">\n                    <span>Formulaire Doussel Immo - {PROPERTY_TYPE_LABELS[selectedType]}</span>\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\etats-lieux\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\interventions\\InterventionsPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\interventions\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\layout.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'router'. Either include it or remove the dependency array.","line":57,"column":8,"nodeType":"ArrayExpression","endLine":57,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [router]","fix":{"range":[1467,1469],"text":"[router]"}}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(webapp)\\layout.tsx:61:9\n  59 |     // Close sidebar on route change (mobile)\n  60 |     useEffect(() => {\n> 61 |         setIsSidebarOpen(false);\n     |         ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  62 |     }, [pathname]);\n  63 |\n  64 |     if (!isAuthenticated) {","line":61,"column":9,"nodeType":null,"endLine":61,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { usePathname } from \"next/navigation\";\nimport { scrollToTop } from \"@/lib/scroll-utils\";\nimport Link from \"next/link\";\nimport Image from \"next/image\";\nimport {\n    Scale,\n    Settings,\n    Building2,\n    Wrench,\n    MessageSquare,\n    Sidebar,\n    X,\n    ChevronLeft,\n    Wallet,\n    ClipboardList,\n    FolderOpen,\n    Sun,\n    Moon\n} from \"lucide-react\";\nimport { useEffect, useState, useRef } from \"react\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport { useRouter } from \"next/navigation\";\nimport { useTheme } from \"@/components/theme-provider\";\n\nfunction WebAppLayoutContent({\n    children,\n}: {\n    children: React.ReactNode;\n}) {\n    const router = useRouter();\n    const pathname = usePathname();\n    const [isAuthenticated, setIsAuthenticated] = useState(true);\n    const [isSidebarOpen, setIsSidebarOpen] = useState(false);\n    const [isCollapsed, setIsCollapsed] = useState(true);\n    const { toggleTheme, isDark } = useTheme();\n    const mainRef = useRef<HTMLElement>(null);\n\n    // Scroll to top on navigation\n    useEffect(() => {\n        scrollToTop();\n    }, [pathname]);\n\n    useEffect(() => {\n        const checkAuth = async () => {\n            const supabase = createClient();\n            const { data: { user } } = await supabase.auth.getUser();\n\n            if (!user) {\n                router.push('/login');\n                setIsAuthenticated(false);\n            }\n        };\n\n        checkAuth();\n    }, []);\n\n    // Close sidebar on route change (mobile)\n    useEffect(() => {\n        setIsSidebarOpen(false);\n    }, [pathname]);\n\n    if (!isAuthenticated) {\n        return null;\n    }\n\n    const navItems = [\n        {\n            id: \"tour-nav-etats-lieux\",\n            href: \"/etats-lieux\",\n            icon: ClipboardList,\n            label: \"√âtats des Lieux\",\n            isActive: pathname?.startsWith('/etats-lieux'),\n        },\n        {\n            id: \"tour-nav-interventions\",\n            href: \"/interventions\",\n            icon: Wrench,\n            label: \"Interventions\",\n            isActive: pathname?.startsWith('/interventions'),\n        },\n        {\n            id: \"tour-nav-documents\",\n            href: \"/gestion/documents\",\n            icon: FolderOpen,\n            label: \"Documents\",\n            isActive: pathname?.startsWith('/gestion/documents'),\n        },\n        {\n            id: \"tour-nav-messages\",\n            href: \"/gestion/messages\",\n            icon: MessageSquare,\n            label: \"Messagerie\",\n            isActive: pathname?.startsWith('/gestion/messages'),\n        },\n        {\n            id: \"tour-nav-legal\",\n            href: \"/documents-legaux\",\n            icon: Scale,\n            label: \"Juridique\",\n            isActive: pathname === '/documents-legaux',\n        },\n        {\n            id: \"tour-nav-accounting\",\n            href: \"/gestion/comptabilite\",\n            icon: Wallet,\n            label: \"Comptabilit√©\",\n            isActive: pathname === '/gestion/comptabilite',\n        },\n    ];\n\n    return (\n        <div className={`flex flex-col h-[100dvh] w-screen overflow-hidden transition-colors ${isDark\n            ? 'bg-black text-gray-100'\n            : 'bg-gray-50 text-gray-900'\n            }`}>\n\n            {/* ========================================\n                HEADER GLOBAL (Logo + Quitter)\n                ======================================== */}\n            <header className={`border-b shrink-0 z-50 transition-colors ${isDark\n                ? 'bg-[#121212] border-gray-800'\n                : 'bg-white border-gray-200'\n                }`}\n                style={{ paddingTop: \"env(safe-area-inset-top, 0px)\" }}>\n                <div className=\"h-16 flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-3\">\n                        {/* Hamburger Menu - Mobile only */}\n                        <button\n                            onClick={() => setIsSidebarOpen(!isSidebarOpen)}\n                            className=\"lg:hidden p-2 -ml-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition-colors\"\n                        >\n                            <Sidebar className=\"w-5 h-5\" />\n                        </button>\n\n                        {/* Logo */}\n                        <Link href=\"/\" className=\"flex items-center\">\n                            <Image\n                                src=\"/icons/icon-192.png\"\n                                width={32}\n                                height={32}\n                                alt=\"Dousell Immo\"\n                                className=\"rounded\"\n                            />\n                        </Link>\n                        <span className={`font-semibold text-lg border-l border-gray-700 pl-3 ${isDark ? 'text-[#F4C430]' : 'text-slate-900'}`}>\n                            Gestion Locative\n                        </span>\n                    </div>\n\n                    {/* Actions √† droite */}\n                    <div className=\"flex items-center gap-2\">\n                        {/* Bouton Theme Toggle */}\n                        <button\n                            onClick={toggleTheme}\n                            className={`p-2 rounded-lg transition-colors ${isDark\n                                ? 'hover:bg-slate-800 text-slate-400 hover:text-white'\n                                : 'hover:bg-gray-200 text-gray-600 hover:text-gray-900'\n                                }`}\n                            title={isDark ? \"Activer le mode clair\" : \"Activer le mode sombre\"}\n                        >\n                            {isDark ? (\n                                <Sun className=\"w-5 h-5\" />\n                            ) : (\n                                <Moon className=\"w-5 h-5\" />\n                            )}\n                        </button>\n\n                        {/* Bouton Quitter */}\n                        <Link\n                            href=\"/compte\"\n                            className={`text-sm px-3 py-2 rounded transition-colors ${isDark\n                                ? 'text-gray-400 hover:text-white hover:bg-gray-800'\n                                : 'text-gray-600 hover:text-gray-900 hover:bg-gray-200'\n                                }`}\n                        >\n                            <span className=\"hidden sm:inline\">Quitter</span>\n                            <X className=\"w-5 h-5 sm:hidden\" />\n                        </Link>\n                    </div>\n                </div>\n            </header>\n\n            {/* ========================================\n                ZONE PRINCIPALE (Sidebar + Content)\n                ======================================== */}\n            <div className=\"flex-1 flex overflow-hidden\">\n\n                {/* Mobile Overlay */}\n                {isSidebarOpen && (\n                    <div\n                        className=\"fixed inset-0 bg-black/60 z-40 lg:hidden backdrop-blur-sm\"\n                        onClick={() => setIsSidebarOpen(false)}\n                    />\n                )}\n\n                {/* Sidebar */}\n                <aside\n                    className={`\n                    fixed left-0 z-50\n                    border-r\n                    transform transition-all duration-300 ease-in-out\n                    ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}\n                    lg:translate-x-0 lg:static lg:h-full\n                    ${isCollapsed ? 'w-64 lg:w-16' : 'w-64'}\n                    ${isDark ? 'bg-black border-gray-800' : 'bg-white border-gray-200'}\n                    flex flex-col\n                    print:hidden\n                `}\n                    style={{\n                        top: \"calc(4rem + env(safe-area-inset-top, 0px))\",\n                        height: \"calc(100dvh - (4rem + env(safe-area-inset-top, 0px)))\"\n                    }}>\n\n                    {/* Sidebar Header avec bouton collapse */}\n                    <div className={`h-12 flex items-center justify-between px-4 border-b shrink-0 ${isDark ? 'border-gray-800' : 'border-gray-200'\n                        }`}>\n                        <span className={`text-xs font-medium uppercase tracking-wider ${isDark ? 'text-gray-500' : 'text-gray-400'} ${isCollapsed ? 'lg:hidden' : ''}`}>\n                            Navigation\n                        </span>\n\n                        {/* Collapse button - Desktop only */}\n                        <button\n                            onClick={() => setIsCollapsed(!isCollapsed)}\n                            className={`hidden lg:flex p-1.5 rounded-lg transition-colors ml-auto ${isDark\n                                ? 'hover:bg-slate-800 text-slate-400 hover:text-white'\n                                : 'hover:bg-gray-200 text-gray-500 hover:text-gray-900'\n                                }`}\n                        >\n                            <ChevronLeft className={`w-4 h-4 transition-transform ${isCollapsed ? 'rotate-180' : ''}`} />\n                        </button>\n\n\n                    </div>\n\n                    {/* Navigation Links */}\n                    <nav className={`p-3 space-y-1 flex-1 overflow-y-auto scrollbar-thin ${isDark ? 'scrollbar-thumb-slate-800' : 'scrollbar-thumb-gray-300'\n                        }`}>\n                        {/* Gestion Locative (Dashboard Principal) */}\n                        <Link\n                            href=\"/gestion\"\n                            className={`\n                                flex items-center gap-2 px-3 py-2 rounded-md\n                                transition-colors duration-200 group\n                                ${isCollapsed ? 'lg:justify-center' : ''}\n                                ${(pathname === '/gestion' || pathname?.startsWith('/gestion/locataires'))\n                                    ? isDark\n                                        ? 'bg-gray-900 text-white font-medium'\n                                        : 'bg-gray-100 text-gray-900 font-medium'\n                                    : isDark\n                                        ? 'text-gray-400 hover:text-gray-50 hover:bg-gray-900'\n                                        : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100'\n                                }\n                            `}\n                            title=\"Gestion Locative\"\n                        >\n                            <Building2 className={`w-4 h-4 shrink-0 transition-colors ${(pathname === '/gestion' || pathname?.startsWith('/gestion/locataires'))\n                                ? 'text-current'\n                                : 'text-gray-500 group-hover:text-current'\n                                }`} />\n                            <span className={`text-sm ${isCollapsed ? 'lg:hidden' : ''}`}>Dashboard</span>\n                        </Link>\n\n                        {/* S√©parateur */}\n                        <div className={`h-px my-2 ${isDark ? 'bg-gray-800' : 'bg-gray-200'}`} />\n\n                        {/* Navigation principale */}\n                        {navItems.map((item) => (\n                            <Link\n                                key={item.id}\n                                id={item.id}\n                                href={item.href}\n                                className={`\n                                    flex items-center gap-2 px-3 py-2 rounded-md\n                                    transition-colors duration-200 group\n                                    ${isCollapsed ? 'lg:justify-center' : ''}\n                                    ${item.isActive\n                                        ? isDark\n                                            ? 'bg-gray-900 text-white font-medium'\n                                            : 'bg-gray-100 text-gray-900 font-medium'\n                                        : isDark\n                                            ? 'text-gray-400 hover:text-gray-50 hover:bg-gray-900'\n                                            : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100'\n                                    }\n                                `}\n                                title={item.label}\n                            >\n                                <item.icon className={`w-4 h-4 shrink-0 transition-colors ${item.isActive\n                                    ? 'text-current'\n                                    : 'text-gray-500 group-hover:text-current'\n                                    }`} />\n                                <span className={`text-sm ${isCollapsed ? 'lg:hidden' : ''}`}>{item.label}</span>\n                            </Link>\n                        ))}\n                    </nav>\n\n                    {/* Bottom Section - Settings */}\n                    <div className={`p-3 border-t shrink-0 ${isDark ? 'border-slate-800' : 'border-gray-200'}`}>\n                        <Link\n                            href=\"/gestion/config\"\n                            className={`\n                                flex items-center gap-2 px-3 py-2 rounded-md\n                                transition-colors\n                                ${isCollapsed ? 'lg:justify-center' : ''}\n                                ${isDark\n                                    ? 'text-gray-400 hover:text-white hover:bg-gray-900'\n                                    : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100'\n                                }\n                            `}\n                            title=\"Configuration\"\n                        >\n                            <Settings className=\"w-5 h-5 shrink-0\" />\n                            <span className={`text-sm font-medium ${isCollapsed ? 'lg:hidden' : ''}`}>Configuration</span>\n                        </Link>\n                    </div>\n                </aside>\n\n                {/* ========================================\n                    MAIN CONTENT AREA\n                    ======================================== */}\n                <main\n                    ref={mainRef}\n                    id=\"main-scroll-container\"\n                    className={`flex-1 w-full h-full overflow-y-auto transition-colors ${isDark\n                        ? 'bg-black'\n                        : 'bg-gray-50'\n                        }`}>\n                    {children}\n                </main>\n            </div>\n        </div>\n    );\n}\n\nexport default function WebAppLayout({\n    children,\n}: {\n    children: React.ReactNode;\n}) {\n    return (\n        <WebAppLayoutContent>{children}</WebAppLayoutContent>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\activation-requests\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\activation-requests\\components\\ActivationRequestsList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\activation-requests\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\biens\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\biens\\nouveau\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2216,2219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2216,2219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3591,3594],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3591,3594],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":711,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":711,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25905,25908],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25905,25908],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Image from \"next/image\";\nimport { useState, DragEvent, useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { toast } from \"sonner\";\nimport confetti from \"canvas-confetti\";\nimport { motion, _AnimatePresence } from \"framer-motion\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { supabase } from \"@/lib/supabase\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { propertySchema, type PropertyFormValues } from \"@/lib/schemas/propertySchema\";\nimport { PropertyCard } from \"@/app/(workspace)/compte/mes-biens/PropertyCard\";\nimport type { _Property } from \"@/types/property\";\n\nconst AUTHORIZED_ADMIN_EMAIL = \"barrymohamadou98@gmail.com\";\n\nconst defaultValues: Partial<PropertyFormValues> = {\n  title: \"\",\n  description: \"\",\n  price: 0,\n  category: \"vente\",\n  type: \"appartement\",\n  city: \"\",\n  district: \"\",\n  address: \"\",\n  landmark: \"\",\n  surface: 120,\n  surfaceTotale: undefined,\n  rooms: 4,\n  bedrooms: 3,\n  bathrooms: 2,\n  hasGenerator: false,\n  hasWaterTank: false,\n  security: true,\n  pool: false,\n  juridique: undefined,\n};\n\nconst quartiers = [\n  \"Almadies\",\n  \"Plateau\",\n  \"Mermoz\",\n  \"Yoff\",\n  \"Ngor\",\n  \"Ouakam\",\n  \"Sacr√©-C≈ìur\",\n  \"Les Mamelles\",\n];\n\nconst typesBien = [\n  { value: \"villa\", label: \"Villa\" },\n  { value: \"appartement\", label: \"Appartement\" },\n  { value: \"terrain\", label: \"Terrain\" },\n  { value: \"immeuble\", label: \"Immeuble / Commercial\" },\n  { value: \"studio\", label: \"Studio\" },\n];\n\nconst situationsJuridiques = [\n  { value: \"titre-foncier\", label: \"Titre Foncier\" },\n  { value: \"bail\", label: \"Bail\" },\n  { value: \"deliberation\", label: \"D√©lib√©ration\" },\n  { value: \"nicad\", label: \"Nicad\" },\n];\n\nexport default function NewPropertyPage() {\n  const router = useRouter();\n  const { user, loading } = useAuth();\n  const [imageUrls, setImageUrls] = useState<string[]>([]);\n  const [uploading, setUploading] = useState(false);\n  const [createdProperty, setCreatedProperty] = useState<any | null>(null);\n\n  const {\n    register,\n    _handleSubmit,\n    setValue,\n    watch,\n    getValues,\n    formState: { errors },\n    trigger,\n  } = useForm<PropertyFormValues>({\n    resolver: zodResolver(propertySchema),\n    defaultValues,\n  });\n\n  // Watch pour r√©agir aux changements\n  const type = watch(\"type\");\n  const category = watch(\"category\");\n  const isTerrain = type === \"terrain\";\n\n  // Check admin access\n  useEffect(() => {\n    if (!loading && user) {\n      if (user.email?.toLowerCase() !== AUTHORIZED_ADMIN_EMAIL.toLowerCase()) {\n        toast.error(\"Acc√®s non autoris√©\");\n        router.push(\"/compte\");\n      }\n    } else if (!loading && !user) {\n      router.push(\"/login?redirect=/admin/biens/nouveau\");\n    }\n  }, [user, loading, router]);\n\n  if (loading) {\n    return (\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\n        <div className=\"text-white/70\">Chargement...</div>\n      </div>\n    );\n  }\n\n  if (!user || user.email?.toLowerCase() !== AUTHORIZED_ADMIN_EMAIL.toLowerCase()) {\n    return null;\n  }\n\n  const triggereMagic = () => {\n    const duration = 3000;\n    const animationEnd = Date.now() + duration;\n    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };\n\n    const randomInRange = (min: number, max: number) => {\n      return Math.random() * (max - min) + min;\n    }\n\n    const interval: any = setInterval(function () {\n      const timeLeft = animationEnd - Date.now();\n\n      if (timeLeft <= 0) {\n        return clearInterval(interval);\n      }\n\n      const particleCount = 50 * (timeLeft / duration);\n\n      confetti({\n        ...defaults,\n        particleCount,\n        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }\n      });\n      confetti({\n        ...defaults,\n        particleCount,\n        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }\n      });\n    }, 250);\n  };\n\n  const onDrop = async (event: DragEvent<HTMLDivElement>) => {\n    event.preventDefault();\n    const files = Array.from(event.dataTransfer.files);\n    await handleUpload(files);\n  };\n\n  const handleUpload = async (files: FileList | File[]) => {\n    const arr = Array.from(files);\n    if (!arr.length) return;\n    setUploading(true);\n    try {\n      const uploadedUrls: string[] = [];\n      for (const file of arr) {\n        const filePath = `${Date.now()}-${file.name}`;\n        const { error } = await supabase.storage\n          .from(\"properties\")\n          .upload(filePath, file, { upsert: true });\n        if (error) throw error;\n        const {\n          data: { publicUrl },\n        } = supabase.storage.from(\"properties\").getPublicUrl(filePath);\n        uploadedUrls.push(publicUrl);\n      }\n      setImageUrls((prev) => [...prev, ...uploadedUrls]);\n    } catch (error) {\n      console.error(error);\n      toast.error(\"Upload impossible\");\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  const onSubmit = async (values: PropertyFormValues) => {\n    try {\n      // Pr√©parer les specs selon le type\n      const specs = isTerrain\n        ? {\n          surface: values.surfaceTotale ?? 0,\n          rooms: 0,\n          bedrooms: 0,\n          bathrooms: 0,\n          dpe: \"B\" as const,\n        }\n        : {\n          surface: values.surface ?? 0,\n          rooms: values.rooms ?? 0,\n          bedrooms: values.bedrooms ?? 0,\n          bathrooms: values.bathrooms ?? 0,\n          dpe: \"B\" as const,\n        };\n\n      // Pr√©parer les features (masqu√©s pour les terrains)\n      const features = isTerrain\n        ? {}\n        : {\n          hasGenerator: values.hasGenerator ?? false,\n          hasWaterTank: values.hasWaterTank ?? false,\n          security: values.security ?? false,\n          pool: values.pool ?? false,\n        };\n\n      // Mapper le type pour details\n      const typeMap: Record<string, \"Appartement\" | \"Maison\" | \"Studio\"> = {\n        villa: \"Maison\",\n        appartement: \"Appartement\",\n        immeuble: \"Appartement\",\n        terrain: \"Appartement\", // Valeur par d√©faut, non utilis√©e pour terrain\n        studio: \"Studio\",\n      };\n\n      const payload = {\n        title: values.title,\n        description: values.description,\n        price: values.price,\n        category: values.category,\n        transaction: values.category, // Ajout pour conformit√© type\n        status: \"disponible\",\n        location: {\n          city: values.city,\n          district: values.district,\n          address: values.address,\n          landmark: values.landmark,\n          coords: { lat: 14.7167, lng: -17.4677 }, // Default Dakar coords\n        },\n        specs,\n        features, // Sera ignor√© si pas dans le type, mais utile pour le stockage\n        details: isTerrain\n          ? {\n            type: \"Appartement\" as const, // Non utilis√© pour terrain\n            year: new Date().getFullYear(),\n            heating: \"\",\n            juridique: values.juridique,\n          }\n          : {\n            type: typeMap[values.type] ?? \"Appartement\",\n            year: new Date().getFullYear(),\n            heating: \"Climatisation\",\n            ...features, // Spread features into details for compatibility if needed\n          },\n        images: imageUrls,\n        agent: {\n          name: \"Admin\",\n          photo: \"\",\n          phone: \"\"\n        },\n        disponibilite: \"Imm√©diate\"\n      };\n\n      const { data, error } = await supabase\n        .from(\"properties\")\n        .insert([payload])\n        .select()\n        .single();\n\n      if (error) throw error;\n\n      // Construire l'objet complet pour la PropertyCard\n      const completeProperty = {\n        ...data,\n        validation_status: 'approved',\n        occupation_status: 'vacant',\n        // S'assurer que les champs requis par le type Property sont pr√©sents\n        transaction: payload.transaction,\n        location: payload.location,\n        specs: payload.specs,\n        details: payload.details,\n        images: payload.images,\n        agent: payload.agent,\n        disponibilite: payload.disponibilite\n      };\n\n      setCreatedProperty(completeProperty);\n      triggereMagic();\n\n      // Scroll to bottom to see effects\n      setTimeout(() => {\n        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });\n      }, 100);\n\n    } catch (error) {\n      console.error(error);\n      toast.error(\"Impossible d'enregistrer ce bien\");\n    }\n  };\n\n  // Label dynamique pour le prix\n  const priceLabel =\n    category === \"location\"\n      ? \"Loyer Mensuel (FCFA)\"\n      : \"Prix de Vente (FCFA)\";\n\n  if (createdProperty) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[80vh] py-10 space-y-8\">\n        <motion.div\n          initial={{ scale: 0.8, opacity: 0 }}\n          animate={{ scale: 1, opacity: 1 }}\n          transition={{ type: \"spring\", duration: 0.8 }}\n          className=\"w-full max-w-md\"\n        >\n          <PropertyCard\n            property={createdProperty}\n            viewMode=\"grid\"\n          />\n        </motion.div>\n\n        <motion.div\n          initial={{ y: 20, opacity: 0 }}\n          animate={{ y: 0, opacity: 1 }}\n          transition={{ delay: 0.5 }}\n          className=\"flex flex-col items-center gap-4\"\n        >\n          <div className=\"relative\">\n            <div className=\"absolute inset-0 bg-yellow-400/20 blur-xl rounded-full animate-pulse\" />\n            <div className=\"relative bg-[#FFD700] text-black px-8 py-3 rounded-full font-bold text-lg flex items-center gap-2 shadow-[0_0_30px_rgba(255,215,0,0.3)] border border-[#FFD700]/50\">\n              <SparklesIcon className=\"w-5 h-5 animate-spin-slow\" />\n              Magie op√©r√©e ‚ú®\n            </div>\n          </div>\n\n          <div className=\"flex gap-4 mt-4\">\n            <Button\n              variant=\"ghost\"\n              onClick={() => {\n                setCreatedProperty(null);\n                setImageUrls([]);\n                window.scrollTo({ top: 0, behavior: 'instant' });\n              }}\n            >\n              Nouveau bien\n            </Button>\n            <Button onClick={() => router.push('/admin/dashboard')}>\n              Aller au tableau de bord\n            </Button>\n          </div>\n        </motion.div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 py-6 text-white relative\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <p className=\"text-xs uppercase tracking-[0.3em] text-white/40\">\n            Admin\n          </p>\n          <h1 className=\"text-3xl font-semibold\">Nouveau bien</h1>\n        </div>\n      </div>\n      <div\n        className=\"space-y-6 sm:space-y-8 rounded-[32px] border border-white/10 bg-white/5 p-4 sm:p-6\"\n      >\n        <section className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">Informations principales</h2>\n          <div className=\"grid gap-4 sm:grid-cols-2\">\n            {/* Cat√©gorie en premier */}\n            <div>\n              <label className=\"text-sm text-white/70\">Cat√©gorie</label>\n              <select\n                {...register(\"category\")}\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                style={{\n                  colorScheme: \"dark\",\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                  backgroundPosition: \"right 0.75rem center\",\n                  backgroundSize: \"1.5em 1.5em\"\n                }}\n              >\n                <option value=\"vente\" className=\"bg-[#121212] text-white py-2\">\n                  Vente\n                </option>\n                <option value=\"location\" className=\"bg-[#121212] text-white py-2\">\n                  Location\n                </option>\n              </select>\n            </div>\n            <div>\n              <label className=\"text-sm text-white/70\">Type de bien</label>\n              <select\n                {...register(\"type\")}\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                style={{\n                  colorScheme: \"dark\",\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                  backgroundPosition: \"right 0.75rem center\",\n                  backgroundSize: \"1.5em 1.5em\"\n                }}\n              >\n                {typesBien.map((t) => (\n                  <option\n                    key={t.value}\n                    value={t.value}\n                    className=\"bg-[#121212] text-white py-2\"\n                  >\n                    {t.label}\n                  </option>\n                ))}\n              </select>\n              {errors.type && (\n                <p className=\"text-sm text-primary\">{errors.type.message}</p>\n              )}\n            </div>\n            <div className=\"sm:col-span-2\">\n              <label className=\"text-sm text-white/70\">Titre</label>\n              <Input {...register(\"title\")} className=\"mt-2\" />\n              {errors.title && (\n                <p className=\"text-sm text-primary\">{errors.title.message}</p>\n              )}\n            </div>\n            <div className=\"sm:col-span-2\">\n              <label className=\"text-sm text-white/70\">{priceLabel}</label>\n              <Input\n                type=\"number\"\n                {...register(\"price\", { valueAsNumber: true })}\n                className=\"mt-2\"\n              />\n              {errors.price && (\n                <p className=\"text-sm text-primary\">{errors.price.message}</p>\n              )}\n            </div>\n          </div>\n          <div>\n            <label className=\"text-sm text-white/70\">Description</label>\n            <Textarea {...register(\"description\")} className=\"mt-2\" />\n            {errors.description && (\n              <p className=\"text-sm text-primary\">\n                {errors.description.message}\n              </p>\n            )}\n          </div>\n        </section>\n\n        <section className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">Localisation</h2>\n          <div className=\"grid gap-4 sm:grid-cols-2\">\n            <div>\n              <label className=\"text-sm text-white/70\">Ville</label>\n              <Input {...register(\"city\")} className=\"mt-2\" />\n              {errors.city && (\n                <p className=\"text-sm text-primary\">{errors.city.message}</p>\n              )}\n            </div>\n            <div>\n              <label className=\"text-sm text-white/70\">Quartier</label>\n              <select\n                {...register(\"district\")}\n                className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                style={{\n                  colorScheme: \"dark\",\n                  backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                  backgroundPosition: \"right 0.75rem center\",\n                  backgroundSize: \"1.5em 1.5em\"\n                }}\n              >\n                <option value=\"\" className=\"bg-[#121212] text-white py-2\">\n                  S√©lectionnez\n                </option>\n                {quartiers.map((q) => (\n                  <option\n                    key={q}\n                    value={q}\n                    className=\"bg-[#121212] text-white py-2\"\n                  >\n                    {q}\n                  </option>\n                ))}\n              </select>\n              {errors.district && (\n                <p className=\"text-sm text-primary\">\n                  {errors.district.message}\n                </p>\n              )}\n            </div>\n            <div>\n              <label className=\"text-sm text-white/70\">Adresse</label>\n              <Input {...register(\"address\")} className=\"mt-2\" />\n              {errors.address && (\n                <p className=\"text-sm text-primary\">\n                  {errors.address.message}\n                </p>\n              )}\n            </div>\n            <div>\n              <label className=\"text-sm text-white/70\">Point de rep√®re</label>\n              <Input {...register(\"landmark\")} className=\"mt-2\" />\n              {errors.landmark && (\n                <p className=\"text-sm text-primary\">\n                  {errors.landmark.message}\n                </p>\n              )}\n            </div>\n          </div>\n        </section>\n\n        {/* Section Caract√©ristiques - Conditionnelle selon le type */}\n        {!isTerrain ? (\n          <section className=\"space-y-4 transition-all duration-300\">\n            <h2 className=\"text-xl font-semibold\">Caract√©ristiques</h2>\n            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n              <div>\n                <label className=\"text-sm text-white/70\">Surface habitable (m¬≤)</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"surface\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.surface && (\n                  <p className=\"text-sm text-primary\">\n                    {errors.surface.message}\n                  </p>\n                )}\n              </div>\n              <div>\n                <label className=\"text-sm text-white/70\">Pi√®ces</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"rooms\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.rooms && (\n                  <p className=\"text-sm text-primary\">\n                    {errors.rooms.message}\n                  </p>\n                )}\n              </div>\n              <div>\n                <label className=\"text-sm text-white/70\">Chambres</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"bedrooms\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.bedrooms && (\n                  <p className=\"text-sm text-primary\">\n                    {errors.bedrooms.message}\n                  </p>\n                )}\n              </div>\n              <div>\n                <label className=\"text-sm text-white/70\">Salles de bain</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"bathrooms\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.bathrooms && (\n                  <p className=\"text-sm text-primary\">\n                    {errors.bathrooms.message}\n                  </p>\n                )}\n              </div>\n            </div>\n            <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n              {[\n                { label: \"Groupe √©lectrog√®ne\", key: \"hasGenerator\" },\n                { label: \"R√©servoir eau\", key: \"hasWaterTank\" },\n                { label: \"Gardiennage 24/7\", key: \"security\" },\n                { label: \"Piscine\", key: \"pool\" },\n              ].map((feature) => (\n                <label\n                  key={feature.key}\n                  className=\"flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white/80\"\n                >\n                  {feature.label}\n                  <Switch\n                    checked={(watch(feature.key as keyof PropertyFormValues) as boolean) ?? false}\n                    onCheckedChange={(checked) =>\n                      setValue(feature.key as keyof PropertyFormValues, checked)\n                    }\n                  />\n                </label>\n              ))}\n            </div>\n          </section>\n        ) : (\n          <section className=\"space-y-4 transition-all duration-300\">\n            <h2 className=\"text-xl font-semibold\">Caract√©ristiques du terrain</h2>\n            <div className=\"grid gap-4 sm:grid-cols-2\">\n              <div>\n                <label className=\"text-sm text-white/70\">Surface totale (m¬≤)</label>\n                <Input\n                  type=\"number\"\n                  {...register(\"surfaceTotale\", { valueAsNumber: true })}\n                  className=\"mt-2\"\n                />\n                {errors.surfaceTotale && (\n                  <p className=\"text-sm text-primary\">\n                    {errors.surfaceTotale.message}\n                  </p>\n                )}\n              </div>\n              <div>\n                <label className=\"text-sm text-white/70\">Situation juridique</label>\n                <select\n                  {...register(\"juridique\")}\n                  className=\"mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-white/30 focus:outline-none focus:ring-2 focus:ring-white/20 appearance-none bg-no-repeat bg-right pr-10\"\n                  style={{\n                    colorScheme: \"dark\",\n                    backgroundImage: \"url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724%27 height=%2724%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27rgba(255,255,255,0.4)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')\",\n                    backgroundPosition: \"right 0.75rem center\",\n                    backgroundSize: \"1.5em 1.5em\"\n                  }}\n                >\n                  <option value=\"\" className=\"bg-[#121212] text-white py-2\">\n                    S√©lectionnez\n                  </option>\n                  {situationsJuridiques.map((sj) => (\n                    <option\n                      key={sj.value}\n                      value={sj.value}\n                      className=\"bg-[#121212] text-white py-2\"\n                    >\n                      {sj.label}\n                    </option>\n                  ))}\n                </select>\n                {errors.juridique && (\n                  <p className=\"text-sm text-primary\">\n                    {errors.juridique.message}\n                  </p>\n                )}\n              </div>\n            </div>\n          </section>\n        )}\n\n        <section className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">\n            {isTerrain ? \"Photos du site\" : \"Photos\"}\n          </h2>\n          <div\n            className=\"rounded-3xl border border-dashed border-white/20 bg-white/5 p-6 text-center text-white/70\"\n            onDragOver={(event) => event.preventDefault()}\n            onDrop={onDrop}\n          >\n            <p>Glisse-d√©pose tes images ici ou</p>\n            <div className=\"mt-3\">\n              <label className=\"inline-flex cursor-pointer items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-sm text-white\">\n                <input\n                  type=\"file\"\n                  multiple\n                  accept=\"image/*\"\n                  className=\"hidden\"\n                  onChange={(event) =>\n                    event.target.files && handleUpload(event.target.files)\n                  }\n                />\n                Choisir des fichiers\n              </label>\n            </div>\n            {uploading && <p className=\"mt-2 text-sm\">Upload en cours...</p>}\n            {imageUrls.length > 0 && (\n              <div className=\"mt-4 flex flex-wrap gap-3\">\n                {imageUrls.map((url) => (\n                  <div\n                    key={url}\n                    className=\"relative h-24 w-24 overflow-hidden rounded-xl\"\n                  >\n                    <Image\n                      src={url}\n                      alt=\"preview\"\n                      fill\n                      className=\"object-cover\"\n                    />\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </section>\n\n        <Button\n          type=\"button\"\n          onClick={async () => {\n            const isValid = await trigger();\n            if (!isValid) {\n              return;\n            }\n            const values = getValues();\n            await onSubmit(values);\n          }}\n          className=\"w-full rounded-full bg-background text-foreground\"\n          disabled={uploading}\n        >\n          Publier le bien\n        </Button>\n      </div>\n\n      {/* Badge Saisie Admin en bas √† droite comme sur la maquette */}\n      <div className=\"fixed bottom-6 right-6 pointer-events-none\">\n        <div className=\"bg-white/10 backdrop-blur-md px-3 py-1.5 rounded-full border border-white/10 text-xs text-white/50 font-medium\">\n          Saisie Admin\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction SparklesIcon(props: any) {\n  return (\n    <svg\n      {...props}\n      xmlns=\"http://www.w3.org/2000/svg\"\n      width=\"24\"\n      height=\"24\"\n      viewBox=\"0 0 24 24\"\n      fill=\"none\"\n      stroke=\"currentColor\"\n      strokeWidth=\"2\"\n      strokeLinecap=\"round\"\n      strokeLinejoin=\"round\"\n    >\n      <path d=\"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z\" />\n    </svg>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\cache-metrics\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\dashboard\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\dashboard\\delete-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\leads\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\leads\\lead-message-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\leads\\lead-status-select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\leads\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\moderation\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\moderation\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\moderation\\moderation-client.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperties'. Either include it or remove the dependency array.","line":188,"column":6,"nodeType":"ArrayExpression","endLine":188,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [user, authLoading, loadingRoles, canModerate, loadProperties]","fix":{"range":[6864,6910],"text":"[user, authLoading, loadingRoles, canModerate, loadProperties]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\moderation\\notification.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'pathname'. Either include it or remove the dependency array.","line":57,"column":6,"nodeType":"ArrayExpression","endLine":57,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [router, hasShownNotification, pathname]","fix":{"range":[1779,1809],"text":"[router, hasShownNotification, pathname]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { toast } from \"sonner\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport { useRouter, usePathname } from \"next/navigation\";\n\nexport function ModerationNotification() {\n  const router = useRouter();\n  const [hasShownNotification, setHasShownNotification] = useState(false);\n\n  const pathname = usePathname();\n\n  useEffect(() => {\n    // Ne pas afficher la notification si on est d√©j√† sur la page de mod√©ration\n    if (pathname?.startsWith(\"/admin/moderation\")) {\n      return;\n    }\n\n    const checkNewProperties = async () => {\n      const supabase = createClient();\n\n\n      // V√©rifier s'il y a de nouvelles annonces en attente\n      const { count, error } = await supabase\n        .from(\"properties\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"is_agency_listing\", false)\n        .in(\"validation_status\", [\"pending\", \"payment_pending\"]);\n\n      if (!error && count && count > 0 && !hasShownNotification) {\n        // Afficher une notification une seule fois\n        toast.info(`${count} annonce${count > 1 ? \"s\" : \"\"} en attente de mod√©ration`, {\n          description: \"Cliquez sur Mod√©ration pour les examiner\",\n          duration: 6000,\n          action: {\n            label: \"Voir\",\n            onClick: () => {\n              router.push(\"/admin/moderation\");\n            },\n          },\n        });\n        setHasShownNotification(true);\n      }\n    };\n\n    // V√©rifier au chargement de la page (avec un petit d√©lai)\n    const timeout = setTimeout(checkNewProperties, 1000);\n\n    // V√©rifier toutes les 60 secondes\n    const interval = setInterval(checkNewProperties, 60000);\n\n    return () => {\n      clearTimeout(timeout);\n      clearInterval(interval);\n    };\n  }, [router, hasShownNotification]);\n\n  return null;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\moderation\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\moderation\\property-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\moderation\\reject-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\roles\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\roles\\grant-role-action.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\roles\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\roles\\role-manager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\biens\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\biens\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\biens\\property-verification-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\identites\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\identites\\identity-verification-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\identites\\identity-verification-tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\identites\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\identites\\verified-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\admin\\verifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\components\\ThemedComponents.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2066,2069],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2066,2069],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useTheme } from \"@/components/theme-provider\";\nimport { ReactNode } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\n/**\n * Wrapper pour une page compl√®te - applique les couleurs de texte\n */\nexport function ThemedPage({ children, className = \"\" }: { children: ReactNode; className?: string }) {\n    const { isDark } = useTheme();\n\n    return (\n        <div className={cn(\n            \"space-y-6\",\n            isDark ? 'text-white' : 'text-gray-900',\n            className\n        )}>\n            {children}\n        </div>\n    );\n}\n\n/**\n * Card avec background et bordures adapt√©s au th√®me\n */\nexport function ThemedCard({\n    children,\n    className = \"\",\n    hover = false\n}: {\n    children: ReactNode;\n    className?: string;\n    hover?: boolean;\n}) {\n    const { isDark } = useTheme();\n\n    return (\n        <div className={cn(\n            \"border rounded-xl\",\n            isDark\n                ? 'bg-slate-900 border-slate-800'\n                : 'bg-white border-gray-200',\n            hover && (isDark ? 'hover:bg-slate-800' : 'hover:bg-gray-50'),\n            \"transition-colors\",\n            className\n        )}>\n            {children}\n        </div>\n    );\n}\n\n/**\n * Texte avec variantes de couleur selon le th√®me\n */\nexport function ThemedText({\n    children,\n    variant = \"primary\",\n    className = \"\",\n    as: Component = \"span\"\n}: {\n    children: ReactNode;\n    variant?: \"primary\" | \"secondary\" | \"muted\";\n    className?: string;\n    as?: \"span\" | \"p\" | \"h1\" | \"h2\" | \"h3\" | \"h4\" | \"div\";\n}) {\n    const { isDark } = useTheme();\n\n    const colorClasses = {\n        primary: isDark ? 'text-white' : 'text-gray-900',\n        secondary: isDark ? 'text-white/80' : 'text-gray-700',\n        muted: isDark ? 'text-white/60' : 'text-gray-500'\n    };\n\n    return (\n        <Component className={cn(colorClasses[variant], className)}>\n            {children}\n        </Component>\n    );\n}\n\n/**\n * Empty State avec th√®me adapt√©\n */\nexport function ThemedEmptyState({\n    icon: Icon,\n    title,\n    description,\n    action\n}: {\n    icon: any;\n    title: string;\n    description: string;\n    action?: ReactNode;\n}) {\n    const { isDark } = useTheme();\n\n    return (\n        <ThemedCard className=\"p-12 text-center\">\n            <div className={cn(\n                \"w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4\",\n                isDark ? 'bg-slate-800' : 'bg-gray-100'\n            )}>\n                <Icon className={cn(\n                    \"w-8 h-8\",\n                    isDark ? 'text-slate-600' : 'text-gray-400'\n                )} />\n            </div>\n            <ThemedText as=\"h3\" variant=\"primary\" className=\"text-lg font-medium mb-2\">\n                {title}\n            </ThemedText>\n            <ThemedText as=\"p\" variant=\"muted\" className=\"text-sm max-w-md mx-auto mb-6\">\n                {description}\n            </ThemedText>\n            {action}\n        </ThemedCard>\n    );\n}\n\n/**\n * Badge avec couleur de fond adapt√©e au th√®me\n */\nexport function ThemedBadge({\n    children,\n    variant = \"default\",\n    className = \"\"\n}: {\n    children: ReactNode;\n    variant?: \"default\" | \"success\" | \"warning\" | \"danger\";\n    className?: string;\n}) {\n    const { isDark } = useTheme();\n\n    const variantClasses = {\n        default: isDark\n            ? 'bg-slate-500/20 text-slate-300'\n            : 'bg-gray-200 text-gray-700',\n        success: isDark\n            ? 'bg-emerald-500/20 text-emerald-300'\n            : 'bg-emerald-100 text-emerald-700',\n        warning: isDark\n            ? 'bg-amber-500/20 text-amber-300'\n            : 'bg-amber-100 text-amber-700',\n        danger: isDark\n            ? 'bg-red-500/20 text-red-300'\n            : 'bg-red-100 text-red-700'\n    };\n\n    return (\n        <span className={cn(\n            \"inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium\",\n            variantClasses[variant],\n            className\n        )}>\n            {children}\n        </span>\n    );\n}\n\n/**\n * Header de section avec titre et action\n */\nexport function ThemedSectionHeader({\n    title,\n    subtitle,\n    action\n}: {\n    title: string;\n    subtitle?: string;\n    action?: ReactNode;\n}) {\n    return (\n        <div className=\"flex items-center justify-between\">\n            <div>\n                <ThemedText as=\"h1\" variant=\"primary\" className=\"text-2xl font-semibold\">\n                    {title}\n                </ThemedText>\n                {subtitle && (\n                    <ThemedText as=\"p\" variant=\"muted\" className=\"text-sm mt-1\">\n                        {subtitle}\n                    </ThemedText>\n                )}\n            </div>\n            {action && <div className=\"flex gap-2\">{action}</div>}\n        </div>\n    );\n}\n\n/**\n * Alert/Message box avec th√®me adapt√©\n */\nexport function ThemedAlert({\n    children,\n    variant = \"info\",\n    className = \"\"\n}: {\n    children: ReactNode;\n    variant?: \"info\" | \"success\" | \"warning\" | \"error\";\n    className?: string;\n}) {\n    const { isDark } = useTheme();\n\n    const variantClasses = {\n        info: isDark\n            ? 'bg-blue-500/10 border-blue-500/30 text-blue-300'\n            : 'bg-blue-50 border-blue-200 text-blue-700',\n        success: isDark\n            ? 'bg-green-500/10 border-green-500/30 text-green-300'\n            : 'bg-green-50 border-green-200 text-green-700',\n        warning: isDark\n            ? 'bg-amber-500/10 border-amber-500/30 text-amber-300'\n            : 'bg-amber-50 border-amber-200 text-amber-700',\n        error: isDark\n            ? 'bg-red-500/10 border-red-500/30 text-red-300'\n            : 'bg-red-50 border-red-200 text-red-700'\n    };\n\n    return (\n        <div className={cn(\n            \"border rounded-xl p-4\",\n            variantClasses[variant],\n            className\n        )}>\n            {children}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\activer-gestion\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\activer-gestion\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1286,1289],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1286,1289],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useRef } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { motion } from 'framer-motion';\nimport { Building2, Upload, FileCheck, Loader2, CheckCircle, Clock, AlertCircle } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Label } from '@/components/ui/label';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { toast } from 'sonner';\nimport { submitActivationRequest, getActivationStatus } from './actions';\nimport { createClient } from '@/utils/supabase/client';\nimport { useEffect } from 'react';\n\nexport default function ActiverGestionPage() {\n    const router = useRouter();\n    const [isLoading, setIsLoading] = useState(false);\n    const [status, setStatus] = useState<'inactive' | 'pending' | 'approved' | 'rejected'>('inactive');\n    const [identityDoc, setIdentityDoc] = useState<File | null>(null);\n    const [propertyDoc, setPropertyDoc] = useState<File | null>(null);\n    const identityRef = useRef<HTMLInputElement>(null);\n    const propertyRef = useRef<HTMLInputElement>(null);\n\n    useEffect(() => {\n        async function checkStatus() {\n            const result = await getActivationStatus();\n            setStatus(result.status as any);\n        }\n        checkStatus();\n    }, []);\n\n    const uploadFile = async (file: File, path: string) => {\n        const supabase = createClient();\n        const { _data, error } = await supabase.storage\n            .from('gestion-locative-docs')\n            .upload(path, file, { upsert: true });\n\n        if (error) throw error;\n\n        const { data: { publicUrl } } = supabase.storage\n            .from('gestion-locative-docs')\n            .getPublicUrl(path);\n\n        return publicUrl;\n    };\n\n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault();\n        if (!identityDoc || !propertyDoc) {\n            toast.error('Veuillez fournir tous les documents requis');\n            return;\n        }\n\n        setIsLoading(true);\n        try {\n            const supabase = createClient();\n            const { data: { user } } = await supabase.auth.getUser();\n            if (!user) throw new Error('Non authentifi√©');\n\n            // Upload documents\n            const identityUrl = await uploadFile(\n                identityDoc,\n                `${user.id}/identity_${Date.now()}.${identityDoc.name.split('.').pop()}`\n            );\n            const propertyUrl = await uploadFile(\n                propertyDoc,\n                `${user.id}/property_${Date.now()}.${propertyDoc.name.split('.').pop()}`\n            );\n\n            // Submit request\n            const result = await submitActivationRequest({\n                identityDocumentUrl: identityUrl,\n                propertyProofUrl: propertyUrl,\n            });\n\n            if (result.error) {\n                toast.error(result.error);\n                return;\n            }\n\n            toast.success('Demande soumise ! Nous examinerons vos documents sous 24-48h.');\n            setStatus('pending');\n        } catch (error) {\n            console.error(error);\n            toast.error('Une erreur est survenue lors de l\\'envoi');\n        } finally {\n            setIsLoading(false);\n        }\n    };\n\n    // Status display components\n    if (status === 'pending') {\n        return (\n            <div className=\"min-h-screen bg-slate-950 py-8 px-4\">\n                <div className=\"max-w-lg mx-auto text-center\">\n                    <motion.div\n                        initial={{ opacity: 0, scale: 0.9 }}\n                        animate={{ opacity: 1, scale: 1 }}\n                        className=\"bg-zinc-900 border border-zinc-800 rounded-2xl p-8\"\n                    >\n                        <Clock className=\"w-16 h-16 text-amber-400 mx-auto mb-4\" />\n                        <h1 className=\"text-2xl font-bold text-white mb-2\">Demande en cours d&apos;examen</h1>\n                        <p className=\"text-zinc-400 mb-6\">\n                            Votre demande d&apos;activation est en cours de v√©rification par notre √©quipe.\n                            Vous recevrez une notification d√®s qu&apos;elle sera trait√©e.\n                        </p>\n                        <Button variant=\"outline\" onClick={() => router.push('/compte')}>\n                            Retour au compte\n                        </Button>\n                    </motion.div>\n                </div>\n            </div>\n        );\n    }\n\n    if (status === 'approved') {\n        return (\n            <div className=\"min-h-screen bg-slate-950 py-8 px-4\">\n                <div className=\"max-w-lg mx-auto text-center\">\n                    <motion.div\n                        initial={{ opacity: 0, scale: 0.9 }}\n                        animate={{ opacity: 1, scale: 1 }}\n                        className=\"bg-zinc-900 border border-green-500/30 rounded-2xl p-8\"\n                    >\n                        <CheckCircle className=\"w-16 h-16 text-green-400 mx-auto mb-4\" />\n                        <h1 className=\"text-2xl font-bold text-white mb-2\">Gestion Locative Activ√©e !</h1>\n                        <p className=\"text-zinc-400 mb-6\">\n                            Votre compte est maintenant activ√© pour la gestion locative.\n                        </p>\n                        <Button onClick={() => router.push('/gestion-locative')}>\n                            Acc√©der √† la Gestion Locative\n                        </Button>\n                    </motion.div>\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"min-h-screen bg-slate-950 py-8 px-4\">\n            <div className=\"max-w-lg mx-auto\">\n                <motion.div\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    transition={{ duration: 0.5 }}\n                >\n                    {/* Header */}\n                    <div className=\"text-center mb-8\">\n                        <div className=\"w-16 h-16 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4\">\n                            <Building2 className=\"w-8 h-8 text-amber-400\" />\n                        </div>\n                        <h1 className=\"text-2xl font-bold text-white mb-2\">\n                            Activer la Gestion Locative\n                        </h1>\n                        <p className=\"text-zinc-400\">\n                            Pour activer cette fonctionnalit√©, veuillez fournir les documents suivants.\n                        </p>\n                    </div>\n\n                    {/* Form */}\n                    <Card className=\"bg-zinc-900 border-zinc-800\">\n                        <CardHeader>\n                            <CardTitle className=\"text-lg text-white\">Documents requis</CardTitle>\n                            <CardDescription>\n                                Ces documents seront v√©rifi√©s par notre √©quipe sous 24-48h.\n                            </CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                            <form onSubmit={handleSubmit} className=\"space-y-6\">\n                                {/* Pi√®ce d'identit√© */}\n                                <div className=\"space-y-2\">\n                                    <Label className=\"text-zinc-300\">\n                                        Pi√®ce d&apos;identit√© *\n                                    </Label>\n                                    <input\n                                        type=\"file\"\n                                        ref={identityRef}\n                                        accept=\"image/*,.pdf\"\n                                        className=\"hidden\"\n                                        onChange={(e) => setIdentityDoc(e.target.files?.[0] || null)}\n                                    />\n                                    <div\n                                        onClick={() => identityRef.current?.click()}\n                                        className={`border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors ${identityDoc\n                                                ? 'border-green-500/50 bg-green-500/10'\n                                                : 'border-zinc-700 hover:border-zinc-600'\n                                            }`}\n                                    >\n                                        {identityDoc ? (\n                                            <div className=\"flex items-center justify-center gap-2 text-green-400\">\n                                                <FileCheck className=\"w-5 h-5\" />\n                                                <span>{identityDoc.name}</span>\n                                            </div>\n                                        ) : (\n                                            <div className=\"text-zinc-500\">\n                                                <Upload className=\"w-8 h-8 mx-auto mb-2\" />\n                                                <p>CNI, Passeport ou Permis de conduire</p>\n                                            </div>\n                                        )}\n                                    </div>\n                                </div>\n\n                                {/* Justificatif propri√©t√© */}\n                                <div className=\"space-y-2\">\n                                    <Label className=\"text-zinc-300\">\n                                        Justificatif de propri√©t√© *\n                                    </Label>\n                                    <input\n                                        type=\"file\"\n                                        ref={propertyRef}\n                                        accept=\"image/*,.pdf\"\n                                        className=\"hidden\"\n                                        onChange={(e) => setPropertyDoc(e.target.files?.[0] || null)}\n                                    />\n                                    <div\n                                        onClick={() => propertyRef.current?.click()}\n                                        className={`border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors ${propertyDoc\n                                                ? 'border-green-500/50 bg-green-500/10'\n                                                : 'border-zinc-700 hover:border-zinc-600'\n                                            }`}\n                                    >\n                                        {propertyDoc ? (\n                                            <div className=\"flex items-center justify-center gap-2 text-green-400\">\n                                                <FileCheck className=\"w-5 h-5\" />\n                                                <span>{propertyDoc.name}</span>\n                                            </div>\n                                        ) : (\n                                            <div className=\"text-zinc-500\">\n                                                <Upload className=\"w-8 h-8 mx-auto mb-2\" />\n                                                <p>Titre foncier, Acte de vente, Bail ou Attestation</p>\n                                            </div>\n                                        )}\n                                    </div>\n                                </div>\n\n                                {/* Info */}\n                                <div className=\"bg-zinc-800/50 rounded-lg p-4 flex gap-3\">\n                                    <AlertCircle className=\"w-5 h-5 text-amber-400 shrink-0 mt-0.5\" />\n                                    <p className=\"text-sm text-zinc-400\">\n                                        Vos documents sont trait√©s de mani√®re confidentielle et ne seront utilis√©s\n                                        que pour v√©rifier votre identit√© et votre qualit√© de propri√©taire.\n                                    </p>\n                                </div>\n\n                                {/* Submit */}\n                                <Button\n                                    type=\"submit\"\n                                    className=\"w-full\"\n                                    disabled={isLoading || !identityDoc || !propertyDoc}\n                                >\n                                    {isLoading ? (\n                                        <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n                                    ) : (\n                                        <Upload className=\"w-4 h-4 mr-2\" />\n                                    )}\n                                    Soumettre ma demande\n                                </Button>\n                            </form>\n                        </CardContent>\n                    </Card>\n                </motion.div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\alertes\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\alertes\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadAlerts' and 'loadPreferences'. Either include them or remove the dependency array.","line":91,"column":6,"nodeType":"ArrayExpression","endLine":91,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [user, authLoading, router, loadAlerts, loadPreferences]","fix":{"range":[2333,2360],"text":"[user, authLoading, router, loadAlerts, loadPreferences]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { motion, _AnimatePresence } from \"framer-motion\";\nimport {\n  Bell,\n  ArrowLeft,\n  Settings,\n  Plus,\n  Search,\n  _X,\n  _MapPin,\n  _DollarSign,\n  _Home,\n  Filter,\n  Trash2,\n  _Check,\n  ToggleLeft,\n  ToggleRight,\n} from \"lucide-react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport { WorkspaceSwitch as Switch } from \"@/components/ui/workspace-switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { useNotifications } from \"@/hooks/use-notifications\";\nimport { _NotificationBell } from \"@/components/layout/notification-bell\";\nimport { FadeIn } from \"@/components/ui/motion-wrapper\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport { toast } from \"sonner\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { deleteSearchAlert, updateSearchAlert } from \"./actions\";\n\ninterface SearchAlert {\n  id: string;\n  user_id: string;\n  name: string;\n  filters: {\n    category?: \"vente\" | \"location\";\n    city?: string;\n    minPrice?: number;\n    maxPrice?: number;\n    rooms?: number;\n    bedrooms?: number;\n    type?: \"Appartement\" | \"Maison\" | \"Studio\";\n  };\n  is_active: boolean;\n  created_at: string;\n}\n\ninterface NotificationPreferences {\n  new_properties: boolean;\n  property_updates: boolean;\n  price_drops: boolean;\n  matching_alerts: boolean;\n}\n\nexport default function AlertesPage() {\n  const { user, loading: authLoading } = useAuth();\n  const router = useRouter();\n  const { notifications, unreadCount, loading: notificationsLoading } = useNotifications(user?.id || null);\n  const [alerts, setAlerts] = useState<SearchAlert[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [_showCreateAlert, _setShowCreateAlert] = useState(false);\n  const [preferences, setPreferences] = useState<NotificationPreferences>({\n    new_properties: true,\n    property_updates: true,\n    price_drops: true,\n    matching_alerts: true,\n  });\n\n  useEffect(() => {\n    if (authLoading) return;\n\n    if (!user) {\n      router.push(\"/login\");\n      return;\n    }\n\n    loadAlerts();\n    loadPreferences();\n  }, [user, authLoading, router]);\n\n  const loadAlerts = async () => {\n    if (!user) return;\n\n    try {\n      const supabase = createClient();\n      const { data, error } = await supabase\n        .from(\"search_alerts\")\n        .select(\"*\")\n        .eq(\"user_id\", user.id)\n        .order(\"created_at\", { ascending: false });\n\n      // Si la table n'existe pas, utiliser un tableau vide (silencieux)\n      if (error) {\n        if (error.code === \"PGRST116\" || error.message?.includes(\"does not exist\")) {\n          setAlerts([]);\n          return;\n        }\n        // Erreur de permission ou autre - utiliser un tableau vide (silencieux)\n        setAlerts([]);\n        return;\n      }\n\n      setAlerts(data || []);\n    } catch (_error) {\n      // Erreur silencieuse - utiliser un tableau vide\n      // Ne pas logger car c'est normal si la table n'existe pas\n      setAlerts([]);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadPreferences = async () => {\n    if (!user) return;\n\n    try {\n      const { getNotificationPreferences } = await import(\"./actions\");\n      const result = await getNotificationPreferences();\n\n      if (result.error) {\n        // Erreur silencieuse - utiliser les valeurs par d√©faut\n        return;\n      }\n\n      if (result.data) {\n        setPreferences(result.data);\n      }\n      // Sinon, les valeurs par d√©faut sont d√©j√† d√©finies\n    } catch (_error) {\n      // Erreur silencieuse - utiliser les valeurs par d√©faut\n      // Ne pas logger car c'est normal si la table n'existe pas\n    }\n  };\n\n  const savePreferences = async (newPreferences: NotificationPreferences) => {\n    if (!user) return;\n\n    try {\n      const { saveNotificationPreferences } = await import(\"./actions\");\n      const result = await saveNotificationPreferences(newPreferences);\n\n      if (result.error) {\n        toast.error(\"Erreur\", {\n          description: result.error,\n        });\n        return;\n      }\n\n      setPreferences(newPreferences);\n      toast.success(\"Pr√©f√©rences mises √† jour\");\n    } catch (error) {\n      console.error(\"Error saving preferences:\", error);\n      toast.error(\"Erreur lors de la sauvegarde des pr√©f√©rences\");\n    }\n  };\n\n  const togglePreference = (key: keyof NotificationPreferences) => {\n    const newPreferences = { ...preferences, [key]: !preferences[key] };\n    savePreferences(newPreferences);\n  };\n\n  const deleteAlert = async (alertId: string) => {\n    try {\n      const result = await deleteSearchAlert(alertId);\n\n      if (result.error) {\n        toast.error(\"Erreur\", {\n          description: result.error,\n        });\n        return;\n      }\n\n      setAlerts((prev) => prev.filter((a) => a.id !== alertId));\n      toast.success(\"Alerte supprim√©e\");\n    } catch (error) {\n      console.error(\"Error deleting alert:\", error);\n      toast.error(\"Erreur lors de la suppression de l'alerte\");\n    }\n  };\n\n  const toggleAlert = async (alert: SearchAlert) => {\n    try {\n      const result = await updateSearchAlert(alert.id, {\n        is_active: !alert.is_active,\n      });\n\n      if (result.error) {\n        toast.error(\"Erreur\", {\n          description: result.error,\n        });\n        return;\n      }\n\n      setAlerts((prev) =>\n        prev.map((a) => (a.id === alert.id ? { ...a, is_active: !a.is_active } : a))\n      );\n      toast.success(`Alerte ${!alert.is_active ? \"activ√©e\" : \"d√©sactiv√©e\"}`);\n    } catch (error) {\n      console.error(\"Error toggling alert:\", error);\n      toast.error(\"Erreur lors de la modification de l'alerte\");\n    }\n  };\n\n  const formatAlertFilters = (filters: SearchAlert[\"filters\"]) => {\n    const parts: string[] = [];\n    if (filters.category) parts.push(filters.category === \"vente\" ? \"Achat\" : \"Location\");\n    if (filters.city) parts.push(filters.city);\n    if (filters.minPrice || filters.maxPrice) {\n      const priceRange = [filters.minPrice, filters.maxPrice].filter(Boolean).join(\" - \");\n      parts.push(`${priceRange} FCFA`);\n    }\n    if (filters.type) parts.push(filters.type);\n    if (filters.rooms) parts.push(`${filters.rooms} pi√®ces`);\n    if (filters.bedrooms) parts.push(`${filters.bedrooms} chambres`);\n    return parts.join(\" ‚Ä¢ \") || \"Aucun filtre\";\n  };\n\n  const formatTimeAgo = (dateString: string) => {\n    try {\n      const result = formatDistanceToNow(new Date(dateString), {\n        addSuffix: true,\n      });\n      // Traduire les termes de base en fran√ßais\n      return result\n        .replace(\"about \", \"\")\n        .replace(\"less than a minute ago\", \"√† l'instant\")\n        .replace(\"minute ago\", \"minute\")\n        .replace(\"minutes ago\", \"minutes\")\n        .replace(\"hour ago\", \"heure\")\n        .replace(\"hours ago\", \"heures\")\n        .replace(\"day ago\", \"jour\")\n        .replace(\"days ago\", \"jours\")\n        .replace(\"month ago\", \"mois\")\n        .replace(\"months ago\", \"mois\")\n        .replace(\"year ago\", \"an\")\n        .replace(\"years ago\", \"ans\")\n        .replace(\" ago\", \"\");\n    } catch {\n      return \"R√©cemment\";\n    }\n  };\n\n  if (authLoading || loading) {\n    return (\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\n        <div className=\"text-muted-foreground\">Chargement...</div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return null;\n  }\n\n  return (\n    <div className=\"px-4 md:px-6 lg:px-8 space-y-6 py-6\">\n      <FadeIn>\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-4\">\n            <Link href=\"/compte\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"text-muted-foreground hover:text-foreground hover:bg-accent\"\n              >\n                <ArrowLeft className=\"h-5 w-5\" />\n              </Button>\n            </Link>\n            <div>\n              <h1 className=\"text-2xl font-bold text-foreground\">Mes Alertes</h1>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                G√©rez vos notifications et alertes de recherche\n              </p>\n            </div>\n          </div>\n        </div>\n\n        {/* Notifications r√©centes */}\n        <Card className=\"border-border bg-card backdrop-blur-sm\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <CardTitle className=\"text-foreground\">Notifications r√©centes</CardTitle>\n                <CardDescription className=\"text-muted-foreground\">\n                  {unreadCount > 0 ? `${unreadCount} non lue${unreadCount > 1 ? \"s\" : \"\"}` : \"Aucune nouvelle notification\"}\n                </CardDescription>\n              </div>\n              {notifications.length > 0 && (\n                <Link href=\"/compte/alertes#notifications\">\n                  <Button\n                    size=\"sm\"\n                    className=\"bg-[#0F172A] text-white hover:bg-[#0F172A]/90 dark:bg-[#F4C430] dark:text-black dark:hover:bg-[#F4C430]/90\"\n                  >\n                    Voir tout\n                  </Button>\n                </Link>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent>\n            {notificationsLoading ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <div className=\"h-6 w-6 animate-spin rounded-full border-2 border-primary/20 border-t-primary\" />\n              </div>\n            ) : notifications.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n                <Bell className=\"h-12 w-12 text-muted-foreground/20 mb-4\" />\n                <p className=\"text-muted-foreground\">Aucune notification</p>\n                <p className=\"text-sm text-muted-foreground/60 mt-2\">\n                  Vous serez notifi√© quand de nouveaux biens correspondent √† vos crit√®res\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {notifications.slice(0, 3).map((notification) => (\n                  <div\n                    key={notification.id}\n                    className={`rounded-lg border p-3 transition-colors ${!notification.is_read\n                      ? \"border-primary/20 bg-primary/5\"\n                      : \"border-border bg-card/50 opacity-60\"\n                      }`}\n                  >\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <p className={`text-sm font-medium ${!notification.is_read ? \"text-foreground\" : \"text-muted-foreground\"}`}>\n                          {notification.title}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground mt-1 line-clamp-2\">\n                          {notification.message}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground mt-2 font-medium\">\n                          {formatTimeAgo(notification.created_at)}\n                        </p>\n                      </div>\n                      {!notification.is_read && (\n                        <div className=\"h-2 w-2 rounded-full bg-primary ml-3 mt-1\" />\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Alertes de recherche */}\n        <Card className=\"border-border bg-card backdrop-blur-sm\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <CardTitle className=\"text-foreground\">Alertes de recherche</CardTitle>\n                <CardDescription className=\"text-muted-foreground\">\n                  Cr√©ez des alertes pour √™tre notifi√© des nouveaux biens correspondant √† vos crit√®res\n                </CardDescription>\n              </div>\n              <Button\n                onClick={() => {\n                  router.push(\"/recherche?alert=create\");\n                }}\n                className=\"bg-[#0F172A] text-white hover:bg-[#0F172A]/90 dark:bg-[#F4C430] dark:text-black dark:hover:bg-[#F4C430]/90\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Nouvelle alerte\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {alerts.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n                <Search className=\"h-12 w-12 text-muted-foreground/20 mb-4\" />\n                <p className=\"text-muted-foreground\">Aucune alerte de recherche</p>\n                <p className=\"text-sm text-muted-foreground/60 mt-2\">\n                  Cr√©ez une alerte pour √™tre notifi√© automatiquement des nouveaux biens\n                </p>\n                <Button\n                  onClick={() => router.push(\"/recherche?alert=create\")}\n                  className=\"mt-4 bg-[#0F172A] text-white hover:bg-[#0F172A]/90 dark:bg-[#F4C430] dark:text-black dark:hover:bg-[#F4C430]/90\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Cr√©er ma premi√®re alerte\n                </Button>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {alerts.map((alert) => (\n                  <motion.div\n                    key={alert.id}\n                    initial={{ opacity: 0, y: 10 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    className=\"rounded-lg border border-border bg-card/50 p-4\"\n                  >\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-2 mb-2\">\n                          <h4 className=\"font-semibold text-foreground\">{alert.name}</h4>\n                          <Badge\n                            variant={alert.is_active ? \"default\" : \"secondary\"}\n                            className={alert.is_active ? \"bg-amber-500 text-black dark:bg-amber-500 dark:text-black\" : \"bg-muted text-muted-foreground\"}\n                          >\n                            {alert.is_active ? \"Active\" : \"Inactive\"}\n                          </Badge>\n                        </div>\n                        <div className=\"flex flex-wrap items-center gap-2 text-sm text-muted-foreground mb-3\">\n                          <Filter className=\"h-4 w-4\" />\n                          <span>{formatAlertFilters(alert.filters)}</span>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground font-medium\">\n                          Cr√©√©e {formatTimeAgo(alert.created_at)}\n                        </p>\n                      </div>\n                      <div className=\"flex items-center gap-2 ml-4\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => toggleAlert(alert)}\n                          className=\"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        >\n                          {alert.is_active ? (\n                            <ToggleRight className=\"h-5 w-5\" />\n                          ) : (\n                            <ToggleLeft className=\"h-5 w-5\" />\n                          )}\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => deleteAlert(alert.id)}\n                          className=\"text-red-500/60 hover:text-red-600 hover:bg-red-500/10\"\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </motion.div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Param√®tres d'alertes */}\n        <Card className=\"border-border bg-card backdrop-blur-sm\">\n          <CardHeader>\n            <CardTitle className=\"text-foreground flex items-center gap-2\">\n              <Settings className=\"h-5 w-5\" />\n              Param√®tres de notifications\n            </CardTitle>\n            <CardDescription className=\"text-muted-foreground\">\n              Configurez vos pr√©f√©rences de notifications\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between rounded-lg border border-border bg-card/50 p-4\">\n              <div className=\"flex-1\">\n                <p className=\"text-sm font-medium text-foreground\">Nouveaux biens</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Recevez une notification pour chaque nouveau bien publi√©\n                </p>\n              </div>\n              <Switch\n                checked={preferences.new_properties}\n                onCheckedChange={() => togglePreference(\"new_properties\")}\n              />\n            </div>\n\n            <div className=\"flex items-center justify-between rounded-lg border border-border bg-card/50 p-4\">\n              <div className=\"flex-1\">\n                <p className=\"text-sm font-medium text-foreground\">Mises √† jour de vos annonces</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Alertes sur l&apos;√©tat de vos biens d√©pos√©s (approuv√©, refus√©, etc.)\n                </p>\n              </div>\n              <Switch\n                checked={preferences.property_updates}\n                onCheckedChange={() => togglePreference(\"property_updates\")}\n              />\n            </div>\n\n            <div className=\"flex items-center justify-between rounded-lg border border-border bg-card/50 p-4\">\n              <div className=\"flex-1\">\n                <p className=\"text-sm font-medium text-foreground\">Baisse de prix</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Soyez notifi√© quand un bien de vos favoris baisse de prix\n                </p>\n              </div>\n              <Switch\n                checked={preferences.price_drops}\n                onCheckedChange={() => togglePreference(\"price_drops\")}\n              />\n            </div>\n\n            <div className=\"flex items-center justify-between rounded-lg border border-border bg-card/50 p-4\">\n              <div className=\"flex-1\">\n                <p className=\"text-sm font-medium text-foreground\">Alertes de recherche</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Notifications quand de nouveaux biens correspondent √† vos alertes de recherche\n                </p>\n              </div>\n              <Switch\n                checked={preferences.matching_alerts}\n                onCheckedChange={() => togglePreference(\"matching_alerts\")}\n              />\n            </div>\n          </CardContent>\n        </Card>\n      </FadeIn>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\biens\\[id]\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperty'. Either include it or remove the dependency array.","line":75,"column":6,"nodeType":"ArrayExpression","endLine":75,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [user, authLoading, loadProperty]","fix":{"range":[2564,2583],"text":"[user, authLoading, loadProperty]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperty'. Either include it or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [user, authLoading, propertyId, loadProperty]","fix":{"range":[2039,2070],"text":"[user, authLoading, propertyId, loadProperty]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { useRouter, useParams } from \"next/navigation\";\nimport Link from \"next/link\";\nimport Image from \"next/image\";\nimport { ArrowLeft, AlertCircle, CheckCircle2, Clock } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { motion } from \"framer-motion\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport { VerificationUploadForm } from \"@/components/dashboard/verification-upload-form\";\nimport { VerificationStatusBadge } from \"@/components/dashboard/verification-status-badge\";\nimport type { Property } from \"@/types/property\";\n\ntype PropertyWithVerification = Property & {\n  verification_status: \"pending\" | \"verified\" | \"rejected\" | null;\n  proof_document_url?: string | null;\n  verification_rejection_reason?: string | null;\n  verification_requested_at?: string | null;\n};\n\nexport default function PropertyDetailPage() {\n  const router = useRouter();\n  const params = useParams();\n  const propertyId = params.id as string;\n  const { user, loading: authLoading } = useAuth();\n  const [loading, setLoading] = useState(true);\n  const [property, setProperty] = useState<PropertyWithVerification | null>(null);\n\n  const loadProperty = async () => {\n    if (!user || !propertyId) return;\n\n    const supabase = createClient();\n    const { data, error } = await supabase\n      .from(\"properties\")\n      .select(\"*\")\n      .eq(\"id\", propertyId)\n      .eq(\"owner_id\", user.id)\n      .single();\n\n    if (error || !data) {\n      toast.error(\"Bien introuvable ou acc√®s non autoris√©\");\n      router.push(\"/compte/mes-biens\");\n      return;\n    }\n\n    setProperty(data as PropertyWithVerification);\n    setLoading(false);\n  };\n\n  useEffect(() => {\n    if (user && !authLoading) {\n      loadProperty();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [user, authLoading, propertyId]);\n\n  // Recharger la page apr√®s une soumission r√©ussie\n  // On utilise un listener pour d√©tecter les changements de route\n  useEffect(() => {\n    const handleFocus = () => {\n      // Recharger les donn√©es quand la fen√™tre redevient active\n      // (utile apr√®s une redirection ou un refresh)\n      if (user && !authLoading) {\n        loadProperty();\n      }\n    };\n    \n    window.addEventListener(\"focus\", handleFocus);\n    return () => window.removeEventListener(\"focus\", handleFocus);\n  }, [user, authLoading]);\n\n  if (authLoading || loading) {\n    return (\n      <div className=\"flex min-h-[60vh] items-center justify-center\">\n        <div className=\"text-white/70\">Chargement...</div>\n      </div>\n    );\n  }\n\n  if (!property) {\n    return null;\n  }\n\n  const verificationStatus = property.verification_status || null;\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat(\"fr-FR\", {\n      maximumFractionDigits: 0,\n    }).format(price);\n  };\n\n  return (\n    <div className=\"space-y-6 pb-10\">\n      {/* Header avec bouton retour */}\n      <div className=\"flex items-center justify-between\">\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={() => router.push(\"/compte/mes-biens\")}\n          className=\"text-white/70 hover:text-white\"\n        >\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Retour √† mes biens\n        </Button>\n        <Link href={`/compte/biens/edit/${propertyId}`}>\n          <Button variant=\"secondary\" size=\"sm\">\n            Modifier\n          </Button>\n        </Link>\n      </div>\n\n      {/* Titre du bien */}\n      <div>\n        <h1 className=\"text-3xl font-semibold text-white\">{property.title}</h1>\n        <p className=\"mt-2 text-lg text-white/70\">\n          {formatPrice(property.price)} FCFA\n        </p>\n      </div>\n\n      {/* Image principale */}\n      {property.images && property.images[0] && (\n        <div className=\"relative h-[400px] w-full overflow-hidden rounded-2xl\">\n          <Image\n            src={property.images[0]}\n            alt={property.title}\n            fill\n            className=\"object-cover\"\n            sizes=\"(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px\"\n            priority\n          />\n        </div>\n      )}\n\n      {/* Informations principales */}\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <CardTitle className=\"text-white\">Informations principales</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm text-white/60\">Type</p>\n              <p className=\"text-white\">{property.details?.type || \"Non sp√©cifi√©\"}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-white/60\">Surface</p>\n              <p className=\"text-white\">{property.specs?.surface} m¬≤</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-white/60\">Pi√®ces</p>\n              <p className=\"text-white\">\n                {property.specs?.rooms} pi√®ce{property.specs?.rooms && property.specs.rooms > 1 ? \"s\" : \"\"}\n                {property.specs?.bedrooms && ` ‚Ä¢ ${property.specs.bedrooms} chambre${property.specs.bedrooms > 1 ? \"s\" : \"\"}`}\n              </p>\n            </div>\n            <div>\n              <p className=\"text-sm text-white/60\">Localisation</p>\n              <p className=\"text-white\">\n                {property.location.city}\n                {property.location.address && `, ${property.location.address}`}\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <CardTitle className=\"text-white\">Statut de publication</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm text-white/60\">Statut</p>\n              <p className=\"text-white capitalize\">\n                {property.status || \"disponible\"}\n              </p>\n            </div>\n            <div>\n              <p className=\"text-sm text-white/60\">Transaction</p>\n              <p className=\"text-white capitalize\">{property.transaction}</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Section V√©rification du Bien */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.3 }}\n      >\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <CardTitle className=\"text-white\">V√©rification du bien</CardTitle>\n                <CardDescription className=\"text-white/60\">\n                  Certifiez votre bien pour plus de visibilit√©\n                </CardDescription>\n              </div>\n              {verificationStatus && (\n                <VerificationStatusBadge status={verificationStatus} />\n              )}\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Statut: verified */}\n            {verificationStatus === \"verified\" && (\n              <div className=\"flex items-start gap-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20 p-4\">\n                <CheckCircle2 className=\"h-5 w-5 text-emerald-400 mt-0.5 flex-shrink-0\" />\n                <div className=\"flex-1\">\n                  <p className=\"font-medium text-emerald-300\">\n                    Votre bien est v√©rifi√© et certifi√©\n                  </p>\n                  <p className=\"mt-1 text-sm text-emerald-200/80\">\n                    Votre bien est certifi√© et mis en avant sur la plateforme. Les utilisateurs\n                    peuvent faire confiance √† votre annonce.\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {/* Statut: pending */}\n            {verificationStatus === \"pending\" && (\n              <div className=\"flex items-start gap-3 rounded-lg bg-amber-500/10 border border-amber-500/20 p-4\">\n                <Clock className=\"h-5 w-5 text-amber-400 mt-0.5 flex-shrink-0\" />\n                <div className=\"flex-1\">\n                  <p className=\"font-medium text-amber-300\">\n                    V√©rification en cours\n                  </p>\n                  <p className=\"mt-1 text-sm text-amber-200/80\">\n                    Nos √©quipes analysent votre document. Vous serez notifi√© d√®s que la v√©rification\n                    sera termin√©e.\n                  </p>\n                  {property.verification_requested_at && (\n                    <p className=\"mt-2 text-xs text-amber-200/60\">\n                      Demande soumise le{\" \"}\n                      {new Date(property.verification_requested_at).toLocaleDateString(\"fr-FR\", {\n                        day: \"numeric\",\n                        month: \"long\",\n                        year: \"numeric\",\n                        hour: \"2-digit\",\n                        minute: \"2-digit\",\n                      })}\n                    </p>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {/* Statut: rejected */}\n            {verificationStatus === \"rejected\" && (\n              <div className=\"flex items-start gap-3 rounded-lg bg-red-500/10 border border-red-500/20 p-4\">\n                <AlertCircle className=\"h-5 w-5 text-red-400 mt-0.5 flex-shrink-0\" />\n                <div className=\"flex-1\">\n                  <p className=\"font-medium text-red-300\">\n                    V√©rification refus√©e\n                  </p>\n                  {property.verification_rejection_reason && (\n                    <p className=\"mt-2 text-sm text-red-200/90 bg-red-500/10 rounded-lg p-3 border border-red-500/20\">\n                      <span className=\"font-medium\">Raison :</span> {property.verification_rejection_reason}\n                    </p>\n                  )}\n                  <p className=\"mt-2 text-sm text-red-200/80\">\n                    Vous pouvez soumettre un nouveau document pour relancer la v√©rification.\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {/* Statut: null (aucune v√©rification) */}\n            {verificationStatus === null && (\n              <div className=\"rounded-lg bg-white/5 border border-white/10 p-4\">\n                <p className=\"text-sm text-white/70\">\n                  Soumettez un document de preuve de propri√©t√© pour certifier votre bien. Les biens\n                  v√©rifi√©s b√©n√©ficient d&apos;une meilleure visibilit√© et de la confiance des utilisateurs.\n                </p>\n              </div>\n            )}\n\n            {/* Formulaire d'upload - Affich√© uniquement si verified, rejected ou null */}\n            {(verificationStatus === null || verificationStatus === \"rejected\") && (\n              <div className=\"mt-4\">\n                <VerificationUploadForm\n                  propertyId={property.id}\n                  currentStatus={verificationStatus}\n                  proofDocumentUrl={property.proof_document_url}\n                />\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Description */}\n      {property.description && (\n        <Card className=\"border-white/10 bg-white/5\">\n          <CardHeader>\n            <CardTitle className=\"text-white\">Description</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-white/80 whitespace-pre-line\">{property.description}</p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\biens\\edit\\[id]\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\biens\\edit\\[id]\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":463,"column":17,"nodeType":"JSXOpeningElement","endLine":467,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\components\\GestionLocativeWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\components\\LegalAssistantWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\components\\OwnerDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\debug\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\debug\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\deposer\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\deposer\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'formData.contact_phone'. Either include it or remove the dependency array.","line":120,"column":6,"nodeType":"ArrayExpression","endLine":120,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [formData.contact_phone, user]","fix":{"range":[3564,3570],"text":"[formData.contact_phone, user]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'processImageFiles'. Either include it or remove the dependency array.","line":135,"column":6,"nodeType":"ArrayExpression","endLine":135,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [processImageFiles]","fix":{"range":[4030,4054],"text":"[processImageFiles]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useCallback, Suspense } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { toast } from \"sonner\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\nimport {\n  ArrowLeft,\n  ArrowRight,\n  Building2,\n  Home,\n  MapPin,\n  Ruler,\n  ImageIcon,\n  Send,\n  Loader2,\n  X,\n  Sparkles,\n  Check,\n  Upload,\n  Building,\n  TreePine,\n  Briefcase,\n  Store,\n  _ChevronDown,\n} from \"lucide-react\";\nimport { PhoneInput } from \"@/components/ui/phone-input\";\nimport { AddressAutocomplete } from \"@/components/forms/address-autocomplete\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport { submitUserListing, generateAIDescription } from \"./actions\";\nimport { smartGeocode } from \"@/lib/geocoding\";\nimport { scrollToTop } from \"@/lib/scroll-utils\";\n\n// Storage keys\nconst STORAGE_KEYS = {\n  formData: \"deposit_form_data_v3\",\n  images: \"deposit_form_images_v3\",\n  step: \"deposit_form_step_v3\",\n};\n\nconst PROPERTY_TYPES = [\n  { value: \"villa\", label: \"Villa\", icon: Home },\n  { value: \"appartement\", label: \"Appartement\", icon: Building },\n  { value: \"terrain\", label: \"Terrain\", icon: TreePine },\n  { value: \"immeuble\", label: \"Immeuble\", icon: Building2 },\n  { value: \"magasin\", label: \"Magasin\", icon: Store },\n  { value: \"bureau\", label: \"Bureau\", icon: Briefcase },\n];\n\nconst STEPS = [\n  { id: 1, title: \"L'essentiel\", icon: Building2 },\n  { id: 2, title: \"Localisation\", icon: MapPin },\n  { id: 3, title: \"D√©tails\", icon: Ruler },\n  { id: 4, title: \"M√©dia\", icon: ImageIcon },\n  { id: 5, title: \"Publication\", icon: Send },\n];\n\nfunction DeposerPageContent() {\n  const router = useRouter();\n  const { user, loading } = useAuth();\n\n  const [currentStep, setCurrentStep] = useState(1);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [uploadingImages, setUploadingImages] = useState(false);\n  const [dragActive, setDragActive] = useState(false);\n  const [isGeneratingAI, setIsGeneratingAI] = useState(false);\n\n  const [formData, setFormData] = useState({\n    type: \"appartement\",\n    category: \"location\" as \"vente\" | \"location\",\n    title: \"\",\n    price: \"\",\n    city: \"\",\n    district: \"\",\n    address: \"\",\n    landmark: \"\",\n    surface: \"\",\n    rooms: \"\",\n    bedrooms: \"\",\n    bathrooms: \"\",\n    description: \"\",\n    virtual_tour_url: \"\",\n    contact_phone: \"\",\n    images: [] as string[],\n  });\n\n  const updateField = (field: string, value: string | string[]) => {\n    setFormData((prev) => ({ ...prev, [field]: value }));\n  };\n\n  // Restore from localStorage\n  useEffect(() => {\n    if (typeof window === \"undefined\") return;\n    const stored = localStorage.getItem(STORAGE_KEYS.formData);\n    if (stored) {\n      try {\n        const data = JSON.parse(stored);\n        setFormData((prev) => ({ ...prev, ...data }));\n      } catch { }\n    }\n    const storedStep = localStorage.getItem(STORAGE_KEYS.step);\n    if (storedStep) setCurrentStep(parseInt(storedStep, 10) || 1);\n  }, []);\n\n  // Save to localStorage\n  useEffect(() => {\n    if (typeof window === \"undefined\" || isSubmitting) return;\n    localStorage.setItem(STORAGE_KEYS.formData, JSON.stringify(formData));\n    localStorage.setItem(STORAGE_KEYS.step, currentStep.toString());\n  }, [formData, currentStep, isSubmitting]);\n\n  // Pre-fill phone from profile\n  useEffect(() => {\n    if (user?.user_metadata?.phone && !formData.contact_phone) {\n      updateField(\"contact_phone\", user.user_metadata.phone);\n    }\n  }, [user]);\n\n  // Drag & Drop\n  const handleDrag = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setDragActive(e.type === \"dragenter\" || e.type === \"dragover\");\n  }, []);\n\n  const handleDrop = useCallback(async (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setDragActive(false);\n    const files = e.dataTransfer.files;\n    if (files?.length) await processImageFiles(Array.from(files));\n  }, [formData.images.length]);\n\n  const processImageFiles = async (fileArray: File[]) => {\n    if (formData.images.length + fileArray.length > 10) {\n      setError(\"Maximum 10 photos\");\n      return;\n    }\n    setUploadingImages(true);\n    setError(null);\n    try {\n      const supabase = createClient();\n      const uploadedUrls: string[] = [];\n      for (const file of fileArray) {\n        if (file.size > 5 * 1024 * 1024) continue;\n        const fileExt = file.name.split(\".\").pop()?.toLowerCase();\n        if (![\"jpg\", \"jpeg\", \"png\", \"webp\"].includes(fileExt || \"\")) continue;\n        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;\n        const { error: uploadError } = await supabase.storage\n          .from(\"properties\")\n          .upload(fileName, file, { cacheControl: \"3600\", upsert: false });\n        if (uploadError) throw uploadError;\n        const { data: { publicUrl } } = supabase.storage.from(\"properties\").getPublicUrl(fileName);\n        uploadedUrls.push(publicUrl);\n      }\n      setFormData((prev) => ({ ...prev, images: [...prev.images, ...uploadedUrls] }));\n      toast.success(`${uploadedUrls.length} photo(s) ajout√©e(s)`);\n    } catch (_err) {\n      setError(\"Erreur lors de l'upload\");\n    } finally {\n      setUploadingImages(false);\n    }\n  };\n\n  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (files?.length) await processImageFiles(Array.from(files));\n  };\n\n  const removeImage = (index: number) => {\n    setFormData((prev) => ({ ...prev, images: prev.images.filter((_, i) => i !== index) }));\n  };\n\n  // AI Description\n  const handleGenerateAI = async () => {\n    const isReady = currentStep >= 3 && formData.city && formData.price;\n    if (!isReady) {\n      setError(\"Renseignez au moins la ville et le prix.\");\n      return;\n    }\n    setIsGeneratingAI(true);\n    setError(null);\n    try {\n      const result = await generateAIDescription({\n        type: formData.type,\n        category: formData.category,\n        city: formData.city,\n        district: formData.district,\n        price: parseInt(formData.price),\n        surface: formData.surface ? parseInt(formData.surface) : undefined,\n        rooms: formData.rooms ? parseInt(formData.rooms) : undefined,\n        bedrooms: formData.bedrooms ? parseInt(formData.bedrooms) : undefined,\n        bathrooms: formData.bathrooms ? parseInt(formData.bathrooms) : undefined,\n      });\n      if (result.success && result.description) {\n        updateField(\"description\", result.description);\n        toast.success(\"Description g√©n√©r√©e !\");\n      }\n    } catch {\n      setError(\"Erreur lors de la g√©n√©ration\");\n    } finally {\n      setIsGeneratingAI(false);\n    }\n  };\n\n  // Validation\n  const validateStep = (step: number): boolean => {\n    setError(null);\n    switch (step) {\n      case 1:\n        if (!formData.title || formData.title.length < 3) {\n          setError(\"Le titre doit contenir au moins 3 caract√®res\");\n          return false;\n        }\n        if (!formData.price || parseInt(formData.price) <= 0) {\n          setError(\"Le prix est requis\");\n          return false;\n        }\n        return true;\n      case 2:\n        if (!formData.city) {\n          setError(\"La ville est requise\");\n          return false;\n        }\n        if (!formData.district) {\n          setError(\"Le quartier est requis\");\n          return false;\n        }\n        return true;\n      case 3:\n        return true;\n      case 4:\n        if (formData.images.length === 0) {\n          setError(\"Au moins une photo est requise\");\n          return false;\n        }\n        return true;\n      case 5:\n        return true;\n      default:\n        return true;\n    }\n  };\n\n  const nextStep = async () => {\n    if (validateStep(currentStep)) {\n      // Auto-generate description when going to step 4\n      if (currentStep === 3 && (!formData.description || formData.description.length < 10)) {\n        await handleGenerateAI();\n      }\n      setCurrentStep((prev) => Math.min(prev + 1, 5));\n      scrollToTop();\n    }\n  };\n\n  const prevStep = () => {\n    setCurrentStep((prev) => Math.max(prev - 1, 1));\n    scrollToTop();\n  };\n\n  // Submit\n  const handleSubmit = async () => {\n    if (!validateStep(1) || !validateStep(2) || !validateStep(4)) return;\n    setIsSubmitting(true);\n    setError(null);\n\n    let coordinates = { lat: 14.7167, lng: -17.4677 };\n    try {\n      coordinates = await smartGeocode(formData.address, formData.district, formData.city);\n    } catch { }\n\n    try {\n      const result = await submitUserListing({\n        type: formData.type,\n        category: formData.category,\n        title: formData.title,\n        price: parseInt(formData.price),\n        city: formData.city,\n        district: formData.district,\n        address: formData.address,\n        landmark: formData.landmark,\n        surface: formData.surface ? parseInt(formData.surface) : undefined,\n        rooms: formData.rooms ? parseInt(formData.rooms) : undefined,\n        bedrooms: formData.bedrooms ? parseInt(formData.bedrooms) : undefined,\n        bathrooms: formData.bathrooms ? parseInt(formData.bathrooms) : undefined,\n        description: formData.description,\n        virtual_tour_url: formData.virtual_tour_url,\n        contact_phone: formData.contact_phone,\n        images: formData.images,\n        location: {\n          city: formData.city,\n          district: formData.district,\n          address: formData.address,\n          landmark: formData.landmark,\n          coords: coordinates,\n        },\n      });\n\n      if (result?.error) {\n        setError(result.error);\n        setIsSubmitting(false);\n        return;\n      }\n\n      toast.success(\"Annonce publi√©e avec succ√®s !\");\n      localStorage.removeItem(STORAGE_KEYS.formData);\n      localStorage.removeItem(STORAGE_KEYS.step);\n      setTimeout(() => {\n        router.push(\"/compte/mes-biens?success=true\");\n        router.refresh();\n      }, 1000);\n    } catch {\n      setError(\"Une erreur est survenue\");\n      setIsSubmitting(false);\n    }\n  };\n\n  const isTerrain = formData.type === \"terrain\";\n  const priceLabel = formData.category === \"location\" ? \"Prix mensuel\" : \"Prix de vente\";\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-[#121212] flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\n      </div>\n    );\n  }\n\n  if (!user) {\n    return (\n      <div className=\"min-h-screen bg-[#121212] flex flex-col items-center justify-center gap-4 text-white\">\n        <h1 className=\"text-xl font-semibold\">Connexion requise</h1>\n        <Link href=\"/login\" className=\"px-6 py-3 bg-[#F4C430] text-black rounded-lg font-medium\">\n          Se connecter\n        </Link>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-[#121212]\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-50 bg-[#121212]/95 backdrop-blur-sm border-b border-zinc-800/50\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          <div className=\"flex items-center gap-4\">\n            <Link href=\"/compte\" className=\"p-2 hover:bg-zinc-800/50 rounded-lg transition-colors\">\n              <ArrowLeft className=\"w-5 h-5 text-zinc-400\" />\n            </Link>\n            <div>\n              <h1 className=\"text-lg font-semibold text-white\">D√©poser une annonce</h1>\n              <p className=\"text-sm text-emerald-400\">100% Gratuit</p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"max-w-4xl mx-auto px-4 py-6\">\n        {/* Stepper */}\n        <div className=\"flex items-center justify-between mb-8 overflow-x-auto pb-4 scrollbar-hide -mx-1 px-1\">\n          {STEPS.map((step, index) => {\n            const Icon = step.icon;\n            const isActive = currentStep === step.id;\n            const isCompleted = currentStep > step.id;\n            return (\n              <div key={step.id} className=\"flex items-center shrink-0\">\n                <button\n                  onClick={() => step.id < currentStep && setCurrentStep(step.id)}\n                  className={`flex flex-col items-center gap-2 transition-all ${step.id <= currentStep ? \"cursor-pointer\" : \"cursor-default\"}`}\n                >\n                  <div className={`w-9 h-9 sm:w-10 sm:h-10 rounded-full flex items-center justify-center transition-all ${isActive\n                    ? \"bg-[#F4C430] text-black shadow-lg shadow-[#F4C430]/20\"\n                    : isCompleted ? \"bg-[#F4C430]/20 text-[#F4C430]\" : \"bg-zinc-800 text-zinc-500\"\n                    }`}>\n                    {isCompleted ? <Check className=\"w-5 h-5\" /> : <Icon className=\"w-4 h-4 sm:w-5 sm:h-5\" />}\n                  </div>\n                  <span className={`text-[10px] sm:text-xs font-medium ${isActive ? \"text-white\" : isCompleted ? \"text-[#F4C430]\" : \"text-zinc-500\"}`}>\n                    {step.title}\n                  </span>\n                </button>\n                {index < STEPS.length - 1 && (\n                  <div className={`w-6 sm:w-20 h-0.5 mx-1 sm:mx-2 ${currentStep > step.id ? \"bg-[#F4C430]/30\" : \"bg-zinc-800\"}`} />\n                )}\n              </div>\n            );\n          })}\n        </div>\n\n        {/* Error */}\n        {error && (\n          <div className=\"bg-red-500/10 border border-red-500/20 rounded-lg px-4 py-3 mb-6 text-red-400 text-sm\">\n            {error}\n          </div>\n        )}\n\n        {/* Step Content */}\n        <div className=\"space-y-8\">\n          {/* Step 1: L'essentiel */}\n          {currentStep === 1 && (\n            <div className=\"space-y-8 animate-in fade-in duration-300\">\n              {/* Transaction Toggle */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-3 block\">Type de transaction</label>\n                <div className=\"flex bg-zinc-800/50 rounded-lg p-1 w-full sm:w-fit\">\n                  <button\n                    type=\"button\"\n                    onClick={() => updateField(\"category\", \"location\")}\n                    className={`flex-1 sm:flex-none px-6 py-2.5 rounded-md text-sm font-medium transition-all ${formData.category === \"location\" ? \"bg-[#F4C430] text-black\" : \"text-zinc-400 hover:text-white\"\n                      }`}\n                  >\n                    Location\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={() => updateField(\"category\", \"vente\")}\n                    className={`flex-1 sm:flex-none px-6 py-2.5 rounded-md text-sm font-medium transition-all ${formData.category === \"vente\" ? \"bg-[#F4C430] text-black\" : \"text-zinc-400 hover:text-white\"\n                      }`}\n                  >\n                    Vente\n                  </button>\n                </div>\n              </div>\n\n              {/* Property Type */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-3 block\">Type de bien</label>\n                <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3\">\n                  {PROPERTY_TYPES.map((type) => {\n                    const Icon = type.icon;\n                    return (\n                      <button\n                        key={type.value}\n                        type=\"button\"\n                        onClick={() => updateField(\"type\", type.value)}\n                        className={`p-3 sm:p-4 rounded-xl border transition-all text-center ${formData.type === type.value\n                          ? \"bg-[#F4C430]/10 border-[#F4C430]/50 text-[#F4C430]\"\n                          : \"bg-zinc-800/30 border-zinc-800 text-zinc-400 hover:border-zinc-700 hover:text-white\"\n                          }`}\n                      >\n                        <Icon className={`w-5 h-5 sm:w-6 sm:h-6 mx-auto mb-2 ${formData.type === type.value ? \"text-[#F4C430]\" : \"text-zinc-500\"}`} />\n                        <span className=\"text-[11px] sm:text-xs font-medium\">{type.label}</span>\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n\n              {/* Title */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-2 block\">Titre de l&apos;annonce</label>\n                <input\n                  type=\"text\"\n                  value={formData.title}\n                  onChange={(e) => updateField(\"title\", e.target.value)}\n                  placeholder=\"Ex: Belle villa avec piscine\"\n                  className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                />\n              </div>\n\n              {/* Price */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-2 block\">{priceLabel}</label>\n                <div className=\"relative\">\n                  <input\n                    type=\"number\"\n                    value={formData.price}\n                    onChange={(e) => updateField(\"price\", e.target.value)}\n                    placeholder=\"0\"\n                    className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 pr-24 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                  />\n                  <span className=\"absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm\">\n                    FCFA{formData.category === \"location\" && \"/mois\"}\n                  </span>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 2: Localisation */}\n          {currentStep === 2 && (\n            <div className=\"space-y-8 animate-in fade-in duration-300\">\n              {/* Location */}\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-sm text-zinc-400 mb-2 block\">Ville / R√©gion</label>\n                  <input\n                    type=\"text\"\n                    value={formData.city}\n                    onChange={(e) => updateField(\"city\", e.target.value)}\n                    placeholder=\"Dakar\"\n                    className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                  />\n                </div>\n                <div>\n                  <label className=\"text-sm text-zinc-400 mb-2 block\">Quartier</label>\n                  <input\n                    type=\"text\"\n                    value={formData.district}\n                    onChange={(e) => updateField(\"district\", e.target.value)}\n                    placeholder=\"Almadies\"\n                    className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                  />\n                </div>\n              </div>\n\n              {/* Address */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-2 block\">\n                  Adresse pr√©cise <span className=\"text-zinc-600\">(optionnel)</span>\n                </label>\n                <AddressAutocomplete\n                  defaultValue={formData.address}\n                  onAddressSelect={(details) => {\n                    updateField(\"address\", details.display_name);\n                    if (details.state) updateField(\"city\", details.state);\n                    const quartier = details.suburb || details.city || details.road;\n                    if (quartier) updateField(\"district\", quartier);\n                  }}\n                  className=\"w-full\"\n                />\n              </div>\n\n              {/* Landmark */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-2 block\">Point de rep√®re <span className=\"text-zinc-600\">(optionnel)</span></label>\n                <input\n                  type=\"text\"\n                  value={formData.landmark}\n                  onChange={(e) => updateField(\"landmark\", e.target.value)}\n                  placeholder=\"Pr√®s de l'√©cole...\"\n                  className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                />\n              </div>\n            </div>\n          )}\n\n          {/* Step 3: D√©tails */}\n          {currentStep === 3 && (\n            <div className=\"space-y-8 animate-in fade-in duration-300\">\n              <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-4\">\n                <div>\n                  <label className=\"text-sm text-zinc-400 mb-2 block\">Surface</label>\n                  <div className=\"relative\">\n                    <input\n                      type=\"number\"\n                      value={formData.surface}\n                      onChange={(e) => updateField(\"surface\", e.target.value)}\n                      placeholder=\"0\"\n                      className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 pr-12 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                    />\n                    <span className=\"absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm\">m¬≤</span>\n                  </div>\n                </div>\n                {!isTerrain && (\n                  <>\n                    <div>\n                      <label className=\"text-sm text-zinc-400 mb-2 block\">Pi√®ces</label>\n                      <input\n                        type=\"number\"\n                        value={formData.rooms}\n                        onChange={(e) => updateField(\"rooms\", e.target.value)}\n                        placeholder=\"0\"\n                        className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm text-zinc-400 mb-2 block\">Chambres</label>\n                      <input\n                        type=\"number\"\n                        value={formData.bedrooms}\n                        onChange={(e) => updateField(\"bedrooms\", e.target.value)}\n                        placeholder=\"0\"\n                        className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm text-zinc-400 mb-2 block\">Salles de bain</label>\n                      <input\n                        type=\"number\"\n                        value={formData.bathrooms}\n                        onChange={(e) => updateField(\"bathrooms\", e.target.value)}\n                        placeholder=\"0\"\n                        className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                      />\n                    </div>\n                  </>\n                )}\n              </div>\n              {isTerrain && (\n                <p className=\"text-sm text-zinc-500\">\n                  Pour un terrain, seule la surface est requise.\n                </p>\n              )}\n            </div>\n          )}\n\n          {/* Step 4: M√©dia */}\n          {currentStep === 4 && (\n            <div className=\"space-y-8 animate-in fade-in duration-300\">\n              {/* Photos */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-3 block\">Photos ({formData.images.length}/10)</label>\n                <div\n                  onDragEnter={handleDrag}\n                  onDragLeave={handleDrag}\n                  onDragOver={handleDrag}\n                  onDrop={handleDrop}\n                  className={`border-2 border-dashed rounded-xl p-8 text-center transition-all ${dragActive ? \"border-[#F4C430] bg-[#F4C430]/5\" : \"border-zinc-700 hover:border-zinc-600\"\n                    }`}\n                >\n                  {uploadingImages ? (\n                    <div className=\"flex flex-col items-center gap-3\">\n                      <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\n                      <p className=\"text-zinc-400\">Upload en cours...</p>\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center gap-3\">\n                      <Upload className=\"w-10 h-10 text-zinc-500\" />\n                      <p className=\"text-zinc-300\">Glissez vos photos ici</p>\n                      <label className=\"cursor-pointer px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white text-sm rounded-lg transition-colors\">\n                        Parcourir\n                        <input type=\"file\" multiple accept=\"image/*\" onChange={handleImageUpload} className=\"hidden\" />\n                      </label>\n                      <p className=\"text-xs text-zinc-600\">JPG, PNG, WebP ‚Ä¢ Max 5MB</p>\n                    </div>\n                  )}\n                </div>\n\n                {formData.images.length > 0 && (\n                  <div className=\"grid grid-cols-3 sm:grid-cols-5 gap-3 mt-4\">\n                    {formData.images.map((url, index) => (\n                      <div key={index} className=\"relative aspect-square rounded-lg overflow-hidden group\">\n                        <Image src={url} alt={`Photo ${index + 1}`} fill className=\"object-cover\" />\n                        <button\n                          type=\"button\"\n                          onClick={() => removeImage(index)}\n                          className=\"absolute top-1 right-1 p-1 bg-black/60 rounded-full opacity-0 group-hover:opacity-100 transition-opacity\"\n                        >\n                          <X className=\"w-4 h-4 text-white\" />\n                        </button>\n                        {index === 0 && (\n                          <span className=\"absolute bottom-1 left-1 px-2 py-0.5 bg-[#F4C430] text-black text-xs font-medium rounded\">\n                            Principale\n                          </span>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n\n              {/* Description */}\n              <div>\n                <div className=\"flex items-center justify-between mb-2\">\n                  <label className=\"text-sm text-zinc-400\">Description</label>\n                  <button\n                    type=\"button\"\n                    onClick={handleGenerateAI}\n                    disabled={isGeneratingAI}\n                    className=\"flex items-center gap-1.5 text-xs text-zinc-400 hover:text-[#F4C430] transition-colors disabled:opacity-50\"\n                  >\n                    {isGeneratingAI ? <Loader2 className=\"w-3.5 h-3.5 animate-spin\" /> : <Sparkles className=\"w-3.5 h-3.5\" />}\n                    G√©n√©rer avec l&apos;IA\n                  </button>\n                </div>\n                <textarea\n                  value={formData.description}\n                  onChange={(e) => updateField(\"description\", e.target.value)}\n                  placeholder=\"D√©crivez le bien, ses atouts...\"\n                  rows={5}\n                  className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 resize-none transition-colors\"\n                />\n              </div>\n\n              {/* Virtual Tour */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-2 block\">\n                  Visite virtuelle <span className=\"text-zinc-600\">(optionnel)</span>\n                </label>\n                <input\n                  type=\"text\"\n                  value={formData.virtual_tour_url}\n                  onChange={(e) => updateField(\"virtual_tour_url\", e.target.value)}\n                  placeholder=\"Lien YouTube\"\n                  className=\"w-full bg-zinc-800/30 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-600 focus:outline-none focus:border-[#F4C430]/50 transition-colors\"\n                />\n              </div>\n            </div>\n          )}\n\n          {/* Step 5: Publication */}\n          {currentStep === 5 && (\n            <div className=\"space-y-8 animate-in fade-in duration-300\">\n              {/* Contact */}\n              <div>\n                <label className=\"text-sm text-zinc-400 mb-2 block\">\n                  T√©l√©phone de contact <span className=\"text-zinc-600\">(optionnel)</span>\n                </label>\n                <PhoneInput\n                  value={formData.contact_phone || undefined}\n                  onChange={(val) => updateField(\"contact_phone\", val || \"\")}\n                  defaultCountry=\"SN\"\n                  international\n                />\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Navigation */}\n        <div className=\"flex items-center justify-between mt-12 pt-6 border-t border-zinc-800/50\">\n          <button\n            type=\"button\"\n            onClick={prevStep}\n            disabled={currentStep === 1}\n            className=\"flex items-center gap-2 px-5 py-2.5 text-zinc-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-colors\"\n          >\n            <ArrowLeft className=\"w-4 h-4\" />\n            Retour\n          </button>\n\n          {currentStep < 5 ? (\n            <button\n              type=\"button\"\n              onClick={nextStep}\n              className=\"flex items-center gap-2 px-6 py-2.5 bg-[#F4C430] text-black font-medium rounded-lg hover:bg-[#F4C430]/90 transition-colors shadow-lg shadow-[#F4C430]/10\"\n            >\n              Continuer\n              <ArrowRight className=\"w-4 h-4\" />\n            </button>\n          ) : (\n            <button\n              type=\"button\"\n              onClick={handleSubmit}\n              disabled={isSubmitting}\n              className=\"flex items-center gap-2 px-6 py-2.5 bg-[#F4C430] text-black font-medium rounded-lg hover:bg-[#F4C430]/90 disabled:opacity-50 transition-colors\"\n            >\n              {isSubmitting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4\" />}\n              Publier gratuitement\n            </button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function DeposerPage() {\n  return (\n    <Suspense fallback={<div className=\"min-h-screen bg-[#121212] flex items-center justify-center\"><Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" /></div>}>\n      <DeposerPageContent />\n    </Suspense>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\favoris\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\gestion-locative\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\mes-biens\\PropertyCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\mes-biens\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\mes-biens\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProperties'. Either include it or remove the dependency array.","line":123,"column":6,"nodeType":"ArrayExpression","endLine":123,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [loadProperties, user]","fix":{"range":[4030,4036],"text":"[loadProperties, user]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\mes-biens\\property-card-actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\mes-documents\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[944,947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[944,947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":675,"column":113,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":675,"endColumn":116,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23905,23908],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23905,23908],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":678,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":678,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24089,24092],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24089,24092],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":678,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":678,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24101,24104],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24101,24104],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport { revalidatePath } from \"next/cache\";\n\ntype DocumentType =\n  | \"titre_propriete\"\n  | \"bail\"\n  | \"cni\"\n  | \"passport\"\n  | \"facture\"\n  | \"attestation\"\n  | \"autre\";\n\nexport interface UserDocument {\n  id: string;\n  user_id: string;\n  file_name: string;\n  file_path: string;\n  file_type: string;\n  file_size: number;\n  mime_type: string;\n  source: string;\n  certification_scope: string | null;\n  property_id: string | null;\n  lease_id: string | null;\n  category: string | null;\n  created_at: string;\n  updated_at: string;\n  is_certified?: boolean;\n  description?: string;\n  entity_type?: string;\n  entity_id?: string;\n}\n\nexport interface GEDDocument extends UserDocument {\n  name: string;\n  url: string;\n  property_title: string;\n  tenant_name: string | null;\n  uploaded_at: string | null;\n  is_virtual?: boolean;\n  virtual_type?: string;\n  virtual_data?: Record<string, any>;\n}\n\n/**\n * Upload un document dans le coffre-fort personnel de l'utilisateur\n */\nexport async function uploadDocument(formData: FormData) {\n  const supabase = await createClient();\n\n  console.log(\"üîç [uploadDocument] D√©but de l'upload\");\n\n  // V√©rifier l'authentification\n  const {\n    data: { user },\n    error: authError,\n  } = await supabase.auth.getUser();\n\n  console.log(\"üîç [uploadDocument] User:\", user?.id, \"Auth Error:\", authError?.message);\n\n  if (authError || !user) {\n    console.error(\"‚ùå [uploadDocument] Non authentifi√©:\", authError);\n    return { success: false, error: \"Non authentifi√©\" };\n  }\n\n  try {\n    const file = formData.get(\"file\") as File;\n    const type = formData.get(\"type\") as DocumentType;\n\n    console.log(\"üîç [uploadDocument] File:\", file?.name, \"Type:\", type, \"Size:\", file?.size);\n\n    if (!file || !type) {\n      console.error(\"‚ùå [uploadDocument] Fichier ou type manquant\");\n      return { success: false, error: \"Fichier ou type manquant\" };\n    }\n\n    // Valider la taille (max 10MB)\n    if (file.size > 10 * 1024 * 1024) {\n      console.error(\"‚ùå [uploadDocument] Fichier trop volumineux:\", file.size);\n      return { success: false, error: \"Le fichier ne doit pas d√©passer 10 MB\" };\n    }\n\n    // Valider le type de fichier\n    const allowedTypes = [\"application/pdf\", \"image/jpeg\", \"image/png\", \"image/jpg\"];\n    if (!allowedTypes.includes(file.type)) {\n      console.error(\"‚ùå [uploadDocument] Type non autoris√©:\", file.type);\n      return { success: false, error: \"Type de fichier non autoris√© (PDF, JPG, PNG uniquement)\" };\n    }\n\n    // G√©n√©rer un nom de fichier unique\n    const timestamp = Date.now();\n    const sanitizedFileName = file.name.replace(/[^a-z0-9.]/gi, \"_\").toLowerCase();\n    const fileName = `${user.id}/${type}/${timestamp}_${sanitizedFileName}`;\n\n    console.log(\"üîç [uploadDocument] fileName g√©n√©r√©:\", fileName);\n\n    // Upload vers Supabase Storage\n    console.log(\"üì§ [uploadDocument] Upload vers Storage bucket verification-docs...\");\n    const { data: uploadData, error: uploadError } = await supabase.storage\n      .from(\"verification-docs\")\n      .upload(fileName, file, {\n        cacheControl: \"3600\",\n        upsert: false,\n      });\n\n    if (uploadError) {\n      console.error(\"‚ùå [uploadDocument] Upload Storage error:\", uploadError);\n      return { success: false, error: `Erreur Storage: ${uploadError.message}` };\n    }\n\n    console.log(\"‚úÖ [uploadDocument] Upload Storage r√©ussi:\", uploadData?.path);\n\n    // Obtenir l'URL publique sign√©e (valide 1 an)\n    const { data: urlData } = await supabase.storage\n      .from(\"verification-docs\")\n      .createSignedUrl(fileName, 31536000); // 1 an en secondes\n\n    console.log(\"üîç [uploadDocument] URL sign√©e g√©n√©r√©e:\", urlData?.signedUrl ? \"OK\" : \"KO\");\n\n    // Enregistrer les m√©tadonn√©es en base de donn√©es\n    console.log(\"üíæ [uploadDocument] Insertion dans user_documents...\");\n    // D√©terminer le scope de certification selon le type de document\n    const certificationScope = (type === 'cni' || type === 'passport') ? 'global' : 'specific';\n\n    const insertData = {\n      user_id: user.id,\n      file_name: file.name,\n      file_path: fileName,\n      file_type: type,\n      file_size: file.size,\n      mime_type: file.type,\n      source: \"manual\",\n      certification_scope: certificationScope,\n      property_id: formData.get(\"propertyId\") ? String(formData.get(\"propertyId\")) : null,\n      lease_id: formData.get(\"leaseId\") ? String(formData.get(\"leaseId\")) : null,\n      category: formData.get(\"category\") ? String(formData.get(\"category\")) : null,\n    };\n    console.log(\"üîç [uploadDocument] Data √† ins√©rer:\", insertData);\n\n    const { error: dbError } = await supabase.from(\"user_documents\").insert(insertData);\n\n    if (dbError) {\n      console.error(\"‚ùå [uploadDocument] Database error:\", dbError);\n      console.error(\"‚ùå [uploadDocument] Error details:\", {\n        message: dbError.message,\n        details: dbError.details,\n        hint: dbError.hint,\n        code: dbError.code,\n      });\n      // Supprimer le fichier upload√© si l'insertion DB √©choue\n      await supabase.storage.from(\"verification-docs\").remove([fileName]);\n      return { success: false, error: `Erreur DB: ${dbError.message}` };\n    }\n\n    console.log(\"‚úÖ [uploadDocument] Insertion DB r√©ussie\");\n\n    revalidatePath(\"/compte/mes-documents\");\n\n    // Notifier l'admin si c'est un document d'identit√© (CNI/Passeport)\n    if (type === 'cni' || type === 'passport') {\n      const { notifyAdmin } = await import(\"@/lib/notifications\");\n      await notifyAdmin({\n        type: \"info\",\n        title: \"V√©rification d'identit√©\",\n        message: `Nouveau document d'identit√© (${type}) t√©l√©charg√© par ${user.email}`,\n        resourcePath: `/admin/verifications/identites?highlight=${user.id}`\n      });\n    }\n\n    console.log(\"üéâ [uploadDocument] Upload termin√© avec succ√®s!\");\n\n    return {\n      success: true,\n      data: {\n        fileName,\n        url: urlData?.signedUrl,\n      },\n    };\n  } catch (error) {\n    console.error(\"‚ùå [uploadDocument] Exception:\", error);\n    return { success: false, error: `Erreur interne: ${error}` };\n  }\n}\n\n/**\n * R√©cup√©rer les documents manuels de l'utilisateur\n */\nexport async function getMyDocuments() {\n  const supabase = await createClient();\n\n  console.log(\"üîç [getMyDocuments] D√©but\");\n\n  const {\n    data: { user },\n    error: authError,\n  } = await supabase.auth.getUser();\n\n  console.log(\"üîç [getMyDocuments] User:\", user?.id);\n\n  if (authError || !user) {\n    console.error(\"‚ùå [getMyDocuments] Non authentifi√©\");\n    return { success: false, error: \"Non authentifi√©\" };\n  }\n\n  try {\n    const { data: documents, error } = await supabase\n      .from(\"user_documents\")\n      .select(\"*\")\n      .eq(\"user_id\", user.id)\n      .eq(\"source\", \"manual\")\n      .order(\"created_at\", { ascending: false });\n\n    console.log(\"üîç [getMyDocuments] Documents trouv√©s:\", documents?.length || 0);\n    console.log(\"üîç [getMyDocuments] Error:\", error);\n\n    if (error) {\n      console.error(\"‚ùå [getMyDocuments] DB error:\", error);\n      return { success: false, error: \"Erreur lors de la r√©cup√©ration\" };\n    }\n\n    // G√©n√©rer les URLs sign√©es pour chaque document\n    const documentsWithUrls = await Promise.all(\n      (documents || []).map(async (doc) => {\n        const { data: urlData } = await supabase.storage\n          .from(\"verification-docs\")\n          .createSignedUrl(doc.file_path, 604800); // 7 jours\n\n        return {\n          id: doc.id,\n          name: doc.file_name,\n          type: doc.file_type,\n          size: doc.file_size,\n          url: urlData?.signedUrl || \"\",\n          uploaded_at: doc.created_at,\n          source: \"manual\" as const,\n          certification_scope: doc.certification_scope || \"specific\",\n          is_certified: doc.is_certified || false,\n        };\n      })\n    );\n\n    console.log(\"‚úÖ [getMyDocuments] Retour:\", documentsWithUrls.length, \"documents\");\n\n    return { success: true, data: documentsWithUrls };\n  } catch (error) {\n    console.error(\"‚ùå [getMyDocuments] Exception:\", error);\n    return { success: false, error: \"Erreur interne\" };\n  }\n}\n\n/**\n * R√©cup√©rer les documents de certification (annonces certifi√©es)\n */\nexport async function getVerificationDocuments() {\n  const supabase = await createClient();\n\n  console.log(\"üîç [getVerificationDocuments] D√©but\");\n\n  const {\n    data: { user },\n    error: authError,\n  } = await supabase.auth.getUser();\n\n  console.log(\"üîç [getVerificationDocuments] User:\", user?.id);\n\n  if (authError || !user) {\n    console.error(\"‚ùå [getVerificationDocuments] Non authentifi√©\");\n    return { success: false, error: \"Non authentifi√©\" };\n  }\n\n  try {\n    // 1. R√©cup√©rer les documents d'identit√© certifi√©s (global scope)\n    const { data: identityDocs, error: identityError } = await supabase\n      .from(\"user_documents\")\n      .select(\"*\")\n      .eq(\"user_id\", user.id)\n      .eq(\"certification_scope\", \"global\")\n      .eq(\"is_certified\", true)\n      .order(\"created_at\", { ascending: false });\n\n    console.log(\"üîç [getVerificationDocuments] Identity docs trouv√©s:\", identityDocs?.length || 0);\n\n    if (identityError) {\n      console.error(\"‚ùå [getVerificationDocuments] Identity docs error:\", identityError);\n    }\n\n    // 2. R√©cup√©rer les annonces de l'utilisateur qui sont certifi√©es et ont un document de preuve\n    const { data: properties, error: propertiesError } = await supabase\n      .from(\"properties\")\n      .select(\"id, title, proof_document_url, verification_requested_at\")\n      .eq(\"owner_id\", user.id)\n      .eq(\"verification_status\", \"verified\")\n      .not(\"proof_document_url\", \"is\", null);\n\n    console.log(\"üîç [getVerificationDocuments] Properties trouv√©es:\", properties?.length || 0);\n\n    if (propertiesError) {\n      console.error(\"‚ùå [getVerificationDocuments] DB error:\", propertiesError);\n      return { success: false, error: \"Erreur lors de la r√©cup√©ration\" };\n    }\n\n    // G√©n√©rer les URLs sign√©es pour chaque document d'identit√© certifi√©\n    const identityDocsWithUrls = await Promise.all(\n      (identityDocs || []).map(async (doc) => {\n        const { data: urlData } = await supabase.storage\n          .from(\"verification-docs\")\n          .createSignedUrl(doc.file_path, 604800); // 7 jours\n\n        return {\n          id: doc.id,\n          name: doc.file_name,\n          type: doc.file_type,\n          size: doc.file_size,\n          url: urlData?.signedUrl || \"\",\n          uploaded_at: doc.created_at,\n          source: \"verification\" as const,\n          certification_scope: \"global\", // Documents d'identit√©\n          is_certified: true,\n        };\n      })\n    );\n\n    // G√©n√©rer les URLs sign√©es pour chaque document de certification de propri√©t√©\n    const propertyDocsWithUrls = await Promise.all(\n      (properties || []).map(async (property) => {\n        // Extraire le chemin du fichier depuis l'URL du document\n        const documentPath = property.proof_document_url;\n\n        console.log(\"üîç [getVerificationDocuments] Processing property:\", property.title, \"Path:\", documentPath);\n\n        if (!documentPath) {\n          console.warn(\"‚ö†Ô∏è [getVerificationDocuments] Pas de document path pour:\", property.title);\n          return null;\n        }\n\n        let finalUrl = \"\";\n\n        // V√©rifier si documentPath est d√©j√† une URL compl√®te (commence par http)\n        if (documentPath.startsWith(\"http://\") || documentPath.startsWith(\"https://\")) {\n          console.log(\"üîç [getVerificationDocuments] documentPath est d√©j√† une URL compl√®te\");\n          finalUrl = documentPath;\n        } else {\n          // C'est un chemin relatif, g√©n√©rer l'URL sign√©e (7 jours)\n          console.log(\"üîç [getVerificationDocuments] G√©n√©ration d'URL sign√©e pour:\", documentPath);\n          const { data: urlData, error: urlError } = await supabase.storage\n            .from(\"verification-docs\")\n            .createSignedUrl(documentPath, 604800); // 7 jours\n\n          if (urlError) {\n            console.error(\"‚ùå [getVerificationDocuments] URL error:\", urlError, \"for:\", documentPath);\n            console.warn(\"‚ö†Ô∏è [getVerificationDocuments] Le fichier n'existe peut-√™tre pas dans le storage\");\n          } else {\n            finalUrl = urlData?.signedUrl || \"\";\n            console.log(\"üîç [getVerificationDocuments] URL g√©n√©r√©e:\", finalUrl ? \"OK\" : \"KO\");\n          }\n        }\n\n        return {\n          id: property.id,\n          name: `Certification - ${property.title}`,\n          type: \"certification\",\n          size: 0, // Pas de taille stock√©e\n          url: finalUrl,\n          uploaded_at: property.verification_requested_at || new Date().toISOString(),\n          source: \"verification\" as const,\n          certification_scope: \"specific\", // Documents de certification de biens\n          is_certified: true, // D√©j√† certifi√©s\n        };\n      })\n    );\n\n    // Combiner tous les documents (identit√© + propri√©t√©s)\n    const allDocuments = [...identityDocsWithUrls, ...propertyDocsWithUrls];\n\n    // Filtrer les documents null ET ceux avec des URLs vides (fichiers manquants)\n    const validDocuments = allDocuments.filter((doc) => {\n      if (doc === null) return false;\n      if (!doc.url || doc.url === \"\") {\n        console.warn(\"‚ö†Ô∏è [getVerificationDocuments] Document ignor√© car URL vide:\", doc.name);\n        console.warn(\"   Le fichier de certification est probablement manquant dans le storage\");\n        return false;\n      }\n      return true;\n    });\n\n    console.log(\"‚úÖ [getVerificationDocuments] Documents valides:\", validDocuments.length);\n    console.log(\"   - Documents d'identit√©:\", identityDocsWithUrls.length);\n    console.log(\"   - Documents de propri√©t√©s:\", propertyDocsWithUrls.filter(d => d !== null && d.url).length);\n\n    return { success: true, data: validDocuments };\n  } catch (error) {\n    console.error(\"‚ùå [getVerificationDocuments] Exception:\", error);\n    return { success: false, error: \"Erreur interne\" };\n  }\n}\n\n/**\n * R√©g√©n√©rer l'URL sign√©e pour un document (en cas d'expiration)\n */\nexport async function refreshDocumentUrl(documentId: string, source: \"manual\" | \"verification\") {\n  const supabase = await createClient();\n\n  console.log(\"üîÑ [refreshDocumentUrl] D√©but - documentId:\", documentId, \"source:\", source);\n\n  const {\n    data: { user },\n    error: authError,\n  } = await supabase.auth.getUser();\n\n  if (authError || !user) {\n    console.error(\"‚ùå [refreshDocumentUrl] Non authentifi√©\");\n    return { success: false, error: \"Non authentifi√©\" };\n  }\n\n  try {\n    let filePath: string | null = null;\n\n    if (source === \"manual\") {\n      // R√©cup√©rer le document manuel\n      const { data: document, error: getError } = await supabase\n        .from(\"user_documents\")\n        .select(\"file_path\")\n        .eq(\"id\", documentId)\n        .eq(\"user_id\", user.id)\n        .eq(\"source\", \"manual\")\n        .single();\n\n      if (getError || !document) {\n        console.error(\"‚ùå [refreshDocumentUrl] Document non trouv√©:\", getError);\n        return { success: false, error: \"Document non trouv√©\" };\n      }\n\n      filePath = document.file_path;\n    } else {\n      // R√©cup√©rer le document de certification depuis la table properties\n      const { data: property, error: getError } = await supabase\n        .from(\"properties\")\n        .select(\"proof_document_url, owner_id\")\n        .eq(\"id\", documentId)\n        .eq(\"verification_status\", \"verified\")\n        .single();\n\n      if (getError || !property) {\n        console.error(\"‚ùå [refreshDocumentUrl] Property non trouv√©e:\", getError);\n        return { success: false, error: \"Document non trouv√©\" };\n      }\n\n      // V√©rifier que l'utilisateur poss√®de la propri√©t√©\n      if (property.owner_id !== user.id) {\n        console.error(\"‚ùå [refreshDocumentUrl] Acc√®s refus√© - utilisateur ne poss√®de pas la propri√©t√©\");\n        return { success: false, error: \"Acc√®s refus√©\" };\n      }\n\n      filePath = property.proof_document_url;\n    }\n\n    if (!filePath) {\n      return { success: false, error: \"Chemin du fichier introuvable\" };\n    }\n\n    // G√©n√©rer une nouvelle URL sign√©e (7 jours)\n    const { data: urlData, error: urlError } = await supabase.storage\n      .from(\"verification-docs\")\n      .createSignedUrl(filePath, 604800); // 7 jours\n\n    if (urlError || !urlData?.signedUrl) {\n      console.error(\"‚ùå [refreshDocumentUrl] Erreur g√©n√©ration URL:\", urlError);\n      return { success: false, error: \"Erreur lors de la g√©n√©ration de l'URL\" };\n    }\n\n    console.log(\"‚úÖ [refreshDocumentUrl] URL r√©g√©n√©r√©e avec succ√®s\");\n\n    return {\n      success: true,\n      data: {\n        url: urlData.signedUrl,\n      },\n    };\n  } catch (error) {\n    console.error(\"‚ùå [refreshDocumentUrl] Exception:\", error);\n    return { success: false, error: \"Erreur interne\" };\n  }\n}\n\n/**\n * Supprimer un document manuel\n */\nexport async function deleteDocument(documentId: string) {\n  const supabase = await createClient();\n\n  const {\n    data: { user },\n    error: authError,\n  } = await supabase.auth.getUser();\n\n  if (authError || !user) {\n    return { success: false, error: \"Non authentifi√©\" };\n  }\n\n  try {\n    // R√©cup√©rer le document pour v√©rifier la propri√©t√© et obtenir le chemin\n    const { data: document, error: getError } = await supabase\n      .from(\"user_documents\")\n      .select(\"*\")\n      .eq(\"id\", documentId)\n      .eq(\"user_id\", user.id)\n      .eq(\"source\", \"manual\") // On ne peut supprimer que les documents manuels\n      .single();\n\n    if (getError || !document) {\n      return { success: false, error: \"Document non trouv√©\" };\n    }\n\n    // Supprimer le fichier du storage\n    const { error: storageError } = await supabase.storage\n      .from(\"verification-docs\")\n      .remove([document.file_path]);\n\n    if (storageError) {\n      console.error(\"Storage delete error:\", storageError);\n      // Continue quand m√™me pour supprimer l'entr√©e DB\n    }\n\n    // Supprimer l'entr√©e de la base de donn√©es\n    const { error: dbError } = await supabase\n      .from(\"user_documents\")\n      .delete()\n      .eq(\"id\", documentId);\n\n    if (dbError) {\n      console.error(\"Database delete error:\", dbError);\n      return { success: false, error: \"Erreur lors de la suppression\" };\n    }\n\n    revalidatePath(\"/compte/mes-documents\");\n\n    return { success: true };\n  } catch (error) {\n    console.error(\"Delete document error:\", error);\n    return { success: false, error: \"Erreur interne\" };\n  }\n}\n\n/**\n * R√©cup√©rer les documents de gestion locative (GED)\n */\n/**\n * R√©cup√©rer les documents de gestion locative (GED)\n * Agr√®ge:\n * 1. Documents upload√©s manuellement (user_documents)\n * 2. Quittances de loyer (rental_transactions 'paid')\n * 3. √âtats des lieux (inventory_reports)\n */\n/**\n * R√©cup√©rer les documents de gestion locative (GED)\n * Agr√®ge:\n * 1. Documents upload√©s manuellement (user_documents)\n * 2. Quittances de loyer (rental_transactions 'paid')\n * 3. √âtats des lieux (inventory_reports)\n * 4. Contrats de bail (leases)\n * 5. Devis/Factures d'intervention (maintenance_requests)\n *\n * NOTE: Utilise team_id pour le mode √©quipe (SaaS)\n */\nexport async function getRentalDocuments(filters?: { propertyId?: string; leaseId?: string }) {\n  const supabase = await createClient();\n\n  // Utiliser le contexte d'√©quipe pour supporter le mode SaaS\n  const { getUserTeamContext } = await import(\"@/lib/team-context\");\n  const { teamId, user } = await getUserTeamContext();\n\n  if (!user || !teamId) return { success: false, error: \"Non autoris√©\" };\n\n  try {\n    // 1. Documents manuels (Upload√©s par owner OU locataire sur un bail du owner)\n    // On veut: created by user OR linked to a lease owned by user.\n    // La jointure !inner sur leases permet de filtrer ceux dont le bail appartient au user.\n    // Mais attention aux docs \"sans bail\" (titre propri√©t√©) upload√©s par le user lui-m√™me.\n    // Donc on fait 2 requ√™tes ou on utilise un OR complexe.\n    // Strat√©gie: \n    // A. Docs du User (qu'il a upload√© lui-m√™me, li√© √† un bail ou non)\n    // B. Docs li√©s aux baux du User (upload√©s par n'importe qui, ex: locataire)\n\n    // Simplification: On r√©cup√®re tout ce qui touche aux baux du owner + ce que le owner a upload√©.\n    // Supabase : .or(`user_id.eq.${user.id},leases.owner_id.eq.${user.id}`) ne marche pas direct avec des joins imbriqu√©s facilement.\n    // On va faire 2 appels manuels si besoin, mais essayons la jointure.\n\n    const _manualsQuery = supabase\n      .from(\"user_documents\")\n      .select(`\n        *,\n        properties (title),\n        leases (tenant_name, owner_id)\n      `)\n      // On retire le filtre strict user_id pour permettre de voir ceux des locataires\n      // Mais on doit s√©curiser pour ne pas voir ceux des autres owners.\n      // On filtre: soit user_id = me, soit leases.owner_id = me.\n      // Sauf que si user_id = me, le lease peut √™tre null.\n      // Si lease.owner_id = me, c'est bon.\n      // Post-filtre en JS plus s√ªr et simple pour ce cas mixte.\n      .not(\"file_path\", \"is\", null);\n\n    // Note: Pour la s√©cu, on devrait compter sur RLS. \n    // Si RLS dit \"user can see doc if user_id=uid OR lease.owner_id=uid\", alors on peut juste faire select.\n    // On va assumer que RLS fait son job ou filtrer nous m√™me.\n    // Faisons un filtre JS pour √™tre s√ªr :\n\n    // On charge un peu large (bas√© sur leases ou user) et on filtre.\n    // LIMITATION: Si bcp de docs, inefficace. Mieux vaut 2 queries.\n\n    // Query A: Mes uploads\n    const _qA = supabase.from(\"user_documents\").select('id').eq(\"user_id\", user.id);\n\n    // Query B: Uploads li√©s √† mes baux\n    const _qB = supabase.from(\"user_documents\").select('id, leases!inner(owner_id)').eq(\"leases.owner_id\", user.id);\n\n    // On va fusionner dans la query principale en utilisant 'or' si possible, ou une logique de filtre post-fetch si le volume est faible.\n    // Vu la complexit√© de OR avec relation inner/outer, on va utiliser le filtre \"user_documents\" g√©n√©ral et filter cote serveur (ou modifier la query pour utiliser des IDs).\n\n    // Alternative Robuste : Fetch by Lease IDs if filter exist, or just owner's docs.\n    // Si pas de filtre, on veut TOUT.\n    // Utilisons user_id = user.id (owner uploads)\n    // Et une 2eme query pour les docs li√©es aux baux du owner mais PAS upload√©s par lui (tenant uploads).\n\n    // APPROCHE ROBUSTE EN 2 √âTAPES:\n    // 1. R√©cup√©rer les lease_ids de l'√©quipe\n    // 2. R√©cup√©rer les documents li√©s √† ces leases OU upload√©s par l'utilisateur\n\n    // √âtape 1: R√©cup√©rer tous les lease_ids de l'√©quipe\n    const { data: teamLeases } = await supabase\n      .from(\"leases\")\n      .select(\"id\")\n      .eq(\"team_id\", teamId);\n\n    const teamLeaseIds = (teamLeases || []).map(l => l.id);\n    console.log(\"[GED] Team lease IDs:\", teamLeaseIds.length, \"for team:\", teamId);\n\n    // √âtape 2: R√©cup√©rer les documents - 2 queries parall√®les\n    // A. Documents upload√©s par l'utilisateur actuel\n    let queryUserDocs = supabase\n      .from(\"user_documents\")\n      .select(`*`)\n      .eq(\"user_id\", user.id);\n\n    // B. Documents li√©s aux baux de l'√©quipe (peu importe qui les a upload√©s)\n    let queryTeamDocs = teamLeaseIds.length > 0\n      ? supabase\n        .from(\"user_documents\")\n        .select(`*`)\n        .in(\"lease_id\", teamLeaseIds)\n      : Promise.resolve({ data: [], error: null });\n\n    if (filters?.propertyId) {\n      queryUserDocs = queryUserDocs.eq(\"property_id\", filters.propertyId);\n    }\n    if (filters?.leaseId) {\n      queryUserDocs = queryUserDocs.eq(\"lease_id\", filters.leaseId);\n      // Pour queryTeamDocs, on filtre aussi par leaseId si sp√©cifi√©\n      if (teamLeaseIds.length > 0) {\n        queryTeamDocs = supabase\n          .from(\"user_documents\")\n          .select(`*`)\n          .eq(\"lease_id\", filters.leaseId);\n      }\n    }\n\n    const [userDocsRes, teamDocsRes] = await Promise.all([\n      queryUserDocs.order(\"created_at\", { ascending: false }),\n      queryTeamDocs\n    ]);\n\n    // Fusionner et d√©dupliquer les r√©sultats\n    const allUserDocs = [...(userDocsRes.data || []), ...((teamDocsRes as { data: UserDocument[] | null; error: any }).data || [])];\n    const manualsOwnerRes = {\n      data: Array.from(new Map(allUserDocs.map(d => [d.id, d])).values()),\n      error: userDocsRes.error || (teamDocsRes as { data: any; error: any }).error\n    };\n    console.log(\"[GED] Total documents found:\", manualsOwnerRes.data?.length || 0);\n\n    // Placeholder pour compatibilit√©\n    const manualsTenantRes = { data: [], error: null };\n\n    // 2. Quittances (Transactions pay√©es) - filtr√©es par team_id\n    let receiptsQuery = supabase\n      .from(\"rental_transactions\")\n      .select(`\n        id,\n        period_month,\n        period_year,\n        paid_at,\n        amount_due,\n        leases!inner (\n          id,\n          tenant_name,\n          property_address,\n          team_id\n        )\n      `)\n      .eq(\"status\", \"paid\")\n      .eq(\"leases.team_id\", teamId);\n\n    if (filters?.leaseId) receiptsQuery = receiptsQuery.eq(\"lease_id\", filters.leaseId);\n\n    // 3. √âtats des lieux - filtr√©s par team_id\n    let inventoryQuery = supabase\n      .from(\"inventory_reports\")\n      .select(`\n        id,\n        report_type,\n        date,\n        status,\n        updated_at,\n        leases!inner (\n          id,\n          tenant_name,\n          property_address,\n          team_id\n        )\n      `)\n      .eq(\"leases.team_id\", teamId);\n\n    if (filters?.leaseId) inventoryQuery = inventoryQuery.eq(\"lease_id\", filters.leaseId);\n\n    // 4. Contrats (Baux) - filtr√©s par team_id\n    let leasesQuery = supabase\n      .from(\"leases\")\n      .select(`\n        id,\n        start_date,\n        end_date,\n        status,\n        created_at,\n        tenant_name,\n        property_address,\n        team_id\n      `)\n      .eq(\"team_id\", teamId);\n\n    if (filters?.leaseId) leasesQuery = leasesQuery.eq(\"id\", filters.leaseId);\n\n    // 5. Interventions (Maintenance) - filtr√©es par team_id\n    let maintenanceQuery = supabase\n      .from(\"maintenance_requests\")\n      .select(`\n        id,\n        description,\n        status,\n        created_at,\n        quoted_price,\n        quote_url,\n        leases!inner (\n          id,\n          tenant_name,\n          property_address,\n          team_id\n        )\n      `)\n      .eq(\"leases.team_id\", teamId);\n\n    if (filters?.leaseId) maintenanceQuery = maintenanceQuery.eq(\"lease_id\", filters.leaseId);\n\n\n    // Ex√©cuter les requ√™tes restantes en parall√®le\n    const [receiptsRes, inventoryRes, leasesRes, maintenanceRes] = await Promise.all([\n      receiptsQuery.order(\"paid_at\", { ascending: false }),\n      inventoryQuery.order(\"date\", { ascending: false }),\n      leasesQuery.order(\"created_at\", { ascending: false }),\n      maintenanceQuery.order(\"created_at\", { ascending: false })\n    ]);\n\n\n\n    const allManualsData = [...(manualsOwnerRes.data || []), ...(manualsTenantRes.data || [])];\n    // D√©doublonnage au cas o√π (par s√©curit√©, bien que les queries soient disjointe par user_id)\n    const uniqueManuals = Array.from(new Map(allManualsData.map(item => [item.id, item])).values());\n\n    // --- Traitement de TOUS les documents pour obtenir les URLs sign√©es ---\n    const docsWithUrls = await Promise.all(\n      uniqueManuals.map(async (doc) => {\n        // D√©terminer le bon bucket selon le type ou la cat√©gorie\n        let bucketName: 'verification-docs' | 'lease-contracts' | 'receipts' | 'properties' = 'verification-docs';\n        if (doc.category === 'lease_contract' || doc.entity_type === 'lease' || doc.file_type === 'bail') {\n          bucketName = 'lease-contracts';\n        } else if (doc.entity_type === 'payment' || doc.entity_type === 'quittance' || doc.file_type === 'quittance') {\n          bucketName = 'receipts';\n        } else if (doc.file_type === 'maintenance' || doc.file_path?.includes('maintenance/')) {\n          bucketName = 'properties';\n        }\n\n        const { data } = await supabase.storage\n          .from(bucketName)\n          .createSignedUrl(doc.file_path, 604800);\n\n        let signedUrl = data?.signedUrl || \"\";\n        if (signedUrl) {\n          // Force inline display instead of download\n          signedUrl += (signedUrl.includes('?') ? '&' : '?') + 'response-content-disposition=inline';\n        }\n\n        // Since we removed joins, construct property_title from description or file_name\n        const propertyTitle = doc.description || doc.file_name || \"Document\";\n\n        // Extract tenant name from description if available\n        let tenantName = null;\n        if (doc.description && doc.description.includes(' - ')) {\n          tenantName = doc.description.split(' - ')[1];\n        }\n\n        return {\n          ...doc,\n          name: doc.description || doc.file_name || \"Document sans nom\",\n          url: data?.signedUrl || \"\",\n          property_title: propertyTitle,\n          tenant_name: tenantName,\n          uploaded_at: doc.created_at || doc.updated_at || null\n        };\n      })\n    );\n\n    // --- Indexation des documents GED pour lookup rapide ---\n    // Maintenant docsWithUrls contient les URLs sign√©es\n    const gedIndex = new Map<string, GEDDocument>(); // Key: \"type:id\" -> Document\n    docsWithUrls.forEach(doc => {\n      if (doc.entity_type && doc.entity_id) {\n        gedIndex.set(`${doc.entity_type}:${doc.entity_id}`, doc);\n      }\n      // Support legacy/fallback: parfois on n'a que lease_id\n      if (doc.file_type === 'bail' && doc.lease_id) {\n        gedIndex.set(`lease:${doc.lease_id}`, doc);\n      }\n    });\n\n    // --- Traitement Documents Manuels ---\n    const manualDocs = docsWithUrls.filter(doc => {\n      // Exclure les documents qui sont d√©j√† trait√©s dans les sections sp√©cifiques (Baux, Quittances)\n      const isHandledElsewhere =\n        (doc.entity_type === 'lease' || doc.file_type === 'bail') ||\n        (doc.entity_type === 'payment' || doc.entity_type === 'quittance' || doc.file_type === 'quittance') ||\n        (doc.entity_type === 'maintenance_request' || doc.file_type === 'maintenance');\n\n      return !isHandledElsewhere;\n    });\n\n    // --- Traitement Quittances ---\n    const validReceipts = (receiptsRes.data || []).filter(_r => true);\n\n    const receiptDocs = validReceipts.map(r => {\n      const lease = r.leases as unknown as { id: string; tenant_name: string; property_address: string };\n      const dateStr = new Date(r.period_year, r.period_month - 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });\n\n      // Chercher un document GED existant pour cette transaction\n      const existingDoc = gedIndex.get(`payment:${r.id}`) || gedIndex.get(`quittance:${r.id}`);\n\n      // L'URL est soit celle du doc stock√© (si pr√©sent), soit l'API dynamique\n      const docUrl = existingDoc?.url || `/api/documents/receipt/${r.id}`;\n\n      return {\n        id: `receipt-${r.id}`,\n        name: existingDoc?.name || `Quittance - ${dateStr}`,\n        type: \"quittance\",\n        category: \"quittance\",\n        size: existingDoc?.size || 0,\n        url: docUrl, // Priorit√© au document stock√©\n        uploaded_at: r.paid_at || new Date().toISOString(),\n        property_id: null,\n        lease_id: lease?.id,\n        property_title: lease?.property_address || \"Propri√©t√© sans titre\",\n        tenant_name: lease?.tenant_name,\n        is_virtual: !existingDoc, // N'est plus virtuel si on a un doc physique\n        virtual_type: 'receipt',\n        virtual_data: {\n          transactionId: r.id,\n          amount: r.amount_due,\n          period: dateStr\n        }\n      };\n    });\n\n    // --- Traitement √âtats des Lieux ---\n    const inventoryDocs = (inventoryRes.data || []).map(r => {\n      const lease = r.leases as unknown as { id: string; tenant_name: string; property_address: string };\n      // TODO: V√©rifier si un EDL stock√© existe (entity_type='inventory'?)\n      return {\n        id: `inventory-${r.id}`,\n        name: `√âtat des lieux (${r.report_type === 'entry' ? 'Entr√©e' : 'Sortie'})`,\n        type: \"etat_lieux\",\n        category: \"etat_lieux\",\n        size: 0,\n        url: `/gestion/etats-lieux/${r.id}/pdf`,\n        uploaded_at: r.updated_at || r.date,\n        property_id: null,\n        lease_id: lease?.id,\n        property_title: lease?.property_address || \"Propri√©t√© sans titre\",\n        tenant_name: lease?.tenant_name,\n        is_virtual: true,\n        virtual_type: 'inventory'\n      };\n    });\n\n    // --- Traitement Contrats (Baux) ---\n    const leaseDocs = (leasesRes.data || []).map(l => {\n      // Chercher un document GED existant pour ce bail\n      const existingDoc = gedIndex.get(`lease:${l.id}`);\n\n      const docUrl = existingDoc?.url || `/api/documents/lease/${l.id}`;\n\n      return {\n        id: `lease-${l.id}`,\n        name: existingDoc?.name || `Contrat de Bail - ${l.tenant_name}`,\n        type: \"bail\",\n        category: \"bail\",\n        size: existingDoc?.size || 0,\n        url: docUrl,\n        uploaded_at: l.created_at,\n        property_id: null,\n        lease_id: l.id,\n        property_title: l.property_address || \"Propri√©t√© sans titre\",\n        tenant_name: l.tenant_name,\n        is_virtual: !existingDoc,\n        virtual_type: 'lease'\n      };\n    });\n\n    // --- Traitement Interventions ---\n    // On ne garde que celles qui ont une URL de devis/facture valide\n    const maintenanceDocs = await Promise.all((maintenanceRes.data || [])\n      .filter(m => !!m.quote_url)\n      .map(async (m) => {\n        const lease = m.leases as unknown as { id: string; tenant_name: string; property_address: string };\n        const isCompleted = m.status === 'completed';\n\n        let finalUrl = m.quote_url || `/gestion`;\n\n        // Si on a un quote_url qui est une URL Supabase, on essaie de la signer pour √™tre s√ªr de l'acc√®s\n        if (m.quote_url && (m.quote_url.includes('storage/v1/object/public/properties/') || m.quote_url.includes('storage/v1/object/sign/properties/'))) {\n          try {\n            // Extraire le path relatif (apr√®s /properties/)\n            const filePath = m.quote_url.split('/properties/')[1].split('?')[0];\n            const { data: signedData } = await supabase.storage\n              .from('properties')\n              .createSignedUrl(filePath, 604800);\n            if (signedData?.signedUrl) {\n              finalUrl = signedData.signedUrl + (signedData.signedUrl.includes('?') ? '&' : '?') + 'response-content-disposition=inline';\n            }\n          } catch (e) {\n            console.warn(\"Erreur signature URL maintenance:\", e);\n          }\n        }\n\n        return {\n          id: `maintenance-${m.id}`,\n          name: isCompleted ? `Facture: ${m.description.substring(0, 30)}...` : `Devis: ${m.description.substring(0, 30)}...`,\n          type: isCompleted ? \"facture_travaux\" : \"devis\",\n          category: isCompleted ? \"facture_travaux\" : \"devis\",\n          size: 0,\n          url: finalUrl,\n          uploaded_at: m.created_at,\n          property_id: null,\n          lease_id: lease?.id,\n          property_title: lease?.property_address || \"Propri√©t√© sans titre\",\n          tenant_name: lease?.tenant_name,\n          is_virtual: true,\n          virtual_type: 'maintenance',\n          virtual_data: {\n            status: m.status,\n            price: m.quoted_price\n          }\n        };\n      }));\n\n\n    // Fusionner et trier par date d√©croissante\n    // On inclut les documents manuels/g√©n√©r√©s ET les documents virtuels (quittances, etc.)\n    const allDocs = [\n      ...manualDocs,\n      ...receiptDocs,\n      ...inventoryDocs,\n      ...leaseDocs,\n      ...maintenanceDocs\n    ].sort((a, b) => {\n      const dateA = a.uploaded_at ? new Date(a.uploaded_at).getTime() : 0;\n      const dateB = b.uploaded_at ? new Date(b.uploaded_at).getTime() : 0;\n      return dateB - dateA;\n    });\n\n\n    return { success: true, data: allDocs };\n\n  } catch (error) {\n    console.error(\"Erreur r√©cup√©ration GED:\", error);\n    return { success: false, error: \"Erreur technique\" };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\mes-documents\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\parametres\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\parametres\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\reset-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\upgrade\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\compte\\upgrade\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\LoadingClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\abonnement\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\abonnement\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\access-control\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":180,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5880,5883],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5880,5883],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":237,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":237,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7940,7943],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7940,7943],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":316,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":316,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10925,10928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10925,10928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":405,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":405,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13994,13997],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13994,13997],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":448,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":448,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15413,15416],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15413,15416],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":502,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":502,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17308,17311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17308,17311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":530,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":530,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18176,18179],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18176,18179],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\r\n\r\n/**\r\n * Server Actions: Temporary Access Control\r\n *\r\n * G√®re les demandes d'acc√®s temporaire et les permissions temporaires\r\n */\r\n\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport { createAdminClient } from \"@/utils/supabase/admin\";\r\nimport { requireTeamPermission } from \"@/lib/permissions\";\r\nimport { safeAction } from \"@/lib/safe-action\";\r\nimport { z } from \"zod\";\r\nimport type { _TeamPermissionKey } from \"@/lib/team-permissions\";\r\nimport {\r\n    notifyAccessRequest,\r\n    notifyAccessApproved,\r\n    notifyAccessRejected,\r\n} from \"@/lib/notifications/access-control-notifications\";\r\n\r\n// =====================================================\r\n// TYPES & SCHEMAS\r\n// =====================================================\r\n\r\nexport type AccessRequestStatus = 'pending' | 'approved' | 'rejected' | 'expired';\r\n\r\nconst requestAccessSchema = z.object({\r\n    teamId: z.string().uuid(),\r\n    permission: z.string().min(1),\r\n    reason: z.string().optional(),\r\n});\r\n\r\nconst reviewAccessRequestSchema = z.object({\r\n    requestId: z.string().uuid(),\r\n    action: z.enum(['approve', 'reject']),\r\n    reviewNotes: z.string().optional(),\r\n    durationHours: z.number().min(1).max(720).optional(), // Max 30 jours\r\n});\r\n\r\nconst grantTemporaryPermissionSchema = z.object({\r\n    teamId: z.string().uuid(),\r\n    userId: z.string().uuid(),\r\n    permission: z.string().min(1),\r\n    durationHours: z.number().min(1).max(720),\r\n    reason: z.string().optional(),\r\n});\r\n\r\n// =====================================================\r\n// ACCESS REQUESTS\r\n// =====================================================\r\n\r\n/**\r\n * Cr√©er une demande d'acc√®s temporaire\r\n */\r\n// ... existing imports\r\n\r\n/**\r\n * Cr√©er une demande d'acc√®s temporaire\r\n */\r\nexport const submitAccessRequest = safeAction(\r\n    \"submitAccessRequest\",\r\n    requestAccessSchema,\r\n    async (data, { userId }) => {\r\n        const { teamId, permission, reason } = data;\r\n        const supabase = await createClient();\r\n\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user || user.id !== userId) throw new Error(\"Non connect√©\");\r\n\r\n        // V√©rifier que l'utilisateur est membre de l'√©quipe\r\n        const { data: membership } = await supabase\r\n            .from('team_members')\r\n            .select('id, role')\r\n            .eq('team_id', teamId)\r\n            .eq('user_id', userId)\r\n            .eq('status', 'active')\r\n            .single();\r\n\r\n        if (!membership) {\r\n            throw new Error(\"Vous n'√™tes pas membre de cette √©quipe\");\r\n        }\r\n\r\n        // V√©rifier qu'il n'y a pas d√©j√† une demande pending pour cette permission\r\n        const { data: existingRequest } = await supabase\r\n            .from('access_requests')\r\n            .select('id')\r\n            .eq('team_id', teamId)\r\n            .eq('requester_id', userId)\r\n            .eq('requested_permission', permission)\r\n            .eq('status', 'pending')\r\n            .maybeSingle();\r\n\r\n        if (existingRequest) {\r\n            throw new Error(\"Vous avez d√©j√† une demande en attente pour cette permission\");\r\n        }\r\n\r\n        // Cr√©er la demande\r\n        const { error: insertError } = await supabase\r\n            .from('access_requests')\r\n            .insert({\r\n                team_id: teamId,\r\n                requester_id: userId,\r\n                requested_permission: permission,\r\n                reason: reason || null,\r\n                status: 'pending',\r\n            });\r\n\r\n        if (insertError) {\r\n            console.error('[Access Request] Insert error:', insertError);\r\n            throw new Error(\"Erreur lors de la cr√©ation de la demande\");\r\n        }\r\n\r\n        // Envoyer notification aux owners/managers\r\n        await notifyAccessRequest({\r\n            teamId,\r\n            requesterId: userId,\r\n            permission,\r\n            reason,\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            message: \"Demande d'acc√®s envoy√©e avec succ√®s\"\r\n        };\r\n    }\r\n);\r\n\r\n/**\r\n * R√©cup√©rer les demandes d'acc√®s pour une √©quipe\r\n */\r\nexport async function getAccessRequestsAction(teamId: string, status?: AccessRequestStatus) {\r\n    try {\r\n        const _context = await requireTeamPermission(\"team.members.view\");\r\n        const adminSupabase = createAdminClient();\r\n\r\n        // R√©cup√©rer les demandes\r\n        let query = adminSupabase\r\n            .from('access_requests')\r\n            .select('*')\r\n            .eq('team_id', teamId)\r\n            .order('requested_at', { ascending: false });\r\n\r\n        if (status) {\r\n            query = query.eq('status', status);\r\n        }\r\n\r\n        const { data: requests, error } = await query;\r\n\r\n        if (error) {\r\n            console.error('[Access Requests] Fetch error:', error);\r\n            return { success: false, error: \"Erreur lors de la r√©cup√©ration des demandes\" };\r\n        }\r\n\r\n        if (!requests || requests.length === 0) {\r\n            return { success: true, data: [] };\r\n        }\r\n\r\n        // R√©cup√©rer les profils des demandeurs et reviewers\r\n        const userIds = new Set<string>();\r\n        requests.forEach(r => {\r\n            if (r.requester_id) userIds.add(r.requester_id);\r\n            if (r.reviewed_by) userIds.add(r.reviewed_by);\r\n        });\r\n\r\n        const { data: profiles } = await adminSupabase\r\n            .from('profiles')\r\n            .select('id, email, full_name')\r\n            .in('id', Array.from(userIds));\r\n\r\n        const profileMap = new Map(profiles?.map(p => [p.id, p]) || []);\r\n\r\n        // Enrichir les demandes avec les profils\r\n        const enrichedData = requests.map(r => ({\r\n            ...r,\r\n            requester: profileMap.get(r.requester_id) || null,\r\n            reviewer: r.reviewed_by ? profileMap.get(r.reviewed_by) || null : null,\r\n        }));\r\n\r\n        return { success: true, data: enrichedData };\r\n    } catch (error: any) {\r\n        console.error('[Access Requests] Unexpected error:', error);\r\n        return { success: false, error: error.message || \"Erreur inattendue\" };\r\n    }\r\n}\r\n\r\n/**\r\n * Approuver ou rejeter une demande d'acc√®s\r\n */\r\nexport async function reviewAccessRequestAction(formData: FormData | {\r\n    requestId: string;\r\n    action: 'approve' | 'reject';\r\n    reviewNotes?: string;\r\n    durationHours?: number;\r\n}) {\r\n    try {\r\n        const context = await requireTeamPermission(\"team.members.edit_role\"); // Owners/Managers\r\n        const supabase = await createClient();\r\n        const adminSupabase = createAdminClient();\r\n\r\n        // Parse & validate\r\n        const data = formData instanceof FormData\r\n            ? {\r\n                requestId: formData.get('requestId') as string,\r\n                action: formData.get('action') as 'approve' | 'reject',\r\n                reviewNotes: formData.get('reviewNotes') as string | undefined,\r\n                durationHours: formData.get('durationHours') ? Number(formData.get('durationHours')) : undefined,\r\n            }\r\n            : formData;\r\n\r\n        const validation = reviewAccessRequestSchema.safeParse(data);\r\n        if (!validation.success) {\r\n            return {\r\n                success: false,\r\n                error: validation.error.issues[0]?.message || \"Donn√©es invalides\"\r\n            };\r\n        }\r\n\r\n        const { requestId, action, reviewNotes, durationHours } = validation.data;\r\n\r\n        // R√©cup√©rer la demande\r\n        const { data: request, error: fetchError } = await supabase\r\n            .from('access_requests')\r\n            .select('*')\r\n            .eq('id', requestId)\r\n            .eq('team_id', context.teamId)\r\n            .single();\r\n\r\n        if (fetchError || !request) {\r\n            return { success: false, error: \"Demande introuvable\" };\r\n        }\r\n\r\n        if (request.status !== 'pending') {\r\n            return { success: false, error: \"Cette demande a d√©j√† √©t√© trait√©e\" };\r\n        }\r\n\r\n        // Mettre √† jour la demande\r\n        const updateData: any = {\r\n            status: action === 'approve' ? 'approved' : 'rejected',\r\n            reviewed_by: context.user.id,\r\n            reviewed_at: new Date().toISOString(),\r\n            review_notes: reviewNotes || null,\r\n        };\r\n\r\n        if (action === 'approve') {\r\n            const hours = durationHours || 24; // Par d√©faut 24h\r\n            const expiresAt = new Date();\r\n            expiresAt.setHours(expiresAt.getHours() + hours);\r\n            updateData.expires_at = expiresAt.toISOString();\r\n\r\n            // Cr√©er la permission temporaire\r\n            const { error: tempPermError } = await adminSupabase\r\n                .from('temporary_permissions')\r\n                .insert({\r\n                    team_id: request.team_id,\r\n                    user_id: request.requester_id,\r\n                    permission: request.requested_permission,\r\n                    granted_by: context.user.id,\r\n                    expires_at: expiresAt.toISOString(),\r\n                    access_request_id: requestId,\r\n                    reason: request.reason,\r\n                });\r\n\r\n            if (tempPermError) {\r\n                console.error('[Temporary Permission] Insert error:', tempPermError);\r\n                return {\r\n                    success: false,\r\n                    error: \"Erreur lors de la cr√©ation de la permission temporaire\"\r\n                };\r\n            }\r\n        }\r\n\r\n        const { error: updateError } = await adminSupabase\r\n            .from('access_requests')\r\n            .update(updateData)\r\n            .eq('id', requestId);\r\n\r\n        if (updateError) {\r\n            console.error('[Access Request] Update error:', updateError);\r\n            return {\r\n                success: false,\r\n                error: \"Erreur lors de la mise √† jour de la demande\"\r\n            };\r\n        }\r\n\r\n        // Envoyer notification au demandeur\r\n        if (action === 'approve') {\r\n            const hours = durationHours || 24;\r\n            const expiresAt = new Date();\r\n            expiresAt.setHours(expiresAt.getHours() + hours);\r\n\r\n            await notifyAccessApproved({\r\n                requesterId: request.requester_id,\r\n                teamId: request.team_id,\r\n                permission: request.requested_permission,\r\n                expiresAt: expiresAt.toISOString(),\r\n                durationHours: hours,\r\n                reviewerId: context.user.id,\r\n                reviewNotes,\r\n            });\r\n        } else {\r\n            await notifyAccessRejected({\r\n                requesterId: request.requester_id,\r\n                teamId: request.team_id,\r\n                permission: request.requested_permission,\r\n                reviewerId: context.user.id,\r\n                reviewNotes,\r\n            });\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            message: action === 'approve'\r\n                ? \"Demande approuv√©e et permission accord√©e\"\r\n                : \"Demande rejet√©e\"\r\n        };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message || \"Erreur inattendue\" };\r\n    }\r\n}\r\n\r\n// =====================================================\r\n// TEMPORARY PERMISSIONS\r\n// =====================================================\r\n\r\n/**\r\n * Accorder directement une permission temporaire (sans demande)\r\n */\r\nexport async function grantTemporaryPermissionAction(formData: FormData | {\r\n    teamId: string;\r\n    userId: string;\r\n    permission: string;\r\n    durationHours: number;\r\n    reason?: string;\r\n}) {\r\n    try {\r\n        const context = await requireTeamPermission(\"team.members.edit_role\");\r\n        const adminSupabase = createAdminClient();\r\n\r\n        // Parse & validate\r\n        const data = formData instanceof FormData\r\n            ? {\r\n                teamId: formData.get('teamId') as string,\r\n                userId: formData.get('userId') as string,\r\n                permission: formData.get('permission') as string,\r\n                durationHours: Number(formData.get('durationHours')),\r\n                reason: formData.get('reason') as string | undefined,\r\n            }\r\n            : formData;\r\n\r\n        const validation = grantTemporaryPermissionSchema.safeParse(data);\r\n        if (!validation.success) {\r\n            return {\r\n                success: false,\r\n                error: validation.error.issues[0]?.message || \"Donn√©es invalides\"\r\n            };\r\n        }\r\n\r\n        const { teamId, userId, permission, durationHours, reason } = validation.data;\r\n\r\n        if (teamId !== context.teamId) {\r\n            return { success: false, error: \"Acc√®s non autoris√©\" };\r\n        }\r\n\r\n        // Calculer la date d'expiration\r\n        const expiresAt = new Date();\r\n        expiresAt.setHours(expiresAt.getHours() + durationHours);\r\n\r\n        // Cr√©er la permission temporaire (upsert pour √©viter les doublons)\r\n        const { error: insertError } = await adminSupabase\r\n            .from('temporary_permissions')\r\n            .upsert({\r\n                team_id: teamId,\r\n                user_id: userId,\r\n                permission,\r\n                granted_by: context.user.id,\r\n                expires_at: expiresAt.toISOString(),\r\n                reason: reason || null,\r\n            }, {\r\n                onConflict: 'team_id,user_id,permission'\r\n            });\r\n\r\n        if (insertError) {\r\n            console.error('[Temporary Permission] Upsert error:', insertError);\r\n            return {\r\n                success: false,\r\n                error: \"Erreur lors de l'octroi de la permission temporaire\"\r\n            };\r\n        }\r\n\r\n        // Envoyer notification √† l'utilisateur\r\n        await notifyAccessApproved({\r\n            requesterId: userId,\r\n            teamId,\r\n            permission,\r\n            expiresAt: expiresAt.toISOString(),\r\n            durationHours,\r\n            reviewerId: context.user.id,\r\n            reviewNotes: reason,\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            message: `Permission accord√©e pour ${durationHours} heures`\r\n        };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message || \"Erreur inattendue\" };\r\n    }\r\n}\r\n\r\n/**\r\n * R√©voquer une permission temporaire\r\n */\r\nexport async function revokeTemporaryPermissionAction(permissionId: string) {\r\n    try {\r\n        const context = await requireTeamPermission(\"team.members.edit_role\");\r\n        const adminSupabase = createAdminClient();\r\n\r\n        // V√©rifier que la permission appartient √† l'√©quipe\r\n        const { data: permission, error: fetchError } = await adminSupabase\r\n            .from('temporary_permissions')\r\n            .select('*')\r\n            .eq('id', permissionId)\r\n            .eq('team_id', context.teamId)\r\n            .single();\r\n\r\n        if (fetchError || !permission) {\r\n            return { success: false, error: \"Permission introuvable\" };\r\n        }\r\n\r\n        // Supprimer la permission\r\n        const { error: deleteError } = await adminSupabase\r\n            .from('temporary_permissions')\r\n            .delete()\r\n            .eq('id', permissionId);\r\n\r\n        if (deleteError) {\r\n            console.error('[Temporary Permission] Delete error:', deleteError);\r\n            return {\r\n                success: false,\r\n                error: \"Erreur lors de la r√©vocation de la permission\"\r\n            };\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            message: \"Permission r√©voqu√©e avec succ√®s\"\r\n        };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message || \"Erreur inattendue\" };\r\n    }\r\n}\r\n\r\n/**\r\n * R√©cup√©rer les permissions temporaires actives d'une √©quipe\r\n */\r\nexport async function getTemporaryPermissionsAction(teamId: string) {\r\n    try {\r\n        const _context = await requireTeamPermission(\"team.members.view\");\r\n        const adminSupabase = createAdminClient();\r\n\r\n        const { data: permissions, error } = await adminSupabase\r\n            .from('temporary_permissions')\r\n            .select('*')\r\n            .eq('team_id', teamId)\r\n            .gte('expires_at', new Date().toISOString())\r\n            .order('expires_at', { ascending: true });\r\n\r\n        if (error) {\r\n            console.error('[Temporary Permissions] Fetch error:', error);\r\n            return {\r\n                success: false,\r\n                error: \"Erreur lors de la r√©cup√©ration des permissions\"\r\n            };\r\n        }\r\n\r\n        if (!permissions || permissions.length === 0) {\r\n            return { success: true, data: [] };\r\n        }\r\n\r\n        // R√©cup√©rer les profils des users et granters\r\n        const userIds = new Set<string>();\r\n        permissions.forEach(p => {\r\n            if (p.user_id) userIds.add(p.user_id);\r\n            if (p.granted_by) userIds.add(p.granted_by);\r\n        });\r\n\r\n        const { data: profiles } = await adminSupabase\r\n            .from('profiles')\r\n            .select('id, email, full_name')\r\n            .in('id', Array.from(userIds));\r\n\r\n        const profileMap = new Map(profiles?.map(p => [p.id, p]) || []);\r\n\r\n        // Enrichir les permissions avec les profils\r\n        const enrichedData = permissions.map(p => ({\r\n            ...p,\r\n            user: profileMap.get(p.user_id) || null,\r\n            granter: profileMap.get(p.granted_by) || null,\r\n        }));\r\n\r\n        return { success: true, data: enrichedData };\r\n    } catch (error: any) {\r\n        console.error('[Temporary Permissions] Unexpected error:', error);\r\n        return { success: false, error: error.message || \"Erreur inattendue\" };\r\n    }\r\n}\r\n\r\n/**\r\n * Nettoyer les permissions expir√©es\r\n */\r\nexport async function cleanupExpiredPermissionsAction() {\r\n    try {\r\n        const adminSupabase = createAdminClient();\r\n\r\n        const { data, error } = await adminSupabase.rpc('cleanup_expired_permissions');\r\n\r\n        if (error) {\r\n            console.error('[Cleanup] Error:', error);\r\n            return {\r\n                success: false,\r\n                error: \"Erreur lors du nettoyage des permissions expir√©es\"\r\n            };\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            deletedCount: data as number,\r\n            message: `${data} permission(s) expir√©e(s) supprim√©e(s)`\r\n        };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message || \"Erreur inattendue\" };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\access-control\\components\\AccessControlDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1432,1435],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1432,1435],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1506,1509],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1506,1509],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1576,1579],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1576,1579],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2476,2479],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2476,2479],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":90,"column":6,"nodeType":"ArrayExpression","endLine":90,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [loadData, teamId]","fix":{"range":[2758,2766],"text":"[loadData, teamId]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":197,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":197,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6575,6578],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6575,6578],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":220,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7241,7244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7241,7244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":327,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":327,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11079,11082],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11079,11082],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":350,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":350,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11741,11744],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11741,11744],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":417,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":417,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14005,14008],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14005,14008],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\n/**\r\n * AccessControlDashboard - Dashboard de gestion des acc√®s temporaires\r\n *\r\n * Affiche:\r\n * - Demandes d'acc√®s en attente\r\n * - Permissions temporaires actives\r\n * - Historique des demandes\r\n */\r\n\r\nimport { useEffect, useState, useCallback } from \"react\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  ClockCounterClockwise,\r\n  CheckCircle,\r\n  XCircle,\r\n  Warning,\r\n  LockKey,\r\n  Calendar,\r\n  User,\r\n} from \"@phosphor-icons/react\";\r\nimport { formatDistance } from \"date-fns\";\r\nimport { fr } from \"date-fns/locale\";\r\nimport {\r\n  getAccessRequestsAction,\r\n  getTemporaryPermissionsAction,\r\n  reviewAccessRequestAction,\r\n  revokeTemporaryPermissionAction,\r\n} from \"../actions\";\r\nimport type { _AccessRequestStatus } from \"../actions\";\r\n\r\ninterface AccessControlDashboardProps {\r\n  teamId: string;\r\n}\r\n\r\nexport function AccessControlDashboard({ teamId }: AccessControlDashboardProps) {\r\n  const [pendingRequests, setPendingRequests] = useState<any[]>([]);\r\n  const [activePermissions, setActivePermissions] = useState<any[]>([]);\r\n  const [historyRequests, setHistoryRequests] = useState<any[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState(\"pending\");\r\n\r\n  const loadData = useCallback(async () => {\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      // Charger les demandes en attente\r\n      const pendingResult = await getAccessRequestsAction(teamId, \"pending\");\r\n      if (pendingResult.success) {\r\n        setPendingRequests(pendingResult.data || []);\r\n      }\r\n\r\n      // Charger les permissions actives\r\n      const activeResult = await getTemporaryPermissionsAction(teamId);\r\n      if (activeResult.success) {\r\n        setActivePermissions(activeResult.data || []);\r\n      }\r\n\r\n      // Charger l'historique (approved + rejected)\r\n      const historyResult = await getAccessRequestsAction(teamId);\r\n      if (historyResult.success) {\r\n        setHistoryRequests(\r\n          (historyResult.data || []).filter(\r\n            (req: any) => req.status !== \"pending\"\r\n          )\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[AccessControlDashboard] Error loading data:\", error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [teamId]);\r\n\r\n  useEffect(() => {\r\n    loadData();\r\n  }, [teamId]);\r\n\r\n  return (\r\n    <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\r\n      <TabsList className=\"grid w-full grid-cols-3 bg-zinc-900\">\r\n        <TabsTrigger value=\"pending\" className=\"data-[state=active]:bg-zinc-800\">\r\n          <ClockCounterClockwise size={16} className=\"mr-2\" />\r\n          En attente\r\n          {pendingRequests.length > 0 && (\r\n            <Badge variant=\"secondary\" className=\"ml-2\">\r\n              {pendingRequests.length}\r\n            </Badge>\r\n          )}\r\n        </TabsTrigger>\r\n        <TabsTrigger value=\"active\" className=\"data-[state=active]:bg-zinc-800\">\r\n          <LockKey size={16} className=\"mr-2\" />\r\n          Permissions actives\r\n          {activePermissions.length > 0 && (\r\n            <Badge variant=\"secondary\" className=\"ml-2\">\r\n              {activePermissions.length}\r\n            </Badge>\r\n          )}\r\n        </TabsTrigger>\r\n        <TabsTrigger value=\"history\" className=\"data-[state=active]:bg-zinc-800\">\r\n          <Calendar size={16} className=\"mr-2\" />\r\n          Historique\r\n        </TabsTrigger>\r\n      </TabsList>\r\n\r\n      {/* Demandes en attente */}\r\n      <TabsContent value=\"pending\" className=\"mt-6\">\r\n        {isLoading ? (\r\n          <div className=\"text-center py-12 text-zinc-400\">Chargement...</div>\r\n        ) : pendingRequests.length === 0 ? (\r\n          <Card className=\"bg-zinc-900 border-zinc-800\">\r\n            <CardContent className=\"py-12 text-center\">\r\n              <CheckCircle size={48} className=\"mx-auto mb-4 text-green-500\" />\r\n              <p className=\"text-zinc-400\">Aucune demande en attente</p>\r\n            </CardContent>\r\n          </Card>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {pendingRequests.map((request) => (\r\n              <PendingRequestCard\r\n                key={request.id}\r\n                request={request}\r\n                onReview={loadData}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n      </TabsContent>\r\n\r\n      {/* Permissions actives */}\r\n      <TabsContent value=\"active\" className=\"mt-6\">\r\n        {isLoading ? (\r\n          <div className=\"text-center py-12 text-zinc-400\">Chargement...</div>\r\n        ) : activePermissions.length === 0 ? (\r\n          <Card className=\"bg-zinc-900 border-zinc-800\">\r\n            <CardContent className=\"py-12 text-center\">\r\n              <LockKey size={48} className=\"mx-auto mb-4 text-zinc-500\" />\r\n              <p className=\"text-zinc-400\">Aucune permission temporaire active</p>\r\n            </CardContent>\r\n          </Card>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {activePermissions.map((perm) => (\r\n              <ActivePermissionCard\r\n                key={perm.id}\r\n                permission={perm}\r\n                onRevoke={loadData}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n      </TabsContent>\r\n\r\n      {/* Historique */}\r\n      <TabsContent value=\"history\" className=\"mt-6\">\r\n        {isLoading ? (\r\n          <div className=\"text-center py-12 text-zinc-400\">Chargement...</div>\r\n        ) : historyRequests.length === 0 ? (\r\n          <Card className=\"bg-zinc-900 border-zinc-800\">\r\n            <CardContent className=\"py-12 text-center\">\r\n              <Calendar size={48} className=\"mx-auto mb-4 text-zinc-500\" />\r\n              <p className=\"text-zinc-400\">Aucun historique</p>\r\n            </CardContent>\r\n          </Card>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {historyRequests.map((request) => (\r\n              <HistoryRequestCard key={request.id} request={request} />\r\n            ))}\r\n          </div>\r\n        )}\r\n      </TabsContent>\r\n    </Tabs>\r\n  );\r\n}\r\n\r\n/**\r\n * Carte pour une demande en attente\r\n */\r\nfunction PendingRequestCard({\r\n  request,\r\n  onReview,\r\n}: {\r\n  request: any;\r\n  onReview: () => void;\r\n}) {\r\n  const [isReviewing, setIsReviewing] = useState(false);\r\n  const [reviewNotes, setReviewNotes] = useState(\"\");\r\n  const [durationHours, setDurationHours] = useState(\"24\");\r\n\r\n  const handleReview = async (action: 'approve' | 'reject') => {\r\n    setIsReviewing(true);\r\n\r\n    try {\r\n      const result = await reviewAccessRequestAction({\r\n        requestId: request.id,\r\n        action,\r\n        reviewNotes,\r\n        durationHours: action === 'approve' ? Number(durationHours) : undefined,\r\n      });\r\n\r\n      if (result.success) {\r\n        onReview();\r\n      } else {\r\n        alert(result.error);\r\n      }\r\n    } catch (error: any) {\r\n      alert(error.message || \"Erreur lors du traitement de la demande\");\r\n    } finally {\r\n      setIsReviewing(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card className=\"bg-zinc-900 border-zinc-800\">\r\n      <CardHeader>\r\n        <div className=\"flex items-start justify-between\">\r\n          <div>\r\n            <CardTitle className=\"text-white flex items-center gap-2\">\r\n              <User size={20} className=\"text-blue-400\" />\r\n              {request.requester?.full_name || request.requester?.email}\r\n            </CardTitle>\r\n            <CardDescription className=\"mt-1\">\r\n              Demande: <span className=\"text-zinc-300 font-mono text-sm\">{request.requested_permission}</span>\r\n            </CardDescription>\r\n          </div>\r\n          <Badge variant=\"outline\" className=\"border-amber-500 text-amber-400\">\r\n            <ClockCounterClockwise size={14} className=\"mr-1\" />\r\n            En attente\r\n          </Badge>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-4\">\r\n        {request.reason && (\r\n          <div>\r\n            <Label className=\"text-zinc-400 text-xs\">Raison</Label>\r\n            <p className=\"mt-1 text-sm text-zinc-300\">{request.reason}</p>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"text-xs text-zinc-500\">\r\n          Demand√©{\" \"}\r\n          {formatDistance(new Date(request.requested_at), new Date(), {\r\n            addSuffix: true,\r\n            locale: fr,\r\n          })}\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-zinc-800\">\r\n          <div>\r\n            <Label htmlFor={`duration-${request.id}`} className=\"text-zinc-300 text-sm\">\r\n              Dur√©e de l&apos;acc√®s\r\n            </Label>\r\n            <Select value={durationHours} onValueChange={setDurationHours}>\r\n              <SelectTrigger id={`duration-${request.id}`} className=\"mt-1 bg-zinc-800 border-zinc-700\">\r\n                <SelectValue />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"2\">2 heures</SelectItem>\r\n                <SelectItem value=\"4\">4 heures</SelectItem>\r\n                <SelectItem value=\"8\">8 heures</SelectItem>\r\n                <SelectItem value=\"24\">24 heures</SelectItem>\r\n                <SelectItem value=\"48\">48 heures</SelectItem>\r\n                <SelectItem value=\"168\">1 semaine</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n\r\n          <div>\r\n            <Label htmlFor={`notes-${request.id}`} className=\"text-zinc-300 text-sm\">\r\n              Notes (optionnel)\r\n            </Label>\r\n            <Textarea\r\n              id={`notes-${request.id}`}\r\n              value={reviewNotes}\r\n              onChange={(e) => setReviewNotes(e.target.value)}\r\n              placeholder=\"Ajouter une note...\"\r\n              className=\"mt-1 bg-zinc-800 border-zinc-700 text-white min-h-[80px]\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex gap-2 pt-2\">\r\n          <Button\r\n            onClick={() => handleReview('approve')}\r\n            disabled={isReviewing}\r\n            className=\"flex-1 bg-green-600 hover:bg-green-700 text-white\"\r\n          >\r\n            <CheckCircle size={16} className=\"mr-2\" />\r\n            Approuver\r\n          </Button>\r\n          <Button\r\n            onClick={() => handleReview('reject')}\r\n            disabled={isReviewing}\r\n            variant=\"outline\"\r\n            className=\"flex-1 bg-zinc-800 border-zinc-700 text-zinc-200 hover:bg-zinc-700\"\r\n          >\r\n            <XCircle size={16} className=\"mr-2\" />\r\n            Rejeter\r\n          </Button>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\n/**\r\n * Carte pour une permission active\r\n */\r\nfunction ActivePermissionCard({\r\n  permission,\r\n  onRevoke,\r\n}: {\r\n  permission: any;\r\n  onRevoke: () => void;\r\n}) {\r\n  const [isRevoking, setIsRevoking] = useState(false);\r\n  const expiresAt = new Date(permission.expires_at);\r\n  const now = new Date();\r\n  const hoursRemaining = Math.ceil((expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60));\r\n\r\n  const handleRevoke = async () => {\r\n    if (!confirm(\"√ätes-vous s√ªr de vouloir r√©voquer cette permission temporaire?\")) {\r\n      return;\r\n    }\r\n\r\n    setIsRevoking(true);\r\n\r\n    try {\r\n      const result = await revokeTemporaryPermissionAction(permission.id);\r\n\r\n      if (result.success) {\r\n        onRevoke();\r\n      } else {\r\n        alert(result.error);\r\n      }\r\n    } catch (error: any) {\r\n      alert(error.message || \"Erreur lors de la r√©vocation\");\r\n    } finally {\r\n      setIsRevoking(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card className=\"bg-zinc-900 border-zinc-800\">\r\n      <CardHeader>\r\n        <div className=\"flex items-start justify-between\">\r\n          <div>\r\n            <CardTitle className=\"text-white flex items-center gap-2\">\r\n              <User size={20} className=\"text-green-400\" />\r\n              {permission.user?.full_name || permission.user?.email}\r\n            </CardTitle>\r\n            <CardDescription className=\"mt-1\">\r\n              Permission: <span className=\"text-zinc-300 font-mono text-sm\">{permission.permission}</span>\r\n            </CardDescription>\r\n          </div>\r\n          <Badge variant=\"outline\" className=\"border-green-500 text-green-400\">\r\n            <CheckCircle size={14} className=\"mr-1\" />\r\n            Active\r\n          </Badge>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-3\">\r\n        <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n          <div>\r\n            <Label className=\"text-zinc-400 text-xs\">Accord√© par</Label>\r\n            <p className=\"mt-1 text-zinc-300\">\r\n              {permission.granter?.full_name || permission.granter?.email}\r\n            </p>\r\n          </div>\r\n          <div>\r\n            <Label className=\"text-zinc-400 text-xs\">Expire dans</Label>\r\n            <p className=\"mt-1 text-zinc-300\">\r\n              {hoursRemaining} heure{hoursRemaining > 1 ? 's' : ''}\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {permission.reason && (\r\n          <div>\r\n            <Label className=\"text-zinc-400 text-xs\">Raison</Label>\r\n            <p className=\"mt-1 text-sm text-zinc-300\">{permission.reason}</p>\r\n          </div>\r\n        )}\r\n\r\n        <Button\r\n          onClick={handleRevoke}\r\n          disabled={isRevoking}\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          className=\"w-full bg-zinc-800 border-zinc-700 text-red-400 hover:bg-zinc-700 hover:text-red-300\"\r\n        >\r\n          <XCircle size={16} className=\"mr-2\" />\r\n          R√©voquer\r\n        </Button>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\n/**\r\n * Carte pour l'historique\r\n */\r\nfunction HistoryRequestCard({ request }: { request: any }) {\r\n  const isApproved = request.status === 'approved';\r\n  const isRejected = request.status === 'rejected';\r\n  const isExpired = request.status === 'expired';\r\n\r\n  return (\r\n    <Card className=\"bg-zinc-900 border-zinc-800 opacity-75\">\r\n      <CardHeader>\r\n        <div className=\"flex items-start justify-between\">\r\n          <div>\r\n            <CardTitle className=\"text-white flex items-center gap-2 text-base\">\r\n              <User size={18} className=\"text-zinc-500\" />\r\n              {request.requester?.full_name || request.requester?.email}\r\n            </CardTitle>\r\n            <CardDescription className=\"mt-1 text-xs\">\r\n              Permission: <span className=\"font-mono\">{request.requested_permission}</span>\r\n            </CardDescription>\r\n          </div>\r\n          <Badge\r\n            variant=\"outline\"\r\n            className={\r\n              isApproved\r\n                ? \"border-green-500 text-green-400\"\r\n                : isRejected\r\n                  ? \"border-red-500 text-red-400\"\r\n                  : \"border-zinc-500 text-zinc-400\"\r\n            }\r\n          >\r\n            {isApproved && <CheckCircle size={12} className=\"mr-1\" />}\r\n            {isRejected && <XCircle size={12} className=\"mr-1\" />}\r\n            {isExpired && <Warning size={12} className=\"mr-1\" />}\r\n            {isApproved ? \"Approuv√©e\" : isRejected ? \"Rejet√©e\" : \"Expir√©e\"}\r\n          </Badge>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-2\">\r\n        {request.review_notes && (\r\n          <div>\r\n            <Label className=\"text-zinc-400 text-xs\">Notes du responsable</Label>\r\n            <p className=\"mt-1 text-xs text-zinc-300\">{request.review_notes}</p>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"text-xs text-zinc-500\">\r\n          Trait√©e par {request.reviewer?.full_name || request.reviewer?.email}{\" \"}\r\n          {formatDistance(new Date(request.reviewed_at), new Date(), {\r\n            addSuffix: true,\r\n            locale: fr,\r\n          })}\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\access-control\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":420,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":420,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15108,15111],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15108,15111],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":421,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":421,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15165,15168],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15165,15168],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":422,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":422,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15221,15224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15221,15224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":423,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":423,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15279,15282],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15279,15282],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":424,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":424,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15335,15338],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15335,15338],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":428,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":428,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15533,15536],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15533,15536],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":431,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":431,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15665,15668],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15665,15668],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":432,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":432,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15720,15723],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15720,15723],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":444,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":444,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16072,16075],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16072,16075],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":588,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":588,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22121,22124],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22121,22124],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":589,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":589,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22263,22266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22263,22266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1390,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1390,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57515,57518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57515,57518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1391,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1391,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57565,57568],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57565,57568],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1391,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1391,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57612,57615],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57612,57615],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1698,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1698,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[67313,67316],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[67313,67316],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1699,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1699,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[67413,67416],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[67413,67416],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1700,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1700,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[67503,67506],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[67503,67506],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1732,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1732,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[69180,69183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[69180,69183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1734,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1734,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[69305,69308],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[69305,69308],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1747,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1747,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[69913,69916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[69913,69916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1780,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1780,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[71072,71075],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[71072,71075],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":21,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { createClient } from '@/utils/supabase/server';\nimport { createClient as createAdminClient } from '@supabase/supabase-js';\nimport { invalidateCacheBatch } from '@/lib/cache/cache-aside';\nimport { invalidateRentalCaches } from '@/lib/cache/invalidation';\nimport { revalidatePath } from 'next/cache';\nimport { validateTenantCreation } from '@/lib/finance';\nimport { sendEmail } from '@/lib/mail';\nimport { getUserTeamContext } from \"@/lib/team-context\";\nimport { requireTeamPermission } from \"@/lib/permissions\";\nimport { checkFeatureAccess } from \"@/lib/subscription/team-subscription\";\nimport { generateMaintenancePDF } from '@/lib/maintenance-pdf-generator';\nimport { _uploadPDFToStorage } from '@/lib/pdf-generator';\nimport { storeDocumentInGED } from '@/lib/ged-utils';\nimport {\n    getRentalTransactions,\n    getLeasesByTeam,\n    getRentalStatsByTeam\n} from \"@/services/rentalService.cached\";\n\n/**\n * R√©cup√©rer les propri√©t√©s de l'√©quipe (pour les listes d√©roulantes)\n */\nexport async function getProperties() {\n    const { teamId } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    try {\n        const { data: properties, error } = await supabase\n            .from('properties')\n            .select('*')\n            .eq('team_id', teamId)\n            .order('created_at', { ascending: false });\n\n        if (error) throw error;\n        return { success: true, data: properties };\n    } catch (error) {\n        console.error(\"Erreur getProperties:\", error);\n        return { success: false, error: \"Erreur lors de la r√©cup√©ration des biens\" };\n    }\n}\n\n/**\n * R√©cup√©rer tous les baux de l'√©quipe (pour les listes d√©roulantes)\n */\nexport async function getLeasesByOwner() {\n    const { teamId } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    try {\n        const { data: leases, error } = await supabase\n            .from('leases')\n            .select('*')\n            .eq('team_id', teamId)\n            .order('created_at', { ascending: false });\n\n        if (error) throw error;\n        return { success: true, data: leases };\n    } catch (error) {\n        console.error(\"Erreur getLeasesByOwner:\", error);\n        return { success: false, error: \"Erreur lors de la r√©cup√©ration des baux\" };\n    }\n}\n\n/**\n * Calcule les statistiques financi√®res en temps r√©el pour l'√©quipe\n */\nexport async function getRentalStats() {\n    const { teamId } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    const today = new Date();\n    const currentDay = today.getDate();\n    const currentMonth = today.getMonth() + 1;\n    const currentYear = today.getFullYear();\n\n    // 1. R√©cup√©rer tous les baux actifs de l'√©quipe\n    const { data: activeLeases } = await supabase\n        .from('leases')\n        .select('id, monthly_amount, billing_day')\n        .eq('team_id', teamId)\n        .eq('status', 'active');\n\n    // 2. R√©cup√©rer les transactions de ce mois pour l'√©quipe\n    const { data: monthlyTrans } = await supabase\n        .from('rental_transactions')\n        .select('lease_id, amount_due, status')\n        .eq('team_id', teamId)\n        .eq('period_month', currentMonth)\n        .eq('period_year', currentYear);\n\n    let collected = 0;\n    let pending = 0;\n    let overdue = 0;\n\n    const paidLeaseIds = new Set();\n\n    // Traiter les paiements existants\n    monthlyTrans?.forEach(t => {\n        if (t.status === 'paid') {\n            collected += Number(t.amount_due);\n            paidLeaseIds.add(t.lease_id);\n        }\n    });\n\n    // 3. Pour chaque bail actif, v√©rifier le statut\n    activeLeases?.forEach(lease => {\n        if (paidLeaseIds.has(lease.id)) return;\n\n        const amount = Number(lease.monthly_amount);\n\n        if (currentDay > (lease.billing_day || 5)) {\n            overdue += amount;\n        } else {\n            pending += amount;\n        }\n    });\n\n    return {\n        collected: collected.toLocaleString('fr-FR'),\n        pending: pending.toLocaleString('fr-FR'),\n        overdue: overdue.toLocaleString('fr-FR')\n    };\n}\n\n/**\n * Calcule les KPIs avanc√©s pour le dashboard de l'√©quipe\n * OPTIMIS√â : Utilise des counts directs et limite le d√©chargement de donn√©es\n */\nexport async function getAdvancedStats() {\n    const { teamId } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    // 1. R√©cup√©rer le nombre total de biens (COUNT uniquement)\n    const { count: totalProperties } = await supabase\n        .from('properties')\n        .select('*', { count: 'exact', head: true })\n        .eq('team_id', teamId);\n\n    // 2. R√©cup√©rer les baux actifs (On a besoin des d√©tails pour les calculs suivants)\n    const { data: activeLeases } = await supabase\n        .from('leases')\n        .select('id, monthly_amount, billing_day, property_address')\n        .eq('team_id', teamId)\n        .eq('status', 'active');\n\n    const activeLeasesCount = activeLeases?.length || 0;\n\n    // 3. Calculer le taux d'occupation\n    let occupancyBase = totalProperties || 0;\n    if (occupancyBase === 0 && activeLeasesCount > 0) {\n        const uniqueAddresses = new Set((activeLeases || []).map(l => l.property_address?.toLowerCase().trim()));\n        occupancyBase = uniqueAddresses.size;\n    }\n\n    const rawOccupancyRate = occupancyBase > 0\n        ? Math.round((activeLeasesCount / occupancyBase) * 100)\n        : (activeLeasesCount > 0 ? 100 : 0);\n\n    const occupancyRate = Math.min(rawOccupancyRate, 100);\n\n    // 4. Calculer le d√©lai moyen de paiement sur les derniers mois uniquement (Limit 50 pour performance)\n    const { data: paidTransactions } = await supabase\n        .from('rental_transactions')\n        .select('lease_id, paid_at, period_month, period_year')\n        .eq('team_id', teamId)\n        .eq('status', 'paid')\n        .not('paid_at', 'is', null)\n        .order('paid_at', { ascending: false })\n        .limit(50);\n\n    let totalDelay = 0;\n    let delayCount = 0;\n\n    paidTransactions?.forEach(t => {\n        const lease = activeLeases?.find(l => l.id === t.lease_id);\n        if (lease && t.paid_at && t.period_month && t.period_year) {\n            const billingDay = lease.billing_day || 5;\n            const expectedDate = new Date(t.period_year, t.period_month - 1, billingDay);\n            const paidDate = new Date(t.paid_at);\n            const diffDays = Math.floor((paidDate.getTime() - expectedDate.getTime()) / (1000 * 60 * 60 * 24));\n            if (diffDays >= 0) {\n                totalDelay += diffDays;\n                delayCount++;\n            }\n        }\n    });\n\n    const avgPaymentDelay = delayCount > 0 ? Math.round(totalDelay / delayCount) : 0;\n\n    // 5. Taux d'impay√©s (COUNT uniquement)\n    const { count: totalTransCount } = await supabase\n        .from('rental_transactions')\n        .select('*', { count: 'exact', head: true })\n        .eq('team_id', teamId);\n\n    const { count: failedCount } = await supabase\n        .from('rental_transactions')\n        .select('*', { count: 'exact', head: true })\n        .eq('team_id', teamId)\n        .in('status', ['failed', 'rejected']);\n\n    const unpaidRate = (totalTransCount && totalTransCount > 0)\n        ? Math.round(((failedCount || 0) / totalTransCount) * 100)\n        : 0;\n\n    // 6. Revenu moyen par bien lou√©\n    const totalMonthlyRevenue = activeLeases?.reduce((acc, l) => acc + Number(l.monthly_amount), 0) || 0;\n    const avgRevenuePerProperty = activeLeasesCount > 0\n        ? Math.round(totalMonthlyRevenue / activeLeasesCount)\n        : 0;\n\n    return {\n        occupancyRate,\n        avgPaymentDelay,\n        unpaidRate,\n        avgRevenuePerProperty,\n        totalProperties: totalProperties || 0,\n        activeLeases: activeLeasesCount\n    };\n}\n\n/**\n * R√©cup√®re l'historique des revenus de l'√©quipe sur les N derniers mois\n */\n/**\n * R√©cup√®re l'historique des revenus de l'√©quipe sur les N derniers mois\n * OPTIMIS√â : 1 seule requ√™te DB au lieu de N requ√™tes (boucle)\n */\nexport async function getRevenueHistory(months: number = 12) {\n    const { teamId } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    const today = new Date();\n    const history: { month: string; year: number; monthNum: number; collected: number; expected: number }[] = [];\n\n    // Calculer la fen√™tre de temps (ex: il y a 12 mois)\n    // On prend une marge de s√©curit√© sur l'ann√©e pr√©c√©dente\n    const pastDate = new Date(today.getFullYear(), today.getMonth() - months, 1);\n    const minYear = pastDate.getFullYear();\n\n    // 1. R√©cup√©rer TOUTES les transactions pertinentes en UNE SEULE requ√™te\n    const { data: transactions } = await supabase\n        .from('rental_transactions')\n        .select('amount_due, status, period_month, period_year')\n        .eq('team_id', teamId)\n        .gte('period_year', minYear);\n\n    // 2. Agr√©ger les donn√©es en m√©moire (beaucoup plus rapide que N requ√™tes DB)\n    for (let i = months - 1; i >= 0; i--) {\n        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);\n        const monthNum = date.getMonth() + 1;\n        const year = date.getFullYear();\n        const monthName = date.toLocaleDateString('fr-FR', { month: 'short' });\n\n        // Filtrer les transactions pour ce mois sp√©cifique\n        const monthTransactions = (transactions || []).filter(t =>\n            t.period_month === monthNum && t.period_year === year\n        );\n\n        const collected = monthTransactions\n            .filter(t => t.status === 'paid')\n            .reduce((sum, t) => sum + Number(t.amount_due || 0), 0);\n\n        const expected = monthTransactions\n            .reduce((sum, t) => sum + Number(t.amount_due || 0), 0);\n\n        history.push({\n            month: monthName.charAt(0).toUpperCase() + monthName.slice(1),\n            year,\n            monthNum,\n            collected,\n            expected\n        });\n    }\n\n    return history;\n}\n\n/**\n * Fonction utilitaire pour envoyer les donn√©es √† n8n\n * Les webhooks n8n doivent √™tre configur√©s pour recevoir ces √©v√©nements\n */\nasync function triggerN8N(webhookPath: string, payload: Record<string, unknown>) {\n    const N8N_URL = process.env.N8N_WEBHOOK_URL; // URL de l'instance n8n\n    console.log(`[triggerN8N] Tentative envoi vers ${webhookPath}`, {\n        hasUrl: !!N8N_URL,\n        payloadKeys: Object.keys(payload)\n    });\n\n    if (!N8N_URL) {\n        console.warn('N8N_WEBHOOK_URL non configur√© - webhook ignor√©');\n        return;\n    }\n\n    try {\n        const response = await fetch(`${N8N_URL}/${webhookPath}`, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n                ...payload,\n                timestamp: new Date().toISOString(),\n                source: 'dousell-immo'\n            }),\n        });\n\n        if (!response.ok) {\n            console.error(`Webhook n8n (${webhookPath}) - Erreur HTTP:`, response.status, await response.text());\n        } else {\n            console.log(`[triggerN8N] Succ√®s envoi ${webhookPath}`);\n        }\n    } catch (err) {\n        console.error(`Erreur Webhook n8n (${webhookPath}):`, err);\n    }\n}\n\n/**\n * Enregistre un nouveau locataire et son bail\n * Supporte :\n * - S√©lection d'un bien existant (property_id)\n * - Cr√©ation de bien on-the-fly (create_new_property)\n * - Liaison automatique bien-bail avec mise √† jour du statut\n */\nexport async function createNewLease(formData: Record<string, unknown>) {\n    const { teamId, user } = await getUserTeamContext();\n    await requireTeamPermission('leases.create');\n\n    // ‚úÖ CHECK FEATURE QUOTA (LEASE)\n    const leaseAccess = await checkFeatureAccess(teamId, \"add_lease\");\n    if (!leaseAccess.allowed) {\n        return {\n            success: false,\n            error: leaseAccess.message,\n            upgradeRequired: leaseAccess.upgradeRequired\n        };\n    }\n\n    // ‚úÖ CHECK FEATURE QUOTA (PROPERTY) if creating on-the-fly\n    if (formData.create_new_property === 'true' || formData.create_new_property === true) {\n        const propertyAccess = await checkFeatureAccess(teamId, \"add_property\");\n        if (!propertyAccess.allowed) {\n            return {\n                success: false,\n                error: propertyAccess.message,\n                upgradeRequired: propertyAccess.upgradeRequired\n            };\n        }\n    }\n\n    const supabase = await createClient();\n\n    // ==============================================\n    // GESTION DU BIEN IMMOBILIER\n    // ==============================================\n    let propertyId = formData.property_id as string | undefined;\n    let propertyAddress = formData.property_address as string;\n\n    // Cas 1: Cr√©ation de bien on-the-fly\n    if (formData.create_new_property === 'true' || formData.create_new_property === true) {\n        const newPropertyTitle = formData.new_property_title as string;\n        const newPropertyAddress = formData.new_property_address as string;\n        const newPropertyPrice = Number(formData.new_property_price) || Number(formData.monthly_amount) || 0;\n\n        if (!newPropertyTitle || !newPropertyAddress) {\n            return { success: false, error: \"Nom et adresse du bien requis pour la cr√©ation\" };\n        }\n\n        // Cr√©er le bien en mode brouillon (sans photos = draft pour vitrine)\n        const { data: newProperty, error: propError } = await supabase\n            .from('properties')\n            .insert([{\n                title: newPropertyTitle,\n                price: newPropertyPrice,\n                currency: 'FCFA',\n                category: 'location',\n                status: 'lou√©', // Directement lou√© car associ√© au locataire\n                location: {\n                    address: newPropertyAddress,\n                    city: 'Dakar', // Valeur par d√©faut\n                },\n                owner_id: user.id,\n                team_id: teamId,\n                validation_status: 'pending', // Pas sur la vitrine (pas de photos)\n                images: [],\n            }])\n            .select('id')\n            .single();\n\n        if (propError || !newProperty) {\n            console.error(\"Erreur cr√©ation bien on-the-fly:\", propError);\n            return { success: false, error: `Erreur cr√©ation bien: ${propError?.message}` };\n        }\n\n        propertyId = newProperty.id;\n        propertyAddress = newPropertyAddress;\n        console.log(\"‚úÖ Bien cr√©√© on-the-fly avec team_id:\", teamId);\n    }\n\n    // Cas 2: Bien existant s√©lectionn√© - mettre √† jour son statut\n    if (propertyId) {\n        const { error: updateError } = await supabase\n            .from('properties')\n            .update({\n                status: 'lou√©',\n                validation_status: 'pending' // Retirer de la vitrine\n            })\n            .eq('id', propertyId)\n            .eq('team_id', teamId); // S√©curit√© suppl√©mentaire\n\n        if (updateError) {\n            console.warn(\"Erreur mise √† jour statut bien:\", updateError);\n        }\n    }\n\n    // ==============================================\n    // PR√âPARATION DES DONN√âES DU BAIL\n    // ==============================================\n    const cleanedFormData = { ...formData };\n    delete (cleanedFormData as any).create_new_property;\n    delete (cleanedFormData as any).new_property_title;\n    delete (cleanedFormData as any).new_property_address;\n    delete (cleanedFormData as any).new_property_price;\n    delete (cleanedFormData as any).monthly_amount_prefilled;\n\n    // Extraire deposit_months pour ne pas l'envoyer √† la table leases\n    const depositMonths = Number(formData.deposit_months) || 2;\n    delete (cleanedFormData as any).deposit_months;\n\n    // Extraire custom_data (champs personnalis√©s de l'import CSV)\n    const customData = (cleanedFormData as any).custom_data || {};\n    delete (cleanedFormData as any).custom_data;\n\n    const finalData = {\n        ...cleanedFormData,\n        owner_id: user.id,\n        team_id: teamId,\n        property_id: propertyId || null,\n        property_address: propertyAddress,\n    };\n\n    // Ajouter custom_data √† finalData seulement s'il n'est pas vide\n    if (Object.keys(customData).length > 0) {\n        (finalData as any).custom_data = customData;\n    }\n\n    const emailToCheck = (finalData as Record<string, unknown>).tenant_email as string | undefined;\n    if (emailToCheck) {\n        // validateTenantCreation devrait id√©alement aussi √™tre mis √† jour mais on continue pour l'instant\n        const validation = await validateTenantCreation(emailToCheck, supabase, user.id);\n\n        if (!validation.valid) {\n            return {\n                success: false,\n                error: validation.error || \"Erreur de validation\"\n            };\n        }\n    }\n\n    // 1.5 V√©rifier que le profil utilisateur existe (Contrainte FK leases_owner_id_fkey)\n    const { data: userProfile, error: _profileError } = await supabase\n        .from('profiles')\n        .select('id')\n        .eq('id', user.id)\n        .maybeSingle();\n\n    if (!userProfile) {\n        // Fallback: Cr√©er le profil s'il n'existe pas (Mode r√©silient)\n        const { error: insertProfileError } = await supabase\n            .from('profiles')\n            .insert([{\n                id: user.id,\n                email: user.email,\n                full_name: user.user_metadata?.full_name || user.email?.split('@')[0] || 'Propri√©taire',\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString()\n            }]);\n\n        if (insertProfileError) {\n            console.error(\"Erreur auto-cr√©ation profil:\", insertProfileError);\n            return { success: false, error: \"Impossible de cr√©er le bail : Votre profil propri√©taire est introuvable.\" };\n        }\n\n        // IMPORTANT: Invalider le cache du profil apr√®s cr√©ation\n        await invalidateCacheBatch([`owner_profile:${user.id}`], 'rentals');\n    }\n\n    // 2. Ins√©rer le bail\n    const { data: lease, error: leaseError } = await supabase\n        .from('leases')\n        .insert([finalData])\n        .select('*')\n        .single();\n\n    if (leaseError || !lease) {\n        console.error(\"Erreur cr√©ation bail:\", leaseError);\n        return { success: false, error: `Erreur cr√©ation bail: ${leaseError?.message}` };\n    }\n\n    // ==============================================\n    // CR√âATION DES TRANSACTIONS INITIALES\n    // ==============================================\n    const today = new Date();\n    const currentMonth = today.getMonth() + 1;\n    const currentYear = today.getFullYear();\n    const monthlyAmount = Number(lease.monthly_amount);\n\n    // 2. Cr√©er transaction CAUTION (Mois 0)\n    // On utilise month=0 pour identifier la caution dans l'historique sans changer le sch√©ma\n    if (depositMonths > 0) {\n        const depositAmount = monthlyAmount * depositMonths;\n        const { error: depositError } = await supabase\n            .from('rental_transactions')\n            .insert([{\n                lease_id: lease.id,\n                period_month: 0, // Convention pour Caution\n                period_year: currentYear,\n                amount_due: depositAmount,\n                status: 'pending',\n                period_start: today.toISOString().split('T')[0],\n                period_end: today.toISOString().split('T')[0],\n                reminder_sent: false,\n                team_id: teamId\n            }]);\n\n        if (depositError) console.error(\"Erreur cr√©ation caution:\", depositError);\n    }\n\n    // 3. Cr√©er automatiquement la transaction pour le mois en cours (Loyer)\n    const { error: transError } = await supabase\n        .from('rental_transactions')\n        .insert([{\n            lease_id: lease.id,\n            period_month: currentMonth,\n            period_year: currentYear,\n            amount_due: monthlyAmount,\n            status: 'pending',\n            period_start: new Date(currentYear, currentMonth - 1, 1).toISOString().split('T')[0],\n            period_end: new Date(currentYear, currentMonth, 0).toISOString().split('T')[0],\n            reminder_sent: false,\n            team_id: teamId\n        }]);\n\n    if (transError) {\n        console.error(\"Erreur cr√©ation transaction:\", transError.message);\n        // On ne bloque pas la cr√©ation du bail, mais on log l'erreur\n    }\n\n    // Invalidation compl√®te du cache pour mise √† jour UI imm√©diate\n    await invalidateRentalCaches(teamId, lease.id, {\n        invalidateLeases: true,\n        invalidateTransactions: true,\n        invalidateStats: true\n    });\n\n    // ==============================================\n    // 4. G√âN√âRATION ET STOCKAGE GED DU BAIL PDF\n    // ==============================================\n    try {\n        // Pr√©parer les donn√©es pour le PDF (ContractData)\n        // Note: On utilise les donn√©es brutes car le profil owner est peut-√™tre fra√Æchement cr√©√©\n        const { data: ownerProfile } = await supabase.from('profiles').select('*').eq('id', user.id).single();\n\n        // Construction des donn√©es du contrat\n        // Import dynamique pour √©viter les cycles si besoin, ou utiliser les imports existants\n        // On suppose que les types sont dispos via imports en haut de fichier (√† ajouter si absent)\n\n        const contractData = {\n            landlord: {\n                firstName: ownerProfile?.first_name || user.user_metadata?.full_name?.split(' ')[0] || 'Propri√©taire',\n                lastName: ownerProfile?.last_name || user.user_metadata?.full_name?.split(' ').slice(1).join(' ') || '',\n                address: ownerProfile?.company_address || 'Adresse non renseign√©e',\n                phone: ownerProfile?.phone_number || '',\n                email: user.email,\n                companyName: ownerProfile?.company_name,\n                ninea: ownerProfile?.company_ninea\n            },\n            tenant: {\n                firstName: lease.tenant_name?.split(' ')[0] || '',\n                lastName: lease.tenant_name?.split(' ').slice(1).join(' ') || '',\n                phone: lease.tenant_phone || '',\n                email: lease.tenant_email,\n                nationalId: '',\n                address: propertyAddress\n            },\n            property: {\n                address: propertyAddress || '',\n                description: (finalData as any).custom_data?.description || propertyAddress || 'Bien immobilier', // Fallback description\n                propertyType: 'appartement' as any\n            },\n            lease: {\n                monthlyRent: Number(lease.monthly_amount),\n                securityDeposit: Number(lease.monthly_amount) * (depositMonths || 2),\n                depositMonths: depositMonths || 2,\n                startDate: new Date(lease.start_date),\n                duration: Number(lease.duration) || 12,\n                billingDay: Number(lease.billing_day) || 5,\n            },\n            signatures: {\n                signatureCity: 'Dakar',\n                signatureDate: new Date()\n            }\n        };\n\n        // G√©n√©rer le PDF\n\n        const { generateLeasePDF } = await import('@/lib/pdf-generator');\n        const pdfResult = await generateLeasePDF(contractData);\n\n        if (pdfResult.success && pdfResult.pdfBytes) {\n            // Stocker dans la GED\n\n            const { storeDocumentInGED } = await import('@/lib/ged-utils');\n\n            // Utiliser un client admin pour outrepasser les restrictions de session sur le storage\n            const { createClient: createAdminSupabase } = await import('@supabase/supabase-js');\n            const supabaseAdmin = createAdminSupabase(\n                process.env.NEXT_PUBLIC_SUPABASE_URL!,\n                process.env.SUPABASE_SERVICE_ROLE_KEY!\n            );\n\n            await storeDocumentInGED({\n                userId: user.id,\n                teamId: teamId,\n                fileBuffer: pdfResult.pdfBytes,\n                fileName: `Bail - ${lease.tenant_name} - ${new Date().getFullYear()}.pdf`,\n                bucketName: 'lease-contracts',\n                documentType: 'bail',\n                metadata: {\n                    leaseId: lease.id,\n                    propertyId: propertyId,\n                    tenantName: lease.tenant_name,\n                    description: `Contrat de bail pour ${lease.tenant_name}`\n                }\n            }, supabaseAdmin);\n            console.log(\"‚úÖ Bail PDF g√©n√©r√© et stock√© en GED via utility\");\n        } else {\n            console.error(\"‚ùå Echec g√©n√©ration PDF interne:\", pdfResult.error);\n        }\n\n    } catch (gedError) {\n        console.error(\"‚ùå Erreur processus GED Bail:\", gedError);\n        // On ne bloque pas la r√©ponse, le bail est cr√©√©\n    }\n\n    // D√âCLENCHEUR N8N : Supprim√© car g√©n√©ration interne\n    // La g√©n√©ration du PDF est maintenant g√©r√©e ci-dessus par generateLeasePDF et stock√©e dans la GED.\n\n    // Invalider aussi le cache du profil propri√©taire et le CACHE VITRINE (Homepage)\n    // pour que le bien disparaisse de la liste \"disponible\"\n    const keysToInvalidate = [\n        `owner_profile:${user.id}`,\n        // Cl√©s Homepage (V3)\n        'all_sections_v3',\n        'popular_locations_v3_8',\n        'properties_for_sale_v3_8',\n        'land_for_sale_v3_8'\n    ];\n\n    // Si on a l'adresse/ville, on invalide aussi le cache par ville\n    if (finalData.property_address && typeof finalData.property_address === 'string') {\n        // Extraction na√Øve de la ville si possible, sinon on invalide Dakar par d√©faut\n        // TODO: Id√©alement il faudrait la ville pr√©cise\n        keysToInvalidate.push('city:Dakar:limit:20', 'city:Saly:limit:20');\n        // Invalidation g√©n√©rique des recherches\n        keysToInvalidate.push('search:*');\n    }\n\n    await invalidateCacheBatch(keysToInvalidate, 'rentals'); // Rentals namespace for owner profile\n    await invalidateCacheBatch(keysToInvalidate, 'homepage'); // Homepage namespace for showcase\n    await invalidateCacheBatch(keysToInvalidate, 'properties'); // Properties namespace for search\n\n    revalidatePath('/gestion');\n    revalidatePath('/gestion/locataires');\n    revalidatePath('/'); // Revalidate root (Vitrine)\n    revalidatePath('/recherche');\n    return { success: true, id: lease.id };\n}\n\n/**\n * Envoie le \"Pack de Bienvenue\" au locataire\n * Comprend : Lien Invitation + Contrat PDF (en pi√®ce jointe)\n * Envoi direct via Nodemailer (sans n8n)\n */\nexport async function sendWelcomePack(leaseId: string) {\n    console.log(\"[sendWelcomePack] Start for lease:\", leaseId);\n    const { teamId, user } = await getUserTeamContext();\n    await requireTeamPermission('documents.generate');\n\n    const supabase = await createClient();\n\n    // 1. R√©cup√©rer les d√©tails du bail et du bien (filtr√© par teamId pour s√©cu)\n    const { data: lease, error: _fetchError } = await supabase\n        .from('leases')\n        .select(`\n            *,\n            property:properties(*)\n        `)\n        .eq('id', leaseId)\n        .eq('team_id', teamId)\n        .single();\n\n    if (!lease) {\n        console.error(\"[sendWelcomePack] Lease not found\");\n        return { success: false, error: \"Bail introuvable\" };\n    }\n\n    // 2. R√©cup√©rer le profil du propri√©taire\n    const { data: profile } = await supabase\n        .from('profiles')\n        .select('company_name, full_name, company_address')\n        .eq('id', user.id)\n        .maybeSingle();\n\n    const ownerName = profile?.company_name || profile?.full_name || \"Votre Gestionnaire\";\n\n    // 3. G√©n√©rer le lien d'invitation (Magic Link) via Admin API\n    let inviteLink = \"https://doussell-immo.com/auth/login\"; // Fallback\n\n    if (process.env.SUPABASE_SERVICE_ROLE_KEY) {\n        try {\n            console.log(\"[sendWelcomePack] Generating magic link...\");\n            const adminAuth = createAdminClient(\n                process.env.NEXT_PUBLIC_SUPABASE_URL!,\n                process.env.SUPABASE_SERVICE_ROLE_KEY\n            ).auth;\n\n            const { data: linkData, error: linkError } = await adminAuth.admin.generateLink({\n                type: 'magiclink',\n                email: lease.tenant_email,\n                options: {\n                    redirectTo: 'https://doussell-immo.com/espace-locataire'\n                }\n            });\n\n            if (linkError) {\n                console.error(\"[sendWelcomePack] Link gen error:\", linkError);\n            } else if (linkData?.properties?.action_link) {\n                inviteLink = linkData.properties.action_link;\n                console.log(\"[sendWelcomePack] Magic link generated successfully\");\n            }\n        } catch (e) {\n            console.error(\"[sendWelcomePack] Erreur g√©n√©ration lien admin:\", e);\n        }\n    } else {\n        console.warn(\"[sendWelcomePack] No SERVICE_ROLE_KEY found, using fallback link\");\n    }\n\n    // 4. Pr√©parer les pi√®ces jointes (Contrat PDF + Re√ßu de Caution + Quittance si applicable)\n    const attachments: Array<{ filename: string; content: Buffer | string; contentType?: string }> = [];\n\n    // IMPORTANT: Re-fetch lease data to get the latest lease_pdf_url (may have been updated by generateLeaseContract)\n    const { data: freshLease } = await supabase\n        .from('leases')\n        .select('*, lease_pdf_url')\n        .eq('id', leaseId)\n        .single();\n\n    console.log(\"[sendWelcomePack] Fresh lease data - PDF URL:\", freshLease?.lease_pdf_url || \"NOT SET\");\n\n    // 4a. Contrat de bail (si d√©j√† g√©n√©r√©)\n    if (freshLease?.lease_pdf_url) {\n        try {\n            console.log(\"[sendWelcomePack] Fetching contract PDF from:\", freshLease.lease_pdf_url);\n            const pdfResponse = await fetch(freshLease.lease_pdf_url);\n            if (pdfResponse.ok) {\n                const pdfArrayBuffer = await pdfResponse.arrayBuffer();\n                attachments.push({\n                    filename: `Contrat_Bail_${lease.tenant_name.replace(/\\s+/g, '_')}.pdf`,\n                    content: Buffer.from(pdfArrayBuffer),\n                    contentType: 'application/pdf'\n                });\n                console.log(\"[sendWelcomePack] Contract PDF attached\");\n            } else {\n                console.error(\"[sendWelcomePack] Failed to fetch contract PDF, status:\", pdfResponse.status);\n            }\n        } catch (e) {\n            console.error(\"[sendWelcomePack] Error fetching contract PDF:\", e);\n        }\n    } else {\n        console.log(\"[sendWelcomePack] No contract PDF URL available - skipping contract attachment\");\n    }\n\n    // 4b. Re√ßu de Caution (si caution pay√©e)\n    try {\n        // V√©rifier si la caution est pay√©e\n        console.log(\"[sendWelcomePack] Looking for deposit transaction with lease_id:\", leaseId, \"period_month: 0, status: paid\");\n        const { data: depositTx, error: depositError } = await supabase\n            .from('rental_transactions')\n            .select('*')\n            .eq('lease_id', leaseId)\n            .eq('period_month', 0) // Caution = mois 0\n            .eq('status', 'paid')\n            .maybeSingle();\n\n        console.log(\"[sendWelcomePack] Deposit tx found:\", depositTx ? `YES (amount: ${depositTx.amount_due})` : \"NO\", depositError ? `Error: ${depositError.message}` : \"\");\n\n        if (depositTx) {\n            console.log(\"[sendWelcomePack] Generating deposit receipt PDF...\");\n            const ReactPDF = await import('@react-pdf/renderer');\n            const { createDepositReceiptDocument } = await import('@/components/pdf/DepositReceiptPDF');\n\n            // R√©cup√©rer le profil complet pour le PDF\n            const { data: fullProfile } = await supabase\n                .from('profiles')\n                .select('company_name, full_name, company_address, company_ninea, logo_url, signature_url')\n                .eq('id', user.id)\n                .maybeSingle();\n\n            const depositReceiptData = {\n                tenantName: lease.tenant_name,\n                tenantEmail: lease.tenant_email,\n                tenantPhone: lease.tenant_phone,\n                depositAmount: depositTx.amount_due,\n                depositMonths: Math.round(depositTx.amount_due / lease.monthly_amount),\n                monthlyRent: lease.monthly_amount,\n                receiptNumber: `CAUT-${Date.now().toString().slice(-8)}`,\n                ownerName: fullProfile?.company_name || fullProfile?.full_name || ownerName,\n                ownerAddress: fullProfile?.company_address || '',\n                ownerNinea: fullProfile?.company_ninea,\n                ownerLogo: fullProfile?.logo_url,\n                ownerSignature: fullProfile?.signature_url,\n                propertyAddress: lease.property_address,\n                leaseStartDate: new Date(lease.start_date).toLocaleDateString('fr-FR'),\n            };\n\n            const depositDoc = createDepositReceiptDocument(depositReceiptData);\n            const stream = await ReactPDF.default.renderToStream(depositDoc);\n\n            // Convertir le stream en buffer\n            const chunks: Uint8Array[] = [];\n            const depositBuffer = await new Promise<Buffer>((resolve, reject) => {\n                stream.on('data', (chunk: Uint8Array) => chunks.push(chunk));\n                stream.on('end', () => resolve(Buffer.concat(chunks)));\n                stream.on('error', reject);\n            });\n\n            attachments.push({\n                filename: `Recu_Caution_${lease.tenant_name.replace(/\\s+/g, '_')}.pdf`,\n                content: depositBuffer,\n                contentType: 'application/pdf'\n            });\n            console.log(\"[sendWelcomePack] Deposit receipt PDF attached\");\n        }\n    } catch (e) {\n        console.error(\"[sendWelcomePack] Error generating deposit receipt:\", e);\n    }\n\n    // 4c. Quittance de Loyer (si premier loyer pay√©)\n    try {\n        // V√©rifier si le loyer du mois en cours est pay√©\n        const currentMonth = new Date().getMonth() + 1;\n        const currentYear = new Date().getFullYear();\n\n        const { data: rentTx } = await supabase\n            .from('rental_transactions')\n            .select('*')\n            .eq('lease_id', leaseId)\n            .eq('period_month', currentMonth)\n            .eq('period_year', currentYear)\n            .eq('status', 'paid')\n            .maybeSingle();\n\n        if (rentTx) {\n            console.log(\"[sendWelcomePack] Generating rent receipt PDF...\");\n            const ReactPDF = await import('@react-pdf/renderer');\n            const { createQuittanceDocument } = await import('@/components/pdf/QuittancePDF_v2');\n\n            // R√©cup√©rer le profil complet pour le PDF\n            const { data: fullProfile } = await supabase\n                .from('profiles')\n                .select('company_name, full_name, company_address, company_ninea, logo_url, signature_url')\n                .eq('id', user.id)\n                .maybeSingle();\n\n            const periodDate = new Date(rentTx.period_year, rentTx.period_month - 1);\n            const lastDayOfMonth = new Date(rentTx.period_year, rentTx.period_month, 0).getDate();\n\n            const quittanceData = {\n                tenantName: lease.tenant_name,\n                tenantEmail: lease.tenant_email,\n                tenantPhone: lease.tenant_phone,\n                tenantAddress: lease.property_address,\n                amount: rentTx.amount_due,\n                periodMonth: periodDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }),\n                periodStart: `01/${String(rentTx.period_month).padStart(2, '0')}/${rentTx.period_year}`,\n                periodEnd: `${lastDayOfMonth}/${String(rentTx.period_month).padStart(2, '0')}/${rentTx.period_year}`,\n                receiptNumber: `QUITT-${Date.now().toString().slice(-8)}`,\n                ownerName: fullProfile?.company_name || fullProfile?.full_name || ownerName,\n                ownerAddress: fullProfile?.company_address || '',\n                ownerNinea: fullProfile?.company_ninea,\n                ownerLogo: fullProfile?.logo_url,\n                ownerSignature: fullProfile?.signature_url,\n                propertyAddress: lease.property_address,\n            };\n\n            const quittanceDoc = createQuittanceDocument(quittanceData);\n            const stream = await ReactPDF.default.renderToStream(quittanceDoc);\n\n            // Convertir le stream en buffer\n            const chunks: Uint8Array[] = [];\n            const quittanceBuffer = await new Promise<Buffer>((resolve, reject) => {\n                stream.on('data', (chunk: Uint8Array) => chunks.push(chunk));\n                stream.on('end', () => resolve(Buffer.concat(chunks)));\n                stream.on('error', reject);\n            });\n\n            attachments.push({\n                filename: `Quittance_${periodDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }).replace(/\\s+/g, '_')}_${lease.tenant_name.replace(/\\s+/g, '_')}.pdf`,\n                content: quittanceBuffer,\n                contentType: 'application/pdf'\n            });\n            console.log(\"[sendWelcomePack] Rent receipt PDF attached\");\n        }\n    } catch (e) {\n        console.error(\"[sendWelcomePack] Error generating rent receipt:\", e);\n    }\n\n    // 5. Construire le contenu HTML de l'email\n    const documentsList = [];\n    if (attachments.find(a => a.filename.includes('Contrat'))) documentsList.push('Contrat de bail');\n    if (attachments.find(a => a.filename.includes('Caution'))) documentsList.push('Re√ßu de d√©p√¥t de garantie');\n    if (attachments.find(a => a.filename.includes('Quittance'))) documentsList.push('Quittance de loyer');\n\n    const emailHtml = `\n        <!DOCTYPE html>\n        <html>\n        <head><meta charset=\"UTF-8\"></head>\n        <body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333; padding: 20px; max-width: 600px; margin: 0 auto;\">\n            <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;\">\n                <h1 style=\"color: white; margin: 0;\">Bienvenue ${lease.tenant_name} ! üéâ</h1>\n            </div>\n            \n            <div style=\"background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px;\">\n                <p>Nous avons le plaisir de vous accueillir en tant que nouveau locataire.</p>\n                \n                <h3 style=\"color: #667eea;\">üìã R√©capitulatif de votre bail</h3>\n                <ul style=\"background: white; padding: 20px 30px; border-radius: 8px; border-left: 4px solid #667eea;\">\n                    <li><strong>Adresse :</strong> ${lease.property_address}</li>\n                    <li><strong>Loyer mensuel :</strong> ${new Intl.NumberFormat('fr-FR').format(lease.monthly_amount)} FCFA</li>\n                    <li><strong>Date de d√©but :</strong> ${new Date(lease.start_date).toLocaleDateString('fr-FR')}</li>\n                    <li><strong>Jour de paiement :</strong> Le ${lease.billing_day} de chaque mois</li>\n                </ul>\n\n                <h3 style=\"color: #667eea;\">üîó Acc√©der √† votre espace locataire</h3>\n                <p>Cliquez sur le bouton ci-dessous pour acc√©der √† votre espace personnel :</p>\n                <div style=\"text-align: center; margin: 20px 0;\">\n                    <a href=\"${inviteLink}\" style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block;\">\n                        Acc√©der √† mon espace\n                    </a>\n                </div>\n\n                ${attachments.length > 0 ? `\n                <h3 style=\"color: #667eea;\">üìé Documents joints</h3>\n                <ul style=\"background: white; padding: 15px 30px; border-radius: 8px; border-left: 4px solid #B8860B;\">\n                    ${documentsList.map(doc => `<li>üìÑ ${doc}</li>`).join('')}\n                </ul>\n                ` : ''}\n\n                <hr style=\"border: none; border-top: 1px solid #ddd; margin: 30px 0;\">\n                \n                <p>Cordialement,<br><strong>${ownerName}</strong></p>\n                ${profile?.company_address ? `<p style=\"color: #666; font-size: 14px;\">${profile.company_address}</p>` : ''}\n                \n                <p style=\"font-size: 12px; color: #999; margin-top: 30px; text-align: center;\">\n                    Email g√©n√©r√© automatiquement par Dousell Immo\n                </p>\n            </div>\n        </body>\n        </html>\n    `;\n\n    // 6. Envoyer l'email via Nodemailer (lib/mail.ts)\n    try {\n        const _result = await sendEmail({\n            to: lease.tenant_email,\n            subject: `üè† Bienvenue ${lease.tenant_name} - Votre Pack Locataire`,\n            html: emailHtml,\n            attachments: attachments.length > 0 ? attachments : undefined\n        });\n\n        console.log(\"[sendWelcomePack] Email sent successfully\");\n\n        // 7. Sauvegarder le pack dans la GED (user_documents)\n        if (attachments.length > 0 && process.env.SUPABASE_SERVICE_ROLE_KEY) {\n            try {\n                const { createClient: createAdminSupabase } = await import('@supabase/supabase-js');\n                const supabaseAdmin = createAdminSupabase(\n                    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n                    process.env.SUPABASE_SERVICE_ROLE_KEY\n                );\n\n                for (const attachment of attachments) {\n                    const fileName = `${user.id}/welcome-pack/${leaseId}_${Date.now()}.pdf`;\n                    const contentBuffer = typeof attachment.content === 'string'\n                        ? Buffer.from(attachment.content)\n                        : attachment.content;\n\n                    // Upload vers Storage\n                    const { error: uploadError } = await supabaseAdmin.storage\n                        .from('verification-docs')\n                        .upload(fileName, contentBuffer, {\n                            contentType: 'application/pdf',\n                            upsert: false\n                        });\n\n                    if (!uploadError) {\n                        // Enregistrer dans user_documents\n                        await supabaseAdmin.from('user_documents').insert({\n                            user_id: user.id,\n                            file_name: attachment.filename,\n                            file_path: fileName,\n                            file_type: 'welcome_pack',\n                            file_size: contentBuffer.length,\n                            mime_type: 'application/pdf',\n                            source: 'generated',\n                            lease_id: leaseId,\n                            category: 'welcome_pack',\n                            description: `Pack de bienvenue - ${lease.tenant_name}`\n                        });\n                        console.log(\"[sendWelcomePack] Document saved to GED:\", fileName);\n                    } else {\n                        console.error(\"[sendWelcomePack] Storage upload error:\", uploadError.message);\n                    }\n                }\n            } catch (storageError) {\n                console.error(\"[sendWelcomePack] GED storage error (non-blocking):\", storageError);\n            }\n        }\n\n        // 8. Invalider le cache et revalider les paths pour que l'UI se mette √† jour\n        try {\n            await invalidateRentalCaches(user.id, leaseId, {\n                invalidateLeases: true,\n                invalidateTransactions: true,\n                invalidateStats: true\n            });\n            revalidatePath('/gestion');\n            revalidatePath(`/gestion/locataires/${leaseId}`);\n            console.log(\"[sendWelcomePack] Cache invalidated and paths revalidated\");\n        } catch (e) {\n            console.error(\"[sendWelcomePack] Cache invalidation error (non-blocking):\", e);\n        }\n\n        return { success: true, message: \"Pack de bienvenue envoy√© !\" };\n    } catch (emailError) {\n        console.error(\"[sendWelcomePack] Email error:\", emailError);\n        return { success: false, error: \"Erreur lors de l'envoi de l'email\" };\n    }\n}\n\n/**\n * Marque un loyer comme pay√©\n * D√©clenche l'envoi automatique de la quittance par EMAIL via n8n\n */\n/**\n * Marque un loyer comme pay√©\n * D√©clenche l'envoi automatique de la quittance par EMAIL via n8n\n * Si pas d'ID de transaction, en cr√©e une pour le mois courant\n */\nexport async function confirmPayment(leaseId: string, transactionId?: string, month?: number, year?: number, silent: boolean = false) {\n    const { teamId, user } = await getUserTeamContext();\n    await requireTeamPermission('payments.confirm');\n\n    const supabase = await createClient();\n\n    let targetId = transactionId;\n\n    // 1. Si pas de transactionID, on en cr√©e une pour le mois actuel\n    // 1. Si pas de transactionID, on cherche ou on cr√©e\n    if (!targetId) {\n        // D√©terminer la p√©riode cible (Mois s√©lectionn√© OU Mois actuel par d√©faut)\n        const targetMonth = month !== undefined ? month : (new Date().getMonth() + 1);\n        const targetYear = year || new Date().getFullYear();\n\n        // Pour les CAUTIONS (month=0), on ne filtre PAS par ann√©e\n        const isDeposit = targetMonth === 0;\n\n        // A) V√©rifier s'il existe D√âJ√Ä une transaction pour ce bail/mois(/ann√©e)\n        let query = supabase\n            .from('rental_transactions')\n            .select('id, status')\n            .eq('team_id', teamId)\n            .eq('lease_id', leaseId)\n            .eq('period_month', targetMonth);\n\n        // Ne filtrer par ann√©e QUE pour les loyers (pas pour les cautions)\n        if (!isDeposit) {\n            query = query.eq('period_year', targetYear);\n        }\n\n        const { data: existingTx } = await query.limit(1).maybeSingle();\n\n        console.log(`[confirmPayment] Looking for transaction: lease=${leaseId}, month=${targetMonth}, year=${isDeposit ? 'N/A (deposit)' : targetYear}, found=${!!existingTx}`);\n\n        if (existingTx) {\n            // Si elle existe d√©j√†, on l'utilise (m√™me si elle est pay√©e, on la mettra √† jour en 'paid')\n            targetId = existingTx.id;\n        } else {\n            // B) Sinon, on en cr√©e une nouvelle\n            const { data: lease } = await supabase\n                .from('leases')\n                .select('monthly_amount, team_id')\n                .eq('id', leaseId)\n                .single();\n\n            if (!lease) return { success: false, error: \"Bail introuvable\" };\n\n            // Fallback: si le bail n'a pas de team_id (anciens baux), on utilise celui de l'utilisateur\n            let effectiveTeamId = lease.team_id;\n            if (!effectiveTeamId) {\n                const { data: teamMember } = await supabase\n                    .from('team_members')\n                    .select('team_id')\n                    .eq('user_id', user.id)\n                    .maybeSingle();\n                effectiveTeamId = teamMember?.team_id || null;\n                console.log(`[confirmPayment] Lease has no team_id, using user's team: ${effectiveTeamId}`);\n            }\n\n            const { data: newTrans, error: insertError } = await supabase\n                .from('rental_transactions')\n                .insert([{\n                    lease_id: leaseId,\n                    period_month: targetMonth,\n                    period_year: targetYear,\n                    amount_due: lease.monthly_amount,\n                    status: 'pending',\n                    team_id: teamId\n                }])\n                .select()\n                .single();\n\n            if (insertError || !newTrans) {\n                console.error(\"Erreur cr√©ation transaction auto:\", insertError);\n                return { success: false, error: \"Impossible de cr√©er la transaction de paiement\" };\n            }\n            targetId = newTrans.id;\n        }\n    }\n\n    // 2. Mettre √† jour la transaction comme pay√©e\n    const { data: trans, error: updateError } = await supabase\n        .from('rental_transactions')\n        .update({\n            status: 'paid',\n            paid_at: new Date().toISOString(),\n            payment_method: 'manual', // Par d√©faut pour confirmation manuelle\n            team_id: teamId, // S√©curit√©\n            meta: {\n                provider: 'manual',\n                confirmed_by: user.id,\n                confirmed_at: new Date().toISOString(),\n                currency: 'XOF',\n            },\n        })\n        .eq('id', targetId)\n        .eq('team_id', teamId)\n        .select('*, leases(tenant_name, tenant_email, monthly_amount, owner_id, property_address)')\n        .single();\n\n    if (updateError || !trans) {\n        console.error(\"Erreur confirmation paiement:\", updateError?.message);\n        return { success: false, error: updateError?.message || \"Transaction introuvable\" };\n    }\n\n    // 4. R√©cup√©rer le profil du propri√©taire pour les infos de l'agence\n    const { data: profile } = await supabase\n        .from('profiles')\n        .select('company_name, company_address, company_email, company_ninea, signature_url, logo_url, full_name')\n        .eq('id', user.id)\n        .maybeSingle();\n\n    // 5. Envoi automatique de la quittance par email (Gmail direct) - SAUF si mode silent\n    let emailSent = false;\n\n    if (!silent && trans && trans.leases && trans.leases.tenant_email) {\n        try {\n            // Pr√©parer les donn√©es pour la quittance\n            const receiptData = {\n                // Locataire\n                tenantName: trans.leases.tenant_name || 'Locataire',\n                tenantEmail: trans.leases.tenant_email,\n                tenantAddress: trans.leases.property_address || '',\n\n                // Montants\n                amount: trans.amount_due || 0,\n\n                // P√©riode\n                periodMonth: new Date(trans.period_year, trans.period_month - 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }),\n                periodStart: `01/${String(trans.period_month).padStart(2, '0')}/${trans.period_year}`,\n                periodEnd: `${new Date(trans.period_year, trans.period_month, 0).getDate()}/${String(trans.period_month).padStart(2, '0')}/${trans.period_year}`,\n\n                // R√©f√©rence\n                receiptNumber: `QUITT-${Date.now().toString().slice(-8)}`,\n\n                // ID pour sauvegarde automatique\n                leaseId: trans.lease_id,\n\n                // Propri√©taire / Agence\n                ownerName: profile?.company_name || profile?.full_name || 'Propri√©taire',\n                ownerAddress: profile?.company_address || '',\n                ownerNinea: profile?.company_ninea || '',\n                ownerLogo: profile?.logo_url || undefined,\n                ownerSignature: profile?.signature_url || undefined,\n                ownerEmail: profile?.company_email || undefined, // Email de l'agence (priorit√©)\n                ownerAccountEmail: user.email, // Email du compte (fallback)\n\n                // Propri√©t√©\n                propertyAddress: trans.leases.property_address || 'Adresse non renseign√©e',\n            };\n\n            try {\n                // Appeler l'API de g√©n√©ration de quittance (PDF)\n                // Note: fetch interne n√©cessite l'URL absolue en Server Actions\n                const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://doussell-immo.com';\n                const start = performance.now();\n                const response = await fetch(`${baseUrl}/api/send-receipt`, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(receiptData),\n                });\n                console.log(`[confirmPayment] Receipt API call took ${Math.round(performance.now() - start)}ms`);\n\n                if (response.ok) {\n                    emailSent = true;\n                    console.log(\"[confirmPayment] Quittance envoy√©e par email\");\n                } else {\n                    console.error(\"[confirmPayment] Erreur API quittance:\", await response.text());\n                }\n            } catch (err) {\n                console.error(\"[confirmPayment] Exception API quittance:\", err);\n            }\n        } catch (err) {\n            console.error(\"Erreur g√©n√©rale quittance:\", err);\n        }\n    }\n\n    // PRIORIT√â : Invalider le cache AVANT revalidatePath pour m√†j UI imm√©diate\n    try {\n        // Invalidation directe de la cl√© de transaction sp√©cifique\n        await invalidateCacheBatch([`rental_transactions:${leaseId}`], 'rentals');\n\n        // Puis invalidation globale\n        await invalidateRentalCaches(teamId, leaseId, {\n            invalidateLeases: true,\n            invalidateTransactions: true,\n            invalidateStats: true\n        });\n    } catch (e) {\n        console.error(\"[confirmPayment] Cache invalidation error:\", e);\n    }\n\n    // üî• CACHE WARMING (Pr√©-chauffage)\n    // Pour √©viter le \"Thundering Herd\" (Timeouts) quand le dashboard se rafra√Æchit\n    // on relance imm√©diatement les requ√™tes lourdes pour repeupler le cache Redis\n    // de mani√®re s√©quentielle AVANT que le client ne fasse ses requ√™tes parall√®les.\n    try {\n        console.log(\"[confirmPayment] üî• Warming up cache...\");\n        await Promise.all([\n            getRentalTransactions([], teamId), // R√©cup√©rer toutes les transactions\n            getLeasesByTeam(teamId, \"active\"), // R√©cup√©rer les baux actifs\n            getRentalStatsByTeam(teamId)       // Recalculer les stats\n        ]);\n        console.log(\"[confirmPayment] ‚úÖ Cache warmed up!\");\n    } catch (warmError) {\n        console.error(\"[confirmPayment] ‚ö†Ô∏è Cache warming failed:\", warmError);\n    }\n\n    // Revalider les pages APR√àS l'invalidation du cache\n    revalidatePath('/gestion');\n    revalidatePath(`/gestion/locataires/${leaseId}`);\n\n    // Message personnalis√© selon si l'email a √©t√© d√©clench√©\n    const message = emailSent\n        ? `Paiement valid√© ! La quittance sera envoy√©e par email au locataire (${trans.leases?.tenant_email}) avec copie au propri√©taire.`\n        : \"Paiement valid√© ! Vous pouvez g√©n√©rer la quittance manuellement.\";\n\n    return { success: true, message };\n}\n\n/**\n * Met √† jour les informations d'un locataire/bail\n */\nexport async function updateLease(leaseId: string, data: {\n    tenant_name?: string;\n    tenant_phone?: string;\n    tenant_email?: string;\n    property_address?: string;\n    monthly_amount?: number;\n    billing_day?: number;\n    start_date?: string;\n    end_date?: string;\n}) {\n    const { teamId, _user } = await getUserTeamContext();\n    await requireTeamPermission('leases.edit');\n\n    const supabase = await createClient();\n\n    // 1. V√©rifier que le bail appartient √† l'√©quipe\n    const { data: lease, error: fetchError } = await supabase\n        .from('leases')\n        .select('owner_id, team_id, property_id')\n        .eq('id', leaseId)\n        .eq('team_id', teamId)\n        .single();\n\n    if (fetchError || !lease) {\n        return { success: false, error: \"Bail non trouv√© ou non autoris√©\" };\n    }\n\n    // 2. Pr√©parer les donn√©es de mise √† jour\n    const updateData: Record<string, string | number | undefined> = {};\n    if (data.tenant_name !== undefined) updateData.tenant_name = data.tenant_name;\n    if (data.tenant_phone !== undefined) updateData.tenant_phone = data.tenant_phone;\n    if (data.tenant_email !== undefined) updateData.tenant_email = data.tenant_email;\n    if (data.property_address !== undefined) updateData.property_address = data.property_address;\n    if (data.monthly_amount !== undefined) updateData.monthly_amount = data.monthly_amount;\n    if (data.billing_day !== undefined) updateData.billing_day = data.billing_day;\n    if (data.start_date !== undefined) updateData.start_date = data.start_date;\n    if (data.end_date !== undefined) updateData.end_date = data.end_date;\n\n    const { error: updateError } = await supabase\n        .from('leases')\n        .update(updateData)\n        .eq('id', leaseId)\n        .eq('team_id', teamId);\n\n    if (updateError) {\n        console.error(\"Erreur mise √† jour bail:\", updateError.message);\n        return { success: false, error: updateError.message };\n    }\n\n    // 3. Si le bail est li√© √† une propri√©t√©, mettre √† jour la propri√©t√© aussi\n    if (lease.property_id && updateData.property_address) {\n        const { error: propError } = await supabase\n            .from('properties')\n            .update({\n                title: updateData.property_address as string\n            })\n            .eq('id', lease.property_id)\n            .eq('team_id', teamId);\n\n        if (propError) {\n            console.warn(\"Erreur mise √† jour propri√©t√© li√©e:\", propError.message);\n        }\n    }\n\n    // 4. Invalidation du cache\n    await invalidateRentalCaches(teamId, leaseId, {\n        invalidateLeases: true,\n        invalidateTransactions: false,\n        invalidateStats: true\n    });\n\n    revalidatePath('/gestion');\n    return { success: true };\n}\n\n/**\n * Lier un bail orphelin √† un bien existant\n * Utilis√© apr√®s import en masse pour la r√©conciliation\n */\nexport async function linkLeaseToProperty(leaseId: string, propertyId: string) {\n    const { teamId, _user } = await getUserTeamContext();\n    await requireTeamPermission('leases.edit');\n\n    const supabase = await createClient();\n\n    // 1. V√©rifier que le bail et le bien appartiennent √† l'√©quipe\n    const { data: lease, error: leaseErr } = await supabase\n        .from('leases')\n        .select('id')\n        .eq('id', leaseId)\n        .eq('team_id', teamId)\n        .single();\n\n    const { data: property, error: propErr } = await supabase\n        .from('properties')\n        .select('id, title, location')\n        .eq('id', propertyId)\n        .eq('team_id', teamId)\n        .single();\n\n    if (leaseErr || !lease || propErr || !property) {\n        return { success: false, error: \"Bail ou bien non trouv√© ou non autoris√©\" };\n    }\n\n    // 2. Pr√©parer l'adresse du bien\n    const propertyAddress = (property as any).location?.address ||\n        `${(property as any).location?.district || ''}, ${(property as any).location?.city || ''}`.trim() ||\n        property.title;\n\n    // 3. Faire la liaison\n    const { error: linkError } = await supabase\n        .from('leases')\n        .update({\n            property_id: propertyId,\n            property_address: propertyAddress\n        })\n        .eq('id', leaseId)\n        .eq('team_id', teamId);\n\n    if (linkError) {\n        console.error(\"Erreur liaison bail-bien:\", linkError.message);\n        return { success: false, error: linkError.message };\n    }\n\n    // 4. Mettre √† jour le statut du bien en \"lou√©\"\n    await supabase\n        .from('properties')\n        .update({ status: 'lou√©' })\n        .eq('id', propertyId)\n        .eq('team_id', teamId);\n\n    // 5. Invalider cache\n    await invalidateRentalCaches(teamId, leaseId, {\n        invalidateLeases: true,\n        invalidateStats: true\n    });\n\n    revalidatePath('/gestion');\n    return { success: true };\n}\n\n/**\n * R√©silier un bail (Suppression logique - conserve l'historique)\n * Change le statut √† 'terminated' et enregistre la date de fin\n */\nexport async function terminateLease(leaseId: string) {\n    const { teamId, _user } = await getUserTeamContext();\n    await requireTeamPermission('leases.terminate');\n\n    const supabase = await createClient();\n\n    // 1. R√©cup√©rer le bail pour confirmation (s√©curis√© par teamId)\n    const { data: lease, error: fetchError } = await supabase\n        .from('leases')\n        .select('*')\n        .eq('id', leaseId)\n        .eq('team_id', teamId)\n        .single();\n\n    if (fetchError || !lease) {\n        return { success: false, error: \"Bail introuvable ou non autoris√©\" };\n    }\n\n    // 2. R√©silier le bail\n    const { error: updateError } = await supabase\n        .from('leases')\n        .update({\n            status: 'terminated',\n            end_date: new Date().toISOString()\n        })\n        .eq('id', leaseId)\n        .eq('team_id', teamId);\n\n    if (updateError) {\n        console.error(\"Erreur r√©siliation bail:\", updateError.message);\n        return { success: false, error: updateError.message };\n    }\n\n    // 3. Invalider caches\n    await invalidateRentalCaches(teamId, leaseId, {\n        invalidateLeases: true,\n        invalidateTransactions: false,\n        invalidateStats: true\n    });\n\n    revalidatePath('/gestion');\n    return {\n        success: true,\n        message: `Le bail de ${lease.tenant_name} a √©t√© r√©sili√©.`\n    };\n}\n\n/**\n * R√©activer un bail r√©sili√©\n * Change le statut de 'terminated' √† 'active'\n */\nexport async function reactivateLease(leaseId: string) {\n    const { teamId, _user } = await getUserTeamContext();\n    await requireTeamPermission('leases.edit');\n\n    const supabase = await createClient();\n\n    // R√©activer le bail\n    const { error } = await supabase\n        .from('leases')\n        .update({\n            status: 'active'\n        })\n        .eq('id', leaseId)\n        .eq('team_id', teamId);\n\n    if (error) {\n        console.error(\"Erreur r√©activation bail:\", error.message);\n        return { success: false, error: error.message };\n    }\n\n    // 3. Invalider caches\n    await invalidateCacheBatch([\n        `leases:${teamId}:active`,\n        `leases:${teamId}:terminated`,\n        `leases:${teamId}:all`,\n        `lease_detail:${leaseId}`,\n        `rental_stats:${teamId}`\n    ], 'rentals');\n\n    revalidatePath('/gestion');\n    return {\n        success: true,\n        message: \"L'op√©ration a √©t√© effectu√©e avec succ√®s.\"\n    };\n}\n\n/**\n * Signaler une demande de maintenance\n * Peut √™tre signal√© par le propri√©taire (avec s√©lection du bail) ou le locataire\n */\nexport async function createMaintenanceRequest(data: {\n    leaseId?: string;\n    description: string;\n    category?: string;\n}) {\n    const { teamId, _user } = await getUserTeamContext();\n    await requireTeamPermission('maintenance.create');\n\n    const supabase = await createClient();\n\n    // Si pas de leaseId fourni, prendre le premier bail actif du propri√©taire\n    let targetLeaseId = data.leaseId;\n\n    if (!targetLeaseId) {\n        const { data: firstLease } = await supabase\n            .from('leases')\n            .select('id')\n            .eq('team_id', teamId)\n            .eq('status', 'active')\n            .limit(1)\n            .single();\n\n        if (!firstLease) {\n            return { success: false, error: \"Aucun bail actif trouv√© pour cette √©quipe\" };\n        }\n        targetLeaseId = firstLease.id;\n    }\n\n    // 1. R√©cup√©rer les infos du bail pour le contexte (Adresse pour Google Maps)\n    const { data: leaseContext } = await supabase\n        .from('leases')\n        .select('property_address, tenant_name, tenant_phone, tenant_email, property_id')\n        .eq('id', targetLeaseId)\n        .eq('team_id', teamId)\n        .single();\n\n    // Variables pour stocker les infos artisan\n    let artisanData: {\n        name?: string;\n        phone?: string;\n        rating?: number;\n        address?: string;\n    } = {};\n    let status = 'open';\n\n    // 2. APPEL DU WEBHOOK MAKE (Recherche Artisan)\n    const MAKE_WEBHOOK_URL = process.env.MAKE_WEBHOOK_URL || process.env.N8N_WEBHOOK_URL;\n\n    if (MAKE_WEBHOOK_URL) {\n        try {\n            const response = await fetch(MAKE_WEBHOOK_URL, {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    category: data.category || \"General\",\n                    location: leaseContext?.property_address || \"Dakar, S√©n√©gal\",\n                    issue: data.description,\n                    tenantName: leaseContext?.tenant_name,\n                    tenantPhone: leaseContext?.tenant_phone,\n                    tenantEmail: leaseContext?.tenant_email,\n                    webhookType: 'find_artisan'\n                })\n            });\n\n            if (response.ok) {\n                const result = await response.json();\n                if (result.artisan_name) {\n                    artisanData = {\n                        name: result.artisan_name,\n                        phone: result.artisan_phone,\n                        rating: parseFloat(result.rating) || undefined,\n                        address: result.address\n                    };\n                    status = 'artisan_found'; // Nouveau statut clair\n                }\n            }\n        } catch (e) {\n            console.error(\"Erreur Webhook Make:\", e);\n        }\n    }\n\n    // 3. ENREGISTRER EN BASE\n    const { data: request, error: insertError } = await supabase\n        .from('maintenance_requests')\n        .insert([{\n            lease_id: targetLeaseId,\n            property_id: leaseContext?.property_id,\n            team_id: teamId,\n            description: data.description,\n            category: data.category || 'General',\n            status: status || 'open', // 'open' triggers artisan search if artisan found, otherwise searching\n            artisan_name: artisanData.name,\n            artisan_phone: artisanData.phone,\n            artisan_rating: artisanData.rating,\n            artisan_address: artisanData.address,\n            created_at: new Date().toISOString()\n        }])\n        .select()\n        .single();\n\n    if (insertError) {\n        console.error(\"Erreur cr√©ation demande maintenance:\", insertError.message);\n        return { success: false, error: insertError.message };\n    }\n\n    revalidatePath('/gestion');\n\n    return {\n        success: true,\n        id: request.id,\n        artisanFound: status === 'artisan_found',\n        artisan: artisanData.name ? artisanData : null,\n        message: status === 'artisan_found' ? \"Artisan trouv√© !\" : \"Demande enregistr√©e.\"\n    };\n}\n\n/**\n * Saisir le devis r√©el apr√®s contact avec l'artisan\n * Passe le statut √† 'awaiting_approval' pour validation propri√©taire\n */\nexport async function submitQuote(requestId: string, data: {\n    quoted_price: number;\n    intervention_date: string;\n    quote_url?: string;\n}) {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Non autoris√©\" };\n\n    // 1. R√©cup√©rer les infos pour le PDF\n    const { data: request, error: reqError } = await supabase\n        .from('maintenance_requests')\n        .select(`\n            id, \n            description, \n            category, \n            lease_id,\n            artisan_name,\n            artisan_phone,\n            leases (\n                tenant_name,\n                property_id,\n                properties (\n                    title,\n                    location\n                )\n            )\n        `)\n        .eq('id', requestId)\n        .single();\n\n    if (reqError || !request) return { success: false, error: \"Intervention introuvable\" };\n\n    // 2. R√©cup√©rer le profil du propri√©taire pour le branding\n    const { data: profile } = await supabase\n        .from('profiles')\n        .select('full_name, company_name, company_address, logo_url')\n        .eq('id', user.id)\n        .single();\n\n    let finalQuoteUrl = data.quote_url;\n\n    try {\n        let fileBuffer: Uint8Array | null = null;\n        let fileName = `Devis_${request.category || 'Intervention'}_${requestId.slice(0, 5)}.pdf`;\n        let isAutoGenerated = false;\n\n        // 3. Pr√©parer le buffer (G√©n√©ration ou T√©l√©chargement pour standardisation)\n        if (!finalQuoteUrl) {\n            // G√©n√©ration Auto\n            const pdfBytes = await generateMaintenancePDF({\n                requestId: request.id,\n                description: request.description,\n                category: request.category || 'Maintenance',\n                interventionDate: data.intervention_date,\n                quotedPrice: data.quoted_price,\n                propertyTitle: (request.leases as any)?.properties?.title || 'Bien non sp√©cifi√©',\n                propertyAddress: (request.leases as any)?.properties?.location?.address || '',\n                tenantName: (request.leases as any)?.tenant_name || 'Locataire',\n                artisanName: request.artisan_name || undefined,\n                artisanPhone: request.artisan_phone || undefined,\n                ownerName: profile?.full_name || 'Propri√©taire',\n                ownerCompany: profile?.company_name || undefined,\n                ownerAddress: profile?.company_address || undefined,\n                logoUrl: profile?.logo_url || undefined,\n            });\n            fileBuffer = pdfBytes;\n            fileName = `auto_quote_${requestId}_${Date.now()}.pdf`;\n            isAutoGenerated = true;\n        } else {\n            // R√©cup√©ration fichier existant (upload manuel client)\n            // On le r√©cup√®re pour le r√©-uploader proprement via GED (standardisation metadonn√©es)\n            const response = await fetch(finalQuoteUrl);\n            if (!response.ok) throw new Error(\"Impossible de r√©cup√©rer le fichier upload√©\");\n            const arrayBuffer = await response.arrayBuffer();\n            fileBuffer = new Uint8Array(arrayBuffer);\n            fileName = `manual_quote_${requestId}_${Date.now()}.pdf`;\n        }\n\n        // 4. Stockage unifi√© via GED\n        // Utilisation du bucket 'properties' car les fichiers doivent √™tre accessibles publiquement (pour le tenant)\n        // storeDocumentInGED g√®re aussi l'inscription dans user_documents\n        const gedResult = await storeDocumentInGED({\n            userId: user.id,\n            fileBuffer: fileBuffer!,\n            fileName: fileName,\n            bucketName: 'properties',\n            documentType: 'maintenance',\n            metadata: {\n                requestId: requestId,\n                propertyId: (request.leases as any)?.property_id || null,\n                leaseId: request.lease_id || null,\n                tenantName: (request.leases as any)?.tenant_name,\n                description: `Devis ${isAutoGenerated ? 'auto' : 'manuel'} pour : ${request.description.slice(0, 50)}`\n            }\n        }, supabase);\n\n        if (gedResult.success && gedResult.fileUrl) {\n            finalQuoteUrl = gedResult.fileUrl;\n        } else {\n            console.error(\"Erreur GED:\", gedResult.error);\n            // Si auto-g√©n√©r√© et √©chec GED, c'est bloquant car on n'a pas d'URL\n            if (isAutoGenerated && !finalQuoteUrl) throw new Error(\"Echec stockage GED du devis auto: \" + (gedResult.error || \"erreur inconnue\"));\n        }\n\n    } catch (err: any) {\n        console.error(\"Erreur traitement devis:\", err);\n        return { success: false, error: \"Erreur lors du traitement du document: \" + err.message };\n    }\n\n    const { error } = await supabase\n        .from('maintenance_requests')\n        .update({\n            quoted_price: data.quoted_price,\n            intervention_date: data.intervention_date,\n            quote_url: finalQuoteUrl,\n            status: 'awaiting_approval' // En attente de validation propri√©taire\n        })\n        .eq('id', requestId);\n\n    if (error) {\n        console.error(\"Erreur saisie devis:\", error.message);\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion');\n    return { success: true, message: \"Devis enregistr√©, en attente de validation.\" };\n}\n\n/**\n * R√©pondre √† une demande de report du locataire\n */\nexport async function handleOwnerRescheduleResponse(requestId: string, action: 'accept' | 'decline', newDate?: string) {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Non autoris√©\" };\n\n    const updateData: any = {};\n    if (action === 'accept') {\n        // R√©cup√©rer la date sugg√©r√©e\n        const { data: request } = await supabase\n            .from('maintenance_requests')\n            .select('tenant_suggested_date')\n            .eq('id', requestId)\n            .single();\n\n        if (request?.tenant_suggested_date) {\n            updateData.intervention_date = request.tenant_suggested_date;\n            updateData.tenant_response = 'confirmed'; // On remet √† confirm√©\n            updateData.tenant_suggested_date = null;\n        }\n    } else if (newDate) {\n        updateData.intervention_date = newDate;\n        updateData.tenant_response = null; // On attend la nouvelle r√©ponse du locataire\n        updateData.tenant_suggested_date = null;\n    }\n\n    const { error } = await supabase\n        .from('maintenance_requests')\n        .update(updateData)\n        .eq('id', requestId);\n\n    if (error) {\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion');\n    return { success: true, message: action === 'accept' ? \"Nouveau cr√©neau accept√©.\" : \"Nouvelle date propos√©e.\" };\n}\n\n/**\n * Valider une demande de maintenance (Locataire -> Recherche Artisan)\n * Passe le statut de 'submitted' √† 'open' et d√©clenche le webhook de recherche\n */\nexport async function validateMaintenanceRequest(requestId: string) {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Non autoris√©\" };\n\n    // 1. R√©cup√©rer les d√©tails de la demande\n    const { data: request, error: fetchError } = await supabase\n        .from('maintenance_requests')\n        .select(`\n            *,\n            leases(property_address, tenant_name, tenant_phone, tenant_email)\n        `)\n        .eq('id', requestId)\n        .single();\n\n    if (fetchError || !request) {\n        return { success: false, error: \"Intervention introuvable\" };\n    }\n\n    const lease = Array.isArray(request.leases) ? request.leases[0] : request.leases;\n\n    // 2. Tenter de trouver un artisan via Webhook (comme lors de la cr√©ation directe par owner)\n    let artisanData: {\n        name?: string;\n        phone?: string;\n        rating?: number;\n        address?: string;\n    } = {};\n    let newStatus = 'open';\n\n    const MAKE_WEBHOOK_URL = process.env.MAKE_WEBHOOK_URL || process.env.N8N_WEBHOOK_URL;\n\n    if (MAKE_WEBHOOK_URL) {\n        try {\n            const response = await fetch(MAKE_WEBHOOK_URL, {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    category: request.category || \"General\",\n                    location: lease?.property_address || \"Dakar, S√©n√©gal\",\n                    issue: request.description,\n                    tenantName: lease?.tenant_name,\n                    tenantPhone: lease?.tenant_phone,\n                    tenantEmail: lease?.tenant_email,\n                    webhookType: 'find_artisan'\n                })\n            });\n\n            if (response.ok) {\n                const result = await response.json();\n                if (result.artisan_name) {\n                    artisanData = {\n                        name: result.artisan_name,\n                        phone: result.artisan_phone,\n                        rating: parseFloat(result.rating) || undefined,\n                        address: result.address\n                    };\n                    newStatus = 'artisan_found';\n                }\n            }\n        } catch (e) {\n            console.error(\"Erreur Webhook validation:\", e);\n        }\n    }\n\n    // 3. Mettre √† jour la demande\n    const { error: updateError } = await supabase\n        .from('maintenance_requests')\n        .update({\n            status: newStatus,\n            artisan_name: artisanData.name,\n            artisan_phone: artisanData.phone,\n            artisan_rating: artisanData.rating,\n            artisan_address: artisanData.address,\n        })\n        .eq('id', requestId);\n\n    if (updateError) {\n        return { success: false, error: updateError.message };\n    }\n\n    revalidatePath('/gestion');\n    return {\n        success: true,\n        message: newStatus === 'artisan_found' ? \"Intervention valid√©e et artisan trouv√© !\" : \"Intervention valid√©e, recherche d'artisan en cours...\"\n    };\n}\n\n/**\n * Rejeter une demande de maintenance\n */\nexport async function rejectMaintenanceRequest(requestId: string, reason?: string) {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Non autoris√©\" };\n\n    const { error } = await supabase\n        .from('maintenance_requests')\n        .update({\n            status: 'rejected',\n            rejection_reason: reason\n        })\n        .eq('id', requestId);\n\n    if (error) {\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion');\n    return { success: true, message: \"Signalement rejet√©.\" };\n}\n\n/**\n * Le propri√©taire approuve le devis\n * Passe le statut √† 'approved' et lance les travaux\n */\nexport async function approveQuoteByOwner(requestId: string) {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Non autoris√©\" };\n\n    const { data: request, error } = await supabase\n        .from('maintenance_requests')\n        .update({\n            status: 'approved',\n            owner_approved: true\n        })\n        .eq('id', requestId)\n        .select('*, leases(tenant_name, tenant_email, owner_id)')\n        .single();\n\n    if (error) {\n        console.error(\"Erreur approbation devis:\", error.message);\n        return { success: false, error: error.message };\n    }\n\n    // R√©cup√©rer les informations compl√®tes du bail pour l'email\n    const lease = Array.isArray(request.leases) ? request.leases[0] : request.leases;\n    const tenantEmail = lease?.tenant_email;\n    const tenantName = lease?.tenant_name;\n\n    // Notification √† l'artisan via webhook\n    await triggerN8N('maintenance-quote-approved', {\n        requestId: request.id,\n        description: request.description,\n        quoteAmount: request.quoted_price,\n        artisanPhone: request.artisan_phone\n    });\n\n    // Notification au locataire par email (Nodemailer)\n    if (tenantEmail && request.artisan_name) {\n        const datePrevue = request.intervention_date\n            ? new Date(request.intervention_date).toLocaleString('fr-FR', {\n                day: 'numeric',\n                month: 'long',\n                year: 'numeric',\n                hour: '2-digit',\n                minute: '2-digit'\n            }).replace(':', 'h')\n            : '√† confirmer';\n\n        try {\n            await sendEmail({\n                to: tenantEmail,\n                subject: `‚úÖ Intervention valid√©e : ${request.description}`,\n                html: `\n                    <div style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; background-color: #f9fafb; padding: 20px;\">\n                        <div style=\"background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 30px 20px; border-radius: 10px 10px 0 0; text-align: center;\">\n                            <h1 style=\"margin: 0; font-size: 24px;\">‚úÖ Intervention Valid√©e</h1>\n                        </div>\n\n                        <div style=\"background-color: white; padding: 30px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n                            <p style=\"font-size: 16px; color: #374151; margin-bottom: 20px;\">\n                                Bonjour <strong>${tenantName || 'Locataire'}</strong>,\n                            </p>\n\n                            <p style=\"font-size: 14px; color: #6b7280; line-height: 1.6;\">\n                                Bonne nouvelle ! La demande d'intervention pour <strong style=\"color: #16a34a;\">${request.description}</strong> a √©t√© valid√©e par le propri√©taire.\n                            </p>\n\n                            <div style=\"background-color: #f0fdf4; border-left: 4px solid #16a34a; padding: 20px; margin: 25px 0; border-radius: 8px;\">\n                                <p style=\"margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #15803d; font-weight: bold;\">\n                                    üë∑‚Äç‚ôÇÔ∏è Artisan Assign√©\n                                </p>\n                                <h2 style=\"margin: 10px 0; font-size: 20px; color: #111827;\">${request.artisan_name}</h2>\n\n                                <div style=\"margin-top: 15px;\">\n                                    <p style=\"margin: 5px 0; font-size: 14px; color: #374151;\">\n                                        <strong>üìû T√©l√©phone :</strong>\n                                        <a href=\"tel:${request.artisan_phone}\" style=\"color: #16a34a; text-decoration: none; font-weight: 600;\">${request.artisan_phone}</a>\n                                    </p>\n                                    ${request.artisan_address ? `\n                                    <p style=\"margin: 5px 0; font-size: 14px; color: #374151;\">\n                                        <strong>üìç Adresse :</strong> ${request.artisan_address}\n                                    </p>` : ''}\n                                    <p style=\"margin: 5px 0; font-size: 14px; color: #374151;\">\n                                        <strong>üìÖ Date pr√©vue :</strong> ${datePrevue}\n                                    </p>\n                                    ${request.quoted_price ? `\n                                    <p style=\"margin: 5px 0; font-size: 14px; color: #374151;\">\n                                        <strong>üí∞ Montant :</strong> ${request.quoted_price.toLocaleString('fr-FR')} FCFA\n                                    </p>` : ''}\n                                </div>\n                            </div>\n\n                            <div style=\"background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin-top: 20px;\">\n                                <p style=\"margin: 0; font-size: 13px; color: #92400e;\">\n                                    <strong>‚ÑπÔ∏è Que faire maintenant ?</strong><br/>\n                                    L'artisan a √©t√© notifi√© et devrait vous contacter sous peu. Si vous ne recevez pas d'appel dans les 24h, n'h√©sitez pas √† le contacter directement au num√©ro ci-dessus.\n                                </p>\n                            </div>\n\n                            <p style=\"font-size: 14px; color: #6b7280; margin-top: 30px; line-height: 1.6;\">\n                                Cordialement,<br/>\n                                <strong style=\"color: #111827;\">L'√©quipe de Gestion</strong>\n                            </p>\n\n                            <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 25px 0;\" />\n\n                            <p style=\"font-size: 11px; color: #9ca3af; text-align: center; margin: 0;\">\n                                Cet email a √©t√© envoy√© automatiquement. Pour toute question, contactez votre propri√©taire.\n                            </p>\n                        </div>\n                    </div>\n                `\n            });\n            console.log(`‚úÖ Email envoy√© √† ${tenantEmail} pour intervention ${request.description}`);\n        } catch (emailError) {\n            console.error(\"‚ùå Erreur envoi email locataire:\", emailError);\n            // On ne bloque pas le workflow si l'email √©choue\n        }\n    }\n\n    revalidatePath('/gestion');\n    return { success: true, message: \"Devis approuv√© ! Le locataire et l'artisan ont √©t√© notifi√©s.\" };\n}\n\n/**\n * Terminer l'intervention et cr√©er la d√©pense comptable\n * Cr√©e automatiquement une ligne dans la table 'expenses'\n */\nexport async function completeIntervention(requestId: string) {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Non autoris√©\" };\n\n    // 1. R√©cup√©rer les d√©tails de l'intervention\n    const { data: request, error: fetchError } = await supabase\n        .from('maintenance_requests')\n        .select('*, leases(owner_id, property_id)')\n        .eq('id', requestId)\n        .single();\n\n    if (fetchError || !request) {\n        return { success: false, error: \"Intervention introuvable\" };\n    }\n\n    // V√©rifier que le devis a √©t√© approuv√©\n    if (!request.owner_approved) {\n        return { success: false, error: \"Le devis doit √™tre approuv√© avant de terminer.\" };\n    }\n\n    // 2. Mettre √† jour le statut de l'intervention\n    const { error: updateError } = await supabase\n        .from('maintenance_requests')\n        .update({\n            status: 'completed',\n            completed_at: new Date().toISOString()\n        })\n        .eq('id', requestId);\n\n    if (updateError) {\n        return { success: false, error: updateError.message };\n    }\n\n    // 3. Cr√©er la d√©pense comptable\n    const leaseData = Array.isArray(request.leases) ? request.leases[0] : request.leases;\n\n    if (leaseData && request.quoted_price) {\n        const { error: expenseError } = await supabase\n            .from('expenses')\n            .insert([{\n                owner_id: user.id,\n                property_id: leaseData.property_id || null,\n                // maintenance_request_id: requestId, // Commenting out potential invalid column, enabling if confirmed\n                lease_id: request.lease_id || null, // Best guess mapping\n                description: `Intervention: ${request.description} (${request.artisan_name || 'Artisan'})`,\n                amount: request.quoted_price,\n                category: 'maintenance',\n                expense_date: new Date().toISOString().split('T')[0]\n                // If maintenance_request_id exists in DB, uncomment below:\n                // maintenance_request_id: requestId, \n            }]);\n\n        if (expenseError) {\n            console.error(\"Erreur cr√©ation d√©pense:\", expenseError.message);\n            // On ne bloque pas la cl√¥ture\n        }\n    }\n\n    revalidatePath('/gestion');\n    return {\n        success: true,\n        message: `Intervention termin√©e ! D√©pense de ${request.quoted_price?.toLocaleString('fr-FR')} FCFA enregistr√©e.`\n    };\n}\n\n/**\n * Envoyer une invitation au portail locataire\n * G√©n√®re un lien magique (Magic Link) et l'envoie par email\n */\nexport async function sendTenantInvitation(leaseId: string) {\n    const { teamId, user } = await getUserTeamContext();\n    if (!user) return { success: false, error: \"Non autoris√©\" };\n\n    const supabase = await createClient();\n    // 1. R√©cup√©rer les infos du locataire\n    const { data: lease } = await supabase\n        .from('leases')\n        .select('tenant_name, tenant_email, property_address, team_id')\n        .eq('id', leaseId)\n        .eq('team_id', teamId)\n        .single();\n\n    if (!lease) return { success: false, error: \"Bail introuvable\" };\n    if (lease.team_id !== teamId) return { success: false, error: \"Non autoris√©\" };\n    if (!lease.tenant_email) return { success: false, error: \"Email du locataire manquant\" };\n\n    // 2. G√©n√©rer le token d'acc√®s locataire (syst√®me custom, cookie-based)\n    const { generateTenantAccessToken, getTenantMagicLinkUrl } = await import('@/lib/tenant-magic-link');\n    const rawToken = await generateTenantAccessToken(leaseId);\n    const magicLink = getTenantMagicLinkUrl(rawToken);\n\n    // 3. Envoyer l'email\n    try {\n        await sendEmail({\n            to: lease.tenant_email,\n            subject: `Invitation √† votre Espace Locataire - Dousell`,\n            html: `\n                <div style=\"font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px;\">\n                     <div style=\"text-align: center; margin-bottom: 24px;\">\n                        <h2 style=\"color: #F4C430; margin-bottom: 8px;\">Bienvenue sur Dousell Immo</h2>\n                        <p style=\"color: #6b7280; font-size: 14px;\">Votre portail locataire est pr√™t</p>\n                    </div>\n\n                    <div style=\"margin-bottom: 24px;\">\n                        <p style=\"color: #374151;\">Bonjour <strong>${lease.tenant_name}</strong>,</p>\n                        <p style=\"color: #374151; line-height: 1.5;\">\n                            Votre propri√©taire vous invite √† rejoindre votre espace locataire pour le bien situ√© √† :\n                        </p>\n                        <div style=\"background-color: #f3f4f6; padding: 12px; border-radius: 6px; margin: 12px 0; font-size: 14px; color: #111827;\">\n                            ${lease.property_address || 'Adresse non renseign√©e'}\n                        </div>\n                    </div>\n\n                    <div style=\"background-color: #fefce8; border: 1px solid #fde047; border-radius: 6px; padding: 16px; margin-bottom: 24px;\">\n                        <h3 style=\"color: #854d0e; margin: 0 0 8px 0; font-size: 16px;\">Ce que vous pouvez faire :</h3>\n                        <ul style=\"margin: 0; padding-left: 20px; color: #a16207; font-size: 14px;\">\n                            <li style=\"margin-bottom: 4px;\">Payer votre loyer en ligne</li>\n                            <li style=\"margin-bottom: 4px;\">T√©l√©charger vos quittances</li>\n                            <li>Signaler un incident</li>\n                        </ul>\n                    </div>\n\n                    <div style=\"text-align: center; margin: 32px 0;\">\n                        <a href=\"${magicLink}\"\n                           style=\"display: inline-block; background-color: #F4C430; color: #000000; padding: 12px 32px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n                            Acc√©der √† mon espace\n                        </a>\n                        <p style=\"margin-top: 12px; font-size: 12px; color: #9ca3af;\">\n                            Ce lien d'acc√®s est personnel et valide pour 7 jours.\n                        </p>\n                    </div>\n\n                    <p style=\"color: #6b7280; font-size: 13px; text-align: center; margin-top: 15px;\">\n                        Le lien ne fonctionne pas ? Copiez et collez cette URL dans votre navigateur :<br>\n                        <code style=\"background: #f3f4f6; padding: 8px; display: inline-block; margin-top: 5px; word-break: break-all; font-size: 11px;\">${magicLink}</code>\n                    </p>\n\n                    <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 24px 0;\" />\n\n                    <p style=\"font-size: 12px; color: #9ca3af; text-align: center;\">\n                        Si vous n'√™tes pas le destinataire de cet email, merci de l'ignorer.<br>\n                        &copy; ${new Date().getFullYear()} Dousell Immo.\n                    </p>\n                </div>\n            `\n        });\n\n        return { success: true, message: `Invitation envoy√©e √† ${lease.tenant_email}` };\n\n    } catch (emailError) {\n        console.error(\"Erreur envoi email invitation:\", emailError);\n        return { success: false, error: \"Erreur lors de l'envoi de l'email\" };\n    }\n}\n\n\n\n\n\n/**\n * R√©cup√©rer les baux actifs (pour le select du formulaire de signalement)\n */\nexport async function getActiveLeases() {\n    const { teamId, user } = await getUserTeamContext();\n\n    if (!user) {\n        return { success: false, data: [] };\n    }\n\n    const supabase = await createClient();\n    const { data: leases, error } = await supabase\n        .from('leases')\n        .select('id, tenant_name, property_address')\n        .eq('status', 'active')\n        .eq('team_id', teamId);\n\n    if (error) {\n        return { success: false, data: [] };\n    }\n\n    return { success: true, data: leases || [] };\n}\n\n/**\n * Envoie les donn√©es de quittance √† Pipedream\n * Formate correctement le payload pour le webhook Pipedream\n */\nexport async function sendReceiptToN8N(data: Record<string, unknown>) {\n    // 1. On r√©cup√®re l'URL Pipedream d√©finie dans .env.local\n    const WEBHOOK_URL = process.env.NEXT_PUBLIC_WEBHOOK_URL;\n\n    if (!WEBHOOK_URL) {\n        console.error(\"URL Pipedream manquante !\");\n        return { success: false, error: \"Configuration webhook manquante\" };\n    }\n\n    // 2. On pr√©pare le paquet de donn√©es (L'enveloppe)\n    // On mappe vos donn√©es Supabase vers les noms attendus par Pipedream\n\n    // Debug: Voir ce qu'on re√ßoit vraiment\n    console.log(\"=\".repeat(80));\n    console.log(\"üì¶ DONN√âES BRUTES RE√áUES AVANT ENVOI:\");\n    const tenant = data.tenant as Record<string, unknown> | undefined;\n    const profile = data.profile as Record<string, unknown> | undefined;\n    console.log(\"üìß Email du tenant:\", tenant?.email);\n    console.log(\"üìû T√©l√©phone du tenant:\", tenant?.phone);\n    console.log(\"üë§ Objet tenant complet:\", JSON.stringify(tenant, null, 2));\n    console.log(\"=\".repeat(80));\n\n    const payload = {\n        // Infos Locataire\n        tenantName: tenant?.tenant_name || tenant?.name || '',\n        tenantEmail: tenant?.email || tenant?.tenant_email || '',\n        tenantPhone: tenant?.phone || tenant?.tenant_phone || '',\n        tenantAddress: tenant?.address || (data.property_address as string) || '',\n\n        // Infos Paiement\n        amount: Number(data.amount) || 0,\n        periodMonth: data.periodMonth || `${data.month || new Date().getMonth() + 1}/2025`,\n        periodStart: data.periodStart || `01/${data.month || new Date().getMonth() + 1}/2025`,\n        periodEnd: data.periodEnd || `30/${data.month || new Date().getMonth() + 1}/2025`,\n        receiptNumber: data.receiptNumber || `QUITT-${Date.now().toString().slice(-6)}`,\n\n        // Infos Propri√©taire (Baraka Immo)\n        ownerName: profile?.company_name || profile?.full_name || 'Propri√©taire',\n        ownerEmail: profile?.email || '',\n        ownerLogo: profile?.logo_url || null,\n        ownerSignature: profile?.signature_url || null,\n        ownerAddress: profile?.company_address || '',\n        ownerNinea: profile?.ninea || '',\n\n        // Infos Propri√©t√©\n        propertyAddress: (data.property_address as string) || tenant?.address || '',\n\n        // Image de la quittance (si g√©n√©r√©e c√¥t√© client)\n        receiptImage: data.receiptImage || null\n    };\n\n    console.log(\"üì§ Envoi √† Pipedream :\", JSON.stringify(payload, null, 2)); // Pour v√©rifier dans vos logs serveur\n\n    try {\n        // 3. On exp√©die le tout √† Pipedream\n        const response = await fetch(WEBHOOK_URL, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify(payload) // Pipedream : envoyer directement le payload, pas envelopp√©\n        });\n\n        if (!response.ok) {\n            const errorText = await response.text();\n            console.error('‚ùå Erreur Pipedream:', response.status, response.statusText);\n            console.error('R√©ponse brute:', errorText.substring(0, 500)); // Log les 500 premiers caract√®res\n            return {\n                success: false,\n                error: `Erreur webhook (${response.status}): ${response.statusText}`\n            };\n        }\n\n        // Essayer de parser la r√©ponse comme JSON\n        const responseText = await response.text();\n        let result;\n\n        try {\n            result = JSON.parse(responseText);\n            console.log(\"‚úÖ R√©ponse Pipedream:\", result);\n            return { success: true, data: result };\n        } catch (_parseError) {\n            // Si ce n'est pas du JSON, c'est probablement du HTML d'erreur\n            console.warn(\"‚ö†Ô∏è R√©ponse non-JSON re√ßue:\", responseText.substring(0, 200));\n\n            // On consid√®re quand m√™me que c'est un succ√®s si status 200\n            if (response.status === 200) {\n                console.log(\"‚úÖ Requ√™te envoy√©e avec succ√®s (pas de JSON retourn√©)\");\n                return {\n                    success: true,\n                    data: {\n                        message: \"Envoy√© √† Pipedream (pas de r√©ponse JSON)\",\n                        rawResponse: responseText.substring(0, 200)\n                    }\n                };\n            }\n\n            return {\n                success: false,\n                error: \"R√©ponse invalide de Pipedream (pas du JSON)\"\n            };\n        }\n    } catch (error) {\n        console.error(\"‚ùå Echec envoi Pipedream:\", error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : \"Impossible de joindre le webhook\"\n        };\n    }\n}\n\n/**\n * Supprime une transaction (pour nettoyer les doublons g√©n√©r√©s par erreur)\n */\nexport async function deleteTransaction(transactionId: string) {\n    const { teamId, user } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    if (!user) {\n        return { success: false, error: \"Non autoris√©\" };\n    }\n\n    // S√©curit√©: V√©rifier que la transaction appartient bien √† un bail de l'√©quipe\n    const { data: transaction } = await supabase\n        .from('rental_transactions')\n        .select('lease_id, leases!inner(team_id)')\n        .eq('id', transactionId)\n        .single();\n\n    const leaseData = transaction?.leases as { team_id: string } | undefined;\n\n    if (!transaction || !leaseData || leaseData.team_id !== teamId) {\n        return { success: false, error: \"Transaction introuvable ou non autoris√©e\" };\n    }\n\n    const { error } = await supabase\n        .from('rental_transactions')\n        .delete()\n        .eq('id', transactionId)\n        .eq('team_id', teamId);\n\n    if (error) {\n        console.error(\"Erreur suppression transaction:\", error.message);\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion');\n    return { success: true };\n}\n\n/**\n * Supprime D√âFINITIVEMENT un bail (Fonction de nettoyage)\n */\nexport async function deleteLease(leaseId: string) {\n    const { teamId, user } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    if (!user) return { success: false, error: \"Non autoris√©\" };\n\n    const { data: lease } = await supabase\n        .from('leases')\n        .select('team_id')\n        .eq('id', leaseId)\n        .eq('team_id', teamId)\n        .single();\n\n    if (!lease) {\n        return { success: false, error: \"Bail introuvable ou non autoris√©\" };\n    }\n\n    const { error } = await supabase\n        .from('leases')\n        .delete()\n        .eq('id', leaseId)\n        .eq('team_id', teamId);\n\n    if (error) {\n        console.error(\"Erreur suppression bail:\", error.message);\n        return { success: false, error: error.message };\n    }\n\n    // Invalider caches\n    await invalidateRentalCaches(teamId, leaseId);\n\n    revalidatePath('/gestion');\n    return { success: true };\n}\n\n/**\n * V√©rifie si l'owner connect√© est aussi locataire dans un autre bien\n *\n * Recherche les baux actifs o√π l'email de l'owner correspond √† tenant_email.\n * Utilis√© pour afficher le switch \"Espace Locataire\" dans le dropdown.\n *\n * Per WORKFLOW_PROPOSAL.md section 2.5 - Switch role Owners\n */\nexport async function checkOwnerHasTenantAccess(): Promise<{\n    hasTenantAccess: boolean;\n    tenantLease?: {\n        id: string;\n        property_title: string;\n        owner_name: string;\n        has_valid_token: boolean;\n    };\n}> {\n    const supabase = await createClient();\n\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user?.email) {\n        return { hasTenantAccess: false };\n    }\n\n    // Chercher un bail actif o√π cet email est le locataire\n    const { data: lease, error } = await supabase\n        .from('leases')\n        .select(`\n            id,\n            tenant_access_token,\n            tenant_token_expires_at,\n            property:properties(title),\n            owner:profiles!leases_owner_id_fkey(full_name, company_name)\n        `)\n        .eq('tenant_email', user.email.toLowerCase())\n        .eq('status', 'active')\n        .limit(1)\n        .maybeSingle();\n\n    if (error || !lease) {\n        return { hasTenantAccess: false };\n    }\n\n    // V√©rifier si le token est valide\n    const hasValidToken = !!(\n        lease.tenant_access_token &&\n        lease.tenant_token_expires_at &&\n        new Date(lease.tenant_token_expires_at) > new Date()\n    );\n\n    const property = lease.property as { title?: string } | null;\n    const owner = lease.owner as { full_name?: string; company_name?: string } | null;\n\n    return {\n        hasTenantAccess: true,\n        tenantLease: {\n            id: lease.id,\n            property_title: property?.title || \"Bien immobilier\",\n            owner_name: owner?.company_name || owner?.full_name || \"Propri√©taire\",\n            has_valid_token: hasValidToken,\n        },\n    };\n}\n\n/**\n * G√©n√®re ou r√©cup√®re le Magic Link pour l'acc√®s locataire de l'owner\n *\n * Si un token valide existe, retourne l'URL.\n * Sinon, g√©n√®re un nouveau token.\n */\nexport async function getOwnerTenantAccessLink(leaseId: string): Promise<{\n    success: boolean;\n    url?: string;\n    error?: string;\n}> {\n    const supabase = await createClient();\n\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user?.email) {\n        return { success: false, error: \"Non authentifi√©\" };\n    }\n\n    // V√©rifier que le bail appartient bien √† cet email\n    const { data: lease } = await supabase\n        .from('leases')\n        .select('id, tenant_access_token, tenant_token_expires_at')\n        .eq('id', leaseId)\n        .eq('tenant_email', user.email.toLowerCase())\n        .eq('status', 'active')\n        .single();\n\n    if (!lease) {\n        return { success: false, error: \"Bail introuvable ou non autoris√©\" };\n    }\n\n    // V√©rifier si le token existant est valide\n    const hasValidToken = !!(\n        lease.tenant_access_token &&\n        lease.tenant_token_expires_at &&\n        new Date(lease.tenant_token_expires_at) > new Date()\n    );\n\n    if (hasValidToken) {\n        // Note: On ne peut pas r√©cup√©rer le token raw car on stocke le hash\n        // Il faut en g√©n√©rer un nouveau\n    }\n\n    // G√©n√©rer un nouveau token\n    const { generateTenantAccessToken, getTenantMagicLinkUrl } = await import('@/lib/tenant-magic-link');\n    const { trackServerEvent, EVENTS } = await import('@/lib/analytics');\n\n    try {\n        const rawToken = await generateTenantAccessToken(leaseId);\n        const url = getTenantMagicLinkUrl(rawToken);\n\n        // Track role switch analytics\n        trackServerEvent(EVENTS.ROLE_SWITCHED, {\n            from: \"gestion\",\n            to: \"locataire\",\n            user_id: user.id,\n            is_owner_dual_role: true,\n        });\n\n        return { success: true, url };\n    } catch (error) {\n        console.error(\"[getOwnerTenantAccessLink] Error:\", error);\n        return { success: false, error: \"Erreur lors de la g√©n√©ration du lien\" };\n    }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\actions\\property-selector.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\biens\\[id]\\edit-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\biens\\[id]\\edit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\biens\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\biens\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":150,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":150,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5246,5249],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5246,5249],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { requireTeamPermission, getUserTeamContext } from \"@/lib/team-permissions.server\";\nimport { invalidatePropertyCaches, invalidateRentalCaches } from \"@/lib/cache/invalidation\";\nimport { checkFeatureAccess } from \"@/lib/subscription/team-subscription\";\n\n// =====================================================\n// TYPES\n// =====================================================\n\nexport type TeamPropertyData = {\n  type: string;\n  title: string;\n  description: string;\n  price: number;\n  category: \"vente\" | \"location\";\n  address: string; // Adresse compl√®te (quartier, ville, r√©gion)\n  surface?: number;\n  surfaceTotale?: number;\n  juridique?: string;\n  rooms?: number;\n  bedrooms?: number;\n  bathrooms?: number;\n  images: string[];\n  virtual_tour_url?: string;\n  owner_id?: string; // Propri√©taire externe (client)\n  owner_name?: string;\n  owner_phone?: string;\n  owner_email?: string;\n  location?: {\n    lat: number;\n    lon: number;\n    city?: string;\n    district?: string;\n    region?: string;\n  };\n};\n\n// =====================================================\n// SCH√âMA DE VALIDATION\n// =====================================================\n\nconst propertySchema = z.object({\n  type: z.enum([\"villa\", \"appartement\", \"terrain\", \"immeuble\", \"studio\", \"bureau\"]),\n  title: z.string().min(3, \"Le titre doit contenir au moins 3 caract√®res\"),\n  description: z.string().min(10, \"La description doit contenir au moins 10 caract√®res\"),\n  price: z.number().positive(\"Le prix doit √™tre positif\"),\n  category: z.enum([\"vente\", \"location\"]),\n  address: z.string().min(3, \"L'adresse est requise\"),\n  surface: z.number().positive().optional(),\n  surfaceTotale: z.number().positive().optional(),\n  juridique: z.string().optional(),\n  rooms: z.number().int().min(0).optional(),\n  bedrooms: z.number().int().min(0).optional(),\n  bathrooms: z.number().int().min(0).optional(),\n  images: z.array(z.string()).min(1, \"Au moins une image est requise\"),\n  virtual_tour_url: z.string().url().optional().or(z.literal(\"\")),\n  owner_id: z.string().uuid().optional(),\n  owner_name: z.string().optional(),\n  owner_phone: z.string().optional(),\n  owner_email: z.string().email().optional().or(z.literal(\"\")),\n  location: z.object({\n    lat: z.number(),\n    lon: z.number(),\n    city: z.string().optional(),\n    district: z.string().optional(),\n    region: z.string().optional()\n  }).optional(),\n});\n\n// =====================================================\n// UTILITAIRES\n// =====================================================\n\nfunction cleanVirtualTourUrl(rawUrl: string | undefined): string | null {\n  if (!rawUrl) return null;\n  const trimmedUrl = rawUrl.trim();\n  if (!trimmedUrl) return null;\n\n  if (trimmedUrl.includes(\"<iframe\")) {\n    const match = trimmedUrl.match(/src=\"([^\"]+)\"/);\n    if (match && match[1]) return match[1];\n  }\n\n  const youtubeWatchMatch = trimmedUrl.match(\n    /(?:youtube\\.com\\/watch\\?v=|youtube\\.com\\/watch\\?.*&v=)([a-zA-Z0-9_-]{11})/\n  );\n  if (youtubeWatchMatch && youtubeWatchMatch[1]) {\n    return `https://www.youtube.com/embed/${youtubeWatchMatch[1]}`;\n  }\n\n  const youtubeShortMatch = trimmedUrl.match(/youtu\\.be\\/([a-zA-Z0-9_-]{11})/);\n  if (youtubeShortMatch && youtubeShortMatch[1]) {\n    return `https://www.youtube.com/embed/${youtubeShortMatch[1]}`;\n  }\n\n  return trimmedUrl;\n}\n\n// =====================================================\n// ACTIONS\n// =====================================================\n\n/**\n * R√©cup√©rer les biens d'une √©quipe\n */\nexport async function getTeamProperties(teamId: string) {\n  const permCheck = await requireTeamPermission(teamId, \"properties.view\");\n  if (!permCheck.success) {\n    return { error: permCheck.error, properties: [] };\n  }\n\n  const supabase = await createClient();\n\n  // 1. R√©cup√©rer les propri√©t√©s\n  const { data: propertiesData, error: propertiesError } = await supabase\n    .from(\"properties\")\n    .select(`\n      *,\n      owner:profiles!owner_id(id, full_name, phone, avatar_url)\n    `)\n    .eq(\"team_id\", teamId)\n    .order(\"created_at\", { ascending: false });\n\n  if (propertiesError) {\n    console.error(\"‚ùå Erreur getTeamProperties (properties):\", propertiesError);\n    return { error: \"Erreur lors de la r√©cup√©ration des biens\", properties: [] };\n  }\n\n  const properties = propertiesData || [];\n  const propertyIds = properties.map((p) => p.id);\n\n  try {\n    // 2. R√©cup√©rer les baux actifs avec les infos du locataire\n    // Note: La table leases stocke directement tenant_name, tenant_email, tenant_phone (pas de tenant_id)\n    const { data: leasesData } = await supabase\n      .from(\"leases\")\n      .select(\"id, property_id, tenant_name, tenant_email, tenant_phone\")\n      .eq(\"status\", \"active\")\n      .in(\"property_id\", propertyIds.length > 0 ? propertyIds : ['00000000-0000-0000-0000-000000000000']);\n\n    if (leasesData && leasesData.length > 0) {\n      // Cr√©er une map pour acc√®s rapide: property_id -> lease info\n      const leaseMap = new Map(leasesData.map((l) => [l.property_id, l]));\n\n      // 3. Fusionner les propri√©t√©s avec les infos du locataire\n      const propertiesWithTenant = properties.map((property: any) => {\n        const lease = leaseMap.get(property.id);\n\n        return {\n          ...property,\n          // Le statut est d√©j√† \"lou√©\" si le bien a un bail\n          status: lease ? \"lou√©\" : property.status,\n          tenant: lease ? {\n            id: lease.id, // ID du bail\n            full_name: lease.tenant_name,\n            avatar_url: undefined, // Pas stock√© dans leases\n            payment_status: \"up_to_date\" as const // TODO: Calculer depuis rental_transactions\n          } : undefined\n        };\n      });\n\n      return { properties: propertiesWithTenant };\n    }\n  } catch (err) {\n    console.warn(\"‚ö†Ô∏è Impossible de r√©cup√©rer les locataires:\", err);\n  }\n\n  return { properties: properties };\n}\n\n/**\n * Cr√©er un bien pour l'√©quipe\n * @param publishMode - \"publish\" | \"draft\" | \"schedule\"\n * @param scheduledAt - Date ISO pour publication programm√©e\n */\nexport async function createTeamProperty(\n  teamId: string,\n  data: TeamPropertyData,\n  publishMode: \"publish\" | \"draft\" | \"schedule\" = \"publish\",\n  scheduledAt?: string\n) {\n  const permCheck = await requireTeamPermission(teamId, \"properties.create\");\n  if (!permCheck.success) {\n    return { success: false, error: permCheck.error };\n  }\n\n  // ‚úÖ CHECK FEATURE QUOTA\n  const access = await checkFeatureAccess(teamId, \"add_property\");\n  if (!access.allowed) {\n    return {\n      success: false,\n      error: access.message,\n      upgradeRequired: access.upgradeRequired,\n      reason: access.reason\n    };\n  }\n\n  // Validation plus souple pour les brouillons\n  if (publishMode !== \"draft\") {\n    const validation = propertySchema.safeParse(data);\n    if (!validation.success) {\n      const firstError = validation.error.issues[0];\n      return { success: false, error: firstError?.message || \"Donn√©es invalides\" };\n    }\n  }\n\n  const supabase = await createClient();\n\n  // D√©terminer si c'est un terrain\n  const isTerrain = data.type === \"terrain\";\n\n  // Pr√©parer les specs\n  const specs = isTerrain\n    ? {\n      surface: data.surfaceTotale ?? 0,\n      rooms: 0,\n      bedrooms: 0,\n      bathrooms: 0,\n      dpe: \"B\" as const,\n    }\n    : {\n      surface: data.surface ?? 0,\n      rooms: data.rooms ?? 0,\n      bedrooms: data.bedrooms ?? 0,\n      bathrooms: data.bathrooms ?? 0,\n      dpe: \"B\" as const,\n    };\n\n  const typeMap: Record<string, string> = {\n    villa: \"Villa\",\n    appartement: \"Appartement\",\n    immeuble: \"Immeuble\",\n    terrain: \"Terrain\",\n    studio: \"Studio\",\n    bureau: \"Bureau\",\n  };\n\n  // D√©terminer le statut de validation selon le mode\n  let validationStatus: \"approved\" | \"pending\" | \"scheduled\";\n  if (publishMode === \"publish\") {\n    validationStatus = \"approved\"; // Publi√© imm√©diatement\n  } else if (publishMode === \"schedule\") {\n    validationStatus = \"scheduled\"; // Programm√©\n  } else {\n    validationStatus = \"pending\"; // Brouillon\n  }\n\n  // Extraire les infos de l'adresse au format \"R√©gion, Ville/Quartier, S√©n√©gal\" \n  // ou format libre via Autocomplete\n  const addressParts = data.address.split(\",\").map((s) => s.trim());\n\n  // Logique d'extraction intelligente\n  let extractedCity = \"\";\n  let extractedDistrict = \"\";\n\n  // Priorit√© aux donn√©es structur√©es si disponibles\n  if (data.location?.city) {\n    extractedCity = data.location.city;\n    extractedDistrict = data.location.district || \"\";\n  } else if (addressParts.length >= 2) {\n    // Si l'adresse finit par \"S√©n√©gal\", on l'ignore pour trouver la ville\n    const lastPart = addressParts[addressParts.length - 1];\n    const isSenegal = lastPart?.toLowerCase() === \"s√©n√©gal\" || lastPart?.toLowerCase() === \"senegal\";\n\n    if (isSenegal && addressParts.length >= 2) {\n      // Format: \"R√©gion, Ville, S√©n√©gal\" -> Ville\n      extractedCity = addressParts[addressParts.length - 2] || \"\";\n      extractedDistrict = addressParts[0] || \"\";\n    } else {\n      // Format: \"R√©gion, Ville\" (sans S√©n√©gal)\n      extractedCity = addressParts[addressParts.length - 1] || \"\";\n      extractedDistrict = addressParts[0] || \"\";\n    }\n  } else {\n    extractedCity = addressParts[0] || \"\";\n  }\n\n  const payload: Record<string, unknown> = {\n    title: data.title,\n    description: data.description || \"\",\n    price: data.price,\n    category: data.category,\n    status: \"disponible\",\n    team_id: teamId,\n    created_by: permCheck.userId,\n    owner_id: data.owner_id || permCheck.userId, // Default to creator for Vitrine sync\n    is_agency_listing: true,\n    validation_status: validationStatus,\n    service_type: \"mandat_confort\",\n    location: {\n      city: extractedCity,\n      district: extractedDistrict,\n      address: data.address,\n      landmark: \"\",\n      coords: data.location ? { lat: data.location.lat, lng: data.location.lon } : { lat: 0, lng: 0 },\n    },\n    specs,\n    features: {},\n    details: isTerrain\n      ? {\n        type: \"Terrain\",\n        year: new Date().getFullYear(),\n        heating: \"\",\n        juridique: data.juridique,\n      }\n      : {\n        type: typeMap[data.type] ?? \"Appartement\",\n        year: new Date().getFullYear(),\n        heating: \"Climatisation\",\n      },\n    images: data.images || [],\n    views_count: 0,\n    virtual_tour_url: cleanVirtualTourUrl(data.virtual_tour_url),\n    verification_status: \"verified\",\n  };\n\n  // Ajouter la date de publication programm√©e si applicable\n  if (publishMode === \"schedule\" && scheduledAt) {\n    payload.scheduled_publish_at = scheduledAt;\n  }\n\n  const { data: insertedProperty, error } = await supabase\n    .from(\"properties\")\n    .insert([payload])\n    .select()\n    .single();\n\n  if (error) {\n    console.error(\"‚ùå Erreur createTeamProperty:\", error);\n    // Erreurs courantes avec messages explicites\n    if (error.code === \"42703\") {\n      return { success: false, error: \"Migration requise: ex√©cutez la migration SQL team_id dans Supabase\" };\n    }\n    if (error.code === \"42501\" || error.message?.includes(\"permission\")) {\n      return { success: false, error: \"Permission refus√©e. V√©rifiez que vous √™tes membre de l'√©quipe.\" };\n    }\n    if (error.code === \"23503\") {\n      return { success: false, error: \"R√©f√©rence invalide (√©quipe ou utilisateur introuvable)\" };\n    }\n    return { success: false, error: error.message || \"Erreur lors de la cr√©ation du bien\" };\n  }\n\n  // Invalider les caches uniquement si publi√©\n  if (publishMode === \"publish\") {\n    await invalidatePropertyCaches(insertedProperty.id, extractedCity, {\n      invalidateHomepage: true,\n      invalidateSearch: true,\n      invalidateDetail: true,\n      invalidateOwner: false,\n    });\n    revalidatePath(\"/recherche\");\n  }\n\n  revalidatePath(\"/gestion/biens\");\n\n  return { success: true, propertyId: insertedProperty.id, mode: publishMode };\n}\n\n/**\n * Mettre √† jour un bien\n */\nexport async function updateTeamProperty(\n  teamId: string,\n  propertyId: string,\n  data: Partial<TeamPropertyData>\n) {\n  const permCheck = await requireTeamPermission(teamId, \"properties.edit\");\n  if (!permCheck.success) {\n    return { success: false, error: permCheck.error };\n  }\n\n  const supabase = await createClient();\n\n  // V√©rifier que le bien appartient √† l'√©quipe\n  const { data: existingProperty } = await supabase\n    .from(\"properties\")\n    .select(\"id, team_id, location\")\n    .eq(\"id\", propertyId)\n    .single();\n\n  if (!existingProperty || existingProperty.team_id !== teamId) {\n    return { success: false, error: \"Bien non trouv√© ou non autoris√©\" };\n  }\n\n  // Construire les champs √† mettre √† jour\n  const updatePayload: Record<string, unknown> = {};\n\n  if (data.title) updatePayload.title = data.title;\n  if (data.description) updatePayload.description = data.description;\n  if (data.price) updatePayload.price = data.price;\n  if (data.category) updatePayload.category = data.category;\n  if (data.images) updatePayload.images = data.images;\n  if (data.virtual_tour_url !== undefined) {\n    updatePayload.virtual_tour_url = cleanVirtualTourUrl(data.virtual_tour_url);\n  }\n  if (data.address) {\n    // Format: \"Quartier, Ville, R√©gion\"\n    const addressParts = data.address.split(\",\").map((s) => s.trim());\n    const extractedDistrict = addressParts[0] || \"\";\n    const extractedCity = addressParts[1] || addressParts[0] || \"\";\n    updatePayload.location = {\n      city: data.location?.city || extractedCity,\n      district: data.location?.district || extractedDistrict,\n      address: data.address,\n      landmark: \"\",\n      coords: data.location ? { lat: data.location.lat, lng: data.location.lon } : { lat: 0, lng: 0 },\n    };\n  }\n  if (data.owner_id) updatePayload.owner_id = data.owner_id;\n\n  // Specs\n  if (data.surface || data.rooms || data.bedrooms || data.bathrooms) {\n    updatePayload.specs = {\n      surface: data.surface ?? 0,\n      rooms: data.rooms ?? 0,\n      bedrooms: data.bedrooms ?? 0,\n      bathrooms: data.bathrooms ?? 0,\n      dpe: \"B\",\n    };\n  }\n\n  // Si on modifie depuis le SaaS, le bien est consid√©r√© comme certifi√©\n  updatePayload.verification_status = \"verified\";\n\n  const { error } = await supabase\n    .from(\"properties\")\n    .update(updatePayload)\n    .eq(\"id\", propertyId);\n\n  if (error) {\n    console.error(\"‚ùå Erreur updateTeamProperty:\", error);\n    return { success: false, error: \"Erreur lors de la mise √† jour\" };\n  }\n\n  // Invalider les caches\n  const city = existingProperty.location?.city;\n  await invalidatePropertyCaches(propertyId, city, {\n    invalidateHomepage: true,\n    invalidateSearch: true,\n    invalidateDetail: true,\n    invalidateOwner: false,\n  });\n\n  revalidatePath(\"/gestion/biens\");\n  revalidatePath(`/gestion/biens/${propertyId}`);\n  revalidatePath(`/biens/${propertyId}`);\n\n  return { success: true };\n}\n\n/**\n * Publier / D√©publier un bien\n */\nexport async function togglePropertyPublication(teamId: string, propertyId: string) {\n  const permCheck = await requireTeamPermission(teamId, \"properties.publish\");\n  if (!permCheck.success) {\n    return { success: false, error: permCheck.error };\n  }\n\n  const supabase = await createClient();\n\n  // R√©cup√©rer l'√©tat actuel\n  const { data: property } = await supabase\n    .from(\"properties\")\n    .select(\"id, team_id, validation_status, verification_status, status, location\")\n    .eq(\"id\", propertyId)\n    .single();\n\n  if (!property || property.team_id !== teamId) {\n    return { success: false, error: \"Bien non trouv√© ou non autoris√©\" };\n  }\n\n  if (property.status === \"lou√©\") {\n    return { success: false, error: \"Impossible de publier un bien actuellement lou√©.\" };\n  }\n\n  // Toggle le statut\n  const newStatus = property.validation_status === \"approved\" ? \"pending\" : \"approved\";\n\n  const { error } = await supabase\n    .from(\"properties\")\n    .update({\n      validation_status: newStatus,\n      // Si on publie depuis le SaaS, on certifie automatiquement\n      verification_status: newStatus === \"approved\" ? \"verified\" : property.verification_status\n    })\n    .eq(\"id\", propertyId);\n\n  if (error) {\n    console.error(\"‚ùå Erreur togglePropertyPublication:\", error);\n    return { success: false, error: \"Erreur lors du changement de statut\" };\n  }\n\n  // Invalider les caches\n  await invalidatePropertyCaches(propertyId, property.location?.city, {\n    invalidateHomepage: true,\n    invalidateSearch: true,\n    invalidateDetail: true,\n    invalidateOwner: false,\n  });\n\n  revalidatePath(\"/gestion/biens\");\n  revalidatePath(\"/recherche\");\n\n  return {\n    success: true,\n    isPublished: newStatus === \"approved\",\n    message: newStatus === \"approved\" ? \"Bien publi√© sur la vitrine\" : \"Bien retir√© de la vitrine\",\n  };\n}\n\n/**\n * Supprimer un bien\n */\nexport async function deleteTeamProperty(teamId: string, propertyId: string) {\n  const permCheck = await requireTeamPermission(teamId, \"properties.delete\");\n  if (!permCheck.success) {\n    return { success: false, error: permCheck.error };\n  }\n\n  const supabase = await createClient();\n\n  // V√©rifier que le bien appartient √† l'√©quipe\n  const { data: property } = await supabase\n    .from(\"properties\")\n    .select(\"id, team_id, location, images\")\n    .eq(\"id\", propertyId)\n    .single();\n\n  if (!property || property.team_id !== teamId) {\n    return { success: false, error: \"Bien non trouv√© ou non autoris√©\" };\n  }\n\n  // Supprimer le bien\n  const { error } = await supabase.from(\"properties\").delete().eq(\"id\", propertyId);\n\n  if (error) {\n    console.error(\"‚ùå Erreur deleteTeamProperty:\", error);\n    return { success: false, error: \"Erreur lors de la suppression\" };\n  }\n\n  // Invalider les caches\n  await invalidatePropertyCaches(propertyId, property.location?.city, {\n    invalidateHomepage: true,\n    invalidateSearch: true,\n    invalidateDetail: true,\n    invalidateOwner: false,\n  });\n\n  revalidatePath(\"/gestion/biens\");\n\n  return { success: true, message: \"Bien supprim√© avec succ√®s\" };\n}\n\n/**\n * R√©cup√©rer un bien par ID (pour √©dition)\n */\nexport async function getTeamPropertyById(teamId: string, propertyId: string) {\n  const permCheck = await requireTeamPermission(teamId, \"properties.view\");\n  if (!permCheck.success) {\n    return { error: permCheck.error, property: null };\n  }\n\n  const supabase = await createClient();\n\n  const { data, error } = await supabase\n    .from(\"properties\")\n    .select(`\n      *,\n      owner:profiles!owner_id(id, full_name, phone, avatar_url, email)\n    `)\n    .eq(\"id\", propertyId)\n    .eq(\"team_id\", teamId)\n    .single();\n\n  if (error || !data) {\n    return { error: \"Bien non trouv√©\", property: null };\n  }\n\n  return { property: data };\n}\n\n/**\n * Rechercher des propri√©taires (pour le s√©lecteur)\n */\nexport async function searchOwners(query: string) {\n  const teamContext = await getUserTeamContext();\n  if (!teamContext) {\n    return { owners: [] };\n  }\n\n  const supabase = await createClient();\n\n  // Filtrer les propri√©taires qui ont au moins une propri√©t√© ou un bail dans cette √©quipe\n  // OU qui sont membres de l'√©quipe (si n√©cessaire)\n\n  // Pour l'instant, on limite aux profils ayant une propri√©t√© dans l'√©quipe\n  const { data: teamProperties } = await supabase\n    .from(\"properties\")\n    .select(\"owner_id\")\n    .eq(\"team_id\", teamContext.team_id);\n\n  const ownerIds = Array.from(new Set(teamProperties?.map(p => p.owner_id).filter(Boolean)));\n\n  if (ownerIds.length === 0) {\n    return { owners: [] };\n  }\n\n  let queryBuilder = supabase\n    .from(\"profiles\")\n    .select(\"id, full_name, phone, email, avatar_url\")\n    .in(\"id\", ownerIds);\n\n  if (query && query.trim().length > 0) {\n    queryBuilder = queryBuilder.or(`full_name.ilike.%${query}%,phone.ilike.%${query}%,email.ilike.%${query}%`);\n  }\n\n  const { data } = await queryBuilder.limit(10);\n\n  return { owners: data || [] };\n}\n\n/**\n * Cr√©er un nouveau propri√©taire (client)\n *\n * S√âCURIT√â: Requiert la permission properties.create\n * Justification: Cr√©er un propri√©taire est li√© √† la cr√©ation de biens,\n * donc nous utilisons la m√™me permission pour coh√©rence.\n */\nexport async function createOwner(data: {\n  full_name: string;\n  phone: string;\n  email?: string;\n}) {\n  // ‚úÖ CORRECTION S√âCURIT√â: V√©rification explicite de permission\n  const teamContext = await getUserTeamContext();\n  if (!teamContext) {\n    return { success: false, error: \"Non autoris√©\" };\n  }\n\n  const permCheck = await requireTeamPermission(teamContext.team_id, \"properties.create\");\n  if (!permCheck.success) {\n    return { success: false, error: permCheck.error };\n  }\n\n  const supabase = await createClient();\n\n  // Pour cr√©er un profil sans compte auth, on utilise un UUID g√©n√©r√©\n  const { data: newOwner, error } = await supabase\n    .from(\"profiles\")\n    .insert({\n      id: crypto.randomUUID(),\n      full_name: data.full_name,\n      phone: data.phone,\n      email: data.email || null,\n      role: \"particulier\",\n    })\n    .select()\n    .single();\n\n  if (error) {\n    console.error(\"‚ùå Erreur createOwner:\", error);\n    return { success: false, error: \"Erreur lors de la cr√©ation du propri√©taire\" };\n  }\n\n  return { success: true, owner: newOwner };\n}\n\n\n\n/**\n * Rechercher des locataires (pour le s√©lecteur d'association)\n * Filtre strictement par les locataires ayant d√©j√† un bail ou un lien avec l'√©quipe\n * pour garantir la confidentialit√© des donn√©es entre propri√©taires.\n */\nexport async function searchTenants(query: string) {\n  const teamContext = await getUserTeamContext();\n  if (!teamContext) {\n    return { owners: [] };\n  }\n\n  const supabase = await createClient();\n\n  // 1. R√©cup√©rer les identifiants uniques des locataires existants pour cette √©quipe via les baux\n  // On utilise email et t√©l√©phone comme cl√©s de r√©conciliation car tenant_id n'est pas stock√© dans leases\n  const { data: linkedLeases } = await supabase\n    .from(\"leases\")\n    .select(\"tenant_email, tenant_phone\")\n    .eq(\"team_id\", teamContext.team_id);\n\n  const emails = Array.from(new Set(linkedLeases?.map(l => l.tenant_email).filter(Boolean)));\n  const phones = Array.from(new Set(linkedLeases?.map(l => l.tenant_phone).filter(Boolean)));\n\n  // 2. Si aucun locataire existant, on ne retourne rien (s√©curit√© maximale)\n  // L'utilisateur devra utiliser \"Cr√©er un nouveau locataire\" pour ajouter son premier client\n  if (emails.length === 0 && phones.length === 0) {\n    return { owners: [] };\n  }\n\n  // 3. Rechercher dans les profils qui correspondent √† ces identifiants\n  let queryBuilder = supabase\n    .from(\"profiles\")\n    .select(\"id, full_name, phone, email, avatar_url\");\n\n  // Filtre d'identit√© (OR entre email/phone de l'√©quipe)\n  const identityFilters = [];\n  if (emails.length > 0) {\n    identityFilters.push(`email.in.(${emails.map(e => `\"${e}\"`).join(\",\")})`);\n  }\n  if (phones.length > 0) {\n    identityFilters.push(`phone.in.(${phones.map(p => `\"${p}\"`).join(\",\")})`);\n  }\n\n  if (identityFilters.length > 0) {\n    queryBuilder = queryBuilder.or(identityFilters.join(\",\"));\n  }\n\n  // Filtre de recherche textuelle (AND sur le r√©sultat pr√©c√©dent)\n  if (query && query.trim().length > 0) {\n    // PostREST combine plusieurs param√®tres 'or' avec un AND\n    queryBuilder = queryBuilder.or(`full_name.ilike.%${query}%,phone.ilike.%${query}%,email.ilike.%${query}%`);\n  }\n\n  const { data } = await queryBuilder.limit(10);\n\n  return { owners: data || [] };\n}\n\n/**\n * Associer un locataire √† un bien (Cr√©ation de bail simplifi√©)\n */\nexport async function associateTenant(\n  teamId: string,\n  propertyId: string,\n  tenantId: string,\n  startDate: string\n) {\n  const permCheck = await requireTeamPermission(teamId, \"properties.edit\");\n  if (!permCheck.success) {\n    return { success: false, error: permCheck.error };\n  }\n\n  // ‚úÖ CHECK FEATURE QUOTA\n  const access = await checkFeatureAccess(teamId, \"add_lease\");\n  if (!access.allowed) {\n    return {\n      success: false,\n      error: access.message,\n      upgradeRequired: access.upgradeRequired,\n      reason: access.reason\n    };\n  }\n\n  const supabase = await createClient();\n\n  // R√©cup√©rer l'utilisateur connect√© pour le owner_id\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) {\n    return { success: false, error: \"Utilisateur non connect√©\" };\n  }\n\n  // 1. V√©rifier si le bien est d√©j√† lou√©\n  const { data: existingLease } = await supabase\n    .from(\"leases\")\n    .select(\"id\")\n    .eq(\"property_id\", propertyId)\n    .eq(\"status\", \"active\")\n    .single();\n\n  if (existingLease) {\n    return { success: false, error: \"Ce bien a d√©j√† un bail actif.\" };\n  }\n\n  // 2. R√©cup√©rer les informations du locataire\n  const { data: tenant } = await supabase\n    .from(\"profiles\")\n    .select(\"id, full_name, email, phone\")\n    .eq(\"id\", tenantId)\n    .single();\n\n  if (!tenant || !tenant.full_name) {\n    return { success: false, error: \"Locataire non trouv√©\" };\n  }\n\n  // 3. R√©cup√©rer les infos du bien (adresse et prix)\n  const { data: property } = await supabase\n    .from(\"properties\")\n    .select(\"price, location, owner_id\")\n    .eq(\"id\", propertyId)\n    .single();\n\n  if (!property) {\n    return { success: false, error: \"Bien non trouv√©\" };\n  }\n\n  const propertyAddress = property.location?.address\n    || `${property.location?.district || ''}, ${property.location?.city || ''}`;\n\n  // 4. Cr√©er le bail avec le client admin (bypass RLS)\n  const { createAdminClient } = await import(\"@/utils/supabase/admin\");\n  const adminClient = createAdminClient();\n\n  const { error } = await adminClient\n    .from(\"leases\")\n    .insert({\n      property_id: propertyId,\n      owner_id: property.owner_id, // Propri√©taire du bien (peut √™tre externe)\n      team_id: teamId,\n      tenant_name: tenant.full_name,\n      tenant_email: tenant.email,\n      tenant_phone: tenant.phone,\n      property_address: propertyAddress,\n      monthly_amount: property.price || 0,\n      start_date: startDate,\n      status: \"active\",\n    });\n\n  if (error) {\n    console.error(\"‚ùå Erreur associateTenant:\", error);\n    return { success: false, error: `Erreur: ${error.message}` };\n  }\n\n  // 5. Mettre √† jour le statut du bien ET le retirer de la vitrine publique\n  await adminClient\n    .from(\"properties\")\n    .update({\n      status: \"lou√©\",\n      validation_status: \"pending\" // Retire de la vitrine publique\n    })\n    .eq(\"id\", propertyId);\n\n  revalidatePath(\"/gestion/biens\");\n  revalidatePath(\"/gestion\"); // Refresh dashboard KPIs\n\n  // Invalider le cache Redis des baux\n  await invalidateRentalCaches(user.id);\n\n  return { success: true };\n}\n\n// =====================================================\n// G√âN√âRATION DE DESCRIPTION IA (SEO OPTIMIS√â)\n// =====================================================\n\ntype AIDescriptionParams = {\n  type: string;\n  category: \"vente\" | \"location\";\n  city: string;\n  district?: string;\n  price: number;\n  surface?: number;\n  rooms?: number;\n  bedrooms?: number;\n  bathrooms?: number;\n  title?: string;\n};\n\nexport async function generateSEODescription(params: AIDescriptionParams): Promise<{\n  success: boolean;\n  description?: string;\n  title?: string;\n  error?: string;\n}> {\n  // ‚úÖ CORRECTION S√âCURIT√â: V√©rifier les permissions avant tout appel IA\n  const teamContext = await getUserTeamContext();\n  if (!teamContext) {\n    return { success: false, error: \"Non autoris√©\" };\n  }\n\n  const permCheck = await requireTeamPermission(teamContext.team_id, \"properties.create\");\n  if (!permCheck.success) {\n    return { success: false, error: permCheck.error };\n  }\n\n  // ‚úÖ CORRECTION S√âCURIT√â: Rate limiting Redis (20 appels/heure par √©quipe)\n  const { checkAIRateLimit } = await import('@/lib/rate-limit');\n  const rateLimit = await checkAIRateLimit(teamContext.team_id);\n\n  if (!rateLimit.allowed) {\n    // Calculer le temps restant en minutes\n    const resetIn = Math.ceil((rateLimit.resetAt.getTime() - Date.now()) / 60000);\n    const minutes = resetIn > 1 ? `${resetIn} minutes` : `${resetIn} minute`;\n\n    console.warn(`üö´ AI Rate limit blocked for team ${teamContext.team_id}`);\n\n    return {\n      success: false,\n      error: `Limite d'appels IA atteinte (20/heure). R√©essayez dans ${minutes}.`,\n    };\n  }\n\n  // Log l'appel autoris√© avec compteur\n  console.log(`ü§ñ AI Request ${20 - rateLimit.remaining}/20 - Team: ${teamContext.team_id}, User: ${permCheck.userId}`);\n\n  try {\n    const openaiApiKey = process.env.OPENAI_API_KEY;\n\n    if (!openaiApiKey) {\n      console.error(\"‚ùå OPENAI_API_KEY non configur√©e\");\n      return {\n        success: false,\n        error: \"La g√©n√©ration IA n'est pas configur√©e. Veuillez contacter l'administrateur.\",\n      };\n    }\n\n    // Labels\n    const categoryLabel = params.category === \"vente\" ? \"√† vendre\" : \"√† louer\";\n    const typeLabel = params.type.charAt(0).toUpperCase() + params.type.slice(1);\n    const locationLabel = params.district\n      ? `${params.district}, ${params.city}`\n      : params.city;\n\n    const specs = [];\n    if (params.surface) specs.push(`${params.surface} m¬≤`);\n    if (params.rooms) specs.push(`${params.rooms} pi√®ces`);\n    if (params.bedrooms) specs.push(`${params.bedrooms} chambre(s)`);\n    if (params.bathrooms) specs.push(`${params.bathrooms} salle(s) de bain`);\n\n    const specsText = specs.length > 0 ? specs.join(\", \") : \"Caract√©ristiques non sp√©cifi√©es\";\n    const priceFormatted = params.price.toLocaleString(\"fr-SN\");\n\n    const prompt = `Tu es un expert en r√©daction immobili√®re et SEO au S√©n√©gal. G√©n√®re une description professionnelle et optimis√©e pour le r√©f√©rencement.\n\nBIEN IMMOBILIER:\n- Type: ${typeLabel} ${categoryLabel}\n- Localisation: ${locationLabel}, S√©n√©gal\n- Caract√©ristiques: ${specsText}\n- Prix: ${priceFormatted} FCFA${params.category === \"location\" ? \" / mois\" : \"\"}\n\nOBJECTIFS SEO:\n1. Inclure naturellement des mots-cl√©s pertinents: \"${typeLabel} ${categoryLabel} ${params.city}\", \"immobilier ${params.city}\", \"location/vente ${params.district || params.city}\"\n2. Structure optimis√©e avec paragraphes courts (2-3 phrases max)\n3. Appel √† l'action engageant √† la fin\n\nFORMAT REQUIS (JSON):\n{\n  \"title\": \"Titre SEO accrocheur (max 70 caract√®res, inclut type + localisation)\",\n  \"description\": \"Description de 150-200 mots, 3 paragraphes:\\\\n\\\\n1. Introduction avec localisation et type de bien\\\\n\\\\n2. Caract√©ristiques et atouts principaux\\\\n\\\\n3. Conclusion avec appel √† l'action\"\n}\n\nR√àGLES:\n- Ton professionnel mais chaleureux, adapt√© au march√© s√©n√©galais\n- Mentionne les avantages du quartier si pertinent (${params.district || \"centre-ville\"})\n- N'invente pas de caract√©ristiques non mentionn√©es\n- √âvite le bourrage de mots-cl√©s, reste naturel\n- √âcris en fran√ßais\n\nR√©ponds UNIQUEMENT avec le JSON, sans texte avant ou apr√®s.`;\n\n    const response = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${openaiApiKey}`,\n      },\n      body: JSON.stringify({\n        model: \"gpt-4o-mini\",\n        messages: [\n          {\n            role: \"system\",\n            content:\n              \"Tu es un r√©dacteur immobilier professionnel sp√©cialis√© au S√©n√©gal, expert en SEO.\",\n          },\n          { role: \"user\", content: prompt },\n        ],\n        max_tokens: 600,\n        temperature: 0.7,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      console.error(\"‚ùå Erreur OpenAI:\", response.status, errorData);\n      return {\n        success: false,\n        error: \"Erreur lors de la g√©n√©ration. Veuillez r√©essayer.\",\n      };\n    }\n\n    const data = await response.json();\n    const content = data.choices?.[0]?.message?.content?.trim();\n\n    if (!content) {\n      return {\n        success: false,\n        error: \"La description g√©n√©r√©e est vide. Veuillez r√©essayer.\",\n      };\n    }\n\n    // Parser le JSON\n    try {\n      const parsed = JSON.parse(content);\n      console.log(\"‚úÖ Description SEO g√©n√©r√©e avec succ√®s\");\n      return {\n        success: true,\n        title: parsed.title,\n        description: parsed.description,\n      };\n    } catch {\n      // Si le parsing √©choue, retourner le contenu brut comme description\n      console.log(\"‚ö†Ô∏è Parsing JSON √©chou√©, utilisation du contenu brut\");\n      return {\n        success: true,\n        description: content,\n      };\n    }\n  } catch (error) {\n    console.error(\"‚ùå Erreur inattendue dans generateSEODescription:\", error);\n    return {\n      success: false,\n      error: \"Une erreur est survenue lors de la g√©n√©ration.\",\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\biens\\biens-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\biens\\nouveau\\nouveau-client.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'processImageFiles'. Either include it or remove the dependency array.","line":149,"column":6,"nodeType":"ArrayExpression","endLine":149,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [processImageFiles]","fix":{"range":[4163,4195],"text":"[processImageFiles]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { AddressAutocomplete } from \"@/components/forms/address-autocomplete\";\nimport { useState, useCallback } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport Image from \"next/image\";\nimport {\n  ArrowLeft,\n  ArrowRight,\n  Building2,\n  Home,\n  MapPin,\n  Ruler,\n  ImageIcon,\n  _FileText,\n  Loader2,\n  _Plus,\n  X,\n  Sparkles,\n  _Calendar,\n  Save,\n  Send,\n  Check,\n  Upload,\n  _User,\n  Building,\n  _Warehouse,\n  TreePine,\n  Briefcase,\n  Hotel,\n\n  ChevronDown,\n  Clock,\n} from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { _format } from \"date-fns\";\nimport { _fr } from \"date-fns/locale\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport { OwnerSelector } from \"@/components/gestion/OwnerSelector\";\nimport { createTeamProperty, generateSEODescription, type TeamPropertyData } from \"../actions\";\nimport { UpgradeModal } from \"@/components/gestion/UpgradeModal\";\nimport { scrollToTop } from \"@/lib/scroll-utils\";\n\ntype PublishMode = \"publish\" | \"draft\" | \"schedule\";\n\ntype NouveauBienClientProps = {\n  teamId: string;\n  teamName: string;\n};\n\nconst PROPERTY_TYPES = [\n  { value: \"villa\", label: \"Villa\", icon: Home },\n  { value: \"appartement\", label: \"Appartement\", icon: Building },\n  { value: \"studio\", label: \"Studio\", icon: Hotel },\n  { value: \"terrain\", label: \"Terrain\", icon: TreePine },\n  { value: \"immeuble\", label: \"Immeuble\", icon: Building2 },\n  { value: \"bureau\", label: \"Bureau\", icon: Briefcase },\n];\n\nconst STEPS = [\n  { id: 1, title: \"L'essentiel\", icon: Building2 },\n  { id: 2, title: \"Localisation\", icon: MapPin },\n  { id: 3, title: \"D√©tails\", icon: Ruler },\n  { id: 4, title: \"M√©dia\", icon: ImageIcon },\n  { id: 5, title: \"Publication\", icon: Send },\n];\n\nexport function NouveauBienClient({ teamId, teamName }: NouveauBienClientProps) {\n  const router = useRouter();\n  const [currentStep, setCurrentStep] = useState(1);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  // Form state\n  const [formData, setFormData] = useState({\n    type: \"appartement\",\n    category: \"location\" as \"vente\" | \"location\",\n    title: \"\",\n    price: \"\",\n    address: \"\",\n    surface: \"\",\n    rooms: \"\",\n    bedrooms: \"\",\n    bathrooms: \"\",\n    description: \"\",\n    virtual_tour_url: \"\",\n    images: [] as string[],\n    owner_id: undefined as string | undefined,\n    lat: null as number | null,\n    lon: null as number | null,\n    city: \"\",\n    district: \"\",\n    region: \"\",\n  });\n\n  // Image upload state\n  const [uploadingImages, setUploadingImages] = useState(false);\n  const [dragActive, setDragActive] = useState(false);\n\n  // AI generation state\n  const [isGeneratingAI, setIsGeneratingAI] = useState(false);\n\n  // Publication options\n  const [publishMode, _setPublishMode] = useState<PublishMode>(\"publish\");\n  const [scheduledDate, setScheduledDate] = useState(\"\");\n  const [isScheduleDialogOpen, setIsScheduleDialogOpen] = useState(false);\n  const [showUpgradeModal, setShowUpgradeModal] = useState(false);\n  const [_statsSummary, _setStatsSummary] = useState({ properties: 0, leases: 0 });\n\n  const updateField = (field: string, value: string | number | string[]) => {\n    setFormData((prev) => ({ ...prev, [field]: value }));\n  };\n\n  // Drag & Drop handlers\n  const handleDrag = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (e.type === \"dragenter\" || e.type === \"dragover\") {\n      setDragActive(true);\n    } else if (e.type === \"dragleave\") {\n      setDragActive(false);\n    }\n  }, []);\n\n  const handleDrop = useCallback(async (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setDragActive(false);\n\n    const files = e.dataTransfer.files;\n    if (files && files.length > 0) {\n      await processImageFiles(Array.from(files));\n    }\n  }, [formData.images.length, teamId]);\n\n  const processImageFiles = async (fileArray: File[]) => {\n    if (formData.images.length + fileArray.length > 10) {\n      setError(\"Maximum 10 photos autoris√©es\");\n      return;\n    }\n\n    setUploadingImages(true);\n    setError(null);\n\n    try {\n      const supabase = createClient();\n      const uploadedUrls: string[] = [];\n\n      for (const file of fileArray) {\n        if (file.size > 5 * 1024 * 1024) {\n          setError(`Le fichier ${file.name} d√©passe 5MB`);\n          continue;\n        }\n\n        const fileExt = file.name.split(\".\").pop()?.toLowerCase();\n        if (![\"jpg\", \"jpeg\", \"png\", \"webp\"].includes(fileExt || \"\")) {\n          setError(`Format non support√©: ${fileExt}`);\n          continue;\n        }\n\n        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;\n        const filePath = `team-properties/${teamId}/${fileName}`;\n\n        const { error: uploadError } = await supabase.storage\n          .from(\"properties\")\n          .upload(filePath, file, { cacheControl: \"3600\", upsert: false });\n\n        if (uploadError) throw new Error(`Erreur upload: ${uploadError.message}`);\n\n        const { data: { publicUrl } } = supabase.storage.from(\"properties\").getPublicUrl(filePath);\n        uploadedUrls.push(publicUrl);\n      }\n\n      setFormData((prev) => ({ ...prev, images: [...prev.images, ...uploadedUrls] }));\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Erreur lors de l'upload\");\n    } finally {\n      setUploadingImages(false);\n    }\n  };\n\n  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files || files.length === 0) return;\n    await processImageFiles(Array.from(files));\n  };\n\n  const removeImage = (index: number) => {\n    setFormData((prev) => ({ ...prev, images: prev.images.filter((_, i) => i !== index) }));\n  };\n\n  // AI Description\n  const handleGenerateAI = async () => {\n    if (!formData.address || !formData.price) {\n      setError(\"Renseignez l'adresse et le prix pour g√©n√©rer une description.\");\n      return;\n    }\n\n    setIsGeneratingAI(true);\n    setError(null);\n\n    const result = await generateSEODescription({\n      type: formData.type,\n      category: formData.category,\n      city: formData.address,\n      price: parseInt(formData.price),\n      surface: formData.surface ? parseInt(formData.surface) : undefined,\n      rooms: formData.rooms ? parseInt(formData.rooms) : undefined,\n      bedrooms: formData.bedrooms ? parseInt(formData.bedrooms) : undefined,\n      bathrooms: formData.bathrooms ? parseInt(formData.bathrooms) : undefined,\n      title: formData.title || undefined,\n    });\n\n    setIsGeneratingAI(false);\n\n    if (result.success) {\n      if (result.description) updateField(\"description\", result.description);\n      if (result.title && !formData.title) updateField(\"title\", result.title);\n    } else {\n      setError(result.error || \"Erreur lors de la g√©n√©ration\");\n    }\n  };\n\n  // Step validation\n  const validateStep = (step: number): boolean => {\n    setError(null);\n    switch (step) {\n      case 1:\n        if (!formData.title || formData.title.length < 3) {\n          setError(\"Le titre doit contenir au moins 3 caract√®res\");\n          return false;\n        }\n        if (!formData.price || parseInt(formData.price) <= 0) {\n          setError(\"Le prix est requis\");\n          return false;\n        }\n        return true;\n      case 2:\n        if (!formData.address) {\n          setError(\"L'adresse est requise\");\n          return false;\n        }\n        if (!formData.address) {\n          setError(\"L'adresse est requise\");\n          return false;\n        }\n        return true;\n      case 3:\n        return true;\n      case 4:\n        return true;\n      case 5:\n        if (publishMode === \"publish\" && formData.images.length === 0) {\n          setError(\"Au moins une image est requise pour publier\");\n          return false;\n        }\n        return true;\n      default:\n        return true;\n    }\n  };\n\n  const nextStep = () => {\n    if (validateStep(currentStep)) {\n      setCurrentStep((prev) => Math.min(prev + 1, 5));\n      scrollToTop();\n    }\n  };\n\n  const prevStep = () => {\n    setCurrentStep((prev) => Math.max(prev - 1, 1));\n    scrollToTop();\n  };\n\n  // Submit\n  const handleSubmit = async (mode: PublishMode = \"publish\", date?: string) => {\n    if (!validateStep(5)) return;\n\n    // Specific validation for scheduling\n    if (mode === \"schedule\" && !date) {\n      setError(\"S√©lectionnez une date pour la programmation\");\n      return;\n    }\n\n    setIsSubmitting(true);\n    setError(null);\n\n    const data: TeamPropertyData = {\n      type: formData.type,\n      category: formData.category,\n      title: formData.title,\n      price: parseInt(formData.price),\n      address: formData.address,\n      surface: formData.surface ? parseInt(formData.surface) : undefined,\n      rooms: formData.rooms ? parseInt(formData.rooms) : undefined,\n      bedrooms: formData.bedrooms ? parseInt(formData.bedrooms) : undefined,\n      bathrooms: formData.bathrooms ? parseInt(formData.bathrooms) : undefined,\n      description: formData.description,\n      virtual_tour_url: formData.virtual_tour_url,\n      images: formData.images,\n      owner_id: formData.owner_id,\n      location: formData.lat && formData.lon ? {\n        lat: formData.lat,\n        lon: formData.lon,\n        city: formData.city,\n        district: formData.district,\n        region: formData.region\n      } : undefined,\n    };\n\n    const result = await createTeamProperty(\n      teamId,\n      data,\n      mode,\n      mode === \"schedule\" ? date : undefined\n    );\n\n    setIsSubmitting(false);\n\n    if (result.success) {\n      const successMsg = mode === \"draft\" ? \"saved_draft\" : mode === \"schedule\" ? \"scheduled\" : \"created\";\n      router.push(`/gestion/biens?success=${successMsg}`);\n    } else {\n      if (result.upgradeRequired) {\n        setShowUpgradeModal(true);\n      }\n      setError(result.error || \"Erreur lors de la cr√©ation\");\n    }\n  };\n\n  const handleScheduleSubmit = () => {\n    if (!scheduledDate) return;\n    handleSubmit(\"schedule\", scheduledDate);\n    setIsScheduleDialogOpen(false);\n  };\n\n  const isTerrain = formData.type === \"terrain\";\n\n  return (\n    <div className=\"min-h-screen bg-background text-foreground\">\n      {/* Sticky Header */}\n      <div className=\"sticky top-0 z-50 bg-background/95 backdrop-blur-sm border-b border-border\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              <Link href=\"/gestion/biens\" className=\"p-2 hover:bg-muted rounded-lg transition-colors\">\n                <ArrowLeft className=\"w-5 h-5 text-muted-foreground\" />\n              </Link>\n              <div>\n                <h1 className=\"text-lg font-semibold\">Nouveau bien</h1>\n                <p className=\"text-sm text-muted-foreground\">{teamName}</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <button\n                onClick={() => handleSubmit()}\n                disabled={isSubmitting}\n                className=\"px-4 py-2 text-sm text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50\"\n              >\n                {isSubmitting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Progress Steps */}\n      <div className=\"max-w-4xl mx-auto px-4 py-6\">\n        <div className=\"flex items-center justify-between mb-8 overflow-x-auto pb-4 scrollbar-hide -mx-1 px-1\">\n          {STEPS.map((step, index) => {\n            const Icon = step.icon;\n            const isActive = currentStep === step.id;\n            const isCompleted = currentStep > step.id;\n\n            return (\n              <div key={step.id} className=\"flex items-center shrink-0\">\n                <button\n                  onClick={() => step.id < currentStep && setCurrentStep(step.id)}\n                  className={`flex flex-col items-center gap-2 transition-all ${step.id <= currentStep ? \"cursor-pointer\" : \"cursor-default\"\n                    }`}\n                >\n                  <div className={`w-9 h-9 sm:w-10 sm:h-10 rounded-full flex items-center justify-center transition-all ${isActive\n                    ? \"bg-primary text-primary-foreground shadow-lg\"\n                    : isCompleted\n                      ? \"bg-primary/20 text-primary\"\n                      : \"bg-muted text-muted-foreground\"\n                    }`}>\n                    {isCompleted ? <Check className=\"w-5 h-5\" /> : <Icon className=\"w-4 h-4 sm:w-5 sm:h-5\" />}\n                  </div>\n                  <span className={`text-[10px] sm:text-xs font-medium hidden sm:block ${isActive ? \"text-foreground\" : isCompleted ? \"text-primary\" : \"text-muted-foreground\"\n                    }`}>\n                    {step.title}\n                  </span>\n                </button>\n                {index < STEPS.length - 1 && (\n                  <div className={`w-6 sm:w-20 h-0.5 mx-1 sm:mx-2 ${currentStep > step.id ? \"bg-primary/30\" : \"bg-muted\"\n                    }`} />\n                )}\n              </div>\n            );\n          })}\n        </div>\n\n        {/* Error */}\n        {error && (\n          <div className=\"bg-red-500/10 border border-red-500/20 rounded-lg px-4 py-3 mb-6 text-red-400 text-sm\">\n            {error}\n          </div>\n        )}\n\n        {/* Step Content */}\n        <div className=\"space-y-8\">\n          {/* Step 1: L'essentiel */}\n          {currentStep === 1 && (\n            <div className=\"space-y-8 animate-in fade-in duration-300\">\n              {/* Transaction Toggle */}\n              <div>\n                <label className=\"text-sm text-muted-foreground mb-3 block\">Type de transaction</label>\n                <div className=\"flex bg-muted rounded-lg p-1 w-full sm:w-fit\">\n                  <button\n                    type=\"button\"\n                    onClick={() => updateField(\"category\", \"location\")}\n                    className={`flex-1 sm:flex-none px-6 py-2.5 rounded-md text-sm font-medium transition-all ${formData.category === \"location\"\n                      ? \"bg-background text-foreground shadow-sm\"\n                      : \"text-muted-foreground hover:text-foreground\"\n                      }`}\n                  >\n                    Location\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={() => updateField(\"category\", \"vente\")}\n                    className={`flex-1 sm:flex-none px-6 py-2.5 rounded-md text-sm font-medium transition-all ${formData.category === \"vente\"\n                      ? \"bg-background text-foreground shadow-sm\"\n                      : \"text-muted-foreground hover:text-foreground\"\n                      }`}\n                  >\n                    Vente\n                  </button>\n                </div>\n              </div>\n\n              {/* Property Type Cards */}\n              <div>\n                <label className=\"text-sm text-muted-foreground mb-3 block\">Type de bien</label>\n                <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3\">\n                  {PROPERTY_TYPES.map((type) => {\n                    const Icon = type.icon;\n                    return (\n                      <button\n                        key={type.value}\n                        type=\"button\"\n                        onClick={() => updateField(\"type\", type.value)}\n                        className={`p-3 sm:p-4 rounded-xl border transition-all text-center ${formData.type === type.value\n                          ? \"bg-primary/10 border-primary/50 text-primary\"\n                          : \"bg-card border-border text-muted-foreground hover:border-primary/30 hover:text-foreground\"\n                          }`}\n                      >\n                        <Icon className={`w-5 h-5 sm:w-6 sm:h-6 mx-auto mb-2 ${formData.type === type.value ? \"text-primary\" : \"text-muted-foreground\"\n                          }`} />\n                        <span className=\"text-[11px] sm:text-xs font-medium\">{type.label}</span>\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n\n              {/* Title */}\n              <div>\n                <Label className=\"text-sm text-muted-foreground mb-2 block\" required>Titre de l&apos;annonce</Label>\n                <input\n                  type=\"text\"\n                  value={formData.title}\n                  onChange={(e) => updateField(\"title\", e.target.value)}\n                  placeholder=\"Ex: Belle villa avec piscine\"\n                  className=\"w-full bg-card border border-border rounded-lg px-4 py-3 text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all\"\n                />\n              </div>\n\n              {/* Price */}\n              <div>\n                <Label className=\"text-sm text-muted-foreground mb-2 block\" required>\n                  Prix {formData.category === \"location\" ? \"mensuel\" : \"de vente\"}\n                </Label>\n                <div className=\"relative\">\n                  <input\n                    type=\"number\"\n                    value={formData.price}\n                    onChange={(e) => updateField(\"price\", e.target.value)}\n                    placeholder=\"0\"\n                    className=\"w-full bg-card border border-border rounded-lg px-4 py-3 pr-32 text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all\"\n                  />\n                  <span className=\"absolute right-10 top-1/2 -translate-y-1/2 text-muted-foreground text-sm\">\n                    FCFA{formData.category === \"location\" && \"/mois\"}\n                  </span>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 2: Localisation */}\n          {currentStep === 2 && (\n            <div className=\"space-y-6 animate-in fade-in duration-300\">\n              <div>\n                <Label className=\"text-sm text-muted-foreground mb-3 block\" required>Adresse compl√®te du bien</Label>\n\n                <AddressAutocomplete\n                  defaultValue={formData.address}\n                  onAddressSelect={(details) => {\n                    setFormData(prev => ({\n                      ...prev,\n                      address: details.display_name,\n                      lat: details.lat ? parseFloat(details.lat) : null,\n                      lon: details.lon ? parseFloat(details.lon) : null,\n                      city: details.city || \"\",\n                      district: details.suburb || \"\",\n                      region: details.state || \"\"\n                    }));\n                  }}\n                  className=\"w-full\"\n                />\n              </div>\n            </div>\n          )}\n\n          {/* Step 3: D√©tails */}\n          {currentStep === 3 && (\n            <div className=\"space-y-6 animate-in fade-in duration-300\">\n              <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-4\">\n                <div>\n                  <label className=\"text-sm text-muted-foreground mb-2 block\">Surface</label>\n                  <div className=\"relative\">\n                    <input\n                      type=\"number\"\n                      value={formData.surface}\n                      onChange={(e) => updateField(\"surface\", e.target.value)}\n                      placeholder=\"0\"\n                      className=\"w-full bg-card border border-border rounded-lg px-4 py-3 pr-16 text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all\"\n                    />\n                    <span className=\"absolute right-10 top-1/2 -translate-y-1/2 text-muted-foreground text-sm\">m¬≤</span>\n                  </div>\n                </div>\n\n                {!isTerrain && (\n                  <>\n                    <div>\n                      <label className=\"text-sm text-muted-foreground mb-2 block\">Pi√®ces</label>\n                      <input\n                        type=\"number\"\n                        value={formData.rooms}\n                        onChange={(e) => updateField(\"rooms\", e.target.value)}\n                        placeholder=\"0\"\n                        className=\"w-full bg-card border border-border rounded-lg px-4 py-3 text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm text-muted-foreground mb-2 block\">Chambres</label>\n                      <input\n                        type=\"number\"\n                        value={formData.bedrooms}\n                        onChange={(e) => updateField(\"bedrooms\", e.target.value)}\n                        placeholder=\"0\"\n                        className=\"w-full bg-card border border-border rounded-lg px-4 py-3 text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm text-muted-foreground mb-2 block\">Salles de bain</label>\n                      <input\n                        type=\"number\"\n                        value={formData.bathrooms}\n                        onChange={(e) => updateField(\"bathrooms\", e.target.value)}\n                        placeholder=\"0\"\n                        className=\"w-full bg-card border border-border rounded-lg px-4 py-3 text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all\"\n                      />\n                    </div>\n                  </>\n                )}\n              </div>\n\n              {isTerrain && (\n                <p className=\"text-sm text-muted-foreground\">\n                  Pour un terrain, seule la surface est requise.\n                </p>\n              )}\n            </div>\n          )}\n\n          {/* Step 4: M√©dia */}\n          {currentStep === 4 && (\n            <div className=\"space-y-6 animate-in fade-in duration-300\">\n              {/* Photos Drag & Drop */}\n              <div>\n                <label className=\"text-sm text-muted-foreground mb-3 block\">\n                  Photos ({formData.images.length}/10)\n                </label>\n                <div\n                  onDragEnter={handleDrag}\n                  onDragLeave={handleDrag}\n                  onDragOver={handleDrag}\n                  onDrop={handleDrop}\n                  className={`border-2 border-dashed rounded-xl p-8 text-center transition-all ${dragActive\n                    ? \"border-primary bg-primary/5\"\n                    : \"border-border hover:border-muted-foreground/50\"\n                    }`}\n                >\n                  {uploadingImages ? (\n                    <div className=\"flex flex-col items-center gap-3\">\n                      <Loader2 className=\"w-8 h-8 text-primary animate-spin\" />\n                      <p className=\"text-muted-foreground\">Upload en cours...</p>\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center gap-3\">\n                      <Upload className=\"w-10 h-10 text-muted-foreground/50\" />\n                      <div>\n                        <p className=\"text-foreground\">Glissez vos photos ici</p>\n                        <p className=\"text-sm text-muted-foreground mt-1\">ou</p>\n                      </div>\n                      <label className=\"cursor-pointer px-4 py-2 bg-muted hover:bg-muted/80 text-foreground text-sm rounded-lg transition-colors border border-border\">\n                        Parcourir\n                        <input\n                          type=\"file\"\n                          multiple\n                          accept=\"image/*\"\n                          onChange={handleImageUpload}\n                          className=\"hidden\"\n                        />\n                      </label>\n                      <p className=\"text-xs text-muted-foreground/60\">JPG, PNG, WebP ‚Ä¢ Max 5MB par photo</p>\n                    </div>\n                  )}\n                </div>\n\n                {/* Image Preview Grid */}\n                {formData.images.length > 0 && (\n                  <div className=\"grid grid-cols-3 sm:grid-cols-5 gap-3 mt-4\">\n                    {formData.images.map((url, index) => (\n                      <div key={index} className=\"relative aspect-square rounded-lg overflow-hidden group border border-border\">\n                        <Image src={url} alt={`Photo ${index + 1}`} fill className=\"object-cover\" />\n                        <button\n                          type=\"button\"\n                          onClick={() => removeImage(index)}\n                          className=\"absolute top-1 right-1 p-1 bg-black/60 rounded-full opacity-0 group-hover:opacity-100 transition-opacity\"\n                        >\n                          <X className=\"w-4 h-4 text-white\" />\n                        </button>\n                        {index === 0 && (\n                          <span className=\"absolute bottom-1 left-1 px-2 py-0.5 bg-primary text-primary-foreground text-xs font-medium rounded shadow-sm\">\n                            Principale\n                          </span>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n\n              {/* Description */}\n              <div>\n                <div className=\"flex items-center justify-between mb-2\">\n                  <label className=\"text-sm text-muted-foreground\">Description</label>\n                  <button\n                    type=\"button\"\n                    onClick={handleGenerateAI}\n                    disabled={isGeneratingAI}\n                    className=\"flex items-center gap-1.5 text-xs text-muted-foreground hover:text-primary transition-colors disabled:opacity-50\"\n                  >\n                    {isGeneratingAI ? (\n                      <Loader2 className=\"w-3.5 h-3.5 animate-spin\" />\n                    ) : (\n                      <Sparkles className=\"w-3.5 h-3.5\" />\n                    )}\n                    Am√©liorer avec l&apos;IA\n                  </button>\n                </div>\n                <textarea\n                  value={formData.description}\n                  onChange={(e) => updateField(\"description\", e.target.value)}\n                  placeholder=\"D√©crivez le bien, ses atouts, son environnement...\"\n                  rows={5}\n                  className=\"w-full bg-card border border-border rounded-lg px-4 py-3 text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 resize-none transition-all\"\n                />\n              </div>\n\n              {/* Virtual Tour */}\n              <div>\n                <label className=\"text-sm text-muted-foreground mb-2 block\">\n                  Visite virtuelle <span className=\"text-muted-foreground/60\">(optionnel)</span>\n                </label>\n                <input\n                  type=\"text\"\n                  value={formData.virtual_tour_url}\n                  onChange={(e) => updateField(\"virtual_tour_url\", e.target.value)}\n                  placeholder=\"Lien YouTube ou Google Maps 360\"\n                  className=\"w-full bg-card border border-border rounded-lg px-4 py-3 text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all\"\n                />\n              </div>\n            </div>\n          )}\n\n          {/* Step 5: Publication */}\n          {currentStep === 5 && (\n            <div className=\"space-y-8 animate-in fade-in duration-300\">\n              {/* Owner */}\n              <div>\n                <label className=\"text-sm text-muted-foreground mb-3 block\">\n                  Propri√©taire <span className=\"text-muted-foreground/60\">(optionnel)</span>\n                </label>\n                <OwnerSelector\n                  value={formData.owner_id}\n                  onChange={(id) => updateField(\"owner_id\", id || \"\")}\n                />\n              </div>\n\n            </div>\n\n          )}\n        </div>\n\n        {/* Navigation Buttons */}\n        <div className=\"flex items-center justify-between mt-12 pt-6 border-t border-border\">\n          <button\n            type=\"button\"\n            onClick={prevStep}\n            disabled={currentStep === 1}\n            className=\"flex items-center gap-2 px-5 py-2.5 text-muted-foreground hover:text-foreground disabled:opacity-30 disabled:cursor-not-allowed transition-colors\"\n          >\n            <ArrowLeft className=\"w-4 h-4\" />\n            Retour\n          </button>\n\n          {currentStep < 5 ? (\n            <button\n              type=\"button\"\n              onClick={nextStep}\n              className=\"flex items-center gap-2 px-6 py-2.5 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-all shadow-md\"\n            >\n              Continuer\n              <ArrowRight className=\"w-4 h-4\" />\n            </button>\n          ) : (\n            <div className=\"flex items-center gap-3\">\n              <button\n                type=\"button\"\n                onClick={() => handleSubmit(\"draft\")}\n                disabled={isSubmitting}\n                className=\"px-4 py-2.5 text-muted-foreground hover:text-foreground text-sm font-medium transition-colors\"\n              >\n                Enregistrer en brouillon\n              </button>\n\n              <div className=\"inline-flex rounded-md shadow-sm\" role=\"group\">\n                <button\n                  type=\"button\"\n                  onClick={() => handleSubmit(\"publish\")}\n                  disabled={isSubmitting}\n                  className=\"\n                    flex items-center gap-2 \n                    px-4 py-2 \n                    bg-primary text-primary-foreground hover:bg-primary/90\n                    font-medium \n                    rounded-l-lg rounded-r-none \n                    transition-all duration-200 ease-in-out\n                    focus:z-10 focus:ring-2 focus:ring-primary/50\n                  \"\n                >\n                  {isSubmitting ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Send className=\"w-4 h-4\" />}\n                  Publier\n                </button>\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <button\n                      disabled={isSubmitting}\n                      className=\"\n                        px-2 py-2 \n                        bg-primary text-primary-foreground hover:bg-primary/90\n                        rounded-r-lg rounded-l-none \n                        border-l border-white/10 \n                        transition-all duration-200 ease-in-out\n                        focus:z-10 focus:ring-2 focus:ring-primary/50\n                      \"\n                    >\n                      <ChevronDown className=\"w-4 h-4\" />\n                      <span className=\"sr-only\">Options de publication</span>\n                    </button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\" className=\"w-[200px]\">\n                    <DropdownMenuItem\n                      onClick={() => setIsScheduleDialogOpen(true)}\n                      className=\"cursor-pointer flex items-center gap-2 py-2.5\"\n                    >\n                      <Clock className=\"w-4 h-4 text-muted-foreground\" />\n                      <span>Programmer</span>\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Schedule Dialog */}\n        <Dialog open={isScheduleDialogOpen} onOpenChange={setIsScheduleDialogOpen}>\n          <DialogContent className=\"sm:max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Programmer la publication</DialogTitle>\n              <DialogDescription>\n                Choisissez la date et l&apos;heure √† laquelle le bien sera visible publiquement.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"py-6\">\n              <div className=\"flex flex-col space-y-4\">\n                <label className=\"text-sm font-medium\">Date et heure</label>\n                <input\n                  type=\"datetime-local\"\n                  value={scheduledDate}\n                  onChange={(e) => setScheduledDate(e.target.value)}\n                  className=\"w-full bg-background border border-border rounded-lg px-4 py-2 text-foreground focus:outline-none focus:ring-1 focus:ring-primary/50 focus:border-primary/50\"\n                  min={new Date().toISOString().slice(0, 16)}\n                />\n              </div>\n            </div>\n            <DialogFooter className=\"sm:justify-between\">\n              <button\n                type=\"button\"\n                onClick={() => setIsScheduleDialogOpen(false)}\n                className=\"px-4 py-2 text-sm text-muted-foreground hover:text-foreground transition-colors\"\n              >\n                Annuler\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleScheduleSubmit}\n                disabled={!scheduledDate || isSubmitting}\n                className=\"px-4 py-2 bg-[#0F172A] text-white rounded-lg text-sm font-medium hover:bg-[#1E293B] dark:bg-primary dark:text-primary-foreground dark:hover:bg-primary/90 transition-all shadow-md disabled:opacity-50\"\n              >\n                Confirmer la programmation\n              </button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Upgrade Modal */}\n        <UpgradeModal\n          open={showUpgradeModal}\n          onOpenChange={setShowUpgradeModal}\n          propertiesCount={10} // Just a fallback or fetch real stats\n        />\n      </div >\n    </div >\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\biens\\nouveau\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\biens\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\AddTenantButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1554,1557],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1554,1557],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\AddTenantButton.tsx:76:42\n  74 |     // Reset rent amount when opening/closing\n  75 |     useEffect(() => {\n> 76 |         if (open && initialData?.amount) setRentAmount(initialData.amount);\n     |                                          ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  77 |     }, [open, initialData]);\n  78 |\n  79 |     // Confetti celebration for first tenant creation - Golden luxury effect (Desktop optimized)","line":76,"column":42,"nodeType":null,"endLine":76,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":178,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6687,6690],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6687,6690],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":180,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6827,6830],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6827,6830],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":566,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":566,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27890,27893],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27890,27893],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":818,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":818,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[42394,42397],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[42394,42397],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":877,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":877,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[45133,45136],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[45133,45136],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":928,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":928,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47647,47650],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47647,47650],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":934,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":934,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47911,47914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47911,47914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1004,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1004,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[51387,51390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[51387,51390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1012,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1012,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[51757,51760],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[51757,51760],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1032,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1032,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[52761,52764],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[52761,52764],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1089,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1089,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[54817,54820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[54817,54820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useEffect, useCallback, useRef } from 'react';\r\nimport { Plus, Loader2, ChevronDown, Upload, User, FileSpreadsheet, X, AlertCircle, ShieldCheck, Mail, Wallet, FileText, Check, _ArrowRight, _MapPin, _Home } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    _DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuItem,\r\n    DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport * as XLSX from 'xlsx';\r\nimport { createNewLease, confirmPayment, sendWelcomePack } from \"../actions\";\r\nimport { UpgradeModal } from \"@/components/gestion/UpgradeModal\";\r\nimport { toast } from 'sonner';\r\nimport { useRouter } from 'next/navigation';\r\nimport { GenerateContractModal } from '@/components/contracts/GenerateContractModal';\r\nimport { generateLeaseContract } from '@/lib/actions/contract-actions';\r\nimport { getPremiumBranding } from '../config/actions';\r\n// import confetti from 'canvas-confetti';\r\nimport { PropertySelector } from './PropertySelector';\r\nimport { type VacantProperty, getAllTeamProperties } from '../actions/property-selector';\r\nimport { fuzzyMatchProperty } from '../utils/property-matching';\r\n\r\ninterface AddTenantButtonProps {\r\n    ownerId: string;\r\n    trigger?: React.ReactNode;\r\n    profile?: any; // To allow flexibility with Supabase types\r\n    initialData?: {\r\n        name?: string;\r\n        phone?: string;\r\n        email?: string;\r\n        address?: string;\r\n        amount?: number;\r\n        day?: number;\r\n        startDate?: string;\r\n        endDate?: string;\r\n    };\r\n}\r\n\r\nconst FIRST_TENANT_KEY = 'dousell_first_tenant_created';\r\n\r\nexport function AddTenantButton({ ownerId, trigger, initialData, profile }: AddTenantButtonProps) {\r\n    const [open, setOpen] = useState(false);\r\n    const [bulkImportOpen, setBulkImportOpen] = useState(false);\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [showProfileAlert, setShowProfileAlert] = useState(false);\r\n\r\n    const [showOnboardingWizard, setShowOnboardingWizard] = useState(false);\r\n    const [showUpgradeModal, setShowUpgradeModal] = useState(false);\r\n\r\n    // Contract Generation Flow State\r\n    const [showContractPrompt, setShowContractPrompt] = useState(false);\r\n    const [showContractModal, setShowContractModal] = useState(false);\r\n\r\n    const [createdLease, setCreatedLease] = useState<{ id: string, name: string, amount: number, depositMonths: number } | null>(null);\r\n\r\n    const router = useRouter();\r\n\r\n    // Controlled state for rent amount to allow auto-fill\r\n    const [rentAmount, setRentAmount] = useState<string | number>(initialData?.amount || '');\r\n\r\n    // Reset rent amount when opening/closing\r\n    useEffect(() => {\r\n        if (open && initialData?.amount) setRentAmount(initialData.amount);\r\n    }, [open, initialData]);\r\n\r\n    // Confetti celebration for first tenant creation - Golden luxury effect (Desktop optimized)\r\n    const triggerConfetti = useCallback(() => {\r\n        // Confetti disabled temporarily for mobile crash investigation\r\n         \r\n        console.log(\"Confetti celebration skipped (mobile crash investigation)\");\r\n        /*\r\n        // Palette dor√©e luxe\r\n        const goldColors = [\r\n            '#F4C430', // Or Dousell (primary)\r\n            '#FFD700', // Or pur\r\n            '#DAA520', // Goldenrod\r\n            '#B8860B', // Dark goldenrod\r\n            '#FFC107', // Amber\r\n            '#FFECB3', // Or clair / champagne\r\n        ];\r\n\r\n        // D√©tection desktop pour ajuster l'intensit√©\r\n        const isDesktop = window.innerWidth >= 1024;\r\n        const particleMultiplier = isDesktop ? 1.5 : 1;\r\n\r\n        // Burst initial central - plus large sur desktop\r\n        confetti({\r\n            particleCount: Math.floor(120 * particleMultiplier),\r\n            spread: isDesktop ? 100 : 70,\r\n            origin: { y: 0.6, x: 0.5 },\r\n            colors: goldColors,\r\n            shapes: ['circle', 'square'],\r\n            scalar: isDesktop ? 1.4 : 1.2,\r\n            gravity: 0.8,\r\n            ticks: 350,\r\n            drift: 0,\r\n            zIndex: 9999, // Force on top\r\n        });\r\n\r\n        // Bursts suppl√©mentaires sur desktop (gauche et droite)\r\n        if (isDesktop) {\r\n            setTimeout(() => {\r\n                confetti({\r\n                    particleCount: 60,\r\n                    spread: 60,\r\n                    origin: { y: 0.7, x: 0.25 },\r\n                    colors: goldColors,\r\n                    shapes: ['circle'],\r\n                    scalar: 1.2,\r\n                    gravity: 0.9,\r\n                    zIndex: 9999,\r\n                });\r\n                confetti({\r\n                    particleCount: 60,\r\n                    spread: 60,\r\n                    origin: { y: 0.7, x: 0.75 },\r\n                    colors: goldColors,\r\n                    shapes: ['circle'],\r\n                    scalar: 1.2,\r\n                    gravity: 0.9,\r\n                    zIndex: 9999,\r\n                });\r\n            }, 200);\r\n        }\r\n        */\r\n    }, []);\r\n\r\n    const handleTriggerClick = async (e: React.MouseEvent) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        // 1. Check if profile has minimal information (just company name is enough) via props (optimistic)\r\n        const isProfileComplete = profile && (profile.full_name || profile.company_name);\r\n\r\n        if (isProfileComplete) {\r\n            setOpen(true);\r\n            return;\r\n        }\r\n\r\n        // 2. If prop check fails, double check with server action (bypasses cache)\r\n        const toastId = toast.loading(\"V√©rification du profil...\");\r\n        try {\r\n            const result = await getPremiumBranding();\r\n            toast.dismiss(toastId);\r\n\r\n            if (result.success && result.data) {\r\n                const fresh = result.data;\r\n                if (fresh.full_name || fresh.company_name) {\r\n                    setOpen(true);\r\n                    return;\r\n                }\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Error checking profile\", err);\r\n            toast.dismiss(toastId);\r\n        }\r\n\r\n        setShowProfileAlert(true);\r\n    };\r\n\r\n    const renderTrigger = () => {\r\n        // ... existing renderTrigger \r\n        if (trigger) {\r\n            if (React.isValidElement(trigger)) {\r\n                return React.cloneElement(trigger as React.ReactElement<any>, {\r\n                    onClick: (e: React.MouseEvent) => {\r\n                        const childProps = (trigger as React.ReactElement<any>).props;\r\n                        if (childProps.onClick) childProps.onClick(e);\r\n                        handleTriggerClick(e);\r\n                    }\r\n                });\r\n            }\r\n            return <span onClick={handleTriggerClick} className=\"cursor-pointer\">{trigger}</span>;\r\n        }\r\n\r\n        return (\r\n            <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                    <Button className=\"bg-primary text-primary-foreground hover:bg-primary/90 rounded-lg h-9 px-2 sm:px-4 font-medium text-sm transition-all shadow-sm\">\r\n                        <Plus className=\"w-4 h-4 sm:mr-1.5\" /> <span className=\"hidden sm:inline\">Ajouter</span>\r\n                        <ChevronDown className=\"w-3 h-3 ml-1 sm:ml-2 opacity-70\" />\r\n                    </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\" className=\"bg-popover border-border min-w-[200px] p-1 shadow-lg\">\r\n                    <DropdownMenuItem\r\n                        onClick={handleTriggerClick}\r\n                        className=\"flex items-center gap-3 cursor-pointer rounded-lg px-3 py-2.5 text-sm hover:bg-accent focus:bg-accent focus:text-accent-foreground\"\r\n                    >\r\n                        <User className=\"w-4 h-4\" />\r\n                        <span>Ajouter un locataire</span>\r\n                    </DropdownMenuItem>\r\n                    <DropdownMenuItem\r\n                        onClick={() => setBulkImportOpen(true)}\r\n                        className=\"flex items-center gap-3 cursor-pointer rounded-lg px-3 py-2.5 text-sm hover:bg-accent focus:bg-accent focus:text-accent-foreground\"\r\n                    >\r\n                        <FileSpreadsheet className=\"w-4 h-4\" />\r\n                        <span>Ajouter en masse</span>\r\n                    </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n            </DropdownMenu>\r\n        );\r\n    };\r\n\r\n    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\r\n        // ... existing handleSubmit\r\n        e.preventDefault();\r\n        setLoading(true);\r\n        setError(null);\r\n        const formData = new FormData(e.currentTarget);\r\n        const tenantNameVal = formData.get('tenant_name') as string;\r\n        const monthlyAmount = Number(formData.get('monthly_amount'));\r\n        const depositMonths = Number(formData.get('deposit_months')) || 2;\r\n\r\n        // Note: property_id and other hidden fields from PropertySelector are automatically in formData\r\n\r\n        // ... rest of logic\r\n        const data = {\r\n            owner_id: ownerId,\r\n            tenant_name: tenantNameVal,\r\n            tenant_phone: formData.get('tenant_phone') as string,\r\n            tenant_email: formData.get('tenant_email') as string,\r\n            property_address: formData.get('property_address') as string, // Will be filled by hidden input from PropertySelector\r\n            property_id: formData.get('property_id') as string, // Will be filled by hidden input from PropertySelector\r\n            monthly_amount: monthlyAmount,\r\n            billing_day: Number(formData.get('billing_day')) || 5,\r\n            start_date: formData.get('start_date') as string,\r\n            end_date: formData.get('end_date') as string || null,\r\n            status: 'active' as const,\r\n            deposit_months: depositMonths,\r\n            create_new_property: formData.get('create_new_property'),\r\n            new_property_title: formData.get('new_property_title'),\r\n            new_property_address: formData.get('new_property_address'),\r\n            new_property_price: formData.get('new_property_price'),\r\n        };\r\n\r\n        const result = await createNewLease(data);\r\n        // ... rest of function\r\n        setLoading(false);\r\n\r\n        if (result.success && result.id) {\r\n            // ... (rest of success logic)\r\n            const isFirstTenant = !localStorage.getItem(FIRST_TENANT_KEY);\r\n            if (isFirstTenant) {\r\n                localStorage.setItem(FIRST_TENANT_KEY, 'true');\r\n                triggerConfetti();\r\n            }\r\n            toast.success('Locataire cr√©√© ! Place √† la configuration...');\r\n\r\n            setCreatedLease({\r\n                id: result.id,\r\n                name: tenantNameVal,\r\n                amount: monthlyAmount,\r\n                depositMonths: depositMonths\r\n            });\r\n            setOpen(false);\r\n\r\n            setTimeout(() => {\r\n                setShowOnboardingWizard(true);\r\n            }, 100);\r\n\r\n            router.refresh();\r\n        } else {\r\n            if (result.upgradeRequired) {\r\n                setShowUpgradeModal(true);\r\n            }\r\n            const errorMsg = result.error || 'Erreur lors de la cr√©ation';\r\n            setError(errorMsg);\r\n            toast.error(errorMsg);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            {renderTrigger()}\r\n            <Dialog open={open} onOpenChange={setOpen}>\r\n                <DialogContent className=\"z-[100] fixed top-[4%] left-[50%] translate-x-[-50%] translate-y-0 sm:top-[50%] sm:translate-y-[-50%] w-[90vw] sm:w-full max-w-lg max-h-[92vh] overflow-y-auto overflow-x-hidden bg-card border-border text-foreground px-4 pt-4 pb-24 sm:p-6 outline-none shadow-2xl\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"text-xl font-semibold text-foreground\">\r\n                            {initialData ? \"Nouveau Bail (D√©mo)\" : \"Nouveau Bail\"}\r\n                        </DialogTitle>\r\n                        <DialogDescription className=\"text-muted-foreground\">\r\n                            {initialData ? \"Ces donn√©es sont pr√©-remplies pour tester la cr√©ation.\" : \"Remplissez les informations pour cr√©er un nouveau bail\"}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <form onSubmit={handleSubmit} className=\"space-y-4 mt-4\">\r\n                        {/* Zone d'erreur critique */}\r\n                        {error && (\r\n                            <div className=\"bg-red-500/10 border border-red-500/50 rounded-lg p-3 flex items-start gap-3\">\r\n                                <span className=\"text-red-500 mt-0.5\">‚ö†Ô∏è</span>\r\n                                <div className=\"space-y-1\">\r\n                                    <h4 className=\"text-sm font-semibold text-destructive\">Erreur Bloquante</h4>\r\n                                    <p className=\"text-sm text-destructive/90\">{error}</p>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"tenant_name\" className=\"text-sm font-medium text-foreground/80\" required>\r\n                                    Nom complet\r\n                                </Label>\r\n                                <Input\r\n                                    name=\"tenant_name\"\r\n                                    placeholder=\"ex: Amadou Ndiaye\"\r\n                                    defaultValue={initialData?.name}\r\n                                    required\r\n                                    className=\"bg-transparent border-border text-foreground focus-visible:ring-primary\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-foreground/80\">T√©l√©phone</label>\r\n                                <Input\r\n                                    name=\"tenant_phone\"\r\n                                    placeholder=\"ex: +221 77...\"\r\n                                    defaultValue={initialData?.phone}\r\n                                    className=\"bg-transparent border-border text-foreground focus-visible:ring-primary\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"tenant_email\" className=\"text-sm font-medium text-foreground/80\" required>\r\n                                Email <span className=\"text-xs text-muted-foreground ml-2\">(pour l&apos;envoi des quittances)</span>\r\n                            </Label>\r\n                            <Input\r\n                                name=\"tenant_email\"\r\n                                type=\"email\"\r\n                                placeholder=\"ex: locataire@email.com\"\r\n                                defaultValue={initialData?.email}\r\n                                required\r\n                                className=\"bg-transparent border-border text-foreground focus-visible:ring-primary\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* REPLACED ADDRESS INPUT WITH PROPERTY SELECTOR */}\r\n                        <PropertySelector\r\n                            onPropertySelect={(property) => {\r\n                                if (property) {\r\n                                    setRentAmount(property.price);\r\n                                }\r\n                            }}\r\n                            onCreateNew={(newProp) => {\r\n                                setRentAmount(newProp.price);\r\n                            }}\r\n                            defaultAddress={initialData?.address}\r\n                        />\r\n\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"monthly_amount\" className=\"text-sm font-medium text-foreground/80\" required>\r\n                                    Loyer (FCFA)\r\n                                </Label>\r\n                                <Input\r\n                                    name=\"monthly_amount\"\r\n                                    type=\"number\"\r\n                                    placeholder=\"500000\"\r\n                                    value={rentAmount}\r\n                                    onChange={(e) => setRentAmount(e.target.value)}\r\n                                    required\r\n                                    className=\"bg-transparent border-border text-foreground font-mono focus-visible:ring-primary\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-foreground/80\">Jour de paiement</label>\r\n                                <Input\r\n                                    name=\"billing_day\"\r\n                                    type=\"number\"\r\n                                    min=\"1\"\r\n                                    max=\"31\"\r\n                                    defaultValue={initialData?.day || 5}\r\n                                    className=\"bg-transparent border-border text-foreground focus-visible:ring-primary\"\r\n                                />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"start_date\" className=\"text-sm font-medium text-foreground/80\" required>\r\n                                    D√©but bail\r\n                                </Label>\r\n                                <Input\r\n                                    name=\"start_date\"\r\n                                    type=\"date\"\r\n                                    defaultValue={initialData?.startDate}\r\n                                    required\r\n                                    className=\"bg-transparent border-border text-foreground h-10 w-full px-3 block focus-visible:ring-primary [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-calendar-picker-indicator]:opacity-60 [&::-webkit-calendar-picker-indicator]:hover:opacity-100 [&::-webkit-calendar-picker-indicator]:ml-auto [&::-webkit-calendar-picker-indicator]:p-1 dark:[&::-webkit-calendar-picker-indicator]:invert\"\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"end_date\" className=\"text-sm font-medium text-foreground/80\" required>\r\n                                Fin bail <span className=\"text-xs text-muted-foreground ml-2\">(pour les alertes juridiques J-180 et J-90)</span>\r\n                            </Label>\r\n                            <Input\r\n                                name=\"end_date\"\r\n                                type=\"date\"\r\n                                defaultValue={initialData?.endDate}\r\n                                required\r\n                                className=\"bg-transparent border-border text-foreground h-10 w-full px-3 block focus-visible:ring-primary [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-calendar-picker-indicator]:opacity-60 [&::-webkit-calendar-picker-indicator]:hover:opacity-100 [&::-webkit-calendar-picker-indicator]:ml-auto [&::-webkit-calendar-picker-indicator]:p-1 dark:[&::-webkit-calendar-picker-indicator]:invert\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Caution Field */}\r\n                        <div className=\"bg-muted/30 p-3 rounded-lg border border-border\">\r\n                            <label className=\"text-sm font-medium text-foreground/80 flex justify-between\">\r\n                                <span>Mois de caution</span>\r\n                                <span className=\"text-xs text-primary\">Recommand√©: 2 mois</span>\r\n                            </label>\r\n                            <div className=\"flex gap-2 mt-2\">\r\n                                {[1, 2, 3].map((m) => (\r\n                                    <label key={m} className=\"flex-1 cursor-pointer\">\r\n                                        <input type=\"radio\" name=\"deposit_months\" value={m} className=\"peer hidden\" defaultChecked={m === 2} />\r\n                                        <div className=\"h-9 flex items-center justify-center rounded-md border border-border bg-card text-muted-foreground peer-checked:bg-primary peer-checked:text-primary-foreground peer-checked:border-primary peer-checked:font-bold transition-all text-sm\">\r\n                                            {m} Mois\r\n                                        </div>\r\n                                    </label>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"pt-4\">\r\n                            <Button\r\n                                type=\"submit\"\r\n                                disabled={loading}\r\n                                className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 h-11 text-base font-semibold rounded-lg disabled:opacity-70 disabled:cursor-not-allowed transition-all shadow-md\"\r\n                            >\r\n                                {loading ? (\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Loader2 className=\"h-5 w-5 animate-spin\" />\r\n                                        <span>Cr√©ation en cours...</span>\r\n                                    </div>\r\n                                ) : (\r\n                                    \"Confirmer & Cr√©er le Bail\"\r\n                                )}\r\n                            </Button>\r\n                        </div>\r\n                    </form>\r\n                </DialogContent>\r\n            </Dialog >\r\n\r\n            {/* PROMPT: Generate Contract? */}\r\n            <Dialog open={showContractPrompt} onOpenChange={setShowContractPrompt}>\r\n                <DialogContent className=\"sm:max-w-md bg-card border-border text-foreground shadow-2xl\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"text-foreground\">G√©n√©rer le contrat de bail ?</DialogTitle>\r\n                        <DialogDescription className=\"text-muted-foreground\">\r\n                            Le locataire a √©t√© cr√©√© avec succ√®s. Souhaitez-vous g√©n√©rer et personnaliser le contrat de bail maintenant ?\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <div className=\"flex justify-end gap-3 mt-4\">\r\n                        <Button\r\n                            variant=\"ghost\"\r\n                            onClick={() => setShowContractPrompt(false)}\r\n                            className=\"text-muted-foreground hover:text-foreground\"\r\n                        >\r\n                            Non, plus tard\r\n                        </Button>\r\n                        <Button\r\n                            onClick={() => {\r\n                                setShowContractPrompt(false);\r\n                                // Small delay to prevent body scroll locking issues between modals\r\n                                setTimeout(() => setShowContractModal(true), 150);\r\n                            }}\r\n                            className=\"bg-primary text-primary-foreground hover:bg-primary/90 transition-colors shadow-sm\"\r\n                        >\r\n                            Oui, g√©n√©rer le contrat\r\n                        </Button>\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            {/* MODAL: Generate Contract */}\r\n            {\r\n                createdLease && (\r\n                    <GenerateContractModal\r\n                        leaseId={createdLease.id}\r\n                        tenantName={createdLease.name}\r\n                        open={showContractModal}\r\n                        onOpenChange={setShowContractModal}\r\n                        onSuccess={() => {\r\n                            // Contract generated successfully\r\n                            setShowContractModal(false);\r\n                        }}\r\n                    />\r\n                )\r\n            }\r\n            {/* ALERT: Profile Incomplete */}\r\n            <Dialog open={showProfileAlert} onOpenChange={setShowProfileAlert}>\r\n                <DialogContent className=\"sm:max-w-md bg-card border-destructive/50 text-foreground shadow-2xl\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"flex items-center gap-2 text-destructive\">\r\n                            <span>‚ö†Ô∏è Profil Incomplet</span>\r\n                        </DialogTitle>\r\n                        <DialogDescription className=\"text-muted-foreground pt-2\">\r\n                            Pour cr√©er des baux valides, vous devez d&apos;abord renseigner votre nom ou raison sociale dans la configuration.\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <div className=\"flex justify-end gap-3 mt-4\">\r\n                        <Button\r\n                            variant=\"ghost\"\r\n                            onClick={() => setShowProfileAlert(false)}\r\n                            className=\"text-muted-foreground hover:text-foreground\"\r\n                        >\r\n                            Annuler\r\n                        </Button>\r\n\r\n                        <Button\r\n                            onClick={() => router.push('/gestion/config')}\r\n                            className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\r\n                        >\r\n                            Compl√©ter mon profil\r\n                        </Button>\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            {/* BULK IMPORT DIALOG */}\r\n            <BulkImportDialog\r\n                open={bulkImportOpen}\r\n                onOpenChange={setBulkImportOpen}\r\n                ownerId={ownerId}\r\n                onSuccess={() => {\r\n                    setBulkImportOpen(false);\r\n                    router.refresh();\r\n                }}\r\n            />\r\n\r\n            {/* ONBOARDING WIZARD */}\r\n            <TenantOnboardingWizard\r\n                open={showOnboardingWizard}\r\n                onOpenChange={setShowOnboardingWizard}\r\n                leaseData={createdLease}\r\n                profile={profile}\r\n                onComplete={() => {\r\n                    setShowOnboardingWizard(false);\r\n                    // Force full page reload with cache bypass to show updated data\r\n                    // Using location.href instead of reload() to ensure fresh fetch\r\n                    window.location.href = window.location.pathname + '?t=' + Date.now();\r\n                }}\r\n            />\r\n            {/* Upgrade Modal */}\r\n            <UpgradeModal\r\n                open={showUpgradeModal}\r\n                onOpenChange={setShowUpgradeModal}\r\n                propertiesCount={10}\r\n            />\r\n        </>\r\n    );\r\n}\r\n\r\n\r\n// --- ONBOARDING WIZARD COMPONENT ---\r\n\r\nfunction TenantOnboardingWizard({ open, _onOpenChange, leaseData, _profile, onComplete }: any) {\r\n    const [step, setStep] = useState(1);\r\n    const [loading, setLoading] = useState(false);\r\n    const [contractGenerated, setContractGenerated] = useState(false);\r\n\r\n    // State for Step 1 - Par d√©faut les deux sont coch√©s (cas d'usage standard)\r\n    const [stats, setStats] = useState({ rentPaid: true, depositPaid: true });\r\n\r\n    // IMPORTANT: Reset wizard state when dialog opens\r\n    useEffect(() => {\r\n        if (open) {\r\n            console.log(\"[Wizard] Dialog opened - resetting states\");\r\n            setStep(1);\r\n            setContractGenerated(false);\r\n            // Par d√©faut les deux sont coch√©s (caution + premier loyer = cas standard)\r\n            setStats({ rentPaid: true, depositPaid: true });\r\n            setLoading(false);\r\n        }\r\n    }, [open]);\r\n\r\n    if (!leaseData) return null;\r\n\r\n    const totalDeposit = leaseData.amount * leaseData.depositMonths;\r\n    const totalRent = leaseData.amount;\r\n    const grandTotal = totalDeposit + totalRent;\r\n\r\n    // Confirm payments using server action (properly invalidates cache)\r\n    const handleConfirmPayments = async () => {\r\n        // V√©rifier qu'au moins une case est coch√©e\r\n        if (!stats.depositPaid && !stats.rentPaid) {\r\n            toast.error(\"Veuillez cocher au moins un paiement √† valider\");\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        console.log(\"[Wizard] handleConfirmPayments called - depositPaid:\", stats.depositPaid, \"rentPaid:\", stats.rentPaid);\r\n        try {\r\n            // Use the server action confirmPayment with silent=true to skip individual emails\r\n            // (all documents will be sent together in the welcome pack)\r\n            if (stats.depositPaid) {\r\n                console.log(\"[Wizard] Confirming deposit payment for lease:\", leaseData.id);\r\n                const result = await confirmPayment(leaseData.id, undefined, 0, new Date().getFullYear(), true);\r\n                console.log(\"[Wizard] Deposit confirmation result:\", result);\r\n                if (!result.success) {\r\n                    toast.error(`Erreur caution: ${result.error}`);\r\n                }\r\n            }\r\n\r\n            if (stats.rentPaid) {\r\n                const currentMonth = new Date().getMonth() + 1;\r\n                const currentYear = new Date().getFullYear();\r\n                console.log(\"[Wizard] Confirming rent payment for lease:\", leaseData.id, \"month:\", currentMonth, \"year:\", currentYear);\r\n                const result = await confirmPayment(leaseData.id, undefined, currentMonth, currentYear, true);\r\n                console.log(\"[Wizard] Rent confirmation result:\", result);\r\n                if (!result.success) {\r\n                    toast.error(`Erreur loyer: ${result.error}`);\r\n                }\r\n            }\r\n\r\n            // Forcer l'invalidation du cache via l'API pour s'assurer que les donn√©es sont fra√Æches\r\n            try {\r\n                await fetch('/api/clear-cache', { method: 'DELETE' });\r\n                console.log(\"[Wizard] Cache cleared via API\");\r\n            } catch (cacheErr) {\r\n                console.warn(\"[Wizard] Cache clear failed (non-blocking):\", cacheErr);\r\n            }\r\n\r\n            console.log(\"[Wizard] Moving to step 2\");\r\n            setStep(2);\r\n        } catch (e) {\r\n            console.error(\"[Wizard] Error in handleConfirmPayments:\", e);\r\n            toast.error(\"Erreur lors de l'encaissement\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // Generate contract and then send pack\r\n    const handleGenerateAndSendPack = async () => {\r\n        setLoading(true);\r\n        console.log(\"[Wizard] handleGenerateAndSendPack called - contractGenerated:\", contractGenerated);\r\n        try {\r\n            // Step 1: Generate contract if not done\r\n            if (!contractGenerated) {\r\n                console.log(\"[Wizard] Generating contract for lease:\", leaseData.id);\r\n                toast.loading(\"G√©n√©ration du contrat...\", { id: 'contract' });\r\n                const contractResult = await generateLeaseContract({ leaseId: leaseData.id });\r\n                console.log(\"[Wizard] Contract generation result:\", contractResult);\r\n                if (contractResult.success) {\r\n                    setContractGenerated(true);\r\n                    toast.success(\"Contrat g√©n√©r√© !\", { id: 'contract' });\r\n                    // Small delay to ensure DB is updated before sendWelcomePack fetches the lease\r\n                    console.log(\"[Wizard] Waiting 500ms for DB to update...\");\r\n                    await new Promise(resolve => setTimeout(resolve, 500));\r\n                } else {\r\n                    console.error(\"[Wizard] Contract generation failed:\", contractResult.error);\r\n                    toast.error(contractResult.error || \"Erreur g√©n√©ration contrat\", { id: 'contract' });\r\n                    // Continue anyway - pack can be sent without contract\r\n                }\r\n            }\r\n\r\n            // Step 2: Send welcome pack (with contract attached if available)\r\n            console.log(\"[Wizard] Sending welcome pack for lease:\", leaseData.id);\r\n            toast.loading(\"Envoi du pack de bienvenue...\", { id: 'pack' });\r\n            const packResult = await sendWelcomePack(leaseData.id);\r\n            console.log(\"[Wizard] Welcome pack result:\", packResult);\r\n            toast.success(\"Pack de bienvenue envoy√© ! üéâ\", { id: 'pack' });\r\n            onComplete();\r\n        } catch (e) {\r\n            console.error(\"[Wizard] Error in handleGenerateAndSendPack:\", e);\r\n            toast.error(\"Erreur lors de l'envoi\", { id: 'pack' });\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={(val) => !val && onComplete()}>\r\n            <DialogContent className=\"sm:max-w-xl bg-card border-border text-foreground p-0 overflow-hidden mb-safe shadow-2xl\">\r\n                <DialogTitle className=\"sr-only\">Assistant de D√©marrage Locataire</DialogTitle>\r\n                <DialogDescription className=\"sr-only\">\r\n                    Finalisez l&apos;entr√©e de votre nouveau locataire en confirmant les paiements et en envoyant le pack de bienvenue.\r\n                </DialogDescription>\r\n                <div className=\"bg-primary p-6 text-primary-foreground\">\r\n                    <h2 className=\"text-xl font-bold flex items-center gap-2\">\r\n                        <ShieldCheck className=\"w-6 h-6\" />\r\n                        Assistant de D√©marrage\r\n                    </h2>\r\n                    <p className=\"opacity-90 text-sm mt-1\">Finalisons l&apos;entr√©e de votre locataire {leaseData.name}</p>\r\n                </div>\r\n\r\n                <div className=\"p-6\">\r\n                    {step === 1 && (\r\n                        <div className=\"space-y-6\">\r\n                            <div className=\"bg-muted/50 p-4 rounded-lg flex items-center justify-between border border-border\">\r\n                                <div>\r\n                                    <p className=\"text-muted-foreground text-sm uppercase tracking-wider font-semibold\">Total √† encaisser</p>\r\n                                    <p className=\"text-3xl font-bold text-primary\">{grandTotal.toLocaleString()} FCFA</p>\r\n                                </div>\r\n                                <Wallet className=\"w-10 h-10 text-muted-foreground/30\" />\r\n                            </div>\r\n                            <div className=\"space-y-3\">\r\n                                <label className={`flex items-center gap-4 p-4 rounded-xl border-2 transition-all cursor-pointer ${stats.depositPaid ? 'border-primary bg-primary/10' : 'border-border hover:border-accent'}`}>\r\n                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${stats.depositPaid ? 'border-primary bg-primary' : 'border-muted-foreground/50'}`}>\r\n                                        {stats.depositPaid && <Check className=\"w-4 h-4 text-primary-foreground\" />}\r\n                                    </div>\r\n                                    <input type=\"checkbox\" className=\"hidden\" checked={stats.depositPaid} onChange={(e) => setStats({ ...stats, depositPaid: e.target.checked })} />\r\n                                    <div className=\"flex-1\">\r\n                                        <div className=\"font-semibold text-foreground\">Caution ({leaseData.depositMonths} mois)</div>\r\n                                        <div className=\"text-sm text-muted-foreground\">Garantie locative</div>\r\n                                    </div>\r\n                                    <div className=\"font-mono font-bold text-lg\">{totalDeposit.toLocaleString()}</div>\r\n                                </label>\r\n\r\n                                <label className={`flex items-center gap-4 p-4 rounded-xl border-2 transition-all cursor-pointer ${stats.rentPaid ? 'border-primary bg-primary/10' : 'border-border hover:border-accent'}`}>\r\n                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${stats.rentPaid ? 'border-primary bg-primary' : 'border-muted-foreground/50'}`}>\r\n                                        {stats.rentPaid && <Check className=\"w-4 h-4 text-primary-foreground\" />}\r\n                                    </div>\r\n                                    <input type=\"checkbox\" className=\"hidden\" checked={stats.rentPaid} onChange={(e) => setStats({ ...stats, rentPaid: e.target.checked })} />\r\n                                    <div className=\"flex-1\">\r\n                                        <div className=\"font-semibold text-foreground\">Premier Loyer</div>\r\n                                        <div className=\"text-sm text-muted-foreground\">Mois en cours</div>\r\n                                    </div>\r\n                                    <div className=\"font-mono font-bold text-lg\">{totalRent.toLocaleString()}</div>\r\n                                </label>\r\n                            </div>\r\n\r\n                            <div className=\"space-y-3 pt-2\">\r\n                                <Button onClick={handleConfirmPayments} disabled={loading} className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 font-bold h-12 text-lg shadow-md\">\r\n                                    {loading ? <Loader2 className=\"animate-spin\" /> : \"Valider les Encaissements\"}\r\n                                </Button>\r\n                                <Button\r\n                                    variant=\"ghost\"\r\n                                    onClick={onComplete}\r\n                                    disabled={loading}\r\n                                    className=\"w-full text-muted-foreground hover:text-foreground hover:bg-muted\"\r\n                                >\r\n                                    Passer (encaisser plus tard)\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {step === 2 && (\r\n                        <div className=\"space-y-6 text-center py-4\">\r\n                            <div className=\"w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6\">\r\n                                <Check className=\"w-10 h-10\" />\r\n                            </div>\r\n\r\n                            <h3 className=\"text-2xl font-bold text-foreground\">Paiements enregistr√©s !</h3>\r\n                            <p className=\"text-muted-foreground text-lg\">Un seul email sera envoy√© avec tous les documents.</p>\r\n\r\n                            <div className=\"bg-muted p-6 rounded-xl text-left space-y-4 border border-border\">\r\n                                <h4 className=\"font-semibold text-foreground border-b border-border pb-2 mb-2\">Le Pack de Bienvenue inclura :</h4>\r\n                                <div className=\"flex items-center gap-3 text-muted-foreground\">\r\n                                    <FileText className=\"w-5 h-5 text-primary\" /> Contrat de Bail (PDF)\r\n                                </div>\r\n                                <div className=\"flex items-center gap-3 text-muted-foreground\">\r\n                                    <Mail className=\"w-5 h-5 text-primary\" /> Lien d&apos;acc√®s √† l&apos;Espace Locataire\r\n                                </div>\r\n                                <div className=\"flex items-center gap-3 text-muted-foreground\">\r\n                                    <FileText className=\"w-5 h-5 text-primary\" /> R√©capitulatif du bail et des paiements\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"pt-2 space-y-3\">\r\n                                <Button onClick={handleGenerateAndSendPack} disabled={loading} className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 font-bold h-12 text-lg shadow-md\">\r\n                                    {loading ? <Loader2 className=\"animate-spin\" /> : \"G√©n√©rer & Envoyer le Pack üöÄ\"}\r\n                                </Button>\r\n                                <Button variant=\"ghost\" onClick={onComplete} className=\"w-full text-muted-foreground hover:text-foreground\">\r\n                                    Passer (envoyer manuellement plus tard)\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n\r\n// --- BULK IMPORT DIALOG COMPONENT ---\r\n\r\ninterface BulkImportDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    ownerId: string;\r\n    onSuccess: () => void;\r\n}\r\n\r\ninterface ParsedTenant {\r\n    nom: string;\r\n    email: string;\r\n    telephone?: string;\r\n    adresse: string;\r\n    loyer: number;\r\n    jour_paiement?: number;\r\n    date_debut: string;\r\n    date_fin?: string;\r\n    mois_caution?: number;\r\n    error?: string;\r\n    // Auto-matching\r\n    property_name?: string;\r\n    matched_property_id?: string;\r\n    matched_property_title?: string;\r\n    // Auto-cr√©ation de bien\r\n    will_create_property?: boolean; // true = bien sera cr√©√© automatiquement\r\n}\r\n\r\nfunction BulkImportDialog({ open, onOpenChange, ownerId, onSuccess }: BulkImportDialogProps) {\r\n    const [isDragging, setIsDragging] = useState(false);\r\n    const [step, setStep] = useState<1 | 2 | 3>(1); // 1=Upload, 2=Mapping, 3=Review\r\n    const [rawData, setRawData] = useState<Record<string, any>[]>([]);\r\n    const [csvColumns, setCsvColumns] = useState<string[]>([]);\r\n    const [columnMappings, setColumnMappings] = useState<Record<string, string>>({});\r\n    const [parsedData, setParsedData] = useState<ParsedTenant[]>([]);\r\n    const [fileName, setFileName] = useState<string>('');\r\n    const [loading, setLoading] = useState(false);\r\n    const [importProgress, setImportProgress] = useState(0);\r\n    const [errors, setErrors] = useState<string[]>([]);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    // Auto-matching: tous les biens de l'√©quipe\r\n    const [teamProperties, setTeamProperties] = useState<VacantProperty[]>([]);\r\n    const [orphanCount, setOrphanCount] = useState(0);\r\n\r\n    // System fields that can be mapped\r\n    const SYSTEM_FIELDS = [\r\n        { key: 'nom', label: 'Locataire (Nom)', required: true },\r\n        { key: 'email', label: 'Email', required: true },\r\n        { key: 'property_name', label: 'Nom du Bien (auto-matching)', required: false, hint: 'Si trouv√© ‚Üí li√© automatiquement' },\r\n        { key: 'adresse', label: 'Adresse (fallback)', required: false, hint: 'Utilis√© si bien non trouv√©' },\r\n        { key: 'loyer', label: 'Loyer (Montant)', required: true },\r\n        { key: 'telephone', label: 'T√©l√©phone', required: false },\r\n        { key: 'date_debut', label: 'Date de d√©but', required: false },\r\n        { key: 'date_fin', label: 'Date de fin', required: false },\r\n        { key: 'jour_paiement', label: 'Jour de paiement', required: false },\r\n        { key: 'mois_caution', label: 'Mois de caution', required: false },\r\n    ];\r\n\r\n    // Reset state when dialog closes, load properties when opens\r\n    useEffect(() => {\r\n        if (!open) {\r\n            setStep(1);\r\n            setRawData([]);\r\n            setCsvColumns([]);\r\n            setColumnMappings({});\r\n            setParsedData([]);\r\n            setFileName('');\r\n            setErrors([]);\r\n            setImportProgress(0);\r\n            setOrphanCount(0);\r\n        } else {\r\n            // Charger tous les biens de l'√©quipe pour l'auto-matching\r\n            getAllTeamProperties().then((result) => {\r\n                if (result.success && result.data) {\r\n                    setTeamProperties(result.data);\r\n                }\r\n            });\r\n        }\r\n    }, [open]);\r\n\r\n    // Step 1: Parse CSV and extract columns\r\n    const parseFile = async (file: File) => {\r\n        setErrors([]);\r\n        setFileName(file.name);\r\n\r\n        try {\r\n            const buffer = await file.arrayBuffer();\r\n            const workbook = XLSX.read(buffer, { type: 'array' });\r\n            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];\r\n            const jsonData = XLSX.utils.sheet_to_json<Record<string, any>>(firstSheet);\r\n\r\n            if (jsonData.length === 0) {\r\n                setErrors(['Le fichier est vide ou ne contient pas de donn√©es valides.']);\r\n                return;\r\n            }\r\n\r\n            // Extract column names from first row\r\n            const columns = Object.keys(jsonData[0]);\r\n            setCsvColumns(columns);\r\n            setRawData(jsonData);\r\n\r\n            // Auto-suggest mappings based on column names\r\n            const autoMappings: Record<string, string> = {};\r\n            const normalize = (s: string) => s.toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\").trim();\r\n\r\n            columns.forEach(col => {\r\n                const normCol = normalize(col);\r\n                // Check for matches\r\n                if (['locataire', 'nom', 'name', 'tenant'].some(k => normCol.includes(k))) {\r\n                    autoMappings[col] = 'nom';\r\n                } else if (['email', 'mail', 'courriel'].some(k => normCol.includes(k))) {\r\n                    autoMappings[col] = 'email';\r\n                } else if (['bien', 'adresse', 'address', 'logement', 'appartement'].some(k => normCol.includes(k))) {\r\n                    autoMappings[col] = 'adresse';\r\n                } else if (['loyer', 'montant', 'rent', 'prix', 'amount', 'fcfa'].some(k => normCol.includes(k))) {\r\n                    autoMappings[col] = 'loyer';\r\n                } else if (['telephone', 'phone', 'tel', 'mobile'].some(k => normCol.includes(k))) {\r\n                    autoMappings[col] = 'telephone';\r\n                } else if (['date_debut', 'debut', 'start'].some(k => normCol.includes(k))) {\r\n                    autoMappings[col] = 'date_debut';\r\n                } else if (['date_fin', 'fin', 'end'].some(k => normCol.includes(k))) {\r\n                    autoMappings[col] = 'date_fin';\r\n                }\r\n            });\r\n\r\n            setColumnMappings(autoMappings);\r\n            setStep(2); // Go to mapping step\r\n        } catch (err) {\r\n            console.error('Error parsing file:', err);\r\n            setErrors(['Erreur lors de la lecture du fichier. V√©rifiez le format.']);\r\n        }\r\n    };\r\n\r\n    // Step 2: Apply mappings and validate with AUTO-MATCHING\r\n    const applyMappings = () => {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        let orphans = 0;\r\n\r\n        const mapped: ParsedTenant[] = rawData.map((row, index) => {\r\n            // Find which CSV column maps to which system field\r\n            const getValue = (systemField: string): any => {\r\n                const csvCol = Object.entries(columnMappings).find(([, v]) => v === systemField)?.[0];\r\n                return csvCol ? row[csvCol] : undefined;\r\n            };\r\n\r\n            // Format date helper\r\n            const formatDate = (value: any): string => {\r\n                if (!value) return '';\r\n                const strVal = String(value).trim();\r\n\r\n                // DD/MM/YYYY\r\n                const dmyMatch = strVal.match(/^(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{4})$/);\r\n                if (dmyMatch) {\r\n                    return `${dmyMatch[3]}-${dmyMatch[2].padStart(2, '0')}-${dmyMatch[1].padStart(2, '0')}`;\r\n                }\r\n                // YYYY-MM-DD\r\n                if (/^\\d{4}-\\d{2}-\\d{2}$/.test(strVal)) return strVal;\r\n                // French months\r\n                const months: Record<string, string> = {\r\n                    'janvier': '01', 'jan': '01', 'f√©vrier': '02', 'fevrier': '02', 'mars': '03',\r\n                    'avril': '04', 'mai': '05', 'juin': '06', 'juillet': '07', 'juil': '07',\r\n                    'ao√ªt': '08', 'aout': '08', 'septembre': '09', 'sept': '09', 'octobre': '10',\r\n                    'novembre': '11', 'd√©cembre': '12', 'decembre': '12'\r\n                };\r\n                const lowerVal = strVal.toLowerCase();\r\n                for (const [monthName, monthNum] of Object.entries(months)) {\r\n                    if (lowerVal.includes(monthName)) {\r\n                        const yearMatch = lowerVal.match(/\\d{4}/);\r\n                        if (yearMatch) return `${yearMatch[0]}-${monthNum}-01`;\r\n                    }\r\n                }\r\n                return '';\r\n            };\r\n\r\n            const nom = String(getValue('nom') || '').trim();\r\n            const email = String(getValue('email') || '').trim();\r\n            const propertyName = String(getValue('property_name') || '').trim();\r\n            const adresse = String(getValue('adresse') || '').trim();\r\n            const loyerRaw = getValue('loyer');\r\n            const loyer = Number(String(loyerRaw || 0).replace(/[^0-9.]/g, ''));\r\n\r\n            // üîç AUTO-MATCHING : Chercher le bien correspondant\r\n            let matchedPropertyId: string | undefined;\r\n            let matchedPropertyTitle: string | undefined;\r\n            let willCreateProperty = false;\r\n\r\n            if (propertyName && teamProperties.length > 0) {\r\n                const matched = fuzzyMatchProperty(propertyName, teamProperties);\r\n                if (matched) {\r\n                    matchedPropertyId = matched.id;\r\n                    matchedPropertyTitle = matched.title;\r\n                }\r\n            }\r\n\r\n            // Si pas de match par nom, essayer avec l'adresse\r\n            if (!matchedPropertyId && adresse && teamProperties.length > 0) {\r\n                const matchedByAddress = fuzzyMatchProperty(adresse, teamProperties);\r\n                if (matchedByAddress) {\r\n                    matchedPropertyId = matchedByAddress.id;\r\n                    matchedPropertyTitle = matchedByAddress.title;\r\n                }\r\n            }\r\n\r\n            // üè† AUTO-CR√âATION : Si pas de match mais nom de bien OU adresse fourni ‚Üí on le cr√©era\r\n            if (!matchedPropertyId && (propertyName || adresse)) {\r\n                willCreateProperty = true;\r\n                // Utiliser le nom du bien ou l'adresse comme titre du futur bien\r\n                matchedPropertyTitle = propertyName || adresse;\r\n            }\r\n\r\n            // Compter les orphelins (vraiment sans bien : rien √† cr√©er)\r\n            if (!matchedPropertyId && !willCreateProperty) {\r\n                orphans++;\r\n            }\r\n\r\n            // Collect custom fields (unmapped columns)\r\n            const customData: Record<string, any> = {};\r\n            csvColumns.forEach(col => {\r\n                const mapping = columnMappings[col];\r\n                if (mapping === 'custom' || (!mapping && row[col] !== undefined && row[col] !== '')) {\r\n                    customData[col] = row[col];\r\n                }\r\n            });\r\n\r\n            const tenant: ParsedTenant & { custom_data?: Record<string, any> } = {\r\n                nom,\r\n                email,\r\n                telephone: String(getValue('telephone') || '').trim() || undefined,\r\n                adresse: adresse || propertyName, // Fallback: utiliser property_name comme adresse\r\n                loyer,\r\n                jour_paiement: Number(getValue('jour_paiement')) || 5,\r\n                date_debut: formatDate(getValue('date_debut')) || today,\r\n                date_fin: formatDate(getValue('date_fin')),\r\n                mois_caution: Number(getValue('mois_caution')) || 2,\r\n                // Auto-matching results\r\n                property_name: propertyName,\r\n                matched_property_id: matchedPropertyId,\r\n                matched_property_title: matchedPropertyTitle,\r\n                // Auto-cr√©ation\r\n                will_create_property: willCreateProperty,\r\n            };\r\n\r\n            // Only add custom_data if there's something\r\n            if (Object.keys(customData).length > 0) {\r\n                (tenant as any).custom_data = customData;\r\n            }\r\n\r\n            // Validate - adresse non requise si bien match√© ou sera cr√©√©\r\n            const missingFields: string[] = [];\r\n            if (!nom) missingFields.push('Locataire');\r\n            if (!email) missingFields.push('Email');\r\n            if (!matchedPropertyId && !willCreateProperty && !adresse) missingFields.push('Bien ou Adresse');\r\n            if (!loyer || loyer <= 0) missingFields.push('Loyer');\r\n\r\n            if (missingFields.length > 0) {\r\n                tenant.error = `Ligne ${index + 2}: champs manquants (${missingFields.join(', ')})`;\r\n            }\r\n\r\n            return tenant;\r\n        });\r\n\r\n        setOrphanCount(orphans);\r\n        setParsedData(mapped);\r\n        setStep(3);\r\n    };\r\n\r\n    const handleDrop = (e: React.DragEvent) => {\r\n        e.preventDefault();\r\n        setIsDragging(false);\r\n        const file = e.dataTransfer.files[0];\r\n        if (file) {\r\n            const ext = file.name.split('.').pop()?.toLowerCase();\r\n            if (['csv', 'xlsx', 'xls'].includes(ext || '')) {\r\n                parseFile(file);\r\n            } else {\r\n                setErrors(['Format non support√©. Utilisez CSV, XLSX ou XLS.']);\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (file) parseFile(file);\r\n    };\r\n\r\n    const handleImport = async () => {\r\n        const validData = parsedData.filter(t => !t.error);\r\n        if (validData.length === 0) {\r\n            toast.error('Aucune donn√©e valide √† importer');\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        setImportProgress(0);\r\n        let successCount = 0;\r\n        let linkedCount = 0;\r\n        let createdCount = 0; // Biens cr√©√©s automatiquement\r\n        let orphanImportCount = 0;\r\n        const importErrors: string[] = [];\r\n\r\n        for (let i = 0; i < validData.length; i++) {\r\n            const tenant = validData[i] as ParsedTenant & { custom_data?: Record<string, any> };\r\n            try {\r\n                // üè† Si will_create_property ‚Üí on cr√©e le bien on-the-fly\r\n                const shouldCreateProperty = tenant.will_create_property && (tenant.property_name || tenant.adresse);\r\n\r\n                const result = await createNewLease({\r\n                    owner_id: ownerId,\r\n                    tenant_name: tenant.nom,\r\n                    tenant_phone: tenant.telephone || '',\r\n                    tenant_email: tenant.email,\r\n                    // Si bien existant match√© ‚Üí vide, sinon adresse\r\n                    property_address: tenant.matched_property_id ? '' : (shouldCreateProperty ? '' : tenant.adresse),\r\n                    property_id: tenant.matched_property_id || undefined,\r\n                    monthly_amount: tenant.loyer,\r\n                    billing_day: tenant.jour_paiement || 5,\r\n                    start_date: tenant.date_debut,\r\n                    end_date: tenant.date_fin || null,\r\n                    status: 'active' as const,\r\n                    deposit_months: tenant.mois_caution || 2,\r\n                    custom_data: tenant.custom_data || {},\r\n                    // üÜï Auto-cr√©ation de bien\r\n                    ...(shouldCreateProperty && {\r\n                        create_new_property: true,\r\n                        new_property_title: tenant.property_name || tenant.adresse, // Nom ou adresse comme titre\r\n                        new_property_address: tenant.adresse || tenant.property_name,\r\n                        new_property_price: tenant.loyer,\r\n                    }),\r\n                });\r\n\r\n                if (result.success) {\r\n                    successCount++;\r\n                    if (tenant.matched_property_id) {\r\n                        linkedCount++;\r\n                    } else if (shouldCreateProperty) {\r\n                        createdCount++;\r\n                    } else {\r\n                        orphanImportCount++;\r\n                    }\r\n                } else {\r\n                    importErrors.push(`${tenant.nom}: ${result.error}`);\r\n                }\r\n            } catch (_err) {\r\n                importErrors.push(`${tenant.nom}: Erreur inattendue`);\r\n            }\r\n\r\n            setImportProgress(Math.round(((i + 1) / validData.length) * 100));\r\n        }\r\n\r\n        setLoading(false);\r\n\r\n        if (successCount > 0) {\r\n            const linkedMsg = linkedCount > 0 ? `${linkedCount} li√©s` : '';\r\n            const createdMsg = createdCount > 0 ? `${createdCount} biens cr√©√©s` : '';\r\n            const orphanMsg = orphanImportCount > 0 ? `${orphanImportCount} √† lier` : '';\r\n            const details = [linkedMsg, createdMsg, orphanMsg].filter(Boolean).join(' ‚Ä¢ ');\r\n            toast.success(`${successCount} locataire(s) import√©(s)${details ? ` (${details})` : ''}`);\r\n        }\r\n        if (importErrors.length > 0) {\r\n            setErrors(importErrors);\r\n        } else {\r\n            onSuccess();\r\n        }\r\n    };\r\n\r\n    const validCount = parsedData.filter(t => !t.error).length;\r\n    const errorCount = parsedData.filter(t => t.error).length;\r\n\r\n    // Check if required fields are mapped\r\n    const requiredFields = SYSTEM_FIELDS.filter(f => f.required).map(f => f.key);\r\n    const mappedFields = Object.values(columnMappings);\r\n    const missingRequired = requiredFields.filter(f => !mappedFields.includes(f));\r\n    const canProceed = missingRequired.length === 0;\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"z-[100] sm:max-w-2xl bg-card border-border text-foreground max-h-[90vh] overflow-y-auto shadow-2xl\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"text-foreground\">\r\n                        <FileSpreadsheet className=\"w-5 h-5 inline-block mr-2\" />\r\n                        Importer des locataires en masse\r\n                    </DialogTitle>\r\n                    <DialogDescription className=\"text-muted-foreground\">\r\n                        {step === 1 && \"√âtape 1/3 : S√©lectionnez votre fichier CSV ou Excel\"}\r\n                        {step === 2 && \"√âtape 2/3 : Faites correspondre vos colonnes aux champs syst√®me\"}\r\n                        {step === 3 && \"√âtape 3/3 : V√©rifiez et importez\"}\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                {/* Step 1: Upload */}\r\n                {step === 1 && (\r\n                    <div\r\n                        onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}\r\n                        onDragLeave={() => setIsDragging(false)}\r\n                        onDrop={handleDrop}\r\n                        onClick={() => fileInputRef.current?.click()}\r\n                        className={`border-2 border-dashed rounded-xl p-10 text-center cursor-pointer transition-all ${isDragging\r\n                            ? 'border-primary bg-primary/10'\r\n                            : 'border-border hover:border-accent bg-muted/20'\r\n                            }`}\r\n                    >\r\n                        <Upload className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\r\n                        <p className=\"text-lg font-medium text-foreground\">\r\n                            Glissez votre fichier ici\r\n                        </p>\r\n                        <p className=\"text-sm mt-1 text-muted-foreground\">\r\n                            ou cliquez pour s√©lectionner\r\n                        </p>\r\n                        <p className=\"text-xs mt-3 text-muted-foreground\">\r\n                            Formats accept√©s : CSV, XLSX, XLS\r\n                        </p>\r\n                        <input\r\n                            ref={fileInputRef}\r\n                            type=\"file\"\r\n                            accept=\".csv,.xlsx,.xls\"\r\n                            onChange={handleFileSelect}\r\n                            className=\"hidden\"\r\n                        />\r\n                    </div>\r\n                )}\r\n\r\n                {/* Step 2: Column Mapping */}\r\n                {step === 2 && (\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <FileSpreadsheet className=\"w-5 h-5 text-primary\" />\r\n                                <span className=\"font-medium\">{fileName}</span>\r\n                                <span className=\"text-sm text-muted-foreground\">\r\n                                    ({rawData.length} lignes)\r\n                                </span>\r\n                            </div>\r\n                            <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => setStep(1)}\r\n                                className=\"text-muted-foreground hover:text-foreground\"\r\n                            >\r\n                                <X className=\"w-4 h-4\" />\r\n                            </Button>\r\n                        </div>\r\n\r\n                        <div className=\"p-4 rounded-lg border bg-muted/50 border-border\">\r\n                            <p className=\"text-sm font-medium mb-3 text-foreground\">\r\n                                Faites correspondre vos colonnes :\r\n                            </p>\r\n                            <div className=\"space-y-2 max-h-[300px] overflow-y-auto\">\r\n                                {csvColumns.map((col) => (\r\n                                    <div key={col} className=\"flex items-center gap-3\">\r\n                                        <div className=\"flex-1 px-3 py-2 rounded text-sm font-mono truncate bg-card border border-border\">\r\n                                            {col}\r\n                                        </div>\r\n                                        <span className=\"text-muted-foreground\">‚Üí</span>\r\n                                        <select\r\n                                            value={columnMappings[col] || ''}\r\n                                            onChange={(e) => setColumnMappings({ ...columnMappings, [col]: e.target.value })}\r\n                                            className=\"flex-1 px-3 py-2 rounded text-sm bg-card text-foreground border-border\"\r\n                                        >\r\n                                            <option value=\"\">-- Ignorer --</option>\r\n                                            {SYSTEM_FIELDS.map(f => (\r\n                                                <option key={f.key} value={f.key}>\r\n                                                    {f.label} {f.required ? '*' : ''}\r\n                                                </option>\r\n                                            ))}\r\n                                            <option value=\"custom\">üì¶ Champ personnalis√©</option>\r\n                                        </select>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Missing required fields warning */}\r\n                        {missingRequired.length > 0 && (\r\n                            <div className=\"p-3 rounded-lg bg-destructive/10 border border-destructive/30\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <AlertCircle className=\"w-4 h-4 text-destructive\" />\r\n                                    <span className=\"text-sm text-destructive\">\r\n                                        Champs obligatoires non mapp√©s : {missingRequired.map(f => SYSTEM_FIELDS.find(sf => sf.key === f)?.label).join(', ')}\r\n                                    </span>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"flex justify-between pt-2\">\r\n                            <Button variant=\"ghost\" onClick={() => setStep(1)}>\r\n                                Retour\r\n                            </Button>\r\n                            <Button\r\n                                onClick={applyMappings}\r\n                                disabled={!canProceed}\r\n                                className=\"bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm\"\r\n                            >\r\n                                Valider le mapping\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Step 3: Review & Import */}\r\n                {step === 3 && (\r\n                    <div className=\"space-y-4\">\r\n                        {/* Stats avec auto-matching et auto-cr√©ation */}\r\n                        <div className=\"grid grid-cols-4 gap-2\">\r\n                            <div className=\"p-3 rounded-lg bg-muted/50 border border-border\">\r\n                                <p className=\"text-2xl font-bold text-foreground\">{validCount}</p>\r\n                                <p className=\"text-xs text-muted-foreground\">Valides</p>\r\n                            </div>\r\n                            <div className=\"p-3 rounded-lg bg-green-500/10 border border-green-500/30\">\r\n                                <p className=\"text-2xl font-bold text-green-600\">\r\n                                    {parsedData.filter(t => !t.error && t.matched_property_id).length}\r\n                                </p>\r\n                                <p className=\"text-xs text-green-700\">Li√©s</p>\r\n                            </div>\r\n                            <div className=\"p-3 rounded-lg bg-primary/10 border border-primary/30\">\r\n                                <p className=\"text-2xl font-bold text-primary\">\r\n                                    {parsedData.filter(t => !t.error && t.will_create_property).length}\r\n                                </p>\r\n                                <p className=\"text-xs text-primary\">√Ä cr√©er</p>\r\n                            </div>\r\n                            <div className=\"p-3 rounded-lg bg-orange-500/10 border border-orange-500/30\">\r\n                                <p className=\"text-2xl font-bold text-orange-600\">{orphanCount}</p>\r\n                                <p className=\"text-xs text-orange-700\">Orphelins</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Info biens √† cr√©er */}\r\n                        {parsedData.filter(t => !t.error && t.will_create_property).length > 0 && (\r\n                            <div className=\"p-3 rounded-lg bg-primary/10 border border-primary/30\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <Plus className=\"w-4 h-4 text-primary\" />\r\n                                    <span className=\"text-sm text-primary\">\r\n                                        {parsedData.filter(t => !t.error && t.will_create_property).length} bien(s) seront cr√©√©s automatiquement et li√©s aux locataires.\r\n                                    </span>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Info orphelins */}\r\n                        {orphanCount > 0 && (\r\n                            <div className=\"p-3 rounded-lg bg-orange-500/10 border border-orange-500/30\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <AlertCircle className=\"w-4 h-4 text-orange-600\" />\r\n                                    <span className=\"text-sm text-orange-700\">\r\n                                        {orphanCount} bail(s) sans bien. Vous pourrez les lier manuellement apr√®s.\r\n                                    </span>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Errors */}\r\n                        {(errors.length > 0 || errorCount > 0) && (\r\n                            <div className=\"p-3 rounded-lg max-h-32 overflow-y-auto bg-destructive/10 border border-destructive/30\">\r\n                                <div className=\"flex items-center gap-2 mb-2\">\r\n                                    <AlertCircle className=\"w-4 h-4 text-destructive\" />\r\n                                    <span className=\"text-sm font-medium text-destructive\">Erreurs d√©tect√©es</span>\r\n                                </div>\r\n                                <ul className=\"text-xs space-y-1 text-destructive\">\r\n                                    {parsedData.filter(t => t.error).slice(0, 10).map((t, i) => (\r\n                                        <li key={i}>‚Ä¢ {t.error}</li>\r\n                                    ))}\r\n                                    {errors.map((e, i) => (\r\n                                        <li key={`err-${i}`}>‚Ä¢ {e}</li>\r\n                                    ))}\r\n                                </ul>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Preview Table avec statut de liaison */}\r\n                        {validCount > 0 && (\r\n                            <div className=\"border rounded-lg overflow-hidden border-border\">\r\n                                <div className=\"px-3 py-2 text-xs font-medium bg-muted text-muted-foreground\">\r\n                                    Aper√ßu ({Math.min(validCount, 5)} sur {validCount})\r\n                                </div>\r\n                                <div className=\"overflow-x-auto\">\r\n                                    <table className=\"w-full text-sm\">\r\n                                        <thead>\r\n                                            <tr className=\"bg-muted/50\">\r\n                                                <th className=\"px-3 py-2 text-left font-medium\">Locataire</th>\r\n                                                <th className=\"px-3 py-2 text-left font-medium\">Bien</th>\r\n                                                <th className=\"px-3 py-2 text-right font-medium\">Loyer</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            {parsedData.filter(t => !t.error).slice(0, 5).map((t, i) => (\r\n                                                <tr key={i} className=\"border-t border-border\">\r\n                                                    <td className=\"px-3 py-2\">\r\n                                                        <div className=\"font-medium text-foreground\">{t.nom}</div>\r\n                                                        <div className=\"text-xs text-muted-foreground\">{t.email}</div>\r\n                                                    </td>\r\n                                                    <td className=\"px-3 py-2\">\r\n                                                        {t.matched_property_id ? (\r\n                                                            // Bien existant trouv√©\r\n                                                            <span className=\"inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-green-500/10 text-green-600 dark:text-green-400 font-medium\">\r\n                                                                <Check className=\"w-3 h-3\" />\r\n                                                                {t.matched_property_title}\r\n                                                            </span>\r\n                                                        ) : t.will_create_property ? (\r\n                                                            // Bien sera cr√©√© automatiquement\r\n                                                            <span className=\"inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-primary/10 text-primary font-medium\">\r\n                                                                <Plus className=\"w-3 h-3\" />\r\n                                                                {t.property_name}\r\n                                                                <span className=\"text-[10px] opacity-70\">(nouveau)</span>\r\n                                                            </span>\r\n                                                        ) : (\r\n                                                            // Orphelin - pas de bien\r\n                                                            <span className=\"text-xs text-orange-600 dark:text-orange-400 font-medium\">\r\n                                                                ‚ö† {t.adresse || 'Sans bien'}\r\n                                                            </span>\r\n                                                        )}\r\n                                                    </td>\r\n                                                    <td className=\"px-3 py-2 text-right font-mono text-foreground\">{t.loyer.toLocaleString()}</td>\r\n                                                </tr>\r\n                                            ))}\r\n                                        </tbody>\r\n                                    </table>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Progress bar */}\r\n                        {loading && (\r\n                            <div className=\"space-y-2\">\r\n                                <div className=\"w-full h-2 rounded-full bg-muted\">\r\n                                    <div\r\n                                        className=\"h-2 rounded-full bg-primary transition-all duration-300\"\r\n                                        style={{ width: `${importProgress}%` }}\r\n                                    />\r\n                                </div>\r\n                                <p className=\"text-xs text-center text-muted-foreground\">\r\n                                    Import en cours... {importProgress}%\r\n                                </p>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Actions */}\r\n                        <div className=\"flex justify-between pt-2\">\r\n                            <Button variant=\"ghost\" onClick={() => setStep(2)} disabled={loading}>\r\n                                Modifier le mapping\r\n                            </Button>\r\n                            <Button\r\n                                onClick={handleImport}\r\n                                disabled={validCount === 0 || loading}\r\n                                className=\"bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm\"\r\n                            >\r\n                                {loading ? (\r\n                                    <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\r\n                                ) : (\r\n                                    <Upload className=\"w-4 h-4 mr-2\" />\r\n                                )}\r\n                                Importer {validCount} locataire{validCount > 1 ? 's' : ''}\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Errors display (for Step 1) */}\r\n                {step === 1 && errors.length > 0 && (\r\n                    <ul className=\"text-sm text-destructive p-3 rounded-lg bg-destructive/10 border border-destructive/20\">\r\n                        {errors.map((e, i) => <li key={i}>‚Ä¢ {e}</li>)}\r\n                    </ul>\r\n                )}\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\ConfigurationRequirementCheck.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\DashboardStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\DashboardTabs.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\DashboardTabs.tsx:39:9\n  37 |     // Reset to overview tab whenever component mounts/remounts\n  38 |     useEffect(() => {\n> 39 |         setActiveTab('overview');\n     |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  40 |     }, []);\n  41 |\n  42 |     // Support for programmatic tab switching (e.g., from the tour)","line":39,"column":9,"nodeType":null,"endLine":39,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1197,1200],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1197,1200],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { ReactNode, useState, useEffect } from 'react';\r\nimport { useTheme } from \"@/components/theme-provider\";\r\nimport { Users, TrendingUp } from 'lucide-react';\r\n\r\ntype TabId = 'overview' | 'performance';\r\n\r\ninterface Tab {\r\n    id: TabId;\r\n    label: string;\r\n    icon: typeof Users;\r\n}\r\n\r\nconst tabs: Tab[] = [\r\n    { id: 'overview', label: 'Vue d\\'ensemble', icon: Users },\r\n    { id: 'performance', label: 'Performance', icon: TrendingUp },\r\n];\r\n\r\ninterface DashboardTabsProps {\r\n    overviewContent: ReactNode;\r\n    performanceContent: ReactNode;\r\n}\r\n\r\nexport function DashboardTabs({\r\n    overviewContent,\r\n    performanceContent,\r\n}: DashboardTabsProps) {\r\n    const [activeTab, setActiveTab] = useState<TabId>('overview');\r\n    const { isDark } = useTheme();\r\n\r\n    const content: Record<TabId, ReactNode> = {\r\n        overview: overviewContent,\r\n        performance: performanceContent,\r\n    };\r\n\r\n    // Reset to overview tab whenever component mounts/remounts\r\n    useEffect(() => {\r\n        setActiveTab('overview');\r\n    }, []);\r\n\r\n    // Support for programmatic tab switching (e.g., from the tour)\r\n    useEffect(() => {\r\n        const handleSwitchTab = (event: any) => {\r\n            const detail = event.detail;\r\n            if (detail && (detail === 'overview' || detail === 'performance')) {\r\n                setActiveTab(detail as TabId);\r\n            }\r\n        };\r\n\r\n        window.addEventListener('dousell-tour-switch-tab', handleSwitchTab);\r\n        return () => window.removeEventListener('dousell-tour-switch-tab', handleSwitchTab);\r\n    }, []);\r\n\r\n    return (\r\n        <div>\r\n            {/* Tab Navigation */}\r\n            <div className={`flex items-center gap-1 p-1 rounded-lg mb-6 w-fit ${isDark ? 'bg-slate-900/80' : 'bg-gray-100'\r\n                }`}>\r\n                {tabs.map((tab) => {\r\n                    const Icon = tab.icon;\r\n                    const isActive = activeTab === tab.id;\r\n\r\n                    return (\r\n                        <button\r\n                            key={tab.id}\r\n                            onClick={() => setActiveTab(tab.id)}\r\n                            className={`\r\n                                flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium\r\n                                transition-all duration-200\r\n                                ${isActive\r\n                                    ? isDark\r\n                                        ? 'bg-slate-800 text-white shadow-sm'\r\n                                        : 'bg-white text-gray-900 shadow-sm'\r\n                                    : isDark\r\n                                        ? 'text-slate-400 hover:text-slate-200'\r\n                                        : 'text-gray-500 hover:text-gray-700'\r\n                                }\r\n                            `}\r\n                        >\r\n                            <Icon className=\"w-3.5 h-3.5\" />\r\n                            <span className=\"hidden sm:inline\">{tab.label}</span>\r\n                        </button>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            {/* Tab Content */}\r\n            <div>{content[activeTab]}</div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\DocumentGeneratorDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1164,1167],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1164,1167],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { FileText, ShieldCheck, CheckCircle, _Search, _Download } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogHeader,\n    DialogTitle,\n    DialogTrigger,\n} from '@/components/ui/dialog';\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { GenerateContractButton } from '@/components/contracts/GenerateContractButton';\nimport { ReceiptModal } from './ReceiptModal';\nimport { _cn } from '@/lib/utils'; // Assumed utility\nimport { ConfigurationRequirementCheck } from './ConfigurationRequirementCheck';\nimport { useTheme } from \"@/components/theme-provider\";\n\ninterface Lease {\n    id: string;\n    tenant_name: string;\n    tenant_email?: string;\n    tenant_phone?: string;\n    property_address: string;\n    monthly_amount: number;\n    lease_pdf_url?: string | null;\n}\n\ninterface DocumentGeneratorDialogProps {\n    leases: Lease[];\n    userEmail?: string;\n    profile?: any;\n    trigger?: React.ReactNode;\n}\n\nexport function DocumentGeneratorDialog({ leases, userEmail, profile, trigger }: DocumentGeneratorDialogProps) {\n    const { isDark } = useTheme();\n    const [isOpen, setIsOpen] = useState(false);\n    const [docType, setDocType] = useState<'receipt' | 'contract'>('receipt');\n\n    // Receipt State\n    const [receiptLeaseId, setReceiptLeaseId] = useState<string>('');\n    const [month, setMonth] = useState<string>(new Date().getMonth() + 1 + '');\n    const [year, setYear] = useState<string>(new Date().getFullYear() + '');\n    const [amount, setAmount] = useState<string>('');\n    const [showPreview, setShowPreview] = useState(false);\n\n    // Contract State\n    const [contractLeaseId, setContractLeaseId] = useState<string>('');\n\n    const selectedReceiptLease = leases.find(l => l.id === receiptLeaseId);\n    const selectedContractLease = leases.find(l => l.id === contractLeaseId);\n\n    const handleReceiptLeaseChange = (leaseId: string) => {\n        const lease = leases.find(l => l.id === leaseId);\n        setReceiptLeaseId(leaseId);\n        if (lease) {\n            setAmount(lease.monthly_amount.toString());\n        }\n    };\n\n    const handleGenerateReceipt = () => {\n        if (!selectedReceiptLease || !amount) return;\n        setShowPreview(true);\n    };\n\n    const periodMonth = parseInt(month).toString().padStart(2, '0');\n\n    // Receipt Data Construction\n    const receiptData = selectedReceiptLease ? {\n        leaseId: receiptLeaseId, // Ajout pour stockage automatique\n        tenant: {\n            tenant_name: selectedReceiptLease.tenant_name,\n            email: selectedReceiptLease.tenant_email,\n            phone: selectedReceiptLease.tenant_phone,\n            address: selectedReceiptLease.property_address\n        },\n        property_address: selectedReceiptLease.property_address,\n        amount: parseInt(amount),\n        month: periodMonth,\n        year: parseInt(year),\n        userEmail: userEmail,\n        profile: profile\n    } : null;\n\n    return (\n        <>\n            <Dialog open={isOpen} onOpenChange={setIsOpen}>\n                <DialogTrigger asChild>\n                    {trigger ? trigger : (\n                        <Button\n                            variant=\"outline\"\n                            className=\"h-9 px-2 sm:px-3 gap-2 bg-background border-border text-foreground hover:bg-accent hover:text-accent-foreground\"\n                        >\n                            <FileText className=\"w-4 h-4\" />\n                            <span className=\"hidden sm:inline\">G√©n√©rer</span>\n                        </Button>\n                    )}\n                </DialogTrigger>\n                <DialogContent className=\"bg-card border-border text-foreground sm:max-w-md shadow-2xl p-0 overflow-hidden\">\n                    <ConfigurationRequirementCheck profile={profile} isDark={isDark}>\n                        <div className=\"p-6\">\n                            <DialogHeader>\n                                <DialogTitle className=\"flex items-center gap-2 text-foreground\">\n                                    {docType === 'receipt' ? (\n                                        <FileText className=\"h-5 w-5 text-primary\" />\n                                    ) : (\n                                        <ShieldCheck className=\"h-5 w-5 text-primary\" />\n                                    )}\n                                    G√©n√©rateur de Documents\n                                </DialogTitle>\n                                <DialogDescription className=\"text-muted-foreground\">\n                                    S√©lectionnez le type de document √† g√©n√©rer.\n                                </DialogDescription>\n                            </DialogHeader>\n\n                            <div className=\"space-y-6 pt-2 pb-4\">\n                                {/* Type Selector */}\n                                <div className=\"w-full\">\n                                    <Tabs value={docType} onValueChange={(v) => setDocType(v as 'receipt' | 'contract')} className=\"w-full\">\n                                        <TabsList className=\"grid w-full grid-cols-2 bg-muted\">\n                                            <TabsTrigger value=\"receipt\" className=\"data-[state=active]:bg-background data-[state=active]:text-foreground\">\n                                                quittance de Loyer\n                                            </TabsTrigger>\n                                            <TabsTrigger value=\"contract\" className=\"data-[state=active]:bg-background data-[state=active]:text-foreground\">\n                                                Contrat de Bail\n                                            </TabsTrigger>\n                                        </TabsList>\n                                    </Tabs>\n                                </div>\n\n                                {/* RECEIPT FORM */}\n                                {docType === 'receipt' && (\n                                    <div className=\"space-y-4 animate-in fade-in slide-in-from-top-2 duration-200\">\n                                        <div className=\"space-y-2\">\n                                            <label className=\"text-sm font-medium text-foreground/80\">Locataire & Bien</label>\n                                            <Select value={receiptLeaseId} onValueChange={handleReceiptLeaseChange}>\n                                                <SelectTrigger className=\"bg-background border-border text-foreground\">\n                                                    <SelectValue placeholder=\"S√©lectionner un bail...\" />\n                                                </SelectTrigger>\n                                                <SelectContent className=\"bg-popover border-border text-foreground max-w-[calc(100vw-2rem)]\">\n                                                    {leases.length === 0 ? (\n                                                        <div className=\"py-6 text-center text-sm text-muted-foreground\">Aucun bail actif</div>\n                                                    ) : (\n                                                        leases.map((lease) => (\n                                                            <SelectItem key={lease.id} value={lease.id}>\n                                                                <div className=\"flex flex-col min-w-0 py-0.5\">\n                                                                    <span className=\"font-medium truncate block\">{lease.tenant_name}</span>\n                                                                    <span className=\"text-[10px] truncate block opacity-70\">\n                                                                        {lease.property_address}\n                                                                    </span>\n                                                                </div>\n                                                            </SelectItem>\n                                                        ))\n                                                    )}\n                                                </SelectContent>\n                                            </Select>\n                                            {selectedReceiptLease && (\n                                                <p className=\"text-xs text-muted-foreground ml-1 truncate\">\n                                                    {selectedReceiptLease.property_address}\n                                                </p>\n                                            )}\n                                        </div>\n\n                                        <div className=\"grid grid-cols-2 gap-4\">\n                                            <div className=\"space-y-2\">\n                                                <label className=\"text-sm font-medium text-foreground/80\">Mois</label>\n                                                <Select value={month} onValueChange={setMonth}>\n                                                    <SelectTrigger className=\"bg-background border-border text-foreground text-sm h-10\">\n                                                        <SelectValue />\n                                                    </SelectTrigger>\n                                                    <SelectContent className=\"bg-popover border-border text-foreground max-h-[200px]\">\n                                                        {Array.from({ length: 12 }, (_, i) => i + 1).map((m) => (\n                                                            <SelectItem key={m} value={m.toString()}>\n                                                                {new Date(0, m - 1).toLocaleString('fr-FR', { month: 'long' })}\n                                                            </SelectItem>\n                                                        ))}\n                                                    </SelectContent>\n                                                </Select>\n                                            </div>\n                                            <div className=\"space-y-2\">\n                                                <label className=\"text-sm font-medium text-foreground/80\">Ann√©e</label>\n                                                <Select value={year} onValueChange={setYear}>\n                                                    <SelectTrigger className=\"bg-background border-border text-foreground text-sm h-10\">\n                                                        <SelectValue />\n                                                    </SelectTrigger>\n                                                    <SelectContent className=\"bg-popover border-border text-foreground\">\n                                                        {[year, (parseInt(year) - 1).toString(), (parseInt(year) + 1).toString()].sort().map((y) => (\n                                                            <SelectItem key={y} value={y}>{y}</SelectItem>\n                                                        ))}\n                                                    </SelectContent>\n                                                </Select>\n                                            </div>\n                                        </div>\n\n                                        <div className=\"space-y-2\">\n                                            <label className=\"text-sm font-medium text-foreground/80\">Montant (FCFA)</label>\n                                            <div className=\"relative\">\n                                                <input\n                                                    type=\"number\"\n                                                    value={amount}\n                                                    onChange={(e) => setAmount(e.target.value)}\n                                                    className=\"w-full bg-background border border-border rounded-md px-3 py-2 text-sm text-foreground focus:ring-2 focus:ring-primary outline-none\"\n                                                />\n                                            </div>\n                                        </div>\n\n                                        <div className=\"pt-2\">\n                                            <Button\n                                                onClick={() => {\n                                                    setIsOpen(false); // Fermer le dialogue principal pour √©viter le chevauchement\n                                                    handleGenerateReceipt();\n                                                }}\n                                                disabled={!selectedReceiptLease || !amount}\n                                                className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 transition-all shadow-md\"\n                                            >\n                                                Pr√©visualiser la Quittance\n                                            </Button>\n                                        </div>\n                                    </div>\n                                )}\n\n                                {/* CONTRACT FORM */}\n                                {docType === 'contract' && (\n                                    <div className=\"space-y-4 animate-in fade-in slide-in-from-top-2 duration-200\">\n                                        <div className=\"space-y-2\">\n                                            <label className=\"text-sm font-medium text-foreground/80\">Locataire & Bien</label>\n                                            <Select value={contractLeaseId} onValueChange={setContractLeaseId}>\n                                                <SelectTrigger className=\"bg-background border-border text-foreground\">\n                                                    <SelectValue placeholder=\"S√©lectionner un bail...\" />\n                                                </SelectTrigger>\n                                                <SelectContent className=\"bg-popover border-border text-foreground\">\n                                                    {leases.length === 0 ? (\n                                                        <div className=\"py-6 text-center text-sm text-muted-foreground\">Aucun bail actif</div>\n                                                    ) : (\n                                                        leases.map((lease) => (\n                                                            <SelectItem key={lease.id} value={lease.id}>\n                                                                <div className=\"flex flex-col min-w-0 py-0.5\">\n                                                                    <span className=\"font-medium truncate block\">{lease.tenant_name}</span>\n                                                                    <span className=\"text-[10px] truncate block opacity-70\">\n                                                                        {lease.property_address}\n                                                                    </span>\n                                                                </div>\n                                                            </SelectItem>\n                                                        ))\n                                                    )}\n                                                </SelectContent>\n                                            </Select>\n                                        </div>\n\n                                        {selectedContractLease && (\n                                            <div className=\"bg-muted/30 rounded-lg p-4 space-y-3 border border-border\">\n                                                <div className=\"flex justify-between items-start\">\n                                                    <div>\n                                                        <h4 className=\"font-medium text-foreground\">{selectedContractLease.tenant_name}</h4>\n                                                        <p className=\"text-xs text-muted-foreground mt-1\">{selectedContractLease.property_address}</p>\n                                                    </div>\n                                                    {selectedContractLease.lease_pdf_url && (\n                                                        <div className=\"px-2 py-1 rounded-full bg-green-500/10 text-green-600 dark:text-green-400 text-[10px] font-medium border border-green-500/20 flex items-center gap-1\">\n                                                            <CheckCircle className=\"h-3 w-3\" />\n                                                            Existe d√©j√†\n                                                        </div>\n                                                    )}\n                                                </div>\n\n                                                <div className=\"pt-2 flex justify-end\">\n                                                    <GenerateContractButton\n                                                        leaseId={selectedContractLease.id}\n                                                        tenantName={selectedContractLease.tenant_name}\n                                                        existingContractUrl={selectedContractLease.lease_pdf_url || undefined}\n                                                        variant=\"default\"\n                                                        className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 font-medium transition-all shadow-md\"\n                                                    />\n                                                </div>\n                                            </div>\n                                        )}\n\n                                        <div className=\"mt-4 p-3 bg-primary/10 border border-primary/20 rounded-lg\">\n                                            <p className=\"text-xs text-primary/80\">\n                                                üí° Le contrat g√©n√©r√© sera conforme aux normes OHADA et au droit s√©n√©galais.\n                                            </p>\n                                        </div>\n                                    </div>\n                                )}\n                            </div>\n                        </div>\n                    </ConfigurationRequirementCheck>\n                </DialogContent>\n            </Dialog>\n\n            {/* Receipt Modal (Outside of main dialog to prevent nesting issues) */}\n            {receiptData && (\n                <ReceiptModal\n                    isOpen={showPreview}\n                    onClose={() => setShowPreview(false)}\n                    data={receiptData}\n                />\n            )}\n        </>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\EditTenantDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\ExpiredBanner.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\ExpiredBanner.tsx:39:7\n  37 |   useEffect(() => {\n  38 |     if (upgradeRequired && isExpired) {\n> 39 |       setShowModal(true);\n     |       ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  40 |     }\n  41 |   }, [upgradeRequired, isExpired]);\n  42 |","line":39,"column":7,"nodeType":null,"endLine":39,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { Warning, ArrowRight, X } from \"@phosphor-icons/react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { UpgradeModal } from \"@/components/gestion/UpgradeModal\";\r\n\r\ninterface ExpiredBannerProps {\r\n  proStatus: string | null;\r\n  propertiesCount?: number;\r\n  leasesCount?: number;\r\n}\r\n\r\n/**\r\n * Banner shown to users with expired subscription\r\n *\r\n * Per WORKFLOW_PROPOSAL.md section 11.1:\r\n * - Shows a persistent banner at the top\r\n * - Can show blocking modal if ?upgrade=required in URL\r\n * - Users can still access data in read-only mode\r\n */\r\nexport function ExpiredBanner({\r\n  proStatus,\r\n  propertiesCount = 0,\r\n  leasesCount = 0,\r\n}: ExpiredBannerProps) {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const [showModal, setShowModal] = useState(false);\r\n  const [dismissed, setDismissed] = useState(false);\r\n\r\n  const isExpired = proStatus === \"past_due\" || proStatus === \"canceled\" || proStatus === \"unpaid\" || proStatus === \"incomplete\";\r\n  const upgradeRequired = searchParams.get(\"upgrade\") === \"required\";\r\n\r\n  // Show modal if ?upgrade=required\r\n  useEffect(() => {\r\n    if (upgradeRequired && isExpired) {\r\n      setShowModal(true);\r\n    }\r\n  }, [upgradeRequired, isExpired]);\r\n\r\n  if (!isExpired || dismissed) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Persistent banner */}\r\n      <div className=\"mb-6 bg-gradient-to-r from-amber-500/10 to-red-500/10 border border-amber-500/30 rounded-xl p-4\">\r\n        <div className=\"flex items-center justify-between gap-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center flex-shrink-0\">\r\n              <Warning size={20} className=\"text-amber-500\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-white font-medium\">\r\n                {proStatus === \"canceled\" ? \"Votre abonnement a √©t√© r√©sili√©\" :\r\n                 proStatus === \"unpaid\" || proStatus === \"incomplete\" ? \"Paiement en attente\" :\r\n                 \"Votre essai a expir√©\"}\r\n              </p>\r\n              <p className=\"text-white/60 text-sm\">\r\n                Acc√®s en lecture seule. R√©activez pour modifier vos donn√©es.\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button\r\n              onClick={() => router.push(\"/gestion/abonnement\")}\r\n              className=\"bg-primary text-primary-foreground hover:bg-primary/90\"\r\n            >\r\n              R√©activer\r\n              <ArrowRight size={16} className=\"ml-1\" />\r\n            </Button>\r\n            <button\r\n              onClick={() => setDismissed(true)}\r\n              className=\"p-2 text-white/40 hover:text-white/60 transition-colors\"\r\n              aria-label=\"Fermer\"\r\n            >\r\n              <X size={18} />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Modal (shown when ?upgrade=required) */}\r\n      <UpgradeModal\r\n        open={showModal}\r\n        onOpenChange={setShowModal}\r\n        blocking={upgradeRequired}\r\n        propertiesCount={propertiesCount}\r\n        leasesCount={leasesCount}\r\n        proStatus={proStatus}\r\n      />\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\GestionLocativeClient.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'expenses?.length', 'leases?.length', 'ownerId', 'profile', and 'transactions?.length'. Either include them or remove the dependency array.","line":178,"column":8,"nodeType":"ArrayExpression","endLine":178,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [expenses?.length, leases?.length, ownerId, profile, transactions?.length]","fix":{"range":[5114,5116],"text":"[expenses?.length, leases?.length, ownerId, profile, transactions?.length]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'expenses'. Either include it or remove the dependency array.","line":268,"column":8,"nodeType":"ArrayExpression","endLine":268,"endColumn":66,"suggestions":[{"desc":"Update the dependencies array to be: [selectedYear, selectedMonth, leases, currentTransactions, expenses]","fix":{"range":[8860,8918],"text":"[selectedYear, selectedMonth, leases, currentTransactions, expenses]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useMemo, useEffect } from 'react';\nimport { useRouter, useSearchParams, usePathname } from 'next/navigation';\nimport { TenantTable } from './TenantTable';\nimport { MonthSelector } from './MonthSelector';\nimport { EditTenantDialog } from './EditTenantDialog';\n\nimport { DashboardStats } from './DashboardStats';\nimport { QuickActions } from './QuickActions';\nimport { TenantCardGrid } from './TenantCardGrid';\nimport { _Search, Download, LayoutGrid, List } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { deleteTransaction, deleteLease, confirmPayment, terminateLease, reactivateLease, sendTenantInvitation } from '../actions';\nimport { processLateReminders } from '@/app/(vitrine)/actions/reminders';\nimport { ReceiptModal } from './ReceiptModal';\nimport { toast } from 'sonner';\n\nimport { calculateFinancials, LeaseInput, TransactionInput } from '@/lib/finance';\nimport { _saveAs } from 'file-saver';\n\ninterface Tenant {\n    id: string;\n    name: string;\n    property: string;\n    phone?: string;\n    email?: string;\n    rentAmount: number;\n    status: 'paid' | 'pending' | 'overdue';\n    dueDate?: number;\n    startDate?: string;\n    endDate?: string;\n    last_transaction_id?: string;\n    period_month?: number;\n    period_year?: number;\n    period_start?: string | null;\n    period_end?: string | null;\n}\n\ninterface Transaction {\n    id: string;\n    lease_id: string;\n    period_month: number;\n    period_year: number;\n    status: string;\n    amount_due?: number;\n    amount_paid?: number | null;\n    paid_at?: string | null;\n    period_start?: string | null;\n    period_end?: string | null;\n}\n\ninterface Expense {\n    id: string;\n    amount: number;\n    expense_date: string;\n    description?: string | null;\n    category?: string | null;\n    lease_id?: string | null;\n}\n\ninterface Lease {\n    id: string;\n    tenant_name: string;\n    tenant_phone?: string;\n    tenant_email?: string;\n    property_address?: string;\n    monthly_amount: number;\n    billing_day?: number;\n    start_date?: string;\n    end_date?: string;\n    status?: 'active' | 'terminated' | 'pending';\n    created_at?: string;\n    property_id?: string;\n    properties?: {\n        id: string;\n        title: string;\n        images?: string[];\n    } | null;\n}\n\ninterface Profile {\n    company_name?: string | null;\n    full_name?: string | null;\n    company_address?: string | null;\n    company_email?: string | null;\n    company_ninea?: string | null;\n    signature_url?: string | null;\n    logo_url?: string | null;\n}\n\ninterface ReceiptData {\n    tenant?: {\n        tenant_name?: string;\n        name?: string;\n        email?: string;\n        phone?: string;\n        address?: string;\n    };\n    property_address?: string;\n    amount?: number;\n    period?: string;\n    month?: string | number;\n    year?: number;\n    periodStart?: string;\n    periodEnd?: string;\n    receiptNumber?: string;\n    userEmail?: string;\n    profile?: {\n        company_name?: string | null;\n        full_name?: string | null;\n        company_address?: string | null;\n        company_email?: string | null;\n        email?: string;\n        logo_url?: string | null;\n        signature_url?: string | null;\n        ninea?: string | null;\n        company_ninea?: string | null;\n    };\n    receiptImage?: string | null;\n}\n\ninterface GestionLocativeClientProps {\n    leases: Lease[];\n    transactions: Transaction[];\n    expenses: Expense[];\n    profile: Profile | null;\n    userEmail?: string;\n    ownerId: string;\n    isViewingTerminated?: boolean;\n    minDate?: string;\n}\n\nexport function GestionLocativeClient({\n    leases,\n    transactions,\n    expenses,\n    profile,\n    userEmail,\n    ownerId,\n    isViewingTerminated = false,\n    minDate\n}: GestionLocativeClientProps) {\n    const router = useRouter();\n    // √âtat pour le mois/ann√©e s√©lectionn√© - Initialis√© √† aujourd'hui\n    const today = useMemo(() => new Date(), []);\n    const [selectedMonth, setSelectedMonth] = useState(today.getMonth() + 1); // 1-12\n    const [selectedYear, setSelectedYear] = useState(today.getFullYear());\n    // Local state for optimistic updates\n    const [localTransactions, setLocalTransactions] = useState<Transaction[]>(transactions);\n\n    // Sync props to local state when they change (re-fetch)\n    useEffect(() => {\n        setLocalTransactions(transactions);\n    }, [transactions]);\n\n    const searchParams = useSearchParams();\n    const pathname = usePathname(); // Add this\n    const urlQuery = searchParams?.get('q') || '';\n    const [searchQuery, setSearchQuery] = useState(urlQuery);\n\n    // Sync state with URL when it changes\n    useEffect(() => {\n        setSearchQuery(urlQuery);\n    }, [urlQuery]);\n\n    // DEBUG: Mobile Crash Investigation\n    useEffect(() => {\n         \n        console.log(\"[GestionLocativeClient] Component Mounted\", {\n            leasesCount: leases?.length,\n            transactionsCount: transactions?.length,\n            expensesCount: expenses?.length,\n            hasProfile: !!profile,\n            ownerId,\n            timestamp: new Date().toISOString()\n        });\n    }, []);\n\n    // Update URL when local search changes (Debounced)\n    useEffect(() => {\n        const timer = setTimeout(() => {\n            if (searchQuery !== urlQuery) {\n                const params = new URLSearchParams(searchParams?.toString());\n                if (searchQuery) {\n                    params.set('q', searchQuery);\n                } else {\n                    params.delete('q');\n                }\n                router.replace(`${pathname}?${params.toString()}`, { scroll: false });\n            }\n        }, 300); // 300ms debounce\n\n        return () => clearTimeout(timer);\n    }, [searchQuery, urlQuery, pathname, router, searchParams]);\n    const [editingTenant, setEditingTenant] = useState<Tenant | null>(null);\n    const [viewMode, setViewMode] = useState<'table' | 'cards'>('cards'); // Default to cards (Noflaye style)\n    const [isReceiptOpen, setIsReceiptOpen] = useState(false);\n    const [currentReceipt, setCurrentReceipt] = useState<ReceiptData | null>(null);\n    const [_saving, setSaving] = useState(false);\n    const [filterStatus, setFilterStatus] = useState<'all' | 'paid' | 'pending' | 'overdue'>('all');\n\n    const handleMonthChange = (month: number, year: number) => {\n        setSelectedMonth(month);\n        setSelectedYear(year);\n    };\n\n    // ========================================\n    // AUTO-UPDATE MONTH DETECTION (Passage automatique au nouveau mois)\n    // ========================================\n\n\n    // ========================================\n    // FILTRAGE STRICT PAR P√âRIODE\n    // ========================================\n    const currentTransactions = useMemo(() => {\n        return localTransactions.filter(t =>\n            t.period_month === selectedMonth &&\n            t.period_year === selectedYear\n        );\n    }, [localTransactions, selectedMonth, selectedYear]);\n\n    // ========================================\n    // KPI CALCULATIONS (Source Unique de V√©rit√© : lib/finance.ts)\n    // ========================================\n    const kpiStats = useMemo(() => {\n        // Pr√©parer les donn√©es pour le Finance Guard\n        const targetDate = new Date(selectedYear, selectedMonth - 1, 1);\n\n        const safeLeases: LeaseInput[] = leases.map(l => ({\n            id: l.id,\n            monthly_amount: l.monthly_amount,\n            status: l.status || 'active',\n            start_date: l.start_date || null,\n            billing_day: l.billing_day || 5\n        }));\n\n        const safeTransactions: TransactionInput[] = currentTransactions.map(t => ({\n            id: t.id,\n            lease_id: t.lease_id,\n            amount_due: t.amount_due || 0,\n            amount_paid: t.amount_paid,\n            status: t.status\n        }));\n\n        // Filtrer les d√©penses pour le mois/ann√©e s√©lectionn√©\n        const monthlyExpenses = (expenses || []).filter(e => {\n            const d = new Date(e.expense_date);\n            return d.getMonth() + 1 === selectedMonth && d.getFullYear() === selectedYear;\n        });\n\n        const kpis = calculateFinancials(safeLeases, safeTransactions, monthlyExpenses, targetDate);\n\n        return {\n            totalExpected: kpis.totalExpected,\n            totalCollected: kpis.totalCollected,\n            totalExpenses: kpis.totalExpenses,\n            actualNetProfit: kpis.actualNetProfit,\n            projectedNetProfit: kpis.projectedNetProfit,\n            hasTemporaryDebt: kpis.hasTemporaryDebt,\n            totalPending: kpis.pendingAmount, // En attente stricte (hors retards)\n            paidCount: kpis.paidCount,\n            pendingCount: kpis.pendingCount,\n            overdueCount: kpis.overdueCount,\n            collectedPercent: kpis.collectionRate,\n            transactionCount: currentTransactions.length\n        };\n    }, [leases, currentTransactions, selectedMonth, selectedYear]);\n\n    // ========================================\n    // FORMATER LES LOCATAIRES POUR LE TABLEAU\n    // ========================================\n    // ========================================\n    // FORMATER LES LOCATAIRES POUR LE TABLEAU\n    // ========================================\n    const formattedTenants: Tenant[] = useMemo(() => {\n        const result: Tenant[] = [];\n\n        (leases || []).forEach(lease => {\n            // Trouver TOUTES les transactions pour CE mois s√©lectionn√©\n            const leaseTransactions = currentTransactions.filter(t => t.lease_id === lease.id);\n\n            // Consolider le statut pour √©viter les doublons\n            const paidTx = leaseTransactions.find(t => t.status === 'paid' || t.status?.toLowerCase() === 'paid');\n            const hasPayment = !!paidTx;\n\n            // Calcul du jour actuel (pour d√©terminer si overdue)\n            const currentDay = today.getDate();\n            const currentMonthIndex = today.getMonth() + 1;\n            const currentYearValue = today.getFullYear();\n\n            const isCurrentMonth = selectedMonth === currentMonthIndex && selectedYear === currentYearValue;\n            const isPastMonth = selectedYear < currentYearValue || (selectedYear === currentYearValue && selectedMonth < currentMonthIndex);\n\n            let displayStatus: 'paid' | 'pending' | 'overdue' = 'pending';\n\n            if (hasPayment) {\n                displayStatus = 'paid';\n            } else {\n                const billingDay = lease.billing_day || 5;\n                if (isPastMonth) {\n                    displayStatus = 'overdue';\n                } else if (isCurrentMonth && currentDay > billingDay) {\n                    displayStatus = 'overdue';\n                }\n                // sinon pending (futur ou courant avant √©ch√©ance)\n            }\n\n            result.push({\n                id: lease.id,\n                name: lease.tenant_name,\n                property: lease.properties?.title || lease.property_address || 'Bien non renseign√©',\n                phone: lease.tenant_phone,\n                email: lease.tenant_email,\n                rentAmount: lease.monthly_amount,\n                status: displayStatus,\n                dueDate: lease.billing_day,\n                startDate: lease.start_date,\n                endDate: lease.end_date,\n                last_transaction_id: paidTx?.id, // ID unique de la transaction pay√©e si elle existe\n                period_month: selectedMonth,\n                period_year: selectedYear,\n                period_start: paidTx?.period_start || null,\n                period_end: paidTx?.period_end || null\n            });\n        });\n\n        return result;\n    }, [leases, currentTransactions, selectedMonth, selectedYear, today]);\n\n    // ========================================\n    // FILTERED TENANTS (Search + Status Filter)\n    // ========================================\n    const filteredTenants = useMemo(() => {\n        let result = formattedTenants;\n\n        // 1. Status Filter (KPI Cards)\n        if (filterStatus !== 'all') {\n            result = result.filter(t => t.status === filterStatus);\n        }\n\n        return result;\n    }, [formattedTenants, filterStatus]);\n\n    // Helper function to format CSV data\n    const _formatCSVValue = (value: string | number | null | undefined): string => {\n        if (value === null || value === undefined) return '';\n        const stringValue = String(value);\n        if (stringValue.includes(',') || stringValue.includes('\\n') || stringValue.includes('\"')) {\n            return `\"${stringValue.replace(/\"/g, '\"\"')}\"`;\n        }\n        return stringValue;\n    };\n\n    // Export to Excel function using xlsx\n    const handleExportExcel = () => {\n        // Prepare data for xlsx\n        const data = formattedTenants.map(tenant => {\n            const periodStr = selectedMonth && selectedYear\n                ? `${selectedMonth.toString().padStart(2, '0')}/${selectedYear}`\n                : '';\n\n            const statusLabels: Record<string, string> = {\n                paid: 'Pay√©',\n                pending: 'En attente',\n                overdue: 'Retard'\n            };\n\n            return {\n                'Locataire': tenant.name || '',\n                'Email': tenant.email || '',\n                'T√©l√©phone': tenant.phone || '',\n                'Bien': tenant.property || '',\n                'P√©riode': periodStr,\n                'Statut': statusLabels[tenant.status] || '',\n                'Montant (FCFA)': tenant.rentAmount || 0\n            };\n        });\n\n        // Import xlsx dynamically to use writeFile\n        import('xlsx').then((XLSX) => {\n            const worksheet = XLSX.utils.json_to_sheet(data);\n            const workbook = XLSX.utils.book_new();\n            XLSX.utils.book_append_sheet(workbook, worksheet, 'Locataires');\n\n            // Generate filename\n            const monthNames = ['janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin',\n                'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre'];\n            const filename = `locataires-${monthNames[selectedMonth - 1]}-${selectedYear}.xlsx`;\n\n            // Write file - this properly handles the filename\n            XLSX.writeFile(workbook, filename);\n\n            toast.success(`Export Excel t√©l√©charg√© : ${filename}`);\n        });\n    };\n\n    // Format montant avec espaces\n    const _formatAmount = (amount: number) => {\n        return amount.toLocaleString('fr-FR');\n    };\n\n    // ========================================\n    // ACTION HANDLERS (LIFTED FROM TENANT TABLE)\n    // ========================================\n    const handleConfirmPayment = async (leaseId: string, transactionId?: string) => {\n        const tenant = formattedTenants.find(t => t.id === leaseId);\n        if (!tenant) {\n            toast.error('Locataire introuvable');\n            return;\n        }\n\n        const result = await confirmPayment(\n            leaseId,\n            transactionId,\n            selectedMonth,\n            selectedYear\n        );\n\n        if (!result.success) {\n            toast.error(result.error || 'Erreur inconnue');\n            return;\n        }\n\n        // --- OPTIMISTIC UPDATE ---\n        const txIndex = localTransactions.findIndex(t =>\n            (transactionId && t.id === transactionId) ||\n            (!transactionId && t.lease_id === leaseId && t.period_month === selectedMonth && t.period_year === selectedYear)\n        );\n\n        const updatedTx: Transaction = txIndex >= 0\n            ? { ...localTransactions[txIndex], status: 'paid', amount_paid: tenant.rentAmount, amount_due: tenant.rentAmount }\n            : {\n                id: transactionId || `temp-${Date.now()}`,\n                lease_id: leaseId,\n                period_month: selectedMonth,\n                period_year: selectedYear,\n                status: 'paid',\n                amount_due: tenant.rentAmount,\n                amount_paid: tenant.rentAmount,\n                paid_at: new Date().toISOString()\n            };\n\n        if (txIndex >= 0) {\n            const newTxs = [...localTransactions];\n            newTxs[txIndex] = updatedTx;\n            setLocalTransactions(newTxs);\n        } else {\n            setLocalTransactions([...localTransactions, updatedTx]);\n        }\n        // ------------------------\n\n        const shouldSendReceipt = window.confirm(\n            `Le loyer est marqu√© comme pay√©. Envoyer la quittance par email √† ${tenant.name} ?`\n        );\n\n        if (shouldSendReceipt) {\n            if (!tenant.email) {\n                toast.error('Email manquant pour ce locataire');\n                return;\n            }\n\n            const periodMonth = tenant.period_month?.toString().padStart(2, '0') || '01';\n            const periodYear = tenant.period_year || new Date().getFullYear();\n            const periodStartDate = tenant.period_start\n                ? new Date(tenant.period_start)\n                : new Date(periodYear, parseInt(periodMonth) - 1, 1);\n            const periodEndDate = tenant.period_end\n                ? new Date(tenant.period_end)\n                : new Date(periodYear, parseInt(periodMonth), 0);\n\n            const receiptData = {\n                tenantName: tenant.name,\n                tenantEmail: tenant.email,\n                tenantPhone: tenant.phone || '',\n                tenantAddress: tenant.property,\n                amount: Number(tenant.rentAmount) || 0,\n                periodMonth: `${periodMonth}/${periodYear}`,\n                periodStart: periodStartDate.toLocaleDateString('fr-FR'),\n                periodEnd: periodEndDate.toLocaleDateString('fr-FR'),\n                receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\n                ownerName: profile?.company_name || profile?.full_name || \"Propri√©taire\",\n                ownerAddress: profile?.company_address || \"Adresse non renseign√©e\",\n                ownerNinea: profile?.company_ninea || undefined,\n                ownerLogo: profile?.logo_url || undefined,\n                ownerSignature: profile?.signature_url || undefined,\n                ownerEmail: profile?.company_email || undefined,\n                ownerAccountEmail: userEmail || undefined,\n                propertyAddress: tenant.property,\n            };\n\n            toast.promise(\n                fetch('/api/send-receipt', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(receiptData),\n                }).then(async (res) => {\n                    const data = await res.json();\n                    if (!res.ok) throw new Error(data.error || 'Erreur lors de l\\'envoi');\n                    return data;\n                }),\n                {\n                    loading: 'Envoi de la quittance...',\n                    success: 'Quittance envoy√©e !',\n                    error: (err) => `Erreur: ${err.message}`,\n                }\n            );\n        } else {\n            toast.success(result.message || \"Paiement enregistr√© !\");\n        }\n\n        // Background refresh to true data\n        router.refresh();\n    };\n\n    const handleViewReceipt = (tenant: Tenant) => {\n        const periodMonth = tenant.period_month?.toString().padStart(2, '0') || '01';\n        const periodYear = tenant.period_year || new Date().getFullYear();\n\n        setCurrentReceipt({\n            tenant: {\n                tenant_name: tenant.name,\n                email: tenant.email,\n                phone: tenant.phone,\n                address: tenant.property\n            },\n            profile: {\n                company_name: profile?.company_name || profile?.full_name || \"Propri√©taire\",\n                company_address: profile?.company_address || \"Adresse non renseign√©e\",\n                company_email: profile?.company_email || undefined,\n                company_ninea: profile?.company_ninea || undefined,\n                logo_url: profile?.logo_url || undefined,\n                signature_url: profile?.signature_url || undefined\n            },\n            userEmail: userEmail,\n            amount: tenant.rentAmount,\n            month: periodMonth,\n            year: periodYear,\n            property_address: tenant.property\n        });\n        setIsReceiptOpen(true);\n    };\n\n    const handleTerminateLease = async (leaseId: string, tenantName: string) => {\n        const confirmed = window.confirm(\n            `‚ö†Ô∏è Voulez-vous vraiment r√©silier le bail de ${tenantName} ?`\n        );\n        if (!confirmed) return;\n\n        setSaving(true);\n        const result = await terminateLease(leaseId);\n        setSaving(false);\n\n        if (result.success) {\n            toast.success(result.message || 'Bail r√©sili√©');\n            window.location.reload();\n        } else {\n            toast.error(result.error || 'Erreur');\n        }\n    };\n\n    const handleReactivateLease = async (leaseId: string, tenantName: string) => {\n        const confirmed = window.confirm(\n            `‚úÖ R√©activer le bail de ${tenantName} ?`\n        );\n        if (!confirmed) return;\n\n        setSaving(true);\n        const result = await reactivateLease(leaseId);\n        setSaving(false);\n\n        if (result.success) {\n            toast.success(result.message || 'Bail r√©activ√©');\n            window.location.reload();\n        } else {\n            toast.error(result.error || 'Erreur');\n        }\n    };\n\n    const handleInvite = async (leaseId: string) => {\n        toast.promise(sendTenantInvitation(leaseId), {\n            loading: 'Envoi de l\\'invitation...',\n            success: (data) => {\n                if (!data.success) throw new Error(data.error);\n                return data.message || 'Invitation envoy√©e avec succ√®s';\n            },\n            error: (err) => `Erreur: ${err.message}`\n        });\n    };\n\n    const handleSendReminders = async () => {\n        // Optimistic UI interaction\n        const promise = processLateReminders();\n\n        toast.promise(promise, {\n            loading: 'Envoi des relances...',\n            success: (result) => {\n                if (result.count > 0) {\n                    return `‚úÖ ${result.count} relance(s) envoy√©e(s)`;\n                } else {\n                    return '‚ÑπÔ∏è Aucune relance √† envoyer';\n                }\n            },\n            error: '‚ùå Erreur lors de l\\'envoi'\n        });\n\n        try {\n            await promise;\n            router.refresh(); // Refresh to update reminder status/counts\n        } catch (error) {\n            console.error(error);\n        }\n    };\n\n    return (\n        <div className=\"space-y-0 w-full\">\n            <ReceiptModal\n                isOpen={isReceiptOpen}\n                onClose={() => setIsReceiptOpen(false)}\n                data={currentReceipt}\n            />\n\n            {/* ========================================\n                DASHBOARD STATS - Style Noflaye\n                ======================================== */}\n            <div id=\"tour-stats\">\n                <DashboardStats\n                    stats={{\n                        totalExpected: kpiStats.totalExpected,\n                        totalCollected: kpiStats.totalCollected,\n                        totalPending: kpiStats.totalPending,\n                        paidCount: kpiStats.paidCount,\n                        pendingCount: kpiStats.pendingCount,\n                        overdueCount: kpiStats.overdueCount,\n                        collectedPercent: kpiStats.collectedPercent,\n                        totalTenants: leases.length,\n                    }}\n                    onFilterChange={setFilterStatus}\n                    activeFilter={filterStatus}\n                />\n            </div>\n\n            {/* ========================================\n                QUICK ACTIONS - Style Noflaye\n                ======================================== */}\n            <QuickActions\n                onExportExcel={handleExportExcel}\n                pendingCount={kpiStats.pendingCount}\n                overdueCount={kpiStats.overdueCount}\n                onSendReminders={handleSendReminders}\n                ownerId={ownerId}\n                profile={profile}\n            />\n\n            {/* Ligne 1: Controls (Month Selector aligned left) */}\n            <div className=\"flex flex-col sm:flex-row gap-2 sm:items-center justify-between\">\n                {/* S√©lecteur de mois - Align√© √† gauche */}\n                <MonthSelector\n                    selectedMonth={selectedMonth}\n                    selectedYear={selectedYear}\n                    onMonthChange={handleMonthChange}\n                    minDate={minDate}\n                />\n\n                {/* View Toggle + Export CSV */}\n                <div className=\"flex items-center gap-2\">\n                    {/* View Mode Toggle */}\n                    <div className=\"flex items-center rounded-lg p-0.5 border border-border bg-muted\">\n                        <button\n                            onClick={() => setViewMode('cards')}\n                            className={`p-1.5 rounded-md transition-colors ${viewMode === 'cards'\n                                ? 'bg-background text-primary shadow-sm'\n                                : 'text-muted-foreground hover:text-foreground'\n                                }`}\n                            title=\"Vue cartes\"\n                        >\n                            <LayoutGrid className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                            onClick={() => setViewMode('table')}\n                            className={`p-1.5 rounded-md transition-colors ${viewMode === 'table'\n                                ? 'bg-background text-primary shadow-sm'\n                                : 'text-muted-foreground hover:text-foreground'\n                                }`}\n                            title=\"Vue tableau\"\n                        >\n                            <List className=\"w-4 h-4\" />\n                        </button>\n                    </div>\n\n                    {/* Bouton Export Excel */}\n                    <Button\n                        id=\"tour-export-excel\"\n                        onClick={() => {\n                            handleExportExcel();\n                        }}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"h-9 px-3 shrink-0 bg-background border-border text-foreground hover:bg-muted\"\n                        disabled={formattedTenants.length === 0}\n                    >\n                        <Download className=\"w-4 h-4 mr-1.5\" />\n                        Excel\n                    </Button>\n                </div>\n            </div>\n\n            {/* ========================================\n                TENANT VIEW - Cards or Table\n                ======================================== */}\n            <div id=\"tour-tenants-list\" className=\"mt-6\">\n                <div id=\"tour-add-tenant\">\n                    {viewMode === 'cards' ? (\n                        <TenantCardGrid\n                            tenants={filteredTenants}\n                            onEdit={(tenant) => setEditingTenant(tenant)}\n                            ownerId={ownerId}\n                            isViewingTerminated={isViewingTerminated}\n                            searchQuery={searchQuery}\n                            onConfirmPayment={handleConfirmPayment}\n                            onViewReceipt={handleViewReceipt}\n                            onTerminate={handleTerminateLease}\n                            onReactivate={handleReactivateLease}\n                            onInvite={handleInvite}\n                        />\n                    ) : (\n                        <TenantTable\n                            tenants={filteredTenants}\n                            profile={profile}\n                            userEmail={userEmail}\n                            ownerId={ownerId}\n                            isViewingTerminated={isViewingTerminated}\n                            searchQuery={searchQuery}\n                            onEdit={(tenant) => setEditingTenant(tenant)}\n                            onDelete={deleteTransaction}\n                            onDeleteLease={deleteLease}\n                            onConfirmPayment={handleConfirmPayment}\n                            onViewReceipt={handleViewReceipt}\n                            onTerminate={handleTerminateLease}\n                            onReactivate={handleReactivateLease}\n                            onInvite={handleInvite}\n                        />\n                    )}\n                </div>\n            </div>\n\n            {/* Modale d'√©dition */}\n            {\n                editingTenant && (\n                    <EditTenantDialog\n                        isOpen={!!editingTenant}\n                        onClose={() => setEditingTenant(null)}\n                        tenant={editingTenant}\n                    />\n                )\n            }\n        </div >\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\InvoiceActions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\KPICards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\LegalAlertsWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\MaintenanceHub.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":194,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":194,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7229,7232],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7229,7232],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":433,"column":49,"nodeType":"JSXOpeningElement","endLine":442,"endColumn":51}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Wrench, Clock, CheckCircle2, X, _Plus, ChevronDown, ChevronUp, CircleDollarSign, Calendar, Loader2, Send, Star, Phone, MapPin, AlertTriangle, Image as ImageIcon, User, Home, FileText, Upload } from 'lucide-react';\nimport { createClient } from '@/utils/supabase/client';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\nimport { Button } from \"@/components/ui/button\";\nimport { toast } from 'sonner';\nimport { EmptyState } from '@/components/ui/empty-state';\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogHeader,\n    DialogTitle,\n    DialogFooter,\n} from \"@/components/ui/dialog\"\nimport { createMaintenanceRequest, getActiveLeases, submitQuote, approveQuoteByOwner, completeIntervention, validateMaintenanceRequest, rejectMaintenanceRequest, handleOwnerRescheduleResponse } from '../actions';\n\ninterface MaintenanceRequest {\n    id: string;\n    description: string;\n    category?: string;\n    status: 'submitted' | 'open' | 'artisan_found' | 'awaiting_approval' | 'approved' | 'in_progress' | 'completed' | 'rejected' | 'cancelled';\n    quoted_price?: number;\n    intervention_date?: string;\n    created_at?: string;\n    tenant_name?: string;\n    // Colonnes artisan\n    artisan_name?: string;\n    artisan_phone?: string;\n    artisan_rating?: number;\n    artisan_address?: string;\n    tenant_response?: 'confirmed' | 'reschedule_requested';\n    tenant_suggested_date?: string;\n    rejection_reason?: string;\n    owner_approved?: boolean;\n    photo_urls?: string[];\n    quote_url?: string;\n    property_title?: string;\n    property_images?: string[];\n    tenant_email?: string;\n    is_new?: boolean;\n}\n\ninterface Lease {\n    id: string;\n    tenant_name: string;\n    property_address?: string;\n}\n\ninterface MaintenanceHubProps {\n    requests?: MaintenanceRequest[];\n}\n\nconst CATEGORIES = [\n    { value: 'Plomberie', emoji: 'üîß' },\n    { value: '√âlectricit√©', emoji: '‚ö°' },\n    { value: 'Ma√ßonnerie', emoji: 'üß±' },\n    { value: 'Climatisation', emoji: '‚ùÑÔ∏è' },\n    { value: 'Serrurerie', emoji: 'üîë' },\n    { value: 'Peinture', emoji: 'üé®' },\n    { value: 'Autre', emoji: 'üìã' }\n];\n\nexport function MaintenanceHub({ requests = [] }: MaintenanceHubProps) {\n    const [showForm, setShowForm] = useState(false);\n    const [description, setDescription] = useState('');\n    const [category, setCategory] = useState('Plomberie');\n    const [selectedLease, setSelectedLease] = useState('');\n    const [leases, setLeases] = useState<Lease[]>([]);\n    const [submitting, setSubmitting] = useState(false);\n    const [processingId, setProcessingId] = useState<string | null>(null);\n\n    // Modal saisie devis\n    const [showQuoteModal, setShowQuoteModal] = useState(false);\n    const [quoteRequestId, setQuoteRequestId] = useState<string | null>(null);\n    const [quotePrice, setQuotePrice] = useState('');\n    const [quoteDate, setQuoteDate] = useState('');\n    const [quoteFile, setQuoteFile] = useState<File | null>(null);\n    const [isUploading, setIsUploading] = useState(false);\n    const [expandedId, setExpandedId] = useState<string | null>(null);\n\n    useEffect(() => {\n        if (showForm) {\n            getActiveLeases().then(result => {\n                if (result.success && result.data) {\n                    setLeases(result.data);\n                    if (result.data.length > 0) {\n                        setSelectedLease(result.data[0].id);\n                    }\n                }\n            });\n        }\n    }, [showForm]);\n\n    const getStatusStyle = (status: string) => {\n        switch (status) {\n            case 'submitted': return \"bg-zinc-500/10 text-zinc-400\";\n            case 'open': return \"bg-blue-500/10 text-blue-400\";\n            case 'artisan_found': return \"bg-emerald-500/10 text-emerald-400\";\n            case 'awaiting_approval': return \"bg-primary/10 text-primary\";\n            case 'approved': return \"bg-purple-500/10 text-purple-400\";\n            case 'in_progress': return \"bg-yellow-500/10 text-yellow-400\";\n            case 'completed': return \"bg-green-500/10 text-green-400\";\n            case 'rejected': return \"bg-red-500/10 text-red-400\";\n            case 'cancelled': return \"bg-zinc-500/10 text-zinc-500\";\n            default: return \"bg-muted text-muted-foreground\";\n        }\n    };\n\n    const getStatusLabel = (status: string) => {\n        switch (status) {\n            case 'submitted': return \"√Ä valider\";\n            case 'open': return \"Recherche...\";\n            case 'artisan_found': return \"Artisan trouv√©\";\n            case 'awaiting_approval': return \"Validation requise\";\n            case 'approved': return \"Approuv√©\";\n            case 'in_progress': return \"En cours\";\n            case 'completed': return \"Termin√©\";\n            case 'rejected': return \"Rejet√©\";\n            case 'cancelled': return \"Annul√©\";\n            default: return status;\n        }\n    };\n\n    const handleSubmit = async () => {\n        if (!description.trim()) {\n            toast.error('Veuillez d√©crire le probl√®me');\n            return;\n        }\n\n        setSubmitting(true);\n        const result = await createMaintenanceRequest({\n            leaseId: selectedLease || undefined,\n            description: description.trim(),\n            category: category\n        });\n        setSubmitting(false);\n\n        if (result.success) {\n            toast.success(result.message || 'Intervention signal√©e!');\n            setDescription('');\n            setCategory('Plomberie');\n            setShowForm(false);\n        } else {\n            toast.error(result.error || 'Erreur lors du signalement');\n        }\n    };\n\n    const openQuoteModal = (requestId: string, currentPrice?: number, currentDate?: string) => {\n        setQuoteRequestId(requestId);\n        setQuotePrice(currentPrice ? currentPrice.toString() : '');\n        // Convert ISO date to YYYY-MM-DDTHH:mm for datetime-local\n        if (currentDate) {\n            const date = new Date(currentDate);\n            const formatted = date.toISOString().slice(0, 16);\n            setQuoteDate(formatted);\n        } else {\n            setQuoteDate('');\n        }\n        setQuoteFile(null);\n        setShowQuoteModal(true);\n    };\n\n    const handleSubmitQuote = async () => {\n        if (!quoteRequestId || !quotePrice || !quoteDate) {\n            toast.error('Veuillez remplir tous les champs');\n            return;\n        }\n\n        setProcessingId(quoteRequestId);\n        let finalQuoteUrl = '';\n\n        if (quoteFile) {\n            setIsUploading(true);\n            try {\n                const supabase = createClient();\n                const fileExt = quoteFile.name.split('.').pop();\n                const fileName = `maintenance/quote_${Date.now()}.${fileExt}`;\n\n                const { data: _uploadData, error: uploadError } = await supabase.storage\n                    .from('properties')\n                    .upload(fileName, quoteFile);\n\n                if (uploadError) throw uploadError;\n\n                const { data: { publicUrl } } = supabase.storage\n                    .from('properties')\n                    .getPublicUrl(fileName);\n\n                finalQuoteUrl = publicUrl;\n            } catch (error: any) {\n                toast.error(\"Erreur upload: \" + error.message);\n                setProcessingId(null);\n                setIsUploading(false);\n                return;\n            } finally {\n                setIsUploading(false);\n            }\n        }\n\n        const result = await submitQuote(quoteRequestId, {\n            quoted_price: parseInt(quotePrice),\n            intervention_date: quoteDate,\n            quote_url: finalQuoteUrl || undefined\n        });\n        setProcessingId(null);\n\n        if (result.success) {\n            toast.success(result.message || 'Devis enregistr√© !');\n            setShowQuoteModal(false);\n            setQuoteFile(null);\n        } else {\n            toast.error(result.error || 'Erreur');\n        }\n    };\n\n    const handleApproveQuote = async (requestId: string) => {\n        setProcessingId(requestId);\n        const result = await approveQuoteByOwner(requestId);\n        setProcessingId(null);\n        if (result.success) {\n            toast.success(result.message || 'Devis approuv√© !');\n        } else {\n            toast.error(result.error || 'Erreur');\n        }\n    };\n\n    const handleAcceptReschedule = async (requestId: string) => {\n        setProcessingId(requestId);\n        try {\n            const result = await handleOwnerRescheduleResponse(requestId, 'accept');\n            if (result.success) {\n                toast.success(result.message);\n            } else {\n                toast.error(result.error || \"Erreur lors de l'acceptation du report\");\n            }\n        } catch (_error) {\n            toast.error(\"Erreur de connexion\");\n        } finally {\n            setProcessingId(null);\n        }\n    };\n\n    const handleValidateRequest = async (requestId: string) => {\n        setProcessingId(requestId);\n        const result = await validateMaintenanceRequest(requestId);\n        setProcessingId(null);\n        if (result.success) {\n            toast.success(result.message || 'Intervention valid√©e !');\n        } else {\n            toast.error(result.error || 'Erreur lors de la validation');\n        }\n    };\n\n    const handleRejectRequest = async (requestId: string) => {\n        const reason = window.prompt(\"Motif du rejet (ex: d√©j√† r√©par√©, demande invalide...) :\");\n        if (reason === null) return; // Annul√© par l'utilisateur\n\n        setProcessingId(requestId);\n        const result = await rejectMaintenanceRequest(requestId, reason);\n        setProcessingId(null);\n        if (result.success) {\n            toast.success(result.message || 'Intervention rejet√©e');\n        } else {\n            toast.error(result.error || 'Erreur');\n        }\n    };\n\n    const handleComplete = async (requestId: string) => {\n        setProcessingId(requestId);\n        const result = await completeIntervention(requestId);\n        setProcessingId(null);\n        if (result.success) {\n            toast.success(result.message || 'Intervention termin√©e !');\n        } else {\n            toast.error(result.error || 'Erreur');\n        }\n    };\n\n    return (\n        <div className=\"relative overflow-hidden rounded-xl p-5 border border-border bg-card\">\n            <div className=\"relative space-y-4\">\n                {/* Header */}\n                <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                        <div className=\"p-2.5 rounded-xl border border-border bg-muted\">\n                            <Wrench className=\"w-5 h-5 text-foreground\" />\n                        </div>\n                        <div>\n                            <h3 className=\"font-semibold text-sm text-foreground\">Interventions</h3>\n                            <p className=\"text-xs text-muted-foreground\">Maintenance & travaux</p>\n                        </div>\n                    </div>\n                    <div id=\"tour-intervention-signaler\">\n                        <Button\n                            size=\"sm\"\n                            variant={showForm ? \"ghost\" : \"outline\"}\n                            className=\"text-xs h-8\"\n                            onClick={() => setShowForm(!showForm)}\n                        >\n                            {showForm ? <><X className=\"w-3 h-3 mr-1\" /> Annuler</> : '+ Signaler'}\n                        </Button>\n                    </div>\n                </div>\n\n                {/* Formulaire */}\n                {showForm && (\n                    <div className=\"p-4 rounded-xl space-y-3 border border-border bg-muted/30\">\n                        <p className=\"text-xs font-medium text-primary\">Nouvelle intervention</p>\n\n                        {leases.length > 0 && (\n                            <div className=\"relative\">\n                                <select\n                                    value={selectedLease}\n                                    onChange={(e) => setSelectedLease(e.target.value)}\n                                    className=\"w-full rounded-lg px-3 py-2 pr-8 text-sm appearance-none cursor-pointer border border-border bg-background text-foreground\"\n                                >\n                                    {leases.map(lease => (\n                                        <option key={lease.id} value={lease.id}>\n                                            {lease.tenant_name}\n                                        </option>\n                                    ))}\n                                </select>\n                                <ChevronDown className=\"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none text-muted-foreground\" />\n                            </div>\n                        )}\n\n                        <textarea\n                            placeholder=\"D√©crivez le probl√®me...\"\n                            value={description}\n                            onChange={(e) => setDescription(e.target.value)}\n                            className=\"w-full rounded-lg px-3 py-2 text-sm resize-none h-16 border border-border bg-background text-foreground placeholder:text-muted-foreground focus:ring-1 focus:ring-primary focus:outline-none\"\n                        />\n\n                        <div className=\"flex gap-2\">\n                            <div className=\"relative flex-1\">\n                                <select\n                                    value={category}\n                                    onChange={(e) => setCategory(e.target.value)}\n                                    className=\"w-full rounded-lg px-3 py-2 pr-8 text-sm appearance-none cursor-pointer border border-border bg-background text-foreground\"\n                                >\n                                    {CATEGORIES.map(cat => (\n                                        <option key={cat.value} value={cat.value}>\n                                            {cat.emoji} {cat.value}\n                                        </option>\n                                    ))}\n                                </select>\n                                <ChevronDown className=\"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none text-muted-foreground\" />\n                            </div>\n                            <Button\n                                onClick={handleSubmit}\n                                disabled={!description.trim() || submitting}\n                                size=\"sm\"\n                                className=\"h-9 px-4 bg-primary text-primary-foreground hover:bg-primary/90 transition-all shadow-md\"\n                            >\n                                {submitting ? (\n                                    <Loader2 className=\"w-4 h-4 animate-spin\" />\n                                ) : (\n                                    <><Send className=\"w-3 h-3 mr-1\" /> Envoyer</>\n                                )}\n                            </Button>\n                        </div>\n                    </div>\n                )}\n\n                {/* Liste des demandes */}\n                <div className=\"space-y-3\">\n                    {requests.length > 0 ? requests.map((req) => (\n                        <div key={req.id} className={`rounded-2xl border overflow-hidden transition-all duration-200 ${req.is_new ? 'border-blue-500/40 bg-blue-500/5' : 'border-border bg-muted/20'}`}>\n                            {req.is_new && (\n                                <div className=\"px-4 py-1.5 bg-blue-500/10 border-b border-blue-500/20 flex items-center gap-2\">\n                                    <span className=\"w-2 h-2 rounded-full bg-blue-500 animate-pulse\" />\n                                    <span className=\"text-xs font-medium text-blue-400\">Nouveau</span>\n                                </div>\n                            )}\n                            {/* En-t√™te cliquable */}\n                            <div\n                                className=\"p-4 cursor-pointer hover:bg-muted/30 transition-colors\"\n                                onClick={() => setExpandedId(expandedId === req.id ? null : req.id)}\n                            >\n                                <div className=\"flex justify-between items-start\">\n                                    <div className=\"flex-1\">\n                                        <div className=\"flex items-center gap-2 mb-1\">\n                                            <h4 className=\"font-bold text-sm text-foreground\">{req.description}</h4>\n                                            {req.photo_urls && req.photo_urls.length > 0 && (\n                                                <ImageIcon className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                                            )}\n                                        </div>\n                                        <div className=\"flex flex-wrap items-center gap-x-3 gap-y-1\">\n                                            <p className=\"text-[10px] text-muted-foreground flex items-center gap-1 font-medium bg-muted/50 px-1.5 py-0.5 rounded uppercase\">\n                                                {req.category}\n                                            </p>\n                                            {req.property_title && (\n                                                <p className=\"text-[10px] text-muted-foreground flex items-center gap-1\">\n                                                    <Home className=\"w-3 h-3\" /> {req.property_title}\n                                                </p>\n                                            )}\n                                            {req.tenant_name && (\n                                                <p className=\"text-[10px] text-muted-foreground flex items-center gap-1\">\n                                                    <User className=\"w-3 h-3\" /> {req.tenant_name}\n                                                </p>\n                                            )}\n                                        </div>\n                                    </div>\n                                    <div className=\"flex flex-col items-end gap-2\">\n                                        <span className={`text-[10px] px-2 py-1 rounded-full font-medium ${getStatusStyle(req.status)} whitespace-nowrap`}>\n                                            {getStatusLabel(req.status)}\n                                        </span>\n                                        {expandedId === req.id ? (\n                                            <ChevronUp className=\"w-4 h-4 text-muted-foreground\" />\n                                        ) : (\n                                            <ChevronDown className=\"w-4 h-4 text-muted-foreground\" />\n                                        )}\n                                    </div>\n                                </div>\n                            </div>\n\n                            {/* Contenu d√©taill√© (Expandable) */}\n                            <div className={`px-4 pb-4 space-y-3 ${expandedId === req.id ? 'block' : 'hidden'}`}>\n                                <div className=\"h-px bg-border/50 mb-3\" />\n\n                                {/* Photos */}\n                                {req.photo_urls && req.photo_urls.length > 0 && (\n                                    <div className=\"space-y-2\">\n                                        <p className=\"text-[10px] uppercase font-bold text-muted-foreground flex items-center gap-1\">\n                                            <ImageIcon className=\"w-3 h-3\" /> Photos du signalement\n                                        </p>\n                                        <div className=\"flex gap-2 p-1 overflow-x-auto pb-2 scrollbar-hide\">\n                                            {req.photo_urls.map((url, i) => (\n                                                <img\n                                                    key={i}\n                                                    src={url}\n                                                    alt={`Photo ${i + 1}`}\n                                                    className=\"w-24 h-24 rounded-lg object-cover flex-shrink-0 border border-border hover:opacity-90 cursor-zoom-in transition-opacity\"\n                                                    onClick={(e) => {\n                                                        e.stopPropagation();\n                                                        window.open(url, '_blank');\n                                                    }}\n                                                />\n                                            ))}\n                                        </div>\n                                    </div>\n                                )}\n\n                                {/* D√©tails Contact Locataire (si besoin) */}\n                                {req.tenant_email && (\n                                    <div className=\"p-3 rounded-lg border border-border bg-background/50 text-[11px] space-y-1\">\n                                        <p className=\"font-bold text-muted-foreground flex items-center gap-1 uppercase text-[9px]\">Contact Locataire</p>\n                                        <div className=\"flex flex-wrap gap-x-4\">\n                                            <p className=\"flex items-center gap-1\">\n                                                <User className=\"w-3 h-3 text-muted-foreground\" /> {req.tenant_name}\n                                            </p>\n                                            <p className=\"text-muted-foreground italic\">{req.tenant_email}</p>\n                                        </div>\n                                    </div>\n                                )}\n\n                                {/* Bloc Artisan (si trouv√©) */}\n                                {req.artisan_name && (\n                                    <div className=\"p-3 rounded-lg border border-border bg-background\">\n                                        <p className=\"text-[10px] uppercase font-bold mb-2 text-muted-foreground\">Artisan sugg√©r√©</p>\n                                        <div className=\"flex items-center justify-between flex-wrap gap-2\">\n                                            <div>\n                                                <p className=\"font-bold text-sm text-foreground\">{req.artisan_name}</p>\n                                                {req.artisan_rating && (\n                                                    <span className=\"text-yellow-500 text-xs flex items-center gap-1\">\n                                                        <Star className=\"w-3 h-3 fill-current\" /> {req.artisan_rating}/5\n                                                    </span>\n                                                )}\n                                            </div>\n                                            {req.artisan_phone && (\n                                                <a\n                                                    href={`tel:${req.artisan_phone}`}\n                                                    className=\"bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-3 py-1.5 rounded-lg flex items-center gap-1.5 transition-colors\"\n                                                >\n                                                    <Phone className=\"w-3 h-3\" /> Appeler\n                                                </a>\n                                            )}\n                                        </div>\n                                        {req.artisan_address && (\n                                            <p className=\"text-xs mt-1 flex items-center gap-1 text-muted-foreground\">\n                                                <MapPin className=\"w-3 h-3\" /> {req.artisan_address}\n                                            </p>\n                                        )}\n                                    </div>\n                                )}\n\n                                {/* Infos devis (si saisi) */}\n                                {req.quoted_price && (\n                                    <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                                        <span className=\"flex items-center gap-1\">\n                                            <CircleDollarSign className=\"w-3 h-3\" /> {req.quoted_price.toLocaleString('fr-FR')} FCFA\n                                        </span>\n                                        {req.intervention_date && (\n                                            <div className=\"flex items-center gap-1\">\n                                                <Calendar className=\"w-3 h-3\" />\n                                                <span className=\"text-secondary font-semibold\">\n                                                    {format(new Date(req.intervention_date), 'd MMMM √† HH:mm', { locale: fr })}\n                                                </span>\n                                            </div>\n                                        )}\n                                    </div>\n                                )}\n\n                                {/* Rejection Reason */}\n                                {req.status === 'rejected' && req.rejection_reason && (\n                                    <div className=\"mt-2 px-3 py-2 rounded-lg bg-red-50/50 border border-red-100 flex items-start gap-2 text-xs font-medium text-red-600\">\n                                        <AlertTriangle className=\"w-3.5 h-3.5 mt-0.5\" />\n                                        <div>\n                                            <p className=\"font-bold uppercase text-[9px]\">Motif du rejet :</p>\n                                            <p>{req.rejection_reason}</p>\n                                        </div>\n                                    </div>\n                                )}\n\n                                {/* Tenant Response Feedback */}\n                                {req.tenant_response && (\n                                    <div className=\"mt-2 space-y-2\">\n                                        <div className=\"px-3 py-2 rounded-lg border flex items-center justify-between gap-2 text-xs font-medium\">\n                                            {req.tenant_response === 'confirmed' ? (\n                                                <div className=\"text-emerald-500 bg-emerald-50/50 border-emerald-100 flex items-center gap-2\">\n                                                    <CheckCircle2 className=\"w-3.5 h-3.5\" /> Locataire disponible\n                                                </div>\n                                            ) : (\n                                                <div className=\"flex flex-col gap-2 w-full\">\n                                                    <div className=\"text-amber-500 bg-amber-50/50 border-amber-100 flex items-center gap-2\">\n                                                        <Clock className=\"w-3.5 h-3.5\" /> Report demand√© : {req.tenant_suggested_date ? format(new Date(req.tenant_suggested_date), 'd MMMM √† HH:mm', { locale: fr }) : '√† pr√©ciser'}\n                                                    </div>\n\n                                                    {req.tenant_response === 'reschedule_requested' && req.tenant_suggested_date && (\n                                                        <div className=\"flex gap-2\">\n                                                            <Button\n                                                                onClick={(e) => { e.stopPropagation(); handleAcceptReschedule(req.id); }}\n                                                                disabled={processingId === req.id}\n                                                                size=\"sm\"\n                                                                className=\"h-7 text-[10px] bg-emerald-600 hover:bg-emerald-700 text-white\"\n                                                            >\n                                                                {processingId === req.id ? <Loader2 className=\"w-3 h-3 animate-spin\" /> : \"Accepter ce cr√©neau\"}\n                                                            </Button>\n                                                            <Button\n                                                                onClick={(e) => { e.stopPropagation(); openQuoteModal(req.id, req.quoted_price, req.intervention_date); }}\n                                                                variant=\"outline\"\n                                                                size=\"sm\"\n                                                                className=\"h-7 text-[10px]\"\n                                                            >\n                                                                Modifier la date\n                                                            </Button>\n                                                        </div>\n                                                    )}\n                                                </div>\n                                            )}\n                                        </div>\n                                    </div>\n                                )}\n\n                                {/* Actions selon le statut */}\n                                <div className=\"flex gap-2 pt-1 flex-wrap\">\n                                    {/* Nouvelle demande -> Valider ou Rejeter */}\n                                    {req.status === 'submitted' && (\n                                        <>\n                                            <Button\n                                                onClick={(e) => { e.stopPropagation(); handleValidateRequest(req.id); }}\n                                                disabled={processingId === req.id}\n                                                size=\"sm\"\n                                                className=\"bg-primary text-primary-foreground hover:bg-primary/90 transition-all shadow-md text-xs h-8\"\n                                            >\n                                                {processingId === req.id ? (\n                                                    <Loader2 className=\"w-3 h-3 animate-spin\" />\n                                                ) : (\n                                                    <>Valider l&apos;intervention</>\n                                                )}\n                                            </Button>\n                                            <Button\n                                                onClick={(e) => { e.stopPropagation(); handleRejectRequest(req.id); }}\n                                                disabled={processingId === req.id}\n                                                variant=\"outline\"\n                                                size=\"sm\"\n                                                className=\"text-xs h-8 border-red-500/50 text-red-500 hover:bg-red-500/10\"\n                                            >\n                                                Rejeter\n                                            </Button>\n                                        </>\n                                    )}\n\n                                    {/* Artisan trouv√© ‚Üí Saisir devis */}\n                                    {req.status === 'artisan_found' && (\n                                        <Button\n                                            onClick={(e) => { e.stopPropagation(); openQuoteModal(req.id, req.quoted_price, req.intervention_date); }}\n                                            size=\"sm\"\n                                            className=\"bg-blue-600 hover:bg-blue-700 text-xs h-8\"\n                                        >\n                                            <CircleDollarSign className=\"w-3 h-3 mr-1\" /> Saisir le devis\n                                        </Button>\n                                    )}\n\n                                    {/* Lien devis (si disponible dans d'autres statuts) */}\n                                    {req.quote_url && req.status !== 'approved' && req.status !== 'completed' && (\n                                        <a\n                                            href={req.quote_url}\n                                            target=\"_blank\"\n                                            rel=\"noopener noreferrer\"\n                                            onClick={(e) => e.stopPropagation()}\n                                            className=\"inline-flex items-center gap-1.5 px-3 h-8 rounded-lg border border-border bg-background hover:bg-muted text-xs font-medium transition-colors\"\n                                        >\n                                            <FileText className=\"w-3 h-3\" /> Devis PDF\n                                        </a>\n                                    )}\n\n                                    {/* Cl√¥tur√© avec facture */}\n                                    {req.status === 'completed' && req.quote_url && (\n                                        <a\n                                            href={req.quote_url}\n                                            target=\"_blank\"\n                                            rel=\"noopener noreferrer\"\n                                            onClick={(e) => e.stopPropagation()}\n                                            className=\"inline-flex items-center gap-1.5 px-3 h-8 rounded-lg border border-border bg-background hover:bg-muted text-xs font-medium transition-colors\"\n                                        >\n                                            <FileText className=\"w-3 h-3\" /> Facture PDF\n                                        </a>\n                                    )}\n\n                                    {/* En attente d'approbation ‚Üí Approuver */}\n                                    {req.status === 'awaiting_approval' && (\n                                        <Button\n                                            onClick={(e) => { e.stopPropagation(); handleApproveQuote(req.id); }}\n                                            disabled={processingId === req.id}\n                                            size=\"sm\"\n                                            className=\"bg-primary text-primary-foreground hover:bg-primary/90 transition-all shadow-md text-xs h-8\"\n                                        >\n                                            {processingId === req.id ? (\n                                                <Loader2 className=\"w-3 h-3 animate-spin\" />\n                                            ) : (\n                                                <>Approuver {req.quoted_price?.toLocaleString('fr-FR')} FCFA</>\n                                            )}\n                                        </Button>\n                                    )}\n\n                                    {/* Approuv√© ‚Üí Terminer */}\n                                    {req.status === 'approved' && (\n                                        <div className=\"flex gap-2\">\n                                            <Button\n                                                onClick={(e) => { e.stopPropagation(); handleComplete(req.id); }}\n                                                disabled={processingId === req.id}\n                                                size=\"sm\"\n                                                className=\"bg-green-600 hover:bg-green-700 text-xs h-8\"\n                                            >\n                                                {processingId === req.id ? (\n                                                    <Loader2 className=\"w-3 h-3 animate-spin\" />\n                                                ) : (\n                                                    <><CheckCircle2 className=\"w-3 h-3 mr-1\" /> Terminer &amp; Payer</>\n                                                )}\n                                            </Button>\n                                            {req.quote_url && (\n                                                <a\n                                                    href={req.quote_url}\n                                                    target=\"_blank\"\n                                                    rel=\"noopener noreferrer\"\n                                                    onClick={(e) => e.stopPropagation()}\n                                                    className=\"inline-flex items-center gap-1.5 px-3 h-8 rounded-lg border border-border bg-background hover:bg-muted text-xs font-medium transition-colors\"\n                                                >\n                                                    <FileText className=\"w-3 h-3\" /> Voir le devis\n                                                </a>\n                                            )}\n                                        </div>\n                                    )}\n\n                                    {/* Termin√© */}\n                                    {req.status === 'completed' && (\n                                        <div className=\"flex items-center justify-between w-full\">\n                                            <span className=\"text-xs text-green-400 flex items-center gap-1\">\n                                                <CheckCircle2 className=\"w-3 h-3\" /> Intervention cl√¥tur√©e\n                                            </span>\n                                            {req.quote_url && (\n                                                <a\n                                                    href={req.quote_url}\n                                                    target=\"_blank\"\n                                                    rel=\"noopener noreferrer\"\n                                                    onClick={(e) => e.stopPropagation()}\n                                                    className=\"inline-flex items-center gap-1 text-[10px] font-medium text-slate-400 hover:text-white transition-colors border border-slate-800 rounded px-1.5 py-0.5\"\n                                                >\n                                                    <FileText className=\"w-3 h-3\" /> Facture PDF\n                                                </a>\n                                            )}\n                                        </div>\n                                    )}\n\n                                    {/* Open (sans artisan) */}\n                                    {req.status === 'open' && !req.artisan_name && (\n                                        <span className=\"text-xs text-gray-500 italic flex items-center gap-1\">\n                                            <Clock className=\"w-3 h-3\" /> Recherche d&apos;artisan en cours...\n                                        </span>\n                                    )}\n                                </div>\n                            </div>\n                        </div>\n                    )) : (\n                        <EmptyState\n                            title=\"Aucun signalement √† traiter\"\n                            description=\"Vos locataires n'ont signal√© aucun incident pour le moment. Vous pouvez cr√©er une intervention manuellement si n√©cessaire.\"\n                            icon={Wrench}\n                            actionLabel=\"Cr√©er une intervention\"\n                            onAction={() => setShowForm(true)}\n                        />\n                    )}\n                </div>\n\n                {/* Modal Saisie Devis */}\n                {/* Modal Saisie Devis */}\n                <Dialog open={showQuoteModal} onOpenChange={setShowQuoteModal}>\n                    <DialogContent className=\"sm:max-w-[425px]\">\n                        <DialogHeader>\n                            <DialogTitle>Saisir le devis</DialogTitle>\n                            <DialogDescription>\n                                Renseignez les d√©tails du devis pour validation.\n                            </DialogDescription>\n                        </DialogHeader>\n\n                        <div className=\"space-y-4 py-4\">\n                            <div className=\"space-y-2\">\n                                <label className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-foreground\">\n                                    Montant (FCFA)\n                                </label>\n                                <input\n                                    type=\"number\"\n                                    value={quotePrice}\n                                    onChange={(e) => setQuotePrice(e.target.value)}\n                                    placeholder=\"Ex: 25000\"\n                                    className=\"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\"\n                                />\n                            </div>\n                            <div className=\"space-y-2\">\n                                <label className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-foreground\">\n                                    Date et heure d&apos;intervention\n                                </label>\n                                <input\n                                    type=\"datetime-local\"\n                                    value={quoteDate}\n                                    onChange={(e) => setQuoteDate(e.target.value)}\n                                    className=\"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\"\n                                />\n                            </div>\n                            <div className=\"space-y-2\">\n                                <label className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-foreground\">\n                                    Document (Devis/Facture PDF)\n                                </label>\n                                <div className=\"relative group\">\n                                    <input\n                                        type=\"file\"\n                                        accept=\"application/pdf,image/*\"\n                                        onChange={(e) => setQuoteFile(e.target.files?.[0] || null)}\n                                        className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10\"\n                                    />\n                                    <div className={`w-full border-2 border-dashed rounded-lg p-4 flex flex-col items-center justify-center gap-2 transition-colors ${quoteFile ? 'border-primary/50 bg-primary/5' : 'border-border group-hover:border-primary/20'}`}>\n                                        {quoteFile ? (\n                                            <>\n                                                <FileText className=\"w-6 h-6 text-primary/70\" />\n                                                <span className=\"text-[10px] font-medium text-foreground truncate max-w-full italic px-2\">\n                                                    {quoteFile.name}\n                                                </span>\n                                                <button\n                                                    type=\"button\"\n                                                    onClick={(e) => { e.stopPropagation(); setQuoteFile(null); }}\n                                                    className=\"text-[9px] text-muted-foreground hover:text-foreground underline z-20\"\n                                                >\n                                                    Supprimer\n                                                </button>\n                                            </>\n                                        ) : (\n                                            <>\n                                                <Upload className=\"w-6 h-6 text-muted-foreground group-hover:text-primary/50 transition-colors\" />\n                                                <span className=\"text-[10px] text-muted-foreground text-center\">\n                                                    Laissez vide pour g√©n√©rer un devis auto\n                                                </span>\n                                                <span className=\"text-[8px] text-gray-400 italic\">\n                                                    ou glissez un PDF externe ici\n                                                </span>\n                                            </>\n                                        )}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <DialogFooter className=\"gap-2 sm:gap-0\">\n                            <Button\n                                onClick={() => setShowQuoteModal(false)}\n                                variant=\"outline\"\n                                type=\"button\"\n                            >\n                                Annuler\n                            </Button>\n                            <Button\n                                onClick={handleSubmitQuote}\n                                disabled={!quotePrice || !quoteDate || processingId !== null || isUploading}\n                                className=\"bg-foreground text-background hover:bg-foreground/90 font-bold\"\n                            >\n                                {processingId !== null || isUploading ? (\n                                    <>\n                                        <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                                        {isUploading ? \"Upload...\" : \"Enregistrement...\"}\n                                    </>\n                                ) : (\n                                    'Valider le devis'\n                                )}\n                            </Button>\n                        </DialogFooter>\n                    </DialogContent>\n                </Dialog>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\MonthSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\OrphanLeasesAlert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\PageWrapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\PropertySelector.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'defaultPrice' and 'onPropertySelect'. Either include them or remove the dependency array. If 'onPropertySelect' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":109,"column":8,"nodeType":"ArrayExpression","endLine":109,"endColumn":44,"suggestions":[{"desc":"Update the dependencies array to be: [selectedPropertyId, defaultAddress, onPropertySelect, defaultPrice]","fix":{"range":[4235,4271],"text":"[selectedPropertyId, defaultAddress, onPropertySelect, defaultPrice]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Check, ChevronsUpDown, Plus, Home, MapPin, Loader2 } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n    Command,\r\n    CommandEmpty,\r\n    CommandGroup,\r\n    CommandInput,\r\n    CommandItem,\r\n    CommandList,\r\n    CommandSeparator,\r\n} from \"@/components/ui/command\";\r\nimport {\r\n    Popover,\r\n    PopoverContent,\r\n    PopoverTrigger,\r\n} from \"@/components/ui/popover\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { getVacantTeamProperties, type VacantProperty } from \"../actions/property-selector\";\r\n\r\ninterface PropertySelectorProps {\r\n    onPropertySelect: (property: VacantProperty | null) => void;\r\n    onCreateNew: (data: { title: string; address: string; price: number }) => void;\r\n    selectedPropertyId?: string;\r\n    defaultPrice?: number;\r\n    defaultAddress?: string;\r\n}\r\n\r\nexport function PropertySelector({\r\n    onPropertySelect,\r\n    onCreateNew,\r\n    selectedPropertyId,\r\n    defaultPrice,\r\n    defaultAddress,\r\n}: PropertySelectorProps) {\r\n    const [open, setOpen] = useState(false);\r\n    const [loading, setLoading] = useState(true);\r\n    const [properties, setProperties] = useState<VacantProperty[]>([]);\r\n    const [selectedProperty, setSelectedProperty] = useState<VacantProperty | null>(null);\r\n\r\n    // Mode cr√©ation\r\n    const [createMode, setCreateMode] = useState(false);\r\n    const [newProperty, setNewProperty] = useState({\r\n        title: \"\",\r\n        address: \"\",\r\n        price: defaultPrice || 0,\r\n    });\r\n\r\n    // Charger les biens vacants au montage\r\n    useEffect(() => {\r\n        async function loadProperties() {\r\n            setLoading(true);\r\n            const result = await getVacantTeamProperties();\r\n            if (result.success && result.data) {\r\n                setProperties(result.data);\r\n\r\n                // S√©lectionner le bien par d√©faut si ID fourni\r\n                if (selectedPropertyId) {\r\n                    const found = result.data.find((p) => p.id === selectedPropertyId);\r\n                    if (found) {\r\n                        setSelectedProperty(found);\r\n                        onPropertySelect(found);\r\n                    }\r\n                }\r\n                // OU essayer de matcher par adresse par d√©faut (mode d√©mo / import)\r\n                else if (defaultAddress && result.data.length > 0) {\r\n                    const normalizedDefault = defaultAddress.toLowerCase().trim();\r\n\r\n                    // Recherche exacte d'abord\r\n                    let matched = result.data.find((p) =>\r\n                        p.address.toLowerCase().includes(normalizedDefault) ||\r\n                        normalizedDefault.includes(p.address.toLowerCase()) ||\r\n                        p.city?.toLowerCase() === normalizedDefault.split(',')[0].trim()\r\n                    );\r\n\r\n                    // Si pas de match exact, recherche par mots-cl√©s\r\n                    if (!matched) {\r\n                        const keywords = normalizedDefault.split(/[,\\s]+/).filter(k => k.length > 2);\r\n                        matched = result.data.find((p) =>\r\n                            keywords.some(kw =>\r\n                                p.address.toLowerCase().includes(kw) ||\r\n                                p.title.toLowerCase().includes(kw) ||\r\n                                p.city?.toLowerCase().includes(kw)\r\n                            )\r\n                        );\r\n                    }\r\n\r\n                    if (matched) {\r\n                        setSelectedProperty(matched);\r\n                        onPropertySelect(matched);\r\n                    } else {\r\n                        // Aucun bien trouv√©, passer en mode cr√©ation avec l'adresse pr√©-remplie\r\n                        setCreateMode(true);\r\n                        setNewProperty(prev => ({\r\n                            ...prev,\r\n                            address: defaultAddress,\r\n                            price: defaultPrice || 0\r\n                        }));\r\n                    }\r\n                }\r\n            }\r\n            setLoading(false);\r\n        }\r\n        loadProperties();\r\n    }, [selectedPropertyId, defaultAddress]);\r\n\r\n    const handleSelect = (property: VacantProperty) => {\r\n        setSelectedProperty(property);\r\n        setCreateMode(false);\r\n        onPropertySelect(property);\r\n        setOpen(false);\r\n    };\r\n\r\n    const handleCreateMode = () => {\r\n        setSelectedProperty(null);\r\n        setCreateMode(true);\r\n        onPropertySelect(null);\r\n        setOpen(false);\r\n    };\r\n\r\n    const _handleCreateSubmit = () => {\r\n        if (newProperty.title && newProperty.address && newProperty.price > 0) {\r\n            onCreateNew(newProperty);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-3\">\r\n            {/* S√©lecteur principal */}\r\n            <div className=\"space-y-2\">\r\n                <Label className=\"text-sm font-medium text-foreground/80\" required>\r\n                    Bien immobilier\r\n                </Label>\r\n\r\n                <Popover open={open} onOpenChange={setOpen}>\r\n                    <PopoverTrigger asChild>\r\n                        <Button\r\n                            variant=\"outline\"\r\n                            role=\"combobox\"\r\n                            aria-expanded={open}\r\n                            className={cn(\r\n                                \"w-full justify-between bg-background border-border text-foreground hover:bg-accent hover:text-accent-foreground\",\r\n                                !selectedProperty && !createMode && \"text-muted-foreground\"\r\n                            )}\r\n                        >\r\n                            {loading ? (\r\n                                <span className=\"flex items-center gap-2\">\r\n                                    <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                                    Chargement...\r\n                                </span>\r\n                            ) : selectedProperty ? (\r\n                                <span className=\"flex items-center gap-2 truncate\">\r\n                                    <Home className=\"w-4 h-4 text-primary shrink-0\" />\r\n                                    <span className=\"truncate\">{selectedProperty.title}</span>\r\n                                    <span className=\"text-muted-foreground text-xs shrink-0\">\r\n                                        {selectedProperty.price.toLocaleString()} FCFA\r\n                                    </span>\r\n                                </span>\r\n                            ) : createMode ? (\r\n                                <span className=\"flex items-center gap-2 text-primary\">\r\n                                    <Plus className=\"w-4 h-4\" />\r\n                                    Cr√©er un nouveau bien...\r\n                                </span>\r\n                            ) : (\r\n                                \"S√©lectionner un bien...\"\r\n                            )}\r\n                            <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                        </Button>\r\n                    </PopoverTrigger>\r\n\r\n                    <PopoverContent className=\"w-[calc(100vw-32px)] md:w-[400px] p-0 bg-popover border-border shadow-2xl\">\r\n                        <Command className=\"bg-popover\">\r\n                            <CommandInput\r\n                                placeholder=\"Rechercher un bien...\"\r\n                                className=\"text-foreground border-border\"\r\n                            />\r\n                            <CommandList>\r\n                                <CommandEmpty className=\"text-muted-foreground py-6 text-center\">\r\n                                    Aucun bien vacant trouv√©.\r\n                                </CommandEmpty>\r\n\r\n                                {properties.length > 0 && (\r\n                                    <CommandGroup heading=\"Biens vacants\" className=\"text-muted-foreground\">\r\n                                        {properties.map((property) => (\r\n                                            <CommandItem\r\n                                                key={property.id}\r\n                                                value={property.title}\r\n                                                onSelect={() => handleSelect(property)}\r\n                                                className=\"flex items-center gap-3 cursor-pointer text-foreground hover:bg-accent aria-selected:bg-accent\"\r\n                                            >\r\n                                                <Check\r\n                                                    className={cn(\r\n                                                        \"h-4 w-4 text-primary\",\r\n                                                        selectedProperty?.id === property.id\r\n                                                            ? \"opacity-100\"\r\n                                                            : \"opacity-0\"\r\n                                                    )}\r\n                                                />\r\n                                                <div className=\"flex-1 min-w-0\">\r\n                                                    <div className=\"font-medium truncate text-foreground\">{property.title}</div>\r\n                                                    <div className=\"text-xs text-muted-foreground flex items-center gap-1 truncate\">\r\n                                                        <MapPin className=\"w-3 h-3\" />\r\n                                                        {property.address}\r\n                                                    </div>\r\n                                                </div>\r\n                                                <div className=\"text-sm font-mono text-primary shrink-0\">\r\n                                                    {property.price.toLocaleString()} F\r\n                                                </div>\r\n                                            </CommandItem>\r\n                                        ))}\r\n                                    </CommandGroup>\r\n                                )}\r\n\r\n                                <CommandSeparator className=\"bg-border\" />\r\n\r\n                                <CommandGroup>\r\n                                    <CommandItem\r\n                                        value=\"__create_new_property__\"\r\n                                        onSelect={handleCreateMode}\r\n                                        className=\"flex items-center gap-2 cursor-pointer text-primary hover:bg-accent aria-selected:bg-accent\"\r\n                                    >\r\n                                        <Plus className=\"h-4 w-4\" />\r\n                                        <span className=\"font-medium\">Cr√©er un nouveau bien...</span>\r\n                                    </CommandItem>\r\n                                </CommandGroup>\r\n                            </CommandList>\r\n                        </Command>\r\n                    </PopoverContent>\r\n                </Popover>\r\n            </div>\r\n\r\n            {/* Badge r√©capitulatif si bien s√©lectionn√© */}\r\n            {selectedProperty && (\r\n                <div className=\"bg-primary/10 border border-primary/30 rounded-lg p-3 flex items-center gap-3\">\r\n                    <div className=\"w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center\">\r\n                        <Home className=\"w-5 h-5 text-primary\" />\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        <div className=\"font-semibold text-foreground truncate\">\r\n                            ‚úÖ {selectedProperty.title} s√©lectionn√©\r\n                        </div>\r\n                        <div className=\"text-xs text-muted-foreground truncate\">\r\n                            {selectedProperty.address} ‚Ä¢ {selectedProperty.price.toLocaleString()} FCFA/mois\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Formulaire de cr√©ation de bien en ligne */}\r\n            {createMode && (\r\n                <div className=\"bg-muted/30 border border-border rounded-lg p-4 space-y-4\">\r\n                    <div className=\"flex items-center gap-2 text-primary font-semibold\">\r\n                        <Plus className=\"w-4 h-4\" />\r\n                        Nouveau bien (cr√©ation rapide)\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-1 gap-3\">\r\n                        <div className=\"space-y-1\">\r\n                            <Label className=\"text-xs text-muted-foreground\" required>Nom du bien</Label>\r\n                            <Input\r\n                                placeholder=\"ex: Appart F2 Maristes\"\r\n                                value={newProperty.title}\r\n                                onChange={(e) =>\r\n                                    setNewProperty({ ...newProperty, title: e.target.value })\r\n                                }\r\n                                className=\"bg-background border-border text-foreground\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1\">\r\n                            <Label className=\"text-xs text-muted-foreground\" required>Adresse</Label>\r\n                            <Input\r\n                                placeholder=\"ex: 58 rue Mariste, Dakar\"\r\n                                value={newProperty.address}\r\n                                onChange={(e) =>\r\n                                    setNewProperty({ ...newProperty, address: e.target.value })\r\n                                }\r\n                                className=\"bg-background border-border text-foreground\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-1\">\r\n                            <Label className=\"text-xs text-muted-foreground\" required>Loyer mensuel (FCFA)</Label>\r\n                            <Input\r\n                                type=\"number\"\r\n                                placeholder=\"300000\"\r\n                                value={newProperty.price || \"\"}\r\n                                onChange={(e) =>\r\n                                    setNewProperty({\r\n                                        ...newProperty,\r\n                                        price: parseInt(e.target.value) || 0,\r\n                                    })\r\n                                }\r\n                                className=\"bg-background border-border text-foreground font-mono\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <p className=\"text-xs text-muted-foreground/60\">\r\n                        üí° Ce bien sera cr√©√© en mode &quot;brouillon&quot; (sans photos). Vous pourrez l&apos;enrichir plus tard.\r\n                    </p>\r\n                </div>\r\n            )}\r\n\r\n            {/* Champs cach√©s pour le formulaire parent */}\r\n            {selectedProperty && (\r\n                <>\r\n                    <input type=\"hidden\" name=\"property_id\" value={selectedProperty.id} />\r\n                    <input type=\"hidden\" name=\"property_address\" value={selectedProperty.address} />\r\n                    <input type=\"hidden\" name=\"monthly_amount_prefilled\" value={selectedProperty.price} />\r\n                </>\r\n            )}\r\n            {createMode && (\r\n                <>\r\n                    <input type=\"hidden\" name=\"create_new_property\" value=\"true\" />\r\n                    <input type=\"hidden\" name=\"new_property_title\" value={newProperty.title} />\r\n                    <input type=\"hidden\" name=\"new_property_address\" value={newProperty.address} />\r\n                    <input type=\"hidden\" name=\"new_property_price\" value={newProperty.price} />\r\n                </>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\QuickActions.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[481,484],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[481,484],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { _useState } from 'react';\nimport {\n    UserPlus,\n    FileText,\n    Download,\n    Bell,\n    Wrench,\n    MessageSquare,\n    ChevronRight\n} from 'lucide-react';\n\nimport Link from 'next/link';\nimport { AddTenantButton } from './AddTenantButton';\n\ninterface QuickActionsProps {\n    onAddTenant?: () => void;\n    onExportExcel?: () => void;\n    onSendReminders?: () => void;\n    pendingCount?: number;\n    overdueCount?: number;\n    ownerId: string;\n    profile: any;\n}\n\nexport function QuickActions({\n    _onAddTenant,\n    onExportExcel,\n    onSendReminders,\n    _pendingCount = 0,\n    overdueCount = 0,\n    ownerId,\n    profile\n}: QuickActionsProps) {\n\n    const actions = [\n        {\n            id: 'add-tenant',\n            label: 'Nouveau Locataire',\n            shortLabel: 'Nouveau',\n            icon: UserPlus,\n            type: 'custom' as const,\n        },\n        {\n            id: 'send-reminders',\n            label: 'Envoyer Relances',\n            shortLabel: 'Relances',\n            icon: Bell,\n            onClick: onSendReminders,\n            type: 'button' as const,\n            badge: overdueCount > 0 ? overdueCount : undefined,\n        },\n        {\n            id: 'interventions',\n            label: 'Interventions',\n            shortLabel: 'Travaux',\n            icon: Wrench,\n            href: '/interventions',\n            type: 'link' as const,\n        },\n        {\n            id: 'messages',\n            label: 'Messagerie',\n            shortLabel: 'Messages',\n            icon: MessageSquare,\n            href: '/gestion/messages',\n            type: 'link' as const,\n        },\n        {\n\n            id: 'legal',\n            label: 'Documents Juridiques',\n            shortLabel: 'Juridique',\n            icon: FileText,\n            href: '/documents-legaux',\n            type: 'link' as const,\n        },\n        {\n            id: 'export-excel',\n            label: 'Exporter Excel',\n            shortLabel: 'Excel',\n            icon: Download,\n            onClick: onExportExcel,\n            type: 'button' as const,\n        },\n    ];\n\n    const ActionContent = ({ action }: { action: typeof actions[0] }) => {\n        const Icon = action.icon;\n        return (\n            <>\n                <div className=\"\n                    p-2 rounded-lg bg-muted\n                    transition-transform duration-200\n                    group-hover:scale-110\n                \">\n                    <Icon className=\"w-4 h-4 text-foreground\" />\n                </div>\n                <span className=\"\n                    text-xs font-medium text-muted-foreground\n                    hidden sm:inline\n                    transition-colors duration-200\n                    group-hover:text-foreground\n                \">\n                    {action.label}\n                </span>\n                {/* Texte masqu√© sur mobile pour n'afficher que les ic√¥nes (alignement ic√¥nes uniquement) */}\n                <span className=\"\n                    text-xs font-medium text-muted-foreground\n                    hidden\n                    transition-colors duration-200\n                    group-hover:text-foreground\n                \">\n                    {action.shortLabel}\n                </span>\n                {action.badge && (\n                    <span className=\"absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center\">\n                        <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75\"></span>\n                        <span className=\"relative inline-flex rounded-full h-4 w-4 bg-red-500 text-[10px] text-white font-bold items-center justify-center\">\n                            {action.badge}\n                        </span>\n                    </span>\n                )}\n            </>\n        );\n    };\n\n    return (\n        <div id=\"tour-quick-actions\" className=\"mb-6\">\n            {/* Header */}\n            <div className=\"flex items-center gap-2 mb-3\">\n                <span className=\"text-xs font-semibold uppercase tracking-wider text-muted-foreground\">\n                    Actions Rapides\n                </span>\n                <div className=\"flex-1 h-px bg-border\"></div>\n            </div>\n\n            {/* Actions Grid */}\n            <div className=\"flex flex-wrap gap-2\">\n                {actions.map((action) => {\n                    const baseClasses = `\n                        relative flex items-center justify-center sm:justify-start\n                        gap-0 sm:gap-2 \n                        p-1 sm:px-3 sm:py-2\n                        rounded-xl border border-border bg-card\n                        transition-all duration-200\n                        cursor-pointer\n                        group\n                        hover:bg-muted\n                        min-w-[44px] sm:min-w-0\n                        h-[44px] sm:h-auto\n                    `;\n\n                    if (action.type === 'link') {\n                        return (\n                            <Link\n                                key={action.id}\n                                href={action.href!}\n                                className={baseClasses}\n                            >\n                                <ActionContent action={action} />\n                                <ChevronRight className=\"\n                                    hidden sm:block\n                                    w-3 h-3 text-muted-foreground/50\n                                    transition-all duration-200\n                                    opacity-0 group-hover:opacity-100\n                                    -translate-x-1 group-hover:translate-x-0\n                                \" />\n                            </Link>\n                        );\n                    }\n\n                    if (action.type === 'custom' && action.id === 'add-tenant') {\n                        return (\n                            <div key={action.id} id=\"tour-add-tenant\">\n                                <AddTenantButton\n                                    ownerId={ownerId}\n                                    profile={profile}\n                                    trigger={\n                                        <button className={baseClasses}>\n                                            <ActionContent action={action} />\n                                        </button>\n                                    }\n                                />\n                            </div>\n                        );\n                    }\n\n                    return (\n                        <button\n                            key={action.id}\n                            onClick={action.onClick}\n                            className={baseClasses}\n                            disabled={!action.onClick}\n                        >\n                            <ActionContent action={action} />\n                        </button>\n                    );\n                })}\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\QuotaBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\ReceiptModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'receiptDetails'. Either include it or remove the dependency array.","line":113,"column":8,"nodeType":"ArrayExpression","endLine":113,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, data, hasSaved, receiptDetails]","fix":{"range":[4118,4142],"text":"[isOpen, data, hasSaved, receiptDetails]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { X, Download, Mail } from 'lucide-react';\nimport { ReceiptPreview } from './ReceiptPreview';\nimport { Button } from '@/components/ui/button';\nimport { toast } from 'sonner';\nimport { PDFDownloadLink } from '@react-pdf/renderer';\nimport { createQuittanceDocument } from '@/components/pdf/QuittancePDF_v2';\n\ninterface ReceiptData {\n    leaseId?: string; // Pour stockage automatique du PDF\n    tenant?: {\n        tenant_name?: string;\n        name?: string;\n        email?: string;\n        phone?: string;\n        address?: string;\n    };\n    property_address?: string;\n    amount?: number;\n    period?: string;\n    month?: string | number;\n    year?: number;\n    periodStart?: string;\n    periodEnd?: string;\n    receiptNumber?: string;\n    userEmail?: string;\n    profile?: {\n        company_name?: string | null;\n        full_name?: string | null;\n        company_address?: string | null;\n        company_email?: string | null;\n        email?: string;\n        logo_url?: string | null;\n        signature_url?: string | null;\n        ninea?: string | null;\n        company_ninea?: string | null;\n    };\n    receiptImage?: string | null;\n}\n\ninterface ReceiptModalProps {\n    isOpen: boolean;\n    onClose: () => void;\n    data: ReceiptData | null;\n}\n\nexport function ReceiptModal({ isOpen, onClose, data }: ReceiptModalProps) {\n    const [isSending, setIsSending] = useState(false);\n    const [hasSaved, setHasSaved] = useState(false); // Eviter double save\n\n    // Pr√©parer les donn√©es pour le PDF (variable d√©riv√©e stable) - SAFE CHECK\n    const receiptDetails = data ? {\n        // IDs pour stockage automatique\n        leaseId: data.leaseId,\n\n        // Locataire\n        tenantName: data.tenant?.tenant_name || data.tenant?.name || 'Locataire',\n        tenantEmail: data.tenant?.email || '',\n        tenantPhone: data.tenant?.phone || '',\n        tenantAddress: data.property_address || '',\n\n        // Montants\n        amount: Number(data.amount) || 0,\n\n        // P√©riode\n        periodMonth: `${String(data.month).padStart(2, '0')}/${data.year}`,\n        periodStart: `01/${String(data.month).padStart(2, '0')}/${data.year}`,\n        periodEnd: `30/${String(data.month).padStart(2, '0')}/${data.year}`,\n\n        // R√©f√©rence\n        receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\n\n        // Propri√©taire\n        ownerName: data.profile?.company_name || data.profile?.full_name || 'Propri√©taire',\n        ownerAddress: data.profile?.company_address || '',\n        ownerNinea: data.profile?.company_ninea || '',\n        ownerLogo: data.profile?.logo_url || undefined,\n        ownerSignature: data.profile?.signature_url || undefined,\n        ownerEmail: data.profile?.company_email || undefined, // Email de config (priorit√©)\n        ownerAccountEmail: data.userEmail || undefined, // Email du compte (fallback)\n\n        // Propri√©t√©\n        propertyAddress: data.property_address || 'Adresse non renseign√©e',\n    } : null;\n\n    // Auto-save effect\n    useEffect(() => {\n        const autoSave = async () => {\n            // On ne sauvegarde que si on a un leaseId et que ce n'est pas d√©j√† fait\n            if (isOpen && receiptDetails?.leaseId && !hasSaved) {\n                console.log(\"üíæ Sauvegarde automatique de la quittance...\", receiptDetails.leaseId);\n                try {\n                    setHasSaved(true); // Optimistic blocking\n                    const response = await fetch('/api/save-receipt', {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(receiptDetails),\n                    });\n\n                    if (response.ok) {\n                        console.log(\"‚úÖ Quittance sauvegard√©e automatiquement\");\n                    } else {\n                        console.error(\"Erreur sauvegarde auto\", await response.text());\n                    }\n                } catch (e) {\n                    console.error(\"Auto-save error\", e);\n                }\n            }\n        };\n        autoSave();\n    }, [isOpen, data, hasSaved]); // data change = new receipt usually\n\n    if (!isOpen || !data || !receiptDetails) return null;\n\n\n    // Nom de fichier pour le t√©l√©chargement\n    const filename = `Quittance_${receiptDetails.tenantName.replace(/\\s+/g, '_')}_${String(data.month).padStart(2, '0')}_${data.year}.pdf`;\n\n    const handleSendEmail = async () => {\n        if (isSending) return;\n        setIsSending(true);\n\n        try {\n            console.log(\"üì§ Envoi de la quittance...\", receiptDetails);\n\n            // Appeler l'API Next.js interne\n            const response = await fetch('/api/send-receipt', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                },\n                body: JSON.stringify(receiptDetails),\n            });\n\n            const result = await response.json();\n\n            if (result.success) {\n                toast.success(`Quittance envoy√©e √† ${receiptDetails.tenantEmail} !`, {\n                    description: `N¬∞ ${receiptDetails.receiptNumber}`,\n                });\n            } else {\n                toast.error(\"Erreur : \" + (result.error || \"Probl√®me inconnu\"));\n            }\n        } catch (err) {\n            console.error(\"‚ùå Erreur technique:\", err);\n            toast.error(\"Erreur technique lors de l'envoi.\");\n        } finally {\n            setIsSending(false);\n        }\n    };\n\n\n    return (\n        <div\n            className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 print:p-0 print:bg-white print:block print:relative\"\n            onClick={onClose}\n        >\n            {/* Header Actions (Masqu√© √† l'impression) */}\n            {/* Boutons d'actions centr√©s */}\n            <div className=\"absolute top-4 left-1/2 -translate-x-1/2 z-50 print:hidden flex gap-2\">\n                {/* Bouton T√©l√©charger PDF avec @react-pdf/renderer */}\n                <PDFDownloadLink\n                    document={createQuittanceDocument(receiptDetails)}\n                    fileName={filename}\n                    className=\"inline-flex items-center gap-1 md:gap-2 bg-secondary text-secondary-foreground hover:bg-secondary/80 border-none shadow-md rounded-full text-xs md:text-sm px-3 md:px-4 h-9 md:h-10 font-medium transition-colors\"\n                    onClick={(e) => e.stopPropagation()}\n                >\n                    {({ loading }) => (\n                        <>\n                            {loading ? (\n                                <>\n                                    <div className=\"w-3 h-3 md:w-4 md:h-4 border-2 border-black border-t-transparent rounded-full animate-spin\" />\n                                    <span className=\"hidden sm:inline\">Pr√©paration...</span>\n                                    <span className=\"sm:hidden\">...</span>\n                                </>\n                            ) : (\n                                <>\n                                    <Download className=\"w-3 h-3 md:w-4 md:h-4\" />\n                                    <span className=\"hidden sm:inline\">T√©l√©charger PDF</span>\n                                    <span className=\"sm:hidden\">PDF</span>\n                                </>\n                            )}\n                        </>\n                    )}\n                </PDFDownloadLink>\n\n                {/* Bouton Envoyer par Email */}\n                <Button\n                    onClick={(e) => {\n                        e.stopPropagation();\n                        handleSendEmail();\n                    }}\n                    disabled={isSending}\n                    className=\"bg-primary text-primary-foreground hover:bg-primary/90 border-none shadow-md gap-1 md:gap-2 rounded-full text-xs md:text-sm px-3 md:px-4 h-9 md:h-10 font-semibold disabled:opacity-50 disabled:cursor-not-allowed\"\n                >\n                    {isSending ? (\n                        <>\n                            <div className=\"w-3 h-3 md:w-4 md:h-4 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n                            <span className=\"hidden sm:inline\">Envoi...</span>\n                        </>\n                    ) : (\n                        <>\n                            <Mail className=\"w-3 h-3 md:w-4 md:h-4\" />\n                            <span className=\"hidden sm:inline\">Envoyer par Email</span>\n                            <span className=\"sm:hidden\">Email</span>\n                        </>\n                    )}\n                </Button>\n            </div>\n\n            {/* Bouton Fermer √† droite */}\n            <Button\n                onClick={onClose}\n                variant=\"outline\"\n                className=\"absolute top-4 right-4 z-50 bg-primary/20 hover:bg-primary/30 text-primary hover:text-primary border-none shadow-md rounded-full h-9 md:h-10 w-9 md:w-10 p-0 print:hidden\"\n            >\n                <X className=\"w-4 h-4\" />\n            </Button>\n\n            <div\n                className=\"relative w-full max-w-4xl bg-card rounded-2xl md:rounded-[2.5rem] overflow-hidden shadow-2xl border border-border print:shadow-none print:border-none print:w-full print:max-w-none print:rounded-none print:bg-white\"\n                onClick={(e) => e.stopPropagation()}\n            >\n                <div className=\"p-4 md:p-8 max-h-[85vh] md:max-h-[90vh] overflow-y-auto bg-muted/30 flex justify-center print:max-h-none print:overflow-visible print:p-0 print:bg-white\">\n                    <ReceiptPreview\n                        tenant={{\n                            tenant_name: data.tenant?.tenant_name || data.tenant?.name || 'Locataire',\n                            address: data.property_address || data.tenant?.address || ''\n                        }}\n                        profile={{\n                            company_name: data.profile?.company_name || data.profile?.full_name || 'Propri√©taire',\n                            company_address: data.profile?.company_address || '',\n                            company_ninea: data.profile?.company_ninea || data.profile?.ninea || undefined,\n                            logo_url: data.profile?.logo_url || undefined,\n                            signature_url: data.profile?.signature_url || undefined\n                        }}\n                        amount={data.amount || 0}\n                        month={data.month || new Date().getMonth() + 1}\n                        year={data.year || new Date().getFullYear()}\n                    />\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\ReceiptPreview.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":37,"column":25,"nodeType":"JSXOpeningElement","endLine":37,"endColumn":110,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":97,"column":29,"nodeType":"JSXOpeningElement","endLine":97,"endColumn":127,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\RentalStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\RevenueChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\RevenueChart.tsx:33:9\n  31 |\n  32 |     useEffect(() => {\n> 33 |         setMounted(true);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  34 |         const checkMobile = () => setIsMobile(window.innerWidth < 640);\n  35 |         checkMobile();\n  36 |         window.addEventListener(\"resize\", checkMobile);","line":33,"column":9,"nodeType":null,"endLine":33,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1596,1599],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1596,1599],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1899,1902],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1899,1902],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\RevenueChart.tsx:173:44\n  171 |                             axisLine={{ stroke: \"currentColor\", className: \"text-border\" }}\n  172 |                         />\n> 173 |                         <Tooltip content={<CustomTooltip />} />\n      |                                            ^^^^^^^^^^^^^ This component is created during render\n  174 |                         {showExpected && (\n  175 |                             <Area\n  176 |                                 type=\"monotone\"\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\RevenueChart.tsx:57:27\n  55 |\n  56 |     // Custom tooltip\n> 57 |     const CustomTooltip = ({ active, payload, label }: any) => {\n     |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 58 |         if (active && payload && payload.length) {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 59 |             return (\n     ‚Ä¶\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 79 |         return null;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 80 |     };\n     | ^^^^^^ The component is created during render here\n  81 |\n  82 |     if (!mounted || data.length === 0) {\n  83 |         return (","line":173,"column":44,"nodeType":null,"endLine":173,"endColumn":57}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport {\r\n    AreaChart,\r\n    Area,\r\n    XAxis,\r\n    YAxis,\r\n    CartesianGrid,\r\n    Tooltip,\r\n    ResponsiveContainer,\r\n    _Legend,\r\n} from \"recharts\";\r\nimport { TrendingUp } from \"lucide-react\";\r\n\r\ninterface RevenueHistoryItem {\r\n    month: string;\r\n    year: number;\r\n    monthNum: number;\r\n    collected: number;\r\n    expected: number;\r\n}\r\n\r\ninterface RevenueChartProps {\r\n    data: RevenueHistoryItem[];\r\n}\r\n\r\nexport function RevenueChart({ data }: RevenueChartProps) {\r\n    const [mounted, setMounted] = useState(false);\r\n    const [isMobile, setIsMobile] = useState(false);\r\n\r\n    useEffect(() => {\r\n        setMounted(true);\r\n        const checkMobile = () => setIsMobile(window.innerWidth < 640);\r\n        checkMobile();\r\n        window.addEventListener(\"resize\", checkMobile);\r\n        return () => window.removeEventListener(\"resize\", checkMobile);\r\n    }, []);\r\n\r\n    const [showExpected, setShowExpected] = useState(true);\r\n\r\n    // Format data for display\r\n    const chartData = data.map((item) => ({\r\n        name: `${item.month} ${item.year}`,\r\n        collected: item.collected,\r\n        expected: item.expected,\r\n    }));\r\n\r\n    // Calculate totals for summary\r\n    const totalCollected = data.reduce((sum, d) => sum + d.collected, 0);\r\n    const totalExpected = data.reduce((sum, d) => sum + d.expected, 0);\r\n    const collectionRate = totalExpected > 0\r\n        ? Math.round((totalCollected / totalExpected) * 100)\r\n        : 100;\r\n\r\n    // Custom tooltip\r\n    const CustomTooltip = ({ active, payload, label }: any) => {\r\n        if (active && payload && payload.length) {\r\n            return (\r\n                <div className=\"p-3 rounded-lg shadow-lg border border-border bg-card text-card-foreground\">\r\n                    <p className=\"font-semibold mb-2\">{label}</p>\r\n                    {payload.map((entry: any, index: number) => (\r\n                        <p key={index} className=\"text-sm flex items-center gap-2\">\r\n                            <span\r\n                                className=\"w-3 h-3 rounded-full\"\r\n                                style={{ backgroundColor: entry.color }}\r\n                            />\r\n                            <span className=\"text-muted-foreground\">\r\n                                {entry.name === \"collected\" ? \"Encaiss√©\" : \"Attendu\"}:\r\n                            </span>\r\n                            <span className=\"font-mono font-medium\">\r\n                                {entry.value.toLocaleString('fr-FR')} FCFA\r\n                            </span>\r\n                        </p>\r\n                    ))}\r\n                </div>\r\n            );\r\n        }\r\n        return null;\r\n    };\r\n\r\n    if (!mounted || data.length === 0) {\r\n        return (\r\n            <div className=\"p-6 rounded-xl border border-border bg-muted/20 min-h-[300px] flex items-center justify-center\">\r\n                <div className=\"text-center space-y-2\">\r\n                    <TrendingUp className=\"w-5 h-5 text-primary mx-auto animate-pulse\" />\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                        {!mounted ? \"Chargement du graphique...\" : \"Pas encore de donn√©es.\"}\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div id=\"tour-gestion-revenue-chart\" className=\"p-6 rounded-xl border border-border bg-card\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <TrendingUp className=\"w-5 h-5 text-primary\" />\r\n                    <h3 className=\"font-semibold text-foreground\">\r\n                        √âvolution des Revenus\r\n                    </h3>\r\n                </div>\r\n                <div className=\"flex items-center gap-4 text-sm\">\r\n                    <div className=\"text-center\">\r\n                        <p className=\"font-mono font-bold text-green-600 dark:text-green-500\">\r\n                            {totalCollected.toLocaleString('fr-FR')}\r\n                        </p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                            Encaiss√©\r\n                        </p>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                        <p className={`font-bold ${collectionRate >= 90 ? \"text-green-500\" : collectionRate >= 70 ? \"text-yellow-500\" : \"text-red-500\"}`}>\r\n                            {collectionRate}%\r\n                        </p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                            Taux\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Toggle */}\r\n            <div className=\"flex items-center gap-2 mb-4\">\r\n                <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                    <input\r\n                        type=\"checkbox\"\r\n                        checked={showExpected}\r\n                        onChange={(e) => setShowExpected(e.target.checked)}\r\n                        className=\"w-4 h-4 rounded border-border bg-background text-primary focus:ring-primary\"\r\n                    />\r\n                    <span className=\"text-xs text-muted-foreground\">\r\n                        Afficher attendu\r\n                    </span>\r\n                </label>\r\n            </div>\r\n\r\n            {/* Chart */}\r\n            <div className=\"h-[250px] min-h-[250px] w-full\">\r\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                    <AreaChart data={chartData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>\r\n                        <defs>\r\n                            <linearGradient id=\"colorCollected\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                <stop offset=\"5%\" stopColor=\"#F4C430\" stopOpacity={0.8} />\r\n                                <stop offset=\"95%\" stopColor=\"#F4C430\" stopOpacity={0.1} />\r\n                            </linearGradient>\r\n                            <linearGradient id=\"colorExpected\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                                <stop offset=\"5%\" stopColor=\"#6366f1\" stopOpacity={0.5} />\r\n                                <stop offset=\"95%\" stopColor=\"#6366f1\" stopOpacity={0.05} />\r\n                            </linearGradient>\r\n                        </defs>\r\n                        <CartesianGrid\r\n                            strokeDasharray=\"3 3\"\r\n                            stroke=\"currentColor\"\r\n                            className=\"text-border\"\r\n                        />\r\n                        <XAxis\r\n                            dataKey=\"name\"\r\n                            tick={{ fill: \"currentColor\", fontSize: isMobile ? 9 : 11 }}\r\n                            className=\"text-muted-foreground\"\r\n                            tickLine={false}\r\n                            axisLine={{ stroke: \"currentColor\", className: \"text-border\" }}\r\n                        />\r\n                        <YAxis\r\n                            tick={{ fill: \"currentColor\", fontSize: isMobile ? 9 : 11 }}\r\n                            className=\"text-muted-foreground\"\r\n                            tickFormatter={(value) => `${(value / 1000).toFixed(0)}k`}\r\n                            tickLine={false}\r\n                            axisLine={{ stroke: \"currentColor\", className: \"text-border\" }}\r\n                        />\r\n                        <Tooltip content={<CustomTooltip />} />\r\n                        {showExpected && (\r\n                            <Area\r\n                                type=\"monotone\"\r\n                                dataKey=\"expected\"\r\n                                stroke=\"#6366f1\"\r\n                                fillOpacity={1}\r\n                                fill=\"url(#colorExpected)\"\r\n                                strokeWidth={2}\r\n                                name=\"expected\"\r\n                            />\r\n                        )}\r\n                        <Area\r\n                            type=\"monotone\"\r\n                            dataKey=\"collected\"\r\n                            stroke=\"#F4C430\"\r\n                            fillOpacity={1}\r\n                            fill=\"url(#colorCollected)\"\r\n                            strokeWidth={2}\r\n                            name=\"collected\"\r\n                        />\r\n                    </AreaChart>\r\n                </ResponsiveContainer>\r\n            </div>\r\n\r\n            {/* Legend */}\r\n            <div className=\"flex items-center justify-center gap-6 mt-4 text-xs\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <span className=\"w-3 h-3 rounded-full bg-primary\" />\r\n                    <span className=\"text-muted-foreground\">Encaiss√©</span>\r\n                </div>\r\n                {showExpected && (\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <span className=\"w-3 h-3 rounded-full bg-indigo-500\" />\r\n                        <span className=\"text-muted-foreground\">Attendu</span>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\RevenueChartSafe.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[954,957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[954,957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport dynamic from \"next/dynamic\";\r\nimport { _Suspense } from 'react';\r\nimport { _Loader2, TrendingUp } from 'lucide-react';\r\n// import { RevenueChart } from './RevenueChart';\r\n\r\n// Dynamically import the RevenueChart with SSR disabled\r\n// This must be done in a Client Component to avoid the Vercel build error\r\nconst RevenueChart = dynamic(\r\n    () => import(\"./RevenueChart\").then((mod) => mod.RevenueChart),\r\n    {\r\n        ssr: false,\r\n        loading: () => (\r\n            <div className=\"h-[300px] w-full bg-muted/10 animate-pulse rounded-xl flex items-center justify-center text-xs text-muted-foreground\">\r\n                <div className=\"text-center space-y-2\">\r\n                    <TrendingUp className=\"w-5 h-5 text-primary mx-auto animate-pulse\" />\r\n                    <p>Initialisation du graphique...</p>\r\n                </div>\r\n            </div>\r\n        ),\r\n    }\r\n);\r\n\r\ninterface RevenueChartSafeProps {\r\n    data: any[];\r\n}\r\n\r\nexport function RevenueChartSafe({ data }: RevenueChartSafeProps) {\r\n    if (typeof window !== 'undefined') {\r\n         \r\n        console.log(\"[RevenueChartSafe] Rendering\", { dataPoints: data?.length });\r\n    }\r\n    return <RevenueChart data={data} />;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\SendRemindersButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantCardGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantList.tsx","messages":[{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantList.tsx:256:41\n  254 |                 periodStart: periodStartDate.toLocaleDateString('fr-FR'),\n  255 |                 periodEnd: periodEndDate.toLocaleDateString('fr-FR'),\n> 256 |                 receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\n      |                                         ^^^^^^^^^^ Cannot call impure function\n  257 |                 ownerName: landlordName,\n  258 |                 ownerAddress: landlordAddress,\n  259 |                 ownerNinea: profile?.company_ninea || undefined,","line":256,"column":41,"nodeType":null,"endLine":256,"endColumn":51}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { ReceiptModal } from './ReceiptModal';\nimport { useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { User, Phone, Calendar, Edit2, X, Check, Mail, MapPin, Loader2, CheckCircle, Eye, Trash2, RotateCcw } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { updateLease, confirmPayment, terminateLease, reactivateLease } from '../actions';\nimport { toast } from 'sonner';\n\ninterface Tenant {\n    id: string;\n    name: string;\n    property: string;\n    phone?: string;\n    email?: string;\n    rentAmount: number;\n    status: 'paid' | 'pending' | 'overdue';\n    dueDate?: number;\n    startDate?: string;\n    last_transaction_id?: string;\n    // DONN√âES DE P√âRIODE (depuis la DB, pas calcul√©es!)\n    period_month?: number;\n    period_year?: number;\n    period_start?: string | null;\n    period_end?: string | null;\n}\n\ninterface ProfileData {\n    company_name?: string | null;\n    full_name?: string | null;\n    company_address?: string | null;\n    company_email?: string | null;\n    company_ninea?: string | null;\n    signature_url?: string | null;\n    logo_url?: string | null;\n}\n\ninterface TenantListProps {\n    tenants?: Tenant[];\n    profile?: ProfileData | null;\n    userEmail?: string;\n    isViewingTerminated?: boolean;\n}\n\nconst statusColors = {\n    paid: 'bg-green-500/20 text-green-400 border-green-500/30',\n    pending: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',\n    overdue: 'bg-red-500/20 text-red-400 border-red-500/30'\n};\n\nconst statusLabels = {\n    paid: 'Pay√©',\n    pending: 'En attente',\n    overdue: 'Retard'\n};\n\nexport function TenantList({ tenants = [], profile, userEmail, isViewingTerminated = false }: TenantListProps) {\n    const router = useRouter();\n    const [editingId, setEditingId] = useState<string | null>(null);\n    const [editData, setEditData] = useState<Partial<Tenant>>({});\n    const [saving, setSaving] = useState(false);\n\n    // √âtat pour la modale de quittance\n    const [isReceiptOpen, setIsReceiptOpen] = useState(false);\n    const [currentReceipt, setCurrentReceipt] = useState<{\n        tenant: {\n            tenant_name: string;\n            email?: string;\n            phone?: string;\n            address: string;\n        };\n        profile: {\n            company_name: string;\n            company_address: string;\n            company_email?: string;\n            company_ninea?: string;\n            logo_url?: string;\n            signature_url?: string;\n        };\n        userEmail?: string;\n        amount: number;\n        month: string;\n        year: number;\n        property_address: string;\n    } | null>(null);\n\n    const getInitials = (name: string) => {\n        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n    };\n\n    const formatAmount = (amount: number) => {\n        return amount.toLocaleString('fr-FR');\n    };\n\n    const handleEdit = (tenant: Tenant) => {\n        setEditingId(tenant.id);\n        setEditData({\n            name: tenant.name,\n            phone: tenant.phone || '',\n            email: tenant.email || '',\n            property: tenant.property,\n            rentAmount: tenant.rentAmount,\n            dueDate: tenant.dueDate,\n            startDate: tenant.startDate\n        });\n    };\n\n    const handleCancelEdit = () => {\n        setEditingId(null);\n        setEditData({});\n    };\n\n    const handleSaveEdit = async () => {\n        if (!editingId || !editData.email) {\n            toast.error('L\\'email est obligatoire');\n            return;\n        }\n\n        setSaving(true);\n        const result = await updateLease(editingId, {\n            tenant_name: editData.name,\n            tenant_phone: editData.phone,\n            tenant_email: editData.email,\n            property_address: editData.property,\n            monthly_amount: editData.rentAmount,\n            billing_day: editData.dueDate,\n            start_date: editData.startDate\n        });\n        setSaving(false);\n\n        if (result.success) {\n            toast.success('Locataire mis √† jour!');\n            setEditingId(null);\n            setEditData({});\n            router.refresh(); // Rafra√Æchir pour afficher les nouvelles donn√©es\n        } else {\n            toast.error(result.error || 'Erreur lors de la mise √† jour');\n        }\n    };\n\n    const handleTerminateLease = async (leaseId: string, tenantName: string) => {\n        // Confirmation avant r√©siliation\n        const confirmed = window.confirm(\n            `‚ö†Ô∏è Voulez-vous vraiment r√©silier le bail de ${tenantName} ?\\n\\n` +\n            `Le locataire n&apos;appara√Ætra plus dans la liste active, mais l&apos;historique des paiements sera conserv√©.`\n        );\n\n        if (!confirmed) return;\n\n        setSaving(true);\n        const result = await terminateLease(leaseId);\n        setSaving(false);\n\n        if (result.success) {\n            toast.success(result.message || 'Bail r√©sili√© avec succ√®s');\n            router.refresh(); // Rafra√Æchir pour mettre √† jour la liste\n        } else {\n            toast.error(result.error || 'Erreur lors de la r√©siliation');\n        }\n    };\n\n    const handleReactivateLease = async (leaseId: string, tenantName: string) => {\n        // Confirmation avant r√©activation\n        const confirmed = window.confirm(\n            `‚úÖ Voulez-vous r√©activer le bail de ${tenantName} ?\\n\\n` +\n            `Le locataire r√©appara√Ætra dans la liste active et le Cron g√©n√©rera automatiquement les prochaines √©ch√©ances.`\n        );\n\n        if (!confirmed) return;\n\n        setSaving(true);\n        const result = await reactivateLease(leaseId);\n        setSaving(false);\n\n        if (result.success) {\n            toast.success(result.message || 'Bail r√©activ√© avec succ√®s');\n            router.refresh(); // Rafra√Æchir pour mettre √† jour la liste\n        } else {\n            toast.error(result.error || 'Erreur lors de la r√©activation');\n        }\n    };\n\n    const handleConfirmPayment = async (leaseId: string, transactionId?: string) => {\n        // Trouver le locataire pour les donn√©es de la quittance\n        const tenant = tenants.find(t => t.id === leaseId);\n\n        if (!tenant) {\n            toast.error('Locataire introuvable');\n            return;\n        }\n\n        // √âtape 1: Marquer comme pay√© dans la DB\n        const result = await confirmPayment(leaseId, transactionId);\n\n        if (!result.success) {\n            toast.error(result.error || 'Erreur inconnue', {\n                description: \"Vous pouvez toujours g√©n√©rer la quittance manuellement via le bouton &quot;Voir quittance&quot;.\",\n                duration: 7000,\n            });\n            return;\n        }\n\n        // √âtape 2: Demander si on envoie la quittance\n        const shouldSendReceipt = window.confirm(\n            `Le loyer est marqu√© comme pay√©. Souhaitez-vous envoyer imm√©diatement la quittance par email √† ${tenant.name} ?`\n        );\n\n        if (shouldSendReceipt) {\n            // V√©rifier si l'email existe\n            if (!tenant.email) {\n                toast.error('Email manquant pour ce locataire', {\n                    description: \"Modifiez le locataire pour ajouter son email.\",\n                    duration: 5000,\n                });\n                return;\n            }\n\n            // V√©rifier si l'adresse du bien est renseign√©e\n            if (!tenant.property || tenant.property === 'Adresse non renseign√©e') {\n                toast.error('Adresse du bien manquante', {\n                    description: \"Veuillez modifier le locataire et ajouter l&apos;adresse du bien avant d&apos;envoyer la quittance.\",\n                    duration: 6000,\n                });\n                return;\n            }\n\n            // Pr√©parer les donn√©es pour la quittance\n            const landlordName = profile?.company_name || profile?.full_name || \"Propri√©taire\";\n            const landlordAddress = profile?.company_address || \"Adresse non renseign√©e\";\n\n            // üö® CRITIQUE: Utiliser les donn√©es de la transaction (DB), PAS new Date()\n            const periodMonth = tenant.period_month?.toString().padStart(2, '0') || '01';\n            const periodYear = tenant.period_year || new Date().getFullYear();\n\n            // Calculer les dates de d√©but/fin si non pr√©sentes (fallback)\n            const periodStartDate = tenant.period_start\n                ? new Date(tenant.period_start)\n                : new Date(periodYear, parseInt(periodMonth) - 1, 1);\n\n            const periodEndDate = tenant.period_end\n                ? new Date(tenant.period_end)\n                : new Date(periodYear, parseInt(periodMonth), 0);\n\n            const receiptData = {\n                tenantName: tenant.name,\n                tenantEmail: tenant.email,\n                tenantPhone: tenant.phone || '',\n                tenantAddress: tenant.property,\n                amount: Number(tenant.rentAmount) || 0,\n                // DONN√âES DYNAMIQUES depuis la DB (transaction)\n                periodMonth: `${periodMonth}/${periodYear}`,\n                periodStart: periodStartDate.toLocaleDateString('fr-FR'),\n                periodEnd: periodEndDate.toLocaleDateString('fr-FR'),\n                receiptNumber: `QUITT-${Date.now().toString().slice(-6)}`,\n                ownerName: landlordName,\n                ownerAddress: landlordAddress,\n                ownerNinea: profile?.company_ninea || undefined,\n                ownerLogo: profile?.logo_url || undefined,\n                ownerSignature: profile?.signature_url || undefined,\n                ownerEmail: profile?.company_email || undefined, // Email de config (priorit√©)\n                ownerAccountEmail: userEmail || undefined, // Email du compte (fallback)\n                propertyAddress: tenant.property,\n            };\n\n            // Envoyer la quittance\n            toast.promise(\n                fetch('/api/send-receipt', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(receiptData),\n                }).then(async (res) => {\n                    const data = await res.json();\n                    if (!res.ok) throw new Error(data.error || 'Erreur lors de l&apos;envoi');\n                    return data;\n                }),\n                {\n                    loading: 'Envoi de la quittance par email...',\n                    success: 'Quittance envoy√©e avec succ√®s !',\n                    error: (err) => `Erreur: ${err.message}`,\n                }\n            );\n        } else {\n            // Juste confirmer le paiement sans envoi\n            toast.success(result.message || \"Paiement enregistr√© avec succ√®s !\", {\n                duration: 5000,\n            });\n        }\n\n        // IMPORTANT: Rafra√Æchir la page pour afficher le nouveau statut \"paid\"\n        // Cela recharge les donn√©es depuis le serveur et met √† jour TOUS les locataires\n        router.refresh();\n    };\n\n    // --- LOGIQUE QUITTANCE ---\n    const handleViewReceipt = (tenant: Tenant) => {\n        // Extraction s√©curis√©e des infos avec fallback intelligent\n        const landlordName = profile?.company_name || profile?.full_name || \"Propri√©taire (non configur√©)\";\n        const landlordAddress = profile?.company_address || \"Adresse (non configur√©e)\";\n\n        const safeProfile = {\n            company_name: landlordName,\n            company_address: landlordAddress,\n            company_email: profile?.company_email || undefined,\n            company_ninea: profile?.company_ninea || undefined,\n            logo_url: profile?.logo_url || undefined,\n            signature_url: profile?.signature_url || undefined\n        };\n\n        // Avertissement si le profil n'est pas complet\n        if (!profile?.company_name && !profile?.full_name) {\n            toast.warning(\"Info: Configurez votre profil pour personnaliser la quittance.\", {\n                duration: 5000,\n            });\n        }\n\n        // üö® CRITIQUE: Utiliser les donn√©es de la transaction (DB), PAS new Date()\n        const periodMonth = tenant.period_month?.toString().padStart(2, '0') || '01';\n        const periodYear = tenant.period_year || new Date().getFullYear();\n\n        setCurrentReceipt({\n            tenant: {\n                tenant_name: tenant.name,\n                email: tenant.email,\n                phone: tenant.phone,\n                address: tenant.property\n            },\n            profile: safeProfile,\n            userEmail: userEmail, // Email du compte pour fallback\n            amount: tenant.rentAmount,\n            // DONN√âES DYNAMIQUES depuis la DB (transaction)\n            month: periodMonth,\n            year: periodYear,\n            property_address: tenant.property\n        });\n        setIsReceiptOpen(true);\n    };\n\n    return (\n        <div className=\"space-y-3\">\n            {/* Modale Quittance */}\n            <ReceiptModal\n                isOpen={isReceiptOpen}\n                onClose={() => setIsReceiptOpen(false)}\n                data={currentReceipt}\n            />\n            {tenants.length > 0 ? (\n                <div className=\"max-h-[600px] overflow-y-auto pr-2 space-y-3 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-900 [&::-webkit-scrollbar-thumb]:bg-gray-700 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-thumb]:hover:bg-gray-600\">\n                    {tenants.map((tenant) => (\n                        <div\n                            key={tenant.id}\n                            className={`p-4 rounded-xl border transition-all w-full max-w-[100vw] overflow-hidden ${editingId === tenant.id\n                                ? 'bg-blue-500/5 border-blue-500/30 ring-1 ring-blue-500/20'\n                                : 'bg-gray-900/40 border-gray-800 hover:border-gray-700'\n                                }`}\n                        >\n                            {editingId === tenant.id ? (\n                                // ===== MODE √âDITION =====\n                                <div className=\"space-y-4\">\n                                    <div className=\"flex items-center justify-between\">\n                                        <h4 className=\"text-sm font-bold text-blue-400 flex items-center gap-2\">\n                                            <Edit2 className=\"w-4 h-4\" /> Modification\n                                        </h4>\n                                        <Button\n                                            variant=\"ghost\"\n                                            size=\"sm\"\n                                            onClick={handleCancelEdit}\n                                            className=\"text-gray-400 hover:text-white h-8 px-2\"\n                                        >\n                                            <X className=\"w-4 h-4\" />\n                                        </Button>\n                                    </div>\n\n                                    <div className=\"grid grid-cols-1 gap-3\">\n                                        <Input\n                                            placeholder=\"Nom complet\"\n                                            value={editData.name || ''}\n                                            onChange={(e) => setEditData({ ...editData, name: e.target.value })}\n                                            className=\"bg-gray-800/50 border-gray-700 h-10\"\n                                        />\n                                        <Input\n                                            type=\"email\"\n                                            placeholder=\"Email *\"\n                                            value={editData.email || ''}\n                                            onChange={(e) => setEditData({ ...editData, email: e.target.value })}\n                                            className={`bg-gray-800/50 border-gray-700 h-10 ${!editData.email ? 'border-red-500/50' : ''}`}\n                                        />\n                                        <Input\n                                            placeholder=\"T√©l√©phone\"\n                                            value={editData.phone || ''}\n                                            onChange={(e) => setEditData({ ...editData, phone: e.target.value })}\n                                            className=\"bg-gray-800/50 border-gray-700 h-10\"\n                                        />\n                                        <Input\n                                            type=\"number\"\n                                            placeholder=\"Loyer FCFA\"\n                                            value={editData.rentAmount || ''}\n                                            onChange={(e) => setEditData({ ...editData, rentAmount: Number(e.target.value) })}\n                                            className=\"bg-gray-800/50 border-gray-700 h-10\"\n                                        />\n                                        <div className=\"flex items-center gap-2\">\n                                            <span className=\"text-xs text-gray-500 whitespace-nowrap\">Jour fact.</span>\n                                            <Input\n                                                type=\"number\"\n                                                min={1}\n                                                max={31}\n                                                placeholder=\"Ex: 5\"\n                                                value={editData.dueDate || ''}\n                                                onChange={(e) => setEditData({ ...editData, dueDate: Number(e.target.value) })}\n                                                className=\"bg-gray-800/50 border-gray-700 h-10 w-20\"\n                                            />\n                                            <span className=\"text-xs text-gray-500 whitespace-nowrap ml-2\">D√©but bail</span>\n                                            <Input\n                                                type=\"date\"\n                                                value={editData.startDate || ''}\n                                                onChange={(e) => setEditData({ ...editData, startDate: e.target.value })}\n                                                className=\"bg-gray-800/50 border-gray-700 h-10\"\n                                            />\n                                        </div>\n                                    </div>\n\n                                    <Input\n                                        placeholder=\"Adresse du bien lou√© *\"\n                                        value={editData.property || ''}\n                                        onChange={(e) => setEditData({ ...editData, property: e.target.value })}\n                                        className={`bg-gray-800/50 border-gray-700 h-10 ${!editData.property || editData.property === 'Adresse non renseign√©e' ? 'border-brand/50' : ''}`}\n                                    />\n\n                                    <div className=\"flex gap-2\">\n                                        <Button\n                                            onClick={handleSaveEdit}\n                                            disabled={saving || !editData.email}\n                                            className=\"flex-1 bg-green-600 hover:bg-green-700 h-10\"\n                                        >\n                                            {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <><Check className=\"w-4 h-4 mr-2\" /> Enregistrer</>}\n                                        </Button>\n                                        {isViewingTerminated ? (\n                                            <Button\n                                                onClick={() => handleReactivateLease(tenant.id, tenant.name)}\n                                                disabled={saving}\n                                                variant=\"outline\"\n                                                className=\"border-green-500/50 text-green-400 hover:bg-green-500/10 hover:text-green-300 h-10 px-4\"\n                                                title=\"R√©activer le bail\"\n                                            >\n                                                <RotateCcw className=\"w-4 h-4\" />\n                                            </Button>\n                                        ) : (\n                                            <Button\n                                                onClick={() => handleTerminateLease(tenant.id, tenant.name)}\n                                                disabled={saving}\n                                                variant=\"outline\"\n                                                className=\"border-red-500/50 text-red-400 hover:bg-red-500/10 hover:text-red-300 h-10 px-4\"\n                                                title=\"R√©silier le bail (conserve l'historique)\"\n                                            >\n                                                <Trash2 className=\"w-4 h-4\" />\n                                            </Button>\n                                        )}\n                                    </div>\n                                </div>\n                            ) : (\n                                // ===== MODE AFFICHAGE =====\n                                <div className=\"space-y-3\">\n                                    {/* Ligne 1: Avatar + Nom + Statut */}\n                                    <div className=\"flex items-center gap-3\">\n                                        <div className=\"w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm shrink-0\">\n                                            {getInitials(tenant.name)}\n                                        </div>\n                                        <div className=\"flex-1 min-w-0\">\n                                            <h3 className=\"font-semibold text-white truncate text-sm\">{tenant.name}</h3>\n                                            <p className=\"text-xs text-gray-500 truncate\">{tenant.property}</p>\n                                        </div>\n                                        <span className={`px-2 py-1 rounded-lg text-[10px] font-medium border shrink-0 ${statusColors[tenant.status] || statusColors.pending}`}>\n                                            {statusLabels[tenant.status] || 'En attente'}\n                                        </span>\n                                    </div>\n\n                                    {/* Ligne 2: Infos + Montant */}\n                                    <div className=\"flex items-center justify-between text-xs text-gray-400 pl-[52px]\">\n                                        <div className=\"flex items-center gap-4 overflow-hidden\">\n                                            {tenant.phone && (\n                                                <span className=\"flex items-center gap-1 shrink-0\">\n                                                    <Phone className=\"w-3 h-3\" /> {tenant.phone}\n                                                </span>\n                                            )}\n                                            {tenant.dueDate && (\n                                                <span className=\"flex items-center gap-1 shrink-0\">\n                                                    <Calendar className=\"w-3 h-3\" /> {tenant.dueDate} du mois\n                                                </span>\n                                            )}\n                                        </div>\n                                        <div className=\"text-right shrink-0\">\n                                            <span className=\"text-white font-bold text-base\">{formatAmount(tenant.rentAmount)}</span>\n                                            <span className=\"text-gray-500 ml-1\">FCFA/mois</span>\n                                        </div>\n                                    </div>\n\n                                    {/* Ligne 3: Warning email/adresse + Actions */}\n                                    <div className=\"flex items-center justify-between pl-[52px]\">\n                                        <div className=\"flex flex-col gap-1\">\n                                            {!tenant.email ? (\n                                                <span className=\"text-xs text-red-400 flex items-center gap-1\">\n                                                    <Mail className=\"w-3 h-3\" /> Email manquant\n                                                </span>\n                                            ) : (\n                                                <span className=\"text-xs text-gray-600 truncate\">{tenant.email}</span>\n                                            )}\n                                            {(!tenant.property || tenant.property === 'Adresse non renseign√©e') && (\n                                                <span className=\"text-xs text-brand flex items-center gap-1\">\n                                                    <MapPin className=\"w-3 h-3\" /> Adresse manquante\n                                                </span>\n                                            )}\n                                        </div>\n\n                                        <div className=\"flex items-center gap-2 mt-4\">\n                                            {/* Bouton \"Marquer pay√©\" pour pending ET overdue */}\n                                            {(tenant.status === 'pending' || tenant.status === 'overdue') && (\n                                                <Button\n                                                    size=\"sm\"\n                                                    onClick={() => handleConfirmPayment(tenant.id, tenant.last_transaction_id)}\n                                                    className={`${tenant.status === 'overdue'\n                                                        ? 'bg-brand hover:bg-brand/90 shadow-brand/20 text-black'\n                                                        : 'bg-green-600 hover:bg-green-700 shadow-green-500/20'\n                                                        } text-white font-bold rounded-xl h-9 shadow-lg transition-all active:scale-95`}\n                                                >\n                                                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                                                    {tenant.status === 'overdue' ? 'Paiement re√ßu' : 'Marquer pay√©'}\n                                                </Button>\n                                            )}\n                                            {/* Bouton \"Voir quittance\" uniquement pour paid */}\n                                            {tenant.status === 'paid' && (\n                                                <button\n                                                    onClick={() => handleViewReceipt(tenant)}\n                                                    className=\"flex items-center gap-2 px-3 py-2 rounded-xl bg-blue-500/10 text-blue-400 hover:bg-blue-500/20 transition-colors text-xs font-medium border border-blue-500/20\"\n                                                >\n                                                    <Eye className=\"w-3 h-3\" /> Voir quittance\n                                                </button>\n                                            )}\n                                            <Button\n                                                variant=\"outline\"\n                                                size=\"sm\"\n                                                className=\"rounded-xl border-gray-700 text-gray-400 hover:text-white hover:bg-gray-800\"\n                                                onClick={() => handleEdit(tenant)}\n                                            >\n                                                Modifier\n                                            </Button>\n                                        </div>\n                                    </div>\n                                </div>\n                            )}\n                        </div>\n                    ))\n                    }\n                </div>\n            ) : (\n                <div className=\"p-12 text-center border-2 border-dashed border-gray-800 rounded-2xl\">\n                    <User className=\"w-10 h-10 text-gray-700 mx-auto mb-3\" />\n                    <p className=\"text-gray-400 text-sm\">Aucun locataire enregistr√©</p>\n                    <p className=\"text-xs text-gray-600 mt-1\">Cliquez sur &quot;Nouveau Locataire&quot; pour commencer</p>\n                </div>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx","messages":[{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:198:42\n  196 |                                     >\n  197 |                                         Locataire\n> 198 |                                         <SortIcon field=\"name\" />\n      |                                          ^^^^^^^^ This component is created during render\n  199 |                                     </button>\n  200 |                                 </th>\n  201 |\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:131:22\n  129 |     };\n  130 |\n> 131 |     const SortIcon = ({ field }: { field: SortField }) => {\n      |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 132 |         if (sortField !== field) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 133 |             return <ArrowUpDown className=\"w-3 h-3 text-muted-foreground/50\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 134 |         }\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 135 |         return sortOrder === 'asc'\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 136 |             ? <ArrowUp className=\"w-3 h-3 text-muted-foreground\" />\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 137 |             : <ArrowDown className=\"w-3 h-3 text-muted-foreground\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 138 |     };\n      | ^^^^^^ The component is created during render here\n  139 |\n  140 |     const filteredTenants = tenants\n  141 |         .filter(tenant =>","line":198,"column":42,"nodeType":null,"endLine":198,"endColumn":50},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:209:42\n  207 |                                     >\n  208 |                                         Bien\n> 209 |                                         <SortIcon field=\"property\" />\n      |                                          ^^^^^^^^ This component is created during render\n  210 |                                     </button>\n  211 |                                 </th>\n  212 |\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:131:22\n  129 |     };\n  130 |\n> 131 |     const SortIcon = ({ field }: { field: SortField }) => {\n      |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 132 |         if (sortField !== field) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 133 |             return <ArrowUpDown className=\"w-3 h-3 text-muted-foreground/50\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 134 |         }\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 135 |         return sortOrder === 'asc'\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 136 |             ? <ArrowUp className=\"w-3 h-3 text-muted-foreground\" />\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 137 |             : <ArrowDown className=\"w-3 h-3 text-muted-foreground\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 138 |     };\n      | ^^^^^^ The component is created during render here\n  139 |\n  140 |     const filteredTenants = tenants\n  141 |         .filter(tenant =>","line":209,"column":42,"nodeType":null,"endLine":209,"endColumn":50},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:220:42\n  218 |                                     >\n  219 |                                         P√©riode\n> 220 |                                         <SortIcon field=\"period\" />\n      |                                          ^^^^^^^^ This component is created during render\n  221 |                                     </button>\n  222 |                                 </th>\n  223 |\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:131:22\n  129 |     };\n  130 |\n> 131 |     const SortIcon = ({ field }: { field: SortField }) => {\n      |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 132 |         if (sortField !== field) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 133 |             return <ArrowUpDown className=\"w-3 h-3 text-muted-foreground/50\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 134 |         }\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 135 |         return sortOrder === 'asc'\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 136 |             ? <ArrowUp className=\"w-3 h-3 text-muted-foreground\" />\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 137 |             : <ArrowDown className=\"w-3 h-3 text-muted-foreground\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 138 |     };\n      | ^^^^^^ The component is created during render here\n  139 |\n  140 |     const filteredTenants = tenants\n  141 |         .filter(tenant =>","line":220,"column":42,"nodeType":null,"endLine":220,"endColumn":50},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:231:42\n  229 |                                     >\n  230 |                                         Statut\n> 231 |                                         <SortIcon field=\"status\" />\n      |                                          ^^^^^^^^ This component is created during render\n  232 |                                     </button>\n  233 |                                 </th>\n  234 |\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:131:22\n  129 |     };\n  130 |\n> 131 |     const SortIcon = ({ field }: { field: SortField }) => {\n      |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 132 |         if (sortField !== field) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 133 |             return <ArrowUpDown className=\"w-3 h-3 text-muted-foreground/50\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 134 |         }\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 135 |         return sortOrder === 'asc'\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 136 |             ? <ArrowUp className=\"w-3 h-3 text-muted-foreground\" />\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 137 |             : <ArrowDown className=\"w-3 h-3 text-muted-foreground\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 138 |     };\n      | ^^^^^^ The component is created during render here\n  139 |\n  140 |     const filteredTenants = tenants\n  141 |         .filter(tenant =>","line":231,"column":42,"nodeType":null,"endLine":231,"endColumn":50},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:242:42\n  240 |                                     >\n  241 |                                         Montant\n> 242 |                                         <SortIcon field=\"rentAmount\" />\n      |                                          ^^^^^^^^ This component is created during render\n  243 |                                     </button>\n  244 |                                 </th>\n  245 |\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\TenantTable.tsx:131:22\n  129 |     };\n  130 |\n> 131 |     const SortIcon = ({ field }: { field: SortField }) => {\n      |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 132 |         if (sortField !== field) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 133 |             return <ArrowUpDown className=\"w-3 h-3 text-muted-foreground/50\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 134 |         }\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 135 |         return sortOrder === 'asc'\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 136 |             ? <ArrowUp className=\"w-3 h-3 text-muted-foreground\" />\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 137 |             : <ArrowDown className=\"w-3 h-3 text-muted-foreground\" />;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 138 |     };\n      | ^^^^^^ The component is created during render here\n  139 |\n  140 |     const filteredTenants = tenants\n  141 |         .filter(tenant =>","line":242,"column":42,"nodeType":null,"endLine":242,"endColumn":50}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { _ReceiptModal } from './ReceiptModal';\nimport { useState } from 'react';\nimport Link from 'next/link';\nimport { useRouter } from 'next/navigation';\nimport { MoreHorizontal, Eye, Edit2, CheckCircle, Trash2, RotateCcw, ArrowUpDown, ArrowUp, ArrowDown, _FileText, Send } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { _GenerateContractButton } from '@/components/contracts/GenerateContractButton';\nimport { EmptyState } from '@/components/ui/empty-state';\nimport { AddTenantButton } from './AddTenantButton';\nimport {\n    DropdownMenu,\n    DropdownMenuContent,\n    DropdownMenuItem,\n    DropdownMenuSeparator,\n    DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport { _confirmPayment, _terminateLease, _reactivateLease } from '../actions';\nimport { _toast } from 'sonner';\n\ninterface Tenant {\n    id: string;\n    name: string;\n    property: string;\n    phone?: string;\n    email?: string;\n    rentAmount: number;\n    status: 'paid' | 'pending' | 'overdue';\n    dueDate?: number;\n    startDate?: string;\n    last_transaction_id?: string;\n    period_month?: number;\n    period_year?: number;\n    period_start?: string | null;\n    period_end?: string | null;\n    lease_pdf_url?: string | null;\n    tenant_name?: string; // Often redundant with name but useful if explicit\n}\n\ninterface ProfileData {\n    company_name?: string | null;\n    full_name?: string | null;\n    company_address?: string | null;\n    company_email?: string | null;\n    company_ninea?: string | null;\n    signature_url?: string | null;\n    logo_url?: string | null;\n}\n\nexport interface TenantTableProps {\n    tenants?: Tenant[];\n    profile?: ProfileData | null;\n    userEmail?: string;\n    isViewingTerminated?: boolean;\n    searchQuery?: string;\n    onEdit?: (tenant: Tenant) => void;\n    onDelete?: (transactionId: string) => void;\n    onDeleteLease?: (leaseId: string) => void;\n    ownerId?: string;\n    onConfirmPayment?: (leaseId: string, transactionId?: string) => void;\n    onViewReceipt?: (tenant: Tenant) => void;\n    onTerminate?: (leaseId: string, tenantName: string) => void;\n    onReactivate?: (leaseId: string, tenantName: string) => void;\n    onInvite?: (leaseId: string) => void;\n}\n\n\n\ntype SortField = 'name' | 'property' | 'rentAmount' | 'status' | 'period';\ntype SortOrder = 'asc' | 'desc';\n\nexport function TenantTable({\n    tenants = [],\n    _profile,\n    _userEmail,\n    ownerId,\n    isViewingTerminated = false,\n    searchQuery = '',\n    onEdit,\n    _onDelete,\n    _onDeleteLease,\n    onConfirmPayment,\n    onViewReceipt,\n    onTerminate,\n    onReactivate,\n    onInvite\n}: TenantTableProps) {\n    const _router = useRouter();\n    const [sortField, setSortField] = useState<SortField>('name');\n    const [sortOrder, setSortOrder] = useState<SortOrder>('asc');\n\n    const statusConfig = {\n        paid: {\n            label: 'Pay√©',\n            bg: 'bg-muted',\n            text: 'text-muted-foreground',\n            dot: 'bg-green-500'\n        },\n        pending: {\n            label: 'Attente',\n            bg: 'bg-muted',\n            text: 'text-muted-foreground',\n            dot: 'bg-yellow-500'\n        },\n        overdue: {\n            label: 'Retard',\n            bg: 'bg-muted',\n            text: 'text-muted-foreground',\n            dot: 'bg-red-500'\n        }\n    };\n\n    const getInitials = (name: string) => {\n        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n    };\n\n    const formatAmount = (amount: number) => {\n        return amount.toLocaleString('fr-FR');\n    };\n\n    const handleSort = (field: SortField) => {\n        if (sortField === field) {\n            setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');\n        } else {\n            setSortField(field);\n            setSortOrder('asc');\n        }\n    };\n\n    const SortIcon = ({ field }: { field: SortField }) => {\n        if (sortField !== field) {\n            return <ArrowUpDown className=\"w-3 h-3 text-muted-foreground/50\" />;\n        }\n        return sortOrder === 'asc'\n            ? <ArrowUp className=\"w-3 h-3 text-muted-foreground\" />\n            : <ArrowDown className=\"w-3 h-3 text-muted-foreground\" />;\n    };\n\n    const filteredTenants = tenants\n        .filter(tenant =>\n            tenant.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n            tenant.property.toLowerCase().includes(searchQuery.toLowerCase()) ||\n            tenant.email?.toLowerCase().includes(searchQuery.toLowerCase())\n        )\n        .sort((a, b) => {\n            let compareA: string | number;\n            let compareB: string | number;\n\n            switch (sortField) {\n                case 'name':\n                    compareA = a.name.toLowerCase();\n                    compareB = b.name.toLowerCase();\n                    break;\n                case 'property':\n                    compareA = a.property.toLowerCase();\n                    compareB = b.property.toLowerCase();\n                    break;\n                case 'rentAmount':\n                    compareA = a.rentAmount;\n                    compareB = b.rentAmount;\n                    break;\n                case 'status':\n                    const statusOrder = { paid: 0, pending: 1, overdue: 2 };\n                    compareA = statusOrder[a.status];\n                    compareB = statusOrder[b.status];\n                    break;\n                case 'period':\n                    compareA = `${a.period_year}-${String(a.period_month).padStart(2, '0')}`;\n                    compareB = `${b.period_year}-${String(b.period_month).padStart(2, '0')}`;\n                    break;\n                default:\n                    return 0;\n            }\n\n            if (compareA < compareB) return sortOrder === 'asc' ? -1 : 1;\n            if (compareA > compareB) return sortOrder === 'asc' ? 1 : -1;\n            return 0;\n        });\n\n    const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];\n\n    return (\n        <>\n\n            <div className=\"border border-border rounded-lg overflow-hidden w-full transition-colors bg-card\">\n                <div className=\"overflow-x-auto\">\n                    <table className=\"w-full text-left text-sm min-w-max sm:min-w-0\">\n                        <thead className=\"border-b border-border bg-muted/30 sticky top-0\">\n                            <tr>\n                                {/* Locataire - Always visible */}\n                                <th className=\"py-3 px-2 sm:px-4\">\n                                    <button\n                                        onClick={() => handleSort('name')}\n                                        className=\"flex items-center gap-1.5 text-xs font-medium uppercase tracking-wider transition-colors text-muted-foreground hover:text-foreground\"\n                                    >\n                                        Locataire\n                                        <SortIcon field=\"name\" />\n                                    </button>\n                                </th>\n\n                                {/* Bien - Hidden on tablet and below */}\n                                <th className=\"py-3 px-4 hidden xl:table-cell\">\n                                    <button\n                                        onClick={() => handleSort('property')}\n                                        className=\"flex items-center gap-1.5 text-xs font-medium uppercase tracking-wider transition-colors text-muted-foreground hover:text-foreground\"\n                                    >\n                                        Bien\n                                        <SortIcon field=\"property\" />\n                                    </button>\n                                </th>\n\n                                {/* P√©riode - Hidden on small devices */}\n                                <th className=\"py-3 px-4 hidden md:table-cell\">\n                                    <button\n                                        onClick={() => handleSort('period')}\n                                        className=\"flex items-center gap-1.5 text-xs font-medium uppercase tracking-wider transition-colors text-muted-foreground hover:text-foreground\"\n                                    >\n                                        P√©riode\n                                        <SortIcon field=\"period\" />\n                                    </button>\n                                </th>\n\n                                {/* Statut - Always visible */}\n                                <th className=\"py-3 px-2 sm:px-4\">\n                                    <button\n                                        onClick={() => handleSort('status')}\n                                        className=\"flex items-center gap-1.5 text-xs font-medium uppercase tracking-wider transition-colors text-muted-foreground hover:text-foreground\"\n                                    >\n                                        Statut\n                                        <SortIcon field=\"status\" />\n                                    </button>\n                                </th>\n\n                                {/* Montant - Always visible */}\n                                <th className=\"py-3 px-2 sm:px-4 text-right\">\n                                    <button\n                                        onClick={() => handleSort('rentAmount')}\n                                        className=\"flex items-center gap-1.5 ml-auto text-xs font-medium uppercase tracking-wider transition-colors text-muted-foreground hover:text-foreground\"\n                                    >\n                                        Montant\n                                        <SortIcon field=\"rentAmount\" />\n                                    </button>\n                                </th>\n\n                                {/* Actions */}\n                                <th className=\"py-3 px-2 sm:px-4 text-right w-10 sm:w-12\">\n                                    <span className=\"sr-only\">Actions</span>\n                                </th>\n                            </tr>\n                        </thead>\n                        <tbody className=\"divide-y divide-border/50\">\n                            {filteredTenants.map((tenant) => {\n                                const periodLabel = tenant.period_month && tenant.period_year\n                                    ? `${monthNames[tenant.period_month - 1]} ${tenant.period_year}`\n                                    : '-';\n\n                                return (\n                                    <tr key={tenant.last_transaction_id || tenant.id} className=\"transition-colors hover:bg-muted/50\">\n                                        {/* Locataire */}\n                                        <td className=\"py-3 px-2 sm:px-4\">\n                                            <div className=\"flex items-center gap-2 sm:gap-3 min-w-0\">\n                                                <div className=\"w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs font-medium shrink-0 bg-muted text-muted-foreground border border-border\">\n                                                    {getInitials(tenant.name)}\n                                                </div>\n                                                <div className=\"min-w-0 flex-1\">\n                                                    <Link href={`/gestion/locataires/${tenant.id}`} className=\"block group/link\">\n                                                        <div className=\"font-medium text-xs sm:text-sm truncate transition-colors text-foreground group-hover/link:text-primary\">\n                                                            {tenant.name}\n                                                        </div>\n                                                    </Link>\n                                                    <div className=\"text-xs truncate text-muted-foreground hidden sm:block\">{tenant.email || 'Email manquant'}</div>\n                                                </div>\n                                            </div>\n                                        </td>\n\n                                        {/* Bien - Hidden on devices below xl */}\n                                        <td className=\"py-3 px-4 hidden xl:table-cell\">\n                                            <div className=\"text-sm truncate max-w-[150px] text-muted-foreground\">{tenant.property}</div>\n                                        </td>\n\n                                        {/* P√©riode - Hidden on small devices */}\n                                        <td className=\"py-3 px-4 hidden md:table-cell\">\n                                            <div className=\"text-xs sm:text-sm text-muted-foreground\">{periodLabel}</div>\n                                        </td>\n\n                                        {/* Statut */}\n                                        <td className=\"py-3 px-2 sm:px-4\">\n                                            <div className={`inline-flex items-center gap-1 px-1.5 sm:px-2 py-0.5 rounded text-xs font-medium ${statusConfig[tenant.status].bg} ${statusConfig[tenant.status].text}`}>\n                                                <div className={`w-1.5 h-1.5 rounded-full ${statusConfig[tenant.status].dot}`} />\n                                                <span className=\"hidden sm:inline\">{statusConfig[tenant.status].label}</span>\n                                                <span className=\"sm:hidden\">{statusConfig[tenant.status].label.slice(0, 3)}</span>\n                                            </div>\n                                        </td>\n\n                                        {/* Montant */}\n                                        <td className=\"py-3 px-2 sm:px-4 text-right\">\n                                            <div className=\"font-mono font-medium text-xs sm:text-sm text-foreground\">{formatAmount(tenant.rentAmount)}</div>\n                                            <div className=\"text-xs text-muted-foreground/60 hidden sm:block\">FCFA</div>\n                                        </td>\n\n                                        {/* Actions */}\n                                        <td className=\"py-3 px-2 sm:px-4 text-right\">\n                                            <DropdownMenu>\n                                                <DropdownMenuTrigger asChild>\n                                                    <Button variant=\"ghost\" size=\"sm\" className=\"h-7 w-7 sm:h-8 sm:w-8 p-0 hover:bg-muted\">\n                                                        <MoreHorizontal className=\"h-3.5 w-3.5 sm:h-4 sm:w-4 text-muted-foreground\" />\n                                                    </Button>\n                                                </DropdownMenuTrigger>\n                                                <DropdownMenuContent align=\"end\" className=\"w-44\">\n                                                    {tenant.status === 'paid' && onViewReceipt && (\n                                                        <DropdownMenuItem onClick={() => onViewReceipt(tenant)}>\n                                                            <Eye className=\"mr-2 h-4 w-4\" />\n                                                            Voir quittance\n                                                        </DropdownMenuItem>\n                                                    )}\n                                                    {(tenant.status === 'pending' || tenant.status === 'overdue') && onConfirmPayment && (\n                                                        <DropdownMenuItem onClick={() => onConfirmPayment(tenant.id, tenant.last_transaction_id)}>\n                                                            <CheckCircle className=\"mr-2 h-4 w-4\" />\n                                                            Marquer pay√©\n                                                        </DropdownMenuItem>\n                                                    )}\n                                                    <DropdownMenuItem\n                                                        onClick={() => onEdit?.(tenant)}\n                                                    >\n                                                        <Edit2 className=\"mr-2 h-4 w-4\" />\n                                                        Modifier\n                                                    </DropdownMenuItem>\n\n                                                    {onInvite && tenant.email && (\n                                                        <DropdownMenuItem\n                                                            onClick={() => onInvite(tenant.id)}\n                                                        >\n                                                            <Send className=\"mr-2 h-4 w-4 text-muted-foreground\" />\n                                                            Inviter au portail\n                                                        </DropdownMenuItem>\n                                                    )}\n\n                                                    <DropdownMenuSeparator />\n                                                    {isViewingTerminated && onReactivate ? (\n                                                        <DropdownMenuItem onClick={() => onReactivate(tenant.id, tenant.name)}>\n                                                            <RotateCcw className=\"mr-2 h-4 w-4 text-muted-foreground\" />\n                                                            R√©activer\n                                                        </DropdownMenuItem>\n                                                    ) : onTerminate && (\n                                                        <DropdownMenuItem onClick={() => onTerminate(tenant.id, tenant.name)} className=\"text-destructive focus:text-destructive focus:bg-destructive/10 transition-colors\">\n                                                            <Trash2 className=\"mr-2 h-4 w-4 text-muted-foreground group-hover:text-destructive\" />\n                                                            R√©silier\n                                                        </DropdownMenuItem>\n                                                    )}\n                                                </DropdownMenuContent>\n                                            </DropdownMenu>\n                                        </td>\n                                    </tr>\n                                );\n                            })}\n                        </tbody>\n                    </table>\n                </div>\n            </div> {\n                filteredTenants.length === 0 && (\n                    <div className=\"py-8 px-4\">\n                        {!searchQuery ? (\n                            <EmptyState\n                                title=\"Votre gestion commence ici\"\n                                description=\"Cr√©ez un bail pour g√©n√©rer automatiquement vos contrats et quittances.\"\n                                actionComponent={\n                                    ownerId ? (\n                                        <AddTenantButton\n                                            ownerId={ownerId}\n                                            trigger={\n                                                <Button size=\"lg\" className=\"bg-primary text-primary-foreground hover:bg-primary/90 font-semibold w-full sm:w-auto transition-all shadow-md\">\n                                                    Cr√©er un Bail\n                                                </Button>\n                                            }\n                                        />\n                                    ) : null\n                                }\n                                secondaryActionComponent={\n                                    ownerId ? (\n                                        <AddTenantButton\n                                            ownerId={ownerId}\n                                            initialData={{\n                                                name: \"Moussa Diop\",\n                                                phone: \"+221 77 123 45 67\",\n                                                email: \"moussa.diop@example.com\",\n                                                address: \"Appartement F4, Sacr√©-C≈ìur 3, Dakar\",\n                                                amount: 250000,\n                                                day: 5,\n                                                startDate: new Date().toISOString().split('T')[0],\n                                                endDate: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0]\n                                            }}\n                                            trigger={\n                                                <Button variant=\"ghost\" className=\"mt-2 sm:mt-0 sm:ml-2\">\n                                                    Voir un exemple de bail\n                                                </Button>\n                                            }\n                                        />\n                                    ) : null\n                                }\n                            />\n                        ) : (\n                            <div className=\"text-center py-16\">\n                                <div className=\"text-muted-foreground text-sm\">\n                                    Aucun r√©sultat pour cette recherche\n                                </div>\n                            </div>\n                        )}\n                    </div>\n                )\n            }\n\n        </>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\components\\ThemedContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\components\\AddExpenseDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\components\\ConnectStripeButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\components\\DownloadReportButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\components\\ExpenseList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\components\\FinancialReportPDF.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\components\\ProfitabilityTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[609,612],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[609,612],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { TrendingUp, TrendingDown, Building2, Loader2 } from 'lucide-react';\r\nimport { getProfitabilityByProperty, PropertyProfitability } from '../expenses-actions';\r\nimport { toast } from 'sonner';\r\nimport { useTheme } from \"@/components/theme-provider\";\r\n\r\ninterface ProfitabilityTableProps {\r\n    year: number;\r\n}\r\n\r\nexport function ProfitabilityTable({ year }: ProfitabilityTableProps) {\r\n    const { isDark } = useTheme();\r\n    const [data, setData] = useState<PropertyProfitability[]>([]);\r\n    const [_debugInfo, setDebugInfo] = useState<any>(null);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        const loadData = async () => {\r\n            setLoading(true);\r\n            const result = await getProfitabilityByProperty(year);\r\n            if (result.success && result.data) {\r\n                setData(result.data);\r\n                if (result.debug) setDebugInfo(result.debug);\r\n            } else if (!result.success && result.error) {\r\n                toast.error(result.error);\r\n                console.error(result.error);\r\n            }\r\n            setLoading(false);\r\n        };\r\n        loadData();\r\n    }, [year]);\r\n\r\n    const formatAmount = (amount: number) => amount.toLocaleString('fr-FR');\r\n\r\n    // Calculate totals\r\n    const totals = data.reduce(\r\n        (acc, item) => ({\r\n            revenue: acc.revenue + item.totalRevenue,\r\n            expenses: acc.expenses + item.totalExpenses,\r\n            profit: acc.profit + item.netProfit,\r\n        }),\r\n        { revenue: 0, expenses: 0, profit: 0 }\r\n    );\r\n\r\n    const overallMargin = totals.revenue > 0 ? ((totals.profit / totals.revenue) * 100) : 0;\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className={`flex items-center justify-center py-12 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\r\n                <Loader2 className=\"w-6 h-6 animate-spin mr-2\" />\r\n                Chargement...\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (data.length === 0) {\r\n        return (\r\n            <div className={`flex flex-col items-center justify-center py-12 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\r\n                <Building2 className=\"w-12 h-12 mb-4 opacity-50\" />\r\n                <p className=\"text-lg font-medium\">Aucune donn√©e de rentabilit√©</p>\r\n                <p className=\"text-sm\">Ajoutez des baux et des d√©penses pour voir la rentabilit√©.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            {/* Summary Card */}\r\n            <div className={`grid grid-cols-2 md:grid-cols-4 gap-2`}>\r\n                <div className={`px-3 py-2 rounded-lg border ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'}`}>\r\n                    <p className={`text-[10px] uppercase tracking-wider mb-0.5 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>Revenus Totaux</p>\r\n                    <p className={`text-lg font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>{formatAmount(totals.revenue)} FCFA</p>\r\n                </div>\r\n                <div className={`px-3 py-2 rounded-lg border ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'}`}>\r\n                    <p className={`text-[10px] uppercase tracking-wider mb-0.5 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>D√©penses Totales</p>\r\n                    <p className={`text-lg font-semibold ${isDark ? 'text-slate-200' : 'text-gray-700'}`}>{formatAmount(totals.expenses)} FCFA</p>\r\n                </div>\r\n                <div className={`px-3 py-2 rounded-lg border ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'}`}>\r\n                    <p className={`text-[10px] uppercase tracking-wider mb-0.5 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>B√©n√©fice Net</p>\r\n                    <p className={`text-lg font-semibold ${totals.profit >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>\r\n                        {formatAmount(totals.profit)} FCFA\r\n                    </p>\r\n                </div>\r\n                <div className={`px-3 py-2 rounded-lg border ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'}`}>\r\n                    <p className={`text-[10px] uppercase tracking-wider mb-0.5 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>Marge Globale</p>\r\n                    <p className={`text-lg font-semibold flex items-center gap-2 ${overallMargin >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>\r\n                        {overallMargin >= 0 ? <TrendingUp className=\"w-4 h-4\" /> : <TrendingDown className=\"w-4 h-4\" />}\r\n                        {overallMargin.toFixed(1)}%\r\n                    </p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Table */}\r\n            <div className={`rounded-xl border overflow-hidden ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'}`}>\r\n                <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full\">\r\n                        <thead>\r\n                            <tr className={`text-left text-xs border-b ${isDark ? 'bg-slate-800/50 text-slate-400 border-slate-700' : 'bg-gray-50 text-gray-500 border-gray-200'}`}>\r\n                                <th className=\"px-4 py-3 font-medium\">Bien / Locataire</th>\r\n                                <th className=\"px-4 py-3 font-medium text-right\">Revenus</th>\r\n                                <th className=\"px-4 py-3 font-medium text-right\">D√©penses</th>\r\n                                <th className=\"px-4 py-3 font-medium text-right\">B√©n√©fice Net</th>\r\n                                <th className=\"px-4 py-3 font-medium text-right\">Marge</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className={`divide-y ${isDark ? 'divide-slate-800' : 'divide-gray-200'}`}>\r\n                            {data.map((item, index) => (\r\n                                <tr key={index} className={`transition-colors ${isDark ? 'hover:bg-slate-800/30' : 'hover:bg-gray-50'}`}>\r\n                                    <td className={`px-4 py-3 ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <Building2 className={`w-4 h-4 ${isDark ? 'text-slate-600' : 'text-gray-400'}`} />\r\n                                            <span className=\"font-medium truncate max-w-[200px]\">{item.propertyAddress}</span>\r\n                                        </div>\r\n                                    </td>\r\n                                    <td className={`px-4 py-3 text-right ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>\r\n                                        {formatAmount(item.totalRevenue)} FCFA\r\n                                    </td>\r\n                                    <td className={`px-4 py-3 text-right ${isDark ? 'text-slate-400' : 'text-gray-500'}`}>\r\n                                        {formatAmount(item.totalExpenses)} FCFA\r\n                                    </td>\r\n                                    <td className={`px-4 py-3 text-right font-medium ${item.netProfit >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>\r\n                                        {formatAmount(item.netProfit)} FCFA\r\n                                    </td>\r\n                                    <td className={`px-4 py-3 text-right ${item.profitMargin >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>\r\n                                        <div className=\"flex items-center justify-end gap-1\">\r\n                                            {item.profitMargin >= 50 ? (\r\n                                                <TrendingUp className=\"w-4 h-4\" />\r\n                                            ) : item.profitMargin < 0 ? (\r\n                                                <TrendingDown className=\"w-4 h-4\" />\r\n                                            ) : null}\r\n                                            {item.profitMargin.toFixed(1)}%\r\n                                        </div>\r\n                                    </td>\r\n                                </tr>\r\n                            ))}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\expense-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\expenses-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3202,3205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3202,3205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":394,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":394,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12362,12365],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12362,12365],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\nimport type { ExpenseCategory } from './expense-types';\nimport { getUserTeamContext } from \"@/lib/team-context\";\nimport { requireTeamPermission } from \"@/lib/permissions\";\nimport { checkFeatureAccess } from \"@/lib/subscription/team-subscription\";\n\n// Re-export the type for convenience\nexport type { ExpenseCategory } from './expense-types';\n\nexport interface Expense {\n    id: string;\n    owner_id: string;\n    property_id?: string | null;\n    lease_id?: string | null;\n    amount: number;\n    expense_date: string;\n    category: ExpenseCategory;\n    description?: string | null;\n    proof_url?: string | null;\n    created_at: string;\n    updated_at: string;\n    // Joined data\n    property_address?: string;\n    tenant_name?: string;\n}\n\nexport interface AddExpenseInput {\n    property_id?: string;\n    lease_id?: string;\n    amount: number;\n    expense_date: string;\n    category: ExpenseCategory;\n    description?: string;\n    proof_url?: string;\n}\n\n// ==========================================\n// ADD EXPENSE\n// ==========================================\nexport async function addExpense(data: AddExpenseInput) {\n    const { teamId, user } = await getUserTeamContext();\n    await requireTeamPermission('expenses.create');\n\n    const supabase = await createClient();\n\n    const { data: expense, error } = await supabase\n        .from('expenses')\n        .insert({\n            owner_id: user.id,\n            team_id: teamId,\n            property_id: data.property_id || null,\n            lease_id: data.lease_id || null,\n            amount: data.amount,\n            expense_date: data.expense_date,\n            category: data.category,\n            description: data.description || null,\n            proof_url: data.proof_url || null,\n        })\n        .select()\n        .single();\n\n    if (error) {\n        console.error('Error adding expense:', error);\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion/comptabilite');\n    return { success: true, expense };\n}\n\n// ==========================================\n// GET EXPENSES BY MONTH\n// ==========================================\nexport async function getExpensesByMonth(month: number, year: number) {\n    const { teamId } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0];\n    const endDate = new Date(year, month, 0).toISOString().split('T')[0];\n\n    const { data: expenses, error } = await supabase\n        .from('expenses')\n        .select(`\n            *,\n            properties:property_id (address),\n            leases:lease_id (tenant_name)\n        `)\n        .eq('team_id', teamId)\n        .gte('expense_date', startDate)\n        .lte('expense_date', endDate)\n        .order('expense_date', { ascending: false });\n\n    if (error) {\n        console.error('Error fetching expenses:', error);\n        return { success: false, error: error.message, expenses: [] };\n    }\n\n    // Format the expenses with joined data\n    const formattedExpenses: Expense[] = (expenses || []).map((e: any) => ({\n        ...e,\n        property_address: e.properties?.address || null,\n        tenant_name: e.leases?.tenant_name || null,\n    }));\n\n    return { success: true, expenses: formattedExpenses };\n}\n\n// ==========================================\n// GET TOTAL EXPENSES BY YEAR\n// ==========================================\nexport async function getExpensesByYear(year: number) {\n    const { teamId } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    const startDate = `${year}-01-01`;\n    const endDate = `${year}-12-31`;\n\n    const { data: expenses, error } = await supabase\n        .from('expenses')\n        .select('*')\n        .eq('team_id', teamId)\n        .gte('expense_date', startDate)\n        .lte('expense_date', endDate)\n        .order('expense_date', { ascending: false });\n\n    if (error) {\n        console.error('Error fetching yearly expenses:', error);\n        return { success: false, error: error.message, expenses: [] };\n    }\n\n    return { success: true, expenses: expenses || [] };\n}\n\n// ==========================================\n// DELETE EXPENSE\n// ==========================================\nexport async function deleteExpense(expenseId: string) {\n    const { teamId } = await getUserTeamContext();\n    await requireTeamPermission('expenses.delete');\n\n    const supabase = await createClient();\n\n    const { error } = await supabase\n        .from('expenses')\n        .delete()\n        .eq('id', expenseId)\n        .eq('team_id', teamId);\n\n    if (error) {\n        console.error('Error deleting expense:', error);\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion/comptabilite');\n    return { success: true, message: 'D√©pense supprim√©e' };\n}\n\n// ==========================================\n// UPDATE EXPENSE\n// ==========================================\nexport async function updateExpense(\n    expenseId: string,\n    data: Partial<AddExpenseInput>\n) {\n    const { teamId } = await getUserTeamContext();\n    await requireTeamPermission('expenses.edit');\n\n    const supabase = await createClient();\n\n    const updateData: Record<string, unknown> = {};\n    if (data.amount !== undefined) updateData.amount = data.amount;\n    if (data.expense_date !== undefined) updateData.expense_date = data.expense_date;\n    if (data.category !== undefined) updateData.category = data.category;\n    if (data.description !== undefined) updateData.description = data.description;\n    if (data.proof_url !== undefined) updateData.proof_url = data.proof_url;\n    if (data.property_id !== undefined) updateData.property_id = data.property_id || null;\n    if (data.lease_id !== undefined) updateData.lease_id = data.lease_id || null;\n    updateData.updated_at = new Date().toISOString();\n\n    const { data: expense, error } = await supabase\n        .from('expenses')\n        .update(updateData)\n        .eq('id', expenseId)\n        .eq('team_id', teamId)\n        .select()\n        .single();\n\n    if (error) {\n        console.error('Error updating expense:', error);\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion/comptabilite');\n    return { success: true, expense };\n}\n\n// ==========================================\n// GET EXPENSES SUMMARY\n// ==========================================\nexport interface ExpensesSummary {\n    totalExpenses: number;\n    byCategory: { category: ExpenseCategory; label: string; total: number; count: number }[];\n    byMonth: { month: string; total: number }[];\n}\n\nexport async function getExpensesSummary(year: number): Promise<{\n    success: boolean;\n    error?: string;\n    summary?: ExpensesSummary;\n}> {\n    const { teamId } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    const { data: expenses, error } = await supabase\n        .from('expenses')\n        .select('*')\n        .eq('team_id', teamId)\n        .gte('expense_date', `${year}-01-01`)\n        .lte('expense_date', `${year}-12-31`);\n\n    if (error) {\n        console.error('Error fetching expenses summary:', error);\n        return { success: false, error: error.message };\n    }\n\n    const { EXPENSE_CATEGORY_LABELS } = await import('./expense-types');\n\n    // Calculate totals by category\n    const categoryMap = new Map<ExpenseCategory, { total: number; count: number }>();\n    let totalExpenses = 0;\n\n    for (const expense of expenses || []) {\n        totalExpenses += expense.amount;\n        const cat = expense.category as ExpenseCategory;\n        const existing = categoryMap.get(cat) || { total: 0, count: 0 };\n        categoryMap.set(cat, {\n            total: existing.total + expense.amount,\n            count: existing.count + 1,\n        });\n    }\n\n    const byCategory = Array.from(categoryMap.entries())\n        .map(([category, data]) => ({\n            category,\n            label: EXPENSE_CATEGORY_LABELS[category] || category,\n            total: data.total,\n            count: data.count,\n        }))\n        .sort((a, b) => b.total - a.total);\n\n    // Calculate totals by month\n    const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];\n    const monthTotals = new Array(12).fill(0);\n\n    for (const expense of expenses || []) {\n        const month = new Date(expense.expense_date).getMonth();\n        monthTotals[month] += expense.amount;\n    }\n\n    const byMonth = monthTotals.map((total, index) => ({\n        month: monthNames[index],\n        total,\n    }));\n\n    return {\n        success: true,\n        summary: {\n            totalExpenses,\n            byCategory,\n            byMonth,\n        },\n    };\n}\n\n// ==========================================\n// GET PROFITABILITY BY PROPERTY\n// ==========================================\nexport interface PropertyProfitability {\n    propertyAddress: string;\n    totalRevenue: number;\n    totalExpenses: number;\n    netProfit: number;\n    profitMargin: number;\n}\n\n// ==========================================\n// GET COMPTABILITE DATA (Team-Centric)\n// ==========================================\nexport interface ComptabiliteData {\n    leases: {\n        id: string;\n        monthly_amount: number;\n        status: string;\n        start_date: string;\n        billing_day: number;\n        tenant_name?: string;\n    }[];\n    transactions: {\n        id: string;\n        lease_id: string;\n        amount_due: number;\n        status: string;\n        period_month: number;\n        period_year: number;\n        created_at: string;\n        amount_paid: number;\n    }[];\n    properties: { id: string; address: string }[];\n}\n\nexport async function getComptabiliteData(year: number): Promise<{\n    success: boolean;\n    error?: string;\n    data?: ComptabiliteData;\n    upgradeRequired?: boolean;\n}> {\n    const { teamId } = await getUserTeamContext();\n\n    // ‚úÖ CHECK FEATURE: Accounting Module Access\n    const access = await checkFeatureAccess(teamId, \"view_advanced_reports\");\n    if (!access.allowed) {\n        return { success: false, error: access.message, upgradeRequired: true };\n    }\n\n    const supabase = await createClient();\n\n    // 1. Fetch all leases for the team\n    const { data: leasesData, error: leasesError } = await supabase\n        .from('leases')\n        .select('id, monthly_amount, status, start_date, billing_day, tenant_name, property_address')\n        .eq('team_id', teamId);\n\n    if (leasesError) {\n        console.error('Error fetching leases for comptabilite:', leasesError);\n        return { success: false, error: leasesError.message };\n    }\n\n    const leases = (leasesData || []).map(l => ({\n        id: l.id,\n        monthly_amount: l.monthly_amount,\n        status: l.status || 'active',\n        start_date: l.start_date,\n        billing_day: l.billing_day || 5,\n        tenant_name: l.tenant_name\n    }));\n\n    // 2. Build properties list from leases (for expense form)\n    const properties = (leasesData || [])\n        .filter(l => l.status === 'active')\n        .map(l => ({\n            id: l.id,\n            address: l.tenant_name || l.property_address || 'Locataire'\n        }));\n\n    // 3. Fetch transactions for the year\n    const leaseIds = leases.map(l => l.id);\n\n    if (leaseIds.length === 0) {\n        return {\n            success: true,\n            data: { leases, transactions: [], properties }\n        };\n    }\n\n    const { data: txsData, error: txsError } = await supabase\n        .from('rental_transactions')\n        .select('id, lease_id, amount_due, status, period_month, period_year, created_at')\n        .eq('team_id', teamId)\n        .eq('period_year', year);\n\n    if (txsError) {\n        console.error('Error fetching transactions for comptabilite:', txsError);\n        return { success: false, error: txsError.message };\n    }\n\n    const transactions = (txsData || []).map(t => ({\n        ...t,\n        amount_paid: (t.status?.toLowerCase() === 'paid') ? t.amount_due : 0\n    }));\n\n    return {\n        success: true,\n        data: { leases, transactions, properties }\n    };\n}\n\nexport async function getProfitabilityByProperty(year: number): Promise<{\n    success: boolean;\n    error?: string;\n    data?: PropertyProfitability[];\n    debug?: any;\n    upgradeRequired?: boolean;\n}> {\n    const { teamId, user } = await getUserTeamContext();\n\n    // ‚úÖ CHECK FEATURE QUOTA (EXPORT)\n    const access = await checkFeatureAccess(teamId, \"export_data\");\n    if (!access.allowed) {\n        return {\n            success: false,\n            error: access.message,\n            upgradeRequired: access.upgradeRequired\n        };\n    }\n\n    const supabase = await createClient();\n\n    // Get all leases with their payments\n    const { data: leases, error: leasesError } = await supabase\n        .from('leases')\n        .select('id, property_address, monthly_amount')\n        .eq('team_id', teamId);\n\n    if (leasesError) {\n        console.error('Error fetching leases for profitability:', leasesError);\n        return { success: false, error: leasesError.message };\n    }\n\n    // Get all expenses for the year\n    const { data: expenses, error: expensesError } = await supabase\n        .from('expenses')\n        .select('*')\n        .eq('team_id', teamId)\n        .gte('expense_date', `${year}-01-01`)\n        .lte('expense_date', `${year}-12-31`);\n\n    if (expensesError) {\n        console.error('Error fetching expenses for profitability:', expensesError);\n        return { success: false, error: expensesError.message };\n    }\n\n    // Get all payments for the year (rent collected)\n    const { data: payments, error: paymentsError } = await supabase\n        .from('rental_transactions')\n        .select('lease_id, amount_due, status')\n        .eq('status', 'paid')\n        .eq('period_year', year)\n        .eq('team_id', teamId);\n\n    if (paymentsError) {\n        console.error('Error fetching payments for profitability:', paymentsError);\n        return { success: false, error: paymentsError.message };\n    }\n\n    // Build property map\n    const propertyMap = new Map<string, { revenue: number; expenses: number }>();\n\n    // Process leases and payments\n    for (const lease of leases || []) {\n        const address = lease.property_address || 'Adresse inconnue';\n        if (!propertyMap.has(address)) {\n            propertyMap.set(address, { revenue: 0, expenses: 0 });\n        }\n\n        // Sum payments for this lease\n        const leasePayments = (payments || []).filter(p => p.lease_id === lease.id);\n        const totalPayments = leasePayments.reduce((sum, p) => sum + (Number(p.amount_due) || 0), 0);\n\n        const prop = propertyMap.get(address)!;\n        prop.revenue += totalPayments;\n    }\n\n    // Process expenses - either by lease or property_id\n    for (const expense of expenses || []) {\n        let address = 'Non attribu√©';\n\n        if (expense.lease_id) {\n            const lease = (leases || []).find(l => l.id === expense.lease_id);\n            if (lease) {\n                address = lease.property_address || 'Adresse inconnue';\n            }\n        }\n\n        if (!propertyMap.has(address)) {\n            propertyMap.set(address, { revenue: 0, expenses: 0 });\n        }\n\n        const prop = propertyMap.get(address)!;\n        prop.expenses += expense.amount;\n    }\n\n    // Calculate profitability\n    const data: PropertyProfitability[] = Array.from(propertyMap.entries())\n        .map(([address, { revenue, expenses }]) => ({\n            propertyAddress: address,\n            totalRevenue: revenue,\n            totalExpenses: expenses,\n            netProfit: revenue - expenses,\n            profitMargin: revenue > 0 ? ((revenue - expenses) / revenue) * 100 : 0,\n        }))\n        .sort((a, b) => b.netProfit - a.netProfit);\n\n    return {\n        success: true,\n        data,\n        debug: {\n            leasesCount: leases?.length || 0,\n            expensesCount: expenses?.length || 0,\n            paymentsCount: payments?.length || 0,\n            mapSize: propertyMap.size,\n            ownerId: user.id\n        }\n    };\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'chartColors' object makes the dependencies of useMemo Hook (at line 192) change on every render. To fix this, wrap the initialization of 'chartColors' in its own useMemo() Hook.","line":133,"column":11,"nodeType":"VariableDeclarator","endLine":139,"endColumn":6},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `expenses`, but the source dependencies were [leases, transactions, selectedYear]. Inferred different dependency than source.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\comptabilite\\page.tsx:142:33\n  140 |\n  141 |     // Calculate monthly data with Unified Logic\n> 142 |     const monthlyData = useMemo(() => {\n      |                                 ^^^^^^^\n> 143 |         if (!leases.length) return [];\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 144 |\n      ‚Ä¶\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 165 |         }));\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 166 |     }, [leases, transactions, selectedYear]);\n      | ^^^^^^ Could not preserve existing manual memoization\n  167 |\n  168 |     // Calculate totals from monthly data\n  169 |     const calculatedTotals = useMemo(() => {","line":142,"column":33,"nodeType":null,"endLine":166,"endColumn":6},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":148,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5331,5334],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5331,5334],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5381,5384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5381,5384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":150,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":150,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5426,5429],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5426,5429],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'expenses'. Either include it or remove the dependency array.","line":166,"column":8,"nodeType":"ArrayExpression","endLine":166,"endColumn":44,"suggestions":[{"desc":"Update the dependencies array to be: [leases, transactions, expenses, selectedYear]","fix":{"range":[6040,6076],"text":"[leases, transactions, expenses, selectedYear]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":390,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":390,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20758,20761],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20758,20761],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":429,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":429,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23526,23529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23526,23529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":464,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":464,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25915,25918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25915,25918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useMemo } from 'react';\nimport {\n    BarChart,\n    Bar,\n    XAxis,\n    YAxis,\n    CartesianGrid,\n    Tooltip,\n    ResponsiveContainer,\n    LineChart,\n    Line,\n    PieChart,\n    Pie,\n    Cell,\n    Legend\n} from 'recharts';\nimport {\n    TrendingUp,\n    _TrendingDown,\n    Wallet,\n    DollarSign,\n    AlertTriangle,\n    Calendar,\n    ArrowUpRight,\n    _ArrowDownRight,\n    _Download,\n    _RefreshCw\n} from 'lucide-react';\nimport { _Button } from '@/components/ui/button';\nimport { Skeleton } from '@/components/ui/skeleton';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { useAuth } from '@/hooks/use-auth';\nimport Link from 'next/link';\nimport { useTheme } from \"@/components/theme-provider\";\n\nimport { calculateYearlyFinancials, LeaseInput, TransactionInput } from '@/lib/finance';\nimport { getExpensesByYear, _getExpensesSummary, getProfitabilityByProperty, getComptabiliteData, PropertyProfitability, Expense } from './expenses-actions';\nimport { DownloadReportButton } from './components/DownloadReportButton';\nimport { AddExpenseDialog } from './components/AddExpenseDialog';\nimport { ExpenseList } from './components/ExpenseList';\nimport { ProfitabilityTable } from './components/ProfitabilityTable';\nimport { FeatureLockedState } from '@/components/gestion/FeatureLockedState';\nimport { ComptabiliteTour } from '@/components/gestion/tours/ComptabiliteTour';\n\ninterface _MonthlyData {\n    month: string;\n    shortMonth: string;\n    expected: number;\n    collected: number;\n    pending: number;\n    future: number;\n    overdue: number;\n    collectionRate: number;\n}\n\nconst _COLORS = {\n    collected: '#22c55e',\n    pending: '#f59e0b',\n    overdue: '#ef4444',\n    expected: '#3b82f6',\n    future: '#334155', // Plus sombre/discret (Slate 700) pour le futur\n};\n\nconst monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];\nconst fullMonthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];\n\nexport default function ComptabilitePage() {\n    const { isDark } = useTheme();\n    const { user, loading: authLoading } = useAuth();\n    const [leases, setLeases] = useState<LeaseInput[]>([]);\n    const [transactions, setTransactions] = useState<TransactionInput[]>([]);\n    const [expenses, setExpenses] = useState<Expense[]>([]);\n    const [properties, setProperties] = useState<{ id: string; address: string }[]>([]);\n    const [loading, setLoading] = useState(true);\n    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());\n    const [activeTab, setActiveTab] = useState<'revenus' | 'depenses' | 'rentabilite'>('revenus');\n    const [profitabilityData, setProfitabilityData] = useState<PropertyProfitability[]>([]);\n    const [upgradeRequired, setUpgradeRequired] = useState(false);\n\n    useEffect(() => {\n        if (!user) return;\n\n        const loadData = async () => {\n            setLoading(true);\n\n            try {\n                // 1. Fetch all comptabilit√© data via Server Action (team_id based)\n                const comptaResult = await getComptabiliteData(selectedYear);\n\n                if (!comptaResult.success && comptaResult.upgradeRequired) {\n                    setUpgradeRequired(true);\n                    setLoading(false);\n                    return;\n                }\n\n                if (comptaResult.success && comptaResult.data) {\n                    setLeases(comptaResult.data.leases as LeaseInput[]);\n                    setTransactions(comptaResult.data.transactions);\n                    setProperties(comptaResult.data.properties);\n                }\n\n                // 2. Fetch Expenses for the year (already team_id based)\n                const expensesResult = await getExpensesByYear(selectedYear);\n                if (expensesResult.success) {\n                    setExpenses(expensesResult.expenses as Expense[]);\n                }\n\n                // 3. Fetch Profitability for PDF (already team_id based)\n                const profitResult = await getProfitabilityByProperty(selectedYear);\n                if (profitResult.success && profitResult.data) {\n                    setProfitabilityData(profitResult.data);\n                }\n            } catch (error) {\n                console.error('Error loading comptabilit√© data:', error);\n            }\n\n            setLoading(false);\n        };\n\n        loadData();\n    }, [user, selectedYear]);\n\n    // Callback to refresh expenses after adding one\n    const refreshExpenses = async () => {\n        const result = await getExpensesByYear(selectedYear);\n        if (result.success) {\n            setExpenses(result.expenses as Expense[]);\n        }\n    };\n\n    const chartColors = {\n        collected: '#22c55e',\n        pending: '#f59e0b',\n        overdue: '#ef4444',\n        expected: '#3b82f6',\n        future: isDark ? '#334155' : '#cbd5e1', // Slate 700 (dark) vs Slate 300 (light)\n    };\n\n    // Calculate monthly data with Unified Logic\n    const monthlyData = useMemo(() => {\n        if (!leases.length) return [];\n\n        // Transform transactions to match the unified input\n        const txInputs: TransactionInput[] = transactions.map(t => ({\n            ...t,\n            period_month: (t as any).period_month,\n            period_year: (t as any).period_year,\n            paid_at: (t as any).paid_at\n        }));\n\n        const results = calculateYearlyFinancials(leases, txInputs, expenses, selectedYear);\n\n        // Adapt unified results to UI format\n        return results.map(res => ({\n            month: fullMonthNames[res.month - 1],\n            shortMonth: monthNames[res.month - 1],\n            expected: res.totalExpected,\n            collected: res.totalCollected,\n            pending: res.pendingAmount, // Use explicit Amount\n            future: res.future,\n            overdue: res.overdueAmount, // Use explicit Amount\n            collectionRate: res.collectionRate\n        }));\n    }, [leases, transactions, selectedYear]);\n\n    // Calculate totals from monthly data\n    const calculatedTotals = useMemo(() => {\n        return monthlyData.reduce((acc, curr) => ({\n            expected: acc.expected + curr.expected,\n            collected: acc.collected + curr.collected,\n            pending: acc.pending + curr.pending, // Removed + curr.future to avoid mixing Future with Arrears\n            overdue: acc.overdue + curr.overdue,\n            future: acc.future + curr.future, // Track future separately if needed\n            collectionRate: 0\n        }), { expected: 0, collected: 0, pending: 0, overdue: 0, future: 0, collectionRate: 0 });\n    }, [monthlyData]);\n\n    const totals = useMemo(() => {\n        const rate = calculatedTotals.expected > 0\n            ? Math.round((calculatedTotals.collected / calculatedTotals.expected) * 100)\n            : 0;\n        return { ...calculatedTotals, collectionRate: rate };\n    }, [calculatedTotals]);\n\n    // Pie chart needs positive values\n    const pieData = useMemo(() => [\n        { name: 'Encaiss√©', value: totals.collected, color: chartColors.collected },\n        { name: 'En attente', value: totals.pending, color: chartColors.pending }, // This now includes future\n        { name: 'En retard', value: totals.overdue, color: chartColors.overdue },\n    ].filter(d => d.value > 0), [totals, chartColors]);\n\n    // Revert chart filtering - Show all months again\n    const chartData = useMemo(() => {\n        return monthlyData;\n    }, [monthlyData]);\n\n    const formatAmount = (val: number) => {\n        if (val >= 1000000) return `${(val / 1000000).toFixed(1)}M`;\n        if (val >= 1000) return `${(val / 1000).toFixed(0)}K`;\n        return val.toString();\n    };\n\n    if (authLoading || loading) {\n        return (\n            <div className=\"p-6 space-y-6\">\n                <Skeleton className={`h-10 w-64 ${isDark ? 'bg-slate-800' : 'bg-gray-200'}`} />\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                    {[...Array(4)].map((_, i) => (\n                        <Skeleton key={i} className={`h-32 rounded-xl ${isDark ? 'bg-slate-800' : 'bg-gray-200'}`} />\n                    ))}\n                </div>\n                <Skeleton className={`h-80 rounded-xl ${isDark ? 'bg-slate-800' : 'bg-gray-200'}`} />\n            </div>\n        );\n    }\n\n    if (!user) {\n        return (\n            <div className=\"flex items-center justify-center h-96\">\n                <p className={isDark ? 'text-slate-400' : 'text-gray-500'}>Veuillez vous connecter</p>\n            </div>\n        );\n    }\n\n    if (upgradeRequired) {\n        return (\n            <FeatureLockedState\n                title=\"Comptabilit√© & Analyses Financi√®res\"\n                description=\"Acc√©dez √† des rapports d√©taill√©s, suivez votre rentabilit√© en temps r√©el et g√©n√©rez des exports comptables professionnels.\"\n                requiredTier=\"pro\"\n            />\n        );\n    }\n\n    return (\n        <div className={`p-4 md:p-6 space-y-6 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n            <ComptabiliteTour />\n            {/* Header */}\n            <div className=\"flex flex-col gap-4\">\n                <div>\n                    <p className={`text-xs uppercase tracking-[0.3em] ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>Gestion Locative</p>\n                    <h1 className={`text-xl md:text-3xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>Dashboard Financier</h1>\n                </div>\n\n                {/* Year Selector + Actions */}\n                <div id=\"tour-compta-export\" className=\"flex flex-wrap items-center gap-2 md:gap-3\">\n                    <div className={`flex items-center gap-2 rounded-lg px-2.5 md:px-3 py-1.5 md:py-2 border ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'\n                        }`}>\n                        <Calendar className={`w-4 h-4 ${isDark ? 'text-slate-500' : 'text-gray-400'}`} />\n                        <select\n                            value={selectedYear}\n                            onChange={(e) => setSelectedYear(parseInt(e.target.value))}\n                            className={`bg-transparent text-sm outline-none cursor-pointer ${isDark ? 'text-white' : 'text-gray-900'\n                                }`}\n                        >\n                            {[2024, 2025, 2026].map(year => (\n                                <option key={year} value={year} className={isDark ? 'bg-slate-900' : 'bg-white'}>{year}</option>\n                            ))}\n                        </select>\n                    </div>\n\n                    {/* PDF Report Button */}\n                    <DownloadReportButton\n                        year={selectedYear}\n                        globalStats={profitabilityData.reduce((acc, curr) => ({\n                            revenue: acc.revenue + curr.totalRevenue,\n                            expenses: acc.expenses + curr.totalExpenses,\n                            profit: acc.profit + curr.netProfit,\n                            margin: (acc.revenue + curr.totalRevenue) > 0\n                                ? ((acc.profit + curr.netProfit) / (acc.revenue + curr.totalRevenue) * 100)\n                                : 0\n                        }), { revenue: 0, expenses: 0, profit: 0, margin: 0 })}\n                        properties={profitabilityData}\n                    />\n\n                    {/* Add Expense Button */}\n                    <AddExpenseDialog properties={properties} onExpenseAdded={refreshExpenses} />\n                </div>\n            </div>\n\n            {/* Tabs for Revenue vs Expenses vs Profitability */}\n            <Tabs id=\"tour-compta-tabs\" value={activeTab} onValueChange={(v) => setActiveTab(v as 'revenus' | 'depenses' | 'rentabilite')} className=\"w-full\">\n                <TabsList className={`w-full md:w-auto ${isDark ? 'bg-slate-900 border border-slate-800' : 'bg-gray-100 border border-gray-200'}`}>\n                    <TabsTrigger value=\"revenus\" className={`text-xs md:text-sm flex-1 md:flex-none ${isDark ? 'data-[state=active]:bg-slate-700 data-[state=active]:text-white' : 'data-[state=active]:bg-white data-[state=active]:text-gray-900'}`}>\n                        <span className=\"hidden md:inline\">Revenus (Loyers)</span>\n                        <span className=\"md:hidden\">Revenus</span>\n                    </TabsTrigger>\n                    <TabsTrigger value=\"depenses\" className={`text-xs md:text-sm flex-1 md:flex-none ${isDark ? 'data-[state=active]:bg-slate-700 data-[state=active]:text-white' : 'data-[state=active]:bg-white data-[state=active]:text-gray-900'}`}>\n                        D√©penses\n                    </TabsTrigger>\n                    <TabsTrigger value=\"rentabilite\" className={`text-xs md:text-sm flex-1 md:flex-none ${isDark ? 'data-[state=active]:bg-slate-700 data-[state=active]:text-white' : 'data-[state=active]:bg-white data-[state=active]:text-gray-900'}`}>\n                        Rentabilit√©\n                    </TabsTrigger>\n                </TabsList>\n\n                {/* REVENUS TAB CONTENT */}\n                <TabsContent value=\"revenus\" className=\"mt-6 space-y-6\">\n                    {/* KPI Cards */}\n                    <div id=\"tour-compta-kpi\" className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4\">\n                        {/* Total Expected */}\n                        <div className={`p-3 md:p-5 rounded-lg border shadow-sm ${isDark ? 'bg-black border-gray-800' : 'bg-white border-gray-200'}`}>\n                            <div className=\"flex items-center gap-2 md:gap-3 mb-2 md:mb-3\">\n                                <div className={`p-1.5 md:p-2 rounded-md ${isDark ? 'bg-blue-900/20 text-blue-400' : 'bg-blue-100 text-blue-600'}`}>\n                                    <Wallet className=\"w-3.5 h-3.5 md:w-4 md:h-4\" />\n                                </div>\n                                <span className={`text-[10px] md:text-xs font-medium uppercase tracking-wider ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>Attendu</span>\n                            </div>\n                            <div className=\"flex items-baseline gap-1\">\n                                <span className={`text-xl md:text-3xl font-semibold tracking-tighter ${isDark ? 'text-white' : 'text-gray-900'}`}>{formatAmount(totals.expected)}</span>\n                                <span className={`text-[10px] md:text-sm font-normal ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>FCFA</span>\n                            </div>\n                        </div>\n\n                        {/* Collected */}\n                        <div className={`p-3 md:p-5 rounded-lg border shadow-sm ${isDark ? 'bg-black border-gray-800' : 'bg-white border-gray-200'}`}>\n                            <div className=\"flex items-center gap-2 md:gap-3 mb-2 md:mb-3\">\n                                <div className={`p-1.5 md:p-2 rounded-md ${isDark ? 'bg-green-900/20 text-green-400' : 'bg-green-100 text-green-600'}`}>\n                                    <TrendingUp className=\"w-3.5 h-3.5 md:w-4 md:h-4\" />\n                                </div>\n                                <span className={`text-[10px] md:text-xs font-medium uppercase tracking-wider ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>Encaiss√©</span>\n                            </div>\n                            <div className=\"flex items-baseline gap-1\">\n                                <span className={`text-xl md:text-3xl font-semibold tracking-tighter ${isDark ? 'text-white' : 'text-gray-900'}`}>{formatAmount(totals.collected)}</span>\n                                <span className={`text-[10px] md:text-sm font-normal ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>FCFA</span>\n                            </div>\n                            <p className=\"text-[10px] md:text-xs text-green-500 mt-1.5 md:mt-2 flex items-center gap-1\">\n                                <ArrowUpRight className=\"w-3 h-3\" />\n                                <span className=\"truncate\">{totals.collectionRate}% taux de recouvrement</span>\n                            </p>\n                        </div>\n\n                        {/* Pending */}\n                        <div className={`p-3 md:p-5 rounded-lg border shadow-sm ${isDark ? 'bg-black border-gray-800' : 'bg-white border-gray-200'}`}>\n                            <div className=\"flex items-center gap-2 md:gap-3 mb-2 md:mb-3\">\n                                <div className={`p-1.5 md:p-2 rounded-md ${isDark ? 'bg-amber-900/20 text-amber-400' : 'bg-amber-100 text-amber-600'}`}>\n                                    <DollarSign className=\"w-3.5 h-3.5 md:w-4 md:h-4\" />\n                                </div>\n                                <span className={`text-[10px] md:text-xs font-medium uppercase tracking-wider ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>En attente</span>\n                            </div>\n                            <div className=\"flex items-baseline gap-1\">\n                                <span className={`text-xl md:text-3xl font-semibold tracking-tighter ${isDark ? 'text-white' : 'text-gray-900'}`}>{formatAmount(totals.pending)}</span>\n                                <span className={`text-[10px] md:text-sm font-normal ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>FCFA</span>\n                            </div>\n                        </div>\n\n                        {/* Overdue */}\n                        <div className={`p-3 md:p-5 rounded-lg border shadow-sm ${isDark ? 'bg-black border-gray-800' : 'bg-white border-gray-200'}`}>\n                            <div className=\"flex items-center gap-2 md:gap-3 mb-2 md:mb-3\">\n                                <div className={`p-1.5 md:p-2 rounded-md ${isDark ? 'bg-red-900/20 text-red-400' : 'bg-red-100 text-red-600'}`}>\n                                    <AlertTriangle className=\"w-3.5 h-3.5 md:w-4 md:h-4\" />\n                                </div>\n                                <span className={`text-[10px] md:text-xs font-medium uppercase tracking-wider ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>Retards</span>\n                            </div>\n                            <div className=\"flex items-baseline gap-1\">\n                                <span className={`text-xl md:text-3xl font-semibold tracking-tighter ${isDark ? 'text-white' : 'text-gray-900'}`}>{formatAmount(totals.overdue)}</span>\n                                <span className={`text-[10px] md:text-sm font-normal ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>FCFA</span>\n                            </div>\n                            {totals.overdue > 0 && (\n                                <Link\n                                    href=\"/gestion?filter=overdue\"\n                                    className=\"text-[10px] md:text-xs text-red-500 mt-1.5 md:mt-2 flex items-center gap-1 hover:underline\"\n                                >\n                                    Voir les impay√©s ‚Üí\n                                </Link>\n                            )}\n                        </div>\n                    </div>\n\n                    {/* Charts Grid */}\n                    <div id=\"tour-compta-chart\" className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                        {/* Bar Chart - Monthly Revenue */}\n                        <div className={`lg:col-span-2 p-5 rounded-xl border ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'\n                            }`}>\n                            <h3 className={`text-sm font-semibold mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>Revenus Mensuels {selectedYear}</h3>\n                            <div className=\"h-72\">\n                                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                    <BarChart data={chartData} margin={{ top: 5, right: 5, left: 0, bottom: 5 }}>\n                                        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#334155\" />\n                                        <XAxis dataKey=\"shortMonth\" tick={{ fill: '#94a3b8', fontSize: 12 }} />\n                                        <YAxis tick={{ fill: '#94a3b8', fontSize: 12 }} tickFormatter={formatAmount} />\n                                        <Tooltip\n                                            contentStyle={{\n                                                backgroundColor: '#1e293b',\n                                                border: '1px solid #334155',\n                                                borderRadius: '8px',\n                                                color: '#fff'\n                                            }}\n                                            formatter={(value: any) => [`${Number(value).toLocaleString('fr-FR')} FCFA`]}\n                                        />\n                                        <Bar dataKey=\"collected\" name=\"Encaiss√©\" fill={chartColors.collected} radius={[4, 4, 0, 0]} />\n                                        <Bar dataKey=\"pending\" name=\"En attente\" fill={chartColors.pending} radius={[4, 4, 0, 0]} />\n                                        <Bar dataKey=\"future\" name=\"√Ä venir\" fill={chartColors.future} radius={[4, 4, 0, 0]} />\n                                        <Bar dataKey=\"overdue\" name=\"Retards\" fill={chartColors.overdue} radius={[4, 4, 0, 0]} />\n                                    </BarChart>\n                                </ResponsiveContainer>\n                            </div>\n                        </div>\n\n                        {/* Pie Chart - Distribution */}\n                        <div className={`p-5 rounded-xl border ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'\n                            }`}>\n                            <h3 className={`text-sm font-semibold mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>R√©partition des Paiements</h3>\n                            <div className=\"h-72\">\n                                {pieData.length > 0 ? (\n                                    <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                        <PieChart>\n                                            <Pie\n                                                data={pieData}\n                                                cx=\"50%\"\n                                                cy=\"50%\"\n                                                innerRadius={60}\n                                                outerRadius={90}\n                                                paddingAngle={2}\n                                                dataKey=\"value\"\n                                            >\n                                                {pieData.map((entry, index) => (\n                                                    <Cell key={`cell-${index}`} fill={entry.color} />\n                                                ))}\n                                            </Pie>\n                                            <Tooltip\n                                                contentStyle={{\n                                                    backgroundColor: '#1e293b',\n                                                    border: '1px solid #334155',\n                                                    borderRadius: '8px',\n                                                    color: '#fff'\n                                                }}\n                                                formatter={(value: any) => [`${Number(value).toLocaleString('fr-FR')} FCFA`]}\n                                            />\n                                            <Legend\n                                                verticalAlign=\"bottom\"\n                                                formatter={(value) => <span className=\"text-xs text-slate-400\">{value}</span>}\n                                            />\n                                        </PieChart>\n                                    </ResponsiveContainer>\n                                ) : (\n                                    <div className={`h-full flex items-center justify-center text-sm ${isDark ? 'text-slate-500' : 'text-gray-500'\n                                        }`}>\n                                        Aucune donn√©e disponible\n                                    </div>\n                                )}\n                            </div>\n                        </div>\n                    </div>\n\n                    {/* Collection Rate Line Chart */}\n                    <div className={`p-5 rounded-xl border ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'\n                        }`}>\n                        <h3 className={`text-sm font-semibold mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>Taux de Recouvrement Mensuel</h3>\n                        <div className=\"h-64\">\n                            <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                <LineChart data={chartData} margin={{ top: 5, right: 20, left: 0, bottom: 5 }}>\n                                    <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#334155\" />\n                                    <XAxis dataKey=\"shortMonth\" tick={{ fill: '#94a3b8', fontSize: 12 }} />\n                                    <YAxis tick={{ fill: '#94a3b8', fontSize: 12 }} domain={[0, 100]} tickFormatter={(v) => `${v}%`} />\n                                    <Tooltip\n                                        contentStyle={{\n                                            backgroundColor: '#1e293b',\n                                            border: '1px solid #334155',\n                                            borderRadius: '8px',\n                                            color: '#fff'\n                                        }}\n                                        formatter={(value: any) => [`${value}%`, 'Taux']}\n                                    />\n                                    <Line\n                                        type=\"monotone\"\n                                        dataKey=\"collectionRate\"\n                                        name=\"Taux de recouvrement\"\n                                        stroke=\"#3b82f6\"\n                                        strokeWidth={2}\n                                        dot={{ fill: '#3b82f6', strokeWidth: 2 }}\n                                        activeDot={{ r: 6, fill: '#3b82f6' }}\n                                    />\n                                </LineChart>\n                            </ResponsiveContainer>\n                        </div>\n                    </div>\n                </TabsContent>\n\n                {/* DEPENSES TAB CONTENT */}\n                <TabsContent value=\"depenses\" className=\"mt-6\">\n                    <ExpenseList expenses={expenses} onExpenseDeleted={refreshExpenses} />\n                </TabsContent>\n\n                {/* RENTABILITE TAB CONTENT */}\n                <TabsContent value=\"rentabilite\" className=\"mt-6\">\n                    <ProfitabilityTable year={selectedYear} />\n                </TabsContent>\n            </Tabs>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\config\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5482,5485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5482,5485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\nimport { _invalidateCache } from '@/lib/cache/cache-aside';\nimport { getUserTeamContext } from '@/lib/team-context';\nimport { requireTeamPermission } from '@/lib/permissions';\n\nexport async function updateBranding(formData: FormData) {\n    const { teamId } = await requireTeamPermission(\"team.settings.edit\");\n    const supabase = await createClient();\n\n    const updates = {\n        name: formData.get('company_name'), // Map company_name -> name\n        company_address: formData.get('company_address'),\n        company_phone: formData.get('company_phone'),\n        company_email: formData.get('company_email'),\n        company_ninea: formData.get('company_ninea'),\n        updated_at: new Date().toISOString()\n    };\n\n    const { error } = await supabase\n        .from('teams')\n        .update(updates)\n        .eq('id', teamId);\n\n    if (!error) {\n        // IMPORTANT: Revalider TOUTES les pages qui utilisent le profil/team\n        revalidatePath('/gestion/config');\n        revalidatePath('/gestion');\n    }\n\n    return { success: !error, error: error?.message };\n}\n\n/**\n * Met √† jour les param√®tres de branding Premium de l'utilisateur\n */\nexport async function updatePremiumBranding(formData: {\n    company_name?: string;\n    company_address?: string;\n    company_phone?: string;\n    company_email?: string;\n    company_ninea?: string;\n}) {\n    const { teamId } = await requireTeamPermission(\"team.settings.edit\");\n    const supabase = await createClient();\n\n    const updates = {\n        name: formData.company_name,\n        company_address: formData.company_address || null,\n        company_phone: formData.company_phone || null,\n        company_email: formData.company_email || null,\n        company_ninea: formData.company_ninea || null,\n        updated_at: new Date().toISOString()\n    };\n\n    const { error } = await supabase\n        .from('teams')\n        .update(updates)\n        .eq('id', teamId);\n\n    if (error) {\n        console.error(\"Erreur mise √† jour branding:\", error.message);\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion/config');\n    return { success: true };\n}\n\n/**\n * Upload du logo vers Supabase Storage et mise √† jour du profil\n */\nexport async function uploadLogo(file: File) {\n    const { teamId } = await requireTeamPermission(\"team.settings.edit\");\n    const supabase = await createClient();\n\n    // G√©n√©rer un nom de fichier unique avec teamId\n    const fileExt = file.name.split('.').pop();\n    const fileName = `teams/${teamId}/logo_${Date.now()}.${fileExt}`;\n\n    // Upload vers le bucket 'branding'\n    const { data: _uploadData, error: uploadError } = await supabase.storage\n        .from('branding')\n        .upload(fileName, file, { upsert: true });\n\n    if (uploadError) {\n        console.error(\"Erreur upload logo:\", uploadError.message);\n        return { success: false, error: uploadError.message };\n    }\n\n    // Obtenir l'URL publique\n    const { data: { publicUrl } } = supabase.storage\n        .from('branding')\n        .getPublicUrl(fileName);\n\n    // Mettre √† jour l'√©quipe\n    const { error } = await supabase\n        .from('teams')\n        .update({ logo_url: publicUrl })\n        .eq('id', teamId);\n\n    if (error) {\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion/config');\n    return { success: true, url: publicUrl };\n}\n\n/**\n * Upload de la signature vers Supabase Storage et mise √† jour du profil\n */\nexport async function uploadSignature(file: File) {\n    const { teamId } = await requireTeamPermission(\"team.settings.edit\");\n    const supabase = await createClient();\n\n    const fileExt = file.name.split('.').pop();\n    const fileName = `teams/${teamId}/signature_${Date.now()}.${fileExt}`;\n\n    const { data: _uploadData, error: uploadError } = await supabase.storage\n        .from('branding')\n        .upload(fileName, file, { upsert: true });\n\n    if (uploadError) {\n        console.error(\"Erreur upload signature:\", uploadError.message);\n        return { success: false, error: uploadError.message };\n    }\n\n    const { data: { publicUrl } } = supabase.storage\n        .from('branding')\n        .getPublicUrl(fileName);\n\n    const { error } = await supabase\n        .from('teams')\n        .update({ signature_url: publicUrl })\n        .eq('id', teamId);\n\n    if (error) {\n        return { success: false, error: error.message };\n    }\n\n    revalidatePath('/gestion/config');\n    return { success: true, url: publicUrl };\n}\n\n/**\n * R√©cup√©rer les donn√©es de branding de l'utilisateur\n */\nexport async function getPremiumBranding() {\n    try {\n        const { user, team } = await getUserTeamContext();\n\n        // Mapper team -> Expected format (fallback to profile if needed)\n        const data = {\n            full_name: user?.user_metadata?.full_name,\n            company_name: team?.name,\n            company_address: team?.company_address,\n            company_phone: team?.company_phone,\n            company_email: team?.company_email,\n            company_ninea: team?.company_ninea,\n            logo_url: team?.logo_url,\n            signature_url: team?.signature_url\n        };\n\n        return { success: true, data };\n    } catch (_err) {\n        return { success: false, data: null };\n    }\n}\n\nconst N8N_WEBHOOK_URL = process.env.N8N_WEBHOOK_URL;\n\nexport async function sendTestEmail(profileData: any) {\n    // ‚úÖ CORRECTION S√âCURIT√â: V√©rification de permission renforc√©e\n    // Seuls les membres avec permission team.settings.edit peuvent envoyer des emails de test\n    const { _teamId, user } = await requireTeamPermission(\"team.settings.edit\");\n    const _supabase = await createClient();\n\n    if (!N8N_WEBHOOK_URL) {\n        console.warn('N8N_WEBHOOK_URL non configur√©');\n        // Fallback simulation for dev environment if no webhook\n        await new Promise(resolve => setTimeout(resolve, 1000));\n        return { success: true, message: \"Simulation (Webhook non configur√©)\" };\n    }\n\n    try {\n        // Construct the test payload with user's specific branding\n        const payload = {\n            type: 'test_email',\n            recipientEmail: user.email, // Send to the logged-in user\n            ownerName: profileData?.full_name || \"Nom Propri√©taire\",\n            companyName: profileData?.company_name || \"Nom Agence\",\n            companyAddress: profileData?.company_address || \"Adresse Agence\",\n            companyLogo: profileData?.logo_url || \"\",\n            companySignature: profileData?.signature_url || \"\",\n            // Add dummy data for template preview\n            tenantName: \"Jean Dupont (Exemple)\",\n            amount: 150000,\n            month: new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })\n        };\n\n        const response = await fetch(`${N8N_WEBHOOK_URL}/generate-lease-pdf`, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(payload),\n        });\n\n        if (!response.ok) {\n            throw new Error(`Webhook error: ${response.status}`);\n        }\n\n        return { success: true };\n    } catch (error) {\n        console.error('Erreur envoi test:', error);\n        return { success: false, error: \"Erreur lors de l'envoi\" };\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\config\\api-settings.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[320,323],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[320,323],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { Mail, CheckCircle2, ShieldCheck, Lock, MessageSquare, Send, RefreshCw } from 'lucide-react';\nimport { Button } from \"@/components/ui/button\";\n\nimport { sendTestEmail } from './actions';\nimport { toast } from 'sonner';\n\ninterface ApiSettingsProps {\n    profile?: any;\n}\n\nexport function ApiSettings({ profile }: ApiSettingsProps) {\n    const [testing, setTesting] = useState(false);\n    const [testSuccess, setTestSuccess] = useState(false);\n\n    const handleTestEmail = async () => {\n        setTesting(true);\n        try {\n            const result = await sendTestEmail(profile);\n            if (result.success) {\n                setTestSuccess(true);\n                toast.success(\"Email de test envoy√© avec vos param√®tres !\");\n                setTimeout(() => setTestSuccess(false), 5000);\n            } else {\n                toast.error(result.error || \"Erreur lors de l'envoi\");\n            }\n        } catch (_e) {\n            toast.error(\"Erreur technique\");\n        } finally {\n            setTesting(false);\n        }\n    };\n\n    return (\n        <div className=\"space-y-8 mt-10\">\n            <div className=\"flex items-center gap-2 text-primary font-bold\">\n                <ShieldCheck className=\"w-5 h-5\" />\n                <h2 className=\"text-lg\">Configuration des Envois Premium</h2>\n            </div>\n\n            <div className=\"grid grid-cols-1 gap-6\">\n                {/* Focus Principal : Gmail */}\n                <div className=\"p-6 md:p-8 bg-primary/5 border border-primary/20 rounded-[2rem]\">\n                    <div className=\"flex flex-col md:flex-row items-start md:items-center gap-6\">\n                        <div className=\"p-4 bg-primary/20 rounded-2xl shrink-0\">\n                            <Mail className=\"w-8 h-8 text-primary\" />\n                        </div>\n\n                        <div className=\"flex-1 space-y-3\">\n                            <div className=\"flex flex-wrap items-center gap-2\">\n                                <h3 className=\"text-xl font-bold\">Service Email (Gmail)</h3>\n                                <span className=\"text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full uppercase font-bold\">\n                                    Actif\n                                </span>\n                            </div>\n\n                            <p className=\"text-sm text-gray-400\">\n                                Votre compte Gmail est utilis√© pour envoyer automatiquement les{' '}\n                                <span className=\"text-primary font-medium\">Baux</span>,{' '}\n                                <span className=\"text-primary font-medium\">Avis d&apos;√©ch√©ance</span> et{' '}\n                                <span className=\"text-primary font-medium\">Quittances</span> √† vos locataires.\n                            </p>\n\n                            <div className=\"flex items-center gap-2 text-xs text-primary font-medium\">\n                                <CheckCircle2 className=\"w-4 h-4\" />\n                                Certificats PDF envoy√©s avec succ√®s via votre adresse li√©e.\n                            </div>\n\n\n                        </div>\n\n                        <div className=\"w-full md:w-auto\">\n                            <Button\n                                className={`w-full md:w-auto h-10 border transition-all ${testSuccess\n                                    ? 'border-green-500/50 text-green-400 bg-green-500/10'\n                                    : 'border-slate-300 dark:border-gray-700 text-slate-700 dark:text-gray-400 bg-transparent hover:bg-slate-100 dark:hover:bg-gray-800 hover:text-slate-900 dark:hover:text-primary'\n                                    }`}\n                                onClick={handleTestEmail}\n                                disabled={testing}\n                            >\n                                {testing ? (\n                                    <><RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" /> Envoi en cours...</>\n                                ) : testSuccess ? (\n                                    <><CheckCircle2 className=\"w-4 h-4 mr-2\" /> Email envoy√©!</>\n                                ) : (\n                                    <><Send className=\"w-4 h-4 mr-2\" /> Tester l&apos;envoi</>\n                                )}\n                            </Button>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Section WhatsApp (D√©sactiv√©e - Bient√¥t disponible) */}\n                <div className=\"p-6 bg-gray-900/20 border border-gray-800 rounded-[2rem] relative overflow-hidden\">\n                    {/* Overlay \"Coming Soon\" */}\n                    <div className=\"absolute inset-0 bg-black/20 backdrop-blur-[1px] z-10 flex items-center justify-center\">\n                        <div className=\"bg-gray-800 px-4 py-2 rounded-full flex items-center gap-2 text-xs font-bold text-gray-300 shadow-xl border border-gray-700\">\n                            <Lock className=\"w-3 h-3\" /> Bient√¥t disponible\n                        </div>\n                    </div>\n\n                    {/* Contenu d√©sactiv√© */}\n                    <div className=\"opacity-40\">\n                        <div className=\"flex items-center gap-3 mb-4\">\n                            <div className=\"p-3 bg-gray-800 rounded-xl\">\n                                <MessageSquare className=\"w-5 h-5 text-gray-500\" />\n                            </div>\n                            <div>\n                                <h3 className=\"font-bold text-gray-500\">Notifications WhatsApp</h3>\n                                <p className=\"text-xs text-gray-600\">Envoyez des rappels directement sur WhatsApp</p>\n                            </div>\n                        </div>\n                        <div className=\"space-y-2\">\n                            <div className=\"h-10 w-full bg-gray-800/50 rounded-xl\"></div>\n                            <div className=\"h-10 w-2/3 bg-gray-800/50 rounded-xl\"></div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            {/* Note informative */}\n            <div className=\"p-4 bg-gray-900/30 border border-gray-800 rounded-2xl\">\n                <p className=\"text-xs text-gray-500 text-center\">\n                    üí° Les emails sont envoy√©s automatiquement via n8n. Assurez-vous que votre workflow n8n est configur√©\n                    et que votre compte Gmail est connect√© dans les param√®tres n8n.\n                </p>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\config\\config-form.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":115,"column":9,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":115,"endColumn":71},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":143,"column":13,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":143,"endColumn":77},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":260,"column":33,"nodeType":"JSXOpeningElement","endLine":260,"endColumn":105},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":339,"column":37,"nodeType":"JSXOpeningElement","endLine":339,"endColumn":119},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":498,"column":33,"nodeType":"JSXOpeningElement","endLine":498,"endColumn":101},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":521,"column":29,"nodeType":"JSXOpeningElement","endLine":521,"endColumn":107}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useRef, useEffect } from 'react';\nimport { Upload, PenTool, Building2, Save, Check, Phone, Mail, MapPin, Loader2, Trash2 } from 'lucide-react';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { updateBranding } from './actions';\nimport { toast } from 'sonner';\n\ninterface BrandingData {\n    company_name?: string | null;\n    company_address?: string | null;\n    company_phone?: string | null;\n    company_email?: string | null;\n    company_ninea?: string | null;\n    logo_url?: string | null;\n    signature_url?: string | null;\n}\n\ninterface ConfigFormProps {\n    initialData: BrandingData | null;\n}\n\nexport function ConfigForm({ initialData }: ConfigFormProps) {\n    const [logoPreview, setLogoPreview] = useState<string | null>(initialData?.logo_url || null);\n    const [signaturePreview, setSignaturePreview] = useState<string | null>(initialData?.signature_url || null);\n    const [saving, setSaving] = useState(false);\n    const [saved, setSaved] = useState(false);\n    const [uploadingLogo, setUploadingLogo] = useState(false);\n    const [uploadingSignature, setUploadingSignature] = useState(false);\n    const [signatureMode, setSignatureMode] = useState<'upload' | 'draw'>('upload');\n\n    // Canvas drawing state\n    const canvasRef = useRef<HTMLCanvasElement>(null);\n    const [isDrawing, setIsDrawing] = useState(false);\n    const [hasDrawn, setHasDrawn] = useState(false);\n\n    const [formData, setFormData] = useState({\n        company_name: initialData?.company_name || '',\n        company_address: initialData?.company_address || '',\n        company_phone: initialData?.company_phone || '',\n        company_email: initialData?.company_email || '',\n        company_ninea: initialData?.company_ninea || ''\n    });\n\n    // Initialize canvas\n    useEffect(() => {\n        if (signatureMode === 'draw' && canvasRef.current) {\n            const canvas = canvasRef.current;\n            const ctx = canvas.getContext('2d');\n            if (!ctx) return;\n\n            const rect = canvas.getBoundingClientRect();\n            canvas.width = rect.width * 2;\n            canvas.height = rect.height * 2;\n            ctx.scale(2, 2);\n            ctx.strokeStyle = '#000000';\n            ctx.lineWidth = 2;\n            ctx.lineCap = 'round';\n            ctx.lineJoin = 'round';\n            ctx.fillStyle = 'white';\n            ctx.fillRect(0, 0, rect.width, rect.height);\n        }\n    }, [signatureMode]);\n\n    const getCoordinates = (e: React.MouseEvent | React.TouchEvent) => {\n        const canvas = canvasRef.current;\n        if (!canvas) return { x: 0, y: 0 };\n        const rect = canvas.getBoundingClientRect();\n        if ('touches' in e) {\n            return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };\n        }\n        return { x: e.clientX - rect.left, y: e.clientY - rect.top };\n    };\n\n    const startDrawing = (e: React.MouseEvent | React.TouchEvent) => {\n        e.preventDefault();\n        const ctx = canvasRef.current?.getContext('2d');\n        if (!ctx) return;\n        const { x, y } = getCoordinates(e);\n        ctx.beginPath();\n        ctx.moveTo(x, y);\n        setIsDrawing(true);\n    };\n\n    const draw = (e: React.MouseEvent | React.TouchEvent) => {\n        if (!isDrawing) return;\n        e.preventDefault();\n        const ctx = canvasRef.current?.getContext('2d');\n        if (!ctx) return;\n        const { x, y } = getCoordinates(e);\n        ctx.lineTo(x, y);\n        ctx.stroke();\n        setHasDrawn(true);\n    };\n\n    const stopDrawing = () => {\n        setIsDrawing(false);\n    };\n\n    const clearCanvas = () => {\n        const canvas = canvasRef.current;\n        const ctx = canvas?.getContext('2d');\n        if (!ctx || !canvas) return;\n        const rect = canvas.getBoundingClientRect();\n        ctx.fillStyle = 'white';\n        ctx.fillRect(0, 0, rect.width, rect.height);\n        setHasDrawn(false);\n        setSignaturePreview(null);\n    };\n\n    const handleFileUpload = async (file: File, type: 'logo' | 'signature') => {\n        const isLogo = type === 'logo';\n        isLogo ? setUploadingLogo(true) : setUploadingSignature(true);\n\n        try {\n            const uploadFormData = new FormData();\n            uploadFormData.append('file', file);\n            uploadFormData.append('type', type);\n\n            const response = await fetch('/api/branding/upload', {\n                method: 'POST',\n                body: uploadFormData\n            });\n\n            const result = await response.json();\n\n            if (result.success) {\n                if (isLogo) {\n                    setLogoPreview(result.url);\n                } else {\n                    setSignaturePreview(result.url);\n                }\n                toast.success(result.message || `${isLogo ? 'Logo' : 'Signature'} enregistr√©!`);\n            } else {\n                toast.error(result.error || 'Erreur lors de l\\'upload');\n            }\n        } catch (error) {\n            console.error('Erreur upload:', error);\n            toast.error('Erreur lors de l\\'upload du fichier');\n        } finally {\n            isLogo ? setUploadingLogo(false) : setUploadingSignature(false);\n        }\n    };\n\n    const saveDrawnSignature = async () => {\n        const canvas = canvasRef.current;\n        if (!canvas) return;\n\n        setUploadingSignature(true);\n\n        // Use toBlob instead of fetch(dataUrl) to avoid CSP violation\n        canvas.toBlob(async (blob) => {\n            if (!blob) {\n                toast.error('Erreur lors de la cr√©ation de l\\'image');\n                setUploadingSignature(false);\n                return;\n            }\n\n            try {\n                const file = new File([blob], 'signature.png', { type: 'image/png' });\n\n                const uploadFormData = new FormData();\n                uploadFormData.append('file', file);\n                uploadFormData.append('type', 'signature');\n\n                const response = await fetch('/api/branding/upload', {\n                    method: 'POST',\n                    body: uploadFormData\n                });\n\n                const result = await response.json();\n                console.log('API Response:', result);\n\n                if (result.success) {\n                    setSignaturePreview(result.url);\n                    toast.success('Signature enregistr√©e!');\n                } else {\n                    console.error('Upload failed:', result);\n                    toast.error(result.error || 'Erreur lors de l\\'upload');\n                }\n            } catch (error) {\n                console.error('Erreur upload:', error);\n                toast.error('Erreur lors de l\\'upload de la signature');\n            } finally {\n                setUploadingSignature(false);\n            }\n        }, 'image/png');\n    };\n\n    const handleLogoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const file = e.target.files?.[0];\n        if (file) {\n            const reader = new FileReader();\n            reader.onloadend = () => setLogoPreview(reader.result as string);\n            reader.readAsDataURL(file);\n            handleFileUpload(file, 'logo');\n        }\n    };\n\n    const handleSignatureUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const file = e.target.files?.[0];\n        if (file) {\n            const reader = new FileReader();\n            reader.onloadend = () => setSignaturePreview(reader.result as string);\n            reader.readAsDataURL(file);\n            handleFileUpload(file, 'signature');\n        }\n    };\n\n    const handleSave = async () => {\n        setSaving(true);\n\n        const formDataObj = new FormData();\n        if (formData.company_name) formDataObj.append('company_name', formData.company_name);\n        if (formData.company_address) formDataObj.append('company_address', formData.company_address);\n        if (formData.company_phone) formDataObj.append('company_phone', formData.company_phone);\n        if (formData.company_email) formDataObj.append('company_email', formData.company_email);\n        if (formData.company_ninea) formDataObj.append('company_ninea', formData.company_ninea);\n\n        const result = await updateBranding(formDataObj);\n\n        setSaving(false);\n        if (result.success) {\n            setSaved(true);\n            toast.success('Configuration enregistr√©e!');\n            setTimeout(() => setSaved(false), 3000);\n        } else {\n            toast.error(result.error || 'Erreur lors de la sauvegarde');\n        }\n    };\n\n    const handleInputChange = (field: keyof typeof formData, value: string) => {\n        setFormData(prev => ({ ...prev, [field]: value }));\n    };\n\n    return (\n        <div className=\"space-y-10\">\n            {/* Upload Sections */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\n                {/* Section Logo */}\n                <section className=\"space-y-4 p-6 bg-white dark:bg-gray-900/40 rounded-3xl border border-slate-200 dark:border-gray-800 shadow-sm dark:shadow-none\">\n                    <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-primary font-bold\">\n                            <Building2 className=\"w-5 h-5\" /> Logo de l&apos;Agence\n                        </div>\n                        {uploadingLogo && (\n                            <div className=\"flex items-center gap-2 text-xs text-primary\">\n                                <Loader2 className=\"w-3 h-3 animate-spin\" /> Upload...\n                            </div>\n                        )}\n                    </div>\n                    <label className=\"block\">\n                        <div className={`h-40 border-2 border-dashed rounded-2xl flex flex-col items-center justify-center transition-all cursor-pointer relative overflow-hidden ${logoPreview\n                            ? 'border-primary/50 bg-primary/5'\n                            : 'border-slate-300 dark:border-gray-700 bg-slate-50 dark:bg-gray-900/20 hover:border-primary/50'\n                            } ${uploadingLogo ? 'opacity-50 pointer-events-none' : ''}`}>\n                            {logoPreview ? (\n                                <img src={logoPreview} alt=\"Logo\" className=\"max-h-32 object-contain\" />\n                            ) : (\n                                <>\n                                    <Upload className=\"w-8 h-8 text-gray-600 mb-2\" />\n                                    <p className=\"text-xs text-gray-500 text-center px-4\">\n                                        Cliquez pour ajouter votre logo\n                                    </p>\n                                    <p className=\"text-[10px] text-gray-600 mt-1\">PNG, JPG (max 2MB)</p>\n                                </>\n                            )}\n                        </div>\n                        <input\n                            type=\"file\"\n                            accept=\"image/png,image/jpeg,image/webp\"\n                            className=\"hidden\"\n                            onChange={handleLogoUpload}\n                            disabled={uploadingLogo}\n                        />\n                    </label>\n                    {logoPreview && !uploadingLogo && (\n                        <div className=\"flex items-center justify-between\">\n                            <span className=\"text-xs text-green-400 flex items-center gap-1\">\n                                <Check className=\"w-3 h-3\" /> Logo enregistr√©\n                            </span>\n                            <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"text-red-400 text-xs hover:bg-red-500/10\"\n                                onClick={() => setLogoPreview(null)}\n                            >\n                                <Trash2 className=\"w-3 h-3 mr-1\" /> Supprimer\n                            </Button>\n                        </div>\n                    )}\n                </section>\n\n                {/* Section Signature - With Tabs */}\n                <section className=\"space-y-4 p-6 bg-white dark:bg-gray-900/40 rounded-3xl border border-slate-200 dark:border-gray-800 shadow-sm dark:shadow-none\">\n                    <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-primary font-bold\">\n                            <PenTool className=\"w-5 h-5\" /> Signature Num√©rique\n                        </div>\n                        {uploadingSignature && (\n                            <div className=\"flex items-center gap-2 text-xs text-primary\">\n                                <Loader2 className=\"w-3 h-3 animate-spin\" /> Upload...\n                            </div>\n                        )}\n                    </div>\n\n                    {/* Mode Toggle */}\n                    <div className=\"flex gap-2 p-1 bg-slate-100 dark:bg-gray-800 rounded-xl\">\n                        <button\n                            onClick={() => setSignatureMode('upload')}\n                            className={`flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-lg text-sm font-medium transition-all ${signatureMode === 'upload'\n                                ? 'bg-primary text-primary-foreground shadow-md'\n                                : 'text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white'\n                                }`}\n                        >\n                            <Upload className=\"w-4 h-4\" /> Importer\n                        </button>\n                        <button\n                            onClick={() => setSignatureMode('draw')}\n                            className={`flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-lg text-sm font-medium transition-all ${signatureMode === 'draw'\n                                ? 'bg-primary text-primary-foreground shadow-md'\n                                : 'text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white'\n                                }`}\n                        >\n                            <PenTool className=\"w-4 h-4\" /> Dessiner\n                        </button>\n                    </div>\n\n                    {signatureMode === 'upload' ? (\n                        /* Upload Mode */\n                        <label className=\"block\">\n                            <div className={`h-40 border-2 border-dashed rounded-2xl flex flex-col items-center justify-center transition-all cursor-pointer relative overflow-hidden ${signaturePreview\n                                ? 'border-primary/50 bg-primary/5'\n                                : 'border-slate-300 dark:border-gray-700 bg-slate-50 dark:bg-gray-900/20 hover:border-primary/50'\n                                } ${uploadingSignature ? 'opacity-50 pointer-events-none' : ''}`}>\n                                {signaturePreview ? (\n                                    <img src={signaturePreview} alt=\"Signature\" className=\"max-h-32 object-contain\" />\n                                ) : (\n                                    <>\n                                        <Upload className=\"w-8 h-8 text-gray-600 mb-2\" />\n                                        <p className=\"text-xs text-gray-500 text-center px-4\">\n                                            Importez votre signature scann√©e\n                                        </p>\n                                        <p className=\"text-[10px] text-gray-600 mt-1\">PNG avec fond transparent recommand√©</p>\n                                    </>\n                                )}\n                            </div>\n                            <input\n                                type=\"file\"\n                                accept=\"image/png,image/jpeg,image/webp\"\n                                className=\"hidden\"\n                                onChange={handleSignatureUpload}\n                                disabled={uploadingSignature}\n                            />\n                        </label>\n                    ) : (\n                        /* Draw Mode */\n                        <div className=\"space-y-2\">\n                            <div className=\"relative\">\n                                <canvas\n                                    ref={canvasRef}\n                                    className=\"w-full h-40 bg-white border-2 border-slate-200 dark:border-transparent rounded-2xl cursor-crosshair touch-none\"\n                                    onMouseDown={startDrawing}\n                                    onMouseMove={draw}\n                                    onMouseUp={stopDrawing}\n                                    onMouseLeave={stopDrawing}\n                                    onTouchStart={startDrawing}\n                                    onTouchMove={draw}\n                                    onTouchEnd={stopDrawing}\n                                />\n                                {!hasDrawn && (\n                                    <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n                                        <p className=\"text-gray-400 text-sm\">Signez ici avec la souris ou le doigt</p>\n                                    </div>\n                                )}\n                            </div>\n                            <div className=\"flex gap-2\">\n                                <Button\n                                    size=\"sm\"\n                                    onClick={clearCanvas}\n                                    className=\"flex-1 border border-slate-300 dark:border-gray-700 text-slate-500 dark:text-gray-400 bg-transparent hover:bg-slate-100 dark:hover:bg-gray-800 hover:text-slate-900 dark:hover:text-white transition-colors\"\n                                >\n                                    <Trash2 className=\"w-3 h-3 mr-1\" /> Effacer\n                                </Button>\n                                <Button\n                                    size=\"sm\"\n                                    onClick={saveDrawnSignature}\n                                    disabled={!hasDrawn || uploadingSignature}\n                                    className=\"flex-1 bg-primary text-primary-foreground hover:bg-primary/90 font-bold shadow-lg shadow-primary/10\"\n                                >\n                                    {uploadingSignature ? (\n                                        <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                                    ) : (\n                                        <Check className=\"w-3 h-3 mr-1\" />\n                                    )}\n                                    Valider\n                                </Button>\n                            </div>\n                        </div>\n                    )}\n\n                    {signaturePreview && !uploadingSignature && signatureMode === 'upload' && (\n                        <div className=\"flex items-center justify-between\">\n                            <span className=\"text-xs text-green-400 flex items-center gap-1\">\n                                <Check className=\"w-3 h-3\" /> Signature enregistr√©e\n                            </span>\n                            <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"text-red-400 text-xs hover:bg-red-500/10\"\n                                onClick={() => setSignaturePreview(null)}\n                            >\n                                <Trash2 className=\"w-3 h-3 mr-1\" /> Supprimer\n                            </Button>\n                        </div>\n                    )}\n                </section>\n            </div >\n\n            {/* Informations Commerciales */}\n            < section className=\"p-6 md:p-8 bg-white dark:bg-gray-900/40 rounded-3xl border border-slate-200 dark:border-gray-800 space-y-6 shadow-sm dark:shadow-none\" >\n                <h2 className=\"text-lg font-bold flex items-center gap-2 text-slate-900 dark:text-white\">\n                    <Building2 className=\"w-5 h-5 text-slate-400 dark:text-gray-400\" />\n                    Informations de l&apos;√©metteur\n                </h2>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"company_name\" className=\"text-sm text-slate-500 dark:text-gray-400\" required>\n                            Nom commercial / Raison sociale\n                        </Label>\n                        <Input\n                            placeholder=\"ex: SCI Teranga Immo\"\n                            className=\"bg-slate-50 dark:bg-gray-800/50 border-slate-200 dark:border-gray-700 h-12 text-slate-900 dark:text-white\"\n                            value={formData.company_name}\n                            onChange={(e) => handleInputChange('company_name', e.target.value)}\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <label className=\"text-sm text-slate-500 dark:text-gray-400\">NINEA (optionnel)</label>\n                        <Input\n                            placeholder=\"ex: 12345678 A 01\"\n                            className=\"bg-slate-50 dark:bg-gray-800/50 border-slate-200 dark:border-gray-700 h-12 text-slate-900 dark:text-white\"\n                            value={formData.company_ninea}\n                            onChange={(e) => handleInputChange('company_ninea', e.target.value)}\n                        />\n                    </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                    <Label htmlFor=\"company_address\" className=\"text-sm text-slate-500 dark:text-gray-400 flex items-center gap-2\" required>\n                        <MapPin className=\"w-4 h-4\" /> Adresse compl√®te\n                    </Label>\n                    <Input\n                        placeholder=\"ex: Rue 10 x Avenue Cheikh Anta Diop, Dakar\"\n                        className=\"bg-slate-50 dark:bg-gray-800/50 border-slate-200 dark:border-gray-700 h-12 text-slate-900 dark:text-white\"\n                        value={formData.company_address}\n                        onChange={(e) => handleInputChange('company_address', e.target.value)}\n                    />\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"company_phone\" className=\"text-sm text-slate-500 dark:text-gray-400 flex items-center gap-2\" required>\n                            <Phone className=\"w-4 h-4\" /> T√©l√©phone\n                        </Label>\n                        <Input\n                            placeholder=\"ex: +221 77 123 45 67\"\n                            className=\"bg-slate-50 dark:bg-gray-800/50 border-slate-200 dark:border-gray-700 h-12 text-slate-900 dark:text-white\"\n                            value={formData.company_phone}\n                            onChange={(e) => handleInputChange('company_phone', e.target.value)}\n                        />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"company_email\" className=\"text-sm text-slate-500 dark:text-gray-400 flex items-center gap-2\" required>\n                            <Mail className=\"w-4 h-4\" /> Email professionnel\n                        </Label>\n                        <Input\n                            type=\"email\"\n                            placeholder=\"ex: contact@monagence.sn\"\n                            className=\"bg-slate-50 dark:bg-gray-800/50 border-slate-200 dark:border-gray-700 h-12 text-slate-900 dark:text-white\"\n                            value={formData.company_email}\n                            onChange={(e) => handleInputChange('company_email', e.target.value)}\n                        />\n                    </div>\n                </div>\n            </section >\n\n            {/* Aper√ßu Document */}\n            < section className=\"p-6 md:p-8 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-gray-900/60 dark:to-gray-800/40 rounded-3xl border border-slate-200 dark:border-gray-700 space-y-4\" >\n                <h2 className=\"text-lg font-bold text-slate-900 dark:text-white\">Aper√ßu sur vos documents</h2>\n                <div className=\"bg-white text-black rounded-2xl p-6 space-y-4\">\n                    <div className=\"flex items-center justify-between border-b border-gray-200 pb-4\">\n                        <div className=\"flex items-center gap-3\">\n                            {logoPreview ? (\n                                <img src={logoPreview} alt=\"Logo\" className=\"h-10 object-contain\" />\n                            ) : (\n                                <div className=\"w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 text-xs\">\n                                    Logo\n                                </div>\n                            )}\n                            <div>\n                                <p className=\"font-bold text-sm\">{formData.company_name || 'Votre nom commercial'}</p>\n                                <p className=\"text-[10px] text-gray-500\">\n                                    {formData.company_address || 'Votre adresse'} | {formData.company_phone || 'Votre t√©l√©phone'}\n                                </p>\n                            </div>\n                        </div>\n                        <div className=\"text-right\">\n                            <p className=\"text-[10px] text-gray-400\">QUITTANCE DE LOYER</p>\n                            <p className=\"text-sm font-bold text-green-600\">PAY√â ‚úì</p>\n                        </div>\n                    </div>\n                    <div className=\"text-center py-4 text-gray-400 text-sm\">\n                        [Contenu du document...]\n                    </div>\n                    <div className=\"flex justify-end pt-4 border-t border-gray-200\">\n                        {signaturePreview ? (\n                            <img src={signaturePreview} alt=\"Signature\" className=\"h-12 object-contain\" />\n                        ) : (\n                            <div className=\"w-24 h-12 border-b-2 border-gray-300 flex items-end justify-center text-[10px] text-gray-400 pb-1\">\n                                Signature\n                            </div>\n                        )}\n                    </div>\n                </div>\n            </section >\n\n            {/* Bouton Save */}\n            < div className=\"flex justify-end\" >\n                <Button\n                    onClick={handleSave}\n                    disabled={saving || uploadingLogo || uploadingSignature}\n                    className={`px-10 h-14 text-lg font-bold rounded-2xl transition-all ${saved\n                        ? 'bg-green-600 hover:bg-green-600'\n                        : 'bg-primary text-primary-foreground hover:bg-primary/90 shadow-xl shadow-primary/10'\n                        }`}\n                >\n                    {saving ? (\n                        <><Loader2 className=\"w-5 h-5 mr-2 animate-spin\" /> Enregistrement...</>\n                    ) : saved ? (\n                        <><Check className=\"w-5 h-5 mr-2\" /> Configuration sauvegard√©e</>\n                    ) : (\n                        <><Save className=\"w-5 h-5 mr-2\" /> Enregistrer ma configuration</>\n                    )}\n                </Button>\n            </div >\n        </div >\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\config\\config-tabs.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[577,580],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[577,580],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { ConfigForm } from \"./config-form\";\r\nimport { SubscriptionManager } from \"@/components/gestion/SubscriptionManager\";\r\nimport { ApiSettings } from \"./api-settings\";\r\nimport { User, CreditCard, Code } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { ConfigTour } from '@/components/gestion/tours/ConfigTour';\r\n\r\ninterface ConfigTabsProps {\r\n    brandingData: any;\r\n}\r\n\r\nexport function ConfigTabs({ brandingData }: ConfigTabsProps) {\r\n    const searchParams = useSearchParams();\r\n    const tabParam = searchParams.get(\"tab\");\r\n    const checkoutResult = searchParams.get(\"checkout\");\r\n\r\n    const [activeTab, setActiveTab] = useState(tabParam === \"subscription\" ? \"subscription\" : tabParam === \"api\" ? \"api\" : \"branding\");\r\n\r\n    // Show checkout feedback toast\r\n    useEffect(() => {\r\n        if (checkoutResult === \"success\") {\r\n            toast.success(\"Paiement r√©ussi ! Votre abonnement est maintenant actif.\", { duration: 6000 });\r\n        } else if (checkoutResult === \"canceled\") {\r\n            toast.info(\"Paiement annul√©. Vous pouvez r√©essayer quand vous le souhaitez.\", { duration: 5000 });\r\n        }\r\n    }, [checkoutResult]);\r\n\r\n    return (\r\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-8\">\r\n            <ConfigTour />\r\n            <TabsList id=\"tour-config-tabs\" className=\"bg-slate-100 dark:bg-gray-900/40 p-1 rounded-2xl border border-slate-200 dark:border-gray-800 h-14 w-full md:w-auto overflow-x-auto\">\r\n                <TabsTrigger\r\n                    value=\"branding\"\r\n                    className=\"flex items-center gap-2 px-6 rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground h-full transition-all hover:bg-slate-200 dark:hover:bg-gray-800 hover:text-slate-900 dark:hover:text-white data-[state=active]:hover:bg-primary/90 data-[state=active]:hover:text-primary-foreground\"\r\n                >\r\n                    <User className=\"w-4 h-4\" />\r\n                    Profil & Branding\r\n                </TabsTrigger>\r\n                <TabsTrigger\r\n                    id=\"tour-config-subscription\"\r\n                    value=\"subscription\"\r\n                    className=\"flex items-center gap-2 px-6 rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground h-full transition-all hover:bg-slate-200 dark:hover:bg-gray-800 hover:text-slate-900 dark:hover:text-white data-[state=active]:hover:bg-primary/90 data-[state=active]:hover:text-primary-foreground\"\r\n                >\r\n                    <CreditCard className=\"w-4 h-4\" />\r\n                    Abonnement\r\n                </TabsTrigger>\r\n                <TabsTrigger\r\n                    id=\"tour-config-api\"\r\n                    value=\"api\"\r\n                    className=\"flex items-center gap-2 px-6 rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground h-full transition-all hover:bg-slate-200 dark:hover:bg-gray-800 hover:text-slate-900 dark:hover:text-white data-[state=active]:hover:bg-primary/90 data-[state=active]:hover:text-primary-foreground\"\r\n                >\r\n                    <Code className=\"w-4 h-4\" />\r\n                    API & Int√©grations\r\n                </TabsTrigger>\r\n            </TabsList>\r\n\r\n            <TabsContent value=\"branding\" className=\"mt-0 focus-visible:ring-0\">\r\n                <ConfigForm initialData={brandingData} />\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"subscription\" className=\"mt-0 focus-visible:ring-0\">\r\n                <SubscriptionManager />\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"api\" className=\"mt-0 focus-visible:ring-0\">\r\n                <ApiSettings profile={brandingData} />\r\n            </TabsContent>\r\n        </Tabs>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\config\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1268,1271],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1268,1271],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1293,1296],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1293,1296],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:32:16\n  30 |     searchParams?: any\n  31 | }) {\n> 32 |     const t0 = Date.now();\n     |                ^^^^^^^^^^ Cannot call impure function\n  33 |     const { teamId, user, team } = context;\n  34 |     console.log(LOG_PREFIX, \"‚ñ∂ D√©but fetch donn√©es\", { teamId: teamId?.slice(0, 8), userId: user?.id?.slice(0, 8) });\n  35 |","line":32,"column":16,"nodeType":null,"endLine":32,"endColumn":26},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:57:23\n  55 |         (async () => {\n  56 |             console.log(LOG_PREFIX, \"‚ñ∂ start profile\");\n> 57 |             const t = Date.now();\n     |                       ^^^^^^^^^^ Cannot call impure function\n  58 |             const r = await getOwnerProfileForReceipts(user.id);\n  59 |             fetchTimers.profile = Date.now() - t;\n  60 |             console.log(LOG_PREFIX, \"‚úì end profile\", fetchTimers.profile);","line":57,"column":23,"nodeType":null,"endLine":57,"endColumn":33},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:59:35\n  57 |             const t = Date.now();\n  58 |             const r = await getOwnerProfileForReceipts(user.id);\n> 59 |             fetchTimers.profile = Date.now() - t;\n     |                                   ^^^^^^^^^^ Cannot call impure function\n  60 |             console.log(LOG_PREFIX, \"‚úì end profile\", fetchTimers.profile);\n  61 |             return r;\n  62 |         })(),","line":59,"column":35,"nodeType":null,"endLine":59,"endColumn":45},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:65:23\n  63 |         (async () => {\n  64 |             console.log(LOG_PREFIX, \"‚ñ∂ start leases\");\n> 65 |             const t = Date.now();\n     |                       ^^^^^^^^^^ Cannot call impure function\n  66 |             // Force status \"all\" explicitly\n  67 |             const r = await getLeasesByOwner(teamId, \"all\");\n  68 |             fetchTimers.leases = Date.now() - t;","line":65,"column":23,"nodeType":null,"endLine":65,"endColumn":33},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:68:34\n  66 |             // Force status \"all\" explicitly\n  67 |             const r = await getLeasesByOwner(teamId, \"all\");\n> 68 |             fetchTimers.leases = Date.now() - t;\n     |                                  ^^^^^^^^^^ Cannot call impure function\n  69 |             console.log(LOG_PREFIX, \"‚úì end leases\", fetchTimers.leases);\n  70 |             return r;\n  71 |         })(),","line":68,"column":34,"nodeType":null,"endLine":68,"endColumn":44},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:74:23\n  72 |         (async () => {\n  73 |             console.log(LOG_PREFIX, \"‚ñ∂ start transactions\");\n> 74 |             const t = Date.now();\n     |                       ^^^^^^^^^^ Cannot call impure function\n  75 |             const r = await getRentalTransactions([], teamId);\n  76 |             fetchTimers.transactions = Date.now() - t;\n  77 |             console.log(LOG_PREFIX, \"‚úì end transactions\", fetchTimers.transactions);","line":74,"column":23,"nodeType":null,"endLine":74,"endColumn":33},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:76:40\n  74 |             const t = Date.now();\n  75 |             const r = await getRentalTransactions([], teamId);\n> 76 |             fetchTimers.transactions = Date.now() - t;\n     |                                        ^^^^^^^^^^ Cannot call impure function\n  77 |             console.log(LOG_PREFIX, \"‚úì end transactions\", fetchTimers.transactions);\n  78 |             return r;\n  79 |         })(),","line":76,"column":40,"nodeType":null,"endLine":76,"endColumn":50},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:82:23\n  80 |         (async () => {\n  81 |             console.log(LOG_PREFIX, \"‚ñ∂ start expenses\");\n> 82 |             const t = Date.now();\n     |                       ^^^^^^^^^^ Cannot call impure function\n  83 |             const r = await getExpensesByOwner(teamId);\n  84 |             fetchTimers.expenses = Date.now() - t;\n  85 |             console.log(LOG_PREFIX, \"‚úì end expenses\", fetchTimers.expenses);","line":82,"column":23,"nodeType":null,"endLine":82,"endColumn":33},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:84:36\n  82 |             const t = Date.now();\n  83 |             const r = await getExpensesByOwner(teamId);\n> 84 |             fetchTimers.expenses = Date.now() - t;\n     |                                    ^^^^^^^^^^ Cannot call impure function\n  85 |             console.log(LOG_PREFIX, \"‚úì end expenses\", fetchTimers.expenses);\n  86 |             return r;\n  87 |         })(),","line":84,"column":36,"nodeType":null,"endLine":84,"endColumn":46},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:90:23\n  88 |         (async () => {\n  89 |             console.log(LOG_PREFIX, \"‚ñ∂ start properties\");\n> 90 |             const t = Date.now();\n     |                       ^^^^^^^^^^ Cannot call impure function\n  91 |             const r = await supabase.from(\"properties\").select(\"*\", { count: \"exact\", head: true }).eq(\"team_id\", teamId);\n  92 |             fetchTimers.properties = Date.now() - t;\n  93 |             console.log(LOG_PREFIX, \"‚úì end properties\", fetchTimers.properties);","line":90,"column":23,"nodeType":null,"endLine":90,"endColumn":33},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:92:38\n  90 |             const t = Date.now();\n  91 |             const r = await supabase.from(\"properties\").select(\"*\", { count: \"exact\", head: true }).eq(\"team_id\", teamId);\n> 92 |             fetchTimers.properties = Date.now() - t;\n     |                                      ^^^^^^^^^^ Cannot call impure function\n  93 |             console.log(LOG_PREFIX, \"‚úì end properties\", fetchTimers.properties);\n  94 |             return r;\n  95 |         })(),","line":92,"column":38,"nodeType":null,"endLine":92,"endColumn":48},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\dash-content.tsx:111:47\n  109 |     }\n  110 |\n> 111 |     console.log(LOG_PREFIX, \"‚è± Total fetch:\", Date.now() - t0, \"ms\");\n      |                                               ^^^^^^^^^^ Cannot call impure function\n  112 |\n  113 |     // Extraire les valeurs (fallback gracieux si une requ√™te √©choue)\n  114 |     const profile = results[0].status === \"fulfilled\" ? results[0].value : null;","line":111,"column":47,"nodeType":null,"endLine":111,"endColumn":57},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":115,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4916,4919],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4916,4919],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":115,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4981,4984],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4981,4984],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5028,5031],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5028,5031],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5093,5096],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5093,5096],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":117,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5133,5136],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5133,5136],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":117,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5198,5201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5198,5201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":118,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5303,5306],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5303,5306],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":135,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6048,6051],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6048,6051],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":142,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":142,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6340,6343],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6340,6343],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":157,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6895,6898],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6895,6898],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":165,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7187,7190],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7187,7190],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7333,7336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7333,7336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":192,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8348,8351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8348,8351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":238,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10240,10243],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10240,10243],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":238,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10248,10251],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10248,10251],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":254,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":254,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10894,10897],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10894,10897],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":255,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":255,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10961,10964],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10961,10964],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":257,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":257,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11086,11089],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11086,11089],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":261,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":261,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11293,11296],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11293,11296],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":263,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":263,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11372,11375],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11372,11375],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":264,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":264,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11426,11429],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11426,11429],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":35,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { GestionLocativeClient } from \"./components/GestionLocativeClient\";\r\nimport { AddTenantButton } from \"./components/AddTenantButton\";\r\nimport { Suspense } from \"react\";\r\nimport _dynamic from \"next/dynamic\";\r\nimport { DocumentGeneratorDialog } from \"./components/DocumentGeneratorDialog\";\r\nimport { ThemedContent } from \"./components/ThemedContent\";\r\nimport { KPICards } from \"./components/KPICards\";\r\nimport { RevenueChartSafe as RevenueChart } from \"./components/RevenueChartSafe\";\r\nimport { DashboardTabs } from \"./components/DashboardTabs\";\r\nimport { OrphanLeasesAlert } from \"./components/OrphanLeasesAlert\";\r\nimport { ExpiredBanner } from \"./components/ExpiredBanner\";\r\nimport { QuotaBanner } from \"./components/QuotaBanner\";\r\nimport { GestionTour } from \"@/components/gestion/GestionTour\";\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport {\r\n    getLeasesByTeam as getLeasesByOwner,\r\n    getRentalTransactions,\r\n    getOwnerProfileForReceipts,\r\n    getExpensesByTeam as getExpensesByOwner,\r\n} from \"@/services/rentalService.cached\";\r\nimport { calculateFinancials } from \"@/lib/finance\";\r\n\r\nconst LOG_PREFIX = \"[Gestion/dash-content]\";\r\n\r\nexport default async function DashboardContent({\r\n    context,\r\n    searchParams\r\n}: {\r\n    context: any,\r\n    searchParams?: any\r\n}) {\r\n    const t0 = Date.now();\r\n    const { teamId, user, team } = context;\r\n    console.log(LOG_PREFIX, \"‚ñ∂ D√©but fetch donn√©es\", { teamId: teamId?.slice(0, 8), userId: user?.id?.slice(0, 8) });\r\n\r\n    const supabase = await createClient();\r\n\r\n    const params = await searchParams;\r\n    const viewMode = params?.view === 'terminated' ? 'terminated' : 'active';\r\n    const isViewingTerminated = viewMode === 'terminated';\r\n\r\n    // ========================================\r\n    // PATTERN /BIENS : Fetch donn√©es brutes EN PARALL√àLE\r\n    // 5 requ√™tes simples au lieu de ~15 avec waterfalls\r\n    // ========================================\r\n    const fetchTimers = {\r\n        profile: 0,\r\n        leases: 0,\r\n        transactions: 0,\r\n        expenses: 0,\r\n        properties: 0,\r\n    };\r\n\r\n    const results = await Promise.allSettled([\r\n        (async () => {\r\n            console.log(LOG_PREFIX, \"‚ñ∂ start profile\");\r\n            const t = Date.now();\r\n            const r = await getOwnerProfileForReceipts(user.id);\r\n            fetchTimers.profile = Date.now() - t;\r\n            console.log(LOG_PREFIX, \"‚úì end profile\", fetchTimers.profile);\r\n            return r;\r\n        })(),\r\n        (async () => {\r\n            console.log(LOG_PREFIX, \"‚ñ∂ start leases\");\r\n            const t = Date.now();\r\n            // Force status \"all\" explicitly\r\n            const r = await getLeasesByOwner(teamId, \"all\");\r\n            fetchTimers.leases = Date.now() - t;\r\n            console.log(LOG_PREFIX, \"‚úì end leases\", fetchTimers.leases);\r\n            return r;\r\n        })(),\r\n        (async () => {\r\n            console.log(LOG_PREFIX, \"‚ñ∂ start transactions\");\r\n            const t = Date.now();\r\n            const r = await getRentalTransactions([], teamId);\r\n            fetchTimers.transactions = Date.now() - t;\r\n            console.log(LOG_PREFIX, \"‚úì end transactions\", fetchTimers.transactions);\r\n            return r;\r\n        })(),\r\n        (async () => {\r\n            console.log(LOG_PREFIX, \"‚ñ∂ start expenses\");\r\n            const t = Date.now();\r\n            const r = await getExpensesByOwner(teamId);\r\n            fetchTimers.expenses = Date.now() - t;\r\n            console.log(LOG_PREFIX, \"‚úì end expenses\", fetchTimers.expenses);\r\n            return r;\r\n        })(),\r\n        (async () => {\r\n            console.log(LOG_PREFIX, \"‚ñ∂ start properties\");\r\n            const t = Date.now();\r\n            const r = await supabase.from(\"properties\").select(\"*\", { count: \"exact\", head: true }).eq(\"team_id\", teamId);\r\n            fetchTimers.properties = Date.now() - t;\r\n            console.log(LOG_PREFIX, \"‚úì end properties\", fetchTimers.properties);\r\n            return r;\r\n        })(),\r\n    ]);\r\n\r\n    // Log chaque r√©sultat\r\n    const labels = [\"profile\", \"leases\", \"transactions\", \"expenses\", \"properties\"] as const;\r\n    for (let i = 0; i < results.length; i++) {\r\n        const r = results[i];\r\n        if (r.status === \"rejected\") {\r\n            console.error(LOG_PREFIX, `‚úó ${labels[i]} FAILED en ${fetchTimers[labels[i]]}ms:`, r.reason);\r\n        } else {\r\n            const val = r.value;\r\n            const size = Array.isArray(val) ? val.length : (val && typeof val === 'object' && 'count' in val) ? val.count : '1 obj';\r\n            console.log(LOG_PREFIX, `‚úì ${labels[i]} OK en ${fetchTimers[labels[i]]}ms (${size} r√©sultats)`);\r\n        }\r\n    }\r\n\r\n    console.log(LOG_PREFIX, \"‚è± Total fetch:\", Date.now() - t0, \"ms\");\r\n\r\n    // Extraire les valeurs (fallback gracieux si une requ√™te √©choue)\r\n    const profile = results[0].status === \"fulfilled\" ? results[0].value : null;\r\n    const allLeases: any[] = results[1].status === \"fulfilled\" ? (results[1].value as any[] || []) : [];\r\n    const rawTransactions: any[] = results[2].status === \"fulfilled\" ? (results[2].value as any[] || []) : [];\r\n    const expenses: any[] = results[3].status === \"fulfilled\" ? (results[3].value as any[] || []) : [];\r\n    const totalProperties = results[4].status === \"fulfilled\" ? (results[4].value as any)?.count ?? 0 : 0;\r\n\r\n    // Log erreurs critiques mais on continue le rendu\r\n    const failedQueries = results.filter(r => r.status === \"rejected\");\r\n    if (failedQueries.length > 0) {\r\n        console.error(LOG_PREFIX, `‚ö† ${failedQueries.length}/5 requ√™tes ont √©chou√©, rendu partiel`);\r\n    }\r\n\r\n    if (allLeases.length === 0 && rawTransactions.length === 0) {\r\n        console.warn(LOG_PREFIX, \"‚ö† Aucune donn√©e de bail ni transaction - dashboard sera vide\");\r\n    }\r\n\r\n    // ========================================\r\n    // CALCULS INLINE depuis les donn√©es brutes (ZERO requ√™te suppl√©mentaire)\r\n    // ========================================\r\n\r\n    // --- Advanced Stats (KPI Cards) ---\r\n    const activeLeases = allLeases.filter((l: any) => l.status === 'active');\r\n    const activeLeasesCount = activeLeases.length;\r\n\r\n    // Taux d'occupation\r\n    let occupancyBase = totalProperties || 0;\r\n    if (occupancyBase === 0 && activeLeasesCount > 0) {\r\n        const uniqueAddresses = new Set(\r\n            activeLeases.map((l: any) => l.property_address?.toLowerCase().trim())\r\n        );\r\n        occupancyBase = uniqueAddresses.size;\r\n    }\r\n    const occupancyRate = Math.min(\r\n        occupancyBase > 0\r\n            ? Math.round((activeLeasesCount / occupancyBase) * 100)\r\n            : activeLeasesCount > 0 ? 100 : 0,\r\n        100\r\n    );\r\n\r\n    // Taux d'impayes (Align√© avec lib/finance.ts pour coh√©rence \"Retards\")\r\n    const currentMonthDate = new Date();\r\n\r\n    // Pr√©parer les donn√©es pour le calcul financier standardis√©\r\n    const safeLeasesForKPI = allLeases.map((l: any) => ({\r\n        id: l.id,\r\n        monthly_amount: Number(l.monthly_amount) || 0,\r\n        status: l.status || 'active',\r\n        start_date: l.start_date || null,\r\n        billing_day: l.billing_day || 5\r\n    }));\r\n\r\n    const currentMonthTransactionsForKPI = rawTransactions.filter((t: any) =>\r\n        t.period_month === (currentMonthDate.getMonth() + 1) &&\r\n        t.period_year === currentMonthDate.getFullYear()\r\n    ).map((t: any) => ({\r\n        id: t.id,\r\n        lease_id: t.lease_id,\r\n        amount_due: Number(t.amount_due) || 0,\r\n        amount_paid: t.status === 'paid' ? (Number(t.amount_paid) || Number(t.amount_due)) : Number(t.amount_paid),\r\n        status: t.status,\r\n        paid_at: t.paid_at ? new Date(t.paid_at) : undefined // Ajout pour calcul d√©lai\r\n    }));\r\n\r\n    const currentMonthStats = calculateFinancials(\r\n        safeLeasesForKPI,\r\n        currentMonthTransactionsForKPI,\r\n        [], // KPI seulement (pas de d√©penses n√©cessaire pour impay√©s)\r\n        currentMonthDate\r\n    );\r\n\r\n    // Le taux d'impay√©s = (Nombre de retards / Nombre de baux actifs) * 100\r\n    // overdueCount (calcul√© par finance.ts) tient compte de la date d'√©ch√©ance et du paiement r√©el\r\n    const unpaidRate = activeLeasesCount > 0\r\n        ? Math.round((currentMonthStats.overdueCount / activeLeasesCount) * 100)\r\n        : 0;\r\n\r\n    // Revenu moyen par bien\r\n    const totalMonthlyRevenue = activeLeases.reduce(\r\n        (acc: number, l: any) => acc + Number(l.monthly_amount), 0\r\n    );\r\n    const avgRevenuePerProperty = activeLeasesCount > 0\r\n        ? Math.round(totalMonthlyRevenue / activeLeasesCount)\r\n        : 0;\r\n\r\n    const advancedStats = {\r\n        occupancyRate,\r\n        avgPaymentDelay: currentMonthStats.avgDelayDays, // Utilise le calcul centralis√©\r\n        unpaidRate,\r\n        overdueAmount: currentMonthStats.overdueAmount, // Montant total en retard\r\n        avgRevenuePerProperty,\r\n        totalProperties: totalProperties || 0,\r\n        activeLeases: activeLeasesCount,\r\n    };\r\n\r\n    // --- Revenue History (Graphique 12 mois) ---\r\n    const today = new Date();\r\n    const txByMonth = new Map<string, { collected: number; expected: number }>();\r\n    for (const t of rawTransactions) {\r\n        const key = `${t.period_year}-${t.period_month}`;\r\n        const entry = txByMonth.get(key) || { collected: 0, expected: 0 };\r\n        const amount = Number(t.amount_due || 0);\r\n        entry.expected += amount;\r\n        if (t.status === 'paid') entry.collected += amount;\r\n        txByMonth.set(key, entry);\r\n    }\r\n\r\n    const revenueHistory = [];\r\n    for (let i = 11; i >= 0; i--) {\r\n        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);\r\n        const monthNum = date.getMonth() + 1;\r\n        const year = date.getFullYear();\r\n        const monthName = date.toLocaleDateString(\"fr-FR\", { month: \"short\" });\r\n        const entry = txByMonth.get(`${year}-${monthNum}`) || { collected: 0, expected: 0 };\r\n        revenueHistory.push({\r\n            month: monthName.charAt(0).toUpperCase() + monthName.slice(1),\r\n            year,\r\n            monthNum,\r\n            collected: entry.collected,\r\n            expected: entry.expected,\r\n        });\r\n    }\r\n\r\n    // --- Earliest lease (depuis les donn√©es d√©j√† charg√©es) ---\r\n    const earliestLease = allLeases.reduce(\r\n        (earliest: any, l: any) => {\r\n            if (!l.start_date) return earliest;\r\n            if (!earliest || l.start_date < earliest.start_date) return { start_date: l.start_date };\r\n            return earliest;\r\n        },\r\n        null as { start_date: string } | null\r\n    );\r\n\r\n    // ========================================\r\n    // FILTRAGE (identique √† avant)\r\n    // ========================================\r\n    const currentTier = team?.subscription_tier || \"starter\";\r\n    const proStatus = context?.subscription_status || \"none\";\r\n    const expensesList = expenses || [];\r\n\r\n    const filteredLeases = isViewingTerminated\r\n        ? allLeases.filter((l: any) => l.status === 'terminated')\r\n        : allLeases.filter((l: any) => !l.status || l.status === 'active' || l.status === 'pending');\r\n\r\n    const orphanLeases = filteredLeases.filter((l: any) => !l.property_id);\r\n    const orphanCount = orphanLeases.length;\r\n    const minDateStr = earliestLease?.start_date || new Date().toISOString();\r\n\r\n    const leaseIdSet = new Set(filteredLeases.map((l: any) => l.id));\r\n    const transactions = rawTransactions\r\n        .filter((t: any) => leaseIdSet.has(t.lease_id))\r\n        .map((t: any) => ({\r\n            ...t,\r\n            amount_paid: (t.status?.toLowerCase() === 'paid') ? t.amount_due : 0\r\n        }));\r\n\r\n    return (\r\n        <ThemedContent\r\n            isViewingTerminated={isViewingTerminated}\r\n            filterSection={\r\n                !isViewingTerminated && (\r\n                    <div id=\"tour-gestion-actions\" className=\"flex gap-2\">\r\n                        <DocumentGeneratorDialog\r\n                            leases={filteredLeases}\r\n                            userEmail={user.email}\r\n                            profile={profile}\r\n                        />\r\n                        <AddTenantButton ownerId={user.id} profile={profile} />\r\n                    </div>\r\n                )\r\n            }\r\n        >\r\n            {/* Banner for expired subscription */}\r\n            <Suspense fallback={null}>\r\n                {(proStatus === \"past_due\" || proStatus === \"canceled\" || proStatus === \"unpaid\" || proStatus === \"incomplete\") ? (\r\n                    <ExpiredBanner\r\n                        proStatus={proStatus}\r\n                        propertiesCount={allLeases.length}\r\n                        leasesCount={filteredLeases.length}\r\n                    />\r\n                ) : (\r\n                    <QuotaBanner\r\n                        tier={currentTier}\r\n                        propertiesCount={advancedStats.totalProperties}\r\n                        leasesCount={advancedStats.activeLeases}\r\n                    />\r\n                )}\r\n            </Suspense>\r\n\r\n            {/* Alerte baux orphelins */}\r\n            {!isViewingTerminated && orphanCount > 0 && (\r\n                <OrphanLeasesAlert count={orphanCount} leases={orphanLeases} />\r\n            )}\r\n\r\n            {/* Onglets du dashboard - Seulement en mode actif */}\r\n            {!isViewingTerminated ? (\r\n                <DashboardTabs\r\n                    overviewContent={\r\n                        <>\r\n                            {/* Table des locataires */}\r\n                            <div id=\"tour-gestion-table\">\r\n                                <Suspense fallback={<div className=\"h-64 w-full bg-muted/20 animate-pulse rounded-xl\" />}>\r\n                                    <GestionLocativeClient\r\n                                        leases={filteredLeases || []}\r\n                                        transactions={transactions || []}\r\n                                        expenses={expensesList || []}\r\n                                        profile={profile}\r\n                                        userEmail={user.email}\r\n                                        ownerId={user.id}\r\n                                        isViewingTerminated={isViewingTerminated}\r\n                                        minDate={minDateStr}\r\n                                    />\r\n                                </Suspense>\r\n                            </div>\r\n                        </>\r\n                    }\r\n                    performanceContent={\r\n                        <>\r\n                            {/* KPI Cards analytiques */}\r\n                            <KPICards stats={advancedStats} />\r\n\r\n                            {/* Graphique des revenus 12 mois */}\r\n                            <RevenueChart data={revenueHistory} />\r\n                        </>\r\n                    }\r\n                />\r\n            ) : (\r\n                /* Mode r√©sili√©s : afficher directement la table sans onglets */\r\n                <div id=\"tour-gestion-table\" className=\"mb-6\">\r\n                    <Suspense fallback={<div className=\"h-64 w-full bg-muted/20 animate-pulse rounded-xl\" />}>\r\n                        <GestionLocativeClient\r\n                            leases={filteredLeases || []}\r\n                            transactions={transactions || []}\r\n                            expenses={expensesList || []}\r\n                            profile={profile}\r\n                            userEmail={user.email}\r\n                            ownerId={user.id}\r\n                            isViewingTerminated={isViewingTerminated}\r\n                            minDate={minDateStr}\r\n                        />\r\n                    </Suspense>\r\n                </div>\r\n            )}\r\n\r\n            {/* Tutoriel interactif de la page gestion */}\r\n            <GestionTour />\r\n\r\n        </ThemedContent>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\documents-legaux\\LegalPageClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[741,744],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[741,744],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[760,763],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[760,763],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[804,807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[804,807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { AlertTriangle, CheckCircle, FileText, Clock, BookOpen } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { format } from \"date-fns\";\nimport { fr } from \"date-fns/locale\";\nimport { DecisionModal } from \"./components/DecisionModal\";\nimport { CreateContractDialog } from \"./components/CreateContractDialog\";\nimport { CreateReceiptDialog } from \"./components/CreateReceiptDialog\";\nimport { useTheme } from \"@/components/theme-provider\";\nimport { LegalTour } from '@/components/gestion/tours/LegalTour';\n\ninterface LegalPageClientProps {\n    stats: {\n        activeLeases: number;\n        upcomingRenewals: number;\n        legalRisks: number;\n    };\n    alerts: any[];\n    leases: any[];\n    userEmail?: string;\n    profile: any;\n}\n\nexport function LegalPageClient({ stats, alerts, leases, userEmail, profile }: LegalPageClientProps) {\n    const { isDark } = useTheme();\n\n    return (\n        <div className={`min-h-screen ${isDark ? 'bg-slate-950' : 'bg-gray-50'}`}>\n            <LegalTour />\n            <div className=\"w-full mx-auto px-4 md:px-6 py-8 space-y-8 animate-in fade-in duration-500\">\n\n                {/* SECTION 1 : EN-T√äTE */}\n                <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\n                    <div>\n                        <h1 className={`text-3xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                            Assistant Juridique\n                        </h1>\n                        <p className={`mt-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            Conformit√© Loi 2014 & COCC S√©n√©gal üá∏üá≥\n                        </p>\n                    </div>\n                </div>\n\n                {/* SECTION 2 : LES KPI */}\n                <div id=\"tour-legal-kpi\" className=\"grid gap-4 md:grid-cols-3\">\n                    <Card className={isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}>\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                            <CardTitle className={`text-sm font-medium ${isDark ? 'text-slate-200' : 'text-gray-700'}`}>\n                                Baux Actifs\n                            </CardTitle>\n                            <FileText className=\"h-4 w-4 text-blue-500\" />\n                        </CardHeader>\n                        <CardContent>\n                            <div className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                {stats.activeLeases}\n                            </div>\n                            <p className={`text-xs ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                Tous enregistr√©s\n                            </p>\n                        </CardContent>\n                    </Card>\n\n                    <Card className={`relative overflow-hidden ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                        {stats.upcomingRenewals > 0 && (\n                            <div className=\"absolute top-0 right-0 w-1 h-full bg-orange-500\" />\n                        )}\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                            <CardTitle className={`text-sm font-medium ${isDark ? 'text-slate-200' : 'text-gray-700'}`}>\n                                Renouvellements (3 mois)\n                            </CardTitle>\n                            <Clock className=\"h-4 w-4 text-orange-500\" />\n                        </CardHeader>\n                        <CardContent>\n                            <div className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                {stats.upcomingRenewals}\n                            </div>\n                            <p className=\"text-xs text-orange-400\">\n                                {stats.upcomingRenewals > 0 ? 'Tacite reconduction approche' : 'Aucune √©ch√©ance proche'}\n                            </p>\n                        </CardContent>\n                    </Card>\n\n                    <Card className={isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}>\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                            <CardTitle className={`text-sm font-medium ${isDark ? 'text-slate-200' : 'text-gray-700'}`}>\n                                Risque Juridique\n                            </CardTitle>\n                            <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n                        </CardHeader>\n                        <CardContent>\n                            <div className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                {stats.legalRisks}\n                            </div>\n                            <p className={`text-xs ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                Aucun contentieux en cours\n                            </p>\n                        </CardContent>\n                    </Card>\n                </div>\n\n                {/* SECTION 3 : LE RADAR DES √âCH√âANCES */}\n                <div id=\"tour-legal-alerts\" className=\"space-y-4\">\n                    <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                        Radar des √âch√©ances\n                    </h2>\n                    <div className={`rounded-lg border overflow-hidden ${isDark ? 'border-slate-800 bg-black/50' : 'border-gray-200 bg-white'\n                        }`}>\n                        {alerts.length > 0 ? (\n                            <div className=\"overflow-x-auto\">\n                                <table className=\"w-full text-sm text-left min-w-[600px]\">\n                                    <thead className={`font-medium border-b ${isDark\n                                        ? 'bg-slate-900/50 text-slate-400 border-slate-800'\n                                        : 'bg-gray-50 text-gray-600 border-gray-200'\n                                        }`}>\n                                        <tr>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Locataire & Bien</th>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">√âch√©ance</th>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Type d&apos;alerte</th>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 whitespace-nowrap\">Statut</th>\n                                            <th className=\"px-4 md:px-6 py-3 md:py-4 text-right whitespace-nowrap\">Action</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody className={`divide-y ${isDark ? 'divide-slate-800' : 'divide-gray-200'}`}>\n                                        {alerts.map((alert) => (\n                                            <tr\n                                                key={alert.id}\n                                                className={`transition-colors group ${isDark ? 'hover:bg-slate-900/50' : 'hover:bg-gray-50'\n                                                    }`}\n                                            >\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\n                                                    <div className={`font-medium whitespace-nowrap ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                                        {alert.tenant_name}\n                                                    </div>\n                                                    <div className={`text-xs max-w-[150px] md:max-w-none truncate ${isDark ? 'text-slate-500' : 'text-gray-500'\n                                                        }`}>\n                                                        {alert.property_address}\n                                                    </div>\n                                                </td>\n                                                <td className={`px-4 md:px-6 py-3 md:py-4 whitespace-nowrap ${isDark ? 'text-slate-300' : 'text-gray-700'\n                                                    }`}>\n                                                    {format(new Date(alert.end_date), 'dd MMM yyyy', { locale: fr })}\n                                                </td>\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\n                                                    <div className=\"flex items-center gap-2\">\n                                                        <span className={`w-2 h-2 rounded-full flex-shrink-0 ${alert.alert_type === 'J-180'\n                                                            ? 'bg-orange-500'\n                                                            : 'bg-blue-500'\n                                                            }`} />\n                                                        <span className={`text-xs md:text-sm whitespace-nowrap ${isDark ? 'text-slate-300' : 'text-gray-700'\n                                                            }`}>\n                                                            {alert.alert_type === 'J-180' ? 'Cong√© (6 mois)' : 'Reconduction (3 mois)'}\n                                                        </span>\n                                                    </div>\n                                                </td>\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4\">\n                                                    <div className={`flex items-center gap-2 text-xs md:text-sm whitespace-nowrap ${isDark ? 'text-slate-400' : 'text-gray-600'\n                                                        }`}>\n                                                        <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${alert.status === 'sent' ? 'bg-green-500' : 'bg-amber-500'\n                                                            }`} />\n                                                        {alert.status === 'sent' ? 'Envoy√©' : 'En attente'}\n                                                    </div>\n                                                </td>\n                                                <td className=\"px-4 md:px-6 py-3 md:py-4 text-right\">\n                                                    <DecisionModal alert={alert} />\n                                                </td>\n                                            </tr>\n                                        ))}\n                                    </tbody>\n                                </table>\n                            </div>\n                        ) : (\n                            <div className=\"px-6 py-12 text-center\">\n                                <CheckCircle className=\"w-12 h-12 text-green-500 mx-auto mb-3\" />\n                                <p className={`font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>\n                                    Aucune √©ch√©ance dans les 6 prochains mois\n                                </p>\n                                <p className={`text-sm mt-1 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                    Tous vos baux sont √† jour\n                                </p>\n                            </div>\n                        )}\n                    </div>\n                </div>\n\n                {/* SECTION 4 : G√âN√âRATEUR RAPIDE */}\n                <div id=\"tour-legal-tools\" className=\"grid gap-6 md:grid-cols-2\">\n                    <CreateReceiptDialog leases={leases} userEmail={userEmail} profile={profile} />\n                    <CreateContractDialog leases={leases} profile={profile} />\n                </div>\n\n                {/* R√©f√©rence juridique */}\n                <div id=\"tour-legal-reference\" className={`p-6 rounded-lg border ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'\n                    }`}>\n                    <h2 className={`text-lg font-semibold mb-4 flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'\n                        }`}>\n                        <BookOpen className=\"w-5 h-5 text-green-500\" />\n                        Cadre Juridique de R√©f√©rence\n                    </h2>\n                    <div className=\"grid gap-4 md:grid-cols-2\">\n                        <div>\n                            <h3 className={`text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>\n                                Textes applicables :\n                            </h3>\n                            <ul className={`space-y-1 text-sm ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                                <li>‚Ä¢ COCC (Code des Obligations Civiles et Commerciales)</li>\n                                <li>‚Ä¢ D√©cret de 2014 sur la baisse des loyers</li>\n                                <li>‚Ä¢ Loi de r√©gulation 2024</li>\n                                <li>‚Ä¢ Droit OHADA (usage commercial)</li>\n                            </ul>\n                        </div>\n                        <div>\n                            <h3 className={`text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>\n                                D√©lais cl√©s :\n                            </h3>\n                            <ul className={`space-y-1 text-sm ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                                <li>‚Ä¢ <span className=\"text-red-500 font-semibold\">6 mois</span> : Pr√©avis propri√©taire (cong√© pour reprise)</li>\n                                <li>‚Ä¢ <span className=\"text-yellow-500 font-semibold\">3 mois</span> : N√©gociation avant tacite reconduction</li>\n                                <li>‚Ä¢ <span className=\"text-blue-500 font-semibold\">2 mois</span> : Pr√©avis locataire (r√©sidentiel)</li>\n                                <li>‚Ä¢ <span className=\"text-purple-500 font-semibold\">1 mois</span> : Pr√©avis locataire (meubl√©)</li>\n                            </ul>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\documents-legaux\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\documents-legaux\\components\\CreateContractDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[913,916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[913,916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { ShieldCheck, FileText, CheckCircle } from 'lucide-react';\nimport { _Button } from '@/components/ui/button';\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogHeader,\n    DialogTitle,\n    DialogTrigger,\n} from '@/components/ui/dialog';\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\";\nimport { GenerateContractButton } from '@/components/contracts/GenerateContractButton';\nimport { useTheme } from \"@/components/theme-provider\";\nimport { ConfigurationRequirementCheck } from '../../components/ConfigurationRequirementCheck';\n\ninterface Lease {\n    id: string;\n    tenant_name: string;\n    property_address: string;\n    lease_pdf_url?: string | null;\n}\n\ninterface CreateContractDialogProps {\n    leases: Lease[];\n    trigger?: React.ReactNode;\n    profile?: any;\n}\n\nexport function CreateContractDialog({ leases, trigger, profile }: CreateContractDialogProps) {\n    const { isDark } = useTheme();\n    const [selectedLeaseId, setSelectedLeaseId] = useState<string>('');\n    const [isOpen, setIsOpen] = useState(false);\n\n    const selectedLease = leases.find(l => l.id === selectedLeaseId);\n\n    return (\n        <Dialog open={isOpen} onOpenChange={setIsOpen}>\n            <DialogTrigger asChild>\n                {trigger ? trigger : (\n                    <button id=\"tour-generate-contract\" className={`w-full text-left p-6 rounded-xl border transition-all group outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer ${isDark\n                        ? 'border-slate-800 bg-gradient-to-br from-slate-900 to-black hover:border-slate-700'\n                        : 'border-gray-200 bg-white hover:border-gray-300 hover:shadow-sm'\n                        }`}>\n                        <div className={`h-10 w-10 rounded-lg flex items-center justify-center mb-4 transition-colors ${isDark ? 'bg-slate-800 group-hover:bg-slate-700' : 'bg-gray-100 group-hover:bg-gray-200'\n                            }`}>\n                            <ShieldCheck className={`h-5 w-5 ${isDark ? 'text-white' : 'text-gray-700'}`} />\n                        </div>\n                        <h3 className={`text-lg font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>Nouveau Contrat de Bail</h3>\n                        <p className={`text-sm mt-2 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>G√©n√©rer un contrat conforme OHADA / S√©n√©gal pour un locataire existant.</p>\n                    </button>\n                )}\n            </DialogTrigger>\n            <DialogContent className={`sm:max-w-md p-0 overflow-hidden ${isDark ? 'bg-slate-900 border-slate-800 text-slate-100' : 'bg-white border-gray-200 text-gray-900'}`}>\n                <ConfigurationRequirementCheck profile={profile} isDark={isDark}>\n                    <div className=\"p-6\">\n                        <DialogHeader>\n                            <DialogTitle className={`flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                <FileText className=\"h-5 w-5 text-primary\" />\n                                G√©n√©rateur de Contrat\n                            </DialogTitle>\n                            <DialogDescription className={isDark ? 'text-slate-400' : 'text-gray-600'}>\n                                S√©lectionnez un bail actif pour g√©n√©rer le contrat PDF.\n                            </DialogDescription>\n                        </DialogHeader>\n\n                        <div className=\"space-y-6 pt-6\">\n                            <div className=\"space-y-2\">\n                                <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Locataire & Bien</label>\n                                <Select value={selectedLeaseId} onValueChange={setSelectedLeaseId}>\n                                    <SelectTrigger className={`focus:ring-primary ${isDark ? 'bg-slate-800 border-slate-700 text-slate-100 focus:ring-offset-slate-900' : 'bg-gray-50 border-gray-300 text-gray-900'\n                                        }`}>\n                                        <SelectValue placeholder=\"S√©lectionner un bail...\" />\n                                    </SelectTrigger>\n                                    <SelectContent className={`${isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-white border-gray-200 text-gray-900'} max-w-[calc(100vw-2rem)]`}>\n                                        {leases.length === 0 ? (\n                                            <div className={`py-6 text-center text-sm ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                                Aucun bail actif trouv√©\n                                            </div>\n                                        ) : (\n                                            leases.map((lease) => (\n                                                <SelectItem key={lease.id} value={lease.id} className={isDark ? 'focus:bg-slate-700 focus:text-slate-100 data-[state=checked]:bg-slate-700' : 'focus:bg-gray-100 focus:text-gray-900 data-[state=checked]:bg-gray-100'}>\n                                                    <div className=\"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 max-w-full overflow-hidden\">\n                                                        <span className=\"font-medium truncate\">{lease.tenant_name}</span>\n                                                        <span className={`text-xs truncate ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                                            - {lease.property_address}\n                                                        </span>\n                                                    </div>\n                                                </SelectItem>\n                                            ))\n                                        )}\n                                    </SelectContent>\n                                </Select>\n                            </div>\n\n                            {selectedLease && (\n                                <div className={`rounded-lg p-4 space-y-3 border ${isDark ? 'bg-slate-800/50 border-slate-700/50' : 'bg-gray-50 border-gray-200'\n                                    }`}>\n                                    <div className=\"flex justify-between items-start\">\n                                        <div>\n                                            <h4 className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>{selectedLease.tenant_name}</h4>\n                                            <p className={`text-xs mt-1 ${isDark ? 'text-slate-400' : 'text-gray-500'}`}>{selectedLease.property_address}</p>\n                                        </div>\n                                        {selectedLease.lease_pdf_url && (\n                                            <div className={`px-2 py-1 rounded-full text-[10px] font-medium border flex items-center gap-1 ${isDark\n                                                ? 'bg-green-500/10 text-green-400 border-green-500/20'\n                                                : 'bg-green-50 text-green-700 border-green-200'\n                                                }`}>\n                                                <CheckCircle className=\"h-3 w-3\" />\n                                                Contrat existant\n                                            </div>\n                                        )}\n                                    </div>\n\n                                    <div className=\"pt-2 flex justify-end\">\n                                        <GenerateContractButton\n                                            leaseId={selectedLease.id}\n                                            tenantName={selectedLease.tenant_name}\n                                            existingContractUrl={selectedLease.lease_pdf_url || undefined}\n                                            className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90\"\n                                        />\n                                    </div>\n                                </div>\n                            )}\n                        </div>\n                    </div>\n                </ConfigurationRequirementCheck>\n            </DialogContent>\n        </Dialog>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\documents-legaux\\components\\CreateReceiptDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1014,1017],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1014,1017],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { FileText, _CheckCircle, _Search } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogHeader,\n    DialogTitle,\n    DialogTrigger,\n} from '@/components/ui/dialog';\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\";\nimport { ReceiptModal } from '../../components/ReceiptModal';\nimport { _cn } from '@/lib/utils';\nimport { _createClient } from '@/utils/supabase/client';\nimport { useTheme } from \"@/components/theme-provider\";\nimport { ConfigurationRequirementCheck } from '../../components/ConfigurationRequirementCheck';\n\ninterface Lease {\n    id: string;\n    tenant_name: string;\n    tenant_email?: string;\n    tenant_phone?: string;\n    property_address: string;\n    monthly_amount: number;\n}\n\ninterface CreateReceiptDialogProps {\n    leases: Lease[];\n    userEmail?: string;\n    profile?: any;\n}\n\nexport function CreateReceiptDialog({ leases, userEmail, profile }: CreateReceiptDialogProps) {\n    const { isDark } = useTheme();\n    const [isOpen, setIsOpen] = useState(false);\n    const [selectedLeaseId, setSelectedLeaseId] = useState<string>('');\n    const [month, setMonth] = useState<string>(new Date().getMonth() + 1 + '');\n    const [year, setYear] = useState<string>(new Date().getFullYear() + '');\n    const [amount, setAmount] = useState<string>('');\n\n    // State for the preview modal\n    const [showPreview, setShowPreview] = useState(false);\n\n    const selectedLease = leases.find(l => l.id === selectedLeaseId);\n\n    const handleLeaseChange = (leaseId: string) => {\n        const lease = leases.find(l => l.id === leaseId);\n        setSelectedLeaseId(leaseId);\n        if (lease) {\n            setAmount(lease.monthly_amount.toString());\n        }\n    };\n\n    const handleGenerate = () => {\n        if (!selectedLease || !amount) return;\n        setShowPreview(true);\n    };\n\n    const periodMonth = parseInt(month).toString().padStart(2, '0');\n\n    // Construct data for ReceiptModal\n    const receiptData = selectedLease ? {\n        leaseId: selectedLease.id,\n        tenant: {\n            tenant_name: selectedLease.tenant_name,\n            email: selectedLease.tenant_email,\n            phone: selectedLease.tenant_phone,\n            address: selectedLease.property_address\n        },\n        property_address: selectedLease.property_address,\n        amount: parseInt(amount),\n        month: periodMonth,\n        year: parseInt(year),\n        userEmail: userEmail,\n        profile: profile\n    } : null;\n\n    return (\n        <>\n            <Dialog open={isOpen} onOpenChange={setIsOpen}>\n                <DialogTrigger asChild>\n                    <button className={`w-full text-left p-6 rounded-xl border transition-all group outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer ${isDark\n                        ? 'border-slate-800 bg-gradient-to-br from-slate-900 to-black hover:border-slate-700'\n                        : 'border-gray-200 bg-white hover:border-gray-300 hover:shadow-sm'\n                        }`}>\n                        <div className={`h-10 w-10 rounded-lg flex items-center justify-center mb-4 transition-colors ${isDark ? 'bg-slate-800 group-hover:bg-slate-700' : 'bg-gray-100 group-hover:bg-gray-200'\n                            }`}>\n                            <FileText className={`h-5 w-5 ${isDark ? 'text-white' : 'text-gray-700'}`} />\n                        </div>\n                        <h3 className={`text-lg font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>G√©n√©rer une Quittance</h3>\n                        <p className={`text-sm mt-2 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>Cr√©er manuellement une quittance pour un paiement hors plateforme.</p>\n                    </button>\n                </DialogTrigger>\n                <DialogContent className={`sm:max-w-md p-0 overflow-hidden ${isDark ? 'bg-slate-900 border-slate-800 text-slate-100' : 'bg-white border-gray-200 text-gray-900'}`}>\n                    <ConfigurationRequirementCheck profile={profile} isDark={isDark}>\n                        <div className=\"p-6\">\n                            <DialogHeader>\n                                <DialogTitle className={`flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                                    <FileText className=\"h-5 w-5 text-primary\" />\n                                    G√©n√©rateur de Quittance\n                                </DialogTitle>\n                                <DialogDescription className={isDark ? 'text-slate-400' : 'text-gray-600'}>\n                                    Cr√©ez une quittance pour un locataire existant.\n                                </DialogDescription>\n                            </DialogHeader>\n\n                            <div className=\"space-y-4 py-4\">\n                                <div className=\"space-y-2\">\n                                    <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Locataire & Bien</label>\n                                    <Select value={selectedLeaseId} onValueChange={handleLeaseChange}>\n                                        <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                            <SelectValue placeholder=\"S√©lectionner un bail...\" />\n                                        </SelectTrigger>\n                                        <SelectContent className={`${isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-white border-gray-200 text-gray-900'} max-w-[calc(100vw-2rem)]`}>\n                                            {leases.length === 0 ? (\n                                                <div className={`py-6 text-center text-sm ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                                    Aucun bail actif trouv√©\n                                                </div>\n                                            ) : (\n                                                leases.map((lease) => (\n                                                    <SelectItem key={lease.id} value={lease.id} className={isDark ? 'focus:bg-slate-700 focus:text-slate-100' : 'focus:bg-gray-100 focus:text-gray-900'}>\n                                                        <div className=\"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 max-w-full overflow-hidden\">\n                                                            <span className=\"font-medium truncate\">{lease.tenant_name}</span>\n                                                            <span className={`text-xs truncate ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                                                - {lease.property_address}\n                                                            </span>\n                                                        </div>\n                                                    </SelectItem>\n                                                ))\n                                            )}\n                                        </SelectContent>\n                                    </Select>\n                                    {selectedLease && (\n                                        <p className={`text-xs ml-1 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>\n                                            {selectedLease.property_address}\n                                        </p>\n                                    )}\n                                </div>\n\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                    <div className=\"space-y-2\">\n                                        <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Mois</label>\n                                        <Select value={month} onValueChange={setMonth}>\n                                            <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                                <SelectValue />\n                                            </SelectTrigger>\n                                            <SelectContent className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-white border-gray-200 text-gray-900'}>\n                                                {Array.from({ length: 12 }, (_, i) => i + 1).map((m) => (\n                                                    <SelectItem key={m} value={m.toString()}>\n                                                        {new Date(0, m - 1).toLocaleString('fr-FR', { month: 'long' })}\n                                                    </SelectItem>\n                                                ))}\n                                            </SelectContent>\n                                        </Select>\n                                    </div>\n                                    <div className=\"space-y-2\">\n                                        <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Ann√©e</label>\n                                        <Select value={year} onValueChange={setYear}>\n                                            <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                                <SelectValue />\n                                            </SelectTrigger>\n                                            <SelectContent className={isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-white border-gray-200 text-gray-900'}>\n                                                {[year, (parseInt(year) - 1).toString(), (parseInt(year) + 1).toString()].sort().map((y) => (\n                                                    <SelectItem key={y} value={y}>{y}</SelectItem>\n                                                ))}\n                                            </SelectContent>\n                                        </Select>\n                                    </div>\n                                </div>\n\n                                <div className=\"space-y-2\">\n                                    <label className={`text-sm font-medium ${isDark ? 'text-slate-300' : 'text-gray-700'}`}>Montant (FCFA)</label>\n                                    <input\n                                        type=\"number\"\n                                        value={amount}\n                                        onChange={(e) => setAmount(e.target.value)}\n                                        className={`w-full border rounded-md px-3 py-2 text-sm focus:ring-primary focus:border-primary outline-none ${isDark ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-gray-50 border-gray-300 text-gray-900'\n                                            }`}\n                                    />\n                                </div>\n\n                                <div className=\"pt-2\">\n                                    <Button\n                                        onClick={handleGenerate}\n                                        disabled={!selectedLease || !amount}\n                                        className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90\"\n                                    >\n                                        Pr√©visualiser la Quittance\n                                    </Button>\n                                </div>\n                            </div>\n                        </div>\n                    </ConfigurationRequirementCheck>\n                </DialogContent>\n            </Dialog>\n\n            {receiptData && (\n                <ReceiptModal\n                    isOpen={showPreview}\n                    onClose={() => setShowPreview(false)}\n                    data={receiptData}\n                />\n            )}\n        </>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\documents-legaux\\components\\DecisionModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\documents-legaux\\components\\GenerateNoticeButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\documents-legaux\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\documents\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":127,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":127,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3791,3794],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3791,3794],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport {\n    Folder,\n    FileText,\n    UploadSimple,\n    DownloadSimple,\n    Trash,\n    Funnel,\n    MagnifyingGlass,\n    House,\n    User,\n    FilePdf,\n    Image as ImageIcon,\n    Eye\n} from \"@phosphor-icons/react\";\nimport { motion } from \"framer-motion\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport { fr } from \"date-fns/locale\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogHeader,\n    DialogTitle,\n    DialogTrigger\n} from \"@/components/ui/dialog\";\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\";\nimport { EmptyState } from \"@/components/ui/empty-state\";\nimport { useTheme } from \"@/components/theme-provider\";\n\nimport { uploadDocument, deleteDocument, _getMyDocuments, getRentalDocuments } from \"@/app/(workspace)/compte/mes-documents/actions\";\nimport { getProperties, getLeasesByOwner } from \"../actions\";\nimport { DocumentsTour } from \"@/components/gestion/tours/DocumentsTour\";\n\n// Types\ntype RentalDocument = {\n    id: string;\n    name: string;\n    type: string;\n    category?: string;\n    size: number;\n    url: string;\n    uploaded_at: string;\n    property_id?: string;\n    lease_id?: string;\n    property_title?: string;\n    tenant_name?: string;\n    file_name?: string;\n};\n\ntype Property = {\n    id: string;\n    title: string;\n};\n\ntype Lease = {\n    id: string;\n    property_id: string;\n    tenant_name: string;\n};\n\nconst DOCUMENT_CATEGORIES = [\n    { value: \"bail\", label: \"Contrat de Bailli\" },\n    { value: \"quittance\", label: \"Quittance de Loyer\" },\n    { value: \"etat_lieux\", label: \"√âtat des Lieux\" },\n    { value: \"devis\", label: \"Devis\" },\n    { value: \"facture_travaux\", label: \"Facture Travaux\" },\n    { value: \"assurance\", label: \"Assurance\" },\n    { value: \"courrier\", label: \"Courrier / Avis\" },\n    { value: \"autre\", label: \"Autre Document\" }\n];\n\nexport default function RentalDocumentsPage() {\n    const { isDark } = useTheme();\n    const [documents, setDocuments] = useState<RentalDocument[]>([]);\n    const [properties, setProperties] = useState<Property[]>([]);\n    const [leases, setLeases] = useState<Lease[]>([]);\n    const [loading, setLoading] = useState(true);\n\n    // Filters\n    const [selectedLeaseFilter, setSelectedLeaseFilter] = useState<string>(\"all\");\n    const [searchQuery, setSearchQuery] = useState(\"\");\n\n    // Upload State\n    const [uploadDialogOpen, setUploadDialogOpen] = useState(false);\n    const [uploading, setUploading] = useState(false);\n    const [uploadFile, setUploadFile] = useState<File | null>(null);\n    const [uploadPropertyId, setUploadPropertyId] = useState<string>(\"\");\n    const [uploadLeaseId, setUploadLeaseId] = useState<string>(\"none\");\n    const [uploadCategory, setUploadCategory] = useState<string>(\"\");\n\n    useEffect(() => {\n        loadData();\n    }, []);\n\n    const loadData = async () => {\n        setLoading(true);\n        try {\n            const [docsResult, propsResult, leasesResult] = await Promise.all([\n                getRentalDocuments(),\n                getProperties(),\n                getLeasesByOwner()\n            ]);\n\n            if (docsResult.success) {\n                setDocuments(docsResult.data as RentalDocument[]);\n            }\n            if (propsResult.success) {\n                setProperties(propsResult.data || []);\n            }\n            if (leasesResult.success && leasesResult.data) {\n                // Adapt leases structure if needed\n                setLeases(leasesResult.data.map((l: any) => ({\n                    id: l.id,\n                    property_id: l.property_id,\n                    tenant_name: l.tenant_name\n                })));\n            }\n        } catch (error) {\n            console.error(\"Error loading GED data:\", error);\n            toast.error(\"Erreur lors du chargement des documents\");\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    const handleUpload = async () => {\n        if (!uploadFile || !uploadPropertyId || !uploadCategory) {\n            toast.error(\"Veuillez remplir tous les champs obligatoires\");\n            return;\n        }\n\n        setUploading(true);\n        const formData = new FormData();\n        formData.append(\"file\", uploadFile);\n        formData.append(\"type\", \"autre\"); // Default internal type\n        formData.append(\"category\", uploadCategory);\n        formData.append(\"propertyId\", uploadPropertyId);\n        if (uploadLeaseId && uploadLeaseId !== \"none\") {\n            formData.append(\"leaseId\", uploadLeaseId);\n        }\n\n        const result = await uploadDocument(formData);\n\n        if (result.success) {\n            toast.success(\"Document ajout√© √† la GED\");\n            setUploadDialogOpen(false);\n            setUploadFile(null);\n            setUploadCategory(\"\");\n            loadData(); // Refresh list\n        } else {\n            toast.error(result.error || \"Erreur lors de l'upload\");\n        }\n        setUploading(false);\n    };\n\n    const handleDelete = async (id: string) => {\n        if (!confirm(\"Supprimer ce document ?\")) return;\n        const result = await deleteDocument(id);\n        if (result.success) {\n            toast.success(\"Document supprim√©\");\n            loadData();\n        } else {\n            toast.error(\"Erreur suppression\");\n        }\n    };\n\n    const filteredDocuments = documents.filter(doc => {\n        const matchesLease = selectedLeaseFilter === \"all\" || doc.lease_id === selectedLeaseFilter;\n        const docName = doc.name || doc.file_name || '';  // Fallback to file_name if name is missing\n        const docCategory = doc.category || '';\n        const matchesSearch = docName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n            docCategory.toLowerCase().includes(searchQuery.toLowerCase());\n        return matchesLease && matchesSearch;\n    });\n\n    const getFileIcon = (mimeType: string) => {\n        if (mimeType.includes(\"pdf\")) return <FilePdf className=\"w-6 h-6 text-red-400\" weight=\"duotone\" />;\n        if (mimeType.includes(\"image\")) return <ImageIcon className={`w-6 h-6 ${isDark ? 'text-brand' : 'text-slate-900'}`} weight=\"duotone\" />;\n        return <FileText className=\"w-6 h-6 text-slate-400\" weight=\"duotone\" />;\n    };\n\n    return (\n        <div className={`min-h-screen p-6 md:p-8 ${isDark ? 'bg-slate-950' : 'bg-gray-50'}`}>\n            <div className=\"max-w-7xl mx-auto space-y-8\">\n\n                {/* Header */}\n                <div id=\"tour-ged-header\" className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\n                    <DocumentsTour />\n                    <div>\n                        <h1 className={`text-2xl font-bold flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                            <Folder className=\"text-brand\" weight=\"duotone\" />\n                            GED & Documents\n                        </h1>\n                        <p className={`text-sm mt-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            G√©rez de mani√®re centralis√©e tous les documents de vos biens locatifs\n                        </p>\n                    </div>\n\n                    <Dialog open={uploadDialogOpen} onOpenChange={setUploadDialogOpen}>\n                        <DialogTrigger asChild>\n                            <Button id=\"tour-ged-upload\" className={`${isDark ? 'bg-brand hover:bg-brand/90 text-black' : 'bg-slate-900 hover:bg-slate-800 text-white'} gap-2`}>\n                                <UploadSimple weight=\"bold\" />\n                                Nouveau Document\n                            </Button>\n                        </DialogTrigger>\n                        <DialogContent className={`${isDark ? 'bg-slate-900 border-slate-800 text-white' : 'bg-white border-gray-200 text-gray-900'}`}>\n                            <DialogHeader>\n                                <DialogTitle className={isDark ? 'text-white' : 'text-gray-900'}>Ajouter un document</DialogTitle>\n                                <DialogDescription className={isDark ? 'text-slate-400' : 'text-gray-600'}>\n                                    Liez ce document √† une propri√©t√© pour une organisation optimale.\n                                </DialogDescription>\n                            </DialogHeader>\n\n                            <div className=\"space-y-4 py-4\">\n                                <div className=\"space-y-2\">\n                                    <Label required>Propri√©t√© concern√©e</Label>\n                                    <Select value={uploadPropertyId} onValueChange={setUploadPropertyId}>\n                                        <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                            <SelectValue placeholder=\"Choisir un bien...\" />\n                                        </SelectTrigger>\n                                        <SelectContent className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-200 text-gray-900'}>\n                                            {properties.map(p => (\n                                                <SelectItem key={p.id} value={p.id}>{p.title}</SelectItem>\n                                            ))}\n                                        </SelectContent>\n                                    </Select>\n                                </div>\n\n                                <div className=\"space-y-2\">\n                                    <Label>Locataire / Bail (Optionnel)</Label>\n                                    <Select value={uploadLeaseId} onValueChange={setUploadLeaseId} disabled={!uploadPropertyId}>\n                                        <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                            <SelectValue placeholder=\"Lier √† un locataire...\" />\n                                        </SelectTrigger>\n                                        <SelectContent className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-200 text-gray-900'}>\n                                            <SelectItem value=\"none\">-- Aucun --</SelectItem>\n                                            {leases\n                                                .filter(l => l.property_id === uploadPropertyId)\n                                                .map(l => (\n                                                    <SelectItem key={l.id} value={l.id}>{l.tenant_name}</SelectItem>\n                                                ))}\n                                        </SelectContent>\n                                    </Select>\n                                </div>\n\n                                <div className=\"space-y-2\">\n                                    <Label required>Cat√©gorie</Label>\n                                    <Select value={uploadCategory} onValueChange={setUploadCategory}>\n                                        <SelectTrigger className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                            <SelectValue placeholder=\"Type de document...\" />\n                                        </SelectTrigger>\n                                        <SelectContent className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-200 text-gray-900'}>\n                                            {DOCUMENT_CATEGORIES.map(cat => (\n                                                <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>\n                                            ))}\n                                        </SelectContent>\n                                    </Select>\n                                </div>\n\n                                <div className=\"space-y-2\">\n                                    <Label>Fichier</Label>\n                                    <Input\n                                        type=\"file\"\n                                        onChange={(e) => setUploadFile(e.target.files?.[0] || null)}\n                                        className={isDark\n                                            ? 'bg-slate-800 border-slate-700 text-white file:bg-slate-700 file:text-white file:border-0'\n                                            : 'bg-gray-50 border-gray-300 text-gray-900 file:bg-gray-200 file:text-gray-700 file:border-0'\n                                        }\n                                    />\n                                </div>\n\n                                <Button\n                                    onClick={handleUpload}\n                                    disabled={uploading}\n                                    className={`w-full ${isDark ? 'bg-brand hover:bg-brand/90 text-black' : 'bg-slate-900 hover:bg-slate-800 text-white'} mt-2`}\n                                >\n                                    {uploading ? \"Envoi en cours...\" : \"Sauvegarder\"}\n                                </Button>\n                            </div>\n                        </DialogContent>\n                    </Dialog>\n                </div>\n\n                {/* Filters */}\n                <Card id=\"tour-ged-search\" className={`p-4 ${isDark ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-gray-200'}`}>\n                    <div className=\"flex flex-col md:flex-row gap-4\">\n                        <div className=\"relative flex-1\">\n                            <MagnifyingGlass className={`absolute left-3 top-1/2 -translate-y-1/2 ${isDark ? 'text-slate-400' : 'text-gray-400'}`} />\n                            <Input\n                                placeholder=\"Rechercher un document...\"\n                                value={searchQuery}\n                                onChange={(e) => setSearchQuery(e.target.value)}\n                                className={`pl-10 w-full ${isDark ? 'bg-slate-950 border-slate-800 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'}`}\n                            />\n                        </div>\n                        <div className=\"w-full md:w-64\">\n                            <Select value={selectedLeaseFilter} onValueChange={setSelectedLeaseFilter}>\n                                <SelectTrigger className={isDark ? 'bg-slate-950 border-slate-800 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'}>\n                                    <Funnel className=\"w-4 h-4 mr-2\" />\n                                    <SelectValue placeholder=\"Filtrer par locataire\" />\n                                </SelectTrigger>\n                                <SelectContent className={isDark ? 'bg-slate-900 border-slate-800 text-white' : 'bg-white border-gray-200 text-gray-900'}>\n                                    <SelectItem value=\"all\">Tous les locataires</SelectItem>\n                                    {leases.map(lease => (\n                                        <SelectItem key={lease.id} value={lease.id}>\n                                            {lease.tenant_name}\n                                        </SelectItem>\n                                    ))}\n                                </SelectContent>\n                            </Select>\n                        </div>\n                    </div>\n                </Card>\n\n                {/* Content */}\n                <div id=\"tour-ged-list\">\n                    {loading ? (\n                        <div className={`text-center py-12 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>Chargement de vos documents...</div>\n                    ) : filteredDocuments.length === 0 ? (\n                        <EmptyState\n                            title=\"Aucun document trouv√©\"\n                            description=\"Commencez par ajouter des baux, quittances ou factures pour vos biens.\"\n                            actionLabel=\"Ajouter un document\"\n                            onAction={() => setUploadDialogOpen(true)}\n                            icon={Folder}\n                        />\n                    ) : (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                            {filteredDocuments.map((doc) => (\n                                <motion.div\n                                    key={doc.id}\n                                    initial={{ opacity: 0, y: 10 }}\n                                    animate={{ opacity: 1, y: 0 }}\n                                    className={`group relative rounded-xl p-4 transition-all hover:shadow-lg border ${isDark\n                                        ? 'bg-slate-900 border-slate-800 hover:border-brand/30 hover:shadow-brand/5'\n                                        : 'bg-white border-gray-200 hover:border-brand/30 hover:shadow-brand/5'\n                                        }`}\n                                >\n                                    {/* Lien global cliquable (Stretched link pattern) */}\n                                    {doc.url && (\n                                        <a\n                                            href={doc.url}\n                                            target=\"_blank\"\n                                            rel=\"noopener noreferrer\"\n                                            className=\"absolute inset-0 z-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2\"\n                                            aria-label={`Voir le document ${doc.name}`}\n                                        />\n                                    )}\n\n                                    <div className=\"flex items-start justify-between mb-3 relative z-10 pointer-events-none\">\n                                        <div className={`p-2 rounded-lg pointer-events-auto ${isDark ? 'bg-slate-950' : 'bg-gray-100'}`}>\n                                            {getFileIcon(doc.type || \"\")}\n                                        </div>\n                                        <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto\">\n                                            <a\n                                                href={doc.url}\n                                                target=\"_blank\"\n                                                rel=\"noopener noreferrer\"\n                                                className={`p-1.5 rounded-md ${isDark ? 'hover:bg-slate-800 text-slate-400 hover:text-brand' : 'hover:bg-gray-100 text-gray-400 hover:text-slate-900'}`}\n                                                title=\"Pr√©visualiser\"\n                                            >\n                                                <Eye size={18} weight=\"bold\" />\n                                            </a>\n                                            <a\n                                                href={doc.url}\n                                                download\n                                                target=\"_blank\"\n                                                rel=\"noopener noreferrer\"\n                                                className={`p-1.5 rounded-md ${isDark ? 'hover:bg-slate-800 text-slate-400 hover:text-white' : 'hover:bg-gray-100 text-gray-400 hover:text-gray-900'}`}\n                                                title=\"T√©l√©charger\"\n                                            >\n                                                <DownloadSimple size={18} />\n                                            </a>\n                                            <button\n                                                onClick={(e) => {\n                                                    e.stopPropagation(); // Important pour ne pas trigger le lien global (m√™me si z-index g√®re)\n                                                    handleDelete(doc.id);\n                                                }}\n                                                className={`p-1.5 rounded-md ${isDark ? 'hover:bg-red-900/20 text-slate-400 hover:text-red-400' : 'hover:bg-red-50 text-gray-400 hover:text-red-600'}`}\n                                                title=\"Supprimer\"\n                                            >\n                                                <Trash size={18} />\n                                            </button>\n                                        </div>\n                                    </div>\n\n                                    <div className=\"space-y-1\">\n                                        <h3 className={`font-medium truncate ${isDark ? 'text-slate-200' : 'text-gray-900'}`} title={doc.name}>\n                                            {doc.name}\n                                        </h3>\n                                        <p className={`text-xs uppercase tracking-wider font-semibold ${isDark ? 'text-brand' : 'text-slate-500'}`}>\n                                            {DOCUMENT_CATEGORIES.find(c => c.value === doc.category)?.label || doc.category}\n                                        </p>\n                                    </div>\n\n                                    <div className={`mt-4 pt-3 flex items-center justify-between text-xs border-t ${isDark ? 'border-slate-800 text-slate-500' : 'border-gray-200 text-gray-500'}`}>\n                                        <span className=\"flex items-center gap-1.5\">\n                                            {doc.tenant_name && (\n                                                <>\n                                                    <User size={12} />\n                                                    {doc.tenant_name}\n                                                </>\n                                            )}\n                                            {doc.property_title && !doc.tenant_name && (\n                                                <>\n                                                    <House size={12} />\n                                                    {doc.property_title}\n                                                </>\n                                            )}\n                                        </span>\n                                        <span>{doc.uploaded_at ? format(new Date(doc.uploaded_at), \"d MMM yyyy\", { locale: fr }) : 'Date inconnue'}</span>\n                                    </div>\n                                </motion.div>\n                            ))}\n                        </div>\n                    )}\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4808,4811],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4808,4811],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":205,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5861,5864],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5861,5864],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":244,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6864,6867],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6864,6867],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":306,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":306,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8536,8539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8536,8539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":471,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":471,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13663,13666],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13663,13666],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":786,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":786,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25736,25739],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25736,25739],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":822,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":822,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26717,26720],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26717,26720],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1173,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1173,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36945,36948],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36945,36948],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1223,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1223,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38521,38524],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38521,38524],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1258,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1258,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39594,39597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39594,39597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport { createAdminClient } from \"@/utils/supabase/admin\";\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { safeAction } from \"@/lib/safe-action\";\nimport {\n  TEAM_ROLE_CONFIG,\n} from \"@/lib/team-permissions\";\nimport { getUserTeamContext } from \"@/lib/team-context\";\nimport { requireTeamPermission, _requireTeamRole } from \"@/lib/permissions\";\nimport { checkFeatureAccess } from \"@/lib/subscription/team-subscription\";\nimport { sendEmail } from \"@/lib/mail\";\nimport type {\n  Team,\n  TeamMember,\n  TeamInvitation,\n  TeamAuditLog,\n  TeamRole,\n  CreateTeamResult,\n  _InviteMemberResult,\n  AcceptInvitationResult,\n  TeamActionResult,\n  TeamStats,\n} from \"@/types/team\";\n\n// =====================================================\n// SCHEMAS ZOD\n// =====================================================\n\nconst createTeamSchema = z.object({\n  name: z.string().min(2, \"Le nom doit contenir au moins 2 caract√®res\").max(100),\n  description: z.string().max(500).optional(),\n  company_address: z.string().max(200).optional(),\n  company_phone: z.string().max(20).optional(),\n  company_email: z.string().email(\"Email invalide\").optional().or(z.literal(\"\")),\n  company_ninea: z.string().max(50).optional(),\n});\n\nconst updateTeamSchema = z.object({\n  name: z.string().min(2).max(100).optional(),\n  description: z.string().max(500).optional(),\n  company_address: z.string().max(200).optional(),\n  company_phone: z.string().max(20).optional(),\n  company_email: z.string().email().optional().or(z.literal(\"\")),\n  company_ninea: z.string().max(50).optional(),\n  billing_email: z.string().email().optional().or(z.literal(\"\")),\n  default_billing_day: z.number().min(1).max(31).optional(),\n});\n\nconst inviteMemberSchema = z.object({\n  teamId: z.string().uuid(\"ID d'√©quipe invalide\"),\n  email: z.string().email(\"Email invalide\"),\n  role: z.enum([\"manager\", \"accountant\", \"agent\"]),\n  message: z.string().max(500).optional(),\n});\n\nconst changeRoleSchema = z.object({\n  teamId: z.string().uuid(),\n  memberId: z.string().uuid(),\n  newRole: z.enum([\"manager\", \"accountant\", \"agent\"]),\n});\n\n// =====================================================\n// HELPERS\n// =====================================================\n\n/**\n * G√©n√®re un slug URL-friendly unique\n */\nfunction generateSlug(name: string): string {\n  return name\n    .toLowerCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .replace(/[^a-z0-9]+/g, \"-\")\n    .replace(/(^-|-$)/g, \"\");\n}\n\n/**\n * Log une action dans l'audit trail\n */\nasync function logTeamAudit(\n  teamId: string,\n  userId: string,\n  action: string,\n  resourceType: string,\n  resourceId: string | null,\n  oldData: unknown,\n  newData: unknown\n) {\n  const supabase = await createClient();\n\n  await supabase.from(\"team_audit_logs\").insert({\n    team_id: teamId,\n    user_id: userId,\n    action,\n    resource_type: resourceType,\n    resource_id: resourceId,\n    old_data: oldData ? JSON.parse(JSON.stringify(oldData)) : null,\n    new_data: newData ? JSON.parse(JSON.stringify(newData)) : null,\n  });\n}\n\n// =====================================================\n// LECTURE\n// =====================================================\n\n/**\n * R√©cup√®re l'√©quipe de l'utilisateur connect√© (SSOT)\n */\nexport async function getCurrentUserTeam(): Promise<{\n  success: boolean;\n  team?: Team;\n  role?: TeamRole;\n  error?: string;\n}> {\n  try {\n    const { team, role } = await getUserTeamContext();\n    return {\n      success: true,\n      team: team as unknown as Team,\n      role: role as TeamRole,\n    };\n  } catch (error) {\n    console.error(\"Erreur r√©cup√©ration √©quipe:\", error);\n    return { success: false, error: \"Erreur lors de la r√©cup√©ration de l'√©quipe\" };\n  }\n}\n\n/**\n * R√©cup√®re les membres d'une √©quipe\n */\nexport async function getTeamMembers(\n  teamId: string\n): Promise<{ success: boolean; members?: TeamMember[]; error?: string }> {\n  try {\n    const { teamId: activeTeamId } = await requireTeamPermission(\"team.members.view\");\n\n    // S√©curit√© additionnelle\n    if (activeTeamId !== teamId) {\n      return { success: false, error: \"Acc√®s non autoris√© √† cette √©quipe\" };\n    }\n\n    const supabase = await createClient();\n\n    const { data, error } = await supabase\n      .from(\"team_members\")\n      .select(\n        `\n        *,\n        user:profiles(id, email, full_name, phone)\n      `\n      )\n      .eq(\"team_id\", teamId)\n      .eq(\"status\", \"active\")\n      .order(\"role\", { ascending: true })\n      .order(\"joined_at\", { ascending: true });\n\n    if (error) {\n      console.error(\"Erreur r√©cup√©ration membres:\", error);\n      return { success: false, error: \"Erreur lors de la r√©cup√©ration des membres\" };\n    }\n\n    return { success: true, members: data as TeamMember[] };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n/**\n * R√©cup√®re les invitations en attente\n */\nexport async function getTeamInvitations(\n  teamId: string\n): Promise<{ success: boolean; invitations?: TeamInvitation[]; error?: string }> {\n  try {\n    const { teamId: activeTeamId } = await requireTeamPermission(\"team.members.view\");\n\n    if (activeTeamId !== teamId) {\n      return { success: false, error: \"Acc√®s non autoris√©\" };\n    }\n\n    const supabase = await createClient();\n\n    const { data, error } = await supabase\n      .from(\"team_invitations\")\n      .select(\n        `\n        *,\n        inviter:profiles!invited_by(full_name, email)\n      `\n      )\n      .eq(\"team_id\", teamId)\n      .eq(\"status\", \"pending\")\n      .order(\"created_at\", { ascending: false });\n\n    if (error) {\n      console.error(\"Erreur r√©cup√©ration invitations:\", error);\n      return { success: false, error: \"Erreur lors de la r√©cup√©ration des invitations\" };\n    }\n\n    return { success: true, invitations: data as TeamInvitation[] };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n/**\n * R√©cup√®re les logs d'audit\n */\nexport async function getTeamAuditLogs(\n  teamId: string,\n  limit = 50\n): Promise<{ success: boolean; logs?: TeamAuditLog[]; error?: string }> {\n  try {\n    const { teamId: activeTeamId } = await requireTeamPermission(\"team.audit.view\");\n\n    if (activeTeamId !== teamId) {\n      return { success: false, error: \"Acc√®s non autoris√©\" };\n    }\n\n    const supabase = await createClient();\n\n    const { data, error } = await supabase\n      .from(\"team_audit_logs\")\n      .select(\n        `\n        *,\n        user:profiles(full_name, email)\n      `\n      )\n      .eq(\"team_id\", teamId)\n      .order(\"created_at\", { ascending: false })\n      .limit(limit);\n\n    if (error) {\n      console.error(\"Erreur r√©cup√©ration audit:\", error);\n      return { success: false, error: \"Erreur lors de la r√©cup√©ration de l'historique\" };\n    }\n\n    return { success: true, logs: data as TeamAuditLog[] };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n/**\n * R√©cup√®re les statistiques de l'√©quipe\n */\nexport async function getTeamStats(\n  teamId: string\n): Promise<{ success: boolean; stats?: TeamStats; error?: string }> {\n  try {\n    const { teamId: activeTeamId } = await requireTeamPermission(\"team.members.view\");\n\n    if (activeTeamId !== teamId) {\n      return { success: false, error: \"Acc√®s non autoris√©\" };\n    }\n\n    const supabase = await createClient();\n\n    // R√©cup√©rer les membres\n    const { data: members } = await supabase\n      .from(\"team_members\")\n      .select(\"role\")\n      .eq(\"team_id\", teamId)\n      .eq(\"status\", \"active\");\n\n    // R√©cup√©rer les invitations pending\n    const { count: pendingInvitations } = await supabase\n      .from(\"team_invitations\")\n      .select(\"id\", { count: \"exact\", head: true })\n      .eq(\"team_id\", teamId)\n      .eq(\"status\", \"pending\");\n\n    // R√©cup√©rer les baux\n    const { data: leases } = await supabase\n      .from(\"leases\")\n      .select(\"status\")\n      .eq(\"team_id\", teamId);\n\n    const membersByRole: Record<TeamRole, number> = {\n      owner: 0,\n      manager: 0,\n      accountant: 0,\n      agent: 0,\n    };\n\n    members?.forEach((m) => {\n      const role = m.role as TeamRole;\n      membersByRole[role] = (membersByRole[role] || 0) + 1;\n    });\n\n    return {\n      success: true,\n      stats: {\n        total_members: members?.length || 0,\n        members_by_role: membersByRole,\n        pending_invitations: pendingInvitations || 0,\n        total_leases: leases?.length || 0,\n        active_leases: leases?.filter((l) => l.status === \"active\").length || 0,\n      },\n    };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n// =====================================================\n// CR√âATION D'√âQUIPE\n// =====================================================\n\nexport async function createTeam(\n  formData: z.infer<typeof createTeamSchema>\n): Promise<CreateTeamResult> {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return { success: false, error: \"Non connect√©\" };\n  }\n\n  // V√©rifier si l'utilisateur a d√©j√† une √©quipe\n  const { data: existingMembership } = await supabase\n    .from(\"team_members\")\n    .select(\"id\")\n    .eq(\"user_id\", user.id)\n    .eq(\"status\", \"active\")\n    .maybeSingle();\n\n  if (existingMembership) {\n    return { success: false, error: \"Vous √™tes d√©j√† membre d'une √©quipe\" };\n  }\n\n  // Validation Zod\n  const validation = createTeamSchema.safeParse(formData);\n  if (!validation.success) {\n    return { success: false, error: validation.error.issues[0].message };\n  }\n\n  const data = validation.data;\n\n  // G√©n√©rer un slug unique\n  const baseSlug = generateSlug(data.name);\n  const { data: existingTeam } = await supabase\n    .from(\"teams\")\n    .select(\"id\")\n    .eq(\"slug\", baseSlug)\n    .maybeSingle();\n\n  const slug = existingTeam ? `${baseSlug}-${Date.now().toString(36)}` : baseSlug;\n\n  // Cr√©er l'√©quipe\n  const { data: team, error: teamError } = await supabase\n    .from(\"teams\")\n    .insert({\n      name: data.name,\n      slug,\n      description: data.description || null,\n      company_address: data.company_address || null,\n      company_phone: data.company_phone || null,\n      company_email: data.company_email || null,\n      company_ninea: data.company_ninea || null,\n      created_by: user.id,\n    })\n    .select()\n    .single();\n\n  if (teamError) {\n    console.error(\"Erreur cr√©ation √©quipe:\", teamError);\n    return { success: false, error: `Erreur: ${teamError.message}` };\n  }\n\n  // Ajouter le cr√©ateur comme owner\n  const { error: memberError } = await supabase.from(\"team_members\").insert({\n    team_id: team.id,\n    user_id: user.id,\n    role: \"owner\",\n    status: \"active\",\n    joined_at: new Date().toISOString(),\n  });\n\n  if (memberError) {\n    // Rollback: supprimer l'√©quipe\n    await supabase.from(\"teams\").delete().eq(\"id\", team.id);\n    console.error(\"Erreur ajout membre owner:\", memberError);\n    return { success: false, error: \"Erreur lors de la configuration de l'√©quipe\" };\n  }\n\n  // Audit log\n  await logTeamAudit(team.id, user.id, \"team.created\", \"team\", team.id, null, team);\n\n  revalidatePath(\"/gestion/equipe\");\n  revalidatePath(\"/gestion\");\n\n  return { success: true, teamId: team.id, slug: team.slug };\n}\n\n// =====================================================\n// MISE √Ä JOUR √âQUIPE\n// =====================================================\n\nexport async function updateTeam(\n  teamId: string,\n  formData: z.infer<typeof updateTeamSchema>\n): Promise<TeamActionResult> {\n  try {\n    const { user, teamId: activeTeamId } = await requireTeamPermission(\"team.settings.edit\");\n\n    if (activeTeamId !== teamId) {\n      return { success: false, error: \"Acc√®s non autoris√©\" };\n    }\n\n    const validation = updateTeamSchema.safeParse(formData);\n    if (!validation.success) {\n      return { success: false, error: validation.error.issues[0].message };\n    }\n\n    const supabase = await createClient();\n\n    // R√©cup√©rer l'ancienne valeur pour l'audit\n    const { data: oldTeam } = await supabase\n      .from(\"teams\")\n      .select(\"*\")\n      .eq(\"id\", teamId)\n      .single();\n\n    // Construire l'objet de mise √† jour (uniquement champs non-undefined)\n    const updates: Record<string, unknown> = {};\n    const data = validation.data;\n\n    if (data.name !== undefined) updates.name = data.name;\n    if (data.description !== undefined) updates.description = data.description || null;\n    if (data.company_address !== undefined) updates.company_address = data.company_address || null;\n    if (data.company_phone !== undefined) updates.company_phone = data.company_phone || null;\n    if (data.company_email !== undefined) updates.company_email = data.company_email || null;\n    if (data.company_ninea !== undefined) updates.company_ninea = data.company_ninea || null;\n    if (data.billing_email !== undefined) updates.billing_email = data.billing_email || null;\n    if (data.default_billing_day !== undefined) updates.default_billing_day = data.default_billing_day;\n\n    if (Object.keys(updates).length === 0) {\n      return { success: true, message: \"Aucune modification\" };\n    }\n\n    const { error } = await supabase.from(\"teams\").update(updates).eq(\"id\", teamId);\n\n    if (error) {\n      console.error(\"Erreur mise √† jour √©quipe:\", error);\n      return { success: false, error: \"Erreur lors de la mise √† jour\" };\n    }\n\n    // Audit log\n    await logTeamAudit(\n      teamId,\n      user.id,\n      \"team.updated\",\n      \"team\",\n      teamId,\n      oldTeam,\n      updates\n    );\n\n    revalidatePath(\"/gestion/equipe\");\n    revalidatePath(\"/gestion/equipe/parametres\");\n\n    return { success: true, message: \"√âquipe mise √† jour\" };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n// =====================================================\n// INVITATION DE MEMBRE\n// =====================================================\n\nexport const inviteTeamMember = safeAction(\n  \"inviteTeamMember\",\n  inviteMemberSchema,\n  async (data, { _userId, teamId: _ctxTeamId }) => {\n    // V√©rifier permission\n    const { user, teamId } = await requireTeamPermission(\"team.members.invite\");\n\n    if (teamId !== data.teamId) {\n      throw new Error(\"Acc√®s non autoris√©\");\n    }\n\n    const supabase = await createClient();\n\n    // ‚úÖ QUOTA: V√©rifier les limites du plan (Starter/Pro/Enterprise)\n    const access = await checkFeatureAccess(data.teamId, 'invite_member');\n\n    if (!access.allowed) {\n      throw new Error(access.message || \"Impossible d'inviter plus de membres avec votre plan actuel.\");\n    }\n\n    // R√©cup√©rer information √©quipe pour l'email (optimisation: d√©j√† fait dans checkFeatureAccess mais on a besoin du nom ici)\n    const supabaseAdmin = createAdminClient();\n\n    // V√©rifier si l'email est d√©j√† membre\n    const { data: profiles } = await supabase\n      .from(\"profiles\")\n      .select(\"id\")\n      .eq(\"email\", data.email.toLowerCase())\n      .maybeSingle();\n\n    if (profiles) {\n      const { data: existingMember } = await supabase\n        .from(\"team_members\")\n        .select(\"id\")\n        .eq(\"team_id\", data.teamId)\n        .eq(\"user_id\", profiles.id)\n        .eq(\"status\", \"active\")\n        .maybeSingle();\n\n      if (existingMember) {\n        throw new Error(\"Cet utilisateur est d√©j√† membre de l'√©quipe\");\n      }\n    }\n\n    // V√©rifier si invitation d√©j√† en cours\n    const { data: existingInvite } = await supabaseAdmin\n      .from(\"team_invitations\")\n      .select(\"id\")\n      .eq(\"team_id\", data.teamId)\n      .eq(\"email\", data.email.toLowerCase())\n      .eq(\"status\", \"pending\")\n      .maybeSingle();\n\n    if (existingInvite) {\n      throw new Error(\"Une invitation est d√©j√† en cours pour cet email\");\n    }\n\n    // R√©cup√©rer les infos de l'√©quipe\n    const { data: teamInfo } = await supabase\n      .from(\"teams\")\n      .select(\"name\")\n      .eq(\"id\", data.teamId)\n      .single();\n\n    // R√©cup√©rer le nom de l'inviteur\n    const { data: inviterProfile } = await supabase\n      .from(\"profiles\")\n      .select(\"full_name\")\n      .eq(\"id\", user.id)\n      .single();\n\n    // G√©n√©rer le token et l'expiration\n    const inviteToken = globalThis.crypto.randomUUID();\n    const expiresAt = new Date();\n    expiresAt.setDate(expiresAt.getDate() + 7); // 7 jours\n\n    // Cr√©er l'invitation\n    const { data: invitation, error } = await supabaseAdmin\n      .from(\"team_invitations\")\n      .insert({\n        team_id: data.teamId,\n        email: data.email.toLowerCase(),\n        role: data.role,\n        token: inviteToken,\n        expires_at: expiresAt.toISOString(),\n        invited_by: user.id,\n        message: data.message || null,\n      })\n      .select()\n      .single();\n\n    if (error) {\n      console.error(\"Erreur cr√©ation invitation:\", error);\n      throw new Error(\"Erreur lors de l'envoi de l'invitation\");\n    }\n\n    // Envoyer l'email d'invitation\n    try {\n      const roleConfig = TEAM_ROLE_CONFIG[data.role];\n      const inviteUrl = `${process.env.NEXT_PUBLIC_SITE_URL}/gestion/equipe/invitations/accept?token=${inviteToken}`;\n      console.log(\"üîó LIEN D'INVITATION G√âN√âR√â:\", inviteUrl);\n\n      const emailHtml = `\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <meta charset=\"utf-8\">\n            <style>\n              body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; }\n              .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n              .header { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n              .content { background: #f8fafc; padding: 30px; border-radius: 0 0 10px 10px; }\n              .button { display: inline-block; padding: 12px 30px; background: #F4C430; color: #000; text-decoration: none; border-radius: 6px; font-weight: 600; margin: 20px 0; }\n              .info-box { background: white; padding: 15px; border-left: 4px solid #F4C430; margin: 20px 0; border-radius: 4px; }\n              .footer { text-align: center; margin-top: 30px; color: #64748b; font-size: 14px; }\n            </style>\n          </head>\n          <body>\n            <div class=\"container\">\n              <div class=\"header\">\n                <h1 style=\"margin: 0;\">üè¢ Invitation √† rejoindre ${teamInfo?.name || \"l'√©quipe\"}</h1>\n              </div>\n              <div class=\"content\">\n                <p>Bonjour,</p>\n                <p><strong>${inviterProfile?.full_name || \"Un membre\"}</strong> vous invite √† rejoindre l'√©quipe <strong>${teamInfo?.name || \"l'√©quipe\"}</strong> sur <strong>Dousell Immo</strong>.</p>\n\n                <div class=\"info-box\">\n                  <p style=\"margin: 5px 0;\"><strong>R√¥le propos√©:</strong> ${roleConfig.label}</p>\n                  <p style=\"margin: 5px 0; color: #64748b;\">${roleConfig.description}</p>\n                </div>\n\n                ${data.message ? `<p style=\"font-style: italic; color: #64748b;\">\"${data.message}\"</p>` : \"\"}\n\n                <div style=\"text-align: center;\">\n                  <a href=\"${inviteUrl}\" class=\"button\">Accepter l'invitation</a>\n                </div>\n\n                <p style=\"font-size: 14px; color: #64748b; margin-top: 20px;\">\n                  Cette invitation expire dans 7 jours. Si vous n'avez pas demand√© cette invitation, vous pouvez ignorer cet email.\n                </p>\n\n                <p style=\"font-size: 14px; color: #64748b;\">\n                  Ou copiez ce lien dans votre navigateur:<br>\n                  <a href=\"${inviteUrl}\" style=\"color: #3b82f6; word-break: break-all;\">${inviteUrl}</a>\n                </p>\n              </div>\n              <div class=\"footer\">\n                <p>¬© ${new Date().getFullYear()} Dousell Immo - Gestion Locative Intelligente</p>\n              </div>\n            </div>\n          </body>\n        </html>\n      `;\n\n      await sendEmail({\n        to: data.email,\n        subject: `Invitation √† rejoindre ${teamInfo?.name || \"l'√©quipe\"} sur Dousell Immo`,\n        html: emailHtml,\n        fromName: \"Dousell Immo\",\n      });\n    } catch (emailError) {\n      console.error(\"Erreur envoi email invitation:\", emailError);\n    }\n\n    revalidatePath(\"/gestion/equipe\");\n    revalidatePath(\"/gestion/equipe/invitations\");\n\n    return { success: true, invitationId: invitation.id };\n  }\n);\n\n/**\n * Renvoie une invitation (r√©initialise l'expiration)\n */\nexport async function resendInvitation(\n  teamId: string,\n  invitationId: string\n): Promise<TeamActionResult> {\n  try {\n    const { user, teamId: activeTeamId } = await requireTeamPermission(\"team.members.invite\");\n\n    if (activeTeamId !== teamId) {\n      return { success: false, error: \"Acc√®s non autoris√©\" };\n    }\n\n    const supabaseAdmin = createAdminClient();\n\n    // R√©cup√©rer l'invitation\n    const { data: invitation, error: fetchError } = await supabaseAdmin\n      .from(\"team_invitations\")\n      .select(\"*\")\n      .eq(\"id\", invitationId)\n      .eq(\"team_id\", teamId)\n      .single();\n\n    if (fetchError || !invitation) {\n      return { success: false, error: \"Invitation introuvable\" };\n    }\n\n    // Mettre √† jour l'expiration (7 jours √† partir de maintenant)\n    const expiresAt = new Date();\n    expiresAt.setDate(expiresAt.getDate() + 7);\n\n    const { error: updateError } = await supabaseAdmin\n      .from(\"team_invitations\")\n      .update({\n        expires_at: expiresAt.toISOString(),\n        status: \"pending\", // Au cas o√π elle √©tait expir√©e\n        created_at: new Date().toISOString(), // On reset le timer visuel\n      })\n      .eq(\"id\", invitationId);\n\n    if (updateError) {\n      return { success: false, error: \"Erreur lors du renvoi de l'invitation\" };\n    }\n\n    // Envoyer l'email d'invitation\n    try {\n      const supabase = await createClient();\n\n      // R√©cup√©rer les infos de l'√©quipe et de l'inviteur\n      const { data: team } = await supabase\n        .from(\"teams\")\n        .select(\"name\")\n        .eq(\"id\", teamId)\n        .single();\n\n      const { data: inviterProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"full_name\")\n        .eq(\"id\", user.id)\n        .single();\n\n      const roleConfig = TEAM_ROLE_CONFIG[invitation.role as TeamRole];\n      const inviteUrl = `${process.env.NEXT_PUBLIC_SITE_URL}/gestion/equipe/invitations/accept?token=${invitation.token}`;\n\n      const emailHtml = `\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <meta charset=\"utf-8\">\n            <style>\n              body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; }\n              .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n              .header { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n              .content { background: #f8fafc; padding: 30px; border-radius: 0 0 10px 10px; }\n              .button { display: inline-block; padding: 12px 30px; background: #F4C430; color: #000; text-decoration: none; border-radius: 6px; font-weight: 600; margin: 20px 0; }\n              .info-box { background: white; padding: 15px; border-left: 4px solid #F4C430; margin: 20px 0; border-radius: 4px; }\n              .footer { text-align: center; margin-top: 30px; color: #64748b; font-size: 14px; }\n            </style>\n          </head>\n          <body>\n            <div class=\"container\">\n              <div class=\"header\">\n                <h1 style=\"margin: 0;\">üîÑ Rappel - Invitation √† rejoindre ${team?.name || \"l'√©quipe\"}</h1>\n              </div>\n              <div class=\"content\">\n                <p>Bonjour,</p>\n                <p><strong>${inviterProfile?.full_name || \"Un membre\"}</strong> vous renvoie l'invitation √† rejoindre l'√©quipe <strong>${team?.name || \"l'√©quipe\"}</strong> sur <strong>Dousell Immo</strong>.</p>\n\n                <div class=\"info-box\">\n                  <p style=\"margin: 5px 0;\"><strong>R√¥le propos√©:</strong> ${roleConfig.label}</p>\n                  <p style=\"margin: 5px 0; color: #64748b;\">${roleConfig.description}</p>\n                </div>\n\n                ${invitation.message ? `<p style=\"font-style: italic; color: #64748b;\">\"${invitation.message}\"</p>` : \"\"}\n\n                <div style=\"text-align: center;\">\n                  <a href=\"${inviteUrl}\" class=\"button\">Accepter l'invitation</a>\n                </div>\n\n                <p style=\"font-size: 14px; color: #64748b; margin-top: 20px;\">\n                  Cette invitation a √©t√© renvoy√©e et expire dans 7 jours. Si vous n'avez pas demand√© cette invitation, vous pouvez ignorer cet email.\n                </p>\n\n                <p style=\"font-size: 14px; color: #64748b;\">\n                  Ou copiez ce lien dans votre navigateur:<br>\n                  <a href=\"${inviteUrl}\" style=\"color: #3b82f6; word-break: break-all;\">${inviteUrl}</a>\n                </p>\n              </div>\n              <div class=\"footer\">\n                <p>¬© ${new Date().getFullYear()} Dousell Immo - Gestion Locative Intelligente</p>\n              </div>\n            </div>\n          </body>\n        </html>\n      `;\n\n      await sendEmail({\n        to: invitation.email,\n        subject: `Rappel - Invitation √† rejoindre ${team?.name || \"l'√©quipe\"} sur Dousell Immo`,\n        html: emailHtml,\n        fromName: \"Dousell Immo\",\n      });\n    } catch (emailError) {\n      console.error(\"Erreur envoi email rappel invitation:\", emailError);\n      // On ne bloque pas si l'email √©choue\n    }\n\n    // Audit log\n    await logTeamAudit(teamId, user.id, \"member.invitation_resent\", \"invitation\", invitationId, null, {\n      email: invitation.email,\n    });\n\n    revalidatePath(\"/gestion/equipe\");\n    return { success: true, message: \"Invitation renvoy√©e\" };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n/**\n * Annule une invitation\n */\nexport async function cancelInvitation(\n  teamId: string,\n  invitationId: string\n): Promise<TeamActionResult> {\n  try {\n    const { user, teamId: activeTeamId } = await requireTeamPermission(\"team.members.invite\");\n\n    if (activeTeamId !== teamId) {\n      return { success: false, error: \"Acc√®s non autoris√©\" };\n    }\n\n    const supabaseAdmin = createAdminClient();\n\n    const { error } = await supabaseAdmin\n      .from(\"team_invitations\")\n      .update({ status: \"cancelled\" })\n      .eq(\"id\", invitationId)\n      .eq(\"team_id\", teamId);\n\n    if (error) {\n      return { success: false, error: \"Erreur lors de l'annulation\" };\n    }\n\n    // Audit log\n    await logTeamAudit(teamId, user.id, \"member.invitation_cancelled\", \"invitation\", invitationId, null, null);\n\n    revalidatePath(\"/gestion/equipe\");\n    return { success: true, message: \"Invitation annul√©e\" };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n// =====================================================\n// ACCEPTATION D'INVITATION\n// =====================================================\n\nexport async function acceptInvitation(token: string): Promise<AcceptInvitationResult> {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return { success: false, error: \"Vous devez √™tre connect√© pour accepter l'invitation\" };\n  }\n\n  // Essayer via la fonction RPC (bypass RLS)\n  const { data: rpcResult, error: rpcError } = await supabase.rpc(\"accept_team_invitation\", {\n    p_token: token,\n  });\n\n  if (!rpcError && rpcResult?.success) {\n    revalidatePath(\"/gestion/equipe\");\n    revalidatePath(\"/gestion\");\n    return {\n      success: true,\n      teamId: rpcResult.team_id,\n      teamName: rpcResult.team_name,\n      role: rpcResult.role as TeamRole,\n    };\n  }\n\n  // Fallback: logique manuelle avec client Admin (bypass RLS)\n  const supabaseAdmin = createAdminClient();\n\n  const { data: invitation, error: invError } = await supabaseAdmin\n    .from(\"team_invitations\")\n    .select(\"*, team:teams(id, name)\")\n    .eq(\"token\", token)\n    .eq(\"status\", \"pending\")\n    .single();\n\n  if (invError || !invitation) {\n    return { success: false, error: \"Invitation invalide ou expir√©e\" };\n  }\n\n  // V√©rifier email\n  if (invitation.email.toLowerCase() !== user.email?.toLowerCase()) {\n    return { success: false, error: \"Cette invitation n'est pas destin√©e √† votre compte\" };\n  }\n\n  // V√©rifier expiration\n  if (new Date(invitation.expires_at) < new Date()) {\n    await supabaseAdmin.from(\"team_invitations\").update({ status: \"expired\" }).eq(\"id\", invitation.id);\n    return { success: false, error: \"Cette invitation a expir√©\" };\n  }\n\n  // V√©rifier si d√©j√† membre (et son statut)\n  // Ensure profile exists (fix for missing trigger or race condition)\n  const { data: profile } = await supabaseAdmin\n    .from(\"profiles\")\n    .select(\"id\")\n    .eq(\"id\", user.id)\n    .maybeSingle();\n\n  if (!profile) {\n    // Attempt to create profile if missing\n    const { error: createProfileError } = await supabaseAdmin\n      .from(\"profiles\")\n      .insert({\n        id: user.id,\n        email: user.email,\n        full_name: user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0],\n        avatar_url: user.user_metadata?.avatar_url || user.user_metadata?.picture,\n        updated_at: new Date().toISOString(),\n      });\n\n    if (createProfileError) {\n      console.error(\"Error creating missing profile:\", createProfileError);\n    }\n  }\n\n  // V√©rifier si d√©j√† membre (et son statut)\n  const { data: existingMember } = await supabaseAdmin\n    .from(\"team_members\")\n    .select(\"status\")\n    .eq(\"team_id\", invitation.team_id)\n    .eq(\"user_id\", user.id)\n    .maybeSingle();\n\n  if (existingMember) {\n    if (existingMember.status === 'active') {\n      // D√©j√† actif -> Succ√®s (Idempotence)\n      await supabaseAdmin.from(\"team_invitations\").update({ status: \"accepted\", accepted_at: new Date().toISOString() }).eq(\"id\", invitation.id);\n\n      // Activer l'√©quipe automatiquement\n      const { setActiveTeam } = await import(\"@/lib/team-switching\");\n      await setActiveTeam(invitation.team_id);\n\n      revalidatePath(\"/gestion/equipe\");\n\n      const team = invitation.team as unknown as { id: string; name: string };\n      return {\n        success: true,\n        teamId: team.id,\n        teamName: team.name,\n        role: invitation.role as TeamRole,\n      };\n    } else {\n      // Existe mais pas actif -> R√©activer\n      const { error: updateError } = await supabaseAdmin\n        .from(\"team_members\")\n        .update({\n          status: 'active',\n          role: invitation.role,\n          joined_at: new Date().toISOString(),\n          invited_by: invitation.invited_by\n        })\n        .eq(\"team_id\", invitation.team_id)\n        .eq(\"user_id\", user.id);\n\n      if (updateError) {\n        console.error(\"Erreur r√©activation membre:\", updateError);\n        return { success: false, error: \"Erreur lors de l'activation du membre\" };\n      }\n    }\n  } else {\n    // Nouveau membre -> Ins√©rer\n    const { error: memberError } = await supabaseAdmin.from(\"team_members\").insert({\n      team_id: invitation.team_id,\n      user_id: user.id,\n      role: invitation.role,\n      status: \"active\",\n      invited_by: invitation.invited_by,\n      joined_at: new Date().toISOString(),\n    });\n\n    if (memberError) {\n      console.error(\"Erreur ajout membre:\", memberError);\n      return { success: false, error: \"Erreur lors de l'adh√©sion √† l'√©quipe\" };\n    }\n  }\n\n  // Marquer invitation comme accept√©e avec admin client\n  await supabaseAdmin\n    .from(\"team_invitations\")\n    .update({ status: \"accepted\", accepted_at: new Date().toISOString() })\n    .eq(\"id\", invitation.id);\n\n  // Audit log\n  await logTeamAudit(invitation.team_id, user.id, \"member.joined\", \"member\", user.id, null, {\n    role: invitation.role,\n    via: \"invitation\",\n  });\n\n  // Activer l'√©quipe automatiquement\n  const { setActiveTeam } = await import(\"@/lib/team-switching\");\n  await setActiveTeam(invitation.team_id);\n\n  revalidatePath(\"/gestion/equipe\");\n  revalidatePath(\"/gestion\");\n\n  const team = invitation.team as unknown as { id: string; name: string };\n  return {\n    success: true,\n    teamId: team.id,\n    teamName: team.name,\n    role: invitation.role as TeamRole,\n  };\n}\n\n// =====================================================\n// CHANGEMENT DE R√îLE\n// =====================================================\n\nexport const changeMemberRole = safeAction(\n  \"changeMemberRole\",\n  changeRoleSchema,\n  async (data, { _userId }) => {\n    // Seul owner ou manager avec permission sp√©cifique peut changer les r√¥les\n    const { user, teamId: activeTeamId } = await requireTeamPermission(\"team.members.edit_role\");\n\n    if (activeTeamId !== data.teamId) {\n      throw new Error(\"Acc√®s non autoris√©\");\n    }\n\n    const supabaseAdmin = createAdminClient();\n\n    // R√©cup√©rer l'ancien r√¥le\n    const { data: member, error: fetchError } = await supabaseAdmin\n      .from(\"team_members\")\n      .select(\"role, user_id\")\n      .eq(\"id\", data.memberId)\n      .eq(\"team_id\", data.teamId)\n      .single();\n\n    if (fetchError || !member) {\n      throw new Error(\"Membre introuvable\");\n    }\n\n    // Emp√™cher la modification d'un owner\n    if (member.role === \"owner\") {\n      throw new Error(\"Impossible de modifier le r√¥le du propri√©taire\");\n    }\n\n    // Mettre √† jour\n    const { error } = await supabaseAdmin\n      .from(\"team_members\")\n      .update({ role: data.newRole, updated_at: new Date().toISOString() })\n      .eq(\"id\", data.memberId);\n\n    if (error) {\n      throw new Error(\"Erreur lors du changement de r√¥le\");\n    }\n\n    // Audit log\n    await logTeamAudit(\n      data.teamId,\n      user.id,\n      \"member.role_changed\",\n      \"member\",\n      data.memberId,\n      { role: member.role },\n      { role: data.newRole }\n    );\n\n    revalidatePath(\"/gestion/equipe\");\n    return { success: true, message: \"R√¥le mis √† jour\" };\n  }\n);\n\n/**\n * Supprime un membre de l'√©quipe\n */\nconst removeMemberSchema = z.object({\n  teamId: z.string().uuid(),\n  memberId: z.string().uuid()\n});\n\nexport const removeTeamMember = safeAction(\n  \"removeTeamMember\",\n  removeMemberSchema,\n  async (data, { _userId }) => {\n    const { teamId, memberId } = data;\n    const { user, teamId: activeTeamId } = await requireTeamPermission(\"team.members.remove\");\n\n    if (activeTeamId !== teamId) {\n      throw new Error(\"Acc√®s non autoris√©\");\n    }\n\n    const supabaseAdmin = createAdminClient();\n\n    // R√©cup√©rer le membre pour v√©rifier son r√¥le\n    const { data: member, error: fetchError } = await supabaseAdmin\n      .from(\"team_members\")\n      .select(\"role, user_id\")\n      .eq(\"id\", memberId)\n      .eq(\"team_id\", teamId)\n      .single();\n\n    if (fetchError || !member) {\n      throw new Error(\"Membre introuvable\");\n    }\n\n    if (member.role === \"owner\") {\n      throw new Error(\"Impossible de supprimer le propri√©taire\");\n    }\n\n    // Suppression (logique)\n    const { error } = await supabaseAdmin\n      .from(\"team_members\")\n      .update({ status: \"removed\", removed_at: new Date().toISOString() })\n      .eq(\"id\", memberId);\n\n    if (error) {\n      throw new Error(\"Erreur lors de la suppression\");\n    }\n\n    // Audit log\n    await logTeamAudit(teamId, user.id, \"member.removed\", \"member\", memberId, { role: member.role }, null);\n\n    revalidatePath(\"/gestion/equipe\");\n    return { success: true, message: \"Membre supprim√©\" };\n  }\n);\n\n/**\n * R√©cup√®re toutes les √©quipes dont l'utilisateur est membre\n */\nexport async function getUserTeams(): Promise<{\n  success: boolean;\n  teams?: Array<{\n    id: string;\n    name: string;\n    slug: string;\n    role: string;\n    is_active: boolean;\n  }>;\n  error?: string;\n}> {\n  try {\n    const supabase = await createClient();\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n      return { success: false, error: \"Non connect√©\" };\n    }\n\n    // Utiliser le client admin pour √©viter les probl√®mes de RLS\n    const supabaseAdmin = createAdminClient();\n\n    // R√©cup√©rer tous les memberships actifs\n    const { data: memberships, error } = await supabaseAdmin\n      .from(\"team_members\")\n      .select(`\n        team_id,\n        role,\n        team:teams(id, name, slug)\n      `)\n      .eq(\"user_id\", user.id)\n      .eq(\"status\", \"active\");\n\n    if (error) {\n      console.error(\"Erreur r√©cup√©ration √©quipes:\", error);\n      return { success: false, error: \"Erreur lors de la r√©cup√©ration des √©quipes\" };\n    }\n\n    if (!memberships || memberships.length === 0) {\n      return { success: true, teams: [] };\n    }\n\n    // R√©cup√©rer l'√©quipe active depuis le contexte\n    const { teamId: activeTeamId } = await getUserTeamContext();\n\n    const teams = memberships.map((m) => {\n      const team = m.team as unknown as { id: string; name: string; slug: string };\n      return {\n        id: team.id,\n        name: team.name,\n        slug: team.slug,\n        role: m.role,\n        is_active: team.id === activeTeamId,\n      };\n    });\n\n    return { success: true, teams };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n/**\n * Change l'√©quipe active pour l'utilisateur (stock√© en cookie/session)\n */\nexport async function switchActiveTeam(teamId: string): Promise<TeamActionResult> {\n  try {\n    const supabase = await createClient();\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n      return { success: false, error: \"Non connect√©\" };\n    }\n\n    // V√©rifier que l'utilisateur est bien membre de cette √©quipe\n    const supabaseAdmin = createAdminClient();\n    const { data: membership, error } = await supabaseAdmin\n      .from(\"team_members\")\n      .select(\"id, role\")\n      .eq(\"user_id\", user.id)\n      .eq(\"team_id\", teamId)\n      .eq(\"status\", \"active\")\n      .single();\n\n    if (error || !membership) {\n      return { success: false, error: \"Vous n'√™tes pas membre de cette √©quipe\" };\n    }\n\n    // ‚úÖ CORRECTION S√âCURIT√â: Persister l'√©quipe active dans un cookie s√©curis√©\n    // Cela permet au syst√®me de savoir quelle √©quipe afficher lors des prochaines requ√™tes\n    const { setActiveTeam } = await import(\"@/lib/team-switching\");\n    await setActiveTeam(teamId);\n\n    // Audit log\n    await logTeamAudit(teamId, user.id, \"team.switched\", \"team\", teamId, null, {\n      from: \"previous_team\",\n      to: teamId,\n    });\n\n    // Revalider les chemins pour forcer le refresh des donn√©es\n    revalidatePath(\"/gestion\");\n    revalidatePath(\"/gestion/equipe\");\n    revalidatePath(\"/gestion/biens\");\n\n    return { success: true, message: \"√âquipe chang√©e avec succ√®s\" };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n\n/**\n * Permet √† un utilisateur de quitter l'√©quipe\n */\nexport async function leaveTeam(teamId: string): Promise<TeamActionResult> {\n  try {\n    const { user, role } = await getUserTeamContext();\n\n    if (role === \"owner\") {\n      return { success: false, error: \"Le propri√©taire ne peut pas quitter l'√©quipe directement. Vous devez d'abord transf√©rer la propri√©t√© ou supprimer l'√©quipe.\" };\n    }\n\n    const supabaseAdmin = createAdminClient();\n\n    const { error } = await supabaseAdmin\n      .from(\"team_members\")\n      .update({ status: \"left\", left_at: new Date().toISOString() })\n      .eq(\"team_id\", teamId)\n      .eq(\"user_id\", user.id);\n\n    if (error) {\n      return { success: false, error: \"Erreur lors du d√©part de l'√©quipe\" };\n    }\n\n    // Audit log\n    await logTeamAudit(teamId, user.id, \"member.left\", \"member\", user.id, null, null);\n\n    revalidatePath(\"/gestion/equipe\");\n    revalidatePath(\"/gestion\");\n\n    return { success: true, message: \"Vous avez quitt√© l'√©quipe\" };\n  } catch (err: any) {\n    return { success: false, error: err.message };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\audit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\AccessControlTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":111,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3834,3837],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3834,3837],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":112,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3907,3910],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3907,3910],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":113,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3976,3979],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3976,3979],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":118,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4170,4173],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4170,4173],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":161,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5722,5725],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5722,5725],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":174,"column":6,"nodeType":"ArrayExpression","endLine":174,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [loadData, teamId]","fix":{"range":[6014,6022],"text":"[loadData, teamId]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":346,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":346,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12620,12623],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12620,12623],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":372,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":372,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13415,13418],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13415,13418],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":492,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":492,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17816,17819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17816,17819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":514,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":514,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18581,18584],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18581,18584],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":580,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":580,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20874,20877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20874,20877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\n/**\n * AccessControlTab - Onglet de gestion des acc√®s temporaires\n *\n * Affiche dans la page √âquipe:\n * - Demandes d'acc√®s en attente\n * - Permissions temporaires actives\n * - Historique des demandes\n */\n\nimport { useEffect, useState } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { cn } from \"@/lib/utils\";\nimport { useTheme } from \"@/components/theme-provider\";\nimport {\n  Clock,\n  CheckCircle,\n  XCircle,\n  _AlertTriangle,\n  KeyRound,\n  Calendar,\n  User,\n  Loader2,\n  Trash2,\n  Home,\n  FileText,\n  Wallet,\n  Wrench,\n  Users,\n  FolderOpen,\n  ClipboardList,\n  Filter,\n} from \"lucide-react\";\nimport { formatDistance } from \"date-fns\";\nimport { fr } from \"date-fns/locale\";\nimport {\n  getAccessRequestsAction,\n  getTemporaryPermissionsAction,\n  reviewAccessRequestAction,\n  revokeTemporaryPermissionAction,\n} from \"@/app/(workspace)/gestion/access-control/actions\";\nimport { toast } from \"sonner\";\n\ninterface AccessControlTabProps {\n  teamId: string;\n}\n\n// Cat√©gories de permissions\nconst PERMISSION_CATEGORIES = [\n  { id: \"all\", label: \"Toutes\", icon: Filter, color: \"text-slate-400\", badgeBg: \"bg-amber-500\" },\n  { id: \"properties\", label: \"Biens\", icon: Home, color: \"text-blue-500\", badgeBg: \"bg-blue-500\" },\n  { id: \"leases\", label: \"Baux\", icon: FileText, color: \"text-purple-500\", badgeBg: \"bg-purple-500\" },\n  { id: \"tenants\", label: \"Locataires\", icon: Users, color: \"text-green-500\", badgeBg: \"bg-green-500\" },\n  { id: \"payments\", label: \"Paiements\", icon: Wallet, color: \"text-amber-500\", badgeBg: \"bg-amber-500\" },\n  { id: \"expenses\", label: \"D√©penses\", icon: Wallet, color: \"text-red-500\", badgeBg: \"bg-red-500\" },\n  { id: \"maintenance\", label: \"Maintenance\", icon: Wrench, color: \"text-orange-500\", badgeBg: \"bg-orange-500\" },\n  { id: \"documents\", label: \"Documents\", icon: FolderOpen, color: \"text-cyan-500\", badgeBg: \"bg-cyan-500\" },\n  { id: \"inventory\", label: \"√âtats lieux\", icon: ClipboardList, color: \"text-indigo-500\", badgeBg: \"bg-indigo-500\" },\n  { id: \"team\", label: \"√âquipe\", icon: Users, color: \"text-pink-500\", badgeBg: \"bg-pink-500\" },\n];\n\n// Labels des permissions pour affichage\nconst PERMISSION_LABELS: Record<string, string> = {\n  \"leases.view\": \"Voir baux\",\n  \"leases.create\": \"Cr√©er baux\",\n  \"leases.edit\": \"√âditer baux\",\n  \"leases.delete\": \"Supprimer baux\",\n  \"tenants.view\": \"Voir locataires\",\n  \"tenants.edit\": \"√âditer locataires\",\n  \"payments.view\": \"Voir paiements\",\n  \"payments.confirm\": \"Confirmer paiements\",\n  \"expenses.view\": \"Voir d√©penses\",\n  \"expenses.create\": \"Cr√©er d√©penses\",\n  \"maintenance.view\": \"Voir maintenance\",\n  \"maintenance.create\": \"Cr√©er maintenance\",\n  \"documents.view\": \"Voir documents\",\n  \"documents.generate\": \"G√©n√©rer documents\",\n  \"properties.view\": \"Voir biens\",\n  \"properties.create\": \"Cr√©er biens\",\n  \"properties.edit\": \"√âditer biens\",\n  \"inventory.view\": \"Voir √©tats des lieux\",\n  \"inventory.create\": \"Cr√©er √©tats des lieux\",\n  \"team.members.view\": \"Voir membres\",\n  \"team.members.invite\": \"Inviter membres\",\n  \"team.settings.view\": \"Voir param√®tres\",\n};\n\nfunction getPermissionLabel(permission: string): string {\n  return PERMISSION_LABELS[permission] || permission;\n}\n\nfunction getPermissionCategory(permission: string): string {\n  const prefix = permission.split(\".\")[0];\n  return prefix || \"all\";\n}\n\nexport function AccessControlTab({ teamId }: AccessControlTabProps) {\n  const { isDark } = useTheme();\n  const [pendingRequests, setPendingRequests] = useState<any[]>([]);\n  const [activePermissions, setActivePermissions] = useState<any[]>([]);\n  const [historyRequests, setHistoryRequests] = useState<any[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedCategory, setSelectedCategory] = useState(\"all\");\n\n  // Filtrer par cat√©gorie\n  const filterByCategory = (items: any[], field: string = \"requested_permission\") => {\n    if (selectedCategory === \"all\") return items;\n    return items.filter(item => {\n      const permission = item[field] || item.permission;\n      return getPermissionCategory(permission) === selectedCategory;\n    });\n  };\n\n  const filteredPendingRequests = filterByCategory(pendingRequests);\n  const filteredActivePermissions = filterByCategory(activePermissions, \"permission\");\n  const filteredHistoryRequests = filterByCategory(historyRequests);\n\n  // Compter les demandes en attente par cat√©gorie\n  const getCategoryCount = (categoryId: string) => {\n    if (categoryId === \"all\") {\n      return pendingRequests.length;\n    }\n    return pendingRequests.filter(req =>\n      getPermissionCategory(req.requested_permission) === categoryId\n    ).length;\n  };\n\n  const loadData = async () => {\n    setIsLoading(true);\n\n    try {\n      // Charger les demandes en attente\n      const pendingResult = await getAccessRequestsAction(teamId, \"pending\");\n      if (pendingResult.success) {\n        setPendingRequests(pendingResult.data || []);\n      }\n\n      // Charger les permissions actives\n      const activeResult = await getTemporaryPermissionsAction(teamId);\n      if (activeResult.success) {\n        setActivePermissions(activeResult.data || []);\n      }\n\n      // Charger l'historique (approved + rejected)\n      const historyResult = await getAccessRequestsAction(teamId);\n      if (historyResult.success) {\n        setHistoryRequests(\n          (historyResult.data || [])\n            .filter((req: any) => req.status !== \"pending\")\n            .slice(0, 10) // Limiter √† 10 derniers\n        );\n      }\n    } catch (error) {\n      console.error(\"[AccessControlTab] Error loading data:\", error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    loadData();\n  }, [teamId]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className={cn(\n        \"flex items-center gap-2 p-2 md:p-3 rounded-xl overflow-x-auto scrollbar-none touch-pan-x\",\n        isDark ? \"bg-slate-900/50 border border-slate-800\" : \"bg-slate-50 border border-slate-200\"\n      )}>\n        {PERMISSION_CATEGORIES.map((cat) => {\n          const Icon = cat.icon;\n          const isActive = selectedCategory === cat.id;\n          const count = getCategoryCount(cat.id);\n          const hasItems = count > 0;\n          return (\n            <Button\n              key={cat.id}\n              variant={isActive ? \"default\" : \"ghost\"}\n              size=\"sm\"\n              onClick={() => setSelectedCategory(cat.id)}\n              className={cn(\n                \"shrink-0 gap-1.5 md:gap-2 transition-all relative py-1 md:py-2\",\n                isActive\n                  ? \"bg-primary text-primary-foreground shadow-md\"\n                  : isDark\n                    ? \"text-slate-400 hover:text-white hover:bg-slate-800\"\n                    : \"text-slate-600 hover:text-slate-900 hover:bg-slate-100\"\n              )}\n            >\n              <Icon className={cn(\"h-3.5 w-3.5 md:h-4 md:w-4\", !isActive && cat.color)} />\n              <span className=\"text-xs md:text-sm\">{cat.label}</span>\n              {hasItems && (\n                <span className={cn(\n                  \"absolute -top-1 -right-1 min-w-[16px] md:min-w-[18px] h-[16px] md:h-[18px] flex items-center justify-center text-[8px] md:text-[10px] font-bold rounded-full border-2\",\n                  isActive\n                    ? \"bg-red-500 text-white border-white dark:border-slate-900\"\n                    : cn(cat.badgeBg, \"text-white border-white dark:border-slate-950\")\n                )}>\n                  {count}\n                </span>\n              )}\n            </Button>\n          );\n        })}\n      </div>\n\n      {/* Section: Demandes en attente */}\n      <Card className={cn(\n        isDark ? \"bg-slate-900/50 border-slate-800\" : \"bg-white border-slate-200\"\n      )}>\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <Clock className=\"h-5 w-5 text-amber-500\" />\n              <CardTitle className=\"text-lg\">Demandes en attente</CardTitle>\n            </div>\n            {filteredPendingRequests.length > 0 && (\n              <Badge variant=\"secondary\" className=\"bg-amber-500/10 text-amber-500 border-amber-500/20\">\n                {filteredPendingRequests.length} √† traiter\n              </Badge>\n            )}\n          </div>\n          <CardDescription>\n            Demandes d&apos;acc√®s temporaire de vos membres\n            {selectedCategory !== \"all\" && (\n              <span className=\"ml-1 text-primary\">\n                ‚Ä¢ Cat√©gorie: {PERMISSION_CATEGORIES.find(c => c.id === selectedCategory)?.label}\n              </span>\n            )}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {filteredPendingRequests.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <CheckCircle className=\"h-10 w-10 mx-auto mb-3 text-green-500/50\" />\n              <p>{selectedCategory === \"all\" ? \"Aucune demande en attente\" : \"Aucune demande dans cette cat√©gorie\"}</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {filteredPendingRequests.map((request) => (\n                <PendingRequestCard\n                  key={request.id}\n                  request={request}\n                  onReview={loadData}\n                  isDark={isDark}\n                />\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Section: Permissions actives */}\n      <Card className={cn(\n        isDark ? \"bg-slate-900/50 border-slate-800\" : \"bg-white border-slate-200\"\n      )}>\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <KeyRound className=\"h-5 w-5 text-green-500\" />\n              <CardTitle className=\"text-lg\">Permissions temporaires actives</CardTitle>\n            </div>\n            {filteredActivePermissions.length > 0 && (\n              <Badge variant=\"secondary\" className=\"bg-green-500/10 text-green-500 border-green-500/20\">\n                {filteredActivePermissions.length} active{filteredActivePermissions.length > 1 ? \"s\" : \"\"}\n              </Badge>\n            )}\n          </div>\n          <CardDescription>\n            Acc√®s temporaires accord√©s √† vos membres\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {filteredActivePermissions.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <KeyRound className=\"h-10 w-10 mx-auto mb-3 opacity-30\" />\n              <p>{selectedCategory === \"all\" ? \"Aucune permission temporaire active\" : \"Aucune permission dans cette cat√©gorie\"}</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {filteredActivePermissions.map((perm) => (\n                <ActivePermissionCard\n                  key={perm.id}\n                  permission={perm}\n                  onRevoke={loadData}\n                  isDark={isDark}\n                />\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Section: Historique (compact) */}\n      {filteredHistoryRequests.length > 0 && (\n        <Card className={cn(\n          isDark ? \"bg-slate-900/50 border-slate-800\" : \"bg-white border-slate-200\"\n        )}>\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center gap-2\">\n              <Calendar className=\"h-5 w-5 text-muted-foreground\" />\n              <CardTitle className=\"text-lg\">Historique r√©cent</CardTitle>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {filteredHistoryRequests.map((request) => (\n                <HistoryRequestRow key={request.id} request={request} isDark={isDark} />\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\n/**\n * Carte pour une demande en attente\n */\nfunction PendingRequestCard({\n  request,\n  onReview,\n  isDark,\n}: {\n  request: any;\n  onReview: () => void;\n  isDark: boolean;\n}) {\n  const [isReviewing, setIsReviewing] = useState(false);\n  const [reviewNotes, setReviewNotes] = useState(\"\");\n  const [durationHours, setDurationHours] = useState(\"24\");\n  const [showDetails, setShowDetails] = useState(false);\n\n  const handleReview = async (action: 'approve' | 'reject') => {\n    setIsReviewing(true);\n\n    try {\n      const result = await reviewAccessRequestAction({\n        requestId: request.id,\n        action,\n        reviewNotes,\n        durationHours: action === 'approve' ? Number(durationHours) : undefined,\n      });\n\n      if (result.success) {\n        toast.success(result.message);\n        onReview();\n      } else {\n        toast.error(result.error || \"Erreur lors du traitement\");\n      }\n    } catch (error: any) {\n      toast.error(error.message || \"Erreur lors du traitement de la demande\");\n    } finally {\n      setIsReviewing(false);\n    }\n  };\n\n  return (\n    <div className={cn(\n      \"rounded-lg border p-4\",\n      isDark ? \"bg-slate-800/50 border-slate-700\" : \"bg-slate-50 border-slate-200\"\n    )}>\n      <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n        <div className=\"flex items-start gap-3 flex-1 min-w-0\">\n          <div className=\"p-2 rounded-full bg-amber-500/10 shrink-0\">\n            <User className=\"h-4 w-4 text-amber-500\" />\n          </div>\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"font-semibold text-sm md:text-base truncate\">\n              {request.requester?.full_name || request.requester?.email}\n            </p>\n            <div className=\"flex flex-wrap items-center gap-2 mt-1\">\n              <Badge variant=\"outline\" className=\"text-[10px] md:text-xs py-0 h-5 px-2 bg-background/50\">\n                {getPermissionLabel(request.requested_permission)}\n              </Badge>\n              <span className=\"text-[10px] md:text-xs text-muted-foreground whitespace-nowrap\">\n                {formatDistance(new Date(request.requested_at), new Date(), {\n                  addSuffix: true,\n                  locale: fr,\n                })}\n              </span>\n            </div>\n            {request.reason && (\n              <p className=\"text-xs md:text-sm text-muted-foreground mt-2 italic line-clamp-2 md:line-clamp-none\">\n                &quot;{request.reason}&quot;\n              </p>\n            )}\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 shrink-0 w-full sm:w-auto justify-end sm:justify-start\">\n          <Button\n            size=\"sm\"\n            variant=\"outline\"\n            onClick={() => setShowDetails(!showDetails)}\n            className=\"text-[10px] h-8 md:h-9 px-3 md:text-xs bg-background/50\"\n          >\n            {showDetails ? \"Masquer\" : \"D√©tails\"}\n          </Button>\n          <Button\n            size=\"sm\"\n            variant=\"ghost\"\n            className=\"text-red-500 hover:bg-red-500/10 h-8 w-8 md:h-9 md:w-9 p-0 bg-background/50\"\n            onClick={() => handleReview('reject')}\n            disabled={isReviewing}\n            title=\"Refuser\"\n          >\n            <XCircle className=\"h-4 w-4 md:h-5 md:w-5\" />\n          </Button>\n          <Button\n            size=\"sm\"\n            className=\"bg-green-600 hover:bg-green-700 text-white h-8 w-8 md:h-9 md:w-9 p-0 shadow-sm\"\n            onClick={() => handleReview('approve')}\n            disabled={isReviewing}\n            title=\"Approuver\"\n          >\n            {isReviewing ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <CheckCircle className=\"h-4 w-4 md:h-5 md:w-5\" />\n            )}\n          </Button>\n        </div>\n      </div>\n\n      {/* Options d√©taill√©es */}\n      {showDetails && (\n        <div className={cn(\n          \"mt-4 pt-4 border-t grid grid-cols-1 md:grid-cols-2 gap-4\",\n          isDark ? \"border-slate-700\" : \"border-slate-200\"\n        )}>\n          <div>\n            <Label className=\"text-xs text-muted-foreground\">Dur√©e de l&apos;acc√®s</Label>\n            <Select value={durationHours} onValueChange={setDurationHours}>\n              <SelectTrigger className=\"mt-1\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"1\">1 heure</SelectItem>\n                <SelectItem value=\"4\">4 heures</SelectItem>\n                <SelectItem value=\"8\">8 heures</SelectItem>\n                <SelectItem value=\"24\">24 heures</SelectItem>\n                <SelectItem value=\"48\">48 heures</SelectItem>\n                <SelectItem value=\"168\">1 semaine</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          <div>\n            <Label className=\"text-xs text-muted-foreground\">Note (optionnel)</Label>\n            <Textarea\n              value={reviewNotes}\n              onChange={(e) => setReviewNotes(e.target.value)}\n              placeholder=\"Ajouter une note...\"\n              className=\"mt-1 min-h-[60px]\"\n            />\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n/**\n * Carte pour une permission active\n */\nfunction ActivePermissionCard({\n  permission,\n  onRevoke,\n  isDark,\n}: {\n  permission: any;\n  onRevoke: () => void;\n  isDark: boolean;\n}) {\n  const [isRevoking, setIsRevoking] = useState(false);\n  const expiresAt = new Date(permission.expires_at);\n  const now = new Date();\n  const hoursRemaining = Math.max(0, Math.ceil((expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60)));\n  const isExpiringSoon = hoursRemaining <= 2;\n\n  const handleRevoke = async () => {\n    if (!confirm(\"R√©voquer cette permission imm√©diatement?\")) return;\n\n    setIsRevoking(true);\n    try {\n      const result = await revokeTemporaryPermissionAction(permission.id);\n      if (result.success) {\n        toast.success(\"Permission r√©voqu√©e\");\n        onRevoke();\n      } else {\n        toast.error(result.error || \"Erreur lors de la r√©vocation\");\n      }\n    } catch (error: any) {\n      toast.error(error.message || \"Erreur lors de la r√©vocation\");\n    } finally {\n      setIsRevoking(false);\n    }\n  };\n\n  return (\n    <div className={cn(\n      \"rounded-lg border p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4\",\n      isExpiringSoon\n        ? isDark ? \"bg-red-500/10 border-red-500/30\" : \"bg-red-50 border-red-200\"\n        : isDark ? \"bg-slate-800/50 border-slate-700\" : \"bg-slate-50 border-slate-200\"\n    )}>\n      <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n        <div className={cn(\n          \"p-2 rounded-full shrink-0\",\n          isExpiringSoon ? \"bg-red-500/20\" : \"bg-green-500/10\"\n        )}>\n          <KeyRound className={cn(\n            \"h-4 w-4\",\n            isExpiringSoon ? \"text-red-500\" : \"text-green-500\"\n          )} />\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <p className=\"font-semibold text-sm md:text-base truncate\">\n            {permission.user?.full_name || permission.user?.email}\n          </p>\n          <div className=\"flex flex-wrap items-center gap-2 mt-0.5\">\n            <Badge variant=\"secondary\" className=\"text-[10px] md:text-xs\">\n              {getPermissionLabel(permission.permission)}\n            </Badge>\n            <span className={cn(\n              \"text-[10px] md:text-xs flex items-center gap-1 whitespace-nowrap\",\n              isExpiringSoon ? \"text-red-500 font-medium\" : \"text-muted-foreground\"\n            )}>\n              <Clock className=\"h-3 w-3\" />\n              {hoursRemaining}h restante{hoursRemaining > 1 ? \"s\" : \"\"}\n            </span>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex items-center justify-end w-full sm:w-auto\">\n        <Button\n          size=\"sm\"\n          variant=\"ghost\"\n          className=\"text-red-500 hover:bg-red-500/10 shrink-0 h-8 w-8 md:h-9 md:w-9 p-0 bg-background/50\"\n          onClick={handleRevoke}\n          disabled={isRevoking}\n          title=\"R√©voquer\"\n        >\n          {isRevoking ? (\n            <Loader2 className=\"h-4 w-4 animate-spin\" />\n          ) : (\n            <Trash2 className=\"h-4 w-4 md:h-5 md:w-5\" />\n          )}\n        </Button>\n      </div>\n    </div>\n  );\n}\n\n/**\n * Ligne compacte pour l'historique\n */\nfunction HistoryRequestRow({ request, isDark }: { request: any; isDark: boolean }) {\n  const isApproved = request.status === 'approved';\n\n  return (\n    <div className={cn(\n      \"flex items-center justify-between py-2 px-3 rounded-lg\",\n      isDark ? \"bg-slate-800/30\" : \"bg-slate-50\"\n    )}>\n      <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n        {isApproved ? (\n          <CheckCircle className=\"h-4 w-4 text-green-500 shrink-0\" />\n        ) : (\n          <XCircle className=\"h-4 w-4 text-red-500 shrink-0\" />\n        )}\n        <span className=\"text-sm truncate\">\n          {request.requester?.full_name || request.requester?.email}\n        </span>\n        <Badge variant=\"outline\" className=\"text-xs shrink-0\">\n          {getPermissionLabel(request.requested_permission)}\n        </Badge>\n      </div>\n      <span className=\"text-xs text-muted-foreground shrink-0 ml-2\">\n        {formatDistance(new Date(request.reviewed_at || request.requested_at), new Date(), {\n          addSuffix: true,\n          locale: fr,\n        })}\n      </span>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\ChangeRoleDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\CreateTeamPrompt.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\CreateTeamPrompt.tsx:56:7\n  54 |   useEffect(() => {\n  55 |     if (profileData) {\n> 56 |       setFormData({\n     |       ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  57 |         name: profileData.company_name || \"\",\n  58 |         description: \"\",\n  59 |         company_address: profileData.company_address || \"\",","line":56,"column":7,"nodeType":null,"endLine":56,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Building2, Users, Loader2, ArrowRight, Sparkles, CheckCircle2 } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogDescription,\r\n} from \"@/components/ui/dialog\";\r\nimport { createTeam } from \"../actions\";\r\nimport { toast } from \"sonner\";\r\nimport { useTheme } from \"@/components/theme-provider\";\r\n\r\ninterface ProfileData {\r\n  company_name: string | null;\r\n  company_address: string | null;\r\n  company_phone: string | null;\r\n  company_email: string | null;\r\n  company_ninea: string | null;\r\n  full_name: string | null;\r\n  email: string | null;\r\n}\r\n\r\ninterface CreateTeamPromptProps {\r\n  profileData?: ProfileData | null;\r\n}\r\n\r\nexport function CreateTeamPrompt({ profileData }: CreateTeamPromptProps) {\r\n  const router = useRouter();\r\n  const { isDark } = useTheme();\r\n  const [showForm, setShowForm] = useState(false);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // D√©terminer si l'utilisateur a d√©j√† configur√© son agence\r\n  const hasExistingAgency = Boolean(profileData?.company_name);\r\n\r\n  // Pr√©-remplir avec les donn√©es du profil si disponibles\r\n  const [formData, setFormData] = useState({\r\n    name: \"\",\r\n    description: \"\",\r\n    company_address: \"\",\r\n    company_phone: \"\",\r\n    company_email: \"\",\r\n    company_ninea: \"\",\r\n  });\r\n\r\n  // Pr√©-remplir quand profileData est disponible\r\n  useEffect(() => {\r\n    if (profileData) {\r\n      setFormData({\r\n        name: profileData.company_name || \"\",\r\n        description: \"\",\r\n        company_address: profileData.company_address || \"\",\r\n        company_phone: profileData.company_phone || \"\",\r\n        company_email: profileData.company_email || profileData.email || \"\",\r\n        company_ninea: profileData.company_ninea || \"\",\r\n      });\r\n    }\r\n  }, [profileData]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n\r\n    const result = await createTeam(formData);\r\n\r\n    setLoading(false);\r\n\r\n    if (result.success) {\r\n      toast.success(\"√âquipe cr√©√©e avec succ√®s !\");\r\n      router.refresh();\r\n    } else {\r\n      toast.error(result.error || \"Erreur lors de la cr√©ation\");\r\n    }\r\n  };\r\n\r\n  const handleContinueSolo = () => {\r\n    router.push(\"/gestion\");\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-[60vh] flex items-center justify-center p-4\">\r\n      <div className=\"max-w-2xl w-full\">\r\n        {/* Header */}\r\n        <div className=\"text-center mb-8\">\r\n          <div\r\n            className={cn(\r\n              \"inline-flex items-center justify-center w-20 h-20 rounded-2xl mb-6\",\r\n              isDark ? \"bg-slate-800\" : \"bg-gray-100\"\r\n            )}\r\n          >\r\n            <Users className=\"w-10 h-10 text-[#F4C430]\" />\r\n          </div>\r\n          <h1\r\n            className={cn(\r\n              \"text-3xl font-bold mb-3\",\r\n              isDark ? \"text-white\" : \"text-gray-900\"\r\n            )}\r\n          >\r\n            Gestion d&apos;√©quipe\r\n          </h1>\r\n          <p className={cn(\"text-lg\", isDark ? \"text-slate-400\" : \"text-gray-600\")}>\r\n            Collaborez avec votre √©quipe pour g√©rer vos biens locatifs\r\n          </p>\r\n        </div>\r\n\r\n        {/* Message si agence d√©j√† configur√©e */}\r\n        {hasExistingAgency && (\r\n          <div\r\n            className={cn(\r\n              \"mb-6 p-4 rounded-xl border flex items-start gap-3\",\r\n              isDark\r\n                ? \"bg-green-500/10 border-green-500/20\"\r\n                : \"bg-green-50 border-green-200\"\r\n            )}\r\n          >\r\n            <CheckCircle2 className=\"w-5 h-5 text-green-500 mt-0.5 shrink-0\" />\r\n            <div>\r\n              <p className={cn(\"font-medium\", isDark ? \"text-green-400\" : \"text-green-700\")}>\r\n                Agence d√©j√† configur√©e : {profileData?.company_name}\r\n              </p>\r\n              <p className={cn(\"text-sm mt-1\", isDark ? \"text-slate-400\" : \"text-gray-600\")}>\r\n                Vos informations seront automatiquement utilis√©es pour cr√©er votre √©quipe.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Options */}\r\n        <div className=\"grid md:grid-cols-2 gap-4\">\r\n          {/* Option 1: Cr√©er une √©quipe */}\r\n          <button\r\n            onClick={() => setShowForm(true)}\r\n            className={cn(\r\n              \"group relative p-6 rounded-2xl border-2 text-left transition-all duration-200\",\r\n              \"hover:border-[#F4C430] hover:shadow-lg hover:shadow-[#F4C430]/10\",\r\n              isDark\r\n                ? \"bg-slate-900 border-slate-700\"\r\n                : \"bg-white border-gray-200\"\r\n            )}\r\n          >\r\n            <div className=\"flex items-start gap-4\">\r\n              <div\r\n                className={cn(\r\n                  \"p-3 rounded-xl\",\r\n                  isDark ? \"bg-slate-800\" : \"bg-gray-100\",\r\n                  \"group-hover:bg-[#F4C430]/10\"\r\n                )}\r\n              >\r\n                <Building2\r\n                  className={cn(\r\n                    \"w-6 h-6\",\r\n                    isDark ? \"text-slate-400\" : \"text-gray-500\",\r\n                    \"group-hover:text-[#F4C430]\"\r\n                  )}\r\n                />\r\n              </div>\r\n              <div className=\"flex-1\">\r\n                <h3\r\n                  className={cn(\r\n                    \"font-semibold text-lg mb-1\",\r\n                    isDark ? \"text-white\" : \"text-gray-900\"\r\n                  )}\r\n                >\r\n                  {hasExistingAgency ? \"Activer le mode √©quipe\" : \"Cr√©er une √©quipe\"}\r\n                </h3>\r\n                <p\r\n                  className={cn(\r\n                    \"text-sm mb-3\",\r\n                    isDark ? \"text-slate-400\" : \"text-gray-500\"\r\n                  )}\r\n                >\r\n                  {hasExistingAgency\r\n                    ? \"Transformez votre agence en √©quipe et invitez des collaborateurs\"\r\n                    : \"Invitez des collaborateurs et attribuez-leur des r√¥les sp√©cifiques\"}\r\n                </p>\r\n                <div className=\"flex items-center gap-2 text-[#F4C430] text-sm font-medium\">\r\n                  <Sparkles className=\"w-4 h-4\" />\r\n                  <span>Recommand√©</span>\r\n                </div>\r\n              </div>\r\n              <ArrowRight\r\n                className={cn(\r\n                  \"w-5 h-5 opacity-0 group-hover:opacity-100 transition-opacity\",\r\n                  isDark ? \"text-slate-400\" : \"text-gray-400\"\r\n                )}\r\n              />\r\n            </div>\r\n          </button>\r\n\r\n          {/* Option 2: Continuer seul */}\r\n          <button\r\n            onClick={handleContinueSolo}\r\n            className={cn(\r\n              \"group relative p-6 rounded-2xl border-2 text-left transition-all duration-200\",\r\n              \"hover:border-slate-500\",\r\n              isDark\r\n                ? \"bg-slate-900 border-slate-700\"\r\n                : \"bg-white border-gray-200\"\r\n            )}\r\n          >\r\n            <div className=\"flex items-start gap-4\">\r\n              <div\r\n                className={cn(\r\n                  \"p-3 rounded-xl\",\r\n                  isDark ? \"bg-slate-800\" : \"bg-gray-100\"\r\n                )}\r\n              >\r\n                <Users\r\n                  className={cn(\r\n                    \"w-6 h-6\",\r\n                    isDark ? \"text-slate-400\" : \"text-gray-500\"\r\n                  )}\r\n                />\r\n              </div>\r\n              <div className=\"flex-1\">\r\n                <h3\r\n                  className={cn(\r\n                    \"font-semibold text-lg mb-1\",\r\n                    isDark ? \"text-white\" : \"text-gray-900\"\r\n                  )}\r\n                >\r\n                  Continuer seul\r\n                </h3>\r\n                <p\r\n                  className={cn(\r\n                    \"text-sm\",\r\n                    isDark ? \"text-slate-400\" : \"text-gray-500\"\r\n                  )}\r\n                >\r\n                  G√©rez vos biens en solo. Vous pourrez cr√©er une √©quipe plus\r\n                  tard.\r\n                </p>\r\n              </div>\r\n              <ArrowRight\r\n                className={cn(\r\n                  \"w-5 h-5 opacity-0 group-hover:opacity-100 transition-opacity\",\r\n                  isDark ? \"text-slate-400\" : \"text-gray-400\"\r\n                )}\r\n              />\r\n            </div>\r\n          </button>\r\n        </div>\r\n\r\n        {/* Modal de cr√©ation */}\r\n        <Dialog open={showForm} onOpenChange={setShowForm}>\r\n          <DialogContent\r\n            className={cn(\r\n              \"sm:max-w-lg\",\r\n              isDark ? \"bg-slate-900 border-slate-700\" : \"bg-white\"\r\n            )}\r\n          >\r\n            <DialogHeader>\r\n              <DialogTitle\r\n                className={cn(isDark ? \"text-white\" : \"text-gray-900\")}\r\n              >\r\n                {hasExistingAgency ? \"Activer le mode √©quipe\" : \"Cr√©er votre √©quipe\"}\r\n              </DialogTitle>\r\n              <DialogDescription>\r\n                {hasExistingAgency\r\n                  ? \"V√©rifiez les informations pr√©-remplies depuis votre configuration\"\r\n                  : \"Renseignez les informations de votre √©quipe ou agence\"}\r\n              </DialogDescription>\r\n            </DialogHeader>\r\n\r\n            <form onSubmit={handleSubmit} className=\"space-y-4 mt-4\">\r\n              <div>\r\n                <label\r\n                  className={cn(\r\n                    \"text-sm font-medium mb-1.5 block\",\r\n                    isDark ? \"text-slate-300\" : \"text-gray-700\"\r\n                  )}\r\n                >\r\n                  Nom de l&apos;√©quipe <span className=\"text-red-400\">*</span>\r\n                </label>\r\n                <Input\r\n                  value={formData.name}\r\n                  onChange={(e) =>\r\n                    setFormData((prev) => ({ ...prev, name: e.target.value }))\r\n                  }\r\n                  placeholder=\"Ex: Baraka Immobilier\"\r\n                  required\r\n                  className={cn(\r\n                    isDark && \"bg-slate-800 border-slate-700 text-white\"\r\n                  )}\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label\r\n                  className={cn(\r\n                    \"text-sm font-medium mb-1.5 block\",\r\n                    isDark ? \"text-slate-300\" : \"text-gray-700\"\r\n                  )}\r\n                >\r\n                  Description\r\n                </label>\r\n                <Textarea\r\n                  value={formData.description}\r\n                  onChange={(e) =>\r\n                    setFormData((prev) => ({\r\n                      ...prev,\r\n                      description: e.target.value,\r\n                    }))\r\n                  }\r\n                  placeholder=\"D√©crivez bri√®vement votre √©quipe...\"\r\n                  rows={3}\r\n                  className={cn(\r\n                    isDark && \"bg-slate-800 border-slate-700 text-white\"\r\n                  )}\r\n                />\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div>\r\n                  <label\r\n                    className={cn(\r\n                      \"text-sm font-medium mb-1.5 block\",\r\n                      isDark ? \"text-slate-300\" : \"text-gray-700\"\r\n                    )}\r\n                  >\r\n                    T√©l√©phone\r\n                  </label>\r\n                  <Input\r\n                    value={formData.company_phone}\r\n                    onChange={(e) =>\r\n                      setFormData((prev) => ({\r\n                        ...prev,\r\n                        company_phone: e.target.value,\r\n                      }))\r\n                    }\r\n                    placeholder=\"+221 77 123 45 67\"\r\n                    className={cn(\r\n                      isDark && \"bg-slate-800 border-slate-700 text-white\"\r\n                    )}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label\r\n                    className={cn(\r\n                      \"text-sm font-medium mb-1.5 block\",\r\n                      isDark ? \"text-slate-300\" : \"text-gray-700\"\r\n                    )}\r\n                  >\r\n                    Email\r\n                  </label>\r\n                  <Input\r\n                    type=\"email\"\r\n                    value={formData.company_email}\r\n                    onChange={(e) =>\r\n                      setFormData((prev) => ({\r\n                        ...prev,\r\n                        company_email: e.target.value,\r\n                      }))\r\n                    }\r\n                    placeholder=\"contact@agence.sn\"\r\n                    className={cn(\r\n                      isDark && \"bg-slate-800 border-slate-700 text-white\"\r\n                    )}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div>\r\n                <label\r\n                  className={cn(\r\n                    \"text-sm font-medium mb-1.5 block\",\r\n                    isDark ? \"text-slate-300\" : \"text-gray-700\"\r\n                  )}\r\n                >\r\n                  Adresse\r\n                </label>\r\n                <Input\r\n                  value={formData.company_address}\r\n                  onChange={(e) =>\r\n                    setFormData((prev) => ({\r\n                      ...prev,\r\n                      company_address: e.target.value,\r\n                    }))\r\n                  }\r\n                  placeholder=\"123 Avenue Bourguiba, Dakar\"\r\n                  className={cn(\r\n                    isDark && \"bg-slate-800 border-slate-700 text-white\"\r\n                  )}\r\n                />\r\n              </div>\r\n\r\n              <div className=\"flex justify-end gap-3 pt-4\">\r\n                <Button\r\n                  type=\"button\"\r\n                  variant=\"outline\"\r\n                  onClick={() => setShowForm(false)}\r\n                  className={cn(\r\n                    isDark && \"border-slate-700 text-slate-300 hover:bg-slate-800\"\r\n                  )}\r\n                >\r\n                  Annuler\r\n                </Button>\r\n                <Button\r\n                  type=\"submit\"\r\n                  disabled={loading || !formData.name.trim()}\r\n                  className=\"bg-[#F4C430] hover:bg-[#B8860B] text-black\"\r\n                >\r\n                  {loading ? (\r\n                    <>\r\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                      Cr√©ation...\r\n                    </>\r\n                  ) : (\r\n                    hasExistingAgency ? \"Activer l'√©quipe\" : \"Cr√©er l'√©quipe\"\r\n                  )}\r\n                </Button>\r\n              </div>\r\n            </form>\r\n          </DialogContent>\r\n        </Dialog>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction cn(...classes: (string | boolean | undefined)[]) {\r\n  return classes.filter(Boolean).join(\" \");\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\InvitationCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\InviteMemberDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\MemberCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\MembersList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\MembersTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\RoleBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\RolePermissionsTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\TeamHeader.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":42,"column":15,"nodeType":"JSXOpeningElement","endLine":46,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Building2, Users, Mail, Clock, Settings } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { useTheme } from \"@/components/theme-provider\";\r\nimport { RoleBadge } from \"./RoleBadge\";\r\nimport { InviteMemberDialog } from \"./InviteMemberDialog\";\r\nimport type { Team, TeamRole, TeamStats } from \"@/types/team\";\r\n\r\ninterface TeamHeaderProps {\r\n  team: Team;\r\n  userRole: TeamRole;\r\n  stats?: TeamStats;\r\n}\r\n\r\nexport function TeamHeader({ team, userRole, stats }: TeamHeaderProps) {\r\n  const { isDark } = useTheme();\r\n  const canInvite = userRole === \"owner\" || userRole === \"manager\";\r\n  const canManageSettings = userRole === \"owner\";\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"rounded-2xl border p-6\",\r\n        isDark ? \"bg-slate-900 border-slate-800\" : \"bg-white border-gray-200\"\r\n      )}\r\n    >\r\n      <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n        {/* Info √©quipe */}\r\n        <div className=\"flex items-start gap-4\">\r\n          {/* Logo/Avatar */}\r\n          <div\r\n            className={cn(\r\n              \"w-16 h-16 rounded-2xl flex items-center justify-center shrink-0\",\r\n              team.logo_url\r\n                ? \"\"\r\n                : \"bg-gradient-to-br from-[#F4C430] to-[#B8860B]\"\r\n            )}\r\n          >\r\n            {team.logo_url ? (\r\n              <img\r\n                src={team.logo_url}\r\n                alt={team.name}\r\n                className=\"w-full h-full object-cover rounded-2xl\"\r\n              />\r\n            ) : (\r\n              <Building2 className=\"w-8 h-8 text-black\" />\r\n            )}\r\n          </div>\r\n\r\n          <div>\r\n            <div className=\"flex items-center gap-3 mb-1\">\r\n              <h1\r\n                className={cn(\r\n                  \"text-2xl font-bold\",\r\n                  isDark ? \"text-white\" : \"text-gray-900\"\r\n                )}\r\n              >\r\n                {team.name}\r\n              </h1>\r\n              <RoleBadge role={userRole} size=\"sm\" />\r\n            </div>\r\n\r\n            {team.description && (\r\n              <p\r\n                className={cn(\r\n                  \"text-sm mb-2\",\r\n                  isDark ? \"text-slate-400\" : \"text-gray-500\"\r\n                )}\r\n              >\r\n                {team.description}\r\n              </p>\r\n            )}\r\n\r\n            <div\r\n              className={cn(\r\n                \"flex flex-wrap items-center gap-4 text-sm\",\r\n                isDark ? \"text-slate-400\" : \"text-gray-500\"\r\n              )}\r\n            >\r\n              {stats && (\r\n                <span className=\"flex items-center gap-1.5\">\r\n                  <Users className=\"w-4 h-4\" />\r\n                  {stats.total_members} membre{stats.total_members > 1 ? \"s\" : \"\"}\r\n                </span>\r\n              )}\r\n              {team.company_email && (\r\n                <span className=\"flex items-center gap-1.5\">\r\n                  <Mail className=\"w-4 h-4\" />\r\n                  {team.company_email}\r\n                </span>\r\n              )}\r\n              {stats?.pending_invitations ? (\r\n                <span className=\"flex items-center gap-1.5 text-amber-500\">\r\n                  <Clock className=\"w-4 h-4\" />\r\n                  {stats.pending_invitations} invitation\r\n                  {stats.pending_invitations > 1 ? \"s\" : \"\"} en attente\r\n                </span>\r\n              ) : null}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Actions */}\r\n        <div className=\"flex items-center gap-3\">\r\n          {canInvite && <InviteMemberDialog teamId={team.id} />}\r\n\r\n          {canManageSettings && (\r\n            <Link href=\"/gestion/equipe/parametres\">\r\n              <Button\r\n                variant=\"outline\"\r\n                className={cn(\r\n                  isDark && \"border-slate-700 text-slate-300 hover:bg-slate-800\"\r\n                )}\r\n              >\r\n                <Settings className=\"w-4 h-4 mr-2\" />\r\n                Param√®tres\r\n              </Button>\r\n            </Link>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Stats rapides */}\r\n      {stats && (\r\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-6 border-t border-slate-800\">\r\n          <StatCard\r\n            label=\"Membres\"\r\n            value={stats.total_members}\r\n            isDark={isDark}\r\n          />\r\n          <StatCard\r\n            label=\"Baux actifs\"\r\n            value={stats.active_leases}\r\n            isDark={isDark}\r\n          />\r\n          <StatCard\r\n            label=\"Total baux\"\r\n            value={stats.total_leases}\r\n            isDark={isDark}\r\n          />\r\n          <StatCard\r\n            label=\"Invitations\"\r\n            value={stats.pending_invitations}\r\n            isDark={isDark}\r\n            highlight={stats.pending_invitations > 0}\r\n          />\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction StatCard({\r\n  label,\r\n  value,\r\n  isDark,\r\n  highlight = false,\r\n}: {\r\n  label: string;\r\n  value: number;\r\n  isDark: boolean;\r\n  highlight?: boolean;\r\n}) {\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"p-3 rounded-xl\",\r\n        isDark ? \"bg-slate-800/50\" : \"bg-gray-50\"\r\n      )}\r\n    >\r\n      <p\r\n        className={cn(\r\n          \"text-xs mb-1\",\r\n          isDark ? \"text-slate-400\" : \"text-gray-500\"\r\n        )}\r\n      >\r\n        {label}\r\n      </p>\r\n      <p\r\n        className={cn(\r\n          \"text-2xl font-bold\",\r\n          highlight\r\n            ? \"text-amber-500\"\r\n            : isDark\r\n              ? \"text-white\"\r\n              : \"text-gray-900\"\r\n        )}\r\n      >\r\n        {value}\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction cn(...classes: (string | boolean | undefined)[]) {\r\n  return classes.filter(Boolean).join(\" \");\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\TeamPageClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\components\\TeamPageClient.tsx:60:7\n  58 |   useEffect(() => {\n  59 |     if (tabFromUrl && [\"members\", \"permissions\", \"access-control\"].includes(tabFromUrl)) {\n> 60 |       setActiveTab(tabFromUrl);\n     |       ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  61 |     }\n  62 |   }, [tabFromUrl]);\n  63 |","line":60,"column":7,"nodeType":null,"endLine":60,"endColumn":19},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":82,"column":17,"nodeType":"JSXOpeningElement","endLine":86,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Link from \"next/link\";\nimport { useState, useEffect } from \"react\";\nimport { useSearchParams } from \"next/navigation\";\nimport { Users, Shield, _Settings, UserPlus, Building2, BarChart3, KeyRound } from \"lucide-react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\nimport { useTheme } from \"@/components/theme-provider\";\nimport { TEAM_ROLE_CONFIG } from \"@/lib/team-permissions\";\nimport { MembersTable } from \"./MembersTable\";\nimport { RolePermissionsTable } from \"./RolePermissionsTable\";\nimport { InviteMemberDialog } from \"./InviteMemberDialog\";\nimport { AccessControlTab } from \"./AccessControlTab\";\nimport type { Team, TeamMember, TeamRole, TeamStats } from \"@/types/team\";\nimport { EquipeTour } from '@/components/gestion/tours/EquipeTour';\n\ninterface TeamInvitation {\n  id: string;\n  team_id: string;\n  email: string;\n  role: string;\n  created_at: string;\n  expires_at: string;\n  status: string;\n}\n\ninterface TeamPageClientProps {\n  team: Team;\n  members: TeamMember[];\n  invitations: TeamInvitation[];\n  stats?: TeamStats;\n  currentUserId: string;\n  currentUserRole: TeamRole;\n}\n\nexport function TeamPageClient({\n  team,\n  members,\n  invitations,\n  stats,\n  currentUserId,\n  currentUserRole,\n}: TeamPageClientProps) {\n  const { isDark } = useTheme();\n  const searchParams = useSearchParams();\n  const tabFromUrl = searchParams.get(\"tab\");\n\n  // Initialiser avec l'onglet de l'URL ou \"members\" par d√©faut\n  const [activeTab, setActiveTab] = useState(tabFromUrl || \"members\");\n\n  const canInvite = currentUserRole === \"owner\" || currentUserRole === \"manager\";\n  const roleConfig = TEAM_ROLE_CONFIG[currentUserRole];\n\n  // Mettre √† jour l'onglet si le param√®tre URL change\n  useEffect(() => {\n    if (tabFromUrl && [\"members\", \"permissions\", \"access-control\"].includes(tabFromUrl)) {\n      setActiveTab(tabFromUrl);\n    }\n  }, [tabFromUrl]);\n\n  return (\n    <div className=\"space-y-4 px-4 lg:space-y-6 lg:px-8\">\n      <EquipeTour />\n      {/* En-t√™te de la page */}\n      <div id=\"tour-team-header\" className={cn(\n        \"rounded-2xl p-4 md:p-6\",\n        isDark\n          ? \"bg-gradient-to-r from-slate-800 to-slate-800/50 border border-slate-700\"\n          : \"bg-gradient-to-r from-slate-100 to-white border border-slate-200\"\n      )}>\n        <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4 md:gap-6\">\n          {/* Infos √©quipe */}\n          <div className=\"flex items-center gap-4\">\n            <div className={cn(\n              \"flex items-center justify-center h-12 w-12 md:h-14 md:w-14 rounded-xl overflow-hidden shadow-sm shrink-0\",\n              team.logo_url ? \"bg-white p-1.5 border border-slate-200\" : (isDark ? \"bg-primary/20\" : \"bg-primary/10\")\n            )}>\n              {team.logo_url ? (\n                <img\n                  src={team.logo_url}\n                  alt={team.name}\n                  className=\"h-full w-auto max-w-full object-contain\"\n                />\n              ) : (\n                <Building2 className=\"h-7 w-7 text-primary\" />\n              )}\n            </div>\n            <div>\n              <div className=\"flex items-center gap-3\">\n                <h1 className={cn(\n                  \"text-lg md:text-xl font-bold line-clamp-1\",\n                  isDark ? \"text-white\" : \"text-slate-900\"\n                )}>\n                  {team.name}\n                </h1>\n                <Badge\n                  variant=\"outline\"\n                  className={cn(roleConfig.bgColor, roleConfig.textColor, \"border-0\")}\n                >\n                  {roleConfig.label}\n                </Badge>\n              </div>\n              <p className={cn(\n                \"text-sm mt-0.5\",\n                isDark ? \"text-slate-400\" : \"text-slate-500\"\n              )}>\n                {team.description || \"G√©rez votre √©quipe et ses permissions\"}\n              </p>\n            </div>\n          </div>\n\n          {/* Stats rapides + Action */}\n          <div className=\"flex items-center gap-4\">\n            {stats && (\n              <div id=\"tour-team-stats\" className=\"hidden sm:flex items-center gap-4\">\n                <StatBadge\n                  icon={<Users className=\"h-4 w-4\" />}\n                  value={stats.total_members}\n                  label=\"Membres\"\n                  isDark={isDark}\n                  onClick={() => setActiveTab(\"members\")}\n                />\n                {stats.pending_invitations > 0 && (\n                  <StatBadge\n                    icon={<UserPlus className=\"h-4 w-4\" />}\n                    value={stats.pending_invitations}\n                    label=\"En attente\"\n                    variant=\"warning\"\n                    isDark={isDark}\n                    onClick={() => setActiveTab(\"members\")}\n                  />\n                )}\n                <StatBadge\n                  icon={<BarChart3 className=\"h-4 w-4\" />}\n                  value={stats.active_leases}\n                  label=\"Baux actifs\"\n                  isDark={isDark}\n                  href=\"/gestion\"\n                />\n              </div>\n            )}\n\n            {canInvite && (\n              <InviteMemberDialog\n                teamId={team.id}\n                trigger={\n                  <Button id=\"tour-team-invite\" className=\"w-full md:w-auto bg-primary hover:bg-primary/90 text-primary-foreground font-medium\">\n                    <UserPlus className=\"h-4 w-4 mr-2\" />\n                    Inviter\n                  </Button>\n                }\n              />\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <Tabs id=\"tour-team-tabs\" value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\n        <TabsList className=\"w-full justify-start md:justify-center bg-transparent p-1 gap-1 md:gap-2 border border-slate-200 dark:border-slate-800 rounded-xl md:rounded-full overflow-x-auto overflow-y-hidden scrollbar-none\">\n          <TabsTrigger\n            value=\"members\"\n            className=\"group rounded-full border border-transparent data-[state=active]:bg-slate-200 dark:data-[state=active]:bg-slate-800 data-[state=active]:text-slate-900 dark:data-[state=active]:text-slate-100 data-[state=active]:shadow-none text-muted-foreground hover:bg-muted/50 transition-all flex items-center gap-2 px-3 py-1.5 md:px-4 md:py-2 text-sm\"\n          >\n            <Users className=\"h-4 w-4 transition-colors\" />\n            <span className=\"font-medium transition-colors\">Membres</span>\n            {(members.length + invitations.length) > 0 && (\n              <Badge variant=\"secondary\" className=\"ml-1 h-5 px-1.5 text-xs bg-slate-100/80 text-slate-500 dark:bg-slate-900/80 dark:text-slate-400 border-none\">\n                {members.length + invitations.length}\n              </Badge>\n            )}\n          </TabsTrigger>\n          <TabsTrigger\n            value=\"permissions\"\n            className=\"group rounded-full border border-transparent data-[state=active]:bg-slate-200 dark:data-[state=active]:bg-slate-800 data-[state=active]:text-slate-900 dark:data-[state=active]:text-slate-100 data-[state=active]:shadow-none text-muted-foreground hover:bg-muted/50 transition-all flex items-center gap-2 px-3 py-1.5 md:px-4 md:py-2 text-sm\"\n          >\n            <Shield className=\"h-4 w-4 transition-colors\" />\n            <span className=\"font-medium transition-colors\">R√¥les & Permissions</span>\n          </TabsTrigger>\n          {canInvite && (\n            <TabsTrigger\n              value=\"access-control\"\n              className=\"group rounded-full border border-transparent data-[state=active]:bg-slate-200 dark:data-[state=active]:bg-slate-800 data-[state=active]:text-slate-900 dark:data-[state=active]:text-slate-100 data-[state=active]:shadow-none text-muted-foreground hover:bg-muted/50 transition-all flex items-center gap-2 px-4 py-2\"\n            >\n              <KeyRound className=\"h-4 w-4 transition-colors\" />\n              <span className=\"font-medium transition-colors\">Acc√®s Temporaire</span>\n            </TabsTrigger>\n          )}\n        </TabsList>\n\n        {/* Tab: Membres */}\n        <TabsContent value=\"members\" className=\"mt-0\">\n          <MembersTable\n            members={members}\n            invitations={invitations}\n            teamId={team.id}\n            currentUserRole={currentUserRole}\n            currentUserId={currentUserId}\n          />\n        </TabsContent>\n\n        {/* Tab: Permissions */}\n        <TabsContent value=\"permissions\" className=\"mt-0\">\n          <RolePermissionsTable currentUserRole={currentUserRole} />\n        </TabsContent>\n\n        {/* Tab: Acc√®s Temporaire (owners/managers uniquement) */}\n        {canInvite && (\n          <TabsContent value=\"access-control\" className=\"mt-0\">\n            <AccessControlTab teamId={team.id} />\n          </TabsContent>\n        )}\n      </Tabs>\n    </div>\n  );\n}\n\ninterface StatBadgeProps {\n  icon: React.ReactNode;\n  value: number;\n  label: string;\n  variant?: \"default\" | \"warning\";\n  isDark: boolean;\n  href?: string;\n  onClick?: () => void;\n}\n\nfunction StatBadge({ icon, value, label, variant = \"default\", isDark, href, onClick }: StatBadgeProps) {\n  const content = (\n    <div className={cn(\n      \"flex items-center gap-2 px-3 py-1.5 rounded-lg transition-all duration-200 cursor-pointer hover:scale-105 active:scale-95 text-left\",\n      variant === \"warning\"\n        ? isDark ? \"bg-amber-500/10 text-amber-500 border border-amber-500/20\" : \"bg-amber-50 text-amber-600 border border-amber-200\"\n        : isDark ? \"bg-slate-700/50 text-slate-300 border border-slate-600/50 hover:bg-slate-700 hover:border-slate-500\" : \"bg-white text-slate-600 border border-slate-200 hover:border-slate-300 shadow-sm\"\n    )}>\n      {icon}\n      <div className=\"flex items-center gap-1.5 ml-1 whitespace-nowrap\">\n        <span className=\"text-sm font-semibold leading-none\">{value}</span>\n        <span className=\"text-xs opacity-70 font-medium\">{label}</span>\n      </div>\n    </div>\n  );\n\n  if (href) {\n    return <Link href={href}>{content}</Link>;\n  }\n\n  return (\n    <button onClick={onClick} className=\"block w-full focus:outline-none\">\n      {content}\n    </button>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\invitations\\CancelInvitationButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\invitations\\accept\\AcceptInvitationClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\invitations\\accept\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\invitations\\page.tsx","messages":[{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\invitations\\page.tsx:109:27\n  107 |   const expiresAt = new Date(invitation.expires_at);\n  108 |   const isExpiringSoon =\n> 109 |     expiresAt.getTime() - Date.now() < 2 * 24 * 60 * 60 * 1000; // 2 jours\n      |                           ^^^^^^^^^^ Cannot call impure function\n  110 |\n  111 |   const createdAt = new Date(invitation.created_at).toLocaleDateString(\"fr-FR\", {\n  112 |     day: \"numeric\",","line":109,"column":27,"nodeType":null,"endLine":109,"endColumn":37},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\invitations\\page.tsx:118:28\n  116 |\n  117 |   const expiresIn = Math.ceil(\n> 118 |     (expiresAt.getTime() - Date.now()) / (1000 * 60 * 60 * 24)\n      |                            ^^^^^^^^^^ Cannot call impure function\n  119 |   );\n  120 |\n  121 |   return (","line":118,"column":28,"nodeType":null,"endLine":118,"endColumn":38}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\r\nimport { redirect } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { ArrowLeft, Mail, Clock, _X, UserPlus } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { getTeamInvitations, _cancelInvitation } from \"../actions\";\r\nimport { TEAM_ROLE_CONFIG } from \"@/lib/team-permissions-config\";\r\nimport type { TeamRole, TeamInvitation } from \"@/types/team\";\r\nimport { InviteMemberDialog } from \"../components/InviteMemberDialog\";\r\nimport { CancelInvitationButton } from \"./CancelInvitationButton\";\r\n\r\nexport const metadata = {\r\n  title: \"Invitations | √âquipe - Dousell Immo\",\r\n  description: \"G√©rez les invitations en attente\",\r\n};\r\n\r\nexport default async function InvitationsPage() {\r\n  const supabase = await createClient();\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (!user) redirect(\"/auth\");\r\n\r\n  // R√©cup√©rer le membership\r\n  const { data: membership } = await supabase\r\n    .from(\"team_members\")\r\n    .select(\"team_id, role\")\r\n    .eq(\"user_id\", user.id)\r\n    .eq(\"status\", \"active\")\r\n    .maybeSingle();\r\n\r\n  if (!membership) redirect(\"/gestion/equipe\");\r\n\r\n  const userRole = membership.role as TeamRole;\r\n  const canInvite = userRole === \"owner\" || userRole === \"manager\";\r\n\r\n  // R√©cup√©rer les invitations\r\n  const result = await getTeamInvitations(membership.team_id);\r\n  const invitations = result.success ? result.invitations || [] : [];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <Link href=\"/gestion/equipe\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"h-9 w-9 text-slate-400 hover:text-white hover:bg-slate-800\"\r\n            >\r\n              <ArrowLeft className=\"w-5 h-5\" />\r\n            </Button>\r\n          </Link>\r\n          <div>\r\n            <h1 className=\"text-2xl font-bold text-white\">Invitations</h1>\r\n            <p className=\"text-sm text-slate-400\">\r\n              {invitations.length} invitation\r\n              {invitations.length !== 1 ? \"s\" : \"\"} en attente\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {canInvite && <InviteMemberDialog teamId={membership.team_id} />}\r\n      </div>\r\n\r\n      {/* Liste des invitations */}\r\n      {invitations.length === 0 ? (\r\n        <div className=\"flex flex-col items-center justify-center py-16 rounded-2xl border-2 border-dashed border-slate-800\">\r\n          <Mail className=\"w-12 h-12 text-slate-600 mb-4\" />\r\n          <p className=\"text-lg font-medium text-slate-400 mb-1\">\r\n            Aucune invitation en attente\r\n          </p>\r\n          <p className=\"text-sm text-slate-500 mb-6\">\r\n            Invitez des collaborateurs pour agrandir votre √©quipe\r\n          </p>\r\n          {canInvite && <InviteMemberDialog teamId={membership.team_id} />}\r\n        </div>\r\n      ) : (\r\n        <div className=\"space-y-3\">\r\n          {invitations.map((invitation) => (\r\n            <InvitationCard\r\n              key={invitation.id}\r\n              invitation={invitation}\r\n              teamId={membership.team_id}\r\n              canManage={canInvite}\r\n            />\r\n          ))}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction InvitationCard({\r\n  invitation,\r\n  teamId,\r\n  canManage,\r\n}: {\r\n  invitation: TeamInvitation;\r\n  teamId: string;\r\n  canManage: boolean;\r\n}) {\r\n  const roleConfig = TEAM_ROLE_CONFIG[invitation.role as TeamRole];\r\n  const expiresAt = new Date(invitation.expires_at);\r\n  const isExpiringSoon =\r\n    expiresAt.getTime() - Date.now() < 2 * 24 * 60 * 60 * 1000; // 2 jours\r\n\r\n  const createdAt = new Date(invitation.created_at).toLocaleDateString(\"fr-FR\", {\r\n    day: \"numeric\",\r\n    month: \"short\",\r\n    year: \"numeric\",\r\n  });\r\n\r\n  const expiresIn = Math.ceil(\r\n    (expiresAt.getTime() - Date.now()) / (1000 * 60 * 60 * 24)\r\n  );\r\n\r\n  return (\r\n    <div className=\"p-4 rounded-xl border border-slate-800 bg-slate-900 hover:border-slate-700 transition-colors\">\r\n      <div className=\"flex items-start justify-between gap-4\">\r\n        <div className=\"flex items-start gap-4 min-w-0\">\r\n          {/* Icon */}\r\n          <div className=\"w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0\">\r\n            <UserPlus className=\"w-5 h-5 text-slate-400\" />\r\n          </div>\r\n\r\n          {/* Info */}\r\n          <div className=\"min-w-0\">\r\n            <p className=\"font-medium text-white truncate\">{invitation.email}</p>\r\n            <div className=\"flex flex-wrap items-center gap-2 mt-1\">\r\n              <span\r\n                className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${roleConfig.bgColor} ${roleConfig.textColor}`}\r\n              >\r\n                {roleConfig.label}\r\n              </span>\r\n              <span className=\"text-xs text-slate-500\">\r\n                Invit√© le {createdAt}\r\n              </span>\r\n            </div>\r\n\r\n            {invitation.message && (\r\n              <p className=\"text-sm text-slate-400 mt-2 line-clamp-2\">\r\n                &quot;{invitation.message}&quot;\r\n              </p>\r\n            )}\r\n\r\n            {/* Expiration */}\r\n            <div\r\n              className={`flex items-center gap-1.5 mt-2 text-xs ${\r\n                isExpiringSoon ? \"text-amber-500\" : \"text-slate-500\"\r\n              }`}\r\n            >\r\n              <Clock className=\"w-3.5 h-3.5\" />\r\n              <span>\r\n                {expiresIn > 0\r\n                  ? `Expire dans ${expiresIn} jour${expiresIn > 1 ? \"s\" : \"\"}`\r\n                  : \"Expir√©e\"}\r\n              </span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Actions */}\r\n        {canManage && (\r\n          <CancelInvitationButton\r\n            teamId={teamId}\r\n            invitationId={invitation.id}\r\n          />\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\parametres\\TeamSettingsForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\equipe\\parametres\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\[id]\\pdf\\PDFPreview.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1130,1133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1130,1133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadData` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\[id]\\pdf\\PDFPreview.tsx:35:9\n  33 |\n  34 |     useEffect(() => {\n> 35 |         loadData();\n     |         ^^^^^^^^ `loadData` accessed before it is declared\n  36 |     }, [reportId]);\n  37 |\n  38 |     const loadData = async () => {\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\[id]\\pdf\\PDFPreview.tsx:38:5\n  36 |     }, [reportId]);\n  37 |\n> 38 |     const loadData = async () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 39 |         const [reportResult, brandingResult] = await Promise.all([\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 40 |             getInventoryReportById(reportId),\n     ‚Ä¶\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 64 |         setLoading(false);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 65 |     };\n     | ^^^^^^^ `loadData` is declared here\n  66 |\n  67 |     const handlePrint = () => {\n  68 |         window.print();","line":35,"column":9,"nodeType":null,"endLine":35,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":36,"column":8,"nodeType":"ArrayExpression","endLine":36,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [loadData, reportId]","fix":{"range":[1360,1370],"text":"[loadData, reportId]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3496,3499],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3496,3499],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3522,3525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3522,3525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":154,"column":29,"nodeType":"JSXOpeningElement","endLine":158,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":232,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9749,9752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9749,9752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":253,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":253,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11281,11284],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11281,11284],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":311,"column":37,"nodeType":"JSXOpeningElement","endLine":311,"endColumn":142},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":322,"column":37,"nodeType":"JSXOpeningElement","endLine":322,"endColumn":145},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":338,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":338,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16701,16704],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16701,16704],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":339,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16764,16767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16764,16767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":343,"column":49,"nodeType":"JSXOpeningElement","endLine":347,"endColumn":51}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { ArrowLeft, Loader2, Printer, Check } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { toast } from 'sonner';\nimport { getInventoryReportById, getAgencyBranding } from '../../actions';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\nimport { useTheme } from \"@/components/theme-provider\";\n\ninterface PDFPageProps {\n    reportId: string;\n}\n\n// ... (CONDITION_MAP can be kept inside or outside, assuming it was outside in previous version)\nconst CONDITION_MAP: Record<string, { short: string; label: string }> = {\n    'bon': { short: 'TB', label: 'Tr√®s Bon' },\n    'moyen': { short: 'B', label: 'Bon' },\n    'mauvais': { short: 'M', label: 'Moyen' },\n    'absent': { short: 'D', label: 'D√©grad√©/Absent' },\n};\n\nexport function PDFPreview({ reportId }: PDFPageProps) {\n    const { isDark } = useTheme();\n    const router = useRouter();\n    const [_loading, setLoading] = useState(true);\n    const [report, setReport] = useState<any>(null);\n    const [agencyBranding, setAgencyBranding] = useState<{ name: string | null, logo: string | null } | null>(null);\n    const printRef = useRef<HTMLDivElement>(null);\n\n    useEffect(() => {\n        loadData();\n    }, [reportId]);\n\n    const loadData = async () => {\n        const [reportResult, brandingResult] = await Promise.all([\n            getInventoryReportById(reportId),\n            getAgencyBranding()\n        ]);\n\n        if (reportResult.error) {\n            toast.error(reportResult.error);\n            router.push('/etats-lieux');\n            return;\n        }\n\n        if (reportResult.data?.status !== 'signed') {\n            toast.error('Le rapport doit √™tre sign√© avant de g√©n√©rer le PDF');\n            router.push(`/gestion/etats-lieux/${reportId}/sign`);\n            return;\n        }\n\n        if (brandingResult && !('error' in brandingResult)) {\n            setAgencyBranding({\n                name: brandingResult.agency_name,\n                logo: brandingResult.logo_url\n            });\n        }\n\n        setReport(reportResult.data);\n        setLoading(false);\n    };\n\n    const handlePrint = () => {\n        window.print();\n    };\n\n    const getCityFromAddress = (address: string | undefined) => {\n        if (!address) return null;\n        // Try comma split first (Standard format: Address, City)\n        if (address.includes(',')) {\n            const part = address.split(',').pop()?.trim();\n            if (part && part.length > 2) return part;\n        }\n\n        // Contextual Fallbacks for Senegal\n        const lower = address.toLowerCase();\n        if (lower.includes('dakar')) return 'Dakar';\n        if (lower.includes('saly')) return 'Saly';\n        if (lower.includes('thies') || lower.includes('thi√®s')) return 'Thi√®s';\n        if (lower.includes('saint-louis')) return 'Saint-Louis';\n        if (lower.includes('mbour')) return 'Mbour';\n\n        return null;\n    };\n\n    if (!report) {\n        return (\n            <div className=\"flex items-center justify-center min-h-[50vh]\">\n                <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\n            </div>\n        );\n    }\n\n    const reportDate = report?.report_date ? new Date(report.report_date) : new Date();\n    const _signedDate = report?.signed_at ? new Date(report.signed_at) : new Date();\n\n    const hasPhotos = report?.rooms?.some((r: any) => r.items?.some((i: any) => i.photos?.length > 0));\n\n    return (\n        <div className={`min-h-screen p-6 print:p-0 print:bg-white ${isDark ? 'bg-slate-950' : 'bg-gray-100'}`}>\n            <style jsx global>{`\n                @media print {\n                    body * {\n                        visibility: hidden;\n                    }\n                    #printable-content, #printable-content * {\n                        visibility: visible;\n                    }\n                    #printable-content {\n                        position: absolute;\n                        left: 0;\n                        top: 0;\n                        width: 100% !important;\n                        max-width: 100% !important;\n                        box-sizing: border-box !important;\n                        margin: 0 !important;\n                        padding: 15mm !important; /* Standard A4 Matrix */\n                    }\n                    /* Ensure images are printed */\n                    img {\n                        -webkit-print-color-adjust: exact;\n                        print-color-adjust: exact;\n                    }\n                }\n            `}</style>\n\n            {/* Header Actions - Hidden on print */}\n            <div className=\"max-w-4xl mx-auto mb-6 flex justify-between items-center print:hidden\">\n                <Link href=\"/etats-lieux\" className={`flex items-center gap-2 transition-colors ${isDark ? 'text-slate-400 hover:text-white' : 'text-gray-500 hover:text-gray-900'}`}>\n                    <ArrowLeft className=\"w-4 h-4\" /> Retour\n                </Link>\n                <Button onClick={handlePrint} className=\"bg-[#F4C430] hover:bg-[#D4A420] text-black\">\n                    <Printer className=\"w-4 h-4 mr-2\" />\n                    Imprimer / Enregistrer PDF\n                </Button>\n            </div>\n\n            {/* A4 Page Preview */}\n            <div\n                id=\"printable-content\"\n                ref={printRef}\n                className=\"bg-white text-black rounded-xl p-8 print:p-6 print:rounded-none max-w-4xl mx-auto print:max-w-none text-sm shadow-2xl print:shadow-none\"\n                style={{ fontFamily: 'Arial, sans-serif' }}\n            >\n                {/* Agency Header - Realigned Right */}\n                <div className=\"hidden print:flex justify-between items-start border-b border-black pb-4 mb-4\">\n                    {/* Logo (Left) */}\n                    <div className=\"w-1/3\">\n                        {agencyBranding?.logo && (\n                            <img\n                                src={agencyBranding.logo}\n                                alt=\"Logo Agence\"\n                                className=\"h-16 w-auto object-contain object-left\"\n                            />\n                        )}\n                    </div>\n\n                    {/* Agency Name & Type (Right) */}\n                    <div className=\"w-2/3 text-right\">\n                        <p className=\"font-bold text-xl uppercase tracking-tight\">\n                            {agencyBranding?.name || 'DOUSSEL IMMO'}\n                        </p>\n                        <p className=\"text-xs text-gray-600 mb-2\">\n                            Gestion Locative & Immobili√®re\n                        </p>\n                        <div className=\"inline-block border border-gray-400 px-3 py-1 mt-1\">\n                            <p className=\"font-bold text-sm uppercase\">\n                                {report?.type === 'entry' ? \"√âtat des Lieux d'Entr√©e\" : \"√âtat des Lieux de Sortie\"}\n                            </p>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Document Subtitle (Replaces old Title Header) */}\n                <div className=\"bg-gray-100 text-center py-2 mb-6 border-y border-gray-300\">\n                    <h2 className=\"font-bold uppercase tracking-wide text-xs\">\n                        Constat contradictoire de l&apos;√©tat du logement\n                    </h2>\n                </div>\n\n                {/* Property Description */}\n                <p className=\"font-semibold mb-4 text-sm\">\n                    {report?.type === 'entry' ? \"ENTR√âE\" : \"SORTIE\"} du locataire pour le logement sis √† :<br />\n                    <span className=\"font-normal\">{report?.lease?.property_address}</span>\n                </p>\n\n                {/* Date and Info Row */}\n                <div className=\"mb-6 space-y-2\">\n                    <p>\n                        <strong>Date du constat :</strong>{' '}\n                        <span className=\"border-b border-black inline-block min-w-[200px]\">\n                            {format(reportDate, 'd MMMM yyyy', { locale: fr })}\n                        </span>\n                    </p>\n\n                    <p>\n                        <strong>Locataire :</strong>{' '}\n                        <span className=\"border-b border-black inline-block min-w-[200px]\">\n                            {report?.lease?.tenant_name}\n                        </span>\n                    </p>\n                </div>\n\n                {/* Meter Readings */}\n                <div className=\"mb-6 flex flex-wrap gap-x-8 gap-y-2\">\n                    <p>\n                        <strong>Relev√© compteur √©lectricit√© :</strong>{' '}\n                        <span className=\"border-b border-black inline-block min-w-[80px] text-center\">\n                            {report?.meter_readings?.electricity || '______'}\n                        </span>{' '}\n                        kWh\n                    </p>\n                    <p>\n                        <strong>Relev√© compteur eau :</strong>{' '}\n                        <span className=\"border-b border-black inline-block min-w-[80px] text-center\">\n                            {report?.meter_readings?.water || '______'}\n                        </span>{' '}\n                        m¬≥\n                    </p>\n                </div>\n\n                {/* Legend */}\n                <div className=\"mb-4 text-xs bg-gray-50 p-2 rounded\">\n                    <strong>L√©gende :</strong> TB = Tr√®s Bon | B = Bon | M = Moyen | D = D√©grad√©/Absent\n                </div>\n\n                {/* Rooms Tables */}\n                {report?.rooms?.map((room: any, roomIndex: number) => (\n                    <div key={roomIndex} className=\"mb-6 break-inside-avoid\">\n                        <h3 className=\"font-bold bg-gray-100 border border-gray-300 px-3 py-2 uppercase text-sm\">\n                            {room.name}\n                        </h3>\n                        <table className=\"w-full border-collapse border border-gray-300\">\n                            <thead>\n                                <tr className=\"bg-gray-50\">\n                                    <th className=\"border border-gray-300 px-2 py-1 text-left font-medium w-1/3\">\n                                        √âl√©ment\n                                    </th>\n                                    <th className=\"border border-gray-300 px-1 py-1 text-center font-medium w-8\">TB</th>\n                                    <th className=\"border border-gray-300 px-1 py-1 text-center font-medium w-8\">B</th>\n                                    <th className=\"border border-gray-300 px-1 py-1 text-center font-medium w-8\">M</th>\n                                    <th className=\"border border-gray-300 px-1 py-1 text-center font-medium w-8\">D</th>\n                                    <th className=\"border border-gray-300 px-2 py-1 text-left font-medium\">\n                                        Commentaires\n                                    </th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                {room.items?.map((item: any, itemIndex: number) => {\n                                    const conditionData = CONDITION_MAP[item.condition] || { short: '' };\n                                    return (\n                                        <tr key={itemIndex}>\n                                            <td className=\"border border-gray-300 px-2 py-1\">{item.name}</td>\n                                            <td className=\"border border-gray-300 px-1 py-1 text-center\">\n                                                {conditionData.short === 'TB' ? '‚úì' : ''}\n                                            </td>\n                                            <td className=\"border border-gray-300 px-1 py-1 text-center\">\n                                                {conditionData.short === 'B' ? '‚úì' : ''}\n                                            </td>\n                                            <td className=\"border border-gray-300 px-1 py-1 text-center\">\n                                                {conditionData.short === 'M' ? '‚úì' : ''}\n                                            </td>\n                                            <td className=\"border border-gray-300 px-1 py-1 text-center\">\n                                                {conditionData.short === 'D' ? '‚úì' : ''}\n                                            </td>\n                                            <td className=\"border border-gray-300 px-2 py-1 text-xs text-gray-600\">\n                                                {item.comment || ''}\n                                            </td>\n                                        </tr>\n                                    );\n                                })}\n                            </tbody>\n                        </table>\n                    </div>\n                ))}\n\n                {/* Commentaires Contradictoires */}\n                <div className=\"mb-6\">\n                    <h3 className=\"font-bold uppercase mb-2\">Commentaires Contradictoires :</h3>\n                    <div className=\"border border-gray-300 min-h-[60px] p-2 text-sm\">\n                        {report?.general_comments || ''}\n                    </div>\n                </div>\n\n                {/* Signatures Section - Atomic Block to prevent splitting */}\n                <div className=\"mt-8 pt-4 break-inside-avoid bg-white\">\n                    <div className=\"flex justify-between items-end mb-8\">\n                        <div>\n                            <p className=\"mb-4 font-bold\">\n                                Clefs remises au nombre de : <span className=\"border-b border-black inline-block w-16\"></span>\n                            </p>\n                            <p className=\"font-bold\">\n                                Fait √† : <span className=\"border-b border-black inline-block w-32 px-2 text-center\">{getCityFromAddress(report?.lease?.property_address) || '....................'}</span>\n                                , le {format(new Date(), 'd MMMM yyyy', { locale: fr })}\n                            </p>\n                        </div>\n                    </div>\n\n                    <div className=\"border-t border-black my-4\"></div>\n\n                    <div className=\"grid grid-cols-2 gap-16 mt-8\">\n                        <div className=\"text-center\">\n                            <p className=\"font-bold mb-4\">Le Bailleur (ou son mandataire)</p>\n                            <div className=\"h-32 border border-gray-200 rounded flex flex-col items-center justify-center bg-gray-50 relative\">\n                                <p className=\"text-[10px] text-gray-400 absolute top-2\">Lu et approuv√©</p>\n                                {report?.owner_signature ? (\n                                    <img src={report.owner_signature} alt=\"Signature Proprio\" className=\"h-full w-auto object-contain p-2\" />\n                                ) : (\n                                    <p className=\"text-xs text-gray-400 italic mt-4\">(En attente)</p>\n                                )}\n                            </div>\n                        </div>\n                        <div className=\"text-center\">\n                            <p className=\"font-bold mb-4\">Le(s) Locataire(s)</p>\n                            <div className=\"h-32 border border-gray-200 rounded flex flex-col items-center justify-center bg-gray-50 relative\">\n                                <p className=\"text-[10px] text-gray-400 absolute top-2\">Lu et approuv√©</p>\n                                {report?.tenant_signature ? (\n                                    <img src={report.tenant_signature} alt=\"Signature Locataire\" className=\"h-full w-auto object-contain p-2\" />\n                                ) : (\n                                    <p className=\"text-xs text-gray-400 italic mt-4\">(En attente)</p>\n                                )}\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Photo Appendix */}\n                {hasPhotos && (\n                    <div className=\"break-before-page mt-8\">\n                        <h2 className=\"text-sm font-bold uppercase border-b border-black pb-2 mb-4\">\n                            Annexe : Photos de l&apos;√âtat des Lieux\n                        </h2>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                            {report?.rooms?.map((room: any) =>\n                                room.items?.map((item: any) =>\n                                    item.photos?.map((photoUrl: string, index: number) => (\n                                        <div key={`${room.name}-${item.name}-${index}`} className=\"border border-gray-200 p-2 break-inside-avoid bg-white\">\n                                            <div className=\"aspect-video w-full bg-gray-50 mb-2 overflow-hidden flex items-center justify-center rounded\">\n                                                <img\n                                                    src={photoUrl}\n                                                    alt={`${item.name} - ${room.name}`}\n                                                    className=\"w-full h-full object-contain\"\n                                                />\n                                            </div>\n                                            <div className=\"px-1\">\n                                                <p className=\"text-xs font-bold truncate\">{room.name} - {item.name}</p>\n                                                <p className=\"text-[10px] text-gray-500\">Photo n¬∞{index + 1}</p>\n                                            </div>\n                                        </div>\n                                    ))\n                                )\n                            )}\n                        </div>\n                    </div>\n                )}\n\n                {/* Footer */}\n                <div className=\"mt-8 pt-4 border-t border-gray-200 flex justify-between text-xs text-gray-400\">\n                    <span>Document g√©n√©r√© par {agencyBranding?.name || 'Doussel Immo'}</span>\n                    <span>R√©f: {report?.id?.slice(0, 8)}</span>\n                </div>\n            </div>\n\n            {/* Success Banner - Hidden on print */}\n            <div className=\"bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 flex items-center gap-3 print:hidden\">\n                <Check className=\"w-5 h-5 text-emerald-400\" />\n                <p className={`text-sm ${isDark ? 'text-emerald-300' : 'text-emerald-600'}`}>\n                    √âtat des lieux sign√©. Cliquez sur &quot;Imprimer&quot; puis &quot;Enregistrer en PDF&quot; pour t√©l√©charger.\n                </p>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\[id]\\pdf\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\[id]\\sign\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\components\\DeleteInventoryButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\components\\EtatsLieuxContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":103,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":106,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[728,731],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[728,731],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1117,1120],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1117,1120],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Link from 'next/link';\nimport { Plus, FileText, CheckCircle, Clock, Edit, ArrowLeft, Printer } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\nimport { DeleteInventoryButton } from './DeleteInventoryButton';\nimport {\n    ThemedPage,\n    ThemedCard,\n    ThemedText,\n    ThemedEmptyState,\n    ThemedBadge,\n    ThemedAlert\n} from '@/app/(workspace)/components/ThemedComponents';\nimport { useTheme } from \"@/components/theme-provider\";\nimport { EtatsLieuxTour } from '@/components/gestion/tours/EtatsLieuxTour';\n\nconst statusConfig: Record<string, { label: string; variant: \"default\" | \"warning\" | \"success\"; icon: any }> = {\n    'draft': { label: 'Brouillon', variant: 'default', icon: Edit },\n    'completed': { label: 'Compl√©t√©', variant: 'warning', icon: Clock },\n    'signed': { label: 'Sign√©', variant: 'success', icon: CheckCircle },\n};\n\nconst typeLabels: Record<string, string> = {\n    'entry': 'Entr√©e',\n    'exit': 'Sortie',\n};\n\nexport function EtatsLieuxContent({ reports, error }: { reports: any[]; error: string | null }) {\n    const { isDark } = useTheme();\n\n    return (\n        <ThemedPage>\n            <EtatsLieuxTour />\n            {/* Header */}\n            <div className=\"flex items-center justify-between gap-2\">\n                <div className=\"flex items-center gap-2 sm:gap-3 min-w-0\">\n                    <Link\n                        href=\"/gestion\"\n                        className={`transition-colors shrink-0 ${isDark\n                            ? 'text-white/60 hover:text-white'\n                            : 'text-gray-500 hover:text-gray-900'\n                            }`}\n                    >\n                        <ArrowLeft className=\"w-5 h-5\" />\n                    </Link>\n                    <div className=\"min-w-0\">\n                        <ThemedText as=\"h1\" variant=\"primary\" className=\"text-lg sm:text-2xl font-semibold truncate\">\n                            √âtats des Lieux\n                        </ThemedText>\n                        <ThemedText as=\"p\" variant=\"muted\" className=\"text-sm\">\n                            {reports.length} rapport{reports.length !== 1 ? 's' : ''}\n                        </ThemedText>\n                    </div>\n                </div>\n                <div className=\"flex gap-1.5 sm:gap-2 shrink-0\">\n                    <div id=\"tour-edl-pdf\">\n                        <Button\n                            asChild\n                            size=\"sm\"\n                            variant=\"outline\"\n                            className={isDark\n                                ? 'border-slate-700 text-slate-300 hover:bg-slate-800 px-2 sm:px-3'\n                                : 'border-gray-300 text-gray-700 hover:bg-gray-100 px-2 sm:px-3'\n                            }\n                        >\n                            <Link href=\"/gestion/etats-lieux/formulaire-vierge\">\n                                <Printer className=\"w-4 h-4 sm:mr-2\" />\n                                <span className=\"hidden sm:inline\">PDF Vierge</span>\n                            </Link>\n                        </Button>\n                    </div>\n                    <div id=\"tour-edl-new\">\n                        <Button asChild size=\"sm\" className={`px-2 sm:px-3 ${isDark ? \"bg-[#F4C430] hover:bg-[#D4A420] text-black\" : \"bg-slate-900 hover:bg-slate-800 text-white\"}`}>\n                            <Link href=\"/gestion/etats-lieux/new\">\n                                <Plus className=\"w-4 h-4 sm:mr-2\" />\n                                <span className=\"hidden sm:inline\">Nouveau</span>\n                            </Link>\n                        </Button>\n                    </div>\n                </div>\n            </div>\n\n            {/* List */}\n            <div id=\"tour-edl-list\">\n                {error ? (\n                    <ThemedAlert variant=\"error\">\n                        Erreur: {error}\n                    </ThemedAlert>\n                ) : reports.length === 0 ? (\n                    <ThemedEmptyState\n                        icon={FileText}\n                        title=\"Aucun √©tat des lieux\"\n                        description=\"Cr√©ez votre premier √©tat des lieux pour documenter l'√©tat du bien √† l'entr√©e ou √† la sortie du locataire.\"\n                        action={\n                            <Button asChild className={isDark ? \"bg-[#F4C430] hover:bg-[#D4A420] text-black\" : \"bg-slate-900 hover:bg-slate-800 text-white\"}>\n                                <Link href=\"/gestion/etats-lieux/new\">\n                                    <Plus className=\"w-4 h-4 mr-2\" />\n                                    Cr√©er un √©tat des lieux\n                                </Link>\n                            </Button>\n                        }\n                    />\n                ) : (\n                    <div className=\"grid gap-3\">\n                        {reports.map((report, _index) => {\n                            const status = statusConfig[report.status] || statusConfig['draft'];\n                            const StatusIcon = status.icon;\n\n                            return (\n                                <ThemedCard\n                                    key={report.id}\n                                    hover\n                                    className=\"p-4 flex items-start justify-between gap-2 sm:gap-4 group overflow-hidden\"\n                                >\n                                    <Link\n                                        href={`/gestion/etats-lieux/${report.id}`}\n                                        className=\"flex-1 min-w-0 flex items-start justify-between gap-2 sm:gap-4\"\n                                    >\n                                        <div className=\"flex-1 min-w-0\">\n                                            <div className=\"flex items-center gap-2 mb-1\">\n                                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${report.type === 'entry'\n                                                    ? isDark\n                                                        ? 'bg-blue-500/20 text-blue-300'\n                                                        : 'bg-blue-100 text-blue-700'\n                                                    : isDark\n                                                        ? 'bg-orange-500/20 text-orange-300'\n                                                        : 'bg-slate-100 text-slate-700'\n                                                    }`}>\n                                                    {typeLabels[report.type]}\n                                                </span>\n                                                <ThemedBadge variant={status.variant}>\n                                                    <StatusIcon className=\"w-3 h-3\" />\n                                                    {status.label}\n                                                </ThemedBadge>\n                                            </div>\n\n                                            <ThemedText as=\"h3\" variant=\"primary\" className=\"font-medium truncate max-w-[200px] sm:max-w-none\">\n                                                {report.lease?.property_address || 'Adresse non renseign√©e'}\n                                            </ThemedText>\n                                            <ThemedText as=\"p\" variant=\"muted\" className=\"text-sm\">\n                                                {report.lease?.tenant_name || 'Locataire'}\n                                            </ThemedText>\n                                        </div>\n\n                                        <div className=\"text-right text-xs shrink-0 whitespace-nowrap\">\n                                            <ThemedText variant=\"muted\">\n                                                {format(new Date(report.report_date), 'd MMM yyyy', { locale: fr })}\n                                            </ThemedText>\n                                            {report.signed_at && (\n                                                <p className={`mt-1 ${isDark ? 'text-emerald-400' : 'text-emerald-600'\n                                                    }`}>\n                                                    Sign√© le {format(new Date(report.signed_at), 'd MMM', { locale: fr })}\n                                                </p>\n                                            )}\n                                        </div>\n                                    </Link>\n\n                                    <div className={`pl-2 border-l self-stretch flex items-center ${isDark ? 'border-slate-800' : 'border-gray-200'\n                                        }`}>\n                                        <DeleteInventoryButton id={report.id} />\n                                    </div>\n                                </ThemedCard>\n                            );\n                        })}\n                    </div>\n                )}\n            </div>\n        </ThemedPage>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\components\\InventoryEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1607,1610],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1607,1610],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":43,"column":8,"nodeType":"ArrayExpression","endLine":43,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport, reportId]","fix":{"range":[2101,2111],"text":"[loadReport, reportId]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":395,"column":57,"nodeType":"JSXOpeningElement","endLine":399,"endColumn":59}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { ArrowLeft, Save, Check, ChevronDown, ChevronUp, Camera, Trash2, Plus, Loader2, Zap, Droplets, Flame, Pen } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { toast } from 'sonner';\nimport { getInventoryReportById, updateInventoryReport, uploadInventoryPhoto } from '../actions';\nimport { type Room, type RoomItem, type MeterReadings } from '../types';\nimport { useTheme } from \"@/components/theme-provider\";\n\nconst CONDITION_OPTIONS = [\n    { value: 'bon', label: 'Bon', color: 'bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 border-emerald-500/50' },\n    { value: 'moyen', label: 'Moyen', color: 'bg-amber-500/20 text-amber-600 dark:text-amber-400 border-amber-500/50' },\n    { value: 'mauvais', label: 'Mauvais', color: 'bg-red-500/20 text-red-600 dark:text-red-400 border-red-500/50' },\n    { value: 'absent', label: 'Absent', color: 'bg-slate-500/20 text-slate-600 dark:text-slate-400 border-slate-500/50' },\n];\n\ninterface InventoryEditorProps {\n    reportId: string;\n}\n\nexport function InventoryEditor({ reportId }: InventoryEditorProps) {\n    const { isDark } = useTheme();\n    const router = useRouter();\n    const [loading, setLoading] = useState(true);\n    const [saving, setSaving] = useState(false);\n    const [uploadingPhoto, setUploadingPhoto] = useState(false);\n    const [report, setReport] = useState<any>(null);\n    const fileInputRef = useRef<HTMLInputElement>(null);\n    const [uploadTarget, setUploadTarget] = useState<{ roomIndex: number, itemIndex: number } | null>(null);\n\n    const [rooms, setRooms] = useState<Room[]>([]);\n    const [meterReadings, setMeterReadings] = useState<MeterReadings>({});\n    const [generalComments, setGeneralComments] = useState('');\n    const [expandedRoom, setExpandedRoom] = useState<number | null>(0);\n\n    useEffect(() => {\n        loadReport();\n    }, [reportId]);\n\n    const loadReport = async () => {\n        const result = await getInventoryReportById(reportId);\n        if (result.error) {\n            toast.error(result.error);\n            router.push('/etats-lieux');\n            return;\n        }\n\n        setReport(result.data);\n        setRooms(result.data?.rooms || []);\n        setMeterReadings(result.data?.meter_readings || {});\n        setGeneralComments(result.data?.general_comments || '');\n        setLoading(false);\n    };\n\n    const handleSave = async (markComplete = false) => {\n        setSaving(true);\n\n        const result = await updateInventoryReport(reportId, {\n            rooms,\n            meter_readings: meterReadings,\n            general_comments: generalComments,\n            status: markComplete ? 'completed' : 'draft'\n        });\n\n        if (result.error) {\n            toast.error(result.error);\n        } else {\n            toast.success(markComplete ? '√âtat des lieux compl√©t√© !' : 'Enregistr√©');\n            if (markComplete) {\n                router.push('/etats-lieux');\n            }\n        }\n\n        setSaving(false);\n    };\n\n    const handlePhotoClick = (roomIndex: number, itemIndex: number) => {\n        setUploadTarget({ roomIndex, itemIndex });\n        fileInputRef.current?.click();\n    };\n\n    const handlePhotoFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\n        const file = e.target.files?.[0];\n        if (!file || !uploadTarget) return;\n\n        setUploadingPhoto(true);\n        const { roomIndex, itemIndex } = uploadTarget;\n\n        try {\n            const formData = new FormData();\n            formData.append('file', file);\n\n            const result = await uploadInventoryPhoto(file, reportId);\n\n            if (result.error || !result.url) {\n                toast.error(result.error || \"Erreur upload\");\n            } else {\n                const newRooms = [...rooms];\n                const currentPhotos = newRooms[roomIndex].items[itemIndex].photos || [];\n                newRooms[roomIndex].items[itemIndex].photos = [...currentPhotos, result.url];\n                setRooms(newRooms);\n                toast.success(\"Photo ajout√©e\");\n            }\n        } catch (error) {\n            console.error(error);\n            toast.error(\"Erreur technique lors de l'upload\");\n        } finally {\n            setUploadingPhoto(false);\n            setUploadTarget(null);\n            if (fileInputRef.current) fileInputRef.current.value = '';\n        }\n    };\n\n    const removePhoto = (roomIndex: number, itemIndex: number, photoIndex: number) => {\n        const newRooms = [...rooms];\n        const photos = [...(newRooms[roomIndex].items[itemIndex].photos || [])];\n        photos.splice(photoIndex, 1);\n        newRooms[roomIndex].items[itemIndex].photos = photos;\n        setRooms(newRooms);\n    };\n\n    const updateItemCondition = (roomIndex: number, itemIndex: number, condition: string) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].items[itemIndex].condition = condition as RoomItem['condition'];\n        setRooms(newRooms);\n    };\n\n    const updateItemComment = (roomIndex: number, itemIndex: number, comment: string) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].items[itemIndex].comment = comment;\n        setRooms(newRooms);\n    };\n\n    const addRoom = () => {\n        const newRoom: Room = {\n            name: `Pi√®ce ${rooms.length + 1}`,\n            items: [\n                { name: 'Sol', condition: '', comment: '', photos: [] },\n                { name: 'Murs', condition: '', comment: '', photos: [] },\n                { name: 'Plafond', condition: '', comment: '', photos: [] },\n            ]\n        };\n        setRooms([...rooms, newRoom]);\n        setExpandedRoom(rooms.length);\n    };\n\n    const removeRoom = (roomIndex: number) => {\n        const newRooms = rooms.filter((_, i) => i !== roomIndex);\n        setRooms(newRooms);\n        setExpandedRoom(null);\n    };\n\n    const addItemToRoom = (roomIndex: number) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].items.push({\n            name: 'Nouvel √©l√©ment',\n            condition: '',\n            comment: '',\n            photos: []\n        });\n        setRooms(newRooms);\n    };\n\n    const updateRoomName = (roomIndex: number, name: string) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].name = name;\n        setRooms(newRooms);\n    };\n\n    const updateItemName = (roomIndex: number, itemIndex: number, name: string) => {\n        const newRooms = [...rooms];\n        newRooms[roomIndex].items[itemIndex].name = name;\n        setRooms(newRooms);\n    };\n\n    if (loading) {\n        return (\n            <div className=\"flex items-center justify-center min-h-[50vh]\">\n                <Loader2 className=\"w-8 h-8 text-primary animate-spin\" />\n            </div>\n        );\n    }\n\n    const completedItems = rooms.reduce((acc, room) =>\n        acc + room.items.filter(item => item.condition).length, 0\n    );\n    const totalItems = rooms.reduce((acc, room) => acc + room.items.length, 0);\n    const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;\n\n    return (\n        <div className=\"space-y-6 pb-24\">\n            {/* Header */}\n            <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                    <Link href=\"/etats-lieux\" className={`transition-colors ${isDark ? 'text-white/60 hover:text-white' : 'text-gray-500 hover:text-gray-900'}`}>\n                        <ArrowLeft className=\"w-5 h-5\" />\n                    </Link>\n                    <div>\n                        <h1 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                            √âtat des lieux {report?.type === 'entry' ? \"d'entr√©e\" : 'de sortie'}\n                        </h1>\n                        <p className={`text-sm ${isDark ? 'text-white/60' : 'text-gray-600'}`}>\n                            {report?.lease?.property_address} ‚Ä¢ {report?.lease?.tenant_name}\n                        </p>\n                    </div>\n                </div>\n            </div>\n\n            {/* On-site Instructions */}\n            <div className={`border rounded-xl p-4 ${isDark\n                ? 'bg-primary/10 border-primary/30'\n                : 'bg-muted border-border'\n                }`}>\n                <p className={`text-sm font-medium mb-1 ${isDark ? 'text-primary' : 'text-foreground'}`}>\n                    üìã Mode Contradictoire Recommand√©\n                </p>\n                <p className={`text-xs ${isDark ? 'text-slate-400' : 'text-muted-foreground'}`}>\n                    Ce constat doit √™tre rempli <strong>sur place</strong> avec le locataire pr√©sent.\n                    Visitez chaque pi√®ce ensemble et convenez de l&apos;√©tat avant de noter.\n                </p>\n            </div>\n\n            {/* Progress Bar */}\n            <div className={`border rounded-xl p-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <div className=\"flex items-center justify-between mb-2\">\n                    <span className={`text-sm ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>Progression</span>\n                    <span className={`text-sm font-medium ${isDark ? 'text-[#F4C430]' : 'text-slate-900'}`}>{progress}%</span>\n                </div>\n                <div className={`h-2 rounded-full overflow-hidden ${isDark ? 'bg-slate-800' : 'bg-gray-200'}`}>\n                    <div\n                        className={`h-full transition-all duration-300 ${isDark ? 'bg-[#F4C430]' : 'bg-slate-900'}`}\n                        style={{ width: `${progress}%` }}\n                    />\n                </div>\n                <p className={`text-xs mt-2 ${isDark ? 'text-slate-500' : 'text-gray-500'}`}>{completedItems}/{totalItems} √©l√©ments √©valu√©s</p>\n            </div>\n\n            {/* Meter Readings */}\n            <div className={`border rounded-xl p-4 space-y-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <h2 className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>Relev√©s de compteurs</h2>\n                <div className=\"grid grid-cols-3 gap-3\">\n                    <div>\n                        <label className={`flex items-center gap-1 text-xs mb-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            <Zap className=\"w-3 h-3\" /> √âlectricit√©\n                        </label>\n                        <Input\n                            type=\"number\"\n                            value={meterReadings.electricity || ''}\n                            onChange={(e) => setMeterReadings({ ...meterReadings, electricity: parseInt(e.target.value) || undefined })}\n                            placeholder=\"kWh\"\n                            className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-300 shadow-sm text-gray-900'}\n                        />\n                    </div>\n                    <div>\n                        <label className={`flex items-center gap-1 text-xs mb-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            <Droplets className=\"w-3 h-3\" /> Eau\n                        </label>\n                        <Input\n                            type=\"number\"\n                            value={meterReadings.water || ''}\n                            onChange={(e) => setMeterReadings({ ...meterReadings, water: parseInt(e.target.value) || undefined })}\n                            placeholder=\"m¬≥\"\n                            className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-300 shadow-sm text-gray-900'}\n                        />\n                    </div>\n                    <div>\n                        <label className={`flex items-center gap-1 text-xs mb-1 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                            <Flame className=\"w-3 h-3\" /> Gaz\n                        </label>\n                        <Input\n                            type=\"number\"\n                            value={meterReadings.gas || ''}\n                            onChange={(e) => setMeterReadings({ ...meterReadings, gas: parseInt(e.target.value) || undefined })}\n                            placeholder=\"m¬≥\"\n                            className={isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-300 shadow-sm text-gray-900'}\n                        />\n                    </div>\n                </div>\n            </div>\n\n            {/* Rooms */}\n            <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                    <h2 className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>Pi√®ces</h2>\n                    <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={addRoom}\n                        className={isDark ? \"text-[#F4C430] hover:text-[#F4C430]\" : \"text-slate-900 hover:text-slate-700\"}\n                    >\n                        <Plus className=\"w-4 h-4 mr-1\" /> Ajouter\n                    </Button>\n                </div>\n\n                {rooms.map((room, roomIndex) => (\n                    <div key={roomIndex} className={`border rounded-xl overflow-hidden ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                        {/* Room Header */}\n                        <button\n                            onClick={() => setExpandedRoom(expandedRoom === roomIndex ? null : roomIndex)}\n                            className=\"w-full flex items-center justify-between p-4 text-left\"\n                        >\n                            <div className=\"flex items-center gap-3\">\n                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-medium ${isDark ? 'bg-[#F4C430]/20 text-[#F4C430]' : 'bg-slate-100 text-slate-900'}`}>\n                                    {roomIndex + 1}\n                                </div>\n                                <div>\n                                    <p className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>{room.name}</p>\n                                    <p className={`text-xs ${isDark ? 'text-slate-400' : 'text-gray-500'}`}>\n                                        {room.items.filter(i => i.condition).length}/{room.items.length} √©l√©ments\n                                    </p>\n                                </div>\n                            </div>\n                            {expandedRoom === roomIndex ? (\n                                <ChevronUp className={`w-5 h-5 ${isDark ? 'text-slate-400' : 'text-gray-400'}`} />\n                            ) : (\n                                <ChevronDown className={`w-5 h-5 ${isDark ? 'text-slate-400' : 'text-gray-400'}`} />\n                            )}\n                        </button>\n\n                        {/* Room Content */}\n                        {expandedRoom === roomIndex && (\n                            <div className={`border-t p-4 space-y-4 ${isDark ? 'border-slate-800' : 'border-gray-200'}`}>\n                                {/* Room Name Edit */}\n                                <div className=\"flex items-center gap-2\">\n                                    <Input\n                                        value={room.name}\n                                        onChange={(e) => updateRoomName(roomIndex, e.target.value)}\n                                        className={`text-sm ${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-400 shadow-sm text-gray-900'}`}\n                                        placeholder=\"Nom de la pi√®ce\"\n                                    />\n                                    <Button\n                                        variant=\"ghost\"\n                                        size=\"sm\"\n                                        onClick={() => removeRoom(roomIndex)}\n                                        className=\"text-red-400 hover:text-red-300\"\n                                    >\n                                        <Trash2 className=\"w-4 h-4\" />\n                                    </Button>\n                                </div>\n\n                                {/* Items */}\n                                {room.items.map((item, itemIndex) => (\n                                    <div key={itemIndex} className={`rounded-lg p-3 space-y-2 ${isDark ? 'bg-slate-800/50' : 'bg-gray-50 border border-gray-200'}`}>\n                                        <Input\n                                            value={item.name}\n                                            onChange={(e) => updateItemName(roomIndex, itemIndex, e.target.value)}\n                                            className={`border-none p-0 font-medium text-sm h-auto focus-visible:ring-0 ${isDark ? 'bg-transparent text-white' : 'bg-transparent text-gray-900'}`}\n                                        />\n\n                                        {/* Condition Buttons */}\n                                        <div className=\"flex gap-1 items-center\">\n                                            {CONDITION_OPTIONS.map((option) => (\n                                                <button\n                                                    key={option.value}\n                                                    onClick={() => updateItemCondition(roomIndex, itemIndex, option.value)}\n                                                    className={`px-2 py-1 rounded text-xs font-medium border transition-all ${item.condition === option.value\n                                                        ? option.color\n                                                        : isDark\n                                                            ? 'bg-slate-700/50 text-slate-400 border-slate-600 hover:border-slate-500'\n                                                            : 'bg-gray-200 text-gray-600 border-gray-300 hover:border-gray-400'\n                                                        }`}\n                                                >\n                                                    {option.label}\n                                                </button>\n                                            ))}\n                                            <button\n                                                onClick={() => handlePhotoClick(roomIndex, itemIndex)}\n                                                disabled={uploadingPhoto}\n                                                className={`ml-1 p-1.5 rounded transition-all border ${(item.photos?.length || 0) > 0\n                                                    ? 'bg-blue-500/20 text-blue-400 border-blue-500'\n                                                    : isDark\n                                                        ? 'bg-slate-700/50 text-slate-400 border-slate-600 hover:text-white'\n                                                        : 'bg-gray-200 text-gray-500 border-gray-300 hover:text-gray-700'\n                                                    }`}\n                                                title=\"Ajouter une photo\"\n                                            >\n                                                {uploadingPhoto && uploadTarget?.roomIndex === roomIndex && uploadTarget?.itemIndex === itemIndex ? (\n                                                    <Loader2 className=\"w-3.5 h-3.5 animate-spin\" />\n                                                ) : (\n                                                    <Camera className=\"w-3.5 h-3.5\" />\n                                                )}\n                                            </button>\n                                        </div>\n\n                                        {/* Photos Preview */}\n                                        {item.photos && item.photos.length > 0 && (\n                                            <div className=\"flex gap-2 overflow-x-auto py-1\">\n                                                {item.photos.map((photo, pIndex) => (\n                                                    <div key={pIndex} className=\"relative group shrink-0\">\n                                                        <img\n                                                            src={photo}\n                                                            alt=\"√âtat\"\n                                                            className=\"h-12 w-12 object-cover rounded border border-slate-600\"\n                                                        />\n                                                        <button\n                                                            onClick={() => removePhoto(roomIndex, itemIndex, pIndex)}\n                                                            className=\"absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                                        >\n                                                            <Trash2 className=\"w-2 h-2\" />\n                                                        </button>\n                                                    </div>\n                                                ))}\n                                            </div>\n                                        )}\n\n                                        {/* Comment */}\n                                        <Input\n                                            value={item.comment}\n                                            onChange={(e) => updateItemComment(roomIndex, itemIndex, e.target.value)}\n                                            placeholder=\"Commentaire (optionnel)\"\n                                            className={`text-xs h-8 ${isDark ? 'bg-slate-700/50 border-slate-600 text-white' : 'bg-white border-gray-400 shadow-sm text-gray-900'}`}\n                                        />\n                                    </div>\n                                ))}\n\n                                {/* Add Item */}\n                                <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => addItemToRoom(roomIndex)}\n                                    className={`w-full border border-dashed ${isDark ? 'text-slate-400 hover:text-white border-slate-700' : 'text-gray-500 hover:text-gray-700 border-gray-300'}`}\n                                >\n                                    <Plus className=\"w-4 h-4 mr-1\" /> Ajouter un √©l√©ment\n                                </Button>\n                            </div>\n                        )}\n                    </div>\n                ))}\n            </div>\n\n            {/* General Comments */}\n            <div className={`border rounded-xl p-4 space-y-3 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <h2 className={`font-medium flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                    <Pen className={`w-4 h-4 ${isDark ? 'text-[#F4C430]' : 'text-slate-900'}`} />\n                    Observations g√©n√©rales\n                </h2>\n                <Textarea\n                    value={generalComments}\n                    onChange={(e) => setGeneralComments(e.target.value)}\n                    placeholder=\"Remarques g√©n√©rales sur l'√©tat du logement...\"\n                    className={`min-h-[100px] ${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-gray-400 shadow-sm text-gray-900'}`}\n                />\n            </div>\n\n            {/* Fixed Bottom Bar */}\n            <div className=\"fixed bottom-0 left-0 right-0 p-4 transform transition-all bg-transparent\">\n                <div className=\"max-w-3xl mx-auto flex gap-3\">\n                    <Button\n                        variant=\"outline\"\n                        onClick={() => handleSave(false)}\n                        disabled={saving}\n                        className={isDark ? 'flex-1 border-slate-700 bg-slate-800 hover:bg-slate-700 text-white' : 'flex-1 border-gray-400 bg-white shadow-sm hover:bg-gray-50 text-gray-900'}\n                    >\n                        {saving ? <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> : <Save className=\"w-4 h-4 mr-2\" />}\n                        Enregistrer\n                    </Button>\n\n                    {report?.status === 'completed' || report?.status === 'signed' ? (\n                        <Button\n                            asChild\n                            className={`flex-1 ${isDark ? 'bg-[#F4C430] hover:bg-[#D4A420] text-black' : 'bg-slate-900 text-white hover:bg-slate-800'}`}\n                        >\n                            <Link href={`/gestion/etats-lieux/${reportId}/sign`}>\n                                <Check className=\"w-4 h-4 mr-2\" />\n                                Signatures\n                            </Link>\n                        </Button>\n                    ) : (\n                        <Button\n                            onClick={() => handleSave(true)}\n                            disabled={saving || progress < 100}\n                            className={`flex-1 ${isDark ? 'bg-[#F4C430] hover:bg-[#D4A420] text-black' : 'bg-slate-900 text-white hover:bg-slate-800'}`}\n                        >\n                            <Check className=\"w-4 h-4 mr-2\" />\n                            {progress < 100 ? `Terminer (${progress}%)` : 'Terminer'}\n                        </Button>\n                    )}\n                </div>\n            </div>\n\n            <input\n                type=\"file\"\n                ref={fileInputRef}\n                className=\"hidden\"\n                accept=\"image/*\"\n                onChange={handlePhotoFileChange}\n            />\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\components\\SignatureCanvas.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\components\\SignaturePage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[849,852],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[849,852],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadReport` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\components\\SignaturePage.tsx:29:9\n  27 |\n  28 |     useEffect(() => {\n> 29 |         loadReport();\n     |         ^^^^^^^^^^ `loadReport` accessed before it is declared\n  30 |     }, [reportId]);\n  31 |\n  32 |     const loadReport = async () => {\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\components\\SignaturePage.tsx:32:5\n  30 |     }, [reportId]);\n  31 |\n> 32 |     const loadReport = async () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 33 |         // Fetch report and owner's saved signature in parallel\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 34 |         const [reportResult, signatureResult] = await Promise.all([\n     ‚Ä¶\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 57 |         setLoading(false);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 58 |     };\n     | ^^^^^^^ `loadReport` is declared here\n  59 |\n  60 |     const handleSign = async () => {\n  61 |         if (!ownerSignature || !tenantSignature) {","line":29,"column":9,"nodeType":null,"endLine":29,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":30,"column":8,"nodeType":"ArrayExpression","endLine":30,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport, reportId]","fix":{"range":[1129,1139],"text":"[loadReport, reportId]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { ArrowLeft, FileText, Loader2, Check, Download, UserCheck } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { toast } from 'sonner';\nimport { getInventoryReportById, signInventoryReport, getOwnerSignature } from '../actions';\nimport { SignatureCanvas } from '../components/SignatureCanvas';\nimport { useTheme } from \"@/components/theme-provider\";\n\ninterface SignaturePageProps {\n    reportId: string;\n}\n\nexport function SignaturePage({ reportId }: SignaturePageProps) {\n    const { isDark } = useTheme();\n    const router = useRouter();\n    const [loading, setLoading] = useState(true);\n    const [saving, setSaving] = useState(false);\n    const [report, setReport] = useState<any>(null);\n    const [savedOwnerSignature, setSavedOwnerSignature] = useState<string | null>(null);\n\n    const [ownerSignature, setOwnerSignature] = useState('');\n    const [tenantSignature, setTenantSignature] = useState('');\n\n    useEffect(() => {\n        loadReport();\n    }, [reportId]);\n\n    const loadReport = async () => {\n        // Fetch report and owner's saved signature in parallel\n        const [reportResult, signatureResult] = await Promise.all([\n            getInventoryReportById(reportId),\n            getOwnerSignature()\n        ]);\n\n        if (reportResult.error) {\n            toast.error(reportResult.error);\n            router.push('/etats-lieux');\n            return;\n        }\n\n        setReport(reportResult.data);\n\n        // If report already has signatures, use them\n        if (reportResult.data?.owner_signature) {\n            setOwnerSignature(reportResult.data.owner_signature);\n        } else if (signatureResult.signature_url) {\n            // Otherwise use saved signature from profile\n            setOwnerSignature(signatureResult.signature_url);\n            setSavedOwnerSignature(signatureResult.signature_url);\n        }\n\n        setTenantSignature(reportResult.data?.tenant_signature || '');\n        setLoading(false);\n    };\n\n    const handleSign = async () => {\n        if (!ownerSignature || !tenantSignature) {\n            toast.error('Les deux signatures sont requises');\n            return;\n        }\n\n        setSaving(true);\n\n        const result = await signInventoryReport(reportId, {\n            owner_signature: ownerSignature,\n            tenant_signature: tenantSignature\n        });\n\n        if (result.error) {\n            toast.error(result.error);\n        } else {\n            toast.success('√âtat des lieux sign√© !');\n            router.push(`/gestion/etats-lieux/${reportId}/pdf`);\n        }\n\n        setSaving(false);\n    };\n\n    if (loading) {\n        return (\n            <div className=\"flex items-center justify-center min-h-[50vh]\">\n                <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\n            </div>\n        );\n    }\n\n    const isAlreadySigned = report?.status === 'signed';\n\n    return (\n        <div className=\"space-y-6 pb-8\">\n            {/* Header */}\n            <div className=\"flex items-center gap-4\">\n                <Link href={`/gestion/etats-lieux/${reportId}`} className={`transition-colors ${isDark ? 'text-white/60 hover:text-white' : 'text-gray-500 hover:text-gray-900'}`}>\n                    <ArrowLeft className=\"w-5 h-5\" />\n                </Link>\n                <div>\n                    <h1 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>Signatures</h1>\n                    <p className={`text-sm ${isDark ? 'text-white/60' : 'text-gray-600'}`}>\n                        {report?.lease?.property_address} ‚Ä¢ {report?.lease?.tenant_name}\n                    </p>\n                </div>\n            </div>\n\n            {isAlreadySigned ? (\n                <div className=\"bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6 text-center\">\n                    <Check className=\"w-12 h-12 text-emerald-400 mx-auto mb-3\" />\n                    <h3 className={`text-lg font-medium mb-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>Document sign√©</h3>\n                    <p className={`text-sm mb-4 ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                        Cet √©tat des lieux a √©t√© sign√© le {new Date(report.signed_at).toLocaleDateString('fr-FR')}\n                    </p>\n                    <Button asChild className=\"bg-[#F4C430] hover:bg-[#D4A420] text-black\">\n                        <Link href={`/gestion/etats-lieux/${reportId}/pdf`}>\n                            <Download className=\"w-4 h-4 mr-2\" />\n                            T√©l√©charger le PDF\n                        </Link>\n                    </Button>\n                </div>\n            ) : (\n                <>\n                    {/* Info */}\n                    <div className=\"bg-[#F4C430]/10 border border-[#F4C430]/30 rounded-xl p-4\">\n                        <p className=\"text-sm text-[#F4C430]\">\n                            <FileText className=\"w-4 h-4 inline mr-2\" />\n                            Votre signature est pr√©-remplie. Le locataire signe sur place lors de l&apos;√©tat des lieux.\n                        </p>\n                    </div>\n\n                    {/* Owner Signature */}\n                    <div className={`border rounded-xl p-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                        {savedOwnerSignature && ownerSignature === savedOwnerSignature && (\n                            <div className=\"flex items-center gap-2 text-emerald-400 text-sm mb-3 bg-emerald-500/10 rounded-lg px-3 py-2\">\n                                <UserCheck className=\"w-4 h-4\" />\n                                ‚úÖ Signature import√©e depuis votre configuration\n                            </div>\n                        )}\n                        <SignatureCanvas\n                            label=\"‚úçÔ∏è Signature du Propri√©taire (ou mandataire)\"\n                            existingSignature={ownerSignature}\n                            onSave={setOwnerSignature}\n                        />\n                    </div>\n\n                    {/* Tenant Signature */}\n                    <div className={`border rounded-xl p-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                        <div className=\"flex items-center gap-2 text-blue-400 text-sm mb-3 bg-blue-500/10 rounded-lg px-3 py-2\">\n                            <FileText className=\"w-4 h-4\" />\n                            üëá Passez l&apos;appareil au locataire pour signature\n                        </div>\n                        <SignatureCanvas\n                            label=\"‚úçÔ∏è Signature du Locataire\"\n                            existingSignature={tenantSignature}\n                            onSave={setTenantSignature}\n                        />\n                    </div>\n\n                    {/* Sign Button */}\n                    <Button\n                        onClick={handleSign}\n                        disabled={saving || !ownerSignature || !tenantSignature}\n                        className=\"w-full h-12 bg-[#F4C430] hover:bg-[#D4A420] text-black font-semibold\"\n                    >\n                        {saving ? (\n                            <>\n                                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                                Validation...\n                            </>\n                        ) : (\n                            <>\n                                <Check className=\"w-4 h-4 mr-2\" />\n                                Valider et G√©n√©rer le PDF\n                            </>\n                        )}\n                    </Button>\n                </>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\components\\ThemedPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\formulaire-vierge\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":114,"column":29,"nodeType":"JSXOpeningElement","endLine":118,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useRef, useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport { ArrowLeft, Printer, FileText, Building, Check } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { PROPERTY_TEMPLATES, PROPERTY_TYPE_LABELS, type PropertyType } from '../types';\nimport { getAgencyBranding } from '../actions';\n\nconst PROPERTY_ICONS: Record<PropertyType, string> = {\n    'chambre': 'üõèÔ∏è',\n    'studio': 'üè†',\n    'f2': 'üè¢',\n    'f3': 'üè¢',\n    'f4': 'üè¢',\n    'villa': 'üè°',\n    'custom': '‚öôÔ∏è',\n};\n\n// Map items to string for the blank form\nconst getRoomItems = (type: PropertyType) => {\n    const rooms = PROPERTY_TEMPLATES[type] || PROPERTY_TEMPLATES['f2'];\n    return rooms.map(room => ({\n        name: room.name,\n        items: room.items.map(item => item.name)\n    }));\n};\n\nexport default function BlankPDFPage() {\n    const printRef = useRef<HTMLDivElement>(null);\n    const [selectedType, setSelectedType] = useState<PropertyType>('f2');\n    const [agencyBranding, setAgencyBranding] = useState<{ name: string | null, logo: string | null } | null>(null);\n\n    useEffect(() => {\n        const fetchBranding = async () => {\n            const result = await getAgencyBranding();\n            if (result && !('error' in result)) {\n                setAgencyBranding({\n                    name: result.agency_name,\n                    logo: result.logo_url\n                });\n            }\n        };\n        fetchBranding();\n    }, []);\n\n    const handlePrint = () => {\n        window.print();\n    };\n\n    const rooms = getRoomItems(selectedType);\n\n    return (\n        <div className=\"space-y-6\">\n            {/* Header - Hidden on print */}\n            <div className=\"flex items-center justify-between print:hidden\">\n                <div className=\"flex items-center gap-4\">\n                    <Link href=\"/etats-lieux\" className=\"text-white/60 hover:text-white transition-colors\">\n                        <ArrowLeft className=\"w-5 h-5\" />\n                    </Link>\n                    <div>\n                        <h1 className=\"text-xl font-semibold text-white\">Formulaire Vierge</h1>\n                        <p className=\"text-sm text-white/60\">√âtat des lieux √† imprimer</p>\n                    </div>\n                </div>\n                <Button onClick={handlePrint} className=\"bg-[#F4C430] hover:bg-[#D4A420] text-black\">\n                    <Printer className=\"w-4 h-4 mr-2\" />\n                    Imprimer / T√©l√©charger PDF\n                </Button>\n            </div>\n\n            {/* Type Selector - Hidden on print */}\n            <div className=\"bg-slate-900 border border-slate-800 rounded-xl p-4 print:hidden space-y-3\">\n                <div className=\"flex items-center gap-2 text-white font-medium\">\n                    <Building className=\"w-4 h-4 text-[#F4C430]\" />\n                    <span>Choisir le type de bien pour le mod√®le :</span>\n                </div>\n                <div className=\"flex flex-wrap gap-2\">\n                    {(Object.keys(PROPERTY_TYPE_LABELS) as PropertyType[]).map((type) => (\n                        <button\n                            key={type}\n                            onClick={() => setSelectedType(type)}\n                            className={`flex items-center gap-2 px-3 py-2 rounded-lg border text-sm transition-all ${selectedType === type\n                                ? 'bg-[#F4C430] border-[#F4C430] text-black font-medium'\n                                : 'bg-slate-800 border-slate-700 text-slate-300 hover:border-slate-600'\n                                }`}\n                        >\n                            <span>{PROPERTY_ICONS[type]}</span>\n                            {PROPERTY_TYPE_LABELS[type]}\n                            {selectedType === type && <Check className=\"w-3 h-3 ml-1\" />}\n                        </button>\n                    ))}\n                </div>\n                <div className=\"bg-blue-500/10 border border-blue-500/30 rounded-lg p-3\">\n                    <p className=\"text-sm text-blue-400\">\n                        <FileText className=\"w-4 h-4 inline mr-2\" />\n                        Le formulaire ci-dessous s&apos;adapte automatiquement au type de bien s√©lectionn√© ({PROPERTY_TYPE_LABELS[selectedType]}).\n                    </p>\n                </div>\n            </div>\n\n            {/* PDF Content - Blank Professional Template */}\n            <div\n                id=\"print-content\"\n                ref={printRef}\n                className=\"bg-white text-black rounded-xl p-6 print:p-0 print:rounded-none max-w-4xl mx-auto print:max-w-none text-xs print:w-full print:absolute print:top-0 print:left-0\"\n                style={{ fontFamily: 'Arial, sans-serif' }}\n            >\n                {/* Agency Header (Visible on print) */}\n                <div className=\"hidden print:flex justify-between items-start border-b border-black pb-4 mb-4\">\n                    {/* Logo √† gauche */}\n                    <div className=\"w-1/3\">\n                        {agencyBranding?.logo && (\n                            <img\n                                src={agencyBranding.logo}\n                                alt=\"Logo Agence\"\n                                className=\"h-16 w-auto object-contain object-left\"\n                            />\n                        )}\n                    </div>\n\n                    {/* Informations √† droite */}\n                    <div className=\"w-2/3 text-right\">\n                        <p className=\"font-bold text-xl uppercase tracking-tight\">\n                            {agencyBranding?.name || 'DOUSSEL IMMO'}\n                        </p>\n                        <p className=\"text-xs text-gray-600 mb-2\">\n                            Gestion Locative & Immobili√®re\n                        </p>\n                        <div className=\"inline-block border border-gray-400 px-3 py-1 mt-1\">\n                            <p className=\"font-bold text-sm uppercase\">{PROPERTY_TYPE_LABELS[selectedType]}</p>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Title Header */}\n                <div className=\"bg-gray-200 text-center py-2 mb-6 border-y border-gray-400\">\n                    <h1 className=\"text-lg font-bold uppercase tracking-widest\">\n                        √âtat des Lieux et Inventaire\n                    </h1>\n                </div>\n\n                {/* Property Info - Blank fields */}\n                <div className=\"mb-6 space-y-3 text-sm\">\n                    <p>\n                        <strong>Type :</strong>{' '}\n                        <span className=\"inline-block mr-4\">‚òê Entr√©e</span>\n                        <span className=\"inline-block\">‚òê Sortie</span>\n                    </p>\n                    <p>\n                        <strong>Adresse du bien :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '350px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                    <p>\n                        <strong>Nom du locataire :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '250px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                    <p>\n                        <strong>Date de l&apos;√©tat des lieux :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '150px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                </div>\n\n                {/* Meter Readings */}\n                <div className=\"mb-4 flex flex-wrap gap-x-6 text-sm\">\n                    <p>\n                        <strong>Compteur √©lectricit√© :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '80px' }}>\n                            &nbsp;\n                        </span>{' '}\n                        kWh\n                    </p>\n                    <p>\n                        <strong>Compteur eau :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '80px' }}>\n                            &nbsp;\n                        </span>{' '}\n                        m¬≥\n                    </p>\n                </div>\n\n                {/* Legend */}\n                <div className=\"mb-3 text-xs bg-gray-100 p-2\">\n                    <strong>L√©gende :</strong> TB = Tr√®s Bon | B = Bon | M = Moyen | D = D√©grad√©/Absent\n                </div>\n\n                {/* Rooms Tables */}\n                {rooms.map((room, roomIndex) => (\n                    <div key={roomIndex} className=\"mb-4 break-inside-avoid\">\n                        <h3 className=\"font-bold bg-gray-200 border border-gray-400 px-2 py-1 uppercase text-xs\">\n                            {room.name}\n                        </h3>\n                        <table className=\"w-full border-collapse border border-gray-400 text-xs\">\n                            <thead>\n                                <tr className=\"bg-gray-100\">\n                                    <th className=\"border border-gray-400 px-2 py-1 text-left font-medium\" style={{ width: '30%' }}>\n                                        √âl√©ment\n                                    </th>\n                                    <th className=\"border border-gray-400 px-1 py-1 text-center font-medium\" style={{ width: '8%' }}>TB</th>\n                                    <th className=\"border border-gray-400 px-1 py-1 text-center font-medium\" style={{ width: '8%' }}>B</th>\n                                    <th className=\"border border-gray-400 px-1 py-1 text-center font-medium\" style={{ width: '8%' }}>M</th>\n                                    <th className=\"border border-gray-400 px-1 py-1 text-center font-medium\" style={{ width: '8%' }}>D</th>\n                                    <th className=\"border border-gray-400 px-2 py-1 text-left font-medium\">\n                                        Commentaires\n                                    </th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                {room.items.map((item, itemIndex) => (\n                                    <tr key={itemIndex}>\n                                        <td className=\"border border-gray-400 px-2 py-1\">{item}</td>\n                                        <td className=\"border border-gray-400 px-1 py-1 text-center\">‚òê</td>\n                                        <td className=\"border border-gray-400 px-1 py-1 text-center\">‚òê</td>\n                                        <td className=\"border border-gray-400 px-1 py-1 text-center\">‚òê</td>\n                                        <td className=\"border border-gray-400 px-1 py-1 text-center\">‚òê</td>\n                                        <td className=\"border border-gray-400 px-2 py-1\">&nbsp;</td>\n                                    </tr>\n                                ))}\n                            </tbody>\n                        </table>\n                    </div>\n                ))}\n\n                {/* Inventaire Section */}\n                <div className=\"mb-4 break-inside-avoid\">\n                    <h3 className=\"font-bold uppercase mb-2 text-sm\">Inventaire du mobilier :</h3>\n                    <table className=\"w-full border-collapse border border-gray-400 text-xs\">\n                        <tbody>\n                            {[1, 2, 3, 4, 5, 6, 7, 8].map((i) => (\n                                <tr key={i}>\n                                    <td className=\"border border-gray-400 px-2 py-2\">&nbsp;</td>\n                                </tr>\n                            ))}\n                        </tbody>\n                    </table>\n                </div>\n\n                {/* Commentaires Contradictoires */}\n                <div className=\"mb-4\">\n                    <h3 className=\"font-bold uppercase mb-2 text-sm\">Commentaires Contradictoires :</h3>\n                    <div className=\"border border-gray-400 min-h-[50px] p-2\">&nbsp;</div>\n                </div>\n\n                {/* Keys and Final Info */}\n                <div className=\"mb-4 space-y-2 text-sm\">\n                    <p>\n                        <strong>Clefs remises au nombre de :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '40px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                    <p>\n                        <strong>Fait √† :</strong>{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '120px' }}>\n                            &nbsp;\n                        </span>\n                        , le{' '}\n                        <span className=\"border-b border-black inline-block\" style={{ minWidth: '120px' }}>\n                            &nbsp;\n                        </span>\n                    </p>\n                </div>\n\n                {/* Signatures Section */}\n                <div className=\"grid grid-cols-2 gap-6 mt-6 pt-4 border-t border-gray-400\">\n                    <div className=\"text-center\">\n                        <p className=\"font-bold mb-1 text-sm\">Le Bailleur (ou son mandataire)</p>\n                        <p className=\"text-xs text-gray-500 mb-2\">Lu et approuv√©</p>\n                        <div className=\"border border-gray-400 h-20\">&nbsp;</div>\n                    </div>\n                    <div className=\"text-center\">\n                        <p className=\"font-bold mb-1 text-sm\">Le(s) Locataire(s)</p>\n                        <p className=\"text-xs text-gray-500 mb-2\">Lu et approuv√©</p>\n                        <div className=\"border border-gray-400 h-20\">&nbsp;</div>\n                    </div>\n                </div>\n\n                {/* Footer */}\n                <div className=\"mt-6 pt-2 border-t border-gray-200 text-center text-xs text-gray-400\">\n                    <span>Formulaire Doussel Immo - {PROPERTY_TYPE_LABELS[selectedType]}</span>\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\new\\page.tsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadLeases` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\new\\page.tsx:50:9\n  48 |\n  49 |     useEffect(() => {\n> 50 |         loadLeases();\n     |         ^^^^^^^^^^ `loadLeases` accessed before it is declared\n  51 |     }, []);\n  52 |\n  53 |     const loadLeases = async () => {\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\new\\page.tsx:53:5\n  51 |     }, []);\n  52 |\n> 53 |     const loadLeases = async () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 54 |         const result = await getLeasesForInventory();\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 55 |         if (result.error) {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 56 |             toast.error(result.error);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 57 |         } else {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 58 |             setLeases(result.data);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 59 |         }\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 60 |         setLoading(false);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 61 |     };\n     | ^^^^^^^ `loadLeases` is declared here\n  62 |\n  63 |     const handleCreate = async () => {\n  64 |         if (!selectedLeaseId) {","line":50,"column":9,"nodeType":null,"endLine":50,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { ArrowLeft, ArrowRight, Home, Loader2, Building } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { toast } from 'sonner';\nimport { createInventoryReport, getLeasesForInventory } from '../actions';\nimport { PropertyType, PROPERTY_TYPE_LABELS } from '../types';\nimport { useTheme } from \"@/components/theme-provider\";\n\ntype Lease = {\n    id: string;\n    tenant_name: string;\n    property_address: string;\n    status: string;\n};\n\nconst PROPERTY_ICONS: Record<PropertyType, string> = {\n    'chambre': 'üõèÔ∏è',\n    'studio': 'üè†',\n    'f2': 'üè¢',\n    'f3': 'üè¢',\n    'f4': 'üè¢',\n    'villa': 'üè°',\n    'custom': '‚öôÔ∏è',\n};\n\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\"\n\nexport default function NewInventoryReportPage() {\n    const { isDark } = useTheme();\n    const router = useRouter();\n    const [leases, setLeases] = useState<Lease[]>([]);\n    const [loading, setLoading] = useState(true);\n    const [creating, setCreating] = useState(false);\n\n    const [selectedLeaseId, setSelectedLeaseId] = useState<string>('');\n    const [reportType, setReportType] = useState<'entry' | 'exit'>('entry');\n    const [propertyType, setPropertyType] = useState<PropertyType>('studio');\n\n    useEffect(() => {\n        loadLeases();\n    }, []);\n\n    const loadLeases = async () => {\n        const result = await getLeasesForInventory();\n        if (result.error) {\n            toast.error(result.error);\n        } else {\n            setLeases(result.data);\n        }\n        setLoading(false);\n    };\n\n    const handleCreate = async () => {\n        if (!selectedLeaseId) {\n            toast.error('Veuillez s√©lectionner un bail');\n            return;\n        }\n\n        setCreating(true);\n        const result = await createInventoryReport({\n            leaseId: selectedLeaseId,\n            type: reportType,\n            propertyType: propertyType\n        });\n\n        if (result.error) {\n            toast.error(result.error);\n            setCreating(false);\n        } else if (result.data) {\n            toast.success('√âtat des lieux cr√©√© !');\n            router.push(`/gestion/etats-lieux/${result.data.id}`);\n        }\n    };\n\n    const selectedLease = leases.find(l => l.id === selectedLeaseId);\n\n    if (loading) {\n        return (\n            <div className=\"flex items-center justify-center min-h-[50vh]\">\n                <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"max-w-xl mx-auto space-y-6\">\n            {/* Header */}\n            <div className=\"flex items-center gap-4\">\n                <Link href=\"/gestion/etats-lieux\" className={`transition-colors ${isDark ? 'text-white/60 hover:text-white' : 'text-gray-500 hover:text-gray-900'}`}>\n                    <ArrowLeft className=\"w-5 h-5\" />\n                </Link>\n                <div>\n                    <h1 className={`text-2xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>Nouvel √âtat des Lieux</h1>\n                    <p className={`text-sm mt-1 ${isDark ? 'text-white/60' : 'text-gray-600'}`}>S√©lectionnez le bail et le type de bien</p>\n                </div>\n            </div>\n\n            {/* Step 1: Select Lease */}\n            <div className={`border rounded-xl p-5 space-y-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <h2 className={`font-medium flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                    <Home className=\"w-4 h-4 text-[#F4C430]\" />\n                    1. S√©lectionner le bail\n                </h2>\n\n                {leases.length === 0 ? (\n                    <div className={`rounded-lg p-4 text-center ${isDark ? 'bg-slate-800/50' : 'bg-gray-100'}`}>\n                        <p className={`text-sm ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>Aucun bail trouv√©</p>\n                        <Link href=\"/gestion\" className=\"text-[#F4C430] text-sm hover:underline mt-2 block\">\n                            Cr√©er un bail\n                        </Link>\n                    </div>\n                ) : (\n                    <Select value={selectedLeaseId} onValueChange={setSelectedLeaseId}>\n                        <SelectTrigger className={`w-full ${isDark ? 'bg-slate-800 border-slate-700' : ''}`}>\n                            <SelectValue placeholder=\"Choisir un bail...\" />\n                        </SelectTrigger>\n                        <SelectContent className={`${isDark ? 'bg-slate-800 border-slate-700 text-white' : ''} max-w-[calc(100vw-2rem)]`}>\n                            {leases.map((lease) => (\n                                <SelectItem key={lease.id} value={lease.id}>\n                                    <div className=\"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 max-w-full overflow-hidden\">\n                                        <span className=\"font-medium truncate\">{lease.property_address || 'Adresse inconnue'}</span>\n                                        <span className=\"text-muted-foreground text-xs sm:text-sm truncate\">({lease.tenant_name})</span>\n                                    </div>\n                                </SelectItem>\n                            ))}\n                        </SelectContent>\n                    </Select>\n                )}\n            </div>\n\n            {/* Step 2: Select Property Type */}\n            <div className={`border rounded-xl p-5 space-y-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <h2 className={`font-medium flex items-center gap-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>\n                    <Building className=\"w-4 h-4 text-[#F4C430]\" />\n                    2. Type de bien\n                </h2>\n                <p className={`text-xs -mt-2 ${isDark ? 'text-slate-400' : 'text-gray-500'}`}>\n                    Le formulaire s&apos;adapte automatiquement au type de bien\n                </p>\n\n                <div className=\"grid grid-cols-3 gap-2\">\n                    {(['chambre', 'studio', 'f2', 'f3', 'villa'] as PropertyType[]).map((type) => (\n                        <button\n                            key={type}\n                            onClick={() => setPropertyType(type)}\n                            className={`p-3 rounded-lg border text-center transition-all ${propertyType === type\n                                ? 'bg-purple-500/20 border-purple-500 text-white'\n                                : isDark\n                                    ? 'bg-slate-800/50 border-slate-700 text-slate-400 hover:border-slate-600'\n                                    : 'bg-gray-50 border-gray-300 text-gray-600 hover:border-gray-400'\n                                }`}\n                        >\n                            <span className=\"text-xl block mb-1\">{PROPERTY_ICONS[type]}</span>\n                            <span className=\"text-xs font-medium\">{PROPERTY_TYPE_LABELS[type]}</span>\n                        </button>\n                    ))}\n                </div>\n            </div>\n\n            {/* Step 3: Select Entry/Exit Type */}\n            <div className={`border rounded-xl p-5 space-y-4 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>\n                <h2 className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>3. Type d&apos;√©tat des lieux</h2>\n\n                <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                        onClick={() => setReportType('entry')}\n                        className={`p-4 rounded-xl border text-center transition-all ${reportType === 'entry'\n                            ? 'bg-blue-500/20 border-blue-500 text-white'\n                            : isDark\n                                ? 'bg-slate-800/50 border-slate-700 text-slate-400 hover:border-slate-600'\n                                : 'bg-gray-50 border-gray-300 text-gray-600 hover:border-gray-400'\n                            }`}\n                    >\n                        <span className=\"text-2xl block mb-2\">üîë</span>\n                        <span className=\"font-medium\">Entr√©e</span>\n                        <p className=\"text-xs mt-1 opacity-70\">Remise des cl√©s</p>\n                    </button>\n\n                    <button\n                        onClick={() => setReportType('exit')}\n                        className={`p-4 rounded-xl border text-center transition-all ${reportType === 'exit'\n                            ? 'bg-orange-500/20 border-orange-500 text-white'\n                            : isDark\n                                ? 'bg-slate-800/50 border-slate-700 text-slate-400 hover:border-slate-600'\n                                : 'bg-gray-50 border-gray-300 text-gray-600 hover:border-gray-400'\n                            }`}\n                    >\n                        <span className=\"text-2xl block mb-2\">üö™</span>\n                        <span className=\"font-medium\">Sortie</span>\n                        <p className=\"text-xs mt-1 opacity-70\">D√©part du locataire</p>\n                    </button>\n                </div>\n            </div>\n\n            {/* Summary & Create */}\n            {selectedLease && (\n                <div className=\"bg-[#F4C430]/10 border border-[#F4C430]/30 rounded-xl p-4\">\n                    <p className=\"text-sm text-[#F4C430] mb-1\">R√©capitulatif</p>\n                    <p className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>{selectedLease.property_address}</p>\n                    <p className={`text-sm ${isDark ? 'text-slate-400' : 'text-gray-600'}`}>\n                        {selectedLease.tenant_name} ‚Ä¢ {PROPERTY_TYPE_LABELS[propertyType]} ‚Ä¢ {reportType === 'entry' ? \"Entr√©e\" : 'Sortie'}\n                    </p>\n                </div>\n            )}\n\n            <Button\n                onClick={handleCreate}\n                disabled={!selectedLeaseId || creating}\n                className=\"w-full h-12 bg-[#F4C430] hover:bg-[#D4A420] text-black font-semibold\"\n            >\n                {creating ? (\n                    <>\n                        <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                        Cr√©ation...\n                    </>\n                ) : (\n                    <>\n                        Commencer l&apos;√©tat des lieux\n                        <ArrowRight className=\"w-4 h-4 ml-2\" />\n                    </>\n                )}\n            </Button>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\etats-lieux\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\interventions\\InterventionsPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\interventions\\page.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":58,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":58,"endColumn":58,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[2265,2314],"text":"// @ts-expect-error - Supabase join types can be tricky"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":60,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":60,"endColumn":22,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[2401,2414],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3879,3882],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3879,3882],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { InterventionsPageClient } from \"./InterventionsPageClient\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { redirect } from \"next/navigation\";\nimport { getUserTeamContext } from \"@/lib/team-context\";\nimport { checkFeatureAccess } from \"@/lib/subscription/team-subscription\";\nimport { FeatureLockedState } from \"@/components/gestion/FeatureLockedState\";\nimport { markMaintenanceAsViewed } from \"@/lib/unread-counts\";\n\nexport default async function InterventionsPage() {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n        redirect('/auth');\n    }\n\n    const { teamId } = await getUserTeamContext();\n\n    // ‚úÖ CHECK FEATURE: Interventions\n    const access = await checkFeatureAccess(teamId, \"manage_interventions\");\n    if (!access.allowed) {\n        return (\n            <FeatureLockedState\n                title=\"Gestion des Incidents & Interventions\"\n                description=\"Centralisez les demandes de maintenance, assignez des artisans et suivez les interventions en temps r√©el.\"\n                requiredTier=\"pro\"\n            />\n        );\n    }\n\n    // R√©cup√©rer les demandes de maintenance (avec infos artisan, bien et locataire)\n    const { data: maintenanceData, error: maintenanceError } = await supabase\n        .from('maintenance_requests')\n        .select(`\n            id, description, status, created_at, photo_urls,\n            artisan_name, artisan_phone, artisan_rating, artisan_address,\n            quoted_price, quote_url, category, intervention_date, owner_approved,\n            tenant_response, tenant_suggested_date, rejection_reason, owner_viewed_at,\n            leases (\n                tenant_name,\n                tenant_email,\n                properties (\n                    title,\n                    images\n                )\n            )\n        `)\n        .order('created_at', { ascending: false });\n\n    const maintenanceRequests = maintenanceData || [];\n\n    if (maintenanceError) {\n        console.error(\"Erreur r√©cup√©ration maintenance:\", maintenanceError.message);\n    }\n\n    // Transformer les demandes de maintenance pour MaintenanceHub\n    const formattedRequests = (maintenanceRequests || []).map(req => {\n        // @ts-ignore - Supabase join types can be tricky\n        const lease = Array.isArray(req.leases) ? req.leases[0] : req.leases;\n        // @ts-ignore\n        const property = Array.isArray(lease?.properties) ? lease.properties[0] : lease?.properties;\n\n        // Extraire la cat√©gorie de la description si elle existe (format: \"description [Cat√©gorie]\")\n        const categoryMatch = req.description?.match(/\\[([^\\]]+)\\]$/);\n        const category = categoryMatch ? categoryMatch[1] : undefined;\n        const cleanDescription = category ? req.description.replace(` [${category}]`, '') : req.description;\n\n        return {\n            id: req.id,\n            description: cleanDescription,\n            category: req.category || category,\n            status: req.status,\n            created_at: req.created_at,\n            photo_urls: req.photo_urls,\n            // Infos artisan (Make.com)\n            artisan_name: req.artisan_name,\n            artisan_phone: req.artisan_phone,\n            artisan_rating: req.artisan_rating,\n            artisan_address: req.artisan_address,\n            // Infos devis\n            quoted_price: req.quoted_price,\n            quote_url: req.quote_url,\n            intervention_date: req.intervention_date,\n            owner_approved: req.owner_approved,\n            // Coordination & Feedback\n            tenant_response: req.tenant_response,\n            tenant_suggested_date: req.tenant_suggested_date,\n            rejection_reason: req.rejection_reason,\n            // New/unviewed: only for active (non-terminal) requests without owner_viewed_at\n            is_new: !(req as any).owner_viewed_at && !['completed', 'rejected', 'cancelled'].includes(req.status),\n            // Infos Bien & Locataire\n            property_title: property?.title,\n            property_images: property?.images,\n            tenant_name: lease?.tenant_name,\n            tenant_email: lease?.tenant_email\n        };\n    });\n\n    // Mark maintenance as viewed AFTER query (so is_new reflects pre-view state)\n    markMaintenanceAsViewed();\n\n    return <InterventionsPageClient requests={formattedRequests} />;\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\locataires\\[id]\\PaymentHistory.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[329,332],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[329,332],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[347,350],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[347,350],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[364,367],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[364,367],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[379,382],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[379,382],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[397,400],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[397,400],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1392,1395],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1392,1395],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4107,4110],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4107,4110],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { _useState } from 'react';\nimport { Download } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { PDFDownloadLink } from '@react-pdf/renderer';\nimport { createPaymentHistoryDocument } from '@/components/pdf/PaymentHistoryPDF';\n\ninterface PaymentHistoryProps {\n    transactions: any[];\n    lease: any;\n    tenant: any;\n    user: any;\n    profile: any;\n}\n\nexport function PaymentHistory({ transactions, lease, tenant, _user, profile }: PaymentHistoryProps) {\n\n    // Helper for currency\n    const formatMoney = (amount: number) =>\n        new Intl.NumberFormat(\"fr-SN\", { style: \"currency\", currency: \"XOF\", maximumFractionDigits: 0 }).format(amount);\n\n    const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\n        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];\n\n    // Prepare data for PDF\n    const pdfData = {\n        tenantName: tenant.name,\n        tenantEmail: tenant.email,\n        tenantPhone: tenant.phone,\n        propertyAddress: lease.property_address || 'Adresse non renseign√©e',\n        ownerName: profile?.company_name || profile?.full_name || 'Propri√©taire',\n        ownerAddress: profile?.company_address || '',\n        ownerNinea: profile?.company_ninea || profile?.ninea || undefined,\n        ownerLogo: profile?.logo_url || undefined,\n        transactions: transactions.map((t: any) => ({\n            id: t.id,\n            period: t.period_month === 0 ? 'Caution' : `${monthNames[t.period_month - 1]} ${t.period_year}`,\n            amount: t.amount_due || 0,\n            amountPaid: t.amount_paid || t.amount_due || 0, // Fallback logic same as display\n            status: t.status,\n            paidAt: t.paid_at\n        }))\n    };\n\n    return (\n        <div className=\"space-y-6\">\n            {/* Header / Actions */}\n            <div className=\"p-4 rounded-xl border bg-card border-border\">\n                <div className=\"flex justify-between items-center\">\n                    <h3 className=\"font-semibold text-lg text-foreground\">Historique complet</h3>\n\n                    <PDFDownloadLink\n                        document={createPaymentHistoryDocument(pdfData)}\n                        fileName={`Historique_Paiements_${tenant.name.replace(/\\s+/g, '_')}.pdf`}\n                        className=\"no-underline\"\n                    >\n                        {({ loading }) => (\n                            <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                className=\"bg-background border-border text-foreground hover:bg-accent hover:text-accent-foreground shadow-sm\"\n                                disabled={loading}\n                            >\n                                {loading ? (\n                                    <span className=\"animate-pulse\">G√©n√©ration...</span>\n                                ) : (\n                                    <>\n                                        <Download className=\"w-4 h-4 mr-2\" />\n                                        Exporter PDF\n                                    </>\n                                )}\n                            </Button>\n                        )}\n                    </PDFDownloadLink>\n                </div>\n            </div>\n\n            {/* Table */}\n            <div className=\"border rounded-xl overflow-hidden bg-card border-border\">\n                <table className=\"w-full text-sm text-left\">\n                    <thead className=\"font-medium border-b bg-muted text-muted-foreground border-border\">\n                        <tr>\n                            <th className=\"p-4\">P√©riode</th>\n                            <th className=\"p-4\">Date limite</th>\n                            <th className=\"p-4\">Montant</th>\n                            <th className=\"p-4\">Statut</th>\n                            <th className=\"p-4 text-right\">Action</th>\n                        </tr>\n                    </thead>\n                    <tbody className=\"divide-y divide-border\">\n                        {transactions.map((t: any) => (\n                            <tr key={t.id} className=\"transition-colors hover:bg-accent/50\">\n                                <td className=\"p-4 font-medium capitalize text-foreground\">\n                                    {t.period_month === 0\n                                        ? <span className=\"text-[#F4C430] flex items-center gap-2\">Caution (D√©p√¥t de garantie)</span>\n                                        : new Date(t.period_year, t.period_month - 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })\n                                    }\n                                </td>\n                                <td className=\"p-4 text-muted-foreground\">\n                                    {t.period_month === 0\n                                        ? \"-\"\n                                        : `05/${String(t.period_month).padStart(2, '0')}`\n                                    }\n                                </td>\n                                <td className=\"p-4 font-mono text-foreground\">\n                                    {formatMoney(t.amount_due)}\n                                </td>\n                                <td className=\"p-4\">\n                                    <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${t.status === 'paid' ? 'bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20' :\n                                        t.status === 'overdue' ? 'bg-red-500/10 text-red-600 dark:text-red-400 border-red-500/20' :\n                                            'bg-amber-500/10 text-amber-600 dark:text-amber-400 border-amber-500/20'\n                                        }`}>\n                                        {t.status === 'paid' ? 'Pay√©' : t.status === 'overdue' ? 'En retard' : 'En attente'}\n                                    </span>\n                                </td>\n                                <td className=\"p-4 text-right\">\n                                    {t.status === 'paid' && (\n                                        <Button variant=\"ghost\" size=\"sm\" className=\"h-8 text-primary hover:text-primary/80\">\n                                            <Download className=\"w-3 h-3 mr-1\" /> Quittance\n                                        </Button>\n                                    )}\n                                </td>\n                            </tr>\n                        ))}\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\locataires\\[id]\\TenantProfileClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[597,600],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[597,600],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[620,623],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[620,623],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[713,716],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[713,716],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[731,734],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[731,734],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\locataires\\[id]\\TenantProfileClient.tsx:47:13\n  45 |     useEffect(() => {\n  46 |         if (typeof window !== 'undefined' && window.location.hash === '#documents') {\n> 47 |             setActiveTab(\"documents\");\n     |             ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  48 |         }\n  49 |     }, []);\n  50 |","line":47,"column":13,"nodeType":null,"endLine":47,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":200,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":200,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11261,11264],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11261,11264],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from \"react\";\nimport Link from \"next/link\";\nimport {\n    ChevronLeft,\n    Phone,\n    Mail,\n    MapPin,\n    FileText,\n    Clock,\n    CheckCircle,\n    AlertTriangle,\n    Download,\n    History,\n    FileCheck,\n    Eye\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { PaymentHistory } from \"./PaymentHistory\";\nimport { DocumentGeneratorDialog } from \"../../components/DocumentGeneratorDialog\";\n\ninterface TenantProfileClientProps {\n    lease: any;\n    transactions: any[];\n    totalPaid: number;\n    pendingAmount: number;\n    overdueCount: number;\n    user: any;\n    profile: any;\n}\n\nexport function TenantProfileClient({\n    lease,\n    transactions,\n    totalPaid,\n    pendingAmount,\n    overdueCount,\n    user,\n    profile\n}: TenantProfileClientProps) {\n    const [activeTab, setActiveTab] = useState(\"overview\");\n\n    useEffect(() => {\n        if (typeof window !== 'undefined' && window.location.hash === '#documents') {\n            setActiveTab(\"documents\");\n        }\n    }, []);\n\n    const formatMoney = (amount: number) =>\n        new Intl.NumberFormat(\"fr-SN\", { style: \"currency\", currency: \"XOF\", maximumFractionDigits: 0 }).format(amount);\n\n    return (\n        <div className=\"min-h-screen p-6 space-y-6 bg-background text-foreground\">\n            {/* Header / Navigation */}\n            <div className=\"flex items-center gap-4\">\n                <Button variant=\"ghost\" size=\"icon\" asChild className=\"rounded-full hover:bg-accent hover:text-accent-foreground text-foreground\">\n                    <Link href=\"/gestion\">\n                        <ChevronLeft className=\"w-5 h-5\" />\n                    </Link>\n                </Button>\n                <div>\n                    <h1 className=\"text-2xl font-bold flex items-center gap-2 text-foreground\">\n                        {lease.tenant_name}\n                        {lease.status === \"active\" ? (\n                            <span className=\"px-2 py-0.5 rounded-full bg-green-500/10 text-green-600 dark:text-green-400 text-xs border border-green-500/20\">Actif</span>\n                        ) : (\n                            <span className=\"px-2 py-0.5 rounded-full bg-red-500/10 text-red-600 dark:text-red-400 text-xs border border-red-500/20\">R√©sili√©</span>\n                        )}\n                    </h1>\n                    <p className=\"text-sm flex items-center gap-1 text-muted-foreground\">\n                        <MapPin className=\"w-3 h-3\" /> {lease.property_address}\n                    </p>\n                </div>\n            </div>\n\n            {/* Main Layout */}\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n\n                {/* Left Column: Info Card */}\n                <div className=\"space-y-6\">\n                    <div className=\"border rounded-xl p-6 space-y-6 bg-card border-border\">\n                        <div className=\"flex items-center gap-4\">\n                            <div className=\"w-16 h-16 rounded-full bg-primary flex items-center justify-center text-2xl font-bold text-primary-foreground\">\n                                {lease.tenant_name.charAt(0)}\n                            </div>\n                            <div>\n                                <p className=\"text-sm text-muted-foreground\">Locataire depuis</p>\n                                <p className=\"font-medium text-foreground\">{new Date(lease.start_date).toLocaleDateString(\"fr-FR\")}</p>\n                            </div>\n                        </div>\n\n                        <div className=\"space-y-4 pt-4 border-t border-border\">\n                            <div className=\"flex items-center gap-3 text-sm\">\n                                <Phone className=\"w-4 h-4 text-muted-foreground\" />\n                                <a href={`tel:${lease.tenant_phone}`} className=\"hover:text-primary transition-colors\">{lease.tenant_phone}</a>\n                            </div>\n                            <div className=\"flex items-center gap-3 text-sm\">\n                                <Mail className=\"w-4 h-4 text-muted-foreground\" />\n                                <a href={`mailto:${lease.tenant_email}`} className=\"hover:text-primary transition-colors\">{lease.tenant_email}</a>\n                            </div>\n                            <div className=\"flex items-center gap-3 text-sm\">\n                                <FileText className=\"w-4 h-4 text-muted-foreground\" />\n                                {lease.lease_pdf_url ? (\n                                    <span className=\"text-foreground\">Contrat sign√©</span>\n                                ) : (\n                                    <span className=\"text-amber-500\">Pas encore de bail</span>\n                                )}\n                            </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-3 pt-4\">\n                            <Button className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 transition-all shadow-md\" size=\"sm\" asChild>\n                                <Link href={`/gestion/messages/${lease.id}`}>\n                                    <Mail className=\"w-4 h-4 mr-2\" /> Message\n                                </Link>\n                            </Button>\n                            <Button variant=\"outline\" className=\"w-full border-border hover:bg-accent text-foreground shadow-sm\" size=\"sm\" asChild>\n                                <a href={`tel:${lease.tenant_phone}`}>\n                                    <Phone className=\"w-4 h-4 mr-2\" /> Appeler\n                                </a>\n                            </Button>\n                        </div>\n                    </div>\n\n                    {/* Quick Stats */}\n                    <div className=\"grid grid-cols-2 gap-3\">\n                        <div className=\"border rounded-xl p-4 bg-card border-border\">\n                            <p className=\"text-xs mb-1 text-muted-foreground\">Loyer mensuel</p>\n                            <p className=\"text-lg font-bold text-foreground\">{formatMoney(lease.monthly_amount)}</p>\n                        </div>\n                        <div className=\"border rounded-xl p-4 bg-card border-border\">\n                            <p className=\"text-xs mb-1 text-muted-foreground\">Jour de paiement</p>\n                            <p className=\"text-lg font-bold text-foreground\">Le {lease.billing_day}</p>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Right Column: Tabs & Content */}\n                <div className=\"lg:col-span-2 space-y-6\">\n                    <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n                        <TabsList className=\"w-full justify-start p-1 h-auto bg-muted border border-border\">\n                            <TabsTrigger value=\"overview\" className=\"data-[state=active]:bg-background data-[state=active]:text-foreground\">Vue d&apos;ensemble</TabsTrigger>\n                            <TabsTrigger value=\"payments\" className=\"data-[state=active]:bg-background data-[state=active]:text-foreground\">Paiements</TabsTrigger>\n                            <TabsTrigger value=\"documents\" className=\"data-[state=active]:bg-background data-[state=active]:text-foreground\">Documents</TabsTrigger>\n                        </TabsList>\n\n                        {/* TAB: OVERVIEW */}\n                        <TabsContent value=\"overview\" className=\"space-y-6 mt-6\">\n                            {/* Financial Summary */}\n                            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                                {/* Total Paid */}\n                                <div className=\"p-5 rounded-lg border shadow-sm bg-card border-border\">\n                                    <div className=\"flex items-center gap-3 mb-3\">\n                                        <div className=\"p-2 rounded-md bg-green-500/10 text-green-600 dark:text-green-400\">\n                                            <CheckCircle className=\"w-4 h-4\" />\n                                        </div>\n                                        <span className=\"text-xs font-medium uppercase tracking-wider text-muted-foreground\">Total Vers√©</span>\n                                    </div>\n                                    <div>\n                                        <span className=\"text-3xl font-semibold tracking-tighter text-foreground\">{formatMoney(totalPaid)}</span>\n                                    </div>\n                                </div>\n\n                                {/* Pending */}\n                                <div className=\"p-5 rounded-lg border shadow-sm bg-card border-border\">\n                                    <div className=\"flex items-center gap-3 mb-3\">\n                                        <div className=\"p-2 rounded-md bg-amber-500/10 text-amber-600 dark:text-amber-400\">\n                                            <Clock className=\"w-4 h-4\" />\n                                        </div>\n                                        <span className=\"text-xs font-medium uppercase tracking-wider text-muted-foreground\">En attente</span>\n                                    </div>\n                                    <div>\n                                        <span className=\"text-3xl font-semibold tracking-tighter text-foreground\">{formatMoney(pendingAmount)}</span>\n                                    </div>\n                                </div>\n\n                                {/* Overdue */}\n                                <div className=\"p-5 rounded-lg border shadow-sm bg-card border-border\">\n                                    <div className=\"flex items-center gap-3 mb-3\">\n                                        <div className=\"p-2 rounded-md bg-red-500/10 text-red-600 dark:text-red-400\">\n                                            <AlertTriangle className=\"w-4 h-4\" />\n                                        </div>\n                                        <span className=\"text-xs font-medium uppercase tracking-wider text-muted-foreground\">Retards</span>\n                                    </div>\n                                    <div className=\"flex items-baseline gap-1\">\n                                        <span className=\"text-3xl font-semibold tracking-tighter text-foreground\">{overdueCount}</span>\n                                        <span className=\"text-sm font-normal text-muted-foreground\">mois</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            {/* Recent Activity / Timeline */}\n                            <div className=\"border rounded-xl p-6 bg-card border-border\">\n                                <h3 className=\"font-semibold mb-4 flex items-center gap-2 text-foreground\">\n                                    <History className=\"w-4 h-4 text-primary\" /> Activit√© R√©cente\n                                </h3>\n                                <div className=\"space-y-4\">\n                                    {transactions.slice(0, 5).map((t: any) => (\n                                        <div key={t.id} className=\"flex items-start gap-3 pb-4 border-b last:border-0 last:pb-0 border-border/50\">\n                                            <div className={`mt-1 w-2 h-2 rounded-full ${t.status === 'paid' ? 'bg-green-500' :\n                                                t.status === 'overdue' ? 'bg-red-500' : 'bg-amber-500'\n                                                }`} />\n                                            <div className=\"flex-1\">\n                                                <p className=\"text-sm font-medium text-foreground\">\n                                                    {t.status === 'paid' ? 'Paiement re√ßu' :\n                                                        t.status === 'overdue' ? 'Paiement en retard' : 'Loyer √©mis'}\n                                                </p>\n                                                <p className=\"text-xs text-muted-foreground\">\n                                                    Pour {new Date(t.period_year, t.period_month - 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}\n                                                </p>\n                                            </div>\n                                            <div className=\"text-right\">\n                                                <p className=\"text-sm font-medium text-foreground\">{formatMoney(t.amount_due)}</p>\n                                                <p className=\"text-xs text-muted-foreground\">\n                                                    {new Date(t.created_at).toLocaleDateString('fr-FR')}\n                                                </p>\n                                            </div>\n                                        </div>\n                                    ))}\n                                </div>\n                            </div>\n                        </TabsContent>\n\n                        {/* TAB: PAYMENTS */}\n                        <TabsContent value=\"payments\" className=\"mt-6\">\n                            <PaymentHistory\n                                transactions={transactions}\n                                lease={lease}\n                                tenant={{\n                                    name: lease.tenant_name,\n                                    email: lease.tenant_email,\n                                    phone: lease.tenant_phone\n                                }}\n                                user={user}\n                                profile={lease.owner_profile}\n                            />\n                        </TabsContent>\n\n                        {/* TAB: DOCUMENTS */}\n                        <TabsContent value=\"documents\" className=\"space-y-6 mt-6\">\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                                {/* Contract */}\n                                {lease.lease_pdf_url ? (\n                                    <div className=\"border rounded-xl p-5 transition-colors bg-card border-border hover:border-primary/50 group relative\">\n                                        <div className=\"flex items-start justify-between mb-4\">\n                                            <div className=\"p-2 bg-green-500/10 rounded-lg\">\n                                                <FileCheck className=\"w-6 h-6 text-green-600 dark:text-green-400\" />\n                                            </div>\n                                            <div className=\"flex gap-1 md:opacity-0 group-hover:opacity-100 transition-opacity\">\n                                                <Button\n                                                    variant=\"ghost\"\n                                                    size=\"icon\"\n                                                    className=\"h-8 w-8 text-muted-foreground hover:text-primary\"\n                                                    asChild\n                                                >\n                                                    <a href={lease.lease_pdf_url} target=\"_blank\" rel=\"noopener noreferrer\">\n                                                        <Eye className=\"w-4 h-4\" />\n                                                    </a>\n                                                </Button>\n                                                <Button\n                                                    variant=\"ghost\"\n                                                    size=\"icon\"\n                                                    className=\"h-8 w-8 text-muted-foreground hover:text-primary\"\n                                                    asChild\n                                                >\n                                                    <a href={lease.lease_pdf_url} download>\n                                                        <Download className=\"w-4 h-4\" />\n                                                    </a>\n                                                </Button>\n                                            </div>\n                                        </div>\n                                        <h3 className=\"font-semibold mb-1 text-foreground\">Contrat de Bail</h3>\n                                        <p className=\"text-sm mb-2 text-muted-foreground\">Sign√© le {new Date(lease.start_date).toLocaleDateString('fr-FR')}</p>\n                                        <div className=\"flex gap-2\">\n                                            <span className=\"text-xs px-2 py-1 bg-green-500/10 rounded text-green-600 dark:text-green-400\">PDF Disponible</span>\n                                        </div>\n                                    </div>\n                                ) : (\n                                    <div className=\"border border-dashed rounded-xl p-5 flex flex-col items-center justify-center text-center min-h-[160px] bg-muted/30 border-border\">\n                                        <div className=\"p-3 rounded-full mb-3 bg-primary/10\">\n                                            <FileText className=\"w-8 h-8 text-primary\" />\n                                        </div>\n                                        <h3 className=\"font-semibold mb-1 text-foreground\">Aucun contrat</h3>\n                                        <p className=\"text-sm mb-4 text-muted-foreground\">G√©n√©rez un bail pour ce locataire</p>\n                                        <div className=\"w-full\">\n                                            <DocumentGeneratorDialog\n                                                leases={[lease]}\n                                                profile={profile}\n                                                trigger={\n                                                    <Button className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 transition-all gap-2 shadow-md\">\n                                                        <FileCheck className=\"w-4 h-4\" />\n                                                        G√©n√©rer le contrat\n                                                    </Button>\n                                                }\n                                            />\n                                        </div>\n                                    </div>\n                                )}\n\n                                {/* Placeholder for other documents */}\n                                <div className=\"border border-dashed rounded-xl p-5 flex flex-col items-center justify-center text-center transition-colors cursor-pointer h-full min-h-[160px] border-border hover:bg-accent text-muted-foreground hover:text-foreground\">\n                                    <FileText className=\"w-8 h-8 mb-2 opacity-50\" />\n                                    <span className=\"font-medium text-sm\">Ajouter un document</span>\n                                    <span className=\"text-xs opacity-70\">√âtat des lieux, Assurance, Identit√©...</span>\n                                </div>\n                            </div>\n                        </TabsContent>\n                    </Tabs>\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\locataires\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1983,1986],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1983,1986],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2045,2048],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2045,2048],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2144,2147],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2144,2147],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2209,2212],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2209,2212],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2298,2301],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2298,2301],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\nimport { notFound, redirect } from \"next/navigation\";\nimport { TenantProfileClient } from \"./TenantProfileClient\";\n\nexport default async function TenantProfilePage({ params }: { params: Promise<{ id: string }> }) {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) redirect(\"/login\");\n\n    const { id } = await params;\n\n    // R√©cup√©rer les team_ids de l'utilisateur\n    const { data: teamMemberships } = await supabase\n        .from(\"team_members\")\n        .select(\"team_id\")\n        .eq(\"user_id\", user.id);\n\n    const userTeamIds = teamMemberships?.map(tm => tm.team_id) || [];\n\n    // Construire la requ√™te avec OR: owner_id OU team_id\n    let leaseQuery = supabase\n        .from(\"leases\")\n        .select(`\n            *,\n            properties:property_id(id, title, images),\n            rental_transactions (\n                id,\n                period_month,\n                period_year,\n                amount_due,\n                status,\n                paid_at,\n                created_at\n            ),\n            maintenance_requests (\n                id,\n                description,\n                status,\n                created_at\n            )\n        `)\n        .eq(\"id\", id);\n\n    // Filtre: owner_id = user.id OU team_id dans les √©quipes de l'utilisateur\n    if (userTeamIds.length > 0) {\n        leaseQuery = leaseQuery.or(`owner_id.eq.${user.id},team_id.in.(${userTeamIds.join(',')})`);\n    } else {\n        leaseQuery = leaseQuery.eq(\"owner_id\", user.id);\n    }\n\n    const { data: lease } = await leaseQuery.single();\n\n    const { data: profile } = await supabase\n        .from('profiles')\n        .select('*')\n        .eq('id', user.id)\n        .single();\n\n    if (!lease) notFound();\n\n    // Calculate generic stats\n    const transactions = lease.rental_transactions || [];\n    const totalPaid = transactions\n        .filter((t: any) => t.status === \"paid\")\n        .reduce((sum: number, t: any) => sum + (t.amount_due || 0), 0);\n\n    const pendingAmount = transactions\n        .filter((t: any) => t.status === \"pending\")\n        .reduce((sum: number, t: any) => sum + (t.amount_due || 0), 0);\n\n    const overdueCount = transactions.filter((t: any) => t.status === \"overdue\").length;\n\n    return (\n        <TenantProfileClient\n            lease={lease}\n            transactions={transactions}\n            totalPaid={totalPaid}\n            pendingAmount={pendingAmount}\n            overdueCount={overdueCount}\n\n            user={user}\n            profile={profile}\n        />\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\messages\\MessagesPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\messages\\[leaseId]\\OwnerChatInterface.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\messages\\[leaseId]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\messages\\actions.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":85,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":85,"endColumn":22,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[2701,2714],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\nimport { sendEmail } from '@/lib/mail';\nimport { getUserTeamContext } from \"@/lib/team-context\";\nimport { requireTeamPermission } from \"@/lib/permissions\";\nimport { notifyTenant } from \"@/lib/notifications\";\n\nexport async function getOwnerMessages(leaseId: string) {\n    const { teamId, user } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    if (!user) return { error: \"Non authentifi√©\" };\n\n    // V√©rifier que le bail appartient bien √† l'√©quipe\n    const { data: lease } = await supabase\n        .from('leases')\n        .select('id, tenant_name, team_id')\n        .eq('id', leaseId)\n        .eq('team_id', teamId)\n        .single();\n\n    if (!lease) return { error: \"Bail introuvable ou acc√®s refus√©\" };\n\n    const { data: messages } = await supabase\n        .from('messages')\n        .select('*')\n        .eq('lease_id', leaseId)\n        .order('created_at', { ascending: true });\n\n    return { messages: messages || [], tenantName: lease.tenant_name };\n}\n\n/**\n * Mark all tenant messages in a conversation as read by the owner.\n */\nexport async function markConversationAsRead(leaseId: string) {\n    const { _teamId, user } = await getUserTeamContext();\n    const supabase = await createClient();\n\n    if (!user) return;\n\n    // Only mark tenant messages as read (owner's own messages don't need read_at)\n    await supabase\n        .from('messages')\n        .update({ read_at: new Date().toISOString() })\n        .eq('lease_id', leaseId)\n        .eq('sender_type', 'tenant')\n        .is('read_at', null);\n\n    revalidatePath('/gestion/messages');\n}\n\nexport async function sendOwnerMessage(leaseId: string, content: string) {\n    const { teamId, user } = await getUserTeamContext();\n    await requireTeamPermission('leases.view'); // Base permission for messaging\n    const supabase = await createClient();\n\n    if (!user) return { error: \"Non authentifi√©\" };\n\n    const { error } = await supabase\n        .from('messages')\n        .insert({\n            lease_id: leaseId,\n            sender_id: user.id,\n            sender_type: 'owner',\n            team_id: teamId,\n            content: content\n        });\n\n    if (error) {\n        console.error(\"Erreur envoi message owner:\", error);\n        return { error: \"Impossible d'envoyer le message\" };\n    }\n\n    // Notification Email au Locataire\n    const { data: lease } = await supabase\n        .from('leases')\n        .select('tenant_email, tenant_name, owner:profiles(full_name)') // On r√©cup√®re l'email locataire\n        .eq('id', leaseId)\n        .single();\n\n    if (lease?.tenant_email) {\n        // @ts-ignore\n        const ownerName = lease.owner?.full_name || \"Votre Propri√©taire\";\n\n        try {\n            await sendEmail({\n                to: lease.tenant_email,\n                subject: `Nouveau message de ${ownerName}`,\n                html: `\n                    <p>Bonjour ${lease.tenant_name || ''},</p>\n                    <p>Vous avez re√ßu un nouveau message de <strong>${ownerName}</strong>.</p>\n                    <p><em>\"${content}\"</em></p>\n                    <a href=\"${process.env.NEXT_PUBLIC_APP_URL}/locataire/messages\">Voir la conversation</a>\n                `\n            });\n        } catch (mailError) {\n            console.error(\"Erreur notif mail owner:\", mailError);\n        }\n\n        // Notification Push\n        await notifyTenant({\n            leaseId,\n            title: `Message de ${ownerName}`,\n            message: content,\n            url: \"/locataire/messages\"\n        });\n    }\n\n    revalidatePath(`/gestion/messages/${leaseId}`);\n    return { success: true };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\messages\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1608,1611],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1608,1611],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1683,1686],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1683,1686],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\nimport { MessagesPageClient } from \"./MessagesPageClient\";\n\nexport default async function OwnerMessagesPage() {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    // 1. R√©cup√©rer TOUS les baux actifs (pour le dropdown \"Nouveau message\")\n    const { data: allLeases } = await supabase\n        .from('leases')\n        .select('id, tenant_name, property:properties(title)')\n        .eq('owner_id', user?.id)\n        .eq('status', 'active');\n\n    // 2. R√©cup√©rer les messages avec info de lecture\n    const { data: messagesData } = await supabase\n        .from('messages')\n        .select('lease_id, sender_type, read_at');\n\n    const leaseIdsWithMessages = new Set(messagesData?.map(m => m.lease_id) || []);\n\n    // 3. Compter les messages non lus par lease (messages du locataire non lus)\n    const unreadByLease: Record<string, number> = {};\n    for (const msg of messagesData || []) {\n        if (msg.sender_type === 'tenant' && !msg.read_at) {\n            unreadByLease[msg.lease_id] = (unreadByLease[msg.lease_id] || 0) + 1;\n        }\n    }\n\n    // 4. Filtrer pour n'afficher que les conversations actives (avec messages)\n    const activeConversations = allLeases?.filter(lease => leaseIdsWithMessages.has(lease.id)) || [];\n\n    // 5. Locataires sans conversation (pour le dropdown)\n    const tenantsWithoutConversation = allLeases?.filter(lease => !leaseIdsWithMessages.has(lease.id)) || [];\n\n    return (\n        <MessagesPageClient\n            activeConversations={activeConversations as any}\n            tenantsWithoutConversation={tenantsWithoutConversation as any}\n            unreadByLease={unreadByLease}\n        />\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":54,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2069,2072],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2069,2072],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Suspense } from \"react\";\nimport DashboardContent from \"./dash-content\";\nimport { getUserTeamContext } from \"@/lib/team-context\";\nimport { redirect } from \"next/navigation\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\n// Force dynamic rendering to prevent stale RSC cache on navigation\nexport const dynamic = \"force-dynamic\";\n\nfunction DashboardSkeleton() {\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                {[...Array(4)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-24 rounded-lg\" variant=\"luxury\" />\n                ))}\n            </div>\n            <Skeleton className=\"h-[400px] rounded-xl\" variant=\"luxury\" />\n        </div>\n    );\n}\n\nfunction _DashboardError({ error }: { error: string }) {\n    return (\n        <div className=\"rounded-xl border border-red-500/30 bg-red-500/10 p-6 text-center space-y-2\">\n            <p className=\"text-red-400 font-semibold\">Erreur de chargement du dashboard</p>\n            <p className=\"text-sm text-red-300/70\">{error}</p>\n            <p className=\"text-xs text-neutral-500\">Consultez les logs serveur pour plus de d√©tails.</p>\n        </div>\n    );\n}\n\nexport default async function GestionLocativePage({\n    searchParams,\n}: {\n    searchParams?: Promise<{ view?: string; upgrade?: string }>;\n}) {\n    const t0 = Date.now();\n    console.log(\"[Gestion/page] ‚ñ∂ D√©but chargement page /gestion\");\n\n    // 1. Initialisation - Essayer de r√©cup√©rer le contexte rapidement\n    let context;\n    try {\n        context = await getUserTeamContext();\n        console.log(\"[Gestion/page] ‚úì Contexte r√©cup√©r√© en\", Date.now() - t0, \"ms\", {\n            userId: context?.user?.id?.slice(0, 8),\n            teamId: context?.teamId?.slice(0, 8),\n            role: context?.role,\n            tier: context?.subscription_tier,\n            status: context?.subscription_status,\n        });\n    } catch (err) {\n        // Let Next.js redirect errors pass through (from getUserTeamContext)\n        if ((err as any)?.digest?.startsWith(\"NEXT_REDIRECT\")) throw err;\n        console.error(\"[Gestion/page] ‚úó Erreur getUserTeamContext:\", err);\n        redirect(\"/auth/login?reason=timeout\");\n    }\n\n    if (!context) {\n        console.warn(\"[Gestion/page] ‚úó Contexte null, redirection login\");\n        redirect(\"/auth/login?reason=timeout\");\n    }\n\n    return (\n        <Suspense fallback={<DashboardSkeleton />}>\n            <DashboardContent context={context} searchParams={searchParams} />\n        </Suspense>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\templates\\document-structures.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\gestion\\utils\\property-matching.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\(workspace)\\workspace-layout-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\_actions\\admin-verification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\_actions\\properties.cached.example.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2572,2575],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2572,2575],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":348,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":348,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9542,9545],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9542,9545],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * EXEMPLES DE SERVER ACTIONS AVEC INVALIDATION CACHE\n *\n * Ce fichier montre comment int√©grer le cache Redis dans vos Server Actions existantes.\n * √Ä adapter selon votre structure actuelle.\n *\n * @see REDIS_CACHE_STRATEGY.md\n * @see CACHE_ACTIVATION_GUIDE.md\n */\n\n\"use server\";\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport { invalidateCacheBatch } from \"@/lib/cache/cache-aside\";\nimport { revalidatePath } from \"next/cache\";\n\n// ============================================================================\n// EXEMPLE 1 : Cr√©ation d'un nouveau bien\n// ============================================================================\n\nexport async function createProperty(formData: FormData) {\n  const supabase = await createClient();\n\n  // 1. R√©cup√©rer l'utilisateur\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return { error: \"Non authentifi√©\" };\n  }\n\n  // 2. Extraire les donn√©es du formulaire\n  const title = formData.get(\"title\") as string;\n  const city = formData.get(\"city\") as string;\n  const category = formData.get(\"category\") as string;\n  const type = formData.get(\"type\") as string;\n  // ... autres champs\n\n  // 3. Cr√©er le bien dans la DB\n  const { data: property, error } = await supabase\n    .from(\"properties\")\n    .insert({\n      owner_id: user.id,\n      title,\n      city,\n      category,\n      details: { type },\n      status: \"pending\", // En attente de validation admin\n      // ... autres champs\n    })\n    .select()\n    .single();\n\n  if (error) {\n    console.error(\"Error creating property:\", error);\n    return { error: \"Erreur lors de la cr√©ation du bien\" };\n  }\n\n  // 4. üì¢ INVALIDER LE CACHE\n  // Note : Comme status = 'pending', pas encore visible sur homepage\n  // Mais on invalide quand m√™me pour coh√©rence\n\n  await invalidateCacheBatch(\n    [\n      \"all_sections\", // Homepage globale\n      `city:${city}`, // Filtres par ville\n      // Pas besoin d'invalider les sections individuelles car status != 'disponible'\n    ],\n    \"homepage\"\n  );\n\n  // √âgalement invalider namespace properties\n  await invalidateCacheBatch([`city:${city}`], \"properties\");\n\n  // 5. Revalider les chemins Next.js (ISR)\n  revalidatePath(\"/\");\n  revalidatePath(\"/recherche\");\n\n  return { success: true, propertyId: property.id };\n}\n\n// ============================================================================\n// EXEMPLE 2 : Mise √† jour d'un bien existant\n// ============================================================================\n\nexport async function updateProperty(propertyId: string, updates: any) {\n  const supabase = await createClient();\n\n  // 1. V√©rifier ownership\n  const { data: property } = await supabase\n    .from(\"properties\")\n    .select(\"owner_id, city, status\")\n    .eq(\"id\", propertyId)\n    .single();\n\n  if (!property) {\n    return { error: \"Bien introuvable\" };\n  }\n\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (user?.id !== property.owner_id) {\n    return { error: \"Non autoris√©\" };\n  }\n\n  // 2. Update DB\n  const { error } = await supabase\n    .from(\"properties\")\n    .update(updates)\n    .eq(\"id\", propertyId);\n\n  if (error) {\n    console.error(\"Error updating property:\", error);\n    return { error: \"Erreur lors de la mise √† jour\" };\n  }\n\n  // 3. üì¢ INVALIDER CACHE (CRITIQUE !)\n  const keysToInvalidate: string[] = [];\n\n  // Toujours invalider :\n  keysToInvalidate.push(\"all_sections\"); // Homepage globale\n\n  // Si ville a chang√©, invalider les 2 villes\n  if (updates.city && updates.city !== property.city) {\n    keysToInvalidate.push(`city:${property.city}`, `city:${updates.city}`);\n  } else {\n    keysToInvalidate.push(`city:${property.city}`);\n  }\n\n  // Si statut a chang√©, invalider les sections homepage\n  if (updates.status && updates.status !== property.status) {\n    keysToInvalidate.push(\n      \"popular_locations_8\",\n      \"properties_for_sale_8\",\n      \"land_for_sale_8\"\n    );\n  }\n\n  // Invalider namespace homepage\n  await invalidateCacheBatch(keysToInvalidate, \"homepage\");\n\n  // Invalider namespace properties\n  await invalidateCacheBatch([`detail:${propertyId}`, `city:${property.city}`], \"properties\");\n\n  // Si nouvelle ville, invalider aussi\n  if (updates.city && updates.city !== property.city) {\n    await invalidateCacheBatch([`city:${updates.city}`], \"properties\");\n  }\n\n  // 4. Revalider paths\n  revalidatePath(\"/\");\n  revalidatePath(`/biens/${propertyId}`);\n  revalidatePath(\"/recherche\");\n\n  return { success: true };\n}\n\n// ============================================================================\n// EXEMPLE 3 : Suppression d'un bien\n// ============================================================================\n\nexport async function deleteProperty(propertyId: string) {\n  const supabase = await createClient();\n\n  // 1. R√©cup√©rer info pour invalidation\n  const { data: property } = await supabase\n    .from(\"properties\")\n    .select(\"owner_id, city\")\n    .eq(\"id\", propertyId)\n    .single();\n\n  if (!property) {\n    return { error: \"Bien introuvable\" };\n  }\n\n  // 2. V√©rifier ownership\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (user?.id !== property.owner_id) {\n    return { error: \"Non autoris√©\" };\n  }\n\n  // 3. Supprimer de la DB\n  const { error } = await supabase.from(\"properties\").delete().eq(\"id\", propertyId);\n\n  if (error) {\n    console.error(\"Error deleting property:\", error);\n    return { error: \"Erreur lors de la suppression\" };\n  }\n\n  // 4. üì¢ INVALIDER CACHE\n  await invalidateCacheBatch(\n    [\n      \"all_sections\",\n      `city:${property.city}`,\n      \"popular_locations_8\",\n      \"properties_for_sale_8\",\n      \"land_for_sale_8\",\n    ],\n    \"homepage\"\n  );\n\n  await invalidateCacheBatch([`detail:${propertyId}`, `city:${property.city}`], \"properties\");\n\n  // 5. Revalider paths\n  revalidatePath(\"/\");\n  revalidatePath(\"/recherche\");\n\n  return { success: true };\n}\n\n// ============================================================================\n// EXEMPLE 4 : Validation admin (changement statut)\n// ============================================================================\n\nexport async function approveProperty(propertyId: string) {\n  const supabase = await createClient();\n\n  // 1. V√©rifier que c'est un admin\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return { error: \"Non authentifi√©\" };\n  }\n\n  // V√©rifier r√¥le admin (√† adapter selon votre syst√®me)\n  const { data: profile } = await supabase\n    .from(\"profiles\")\n    .select(\"role\")\n    .eq(\"id\", user.id)\n    .single();\n\n  if (profile?.role !== \"admin\") {\n    return { error: \"Acc√®s refus√©\" };\n  }\n\n  // 2. R√©cup√©rer info propri√©t√©\n  const { data: property } = await supabase\n    .from(\"properties\")\n    .select(\"city, category, details\")\n    .eq(\"id\", propertyId)\n    .single();\n\n  if (!property) {\n    return { error: \"Bien introuvable\" };\n  }\n\n  // 3. Approuver le bien\n  const { error } = await supabase\n    .from(\"properties\")\n    .update({\n      validation_status: \"approved\",\n      status: \"disponible\", // Passe en disponible\n    })\n    .eq(\"id\", propertyId);\n\n  if (error) {\n    console.error(\"Error approving property:\", error);\n    return { error: \"Erreur lors de l'approbation\" };\n  }\n\n  // 4. üì¢ INVALIDER CACHE (IMPORTANT - Le bien devient visible !)\n  await invalidateCacheBatch(\n    [\n      \"all_sections\", // Devient visible homepage\n      `city:${property.city}`,\n      \"popular_locations_8\", // Si location √† Dakar\n      \"properties_for_sale_8\", // Si vente\n      \"land_for_sale_8\", // Si terrain\n    ],\n    \"homepage\"\n  );\n\n  await invalidateCacheBatch([`detail:${propertyId}`, `city:${property.city}`], \"properties\");\n\n  // 5. Revalider paths\n  revalidatePath(\"/\");\n  revalidatePath(`/biens/${propertyId}`);\n  revalidatePath(\"/recherche\");\n  revalidatePath(\"/admin/verifications/biens\");\n\n  return { success: true };\n}\n\n// ============================================================================\n// HELPER : Fonction utilitaire pour invalidation intelligente\n// ============================================================================\n\n/**\n * Invalide tous les caches li√©s √† une propri√©t√©\n * √Ä utiliser dans vos Server Actions existantes\n */\nexport async function invalidatePropertyCaches(\n  propertyId: string,\n  city: string,\n  options: {\n    invalidateHomepage?: boolean;\n    invalidateSearch?: boolean;\n    invalidateDetail?: boolean;\n  } = {}\n) {\n  const { invalidateHomepage = true, invalidateSearch = true, invalidateDetail = true } = options;\n\n  const homepageKeys: string[] = [];\n  const propertyKeys: string[] = [];\n\n  if (invalidateHomepage) {\n    homepageKeys.push(\n      \"all_sections\",\n      \"popular_locations_8\",\n      \"properties_for_sale_8\",\n      \"land_for_sale_8\"\n    );\n  }\n\n  if (invalidateSearch) {\n    homepageKeys.push(`city:${city}`);\n    propertyKeys.push(`city:${city}`);\n  }\n\n  if (invalidateDetail) {\n    propertyKeys.push(`detail:${propertyId}`);\n  }\n\n  // Invalider en parall√®le pour performance\n  await Promise.all([\n    homepageKeys.length > 0 ? invalidateCacheBatch(homepageKeys, \"homepage\") : Promise.resolve(),\n    propertyKeys.length > 0\n      ? invalidateCacheBatch(propertyKeys, \"properties\")\n      : Promise.resolve(),\n  ]);\n}\n\n// ============================================================================\n// USAGE DANS VOS ACTIONS EXISTANTES\n// ============================================================================\n\n/**\n * Exemple d'int√©gration dans une action existante\n */\nexport async function myExistingAction(propertyId: string, data: any) {\n  // ... votre logique DB existante ...\n  const supabase = await createClient();\n\n  const { error } = await supabase.from(\"properties\").update(data).eq(\"id\", propertyId);\n\n  if (error) return { error: \"...\" };\n\n  // ‚úÖ AJOUTER JUSTE CES 2 LIGNES\n  await invalidatePropertyCaches(propertyId, data.city);\n  revalidatePath(\"/\");\n\n  return { success: true };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\_actions\\upload-proof.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\_actions\\verification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\actions\\interventions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1685,1688],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1685,1688],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nimport { supabase } from '@/lib/supabase';\r\nimport { getCurrentUser } from '@/lib/auth';\r\nimport { invalidateFinancialCache } from '@/lib/finance-service';\r\n\r\n/**\r\n * Cr√©e une intervention + d√©pense associ√©e + invalide cache.\r\n */\r\nexport async function createInterventionAction({\r\n    bien_id,\r\n    team_id,\r\n    cost,\r\n    description,\r\n}: {\r\n    bien_id: string;\r\n    team_id: string;\r\n    cost: number;\r\n    description: string;\r\n}) {\r\n    const user = await getCurrentUser();\r\n    if (!user) throw new Error('Unauthorized');\r\n\r\n    try {\r\n        // 1. Cr√©er l'intervention\r\n        const { data: intervention, error: interventionError } = await supabase\r\n            .from('interventions')\r\n            .insert([\r\n                {\r\n                    bien_id,\r\n                    team_id,\r\n                    status: 'pending',\r\n                    created_by: user.id,\r\n                },\r\n            ])\r\n            .select()\r\n            .single();\r\n\r\n        if (interventionError) throw interventionError;\r\n\r\n        // 2. Cr√©er la d√©pense associ√©e\r\n        const { error: expenseError } = await supabase\r\n            .from('expenses')\r\n            .insert([\r\n                {\r\n                    team_id,\r\n                    lease_id: null, // Initialement orphelin ou √† lier plus tard\r\n                    amount: cost,\r\n                    description,\r\n                    expense_type: 'maintenance',\r\n                    expense_date: new Date().toISOString(),\r\n                    owner_id: user.id,\r\n                    meta: {\r\n                        source: 'intervention_auto',\r\n                        intervention_id: (intervention as any).id,\r\n                    },\r\n                },\r\n            ]);\r\n\r\n        if (expenseError) throw expenseError;\r\n\r\n        // 3. Invalider le cache (Realtime hook refetch auto)\r\n        await invalidateFinancialCache(team_id);\r\n\r\n        return {\r\n            ok: true,\r\n            intervention,\r\n            message: `‚úÖ Intervention cr√©√©e. D√©pense de ${cost} FCFA enregistr√©e.`,\r\n        };\r\n    } catch (error) {\r\n        console.error('‚ùå Erreur cr√©ation intervention:', error);\r\n        throw error;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\actions\\team-switching.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\access-control\\my-permissions\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1439,1442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1439,1442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { createClient } from \"@/utils/supabase/server\";\r\n\r\n/**\r\n * GET /api/access-control/my-permissions\r\n *\r\n * R√©cup√®re les permissions temporaires actives de l'utilisateur connect√©\r\n */\r\nexport async function GET(request: Request) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const teamId = searchParams.get(\"teamId\");\r\n\r\n    if (!teamId) {\r\n      return NextResponse.json(\r\n        { error: \"teamId is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // R√©cup√©rer les permissions temporaires actives\r\n    const { data: permissions, error } = await supabase\r\n      .from(\"temporary_permissions\")\r\n      .select(\"*\")\r\n      .eq(\"team_id\", teamId)\r\n      .eq(\"user_id\", user.id)\r\n      .gte(\"expires_at\", new Date().toISOString())\r\n      .order(\"expires_at\", { ascending: true });\r\n\r\n    if (error) {\r\n      console.error(\"[API] Error fetching permissions:\", error);\r\n      return NextResponse.json(\r\n        { error: \"Failed to fetch permissions\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      permissions: permissions || [],\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"[API] Unexpected error:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\admin\\backfill-geocode\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\admin\\catch-up-ged\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2492,2495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2492,2495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4170,4173],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4170,4173],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5935,5938],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5935,5938],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":190,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8604,8607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8604,8607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":241,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":241,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11393,11396],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11393,11396],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":247,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":247,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11544,11547],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11544,11547],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { NextResponse } from 'next/server';\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport { storeDocumentInGED } from '@/lib/ged-utils';\r\nimport { generateLeasePDF } from '@/lib/pdf-generator';\r\nimport _ReactPDF, { renderToStream } from '@react-pdf/renderer';\r\nimport { createQuittanceDocument } from '@/components/pdf/QuittancePDF_v2';\r\n\r\nexport async function POST(req: Request) {\r\n    // 1. Security Check\r\n    const secret = req.headers.get('x-admin-secret');\r\n    if (secret !== process.env.SUPABASE_SERVICE_ROLE_KEY) { // Simple check using existing key as secret, or defined explicitly\r\n        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const supabaseAdmin = createClient(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n    );\r\n\r\n    const report = {\r\n        leasesProcessed: 0,\r\n        leasesGenerated: 0,\r\n        receiptsProcessed: 0,\r\n        receiptsGenerated: 0,\r\n        errors: [] as string[]\r\n    };\r\n\r\n    try {\r\n        // ==========================================\r\n        // 2. CATCH-UP LEASES\r\n        // ==========================================\r\n        const { data: leases, error: leaseError } = await supabaseAdmin\r\n            .from('leases')\r\n            .select(`\r\n                *,\r\n                properties (location, title),\r\n                profiles:owner_id (\r\n                    full_name, email, \r\n                    company_name, company_address, company_ninea\r\n                )\r\n            `)\r\n            .eq('status', 'active');\r\n\r\n        if (leaseError) throw leaseError;\r\n\r\n        for (const lease of (leases || [])) {\r\n            report.leasesProcessed++;\r\n\r\n            // Check if document exists\r\n            const { data: existingDoc } = await supabaseAdmin\r\n                .from('user_documents')\r\n                .select('id')\r\n                .eq('lease_id', lease.id)\r\n                .or('file_type.eq.bail,category.eq.bail')\r\n                .limit(1)\r\n                .maybeSingle();\r\n\r\n            if (existingDoc) {\r\n                console.log(`Lease ${lease.id} already has doc ${existingDoc.id}`);\r\n            } else {\r\n                console.log(`Lease ${lease.id} NO DOC FOUND. Generating...`);\r\n                try {\r\n                    const ownerProfile = lease.profiles;\r\n                    const propertyAddress = lease.property_address ||\r\n                        (lease.properties?.location as any)?.address ||\r\n                        lease.properties?.title ||\r\n                        'Adresse non renseign√©e';\r\n\r\n                    // Prepare Data\r\n                    const ownerNameParts = (ownerProfile?.full_name || '').split(' ');\r\n                    const firstName = ownerNameParts[0] || 'Propri√©taire';\r\n                    const lastName = ownerNameParts.slice(1).join(' ') || '';\r\n\r\n                    const contractData = {\r\n                        landlord: {\r\n                            firstName: firstName,\r\n                            lastName: lastName,\r\n                            address: ownerProfile?.company_address || 'Adresse non renseign√©e',\r\n                            phone: '', // Phone number column does not exist on profiles\r\n                            email: ownerProfile?.email,\r\n                            companyName: ownerProfile?.company_name,\r\n                            ninea: ownerProfile?.company_ninea\r\n                        },\r\n                        tenant: {\r\n                            firstName: lease.tenant_name?.split(' ')[0] || '',\r\n                            lastName: lease.tenant_name?.split(' ').slice(1).join(' ') || '',\r\n                            phone: lease.tenant_phone || '',\r\n                            email: lease.tenant_email,\r\n                            nationalId: '',\r\n                            address: propertyAddress\r\n                        },\r\n                        property: {\r\n                            address: propertyAddress,\r\n                            description: propertyAddress || 'Bien immobilier',\r\n                            propertyType: 'appartement' as any\r\n                        },\r\n                        lease: {\r\n                            monthlyRent: Number(lease.monthly_amount),\r\n                            securityDeposit: Number(lease.monthly_amount) * 2, // Assumption\r\n                            depositMonths: 2,\r\n                            startDate: new Date(lease.start_date),\r\n                            duration: Number(lease.duration) || 12,\r\n                            billingDay: Number(lease.billing_day) || 5,\r\n                        },\r\n                        signatures: {\r\n                            signatureCity: 'Dakar',\r\n                            signatureDate: new Date(lease.created_at)\r\n                        }\r\n                    };\r\n\r\n                    const pdfResult = await generateLeasePDF(contractData);\r\n\r\n                    if (pdfResult.success && pdfResult.pdfBytes) {\r\n                        await storeDocumentInGED({\r\n                            userId: lease.owner_id,\r\n                            fileBuffer: pdfResult.pdfBytes,\r\n                            fileName: `Bail - ${lease.tenant_name} - ${new Date().getFullYear()} (Rattrapage).pdf`,\r\n                            bucketName: 'lease-contracts',\r\n                            documentType: 'bail',\r\n                            metadata: {\r\n                                leaseId: lease.id,\r\n                                propertyId: lease.property_id,\r\n                                tenantName: lease.tenant_name,\r\n                                description: `Contrat de bail pour ${lease.tenant_name}`\r\n                            }\r\n                        }, supabaseAdmin);\r\n                        report.leasesGenerated++;\r\n                    }\r\n                } catch (err: any) {\r\n                    report.errors.push(`Lease ${lease.id}: ${err.message}`);\r\n                }\r\n            }\r\n        }\r\n\r\n        // ==========================================\r\n        // 3. CATCH-UP RECEIPTS\r\n        // ==========================================\r\n        const { data: transactions, error: txError } = await supabaseAdmin\r\n            .from('rental_transactions')\r\n            .select(`\r\n                *,\r\n                leases (\r\n                    tenant_name, tenant_email, tenant_phone, property_address,\r\n                    owner_id,\r\n                    properties (location, title),\r\n                    profiles:owner_id (\r\n                        full_name, email, \r\n                        company_name, company_address, company_ninea,\r\n                        logo_url, signature_url\r\n                    )\r\n                )\r\n            `)\r\n            .eq('status', 'paid');\r\n\r\n        if (txError) throw txError;\r\n\r\n        for (const tx of (transactions || [])) {\r\n            report.receiptsProcessed++;\r\n\r\n            // Check if receipt exists linked to this transaction\r\n            // Note: user_documents schema might rely on metadata in JSON column OR explicit column\r\n            // My implementation of `storeDocumentInGED` puts transactionId in metadata JSON.\r\n            // But querying JSON metadata is slow/complex.\r\n            // BUT, I can check by Description or Filename pattern?\r\n            // Or better, check by `lease_id` and `file_name` containing period?\r\n\r\n            // Wait, the new `user_documents` schema has `entity_id` and `entity_type`.\r\n            // I should rely on that if I populated it.\r\n            // But existing docs might not have `entity_type` set if created before migration?\r\n            // If I created them via `storeDocumentInGED` in this session, they have it.\r\n            // Older ones won't exist at all in `user_documents` if they were just emailed.\r\n            // So checking if ANY receipt exists for this transaction ID is valid.\r\n\r\n            const { data: existingReceipt } = await supabaseAdmin\r\n                .from('user_documents')\r\n                .select('id')\r\n                .eq('entity_id', tx.id)\r\n                .eq('entity_type', 'payment')\r\n                .limit(1)\r\n                .maybeSingle();\r\n\r\n            if (!existingReceipt) {\r\n                try {\r\n                    const lease = tx.leases;\r\n                    if (!lease) continue;\r\n                    const ownerProfile = lease.profiles;\r\n\r\n                    const propertyAddress = lease.property_address ||\r\n                        (lease.properties?.location as any)?.address ||\r\n                        lease.properties?.title ||\r\n                        'Adresse non renseign√©e';\r\n\r\n                    const receiptData = {\r\n                        leaseId: tx.lease_id,\r\n                        tenantName: lease.tenant_name,\r\n                        tenantEmail: lease.tenant_email,\r\n                        tenantPhone: lease.tenant_phone,\r\n                        tenantAddress: propertyAddress,\r\n\r\n                        amount: tx.amount_due,\r\n                        periodMonth: `${String(tx.period_month).padStart(2, '0')}/${tx.period_year}`,\r\n                        periodStart: new Date(tx.period_year, tx.period_month - 1, 1).toLocaleDateString('fr-FR'),\r\n                        periodEnd: new Date(tx.period_year, tx.period_month, 0).toLocaleDateString('fr-FR'),\r\n                        receiptNumber: `QUITT-${tx.id.slice(0, 8)}`,\r\n\r\n                        ownerName: ownerProfile?.company_name || ownerProfile?.full_name,\r\n                        ownerAddress: ownerProfile?.company_address,\r\n                        ownerNinea: ownerProfile?.company_ninea,\r\n                        ownerEmail: ownerProfile?.email,\r\n                        ownerLogo: ownerProfile?.logo_url,\r\n                        ownerSignature: ownerProfile?.signature_url,\r\n\r\n                        propertyAddress: propertyAddress\r\n                    };\r\n\r\n                    const pdfDocument = createQuittanceDocument(receiptData);\r\n                    const stream = await renderToStream(pdfDocument);\r\n                    const chunks: Uint8Array[] = [];\r\n                    const pdfBuffer = await new Promise<Buffer>((resolve, reject) => {\r\n                        stream.on('data', (chunk) => chunks.push(chunk));\r\n                        stream.on('end', () => resolve(Buffer.concat(chunks)));\r\n                        stream.on('error', reject);\r\n                    });\r\n\r\n                    await storeDocumentInGED({\r\n                        userId: lease.owner_id,\r\n                        fileBuffer: new Uint8Array(pdfBuffer),\r\n                        fileName: `Quittance_${receiptData.periodMonth.replace('/', '-')}_${lease.tenant_name.replace(/\\s+/g, '_')} (Rattrapage).pdf`,\r\n                        bucketName: 'receipts',\r\n                        documentType: 'quittance',\r\n                        metadata: {\r\n                            leaseId: tx.lease_id,\r\n                            transactionId: tx.id,\r\n                            tenantName: lease.tenant_name,\r\n                            description: `Quittance - ${receiptData.periodMonth} - ${lease.tenant_name}`\r\n                        }\r\n                    }, supabaseAdmin);\r\n                    report.receiptsGenerated++;\r\n\r\n                } catch (err: any) {\r\n                    report.errors.push(`Receipt Tx ${tx.id}: ${err.message}`);\r\n                }\r\n            }\r\n        }\r\n\r\n    } catch (e: any) {\r\n        return NextResponse.json({ error: e.message || 'Unknown error', report }, { status: 500 });\r\n    }\r\n\r\n    return NextResponse.json({ success: true, report });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\branding\\upload\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\cron\\send-expiring-notification\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1589,1592],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1589,1592],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { notifyAccessExpiring } from \"@/lib/notifications/access-control-notifications\";\nimport { headers } from \"next/headers\";\n\n/**\n * API Route: Envoyer notification d'expiration\n *\n * Appel√©e par l'Edge Function CRON cleanup-access-control\n * ou manuellement pour tester\n *\n * POST /api/cron/send-expiring-notification\n * Body: { teamId, userId, permission, expiresAt }\n * Header: Authorization: Bearer CRON_SECRET_KEY\n */\nexport async function POST(request: NextRequest) {\n  try {\n    // V√©rifier l'authentification\n    const headersList = await headers();\n    const authHeader = headersList.get(\"authorization\");\n    const cronSecretKey = process.env.CRON_SECRET_KEY;\n\n    if (cronSecretKey && authHeader !== `Bearer ${cronSecretKey}`) {\n      return NextResponse.json(\n        { success: false, error: \"Unauthorized\" },\n        { status: 401 }\n      );\n    }\n\n    // Parser le body\n    const body = await request.json();\n    const { teamId, userId, permission, expiresAt } = body;\n\n    if (!teamId || !userId || !permission || !expiresAt) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: \"Missing required fields: teamId, userId, permission, expiresAt\",\n        },\n        { status: 400 }\n      );\n    }\n\n    // Envoyer la notification\n    const result = await notifyAccessExpiring({\n      teamId,\n      userId,\n      permission,\n      expiresAt,\n    });\n\n    return NextResponse.json({\n      success: result.success,\n      timestamp: new Date().toISOString(),\n    });\n  } catch (error: any) {\n    console.error(\"[Send Expiring Notification] Error:\", error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message || \"Internal server error\",\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Permet GET pour tester l'endpoint\n */\nexport async function GET() {\n  return NextResponse.json({\n    message: \"Send Expiring Notification API\",\n    method: \"POST\",\n    body: {\n      teamId: \"uuid\",\n      userId: \"uuid\",\n      permission: \"string\",\n      expiresAt: \"ISO date string\",\n    },\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\search\\suggestions\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2348,2351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2348,2351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2408,2411],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2408,2411],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/server\";\r\nimport { NextResponse } from 'next/server';\r\n\r\nexport async function GET(request: Request) {\r\n    const { searchParams } = new URL(request.url);\r\n    const query = searchParams.get('q');\r\n\r\n    if (!query || query.length < 2) {\r\n        return NextResponse.json([]);\r\n    }\r\n\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    const results = [];\r\n\r\n    // 1. Search Tenants (Authenticated only)\r\n    if (user) {\r\n        // Get team memberships to allow searching across team leases\r\n        const { data: teamMemberships } = await supabase\r\n            .from(\"team_members\")\r\n            .select(\"team_id\")\r\n            .eq(\"user_id\", user.id);\r\n\r\n        const userTeamIds = teamMemberships?.map(tm => tm.team_id) || [];\r\n\r\n        let leasesQuery = supabase\r\n            .from('leases')\r\n            .select('id, tenant_name, property_address, status')\r\n            .ilike('tenant_name', `%${query}%`)\r\n            .limit(5);\r\n\r\n        // Apply ownership/team filter logic similar to getLeasesByOwner\r\n        if (userTeamIds.length > 0) {\r\n            leasesQuery = leasesQuery.or(`owner_id.eq.${user.id},team_id.in.(${userTeamIds.join(',')})`);\r\n        } else {\r\n            leasesQuery = leasesQuery.eq(\"owner_id\", user.id);\r\n        }\r\n\r\n        // We might want to include terminated leases? \r\n        // Usually search should find everything.\r\n\r\n        const { data: tenants } = await leasesQuery;\r\n\r\n        if (tenants) {\r\n            results.push(...tenants.map(t => ({\r\n                id: t.id,\r\n                label: t.tenant_name,\r\n                subLabel: t.property_address,\r\n                type: 'tenant',\r\n                url: `/gestion?q=${encodeURIComponent(t.tenant_name)}&tab=tenants`\r\n            })));\r\n        }\r\n    }\r\n\r\n    // 2. Search Properties (Public)\r\n    const { data: properties } = await supabase\r\n        .from('properties')\r\n        .select('id, title, location')\r\n        .eq('validation_status', 'approved')\r\n        .eq('status', 'disponible')\r\n        .or(`title.ilike.%${query}%,location->>city.ilike.%${query}%`)\r\n        .limit(5);\r\n\r\n    if (properties) {\r\n        results.push(...properties.map(p => ({\r\n            id: p.id,\r\n            label: p.title || (p.location as any)?.city || \"Bien\",\r\n            subLabel: (p.location as any)?.city,\r\n            type: 'property' as const,\r\n            url: `/recherche?q=${encodeURIComponent(p.title || \"\")}`\r\n        })));\r\n    }\r\n\r\n    // 3. Search External Listings (Public) - Critical for Dakar results\r\n    const { data: externalProperties } = await supabase\r\n        .from('external_listings')\r\n        .select('id, title, city')\r\n        .or(`title.ilike.%${query}%,city.ilike.%${query}%`)\r\n        .limit(5);\r\n\r\n    if (externalProperties) {\r\n        results.push(...externalProperties.map(p => ({\r\n            id: p.id,\r\n            label: p.title,\r\n            subLabel: p.city,\r\n            type: 'property' as const,\r\n            url: `/recherche?q=${encodeURIComponent(p.title || p.city || \"\")}`\r\n        })));\r\n    }\r\n\r\n    return NextResponse.json(results);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\stripe\\connect\\onboarding\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\stripe\\payment-intent\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\stripe\\rent-checkout\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\stripe\\webhook\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[309,312],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[309,312],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1344,1347],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1344,1347],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":192,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8162,8165],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8162,8165],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":212,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":212,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9003,9006],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9003,9006],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":229,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9661,9664],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9661,9664],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":253,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":253,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10866,10869],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10866,10869],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":271,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":271,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11499,11502],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11499,11502],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { headers } from 'next/headers';\r\nimport { NextResponse } from 'next/server';\r\nimport { stripe } from '@/lib/subscription/stripe';\r\nimport Stripe from 'stripe';\r\n\r\n/**\r\n * Helper: Resolve team_id from subscription metadata or fallback to DB lookup\r\n */\r\nasync function resolveTeamId(\r\n    adminClient: any,\r\n    metadata: Record<string, string> | null | undefined,\r\n    subscriptionId: string | null\r\n): Promise<string | null> {\r\n    const teamId = metadata?.team_id;\r\n    if (teamId) return teamId;\r\n\r\n    // Fallback: lookup by stripe_subscription_id\r\n    if (subscriptionId) {\r\n        const { data: team } = await adminClient\r\n            .from('teams')\r\n            .select('id')\r\n            .eq('stripe_subscription_id', subscriptionId)\r\n            .single();\r\n        return team?.id ?? null;\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n    const body = await req.text();\r\n    const signature = (await headers()).get('Stripe-Signature') as string;\r\n\r\n    let event: Stripe.Event;\r\n\r\n    try {\r\n        if (!process.env.STRIPE_WEBHOOK_SECRET) {\r\n            throw new Error('STRIPE_WEBHOOK_SECRET is not defined');\r\n        }\r\n        event = stripe.webhooks.constructEvent(\r\n            body,\r\n            signature,\r\n            process.env.STRIPE_WEBHOOK_SECRET\r\n        );\r\n    } catch (err: any) {\r\n        console.error(`Webhook Signature Error: ${err.message}`);\r\n        return NextResponse.json({ error: `Webhook Error: ${err.message}` }, { status: 400 });\r\n    }\r\n\r\n    // Use admin client to bypass RLS for background updates\r\n    const { createAdminClient } = await import('@/utils/supabase/admin');\r\n    const adminClient = createAdminClient();\r\n\r\n    try {\r\n        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n        // IDEMPOTENCY CHECK - skip already-processed events\r\n        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n        const { data: existingEvent } = await adminClient\r\n            .from('stripe_events_log')\r\n            .select('id')\r\n            .eq('stripe_event_id', event.id)\r\n            .single();\r\n\r\n        if (existingEvent) {\r\n            console.log(`‚è≠Ô∏è Event already processed: ${event.id}`);\r\n            return NextResponse.json({ received: true });\r\n        }\r\n\r\n        // Log event for idempotency (UNIQUE constraint on stripe_event_id)\r\n        await adminClient\r\n            .from('stripe_events_log')\r\n            .insert({\r\n                stripe_event_id: event.id,\r\n                type: event.type,\r\n            });\r\n\r\n        switch (event.type) {\r\n            case 'checkout.session.completed': {\r\n                const session = event.data.object as Stripe.Checkout.Session;\r\n\r\n                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n                // RENT PAYMENT HANDLING\r\n                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n                if (session.metadata?.type === 'rent_payment') {\r\n                    const leaseId = session.metadata.lease_id;\r\n                    const periodMonth = parseInt(session.metadata.period_month);\r\n                    const periodYear = parseInt(session.metadata.period_year);\r\n                    const amountFcfa = parseInt(session.metadata.amount_fcfa);\r\n\r\n                    // Check if transaction already exists for this period\r\n                    const { data: existingTx } = await adminClient\r\n                        .from('rental_transactions')\r\n                        .select('id')\r\n                        .eq('lease_id', leaseId)\r\n                        .eq('period_month', periodMonth)\r\n                        .eq('period_year', periodYear)\r\n                        .single();\r\n\r\n                    // Build rich traceability metadata\r\n                    const amountEurCents = session.amount_total || 0;\r\n                    const traceMeta = {\r\n                        provider: 'stripe',\r\n                        stripe_session_id: session.id,\r\n                        stripe_payment_intent_id: typeof session.payment_intent === 'string'\r\n                            ? session.payment_intent : null,\r\n                        amount_eur_cents: amountEurCents,\r\n                        amount_eur: amountEurCents / 100,\r\n                        amount_fcfa: amountFcfa,\r\n                        exchange_rate: amountFcfa > 0 && amountEurCents > 0\r\n                            ? Math.round(amountFcfa / (amountEurCents / 100))\r\n                            : 656,\r\n                        currency: 'eur',\r\n                        paid_at: new Date().toISOString(),\r\n                    };\r\n\r\n                    if (existingTx) {\r\n                        // Update existing transaction\r\n                        await adminClient\r\n                            .from('rental_transactions')\r\n                            .update({\r\n                                status: 'paid',\r\n                                paid_at: new Date().toISOString(),\r\n                                amount_paid: amountFcfa,\r\n                                payment_method: 'stripe',\r\n                                payment_ref: session.id,\r\n                                meta: traceMeta,\r\n                            })\r\n                            .eq('id', existingTx.id);\r\n\r\n                        console.log(`‚úÖ Rent payment updated: ${leaseId} - ${periodMonth}/${periodYear}`);\r\n                    } else {\r\n                        // Create new transaction record\r\n                        await adminClient\r\n                            .from('rental_transactions')\r\n                            .insert({\r\n                                lease_id: leaseId,\r\n                                period_month: periodMonth,\r\n                                period_year: periodYear,\r\n                                amount_due: amountFcfa,\r\n                                amount_paid: amountFcfa,\r\n                                status: 'paid',\r\n                                paid_at: new Date().toISOString(),\r\n                                payment_method: 'stripe',\r\n                                payment_ref: session.id,\r\n                                meta: traceMeta,\r\n                            });\r\n\r\n                        console.log(`‚úÖ Rent payment created: ${leaseId} - ${periodMonth}/${periodYear}`);\r\n                    }\r\n\r\n                    // Log for audit trail\r\n                    await adminClient\r\n                        .from('tenant_access_logs')\r\n                        .insert({\r\n                            lease_id: leaseId,\r\n                            action: 'payment_completed',\r\n                            details: {\r\n                                amount: amountFcfa,\r\n                                period: `${periodMonth}/${periodYear}`,\r\n                                method: 'stripe',\r\n                                stripe_session_id: session.id,\r\n                            },\r\n                        });\r\n\r\n                    break;\r\n                }\r\n\r\n                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n                // TEAM SUBSCRIPTION HANDLING\r\n                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n                const teamId = session.metadata?.team_id;\r\n                const planId = session.metadata?.plan_id;\r\n                const subscriptionId = session.subscription as string;\r\n\r\n                if (teamId && planId) {\r\n                    await adminClient\r\n                        .from('teams')\r\n                        .update({\r\n                            subscription_tier: planId,\r\n                            subscription_status: 'active',\r\n                            stripe_subscription_id: subscriptionId,\r\n                            subscription_trial_ends_at: null,\r\n                        })\r\n                        .eq('id', teamId);\r\n\r\n                    console.log(`‚úÖ Subscription activated for team ${teamId}`);\r\n                }\r\n                break;\r\n            }\r\n\r\n            case 'customer.subscription.deleted': {\r\n                const subscription = event.data.object as any;\r\n                const teamId = await resolveTeamId(adminClient, subscription.metadata, subscription.id);\r\n\r\n                if (teamId) {\r\n                    await adminClient\r\n                        .from('teams')\r\n                        .update({\r\n                            subscription_status: 'canceled',\r\n                            stripe_subscription_id: null,\r\n                        })\r\n                        .eq('id', teamId);\r\n\r\n                    console.log(`‚ùå Subscription canceled for team ${teamId}`);\r\n                } else {\r\n                    console.warn(`‚ö†Ô∏è customer.subscription.deleted: no team found for subscription ${subscription.id}`);\r\n                }\r\n                break;\r\n            }\r\n\r\n            case 'invoice.payment_failed': {\r\n                const invoice = event.data.object as any;\r\n                const subscriptionId = invoice.subscription as string;\r\n\r\n                if (subscriptionId) {\r\n                    await adminClient\r\n                        .from('teams')\r\n                        .update({\r\n                            subscription_status: 'past_due',\r\n                        })\r\n                        .eq('stripe_subscription_id', subscriptionId);\r\n\r\n                    console.log(`‚ö†Ô∏è Payment failed for subscription ${subscriptionId}`);\r\n                }\r\n                break;\r\n            }\r\n\r\n            case 'customer.subscription.updated': {\r\n                const subscription = event.data.object as any;\r\n                const teamId = await resolveTeamId(adminClient, subscription.metadata, subscription.id);\r\n                const status = subscription.status;\r\n\r\n                if (teamId) {\r\n                    await adminClient\r\n                        .from('teams')\r\n                        .update({\r\n                            subscription_status: status,\r\n                            subscription_tier: subscription.metadata?.plan_id,\r\n                            subscription_current_period_end: new Date(subscription.current_period_end * 1000).toISOString(),\r\n                            subscription_currency: subscription.currency ? subscription.currency.toLowerCase() : null,\r\n                        })\r\n                        .eq('id', teamId);\r\n\r\n                    console.log(`üîÑ Subscription updated for team ${teamId}: ${status}`);\r\n                } else {\r\n                    console.warn(`‚ö†Ô∏è customer.subscription.updated: no team found for subscription ${subscription.id}`);\r\n                }\r\n                break;\r\n            }\r\n\r\n            case 'invoice.payment_succeeded':\r\n            case 'invoice.paid': {\r\n                const invoice = event.data.object as any;\r\n                const subscriptionId = invoice.subscription as string;\r\n\r\n                if (subscriptionId) {\r\n                    await adminClient\r\n                        .from('teams')\r\n                        .update({\r\n                            subscription_status: 'active',\r\n                        })\r\n                        .eq('stripe_subscription_id', subscriptionId);\r\n\r\n                    console.log(`‚úÖ Payment succeeded for subscription ${subscriptionId}`);\r\n                }\r\n                break;\r\n            }\r\n        }\r\n\r\n        return NextResponse.json({ received: true });\r\n    } catch (error: any) {\r\n        console.error('Webhook processing failed:', error);\r\n        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\subscription\\checkout\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\subscription\\portal\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1183,1186],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1183,1186],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@/utils/supabase/server';\r\nimport { NextResponse } from 'next/server';\r\nimport { stripe } from '@/lib/subscription/stripe';\r\nimport { getBaseUrl } from '@/lib/utils';\r\nimport { getUserTeamContext } from '@/lib/team-context';\r\n\r\nexport async function POST(_req: Request) {\r\n    try {\r\n        const { teamId } = await getUserTeamContext();\r\n        const supabase = await createClient();\r\n\r\n        // Get customer ID\r\n        const { data: team } = await supabase\r\n            .from('teams')\r\n            .select('stripe_customer_id')\r\n            .eq('id', teamId)\r\n            .single();\r\n\r\n        if (!team?.stripe_customer_id) {\r\n            return NextResponse.json(\r\n                { error: \"Aucun abonnement trouv√© pour cette √©quipe.\" },\r\n                { status: 404 }\r\n            );\r\n        }\r\n\r\n        const baseUrl = getBaseUrl();\r\n\r\n        // Create Portal Session\r\n        const session = await stripe.billingPortal.sessions.create({\r\n            customer: team.stripe_customer_id,\r\n            return_url: `${baseUrl}/gestion/abonnement`,\r\n        });\r\n\r\n        return NextResponse.json({ url: session.url });\r\n    } catch (error: any) {\r\n        console.error('Stripe Portal Error:', error);\r\n        return NextResponse.json(\r\n            { error: error.message || 'Erreur lors de la cr√©ation du portail.' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\tenant\\logout\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\tenant\\receipt\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2063,2066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2063,2066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport ReactPDF from '@react-pdf/renderer';\r\nimport { createQuittanceDocument } from '@/components/pdf/QuittancePDF_v2';\r\nimport { createAdminClient } from '@/utils/supabase/admin';\r\nimport { getTenantSessionFromCookie } from '@/lib/tenant-magic-link';\r\n\r\nexport async function GET(\r\n    request: NextRequest,\r\n    { params }: { params: Promise<{ id: string }> }\r\n) {\r\n    try {\r\n        // 1. V√©rifier la session tenant via cookie\r\n        const session = await getTenantSessionFromCookie();\r\n        if (!session) {\r\n            return NextResponse.json({ error: 'Session expir√©e' }, { status: 401 });\r\n        }\r\n\r\n        const { id: transactionId } = await params;\r\n        const adminClient = createAdminClient();\r\n\r\n        // 2. R√©cup√©rer la transaction (v√©rifier qu'elle appartient au bail du tenant)\r\n        const { data: transaction, error } = await adminClient\r\n            .from('rental_transactions')\r\n            .select(`\r\n                *,\r\n                leases (\r\n                    id,\r\n                    tenant_name,\r\n                    tenant_email,\r\n                    tenant_phone,\r\n                    property_address,\r\n                    owner_id,\r\n                    profiles:owner_id (\r\n                        full_name,\r\n                        company_name,\r\n                        company_address,\r\n                        company_ninea,\r\n                        logo_url,\r\n                        signature_url\r\n                    )\r\n                )\r\n            `)\r\n            .eq('id', transactionId)\r\n            .single();\r\n\r\n        if (error || !transaction) {\r\n            return NextResponse.json({ error: 'Quittance introuvable' }, { status: 404 });\r\n        }\r\n\r\n        // 3. S√©curit√© : v√©rifier que la transaction appartient au bail du tenant\r\n        if (transaction.lease_id !== session.lease_id) {\r\n            return NextResponse.json({ error: 'Acc√®s interdit' }, { status: 403 });\r\n        }\r\n\r\n        const lease = transaction.leases as any;\r\n        const ownerProfile = lease.profiles;\r\n\r\n        // 4. Pr√©parer les donn√©es pour le PDF\r\n        const isGuarantee = transaction.period_month === 0;\r\n        const periodDate = isGuarantee\r\n            ? new Date()\r\n            : new Date(transaction.period_year, transaction.period_month - 1);\r\n        const periodMonthStr = isGuarantee\r\n            ? 'Garantie'\r\n            : periodDate.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });\r\n\r\n        const firstDay = isGuarantee\r\n            ? new Date()\r\n            : new Date(transaction.period_year, transaction.period_month - 1, 1);\r\n        const lastDay = isGuarantee\r\n            ? new Date()\r\n            : new Date(transaction.period_year, transaction.period_month, 0);\r\n\r\n        const pdfData = {\r\n            tenantName: lease.tenant_name,\r\n            tenantEmail: lease.tenant_email || '',\r\n            tenantPhone: lease.tenant_phone || '',\r\n            tenantAddress: lease.property_address,\r\n            amount: transaction.amount_paid || transaction.amount_due,\r\n            periodMonth: periodMonthStr,\r\n            periodStart: firstDay.toLocaleDateString('fr-FR'),\r\n            periodEnd: lastDay.toLocaleDateString('fr-FR'),\r\n            receiptNumber: `QUITT-${transaction.id.substring(0, 8).toUpperCase()}`,\r\n            ownerName: ownerProfile?.company_name || ownerProfile?.full_name || 'Propri√©taire',\r\n            ownerAddress: ownerProfile?.company_address || '',\r\n            ownerNinea: ownerProfile?.company_ninea || '',\r\n            ownerLogo: ownerProfile?.logo_url || undefined,\r\n            ownerSignature: ownerProfile?.signature_url || undefined,\r\n            propertyAddress: lease.property_address,\r\n            isGuarantee,\r\n        };\r\n\r\n        // 5. G√©n√©rer le PDF\r\n        const pdfDocument = createQuittanceDocument(pdfData);\r\n        const stream = await ReactPDF.renderToStream(pdfDocument);\r\n\r\n        const chunks: Uint8Array[] = [];\r\n        for await (const chunk of stream) {\r\n            chunks.push(chunk as Uint8Array);\r\n        }\r\n        const pdfBuffer = Buffer.concat(chunks);\r\n\r\n        // 6. Retourner le PDF\r\n        return new NextResponse(pdfBuffer, {\r\n            headers: {\r\n                'Content-Type': 'application/pdf',\r\n                'Content-Disposition': `inline; filename=\"Quittance_${pdfData.receiptNumber}.pdf\"`,\r\n            },\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Erreur g√©n√©ration PDF quittance tenant:', error);\r\n        return NextResponse.json(\r\n            { error: 'Erreur lors de la g√©n√©ration du PDF' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\tenant\\session\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\tenant\\unread-counts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\webhooks\\apify-sync\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\webhooks\\stripe\\connect\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1442,1445],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1442,1445],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2989,2992],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2989,2992],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { headers } from 'next/headers';\r\nimport { NextResponse } from 'next/server';\r\nimport { stripe } from '@/lib/subscription/stripe';\r\nimport { createClient } from '@/utils/supabase/server';\r\nimport Stripe from 'stripe';\r\n\r\n// Using the generic Stripe Webhook Secret for Connect events\r\n// Ensure this is configured in .env.local\r\nconst webhookSecret = process.env.STRIPE_CONNECT_WEBHOOK_SECRET;\r\n\r\nexport async function POST(req: Request) {\r\n    if (!webhookSecret) {\r\n        console.error('Missing STRIPE_CONNECT_WEBHOOK_SECRET');\r\n        return NextResponse.json({ error: 'Config error' }, { status: 500 });\r\n    }\r\n\r\n    const body = await req.text();\r\n    const headersList = await headers();\r\n    const signature = headersList.get('stripe-signature');\r\n\r\n    let event: Stripe.Event;\r\n\r\n    try {\r\n        if (!signature) throw new Error('No signature');\r\n        event = stripe.webhooks.constructEvent(body, signature, webhookSecret);\r\n    } catch (_err) {\r\n        console.error(`Webhook signature verification failed`);\r\n        return NextResponse.json({ error: 'Webhook Error' }, { status: 400 });\r\n    }\r\n\r\n    const supabase = await createClient();\r\n\r\n    // 1. LOGGING (Idempotent)\r\n    try {\r\n        const { error: logError } = await supabase\r\n            .from('stripe_events_log')\r\n            .insert({\r\n                type: event.type,\r\n                stripe_event_id: event.id,\r\n                payload: event as any // Cast to JSON\r\n            })\r\n            // Ignore if duplicate (handled by UNIQUE constraint)\r\n            .select()\r\n            .single();\r\n\r\n        if (logError && logError.code !== '23505') { // 23505 = unique_violation\r\n            console.error('Failed to log webhook:', logError);\r\n        } else if (logError?.code === '23505') {\r\n            console.log(`Event ${event.id} already processed.`);\r\n            return NextResponse.json({ received: true });\r\n        }\r\n    } catch (logEx) {\r\n        console.error('Logging exception:', logEx);\r\n    }\r\n\r\n    // 2. EVENT PROCESSING\r\n    try {\r\n        switch (event.type) {\r\n            case 'account.updated': {\r\n                const account = event.data.object as Stripe.Account;\r\n                const teamId = account.metadata?.team_id;\r\n\r\n                if (teamId) {\r\n                    await supabase.from('teams').update({\r\n                        stripe_charges_enabled: account.charges_enabled,\r\n                        stripe_payouts_enabled: account.payouts_enabled,\r\n                        stripe_details_submitted: account.details_submitted,\r\n                        stripe_account_status: (account.requirements?.disabled_reason) ? 'restricted' : (account.charges_enabled ? 'active' : 'pending'),\r\n                        // Capture simplified status\r\n                    }).eq('id', teamId);\r\n                }\r\n                break;\r\n            }\r\n            case 'account.application.deauthorized': {\r\n                const accountId = (event.data.object as any).id;\r\n                // Agency disconnected\r\n                await supabase.from('teams').update({\r\n                    stripe_account_id: null,\r\n                    stripe_charges_enabled: false,\r\n                    stripe_payouts_enabled: false,\r\n                    stripe_account_status: 'disconnected'\r\n                }).eq('stripe_account_id', accountId);\r\n                break;\r\n            }\r\n            // Add other handlers (payment_intent.succeeded) here as needed for transaction tracking\r\n            // Use 'transactions' table for that.\r\n            default:\r\n                // Just log (already done above)\r\n                break;\r\n        }\r\n    } catch (error) {\r\n        console.error('Webhook processing error:', error);\r\n        return NextResponse.json({ error: 'Processing error' }, { status: 500 });\r\n    }\r\n\r\n    return NextResponse.json({ received: true });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\api\\webhooks\\stripe\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\accept-invitation\\AcceptInvitationClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\accept-invitation\\AcceptInvitationClient.tsx:20:7\n  18 |   useEffect(() => {\n  19 |     if (!token) {\n> 20 |       setStatus(\"error\");\n     |       ^^^^^^^^^ Avoid calling setState() directly within an effect\n  21 |       setMessage(\"Lien d'invitation invalide\");\n  22 |       return;\n  23 |     }","line":20,"column":7,"nodeType":null,"endLine":20,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { CheckCircle2, XCircle, Loader2, Users, ArrowRight } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { acceptInvitation } from \"@/app/(workspace)/gestion/equipe/actions\";\r\n\r\nexport function AcceptInvitationClient() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const token = searchParams.get(\"token\");\r\n\r\n  const [status, setStatus] = useState<\"loading\" | \"success\" | \"error\">(\"loading\");\r\n  const [message, setMessage] = useState(\"\");\r\n  const [teamName, setTeamName] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    if (!token) {\r\n      setStatus(\"error\");\r\n      setMessage(\"Lien d'invitation invalide\");\r\n      return;\r\n    }\r\n\r\n    const processInvitation = async () => {\r\n      const result = await acceptInvitation(token);\r\n\r\n      if (result.success) {\r\n        setStatus(\"success\");\r\n        setTeamName(result.teamName || \"l'√©quipe\");\r\n        setMessage(`Vous avez rejoint ${result.teamName || \"l'√©quipe\"} avec succ√®s !`);\r\n      } else {\r\n        setStatus(\"error\");\r\n        setMessage(result.error || \"Une erreur est survenue\");\r\n      }\r\n    };\r\n\r\n    processInvitation();\r\n  }, [token]);\r\n\r\n  return (\r\n    <div className=\"max-w-md w-full\">\r\n      <div className=\"bg-slate-900 rounded-2xl border border-slate-800 p-8 text-center\">\r\n        {status === \"loading\" && (\r\n          <>\r\n            <div className=\"w-16 h-16 mx-auto mb-6 rounded-full bg-slate-800 flex items-center justify-center\">\r\n              <Loader2 className=\"w-8 h-8 text-[#F4C430] animate-spin\" />\r\n            </div>\r\n            <h1 className=\"text-xl font-bold text-white mb-2\">\r\n              Traitement en cours...\r\n            </h1>\r\n            <p className=\"text-slate-400\">\r\n              Veuillez patienter pendant que nous validons votre invitation.\r\n            </p>\r\n          </>\r\n        )}\r\n\r\n        {status === \"success\" && (\r\n          <>\r\n            <div className=\"w-16 h-16 mx-auto mb-6 rounded-full bg-green-500/10 flex items-center justify-center\">\r\n              <CheckCircle2 className=\"w-8 h-8 text-green-500\" />\r\n            </div>\r\n            <h1 className=\"text-xl font-bold text-white mb-2\">\r\n              Bienvenue dans l&apos;√©quipe !\r\n            </h1>\r\n            <p className=\"text-slate-400 mb-6\">{message}</p>\r\n\r\n            <div className=\"bg-slate-800/50 rounded-xl p-4 mb-6\">\r\n              <div className=\"flex items-center justify-center gap-3\">\r\n                <Users className=\"w-5 h-5 text-[#F4C430]\" />\r\n                <span className=\"text-white font-medium\">{teamName}</span>\r\n              </div>\r\n            </div>\r\n\r\n            <Button\r\n              onClick={() => router.push(\"/gestion/equipe\")}\r\n              className=\"w-full bg-[#F4C430] hover:bg-[#B8860B] text-black\"\r\n            >\r\n              Acc√©der √† l&apos;√©quipe\r\n              <ArrowRight className=\"w-4 h-4 ml-2\" />\r\n            </Button>\r\n          </>\r\n        )}\r\n\r\n        {status === \"error\" && (\r\n          <>\r\n            <div className=\"w-16 h-16 mx-auto mb-6 rounded-full bg-red-500/10 flex items-center justify-center\">\r\n              <XCircle className=\"w-8 h-8 text-red-500\" />\r\n            </div>\r\n            <h1 className=\"text-xl font-bold text-white mb-2\">\r\n              Invitation invalide\r\n            </h1>\r\n            <p className=\"text-slate-400 mb-6\">{message}</p>\r\n\r\n            <div className=\"space-y-3\">\r\n              <Button\r\n                onClick={() => router.push(\"/gestion\")}\r\n                className=\"w-full bg-[#F4C430] hover:bg-[#B8860B] text-black\"\r\n              >\r\n                Aller √† la gestion locative\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                onClick={() => router.push(\"/\")}\r\n                className=\"w-full border-slate-700 text-slate-300 hover:bg-slate-800\"\r\n              >\r\n                Retour √† l&apos;accueil\r\n              </Button>\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {/* Footer */}\r\n      <p className=\"text-center text-slate-500 text-sm mt-6\">\r\n        ¬© {new Date().getFullYear()} Dousell Immo. Tous droits r√©serv√©s.\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\auth\\accept-invitation\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[391,394],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[391,394],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1745,1748],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1745,1748],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { cookies } from 'next/headers';\nimport { redirect } from 'next/navigation';\nimport {\n    getTenantSessionFromCookie,\n    getTenantLeaseData,\n    validateTenantSession,\n    invalidateTenantSession,\n    checkAndRotateSession,\n    TENANT_SESSION_COOKIE_OPTIONS,\n} from '@/lib/tenant-magic-link';\n\nexport interface TenantDashboardData {\n    hasLease: boolean;\n    lease?: any;\n    isUpToDate?: boolean;\n    tenantName?: string;\n}\n\n/**\n * Get tenant dashboard data\n *\n * This action uses the tenant session from cookie (NOT auth.users).\n * Tenants access via Magic Link and don't have user accounts.\n */\nexport async function getTenantDashboardData(): Promise<TenantDashboardData> {\n    // Get tenant session from cookie\n    const session = await getTenantSessionFromCookie();\n\n    if (!session) {\n        redirect('/locataire/expired?error=no_session');\n    }\n\n    // Note: if we reach here, the session cookie exists (getTenantSessionFromCookie reads it).\n    // The cookie is ONLY created after successful name verification in verifyTenantIdentity(),\n    // so its existence proves the tenant's identity. We skip the verified flag check to avoid\n    // a race condition where DB replication hasn't propagated verified=true yet.\n\n    // Get full lease data\n    const data = await getTenantLeaseData();\n\n    if (!data || !data.lease) {\n        return {\n            hasLease: false,\n        };\n    }\n\n    // Check if payments are up to date\n    const payments = data.lease.payments || [];\n    const currentDate = new Date();\n    const currentMonth = currentDate.getMonth() + 1; // JS months are 0-indexed, DB is 1-indexed\n    const currentYear = currentDate.getFullYear();\n\n    const hasCurrentMonthPayment = payments.some((p: any) => {\n        return (\n            p.period_month === currentMonth &&\n            p.period_year === currentYear &&\n            p.status === 'paid'\n        );\n    });\n\n    return {\n        hasLease: true,\n        lease: data.lease,\n        isUpToDate: hasCurrentMonthPayment,\n        tenantName: data.tenantName,\n    };\n}\n\n/**\n * Get tenant session info (for client-side use via API)\n */\nexport async function getTenantSessionInfo() {\n    const session = await getTenantSessionFromCookie();\n\n    if (!session) {\n        return null;\n    }\n\n    return {\n        lease_id: session.lease_id,\n        tenant_name: session.tenant_name,\n        tenant_email: session.tenant_email,\n        property_title: session.property_title,\n        property_address: session.property_address,\n        verified: session.verified,\n    };\n}\n\n/**\n * Logout tenant - invalidate session in DB and clear cookie\n *\n * Must be called before clearing the cookie client-side.\n * Clears tenant_session_hash in DB and logs the event.\n */\nexport async function logoutTenant(): Promise<{ success: boolean }> {\n    const session = await getTenantSessionFromCookie();\n\n    if (session) {\n        await invalidateTenantSession(session.lease_id);\n    }\n\n    // Clear cookie server-side\n    const cookieStore = await cookies();\n    cookieStore.delete('tenant_session');\n\n    return { success: true };\n}\n\n/**\n * Migrate tenant session cookie to new path\n *\n * This Server Action refreshes the tenant session cookie with the correct\n * path setting so it's available for API routes at /api/*.\n * Also handles session rotation every 4 hours.\n *\n * Called automatically by the tenant portal on page load.\n */\nexport async function migrateTenantCookie(): Promise<{ success: boolean }> {\n    const cookieStore = await cookies();\n    const sessionToken = cookieStore.get('tenant_session')?.value;\n\n    if (!sessionToken) {\n        return { success: false };\n    }\n\n    // Validate the session token\n    const session = await validateTenantSession(sessionToken);\n\n    if (!session) {\n        return { success: false };\n    }\n\n    // Check if session needs rotation (every 4h)\n    const newToken = await checkAndRotateSession(session.lease_id);\n    const tokenToSet = newToken || sessionToken;\n\n    // Refresh cookie with correct path (delete old + set new)\n    cookieStore.delete('tenant_session');\n    cookieStore.set(TENANT_SESSION_COOKIE_OPTIONS.name, tokenToSet, {\n        httpOnly: TENANT_SESSION_COOKIE_OPTIONS.httpOnly,\n        secure: TENANT_SESSION_COOKIE_OPTIONS.secure,\n        sameSite: TENANT_SESSION_COOKIE_OPTIONS.sameSite,\n        maxAge: TENANT_SESSION_COOKIE_OPTIONS.maxAge,\n        path: TENANT_SESSION_COOKIE_OPTIONS.path,\n    });\n\n    return { success: true };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\components\\CookieMigrator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\components\\PaymentButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\components\\PaymentForm.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":208,"column":17,"nodeType":"JSXOpeningElement","endLine":212,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { Button } from '@/components/ui/button';\nimport {\n    ArrowRight,\n    CheckCircle2,\n    Clock,\n    FileText,\n    Wrench,\n    ChevronRight,\n    Building2,\n    MessageSquare,\n    Calendar,\n} from 'lucide-react';\nimport Link from 'next/link';\nimport { RentPaymentModal } from './RentPaymentModal';\n\ninterface PaymentFormProps {\n    leaseId: string;\n    monthlyAmount: number;\n    tenantName?: string;\n    tenantEmail?: string;\n    propertyAddress?: string;\n    leaseStartDate?: string;\n    leaseEndDate?: string;\n    leaseType?: string;\n    leaseStatus?: string;\n    billingDay?: number;\n    ownerName?: string;\n    recentPayments?: Array<{\n        id: string;\n        amount_due: number;\n        amount_paid?: number | null;\n        status: string;\n        period_month: number;\n        period_year: number;\n        paid_at?: string | null;\n        payment_method?: string | null;\n    }>;\n}\n\nconst MONTH_NAMES = [\n    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\n    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'\n];\n\nexport function PaymentForm({\n    leaseId,\n    monthlyAmount,\n    tenantName,\n    tenantEmail,\n    propertyAddress,\n    leaseStartDate,\n    leaseEndDate,\n    leaseType,\n    leaseStatus,\n    billingDay = 5,\n    ownerName,\n    recentPayments = []\n}: PaymentFormProps) {\n    const router = useRouter();\n    const [isModalOpen, setIsModalOpen] = useState(false);\n\n    // Calculs\n    const pendingPayments = recentPayments.filter(p => p.status !== 'paid');\n    const currentBalance = pendingPayments.reduce((sum, p) => sum + (p.amount_due || 0), 0);\n    const isUpToDate = currentBalance === 0;\n\n    // Get the oldest pending period\n    const oldestPending = [...pendingPayments].sort((a, b) => {\n        if (a.period_year !== b.period_year) return a.period_year - b.period_year;\n        return a.period_month - b.period_month;\n    })[0];\n\n    // Determine period to pay\n    const now = new Date();\n    const targetPeriodMonth = oldestPending?.period_month ?? (now.getMonth() + 1);\n    const targetPeriodYear = oldestPending?.period_year ?? now.getFullYear();\n    const targetAmount = oldestPending?.amount_due ?? monthlyAmount;\n\n    // Next rent calculation\n    const getNextRentInfo = () => {\n        const nextDate = new Date();\n        // If billing day hasn't passed this month, next rent is this month\n        // Otherwise, next month\n        if (now.getDate() >= billingDay) {\n            nextDate.setMonth(nextDate.getMonth() + 1);\n        }\n        nextDate.setDate(billingDay);\n        const monthName = MONTH_NAMES[nextDate.getMonth()];\n        return `${billingDay} ${monthName.toLowerCase()} - ${formatCurrency(monthlyAmount)} FCFA`;\n    };\n\n    const getCurrentMonth = () => {\n        return now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });\n    };\n\n    const formatCurrency = (amount?: number | null) => {\n        if (!amount && amount !== 0) return '0';\n        return new Intl.NumberFormat('fr-FR').format(amount);\n    };\n\n    const formatPeriod = (month: number, year: number) => {\n        if (month === 0) return 'Garantie';\n        return `${MONTH_NAMES[(month || 1) - 1]} ${year}`;\n    };\n\n    const formatPaidDate = (dateString?: string | null) => {\n        if (!dateString) return null;\n        const date = new Date(dateString);\n        return date.toLocaleDateString('fr-FR', {\n            day: 'numeric',\n            month: 'short',\n            year: 'numeric'\n        });\n    };\n\n    const formatDate = (dateString?: string) => {\n        if (!dateString) return null;\n        return new Date(dateString).toLocaleDateString('fr-FR', {\n            day: 'numeric',\n            month: 'long',\n            year: 'numeric'\n        });\n    };\n\n    return (\n        <div className=\"w-full max-w-lg mx-auto px-4 py-6 space-y-6\">\n\n            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                CARTE PRINCIPALE - Style Banking App\n            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n            <div className=\"relative overflow-hidden rounded-2xl bg-gradient-to-br from-zinc-900 via-zinc-900 to-zinc-800 p-6 text-white shadow-2xl\">\n                {/* Status indicator bar */}\n                <div className={`absolute top-0 left-0 right-0 h-1 ${isUpToDate ? 'bg-emerald-400' : 'bg-amber-400'}`} />\n\n                {/* Pattern subtil */}\n                <div className=\"absolute inset-0 opacity-5\">\n                    <div className=\"absolute top-0 right-0 w-64 h-64 bg-white rounded-full blur-3xl translate-x-1/2 -translate-y-1/2\" />\n                </div>\n\n                <div className=\"relative\">\n                    {/* Header */}\n                    <div className=\"flex items-center justify-between mb-8\">\n                        <div>\n                            <p className=\"text-zinc-400 text-sm\">Bonjour,</p>\n                            <h1 className=\"text-xl font-semibold text-white\">{tenantName || 'Locataire'}</h1>\n                        </div>\n                        <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-amber-500 flex items-center justify-center font-bold text-black\">\n                            {tenantName?.[0]?.toUpperCase() || 'L'}\n                        </div>\n                    </div>\n\n                    {/* Solde */}\n                    <div className=\"mb-6\">\n                        <p className=\"text-zinc-400 text-xs uppercase tracking-widest mb-2\">\n                            {isUpToDate ? 'Solde actuel' : 'Montant √† payer'}\n                        </p>\n                        <div className=\"flex items-baseline gap-2\">\n                            <span className=\"text-5xl font-bold tracking-tight text-white\">\n                                {formatCurrency(currentBalance)}\n                            </span>\n                            <span className=\"text-zinc-400 text-lg\">FCFA</span>\n                        </div>\n\n                        {isUpToDate ? (\n                            <div className=\"inline-flex items-center gap-1.5 mt-3 text-emerald-400\">\n                                <CheckCircle2 className=\"w-4 h-4\" />\n                                <span className=\"text-sm font-medium\">Paiements √† jour</span>\n                            </div>\n                        ) : (\n                            <p className=\"text-zinc-500 text-sm mt-2\">\n                                {pendingPayments.length} √©ch√©ance{pendingPayments.length > 1 ? 's' : ''} en attente\n                            </p>\n                        )}\n                    </div>\n\n                    {/* CTA or Positive message */}\n                    {isUpToDate ? (\n                        <div className=\"w-full py-3 px-4 bg-emerald-500/10 border border-emerald-500/20 rounded-xl flex items-center justify-center gap-2\">\n                            <CheckCircle2 className=\"w-5 h-5 text-emerald-400\" />\n                            <span className=\"text-emerald-300 font-medium text-sm\">Aucun paiement d√ª</span>\n                        </div>\n                    ) : (\n                        <Button\n                            onClick={() => setIsModalOpen(true)}\n                            className=\"w-full h-12 bg-white hover:bg-zinc-100 text-zinc-900 hover:text-zinc-900 font-semibold rounded-xl transition-all hover:shadow-lg hover:scale-[1.02]\"\n                        >\n                            {`Payer ${formatCurrency(currentBalance)} FCFA`}\n                            <ArrowRight className=\"w-4 h-4 ml-2\" />\n                        </Button>\n                    )}\n\n                    {/* Prochain loyer */}\n                    {isUpToDate && (\n                        <div className=\"flex items-center gap-2 mt-3 text-zinc-500\">\n                            <Calendar className=\"w-3.5 h-3.5\" />\n                            <span className=\"text-xs\">Prochain loyer : {getNextRentInfo()}</span>\n                        </div>\n                    )}\n                </div>\n            </div>\n\n            {/* Secure payment logos */}\n            <div className=\"flex items-center justify-center\">\n                <img\n                    src=\"/images/bouton-senegal.png\"\n                    alt=\"Paiement s√©curis√© - Wave, Orange Money, Carte\"\n                    className=\"h-10 w-auto object-contain\"\n                />\n            </div>\n\n            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                ACTIONS RAPIDES\n            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n            <div className=\"grid grid-cols-2 gap-3\">\n                <Link href=\"/locataire/documents\">\n                    <div className=\"group flex items-center gap-3 p-4 rounded-xl bg-white border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all\">\n                        <div className=\"w-10 h-10 rounded-lg bg-zinc-100 flex items-center justify-center group-hover:bg-zinc-200 transition-colors\">\n                            <FileText className=\"w-5 h-5 text-zinc-600\" />\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                            <p className=\"font-medium text-zinc-900 text-sm\">Documents</p>\n                            <p className=\"text-xs text-zinc-500 truncate\">Contrats & quittances</p>\n                        </div>\n                    </div>\n                </Link>\n\n                <Link href=\"/locataire/maintenance\">\n                    <div className=\"group flex items-center gap-3 p-4 rounded-xl bg-white border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all\">\n                        <div className=\"w-10 h-10 rounded-lg bg-zinc-100 flex items-center justify-center group-hover:bg-zinc-200 transition-colors\">\n                            <Wrench className=\"w-5 h-5 text-zinc-600\" />\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                            <p className=\"font-medium text-zinc-900 text-sm\">Signaler</p>\n                            <p className=\"text-xs text-zinc-500 truncate\">Incident ou panne</p>\n                        </div>\n                    </div>\n                </Link>\n            </div>\n\n            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                HISTORIQUE DES TRANSACTIONS\n            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n            {recentPayments.length > 0 && (\n                <div className=\"bg-white rounded-xl border border-zinc-200 overflow-hidden\">\n                    <div className=\"px-4 py-3 border-b border-zinc-100\">\n                        <h2 className=\"font-semibold text-zinc-900\">Historique</h2>\n                    </div>\n\n                    <div className=\"divide-y divide-zinc-100\">\n                        {recentPayments.slice(0, 5).map((payment) => {\n                            const isPaid = payment.status === 'paid';\n                            const period = formatPeriod(payment.period_month, payment.period_year);\n                            const paidDate = formatPaidDate(payment.paid_at);\n\n                            return (\n                                <button\n                                    key={payment.id}\n                                    onClick={() => isPaid ? router.push(`/locataire/paiements/${payment.id}`) : undefined}\n                                    className={`w-full flex items-center justify-between px-4 py-3.5 hover:bg-zinc-50 transition-colors text-left ${isPaid ? 'cursor-pointer' : 'cursor-default'\n                                        }`}\n                                >\n                                    <div className=\"flex items-center gap-3\">\n                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isPaid\n                                            ? 'bg-emerald-50 text-emerald-600'\n                                            : 'bg-amber-50 text-amber-600'\n                                            }`}>\n                                            {isPaid\n                                                ? <CheckCircle2 className=\"w-4 h-4\" />\n                                                : <Clock className=\"w-4 h-4\" />\n                                            }\n                                        </div>\n                                        <div>\n                                            <p className=\"font-medium text-zinc-900 text-sm\">\n                                                {payment.period_month === 0 ? period : `Loyer ${period}`}\n                                            </p>\n                                            <p className=\"text-xs text-zinc-500\">\n                                                {isPaid && paidDate\n                                                    ? `Pay√© le ${paidDate}`\n                                                    : 'En attente de paiement'\n                                                }\n                                            </p>\n                                        </div>\n                                    </div>\n\n                                    <div className=\"flex items-center gap-2\">\n                                        <div className=\"text-right\">\n                                            <p className={`font-semibold tabular-nums ${isPaid ? 'text-zinc-900' : 'text-amber-600'\n                                                }`}>\n                                                {formatCurrency(payment.amount_paid || payment.amount_due)}\n                                                <span className=\"text-xs font-normal text-zinc-400 ml-1\">F</span>\n                                            </p>\n                                            <div className=\"flex items-center gap-1 justify-end\">\n                                                {isPaid && payment.payment_method && (\n                                                    <span className=\"text-[9px] font-medium text-zinc-400 bg-zinc-100 px-1 py-0.5 rounded\">\n                                                        {payment.payment_method === 'stripe' ? 'Carte' :\n                                                         payment.payment_method === 'kkiapay' ? 'Mobile' :\n                                                         payment.payment_method === 'paydunya' ? 'Mobile' :\n                                                         payment.payment_method}\n                                                    </span>\n                                                )}\n                                                <span className={`inline-flex text-[10px] font-medium px-1.5 py-0.5 rounded ${isPaid\n                                                    ? 'bg-emerald-50 text-emerald-700'\n                                                    : 'bg-amber-50 text-amber-700'\n                                                    }`}>\n                                                    {isPaid ? 'Pay√©' : 'En attente'}\n                                                </span>\n                                            </div>\n                                        </div>\n                                        {isPaid && (\n                                            <ChevronRight className=\"w-4 h-4 text-zinc-400\" />\n                                        )}\n                                    </div>\n                                </button>\n                            );\n                        })}\n                    </div>\n\n                    {recentPayments.length > 5 && (\n                        <Link href=\"/locataire/paiements\" className=\"block\">\n                            <div className=\"px-4 py-3 border-t border-zinc-100 flex items-center justify-center gap-1 text-sm text-zinc-600 hover:text-zinc-900 hover:bg-zinc-50 transition-colors\">\n                                Voir tout l&apos;historique\n                                <ChevronRight className=\"w-4 h-4\" />\n                            </div>\n                        </Link>\n                    )}\n                </div>\n            )}\n\n            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                INFOS LOGEMENT\n            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n            <div className=\"bg-zinc-50 rounded-xl p-4 border border-zinc-200\">\n                <div className=\"flex items-start gap-3\">\n                    <div className=\"w-9 h-9 rounded-lg bg-white border border-zinc-200 flex items-center justify-center flex-shrink-0\">\n                        <Building2 className=\"w-4 h-4 text-zinc-500\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-xs text-zinc-500 uppercase tracking-wider mb-0.5\">Votre logement</p>\n                        <p className=\"font-medium text-zinc-900 text-sm truncate\">\n                            {propertyAddress || 'Adresse non renseign√©e'}\n                        </p>\n                        <div className=\"flex items-center gap-2 mt-2 text-xs text-zinc-500 flex-wrap\">\n                            <span>{leaseType || 'Logement'}</span>\n                            <span>¬∑</span>\n                            <span>{formatCurrency(monthlyAmount)} F/mois</span>\n                            {leaseStatus && (\n                                <>\n                                    <span>¬∑</span>\n                                    <span className={`inline-flex px-1.5 py-0.5 rounded text-[10px] font-medium ${\n                                        leaseStatus === 'active' ? 'bg-emerald-50 text-emerald-700' : 'bg-zinc-200 text-zinc-600'\n                                    }`}>\n                                        {leaseStatus === 'active' ? 'Bail actif' : leaseStatus}\n                                    </span>\n                                </>\n                            )}\n                        </div>\n                        {(leaseStartDate || ownerName) && (\n                            <div className=\"flex items-center gap-2 mt-1.5 text-xs text-zinc-400 flex-wrap\">\n                                {leaseStartDate && (\n                                    <span>Du {formatDate(leaseStartDate)}{leaseEndDate ? ` au ${formatDate(leaseEndDate)}` : ''}</span>\n                                )}\n                                {ownerName && (\n                                    <>\n                                        {leaseStartDate && <span>¬∑</span>}\n                                        <span>Propri√©taire : {ownerName}</span>\n                                    </>\n                                )}\n                            </div>\n                        )}\n                    </div>\n                </div>\n            </div>\n\n            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                CONTACT PROPRI√âTAIRE\n            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n            <Link href=\"/locataire/messages\">\n                <div className=\"flex items-center gap-3 p-4 rounded-xl bg-white border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all\">\n                    <div className=\"w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center\">\n                        <MessageSquare className=\"w-5 h-5 text-blue-600\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                        <p className=\"font-medium text-zinc-900 text-sm\">Contacter le propri√©taire</p>\n                        <p className=\"text-xs text-zinc-500\">\n                            {ownerName ? `Envoyer un message √† ${ownerName}` : 'Envoyer un message'}\n                        </p>\n                    </div>\n                    <ChevronRight className=\"w-4 h-4 text-zinc-400\" />\n                </div>\n            </Link>\n\n            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                CTA STICKY MOBILE (si dette > 0)\n            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n            {!isUpToDate && (\n                <div className=\"fixed bottom-16 left-0 right-0 z-40 md:hidden safe-area-pb\">\n                    <div className=\"bg-zinc-900 px-4 py-3 flex items-center justify-between rounded-t-xl shadow-2xl border-t border-zinc-700\">\n                        <div>\n                            <p className=\"text-white font-semibold text-sm\">{formatCurrency(currentBalance)} FCFA</p>\n                            <p className=\"text-zinc-400 text-[10px]\">{pendingPayments.length} √©ch√©ance{pendingPayments.length > 1 ? 's' : ''}</p>\n                        </div>\n                        <Button\n                            onClick={() => setIsModalOpen(true)}\n                            className=\"bg-white hover:bg-zinc-100 text-zinc-900 font-semibold rounded-lg px-5 h-10 text-sm\"\n                        >\n                            Payer maintenant\n                        </Button>\n                    </div>\n                </div>\n            )}\n\n            {/* Modal */}\n            <RentPaymentModal\n                leaseId={leaseId}\n                defaultAmount={targetAmount}\n                month={getCurrentMonth()}\n                propertyAddress={propertyAddress}\n                tenantName={tenantName}\n                tenantEmail={tenantEmail}\n                open={isModalOpen}\n                onOpenChange={setIsModalOpen}\n                targetPeriodMonth={targetPeriodMonth}\n                targetPeriodYear={targetPeriodYear}\n            />\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\components\\RentPaymentModal.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\components\\RentPaymentModal.tsx:55:13\n  53 |     useEffect(() => {\n  54 |         if (!open) {\n> 55 |             setPaymentMethod('select');\n     |             ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  56 |         }\n  57 |     }, [open]);\n  58 |","line":55,"column":13,"nodeType":null,"endLine":55,"endColumn":29}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Shield, CreditCard, Smartphone, ChevronRight, ArrowLeft } from \"lucide-react\";\nimport { toast } from 'sonner';\nimport { useState, useEffect } from 'react';\nimport { PayDunyaRentButton } from '@/components/payment/PayDunyaRentButton';\nimport { StripeRentButton } from '@/components/payment/StripeRentButton';\n\ninterface RentPaymentModalProps {\n    leaseId: string;\n    defaultAmount: number;\n    month?: string;\n    propertyAddress?: string;\n    open: boolean;\n    onOpenChange: (open: boolean) => void;\n    tenantName?: string;\n    tenantEmail?: string;\n    /** Period month to pay for (1-12). If not provided, uses current month */\n    targetPeriodMonth?: number;\n    /** Period year to pay for. If not provided, uses current year */\n    targetPeriodYear?: number;\n}\n\ntype PaymentMethod = 'select' | 'stripe' | 'mobile';\n\nconst MONTH_NAMES = [\n    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\n    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'\n];\n\nconst getPeriodLabel = (month: number, year: number) => {\n    if (month === 0) return 'Garantie / D√©p√¥t de caution';\n    return `${MONTH_NAMES[month - 1]} ${year}`;\n};\n\nexport function RentPaymentModal({\n    leaseId,\n    defaultAmount,\n    _month,\n    propertyAddress,\n    open,\n    onOpenChange,\n    tenantName = \"Locataire\",\n    tenantEmail = \"\",\n    targetPeriodMonth,\n    targetPeriodYear,\n}: RentPaymentModalProps) {\n    const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>('select');\n    const amount = defaultAmount;\n\n    // Reset to selection when modal closes\n    useEffect(() => {\n        if (!open) {\n            setPaymentMethod('select');\n        }\n    }, [open]);\n\n    // Use target period if provided, otherwise default to current month\n    const now = new Date();\n    const periodMonth = targetPeriodMonth || (now.getMonth() + 1);\n    const periodYear = targetPeriodYear || now.getFullYear();\n\n    const formatAmount = (amt: number) => new Intl.NumberFormat('fr-FR').format(amt);\n    const periodLabel = getPeriodLabel(periodMonth, periodYear);\n\n    // DEBUG: Log modal period\n    console.log('üîµ [RentPaymentModal] Period being used:', {\n        periodMonth,\n        periodYear,\n        periodLabel,\n        targetPeriodMonth,\n        targetPeriodYear,\n        amount: defaultAmount\n    });\n\n    return (\n        <Dialog open={open} onOpenChange={onOpenChange}>\n            <DialogContent className=\"sm:max-w-md bg-white border-zinc-200 shadow-2xl\">\n                <DialogHeader className=\"text-center pb-2\">\n                    <div className=\"mx-auto w-14 h-14 bg-zinc-900 rounded-2xl flex items-center justify-center mb-3\">\n                        <Shield className=\"w-7 h-7 text-white\" />\n                    </div>\n                    <DialogTitle className=\"text-xl font-bold text-zinc-900\">\n                        Paiement du loyer\n                    </DialogTitle>\n                    <DialogDescription className=\"text-zinc-500\">\n                        {periodLabel}\n                    </DialogDescription>\n                </DialogHeader>\n\n                {/* Amount Summary */}\n                <div className=\"bg-zinc-50 rounded-xl p-4 my-4\">\n                    <div className=\"flex justify-between items-center\">\n                        <div>\n                            <p className=\"text-sm text-zinc-500\">Montant √† payer</p>\n                            {propertyAddress && (\n                                <p className=\"text-xs text-zinc-400 mt-0.5 truncate max-w-[200px]\">\n                                    {propertyAddress}\n                                </p>\n                            )}\n                        </div>\n                        <div className=\"text-right\">\n                            <p className=\"text-2xl font-bold text-zinc-900\">\n                                {formatAmount(amount)}\n                            </p>\n                            <p className=\"text-xs text-zinc-400\">FCFA</p>\n                        </div>\n                    </div>\n                </div>\n\n                {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                    PAYMENT METHOD SELECTION\n                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n                {paymentMethod === 'select' && (\n                    <div className=\"space-y-3\">\n                        <p className=\"text-sm font-medium text-zinc-700 mb-2\">\n                            Choisissez votre mode de paiement\n                        </p>\n\n                        {/* Stripe - Card Payment */}\n                        <button\n                            onClick={() => setPaymentMethod('stripe')}\n                            className=\"w-full flex items-center gap-4 p-4 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:bg-zinc-50 transition-all group\"\n                        >\n                            <div className=\"w-12 h-12 bg-[#635BFF]/10 rounded-xl flex items-center justify-center\">\n                                <CreditCard className=\"w-6 h-6 text-[#635BFF]\" />\n                            </div>\n                            <div className=\"flex-1 text-left\">\n                                <p className=\"font-semibold text-zinc-900\">Carte Bancaire</p>\n                                <p className=\"text-xs text-zinc-500\">Visa, Mastercard via Stripe</p>\n                            </div>\n                            <ChevronRight className=\"w-5 h-5 text-zinc-400 group-hover:text-zinc-600 transition-colors\" />\n                        </button>\n\n                        {/* Mobile Money - KKiaPay */}\n                        <button\n                            onClick={() => setPaymentMethod('mobile')}\n                            className=\"w-full flex items-center gap-4 p-4 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:bg-zinc-50 transition-all group\"\n                        >\n                            <div className=\"w-12 h-12 bg-amber-500/10 rounded-xl flex items-center justify-center\">\n                                <Smartphone className=\"w-6 h-6 text-amber-600\" />\n                            </div>\n                            <div className=\"flex-1 text-left\">\n                                <p className=\"font-semibold text-zinc-900\">Mobile Money</p>\n                                <p className=\"text-xs text-zinc-500\">Wave, Orange Money</p>\n                            </div>\n                            <ChevronRight className=\"w-5 h-5 text-zinc-400 group-hover:text-zinc-600 transition-colors\" />\n                        </button>\n                    </div>\n                )}\n\n                {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                    STRIPE PAYMENT\n                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n                {paymentMethod === 'stripe' && (\n                    <div className=\"space-y-4\">\n                        <button\n                            onClick={() => setPaymentMethod('select')}\n                            className=\"text-sm text-zinc-500 hover:text-zinc-700 flex items-center gap-1\"\n                        >\n                            <ArrowLeft className=\"w-4 h-4\" />\n                            Changer de m√©thode\n                        </button>\n\n                        <div className=\"bg-[#635BFF]/5 border border-[#635BFF]/20 rounded-xl p-4\">\n                            <div className=\"flex items-center gap-2 mb-3\">\n                                <CreditCard className=\"w-5 h-5 text-[#635BFF]\" />\n                                <span className=\"font-semibold text-zinc-900\">Paiement par carte</span>\n                            </div>\n                            <p className=\"text-xs text-zinc-500 mb-4\">\n                                Vous serez redirig√© vers la page de paiement s√©curis√©e Stripe.\n                            </p>\n                            <StripeRentButton\n                                amount={amount}\n                                periodMonth={periodMonth}\n                                periodYear={periodYear}\n                                propertyAddress={propertyAddress}\n                                onSuccess={() => {\n                                    toast.success(\"Redirection vers Stripe...\");\n                                }}\n                                onError={(error) => {\n                                    toast.error(error);\n                                }}\n                            />\n                        </div>\n\n                        <div className=\"flex items-center justify-center gap-2 text-xs text-zinc-400\">\n                            <Shield className=\"w-3 h-3\" />\n                            Paiement s√©curis√© par Stripe\n                        </div>\n                    </div>\n                )}\n\n                {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n                    MOBILE MONEY PAYMENT\n                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}\n                {paymentMethod === 'mobile' && (\n                    <div className=\"space-y-4\">\n                        <button\n                            onClick={() => setPaymentMethod('select')}\n                            className=\"text-sm text-zinc-500 hover:text-zinc-700 flex items-center gap-1\"\n                        >\n                            <ArrowLeft className=\"w-4 h-4\" />\n                            Changer de m√©thode\n                        </button>\n\n                        <div className=\"bg-amber-50 border border-amber-200 rounded-xl p-4\">\n                            <div className=\"flex items-center gap-2 mb-3\">\n                                <Smartphone className=\"w-5 h-5 text-amber-600\" />\n                                <span className=\"font-semibold text-zinc-900\">Mobile Money</span>\n                            </div>\n                            <p className=\"text-xs text-zinc-600 mb-4\">\n                                Payez avec Wave ou Orange Money. Vous serez redirig√© vers la page de paiement s√©curis√©e.\n                            </p>\n                            <PayDunyaRentButton\n                                amount={amount}\n                                leaseId={leaseId}\n                                tenantName={tenantName}\n                                tenantEmail={tenantEmail}\n                                periodMonth={periodMonth}\n                                periodYear={periodYear}\n                                onSuccess={() => {\n                                    toast.success(\"Redirection vers PayDunya...\");\n                                }}\n                                onError={(error) => {\n                                    toast.error(error);\n                                }}\n                            />\n                        </div>\n\n                        <div className=\"flex items-center justify-center gap-2 text-xs text-zinc-400\">\n                            <Shield className=\"w-3 h-3\" />\n                            Paiement s√©curis√© par PayDunya\n                        </div>\n                    </div>\n                )}\n\n            </DialogContent>\n        </Dialog>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\components\\TenantDesktopNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\components\\TenantMobileNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\documents\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\documents\\components\\InsuranceUpload.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\documents\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1418,1421],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1418,1421],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":142,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":142,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7072,7075],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7072,7075],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":193,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10292,10295],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10292,10295],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getTenantDashboardData } from \"../actions\";\nimport { FileText, Download, FolderOpen, ShieldCheck, ChevronRight, Share2 } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { fr } from \"date-fns/locale\";\nimport { _Button } from \"@/components/ui/button\";\nimport { InsuranceUpload } from \"./components/InsuranceUpload\";\nimport { createAdminClient } from \"@/utils/supabase/admin\";\n\nconst MONTH_NAMES = [\n    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\n    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'\n];\n\nexport default async function TenantDocumentsPage() {\n    const data = await getTenantDashboardData();\n\n    if (!data.hasLease || !data.lease) {\n        return (\n            <div className=\"flex flex-col items-center justify-center py-16 text-center px-4\">\n                <div className=\"w-16 h-16 rounded-full bg-zinc-100 flex items-center justify-center mb-4\">\n                    <FolderOpen className=\"w-8 h-8 text-zinc-400\" />\n                </div>\n                <h3 className=\"text-lg font-semibold text-zinc-900\">Aucun document</h3>\n                <p className=\"max-w-xs mt-2 text-sm text-zinc-500\">\n                    Vos documents appara√Ætront ici une fois votre bail activ√©.\n                </p>\n            </div>\n        );\n    }\n\n    const { lease } = data;\n    const payments = lease.payments || [];\n    const paidPayments = payments.filter((p: any) => p.status === 'paid');\n\n    // Fetch shared documents from owner\n    const adminClient = createAdminClient();\n    const { data: sharedDocs } = await adminClient\n        .from('shared_documents')\n        .select('id, title, file_url, category, created_at')\n        .eq('lease_id', lease.id)\n        .order('created_at', { ascending: false });\n\n    const CATEGORY_LABELS: Record<string, string> = {\n        reglement: 'R√®glement',\n        diagnostic: 'Diagnostic',\n        etat_des_lieux: '√âtat des lieux',\n        other: 'Document',\n    };\n\n    const formatPeriod = (month: number, year: number) => {\n        return `${MONTH_NAMES[(month || 1) - 1]} ${year}`;\n    };\n\n    return (\n        <div className=\"w-full max-w-lg mx-auto px-4 py-6 space-y-6\">\n            {/* Header */}\n            <div>\n                <h1 className=\"text-xl font-bold text-zinc-900\">Mes Documents</h1>\n                <p className=\"text-sm text-zinc-500 mt-0.5\">Contrats, quittances et attestations</p>\n            </div>\n\n            {/* Contrat de Bail */}\n            <section className=\"space-y-3\">\n                <h2 className=\"text-xs font-semibold text-zinc-500 uppercase tracking-wider\">\n                    Contrat\n                </h2>\n                {lease.lease_pdf_url ? (\n                    <a href={lease.lease_pdf_url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"block bg-white rounded-xl border border-zinc-200 overflow-hidden hover:bg-zinc-50 transition-colors\">\n                        <div className=\"flex items-center justify-between p-4\">\n                            <div className=\"flex items-center gap-3\">\n                                <div className=\"w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center\">\n                                    <FileText className=\"w-5 h-5 text-blue-600\" />\n                                </div>\n                                <div>\n                                    <p className=\"font-medium text-zinc-900\">Contrat de Bail</p>\n                                    <p className=\"text-xs text-zinc-500\">\n                                        {lease.created_at\n                                            ? `Sign√© le ${format(new Date(lease.created_at), 'dd MMMM yyyy', { locale: fr })}`\n                                            : 'Date de signature non disponible'}\n                                    </p>\n                                </div>\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                                <Download className=\"w-4 h-4 text-zinc-500\" />\n                                <ChevronRight className=\"w-4 h-4 text-zinc-400\" />\n                            </div>\n                        </div>\n                    </a>\n                ) : (\n                    <div className=\"bg-white rounded-xl border border-zinc-200 overflow-hidden\">\n                        <div className=\"flex items-center justify-between p-4\">\n                            <div className=\"flex items-center gap-3\">\n                                <div className=\"w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center\">\n                                    <FileText className=\"w-5 h-5 text-blue-600\" />\n                                </div>\n                                <div>\n                                    <p className=\"font-medium text-zinc-900\">Contrat de Bail</p>\n                                    <p className=\"text-xs text-zinc-500\">Non disponible</p>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                )}\n            </section>\n\n            {/* Assurance */}\n            <section className=\"space-y-3\">\n                <h2 className=\"text-xs font-semibold text-zinc-500 uppercase tracking-wider\">\n                    Assurance\n                </h2>\n                <div className=\"bg-white rounded-xl border border-zinc-200 overflow-hidden\">\n                    <div className=\"flex items-center justify-between p-4\">\n                        <div className=\"flex items-center gap-3\">\n                            <div className=\"w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center\">\n                                <ShieldCheck className=\"w-5 h-5 text-indigo-600\" />\n                            </div>\n                            <div>\n                                <p className=\"font-medium text-zinc-900\">Assurance Habitation</p>\n                                <p className=\"text-xs text-zinc-500\">Document obligatoire</p>\n                            </div>\n                        </div>\n                        <InsuranceUpload leaseId={lease.id} existingUrl={lease.insurance_url} />\n                    </div>\n                </div>\n            </section>\n\n            {/* Quittances */}\n            <section className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                    <h2 className=\"text-xs font-semibold text-zinc-500 uppercase tracking-wider\">\n                        Quittances de loyer\n                    </h2>\n                    {paidPayments.length > 0 && (\n                        <span className=\"text-xs text-zinc-400\">\n                            {paidPayments.length} document{paidPayments.length > 1 ? 's' : ''}\n                        </span>\n                    )}\n                </div>\n\n                {paidPayments.length > 0 ? (\n                    <div className=\"bg-white rounded-xl border border-zinc-200 overflow-hidden divide-y divide-zinc-100\">\n                        {paidPayments.map((payment: any) => {\n                            const period = formatPeriod(payment.period_month, payment.period_year);\n                            const receiptUrl = payment.receipt_url || `/api/tenant/receipt/${payment.id}`;\n\n                            return (\n                                <a key={payment.id} href={receiptUrl} target=\"_blank\" rel=\"noopener noreferrer\">\n                                    <div className=\"flex items-center justify-between p-4 hover:bg-zinc-50 transition-colors cursor-pointer\">\n                                        <div className=\"flex items-center gap-3\">\n                                            <div className=\"w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center\">\n                                                <FileText className=\"w-5 h-5 text-emerald-600\" />\n                                            </div>\n                                            <div>\n                                                <p className=\"font-medium text-zinc-900\">Quittance {period}</p>\n                                                <p className=\"text-xs text-zinc-500\">\n                                                    {payment.amount_due?.toLocaleString('fr-FR')} FCFA\n                                                </p>\n                                            </div>\n                                        </div>\n                                        <div className=\"flex items-center gap-1\">\n                                            <Download className=\"w-4 h-4 text-zinc-500\" />\n                                            <ChevronRight className=\"w-4 h-4 text-zinc-400\" />\n                                        </div>\n                                    </div>\n                                </a>\n                            );\n                        })}\n                    </div>\n                ) : (\n                    <div className=\"bg-zinc-50 rounded-xl border border-dashed border-zinc-200 py-12 px-4 text-center\">\n                        <FolderOpen className=\"w-10 h-10 text-zinc-300 mx-auto mb-3\" />\n                        <p className=\"text-sm font-medium text-zinc-600\">Aucune quittance disponible</p>\n                        <p className=\"text-xs text-zinc-400 mt-1\">\n                            Vos quittances appara√Ætront ici apr√®s chaque paiement valid√©\n                        </p>\n                    </div>\n                )}\n            </section>\n\n            {/* Documents partag√©s */}\n            {sharedDocs && sharedDocs.length > 0 && (\n                <section className=\"space-y-3\">\n                    <div className=\"flex items-center justify-between\">\n                        <h2 className=\"text-xs font-semibold text-zinc-500 uppercase tracking-wider\">\n                            Documents partag√©s\n                        </h2>\n                        <span className=\"text-xs text-zinc-400\">\n                            {sharedDocs.length} document{sharedDocs.length > 1 ? 's' : ''}\n                        </span>\n                    </div>\n\n                    <div className=\"bg-white rounded-xl border border-zinc-200 overflow-hidden divide-y divide-zinc-100\">\n                        {sharedDocs.map((doc: any) => (\n                            <a\n                                key={doc.id}\n                                href={doc.file_url}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"flex items-center justify-between p-4 hover:bg-zinc-50 transition-colors cursor-pointer\"\n                            >\n                                <div className=\"flex items-center gap-3\">\n                                    <div className=\"w-10 h-10 rounded-lg bg-violet-50 flex items-center justify-center\">\n                                        <Share2 className=\"w-5 h-5 text-violet-600\" />\n                                    </div>\n                                    <div>\n                                        <p className=\"font-medium text-zinc-900\">{doc.title}</p>\n                                        <p className=\"text-xs text-zinc-500\">\n                                            {CATEGORY_LABELS[doc.category] || 'Document'}\n                                            {doc.created_at && ` ¬∑ ${format(new Date(doc.created_at), 'dd MMM yyyy', { locale: fr })}`}\n                                        </p>\n                                    </div>\n                                </div>\n                                <div className=\"flex items-center gap-1\">\n                                    <Download className=\"w-4 h-4 text-zinc-500\" />\n                                    <ChevronRight className=\"w-4 h-4 text-zinc-400\" />\n                                </div>\n                            </a>\n                        ))}\n                    </div>\n                </section>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\expired\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\expired\\expired-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\expired\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\maintenance\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\maintenance\\components\\MaintenanceForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\maintenance\\new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\maintenance\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":95,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":98,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1120,1123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1120,1123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadRequests` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\maintenance\\page.tsx:105:9\n  103 |\n  104 |     useEffect(() => {\n> 105 |         loadRequests();\n      |         ^^^^^^^^^^^^ `loadRequests` accessed before it is declared\n  106 |     }, []);\n  107 |\n  108 |     const loadRequests = async () => {\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\maintenance\\page.tsx:108:5\n  106 |     }, []);\n  107 |\n> 108 |     const loadRequests = async () => {\n      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 109 |         const data = await getTenantMaintenanceRequests();\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 110 |         setRequests(data);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 111 |         setLoading(false);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 112 |     };\n      | ^^^^^^^ `loadRequests` is declared here\n  113 |\n  114 |     const handleConfirmSlot = async (id: string) => {\n  115 |         setProcessingResponseId(id);","line":105,"column":9,"nodeType":null,"endLine":105,"endColumn":21},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":243,"column":53,"nodeType":"JSXOpeningElement","endLine":248,"endColumn":55}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport {\n    Plus,\n    Wrench,\n    Clock,\n    CheckCircle2,\n    ChevronDown,\n    ChevronUp,\n    Phone,\n    Calendar,\n    CircleDollarSign,\n    X,\n    Loader2,\n    Check,\n    AlertTriangle\n} from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\nimport { toast } from 'sonner';\nimport { getTenantMaintenanceRequests, cancelMaintenanceRequest, respondToMaintenanceSlot } from './actions';\n\ntype MaintenanceRequest = {\n    id: string;\n    category: string;\n    description: string;\n    status: string;\n    photo_urls?: string[];\n    created_at: string;\n    artisan_name?: string;\n    artisan_phone?: string;\n    artisan_rating?: number;\n    quoted_price?: number;\n    intervention_date?: string;\n    tenant_response?: 'confirmed' | 'reschedule_requested';\n    tenant_suggested_date?: string;\n    rejection_reason?: string;\n    quote_url?: string;\n};\n\nconst statusConfig: Record<string, { label: string; bgColor: string; textColor: string; icon: any }> = {\n    'submitted': {\n        label: 'En attente de validation',\n        bgColor: 'bg-zinc-100',\n        textColor: 'text-zinc-600',\n        icon: Clock\n    },\n    'open': {\n        label: 'Recherche d&apos;artisan',\n        bgColor: 'bg-amber-50',\n        textColor: 'text-amber-700',\n        icon: Clock\n    },\n    'artisan_found': {\n        label: 'Artisan trouv√©',\n        bgColor: 'bg-blue-50',\n        textColor: 'text-blue-700',\n        icon: Wrench\n    },\n    'awaiting_approval': {\n        label: 'Devis en attente',\n        bgColor: 'bg-purple-50',\n        textColor: 'text-purple-700',\n        icon: CircleDollarSign\n    },\n    'approved': {\n        label: 'Approuv√©',\n        bgColor: 'bg-emerald-50',\n        textColor: 'text-emerald-700',\n        icon: CheckCircle2\n    },\n    'in_progress': {\n        label: 'En cours',\n        bgColor: 'bg-blue-50',\n        textColor: 'text-blue-700',\n        icon: Wrench\n    },\n    'completed': {\n        label: 'Termin√©',\n        bgColor: 'bg-emerald-50',\n        textColor: 'text-emerald-700',\n        icon: CheckCircle2\n    },\n    'rejected': {\n        label: 'Rejet√©',\n        bgColor: 'bg-red-50',\n        textColor: 'text-red-700',\n        icon: AlertTriangle\n    },\n};\n\nexport default function MaintenanceListPage() {\n    const [requests, setRequests] = useState<MaintenanceRequest[]>([]);\n    const [loading, setLoading] = useState(true);\n    const [expandedId, setExpandedId] = useState<string | null>(null);\n    const [cancellingId, setCancellingId] = useState<string | null>(null);\n    const [processingResponseId, setProcessingResponseId] = useState<string | null>(null);\n    const [suggestedDate, setSuggestedDate] = useState<string>('');\n    const [showReschedule, setShowReschedule] = useState<string | null>(null);\n\n    useEffect(() => {\n        loadRequests();\n    }, []);\n\n    const loadRequests = async () => {\n        const data = await getTenantMaintenanceRequests();\n        setRequests(data);\n        setLoading(false);\n    };\n\n    const handleConfirmSlot = async (id: string) => {\n        setProcessingResponseId(id);\n        const result = await respondToMaintenanceSlot(id, 'confirmed');\n        if (result.success) {\n            toast.success(\"Pr√©sence confirm√©e !\");\n            loadRequests();\n        } else {\n            toast.error(result.error || \"Une erreur est survenue\");\n        }\n        setProcessingResponseId(null);\n    };\n\n    const handleRescheduleSlot = async (id: string) => {\n        if (!suggestedDate) {\n            toast.error(\"Veuillez choisir une date\");\n            return;\n        }\n        setProcessingResponseId(id);\n        const result = await respondToMaintenanceSlot(id, 'reschedule_requested', suggestedDate);\n        if (result.success) {\n            toast.success(\"Demande de report envoy√©e\");\n            loadRequests();\n            setShowReschedule(null);\n        } else {\n            toast.error(result.error || \"Une erreur est survenue\");\n        }\n        setProcessingResponseId(null);\n        setSuggestedDate('');\n    };\n\n    const handleCancel = async (id: string) => {\n        if (!confirm(\"Voulez-vous vraiment annuler ce signalement ?\")) return;\n\n        setCancellingId(id);\n        const result = await cancelMaintenanceRequest(id);\n\n        if (result.error) {\n            toast.error(result.error);\n        } else {\n            toast.success(\"Signalement annul√©\");\n            setRequests(requests.filter(r => r.id !== id));\n        }\n        setCancellingId(null);\n    };\n\n    const toggleExpand = (id: string) => {\n        setExpandedId(expandedId === id ? null : id);\n    };\n\n    if (loading) {\n        return (\n            <div className=\"min-h-[60vh] flex items-center justify-center\">\n                <Loader2 className=\"w-8 h-8 text-zinc-400 animate-spin\" />\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"w-full max-w-lg mx-auto px-4 py-6 pb-24 space-y-6\">\n            {/* Header */}\n            <div>\n                <h1 className=\"text-xl font-bold text-zinc-900\">Mes Signalements</h1>\n                <p className=\"text-sm text-zinc-500 mt-0.5\">Suivez vos demandes d&apos;intervention</p>\n            </div>\n\n            {/* List */}\n            {requests.length === 0 ? (\n                <div className=\"flex flex-col items-center justify-center py-16 text-center\">\n                    <div className=\"w-16 h-16 rounded-full bg-zinc-100 flex items-center justify-center mb-4\">\n                        <Wrench className=\"w-8 h-8 text-zinc-400\" />\n                    </div>\n                    <h3 className=\"text-lg font-semibold text-zinc-900\">Aucun signalement</h3>\n                    <p className=\"max-w-xs mt-2 text-sm text-zinc-500\">\n                        Vous n&apos;avez pas encore signal√© de probl√®me.\n                    </p>\n                    <Link href=\"/locataire/maintenance/new\">\n                        <Button className=\"mt-6 bg-zinc-900 hover:bg-zinc-800 text-white\">\n                            <Plus className=\"w-4 h-4 mr-2\" />\n                            Nouveau signalement\n                        </Button>\n                    </Link>\n                </div>\n            ) : (\n                <div className=\"space-y-3\">\n                    {requests.map((req) => {\n                        const status = statusConfig[req.status] || statusConfig['submitted'];\n                        const StatusIcon = status.icon;\n                        const isExpanded = expandedId === req.id;\n                        const canCancel = ['submitted', 'open'].includes(req.status);\n\n                        return (\n                            <div\n                                key={req.id}\n                                className=\"bg-white rounded-xl border border-zinc-200 overflow-hidden\"\n                            >\n                                {/* Main Row */}\n                                <button\n                                    onClick={() => toggleExpand(req.id)}\n                                    className=\"w-full p-4 text-left\"\n                                >\n                                    <div className=\"flex items-start justify-between mb-2\">\n                                        <span className=\"text-[10px] font-semibold uppercase tracking-wider text-zinc-400\">\n                                            {req.category || 'Autre'}\n                                        </span>\n                                        <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${status.bgColor} ${status.textColor}`}>\n                                            <StatusIcon className=\"w-3 h-3\" />\n                                            {status.label}\n                                        </span>\n                                    </div>\n\n                                    <p className=\"text-zinc-900 font-medium line-clamp-2 mb-3 text-sm\">\n                                        {req.description}\n                                    </p>\n\n                                    <div className=\"flex items-center justify-between text-xs text-zinc-400\">\n                                        <span>{format(new Date(req.created_at), 'd MMM yyyy', { locale: fr })}</span>\n                                        <div className=\"flex items-center gap-1\">\n                                            {isExpanded ? <ChevronUp className=\"w-4 h-4\" /> : <ChevronDown className=\"w-4 h-4\" />}\n                                        </div>\n                                    </div>\n                                </button>\n\n                                {/* Expanded Details */}\n                                {isExpanded && (\n                                    <div className=\"px-4 pb-4 pt-0 border-t border-zinc-100 space-y-3\">\n                                        {/* Photos */}\n                                        {req.photo_urls && req.photo_urls.length > 0 && (\n                                            <div className=\"flex gap-2 pt-3 overflow-x-auto\">\n                                                {req.photo_urls.map((url, i) => (\n                                                    <img\n                                                        key={i}\n                                                        src={url}\n                                                        alt={`Photo ${i + 1}`}\n                                                        className=\"w-20 h-20 rounded-lg object-cover flex-shrink-0 border border-zinc-200\"\n                                                    />\n                                                ))}\n                                            </div>\n                                        )}\n\n                                        {/* Rejection Reason */}\n                                        {req.status === 'rejected' && req.rejection_reason && (\n                                            <div className=\"py-2 px-3 bg-red-50 text-red-700 rounded-lg text-xs font-medium flex items-start gap-2 border border-red-100\">\n                                                <AlertTriangle className=\"w-4 h-4 mt-0.5\" />\n                                                <div>\n                                                    <p className=\"font-bold uppercase text-[9px]\">Motif du rejet :</p>\n                                                    <p>{req.rejection_reason}</p>\n                                                </div>\n                                            </div>\n                                        )}\n\n                                        {/* Coordination Flow (Confirm/Reschedule) */}\n                                        {req.status === 'approved' && req.intervention_date && !req.tenant_response && (\n                                            <div className=\"py-3 border-b border-zinc-100\">\n                                                <div className=\"bg-amber-50 rounded-lg p-3 border border-amber-100\">\n                                                    <p className=\"text-[11px] font-semibold text-amber-800 uppercase tracking-tight mb-2 flex items-center gap-1\">\n                                                        <Calendar className=\"w-3 h-3\" /> Confirmation requise\n                                                    </p>\n                                                    <p className=\"text-xs text-amber-700 leading-relaxed mb-3\">\n                                                        L&apos;intervention est pr√©vue pour le <strong>{format(new Date(req.intervention_date), 'd MMMM', { locale: fr })}</strong>. √ätes-vous disponible ?\n                                                    </p>\n\n                                                    {showReschedule === req.id ? (\n                                                        <div className=\"space-y-2\">\n                                                            <input\n                                                                type=\"datetime-local\"\n                                                                className=\"w-full rounded border-zinc-200 text-xs p-2\"\n                                                                value={suggestedDate}\n                                                                onChange={(e) => setSuggestedDate(e.target.value)}\n                                                            />\n                                                            <div className=\"flex gap-2\">\n                                                                <Button\n                                                                    size=\"sm\"\n                                                                    onClick={() => handleRescheduleSlot(req.id)}\n                                                                    disabled={processingResponseId === req.id}\n                                                                    className=\"flex-1 text-xs bg-zinc-900 h-8\"\n                                                                >\n                                                                    {processingResponseId === req.id ? <Loader2 className=\"w-3 h-3 animate-spin\" /> : \"Envoyer\"}\n                                                                </Button>\n                                                                <Button\n                                                                    size=\"sm\"\n                                                                    variant=\"outline\"\n                                                                    onClick={() => setShowReschedule(null)}\n                                                                    className=\"text-xs h-8\"\n                                                                >\n                                                                    Annuler\n                                                                </Button>\n                                                            </div>\n                                                        </div>\n                                                    ) : (\n                                                        <div className=\"flex gap-2\">\n                                                            <Button\n                                                                size=\"sm\"\n                                                                onClick={() => handleConfirmSlot(req.id)}\n                                                                disabled={processingResponseId === req.id}\n                                                                className=\"flex-1 text-xs bg-emerald-600 hover:bg-emerald-700 h-8\"\n                                                            >\n                                                                {processingResponseId === req.id ? <Loader2 className=\"w-3 h-3 animate-spin\" /> : <><Check className=\"w-3 h-3 mr-1\" /> Je confirme</>}\n                                                            </Button>\n                                                            <Button\n                                                                size=\"sm\"\n                                                                variant=\"outline\"\n                                                                onClick={() => setShowReschedule(req.id)}\n                                                                className=\"flex-1 text-xs h-8\"\n                                                            >\n                                                                Reporter\n                                                            </Button>\n                                                        </div>\n                                                    )}\n                                                </div>\n                                            </div>\n                                        )}\n\n                                        {/* Feedback confirmed status */}\n                                        {req.tenant_response === 'confirmed' && (\n                                            <div className=\"py-2 px-3 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-medium flex items-center gap-2\">\n                                                <CheckCircle2 className=\"w-4 h-4\" /> Pr√©sence confirm√©e pour le {format(new Date(req.intervention_date!), 'd MMMM', { locale: fr })}\n                                            </div>\n                                        )}\n\n                                        {/* Feedback reschedule_requested status */}\n                                        {req.tenant_response === 'reschedule_requested' && (\n                                            <div className=\"py-2 px-3 bg-amber-50 text-amber-700 rounded-lg text-xs font-medium flex items-center gap-2 border border-amber-100\">\n                                                <Clock className=\"w-4 h-4\" /> Report demand√© pour le {req.tenant_suggested_date ? format(new Date(req.tenant_suggested_date), 'd MMMM √† HH:mm', { locale: fr }) : '√† venir'}\n                                            </div>\n                                        )}\n\n                                        {/* Artisan Info */}\n                                        {req.artisan_name && (\n                                            <div className=\"rounded-lg bg-zinc-50 p-3 space-y-2\">\n                                                <p className=\"text-[10px] text-zinc-500 uppercase tracking-wider font-medium\">\n                                                    Artisan assign√©\n                                                </p>\n                                                <div className=\"flex items-center justify-between\">\n                                                    <div>\n                                                        <p className=\"text-zinc-900 font-medium\">{req.artisan_name}</p>\n                                                        {req.artisan_rating && (\n                                                            <p className=\"text-xs text-amber-600\">‚≠ê {req.artisan_rating.toFixed(1)}</p>\n                                                        )}\n                                                    </div>\n                                                    {req.artisan_phone && (\n                                                        <a\n                                                            href={`tel:${req.artisan_phone}`}\n                                                            className=\"w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center hover:bg-emerald-600 transition-colors\"\n                                                        >\n                                                            <Phone className=\"w-5 h-5 text-white\" />\n                                                        </a>\n                                                    )}\n                                                </div>\n                                            </div>\n                                        )}\n\n                                        {/* Quote & Date */}\n                                        {(req.quoted_price || req.intervention_date) && (\n                                            <div className=\"grid grid-cols-2 gap-2\">\n                                                {req.quoted_price && (\n                                                    <div className=\"rounded-lg bg-zinc-50 p-3\">\n                                                        <p className=\"text-[10px] text-zinc-500 flex items-center gap-1 uppercase tracking-wider font-medium\">\n                                                            <CircleDollarSign className=\"w-3 h-3\" /> Devis\n                                                        </p>\n                                                        <div className=\"flex items-center gap-2 mt-1\">\n                                                            <p className=\"text-zinc-900 font-semibold\">\n                                                                {req.quoted_price.toLocaleString('fr-FR')} F\n                                                            </p>\n                                                            {req.quote_url && (\n                                                                <a\n                                                                    href={req.quote_url}\n                                                                    target=\"_blank\"\n                                                                    rel=\"noopener noreferrer\"\n                                                                    className=\"text-[10px] bg-zinc-200 hover:bg-zinc-300 text-zinc-700 px-2 py-0.5 rounded flex items-center gap-1 transition-colors\"\n                                                                    onClick={(e) => e.stopPropagation()}\n                                                                >\n                                                                    PDF ‚Üó\n                                                                </a>\n                                                            )}\n                                                        </div>\n                                                    </div>\n                                                )}\n                                                {req.intervention_date && (\n                                                    <div className=\"rounded-lg bg-zinc-50 p-3 text-left\">\n                                                        <p className=\"text-[10px] text-zinc-500 flex items-center gap-1 uppercase tracking-wider font-medium\">\n                                                            <Calendar className=\"w-3 h-3\" /> Intervention\n                                                        </p>\n                                                        <p className=\"text-zinc-900 font-semibold mt-1\">\n                                                            {format(new Date(req.intervention_date), 'd MMM', { locale: fr })}\n                                                        </p>\n                                                    </div>\n                                                )}\n                                            </div>\n                                        )}\n\n                                        {/* Cancel Button */}\n                                        {canCancel && (\n                                            <Button\n                                                variant=\"ghost\"\n                                                size=\"sm\"\n                                                onClick={() => handleCancel(req.id)}\n                                                disabled={cancellingId === req.id}\n                                                className=\"w-full text-zinc-500 hover:text-red-600 hover:bg-red-50 text-xs\"\n                                            >\n                                                {cancellingId === req.id ? (\n                                                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                                                ) : (\n                                                    <X className=\"w-4 h-4 mr-2\" />\n                                                )}\n                                                Annuler ce signalement\n                                            </Button>\n                                        )}\n                                    </div>\n                                )}\n                            </div>\n                        );\n                    })}\n                </div>\n            )}\n\n            {/* FAB */}\n            {requests.length > 0 && (\n                <Link\n                    href=\"/locataire/maintenance/new\"\n                    className=\"fixed bottom-24 right-4 w-14 h-14 bg-zinc-900 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-zinc-800 transition-colors z-20\"\n                >\n                    <Plus className=\"w-7 h-7\" />\n                </Link>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\messages\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1390,1393],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1390,1393],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":139,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":139,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4526,4529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4526,4529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\nimport { sendEmail } from '@/lib/mail';\nimport { getTenantSessionFromCookie } from '@/lib/tenant-magic-link';\nimport { notifyUser } from '@/lib/notifications';\n\n/**\n * Get messages for the tenant's lease\n * Uses cookie-based tenant session (NOT supabase auth)\n */\nexport async function getTenantMessages() {\n    // Get tenant session from cookie\n    const session = await getTenantSessionFromCookie();\n\n    if (!session) {\n        return { messages: [], leaseId: null, ownerName: null, ownerId: null };\n    }\n\n    const _supabase = await createClient();\n\n    // Get the lease with owner info using service role to bypass RLS\n    const { createClient: createAdminClient } = await import(\"@supabase/supabase-js\");\n    const supabaseAdmin = createAdminClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.SUPABASE_SERVICE_ROLE_KEY!\n    );\n\n    // Get owner info from the lease\n    const { data: lease } = await supabaseAdmin\n        .from('leases')\n        .select('owner_id, owner:profiles(id, full_name)')\n        .eq('id', session.lease_id)\n        .single();\n\n    if (!lease) {\n        return { messages: [], leaseId: session.lease_id, ownerName: null, ownerId: null };\n    }\n\n    const ownerId = lease.owner_id;\n    const ownerName = (lease.owner as any)?.full_name || 'Propri√©taire';\n\n    // Get messages for this lease\n    const { data: messages, error } = await supabaseAdmin\n        .from('messages')\n        .select('*')\n        .eq('lease_id', session.lease_id)\n        .order('created_at', { ascending: true });\n\n    if (error) {\n        console.error(\"Erreur r√©cup√©ration messages:\", error);\n        return { messages: [], leaseId: session.lease_id, ownerName, ownerId };\n    }\n\n    return {\n        messages: messages || [],\n        leaseId: session.lease_id,\n        ownerName,\n        ownerId\n    };\n}\n\n/**\n * Mark all owner messages as read by the tenant.\n * Uses cookie-based tenant session (NOT supabase auth)\n */\nexport async function markTenantMessagesAsRead() {\n    const session = await getTenantSessionFromCookie();\n    if (!session) return;\n\n    const { createClient: createAdminClient } = await import(\"@supabase/supabase-js\");\n    const supabaseAdmin = createAdminClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.SUPABASE_SERVICE_ROLE_KEY!\n    );\n\n    await supabaseAdmin\n        .from('messages')\n        .update({ read_at: new Date().toISOString() })\n        .eq('lease_id', session.lease_id)\n        .eq('sender_type', 'owner')\n        .is('read_at', null);\n}\n\n/**\n * Send a message from tenant to owner\n * Uses cookie-based tenant session (NOT supabase auth)\n */\nexport async function sendTenantMessage(leaseId: string, content: string) {\n    // Get tenant session from cookie\n    const session = await getTenantSessionFromCookie();\n\n    if (!session) {\n        return { error: \"Session expir√©e. Veuillez vous reconnecter via le lien envoy√© par email.\" };\n    }\n\n    // Verify the lease matches the session\n    if (session.lease_id !== leaseId) {\n        return { error: \"Acc√®s non autoris√©\" };\n    }\n\n    // Use admin client to insert message (bypass RLS since tenant has no auth user)\n    const { createClient: createAdminClient } = await import(\"@supabase/supabase-js\");\n    const supabaseAdmin = createAdminClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.SUPABASE_SERVICE_ROLE_KEY!\n    );\n\n    // Get the owner_id from lease to set as sender context\n    const { data: lease } = await supabaseAdmin\n        .from('leases')\n        .select('owner_id, team_id, tenant_name, owner:profiles(email, full_name)')\n        .eq('id', leaseId)\n        .single();\n\n    if (!lease) {\n        return { error: \"Bail non trouv√©\" };\n    }\n\n    // Insert message: sender_id is UUID type, so use owner_id as placeholder\n    // and sender_type='tenant' to distinguish tenant messages from owner messages\n    const { error } = await supabaseAdmin\n        .from('messages')\n        .insert({\n            lease_id: leaseId,\n            sender_id: lease.owner_id,\n            sender_type: 'tenant',\n            content: content,\n            ...(lease.team_id ? { team_id: lease.team_id } : {}),\n        });\n\n    if (error) {\n        console.error(\"Erreur envoi message:\", error);\n        return { error: \"Impossible d'envoyer le message\" };\n    }\n\n    // Send email notification to owner\n    const ownerEmail = (lease.owner as any)?.email;\n    const tenantName = lease.tenant_name || session.tenant_name || \"Votre locataire\";\n\n    if (ownerEmail) {\n        try {\n            await sendEmail({\n                to: ownerEmail,\n                subject: `Nouveau message de ${tenantName}`,\n                html: `\n                    <p>Bonjour,</p>\n                    <p>Vous avez re√ßu un nouveau message de <strong>${tenantName}</strong> sur votre portail propri√©taire.</p>\n                    <p><em>\"${content.substring(0, 200)}${content.length > 200 ? '...' : ''}\"</em></p>\n                    <a href=\"${process.env.NEXT_PUBLIC_APP_URL}/gestion/messages/${leaseId}\">R√©pondre</a>\n                `\n            });\n        } catch (mailError) {\n            console.error(\"Erreur envoi mail notif:\", mailError);\n            // Don't block UI for email errors\n        }\n    }\n\n    // Notification Push √† l'Owner\n    await notifyUser({\n        userId: lease.owner_id,\n        type: 'message',\n        title: `Message de ${tenantName}`,\n        message: content,\n        resourcePath: `/gestion/messages/${leaseId}`\n    });\n\n    revalidatePath('/locataire/messages');\n    return { success: true };\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\messages\\components\\ChatInterface.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\messages\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":100,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3768,3771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3768,3771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { getTenantDashboardData } from \"./actions\";\nimport { PaymentForm } from \"./components/PaymentForm\";\nimport { CookieMigrator } from \"./components/CookieMigrator\";\nimport { FileText } from \"lucide-react\";\n\n// Force dynamic rendering - always fetch fresh data from DB\nexport const dynamic = \"force-dynamic\";\n\ninterface PageProps {\n  searchParams: Promise<{ token?: string }>;\n}\n\n/**\n * Tenant Portal Main Page\n *\n * Handles two access scenarios:\n * 1. First access via Magic Link (token in URL)\n *    - Redirects to /verify (which handles validation + cookie creation)\n *\n * 2. Subsequent access (session cookie exists)\n *    - Uses session cookie for authentication\n *    - Shows dashboard directly\n *\n * Note: Cookie creation is handled exclusively by Server Actions\n * (verifyTenantIdentity, activateTenantSession) because Next.js 16\n * forbids cookies().set() in Server Components.\n */\nexport default async function TenantPortalPage({ searchParams }: PageProps) {\n  const { token } = await searchParams;\n  const cookieStore = await cookies();\n  const sessionToken = cookieStore.get(\"tenant_session\")?.value;\n\n  // If token in URL, handle Magic Link access\n  if (token) {\n    // ALWAYS redirect to /verify when there's a token in the URL.\n    // Even if a cookie exists, it might be stale/invalid (from a previous\n    // token that was replaced). The /verify page will:\n    // - Validate the new token\n    // - Create a fresh session cookie\n    // - Auto-activate if already verified, or show name form if first access\n    redirect(`/locataire/verify?token=${token}`);\n  }\n\n  // No token in URL - use session cookie\n  if (!sessionToken) {\n    redirect(\"/locataire/expired?error=no_session\");\n  }\n\n  // Get dashboard data using session\n  const data = await getTenantDashboardData();\n\n  if (!data.hasLease || !data.lease) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[60vh]\">\n        <div className=\"max-w-md w-full bg-white border border-slate-200 rounded-2xl p-8 text-center shadow-sm\">\n          <div className=\"w-16 h-16 bg-slate-100 border border-slate-200 rounded-2xl flex items-center justify-center mx-auto mb-4\">\n            <FileText className=\"w-8 h-8 text-slate-400\" />\n          </div>\n          <h1 className=\"text-lg font-semibold text-slate-900 mb-2\">\n            Aucune location trouv√©e\n          </h1>\n          <p className=\"text-sm text-slate-600 mb-6\">\n            Nous n&apos;avons trouv√© aucune location active associ√©e √† votre\n            acc√®s.\n          </p>\n          <div className=\"bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm\">\n            <p className=\"font-medium text-slate-900\">\n              üí° Contactez votre propri√©taire\n            </p>\n            <p className=\"text-xs text-slate-500 mt-2\">\n              Si vous pensez qu&apos;il s&apos;agit d&apos;une erreur, demandez\n              un nouveau lien d&apos;acc√®s.\n            </p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const { lease } = data;\n  const property = lease.property;\n\n  return (\n    <>\n      {/* Migrate cookie path on page load for API access */}\n      <CookieMigrator />\n      <PaymentForm\n        leaseId={lease.id}\n        monthlyAmount={lease.monthly_amount || 0}\n        tenantName={data.tenantName || lease.tenant_name}\n        tenantEmail={lease.tenant_email || \"\"}\n        propertyAddress={property?.location?.address || lease.property_address}\n        leaseStartDate={lease.start_date}\n        leaseEndDate={lease.end_date}\n        leaseType={property?.details?.type || \"Appartement\"}\n        leaseStatus={lease.status}\n        billingDay={lease.billing_day || 5}\n        ownerName={(lease.owner as any)?.full_name || undefined}\n        recentPayments={lease.payments || []}\n      />\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiement-succes\\haptic-trigger.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiement-succes\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiements\\[id]\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiements\\[id]\\page.tsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadTransactionDetail` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiements\\[id]\\page.tsx:88:9\n  86 |\n  87 |     useEffect(() => {\n> 88 |         loadTransactionDetail();\n     |         ^^^^^^^^^^^^^^^^^^^^^ `loadTransactionDetail` accessed before it is declared\n  89 |     }, [params.id]);\n  90 |\n  91 |     const loadTransactionDetail = async () => {\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiements\\[id]\\page.tsx:91:5\n   89 |     }, [params.id]);\n   90 |\n>  91 |     const loadTransactionDetail = async () => {\n      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  92 |         if (!params.id || typeof params.id !== 'string') {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  93 |             setLoading(false);\n      ‚Ä¶\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 103 |         setLoading(false);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 104 |     };\n      | ^^^^^^^ `loadTransactionDetail` is declared here\n  105 |\n  106 |     const formatCurrency = (amount?: number | null) => {\n  107 |         if (!amount && amount !== 0) return '0';","line":88,"column":9,"nodeType":null,"endLine":88,"endColumn":30},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadTransactionDetail'. Either include it or remove the dependency array.","line":89,"column":8,"nodeType":"ArrayExpression","endLine":89,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [loadTransactionDetail, params.id]","fix":{"range":[2331,2342],"text":"[loadTransactionDetail, params.id]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { useParams, useRouter } from 'next/navigation';\r\nimport {\r\n    ArrowLeft,\r\n    CheckCircle2,\r\n    Clock,\r\n    AlertTriangle,\r\n    Loader2,\r\n    Receipt,\r\n    CreditCard,\r\n    Smartphone,\r\n    UserCheck,\r\n    Copy,\r\n    Check,\r\n    Download,\r\n    RefreshCw,\r\n    Edit2\r\n} from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { getTransactionDetail } from './actions';\r\n\r\ntype PaymentMeta = {\r\n    provider?: string;\r\n    // Stripe fields\r\n    stripe_session_id?: string;\r\n    stripe_payment_intent_id?: string;\r\n    amount_eur_cents?: number;\r\n    amount_eur?: number;\r\n    exchange_rate?: number;\r\n    card_brand?: string;\r\n    card_last4?: string;\r\n    card_exp_month?: number;\r\n    card_exp_year?: number;\r\n    // KKiaPay fields\r\n    kkiapay_transaction_id?: string;\r\n    payment_channel?: string;\r\n    customer_phone?: string;\r\n    customer_name?: string;\r\n    kkiapay_status?: string;\r\n    kkiapay_created_at?: string;\r\n    // Common fields\r\n    amount_fcfa?: number;\r\n    currency?: string;\r\n    paid_at?: string;\r\n    confirmed_by?: string;\r\n    confirmed_at?: string;\r\n};\r\n\r\ntype Transaction = {\r\n    id: string;\r\n    amount_due: number;\r\n    amount_paid?: number | null;\r\n    status: string;\r\n    period_month: number;\r\n    period_year: number;\r\n    paid_at?: string | null;\r\n    payment_method?: string;\r\n    payment_ref?: string | null;\r\n    meta?: PaymentMeta | null;\r\n};\r\n\r\ntype Lease = {\r\n    id: string;\r\n    tenant_name: string;\r\n    tenant_email: string;\r\n    monthly_amount: number;\r\n    property_address: string;\r\n};\r\n\r\nconst MONTH_NAMES = [\r\n    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\r\n    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'\r\n];\r\n\r\nexport default function TransactionDetailPage() {\r\n    const params = useParams();\r\n    const router = useRouter();\r\n    const [transaction, setTransaction] = useState<Transaction | null>(null);\r\n    const [lease, setLease] = useState<Lease | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [copiedRef, setCopiedRef] = useState(false);\r\n    const [note, setNote] = useState('');\r\n    const [isEditingNote, setIsEditingNote] = useState(false);\r\n\r\n    useEffect(() => {\r\n        loadTransactionDetail();\r\n    }, [params.id]);\r\n\r\n    const loadTransactionDetail = async () => {\r\n        if (!params.id || typeof params.id !== 'string') {\r\n            setLoading(false);\r\n            return;\r\n        }\r\n\r\n        const result = await getTransactionDetail(params.id);\r\n\r\n        if (result) {\r\n            setTransaction(result.transaction);\r\n            setLease(result.lease);\r\n        }\r\n        setLoading(false);\r\n    };\r\n\r\n    const formatCurrency = (amount?: number | null) => {\r\n        if (!amount && amount !== 0) return '0';\r\n        return new Intl.NumberFormat('fr-FR').format(amount);\r\n    };\r\n\r\n    const formatPeriod = (month: number, year: number) => {\r\n        return `${MONTH_NAMES[(month || 1) - 1]} ${year}`;\r\n    };\r\n\r\n    const formatDateTime = (dateString?: string | null) => {\r\n        if (!dateString) return null;\r\n        const date = new Date(dateString);\r\n        return date.toLocaleDateString('fr-FR', {\r\n            day: '2-digit',\r\n            month: 'long',\r\n            year: 'numeric',\r\n        }) + ' √† ' + date.toLocaleTimeString('fr-FR', {\r\n            hour: '2-digit',\r\n            minute: '2-digit',\r\n        });\r\n    };\r\n\r\n    const getMethodIcon = (method?: string) => {\r\n        switch (method) {\r\n            case 'stripe': return <CreditCard className=\"w-5 h-5\" />;\r\n            case 'kkiapay': return <Smartphone className=\"w-5 h-5\" />;\r\n            case 'manual': return <UserCheck className=\"w-5 h-5\" />;\r\n            default: return <Receipt className=\"w-5 h-5\" />;\r\n        }\r\n    };\r\n\r\n    const getMethodLabel = (method?: string, meta?: PaymentMeta | null) => {\r\n        switch (method) {\r\n            case 'stripe':\r\n                if (meta?.card_brand && meta?.card_last4) {\r\n                    return `${meta.card_brand.charAt(0).toUpperCase() + meta.card_brand.slice(1)} ****${meta.card_last4}`;\r\n                }\r\n                return 'Carte bancaire (Stripe)';\r\n            case 'kkiapay':\r\n                if (meta?.payment_channel) {\r\n                    const channel = meta.payment_channel.replace(/_/g, ' ');\r\n                    return channel.charAt(0).toUpperCase() + channel.slice(1);\r\n                }\r\n                return 'Mobile Money (KKiaPay)';\r\n            case 'manual':\r\n                return 'Confirmation manuelle';\r\n            case 'transfer':\r\n                return 'Virement bancaire';\r\n            default:\r\n                return method || 'Non renseign√©';\r\n        }\r\n    };\r\n\r\n    const copyToClipboard = (text: string) => {\r\n        navigator.clipboard.writeText(text);\r\n        setCopiedRef(true);\r\n        setTimeout(() => setCopiedRef(false), 2000);\r\n    };\r\n\r\n    const getPaymentRef = (transaction: Transaction): string | null => {\r\n        if (transaction.payment_ref) return transaction.payment_ref;\r\n        if (transaction.meta?.stripe_session_id) return transaction.meta.stripe_session_id;\r\n        if (transaction.meta?.kkiapay_transaction_id) return transaction.meta.kkiapay_transaction_id;\r\n        return null;\r\n    };\r\n\r\n    const getStatusConfig = (status: string) => {\r\n        switch (status) {\r\n            case 'paid':\r\n                return {\r\n                    label: 'PAY√â',\r\n                    bgColor: 'bg-emerald-500',\r\n                    icon: <CheckCircle2 className=\"w-6 h-6\" />,\r\n                };\r\n            case 'overdue':\r\n                return {\r\n                    label: 'EN RETARD',\r\n                    bgColor: 'bg-red-500',\r\n                    icon: <AlertTriangle className=\"w-6 h-6\" />,\r\n                };\r\n            default:\r\n                return {\r\n                    label: 'EN ATTENTE',\r\n                    bgColor: 'bg-amber-500',\r\n                    icon: <Clock className=\"w-6 h-6\" />,\r\n                };\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div className=\"min-h-screen flex items-center justify-center bg-zinc-50\">\r\n                <Loader2 className=\"w-8 h-8 text-zinc-400 animate-spin\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (!transaction || !lease) {\r\n        return (\r\n            <div className=\"min-h-screen flex flex-col items-center justify-center bg-zinc-50 px-4\">\r\n                <div className=\"w-16 h-16 rounded-full bg-zinc-100 flex items-center justify-center mb-4\">\r\n                    <Receipt className=\"w-8 h-8 text-zinc-400\" />\r\n                </div>\r\n                <h3 className=\"text-lg font-semibold text-zinc-900\">Transaction introuvable</h3>\r\n                <p className=\"max-w-xs mt-2 text-sm text-zinc-500 text-center\">\r\n                    Cette transaction n&apos;existe pas ou vous n&apos;avez pas acc√®s.\r\n                </p>\r\n                <Button\r\n                    onClick={() => router.push('/locataire/paiements')}\r\n                    className=\"mt-6\"\r\n                    variant=\"outline\"\r\n                >\r\n                    <ArrowLeft className=\"w-4 h-4 mr-2\" />\r\n                    Retour aux paiements\r\n                </Button>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const isPaid = transaction.status === 'paid';\r\n    const ref = getPaymentRef(transaction);\r\n    const meta = transaction.meta;\r\n    const statusConfig = getStatusConfig(transaction.status);\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-zinc-50\">\r\n            {/* Header */}\r\n            <div className=\"sticky top-0 z-10 bg-white border-b border-zinc-200\">\r\n                <div className=\"max-w-lg mx-auto px-4 py-4 flex items-center gap-3\">\r\n                    <button\r\n                        onClick={() => router.back()}\r\n                        className=\"p-2 -ml-2 hover:bg-zinc-100 rounded-lg transition-colors\"\r\n                    >\r\n                        <ArrowLeft className=\"w-5 h-5 text-zinc-900\" />\r\n                    </button>\r\n                    <h1 className=\"text-lg font-semibold text-zinc-900\">D√©tail de la transaction</h1>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <div className=\"max-w-lg mx-auto px-4 py-6 space-y-4\">\r\n                {/* Status Card */}\r\n                <div className=\"bg-white rounded-2xl border border-zinc-200 overflow-hidden\">\r\n                    {/* Status Banner */}\r\n                    <div className={`${statusConfig.bgColor} px-6 py-4 text-white flex items-center justify-between`}>\r\n                        <span className=\"text-sm font-semibold tracking-wide\">\r\n                            {statusConfig.label}\r\n                        </span>\r\n                        {statusConfig.icon}\r\n                    </div>\r\n\r\n                    {/* Main Info */}\r\n                    <div className=\"px-6 py-8 text-center\">\r\n                        <p className=\"text-sm text-zinc-500 mb-2\">\r\n                            {isPaid ? 'Vous avez pay√©' : '√Ä payer'}\r\n                        </p>\r\n                        <div className=\"flex items-baseline justify-center gap-2 mb-4\">\r\n                            <span className=\"text-4xl font-bold text-zinc-900 tracking-tight\">\r\n                                {formatCurrency(transaction.amount_paid || transaction.amount_due)}\r\n                            </span>\r\n                            <span className=\"text-xl text-zinc-400\">FCFA</span>\r\n                        </div>\r\n                        <p className=\"text-sm text-zinc-600\">\r\n                            pour le loyer de <span className=\"font-semibold\">{formatPeriod(transaction.period_month, transaction.period_year)}</span>\r\n                        </p>\r\n                        {lease.property_address && (\r\n                            <p className=\"text-xs text-zinc-500 mt-2\">\r\n                                {lease.property_address}\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Confirmation */}\r\n                    {isPaid && ref && (\r\n                        <div className=\"px-6 pb-6\">\r\n                            <div className=\"bg-zinc-50 rounded-xl p-4\">\r\n                                <div className=\"flex items-center justify-between\">\r\n                                    <div>\r\n                                        <p className=\"text-xs text-zinc-500 mb-1\">R√©f√©rence de confirmation</p>\r\n                                        <p className=\"font-mono text-sm text-zinc-900 break-all\">{ref}</p>\r\n                                    </div>\r\n                                    <button\r\n                                        onClick={() => copyToClipboard(ref)}\r\n                                        className=\"ml-2 p-2 hover:bg-zinc-200 rounded-lg transition-colors flex-shrink-0\"\r\n                                        title=\"Copier la r√©f√©rence\"\r\n                                    >\r\n                                        {copiedRef\r\n                                            ? <Check className=\"w-4 h-4 text-emerald-500\" />\r\n                                            : <Copy className=\"w-4 h-4 text-zinc-400\" />\r\n                                        }\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Action Buttons */}\r\n                    {isPaid && (\r\n                        <div className=\"px-6 pb-6 grid grid-cols-2 gap-3\">\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                className=\"w-full\"\r\n                                onClick={() => {\r\n                                    // TODO: Implement receipt download\r\n                                    alert('T√©l√©chargement du re√ßu √† venir');\r\n                                }}\r\n                            >\r\n                                <Download className=\"w-4 h-4 mr-2\" />\r\n                                Voir le re√ßu\r\n                            </Button>\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                className=\"w-full\"\r\n                                onClick={() => router.push('/locataire/paiements')}\r\n                            >\r\n                                <RefreshCw className=\"w-4 h-4 mr-2\" />\r\n                                Nouveau paiement\r\n                            </Button>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Note Section */}\r\n                <div className=\"bg-white rounded-2xl border border-zinc-200 p-6\">\r\n                    <div className=\"flex items-center justify-between mb-3\">\r\n                        <h2 className=\"text-sm font-semibold text-zinc-700\">Note √† soi-m√™me</h2>\r\n                        <button\r\n                            onClick={() => setIsEditingNote(!isEditingNote)}\r\n                            className=\"p-1 hover:bg-zinc-100 rounded transition-colors\"\r\n                        >\r\n                            <Edit2 className=\"w-4 h-4 text-zinc-400\" />\r\n                        </button>\r\n                    </div>\r\n                    {isEditingNote ? (\r\n                        <textarea\r\n                            value={note}\r\n                            onChange={(e) => setNote(e.target.value)}\r\n                            placeholder=\"Ajouter une note...\"\r\n                            className=\"w-full px-3 py-2 border border-zinc-200 rounded-lg text-sm text-zinc-700 resize-none focus:outline-none focus:ring-2 focus:ring-zinc-900\"\r\n                            rows={3}\r\n                        />\r\n                    ) : (\r\n                        <p className=\"text-sm text-zinc-500\">\r\n                            {note || 'Ajouter une note'}\r\n                        </p>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Details Section */}\r\n                <div className=\"bg-white rounded-2xl border border-zinc-200 p-6 space-y-4\">\r\n                    <h2 className=\"text-sm font-semibold text-zinc-700 pb-2 border-b border-zinc-100\">\r\n                        D√©tails de la transaction\r\n                    </h2>\r\n\r\n                    {/* Date & Time */}\r\n                    {transaction.paid_at && (\r\n                        <DetailRow\r\n                            label=\"Date & heure\"\r\n                            value={formatDateTime(transaction.paid_at) || '-'}\r\n                        />\r\n                    )}\r\n\r\n                    {/* Payment Method */}\r\n                    <DetailRow\r\n                        label=\"Moyen de paiement\"\r\n                        value={\r\n                            <div className=\"flex items-center gap-2 justify-end\">\r\n                                {getMethodIcon(transaction.payment_method)}\r\n                                <span>{getMethodLabel(transaction.payment_method, meta)}</span>\r\n                            </div>\r\n                        }\r\n                    />\r\n\r\n                    {/* Amount Details */}\r\n                    <div className=\"pt-2 border-t border-zinc-100 space-y-3\">\r\n                        <DetailRow\r\n                            label=\"Montant du loyer\"\r\n                            value={`${formatCurrency(transaction.amount_due)} FCFA`}\r\n                        />\r\n\r\n                        {/* Stripe: Show EUR amount and exchange rate */}\r\n                        {meta?.provider === 'stripe' && meta.amount_eur && (\r\n                            <>\r\n                                <DetailRow\r\n                                    label=\"Frais de transfert\"\r\n                                    value={meta.amount_eur_cents\r\n                                        ? `${((meta.amount_eur_cents - (meta.amount_eur * 100)) / 100).toFixed(2)} EUR`\r\n                                        : '-'\r\n                                    }\r\n                                />\r\n                                {meta.exchange_rate && (\r\n                                    <DetailRow\r\n                                        label=\"Taux de change\"\r\n                                        value={`1 EUR = ${formatCurrency(meta.exchange_rate)} FCFA`}\r\n                                    />\r\n                                )}\r\n                                <DetailRow\r\n                                    label=\"Total pour le b√©n√©ficiaire\"\r\n                                    value={`${formatCurrency(transaction.amount_paid || transaction.amount_due)} FCFA`}\r\n                                />\r\n                            </>\r\n                        )}\r\n\r\n                        {/* KKiaPay: Show customer phone */}\r\n                        {meta?.provider === 'kkiapay' && meta.customer_phone && (\r\n                            <DetailRow\r\n                                label=\"Num√©ro de t√©l√©phone\"\r\n                                value={meta.customer_phone}\r\n                            />\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Total paid */}\r\n                    <div className=\"pt-3 border-t border-zinc-200\">\r\n                        <DetailRow\r\n                            label={\r\n                                <span className=\"font-semibold text-zinc-900\">\r\n                                    {meta?.provider === 'stripe' ? 'Montant total d√©bit√©' : 'Montant total'}\r\n                                </span>\r\n                            }\r\n                            value={\r\n                                <span className=\"font-bold text-zinc-900\">\r\n                                    {meta?.provider === 'stripe' && meta.amount_eur\r\n                                        ? `${meta.amount_eur.toFixed(2)} EUR`\r\n                                        : `${formatCurrency(transaction.amount_paid || transaction.amount_due)} FCFA`\r\n                                    }\r\n                                </span>\r\n                            }\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Payment Method details */}\r\n                    <div className=\"pt-3 border-t border-zinc-100\">\r\n                        <DetailRow\r\n                            label=\"Pay√© avec\"\r\n                            value={\r\n                                meta?.provider === 'stripe' && meta.card_brand && meta.card_last4\r\n                                    ? `My ${meta.card_brand.toUpperCase()} Card ****${meta.card_last4}`\r\n                                    : getMethodLabel(transaction.payment_method, meta)\r\n                            }\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Additional info for disclaimer */}\r\n                {meta?.provider === 'stripe' && (\r\n                    <div className=\"bg-zinc-50 rounded-xl p-4 border border-zinc-200\">\r\n                        <p className=\"text-xs text-zinc-500 leading-relaxed\">\r\n                            Votre b√©n√©ficiaire peut recevoir une somme inf√©rieure en raison de frais factur√©s par le fournisseur de portefeuille mobile ou une banque et/ou de taxes √©trang√®res.\r\n                        </p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction DetailRow({ label, value }: { label: React.ReactNode; value: React.ReactNode }) {\r\n    return (\r\n        <div className=\"flex justify-between items-start gap-4\">\r\n            <span className=\"text-sm text-zinc-500 flex-shrink-0\">\r\n                {label}\r\n            </span>\r\n            <span className=\"text-sm font-medium text-zinc-800 text-right\">\r\n                {value}\r\n            </span>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiements\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiements\\page.tsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadPayments` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiements\\page.tsx:51:9\n  49 |\n  50 |     useEffect(() => {\n> 51 |         loadPayments();\n     |         ^^^^^^^^^^^^ `loadPayments` accessed before it is declared\n  52 |     }, []);\n  53 |\n  54 |     const loadPayments = async () => {\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\paiements\\page.tsx:54:5\n  52 |     }, []);\n  53 |\n> 54 |     const loadPayments = async () => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 55 |         const result = await getTenantPayments();\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 56 |         setData(result);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 57 |         setLoading(false);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 58 |     };\n     | ^^^^^^^ `loadPayments` is declared here\n  59 |\n  60 |     const formatCurrency = (amount?: number | null) => {\n  61 |         if (!amount && amount !== 0) return '0';","line":51,"column":9,"nodeType":null,"endLine":51,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport {\n    ArrowRight,\n    CheckCircle2,\n    Clock,\n    AlertTriangle,\n    Loader2,\n    Filter,\n    ChevronRight\n} from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { RentPaymentModal } from '../components/RentPaymentModal';\nimport { getTenantPayments } from './actions';\n\ntype Payment = {\n    id: string;\n    amount_due: number;\n    amount_paid?: number | null;\n    status: string;\n    period_month: number;\n    period_year: number;\n    paid_at?: string | null;\n    payment_method?: string | null;\n};\n\ntype PaymentData = {\n    payments: Payment[];\n    leaseId: string;\n    monthlyAmount: number;\n    tenantName: string;\n    tenantEmail: string;\n    propertyAddress: string;\n};\n\nconst MONTH_NAMES = [\n    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\n    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'\n];\n\nexport default function TenantPaymentsPage() {\n    const router = useRouter();\n    const [data, setData] = useState<PaymentData | null>(null);\n    const [loading, setLoading] = useState(true);\n    const [isModalOpen, setIsModalOpen] = useState(false);\n    const [filter, setFilter] = useState<'all' | 'paid' | 'pending'>('all');\n\n    useEffect(() => {\n        loadPayments();\n    }, []);\n\n    const loadPayments = async () => {\n        const result = await getTenantPayments();\n        setData(result);\n        setLoading(false);\n    };\n\n    const formatCurrency = (amount?: number | null) => {\n        if (!amount && amount !== 0) return '0';\n        return new Intl.NumberFormat('fr-FR').format(amount);\n    };\n\n    const formatPeriod = (month: number, year: number) => {\n        return `${MONTH_NAMES[(month || 1) - 1]} ${year}`;\n    };\n\n    const formatPaidDate = (dateString?: string | null) => {\n        if (!dateString) return null;\n        const date = new Date(dateString);\n        return date.toLocaleDateString('fr-FR', {\n            day: 'numeric',\n            month: 'short',\n            year: 'numeric'\n        });\n    };\n\n    const getCurrentMonth = () => {\n        const now = new Date();\n        return now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });\n    };\n\n    if (loading) {\n        return (\n            <div className=\"min-h-[60vh] flex items-center justify-center\">\n                <Loader2 className=\"w-8 h-8 text-zinc-400 animate-spin\" />\n            </div>\n        );\n    }\n\n    if (!data || data.payments.length === 0) {\n        return (\n            <div className=\"flex flex-col items-center justify-center py-16 text-center px-4\">\n                <div className=\"w-16 h-16 rounded-full bg-zinc-100 flex items-center justify-center mb-4\">\n                    <Clock className=\"w-8 h-8 text-zinc-400\" />\n                </div>\n                <h3 className=\"text-lg font-semibold text-zinc-900\">Aucun paiement</h3>\n                <p className=\"max-w-xs mt-2 text-sm text-zinc-500\">\n                    Votre historique de paiements appara√Ætra ici.\n                </p>\n            </div>\n        );\n    }\n\n    const pendingPayments = data.payments.filter(p => p.status !== 'paid');\n    const currentBalance = pendingPayments.reduce((sum, p) => sum + (p.amount_due || 0), 0);\n    const isUpToDate = currentBalance === 0;\n\n    const filteredPayments = data.payments.filter(p => {\n        if (filter === 'all') return true;\n        if (filter === 'paid') return p.status === 'paid';\n        return p.status !== 'paid';\n    });\n\n    return (\n        <div className=\"w-full max-w-lg mx-auto px-4 py-6 space-y-6\">\n            {/* Header */}\n            <div>\n                <h1 className=\"text-xl font-bold text-zinc-900\">Mes Paiements</h1>\n                <p className=\"text-sm text-zinc-500 mt-0.5\">Historique et suivi de vos loyers</p>\n            </div>\n\n            {/* Balance Card */}\n            <div className=\"relative overflow-hidden rounded-2xl bg-gradient-to-br from-zinc-900 via-zinc-900 to-zinc-800 p-6 text-white\">\n                <div className=\"absolute inset-0 opacity-5\">\n                    <div className=\"absolute top-0 right-0 w-64 h-64 bg-white rounded-full blur-3xl translate-x-1/2 -translate-y-1/2\" />\n                </div>\n\n                <div className=\"relative\">\n                    <div className=\"flex items-center justify-between mb-4\">\n                        <div>\n                            <p className=\"text-zinc-400 text-xs uppercase tracking-widest mb-1\">\n                                {isUpToDate ? 'Solde actuel' : 'Montant √† payer'}\n                            </p>\n                            <div className=\"flex items-baseline gap-2\">\n                                <span className=\"text-3xl font-bold tracking-tight\">\n                                    {formatCurrency(currentBalance)}\n                                </span>\n                                <span className=\"text-zinc-400\">FCFA</span>\n                            </div>\n                        </div>\n                        {isUpToDate && (\n                            <div className=\"flex items-center gap-1.5 text-emerald-400\">\n                                <CheckCircle2 className=\"w-5 h-5\" />\n                                <span className=\"text-sm font-medium\">√Ä jour</span>\n                            </div>\n                        )}\n                    </div>\n\n                    <Button\n                        onClick={() => setIsModalOpen(true)}\n                        className=\"w-full h-11 bg-white hover:bg-zinc-100 text-zinc-900 font-semibold rounded-xl\"\n                    >\n                        {isUpToDate ? 'Effectuer un paiement' : `Payer ${formatCurrency(currentBalance)} FCFA`}\n                        <ArrowRight className=\"w-4 h-4 ml-2\" />\n                    </Button>\n                </div>\n            </div>\n\n            {/* Filters */}\n            <div className=\"flex items-center gap-2\">\n                <Filter className=\"w-4 h-4 text-zinc-400\" />\n                {[\n                    { key: 'all', label: 'Tous' },\n                    { key: 'paid', label: 'Pay√©s' },\n                    { key: 'pending', label: 'En attente' },\n                ].map(({ key, label }) => (\n                    <button\n                        key={key}\n                        onClick={() => setFilter(key as typeof filter)}\n                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${\n                            filter === key\n                                ? 'bg-zinc-900 text-white'\n                                : 'bg-zinc-100 text-zinc-600 hover:bg-zinc-200'\n                        }`}\n                    >\n                        {label}\n                    </button>\n                ))}\n            </div>\n\n            {/* Payments List with Year Separators */}\n            <div className=\"space-y-4\">\n                {(() => {\n                    // Group payments by year\n                    const byYear = filteredPayments.reduce<Record<number, Payment[]>>((acc, p) => {\n                        const year = p.period_year;\n                        if (!acc[year]) acc[year] = [];\n                        acc[year].push(p);\n                        return acc;\n                    }, {});\n\n                    const years = Object.keys(byYear).map(Number).sort((a, b) => b - a);\n\n                    if (years.length === 0) {\n                        return (\n                            <div className=\"bg-white rounded-xl border border-zinc-200 py-12 text-center\">\n                                <p className=\"text-sm text-zinc-500\">Aucun paiement dans cette cat√©gorie</p>\n                            </div>\n                        );\n                    }\n\n                    return years.map(year => (\n                        <div key={year}>\n                            <div className=\"sticky top-16 z-10 bg-slate-50/95 backdrop-blur px-1 py-2\">\n                                <h3 className=\"text-xs font-semibold text-zinc-500 uppercase tracking-wider\">{year}</h3>\n                            </div>\n                            <div className=\"bg-white rounded-xl border border-zinc-200 overflow-hidden\">\n                                <div className=\"divide-y divide-zinc-100\">\n                                    {byYear[year].map((payment) => {\n                                        const isPaid = payment.status === 'paid';\n                                        const isOverdue = payment.status === 'overdue';\n                                        const period = formatPeriod(payment.period_month, payment.period_year);\n                                        const paidDate = formatPaidDate(payment.paid_at);\n                                        const methodLabel = payment.payment_method === 'stripe' ? 'Carte' :\n                                                           payment.payment_method === 'kkiapay' ? 'Mobile' :\n                                                           payment.payment_method || null;\n\n                                        return (\n                                            <button\n                                                key={payment.id}\n                                                onClick={() => isPaid ? router.push(`/locataire/paiements/${payment.id}`) : undefined}\n                                                className={`w-full flex items-center justify-between px-4 py-4 hover:bg-zinc-50 transition-colors text-left ${\n                                                    isPaid ? 'cursor-pointer' : 'cursor-default'\n                                                }`}\n                                            >\n                                                <div className=\"flex items-center gap-3\">\n                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${\n                                                        isPaid\n                                                            ? 'bg-emerald-50 text-emerald-600'\n                                                            : isOverdue\n                                                                ? 'bg-red-50 text-red-600'\n                                                                : 'bg-amber-50 text-amber-600'\n                                                    }`}>\n                                                        {isPaid\n                                                            ? <CheckCircle2 className=\"w-5 h-5\" />\n                                                            : isOverdue\n                                                                ? <AlertTriangle className=\"w-5 h-5\" />\n                                                                : <Clock className=\"w-5 h-5\" />\n                                                        }\n                                                    </div>\n                                                    <div>\n                                                        <p className=\"font-medium text-zinc-900\">\n                                                            Loyer {period}\n                                                        </p>\n                                                        <p className=\"text-xs text-zinc-500\">\n                                                            {isPaid && paidDate\n                                                                ? `Pay√© le ${paidDate}`\n                                                                : isOverdue\n                                                                    ? 'Paiement en retard'\n                                                                    : 'En attente de paiement'\n                                                            }\n                                                        </p>\n                                                    </div>\n                                                </div>\n\n                                                <div className=\"flex items-center gap-2\">\n                                                    <div className=\"text-right\">\n                                                        <p className={`font-semibold tabular-nums ${\n                                                            isPaid ? 'text-zinc-900' : isOverdue ? 'text-red-600' : 'text-amber-600'\n                                                        }`}>\n                                                            {formatCurrency(payment.amount_paid || payment.amount_due)}\n                                                            <span className=\"text-xs font-normal text-zinc-400 ml-1\">F</span>\n                                                        </p>\n                                                        <div className=\"flex items-center gap-1 justify-end\">\n                                                            {isPaid && methodLabel && (\n                                                                <span className=\"text-[9px] font-medium text-zinc-400 bg-zinc-100 px-1 py-0.5 rounded\">\n                                                                    {methodLabel}\n                                                                </span>\n                                                            )}\n                                                            <span className={`inline-flex text-[10px] font-medium px-1.5 py-0.5 rounded ${\n                                                                isPaid\n                                                                    ? 'bg-emerald-50 text-emerald-700'\n                                                                    : isOverdue\n                                                                        ? 'bg-red-50 text-red-700'\n                                                                        : 'bg-amber-50 text-amber-700'\n                                                            }`}>\n                                                                {isPaid ? 'Pay√©' : isOverdue ? 'En retard' : 'En attente'}\n                                                            </span>\n                                                        </div>\n                                                    </div>\n                                                    {isPaid && (\n                                                        <ChevronRight className=\"w-4 h-4 text-zinc-400\" />\n                                                    )}\n                                                </div>\n                                            </button>\n                                        );\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                    ));\n                })()}\n            </div>\n\n            {/* Modal */}\n            <RentPaymentModal\n                leaseId={data.leaseId}\n                defaultAmount={currentBalance > 0 ? currentBalance : data.monthlyAmount}\n                month={getCurrentMonth()}\n                propertyAddress={data.propertyAddress}\n                tenantName={data.tenantName}\n                tenantEmail={data.tenantEmail}\n                open={isModalOpen}\n                onOpenChange={setIsModalOpen}\n            />\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\payments\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\verify\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\verify\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\locataire\\verify\\verify-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\a-propos\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\blog\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\carrieres\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\investissement\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\pro-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\signup\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\start\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\start\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\pro\\syndic\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\robots.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\app\\sitemap.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[824,827],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[824,827],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MetadataRoute } from 'next';\nimport { supabase } from '@/lib/supabase';\nimport { slugify } from '@/lib/slugs';\n\nconst BASE_URL = process.env.NEXT_PUBLIC_APP_URL || 'https://www.dousell-immo.com';\n\nexport const revalidate = 3600; // Update sitemap every hour\n\nexport default async function sitemap(): Promise<MetadataRoute.Sitemap> {\n\n    // 1. R√©cup√©rer les donn√©es LOCATION\n    const { data: rentals } = await supabase\n        .rpc('get_active_cities_and_types', { min_count: 1, target_transaction_type: 'location' });\n\n    // 2. R√©cup√©rer les donn√©es VENTE\n    const { data: sales } = await supabase\n        .rpc('get_active_cities_and_types', { min_count: 1, target_transaction_type: 'vente' });\n\n    const routes: MetadataRoute.Sitemap = [];\n\n    // Helper pour ajouter des routes\n    const addRoutes = (items: any[], mode: 'location' | 'vente') => {\n        const processedCities = new Set<string>();\n\n        // Root de la section\n        routes.push({\n            url: `${BASE_URL}/${mode}`,\n            lastModified: new Date(),\n            changeFrequency: 'daily',\n            priority: 1.0,\n        });\n\n        (items || []).forEach((page: { city: string; type: string }) => {\n            const citySlug = slugify(page.city);\n            const typeSlug = slugify(page.type);\n\n            // Page Ville/Type (Feuille)\n            routes.push({\n                url: `${BASE_URL}/${mode}/${citySlug}/${typeSlug}`,\n                lastModified: new Date(),\n                changeFrequency: 'daily',\n                priority: 0.8,\n            });\n\n            // Collecter les villes uniques\n            processedCities.add(citySlug);\n        });\n\n        // Pages Ville (Parents)\n        processedCities.forEach(citySlug => {\n            routes.push({\n                url: `${BASE_URL}/${mode}/${citySlug}`,\n                lastModified: new Date(),\n                changeFrequency: 'daily',\n                priority: 0.9,\n            });\n        });\n    }\n\n    addRoutes(rentals, 'location');\n    addRoutes(sales, 'vente');\n\n    // 3. Les pages statiques de base\n    const staticRoutes = [\n        '',\n        '/recherche',\n        '/a-propos',\n        '/contact',\n        '/planifier-visite',\n    ].map((route) => ({\n        url: `${BASE_URL}${route}`,\n        lastModified: new Date(),\n        changeFrequency: 'monthly' as const,\n        priority: 1.0,\n    }));\n\n    return [...staticRoutes, ...routes];\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\check-env.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":37,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":21,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":36,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\InfoBox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\KPICard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\LoadingSkeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\admin-sidebar-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\admin-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\admin-topbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\dashboard-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\dashboard-view.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'daysMap'. Either include it or remove the dependency array.","line":90,"column":6,"nodeType":"ArrayExpression","endLine":90,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [daysMap, timeRange]","fix":{"range":[2916,2927],"text":"[daysMap, timeRange]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\performance-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\top-properties-table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\admin\\verification-queue.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\conditional-google-analytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\google-consent-mode.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\lazy-analytics.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'timeout' is never reassigned. Use 'const' instead.","line":47,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":47,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport dynamic from 'next/dynamic';\n\n// Lazy load les composants analytics avec dynamic import\nconst ConditionalGoogleAnalytics = dynamic(\n  () => import('./conditional-google-analytics').then((mod) => mod.ConditionalGoogleAnalytics),\n  { ssr: false }\n);\n\nconst MicrosoftClarity = dynamic(\n  () => import('./microsoft-clarity').then((mod) => mod.MicrosoftClarity),\n  { ssr: false }\n);\n\n// Lazy load Google Tag Manager (GTM)\nconst GoogleTagManager = dynamic(\n  () => import('@next/third-parties/google').then((mod) => mod.GoogleTagManager),\n  { ssr: false }\n);\n\ninterface LazyAnalyticsProps {\n  gaId?: string;\n  clarityId: string;\n  gtmId?: string;\n}\n\n/**\n * LazyAnalytics - Charge les analytics apr√®s interaction utilisateur\n *\n * Optimisation: Au lieu de charger imm√©diatement au render, on attend:\n * - 3 secondes IDLE OU\n * - Premier scroll OU\n * - Premier click\n *\n * Inclut: Google Analytics, Microsoft Clarity, Google Tag Manager\n * Impact: -1s sur FCP, -500ms sur LCP, -70% LCP sur /gestion\n */\nexport function LazyAnalytics({ gaId, clarityId, gtmId }: LazyAnalyticsProps) {\n  const [loaded, setLoaded] = useState(false);\n\n  useEffect(() => {\n    // Ne charger que c√¥t√© client\n    if (typeof window === 'undefined') return;\n\n    let timeout: NodeJS.Timeout;\n    let isLoaded = false;\n\n    const loadAnalytics = () => {\n      if (isLoaded) return;\n      isLoaded = true;\n      setLoaded(true);\n\n      // Cleanup\n      clearTimeout(timeout);\n      window.removeEventListener('scroll', loadAnalytics);\n      window.removeEventListener('click', loadAnalytics);\n      window.removeEventListener('touchstart', loadAnalytics);\n      window.removeEventListener('mousemove', loadAnalytics);\n    };\n\n    // Strat√©gie 1: Charger apr√®s 3s d'inactivit√©\n    timeout = setTimeout(loadAnalytics, 3000);\n\n    // Strat√©gie 2: Charger d√®s la premi√®re interaction\n    window.addEventListener('scroll', loadAnalytics, { once: true, passive: true });\n    window.addEventListener('click', loadAnalytics, { once: true });\n    window.addEventListener('touchstart', loadAnalytics, { once: true, passive: true });\n    window.addEventListener('mousemove', loadAnalytics, { once: true, passive: true });\n\n    return () => {\n      clearTimeout(timeout);\n      window.removeEventListener('scroll', loadAnalytics);\n      window.removeEventListener('click', loadAnalytics);\n      window.removeEventListener('touchstart', loadAnalytics);\n      window.removeEventListener('mousemove', loadAnalytics);\n    };\n  }, []);\n\n  // Ne rien afficher tant que pas charg√©\n  if (!loaded) return null;\n\n  return (\n    <>\n      {gaId && <ConditionalGoogleAnalytics gaId={gaId} />}\n      <MicrosoftClarity clarityId={clarityId} />\n      {gtmId && <GoogleTagManager gtmId={gtmId} />}\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\lazy-speed-insights.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'timeout' is never reassigned. Use 'const' instead.","line":41,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":41,"endColumn":12}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport dynamic from \"next/dynamic\";\n\n// Lazy load SpeedInsights de Vercel\nconst SpeedInsights = dynamic(\n  () => import('@vercel/speed-insights/next').then((mod) => mod.SpeedInsights),\n  { ssr: false }\n);\n\n/**\n * LazySpeedInsights - Charge Speed Insights apr√®s interaction utilisateur\n *\n * Optimisation: Au lieu de charger imm√©diatement au render, on attend:\n * - 3 secondes IDLE OU\n * - Premier scroll OU\n * - Premier click\n *\n * Impact: -800ms sur critical path, am√©liore LCP mobile\n * R√©f√©rence: PageSpeed Insights montrait 831ms de latency pour speed-insights/vitals\n */\nexport function LazySpeedInsights() {\n  const [loaded, setLoaded] = useState(false);\n\n  useEffect(() => {\n    // Ne charger que c√¥t√© client\n    if (typeof window === 'undefined') return;\n\n    let timeout: NodeJS.Timeout;\n    let isLoaded = false;\n\n    const load = () => {\n      if (isLoaded) return;\n      isLoaded = true;\n      setLoaded(true);\n      cleanup();\n    };\n\n    // Trigger 1: Apr√®s 3 secondes d'idle\n    timeout = setTimeout(load, 3000);\n\n    // Trigger 2: Premier scroll\n    const onScroll = () => load();\n\n    // Trigger 3: Premier click\n    const onClick = () => load();\n\n    window.addEventListener('scroll', onScroll, { once: true, passive: true });\n    window.addEventListener('click', onClick, { once: true, passive: true });\n\n    const cleanup = () => {\n      clearTimeout(timeout);\n      window.removeEventListener('scroll', onScroll);\n      window.removeEventListener('click', onClick);\n    };\n\n    return cleanup;\n  }, []);\n\n  // Ne rien afficher tant que pas charg√©\n  if (!loaded) return null;\n\n  return <SpeedInsights />;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\microsoft-clarity.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\analytics\\update-consent-on-load.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\auth\\phone-missing-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\auth\\verification-success-toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\contracts\\ContractPreview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\contracts\\GenerateContractButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\contracts\\GenerateContractModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\dashboard\\ad-certification-upload.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\dashboard\\verification-status-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\dashboard\\verification-upload-form.tsx","messages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":36,"column":31,"nodeType":"Identifier","endLine":36,"endColumn":39},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":37,"column":43,"nodeType":"Identifier","endLine":37,"endColumn":51},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":38,"column":41,"nodeType":"Identifier","endLine":38,"endColumn":49},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":39,"column":39,"nodeType":"Identifier","endLine":39,"endColumn":47}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport { toast } from \"sonner\";\nimport { Upload, X, FileText, Loader2, ShieldCheck } from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { uploadVerificationDoc } from \"@/app/(workspace)/compte/mes-biens/actions\";\n\ntype VerificationUploadFormProps = {\n  propertyId: string;\n  variant?: \"default\" | \"outline\" | \"ghost\";\n  currentStatus?: string;\n  proofDocumentUrl?: string | null;\n  onSuccess?: () => void;\n};\n\nexport function VerificationUploadForm({\n  propertyId,\n  variant = \"outline\",\n  currentStatus,\n  _proofDocumentUrl,\n  onSuccess,\n}: VerificationUploadFormProps) {\n  // Si d√©j√† v√©rifi√©, ne rien afficher\n  if (currentStatus === 'verified') {\n    return null;\n  }\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const [isDragOver, setIsDragOver] = useState(false);\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n\n    if (e.dataTransfer.files && e.dataTransfer.files[0]) {\n      validateAndSetFile(e.dataTransfer.files[0]);\n    }\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n      validateAndSetFile(e.target.files[0]);\n    }\n  };\n\n  const validateAndSetFile = (file: File) => {\n    const allowedTypes = [\"application/pdf\", \"image/jpeg\", \"image/png\", \"image/webp\"];\n\n    if (!allowedTypes.includes(file.type)) {\n      toast.error(\"Format non support√©\", {\n        description: \"Veuillez utiliser un fichier PDF, JPG ou PNG.\"\n      });\n      return;\n    }\n\n    if (file.size > 5 * 1024 * 1024) {\n      toast.error(\"Fichier trop volumineux\", {\n        description: \"La taille maximale est de 5Mo.\"\n      });\n      return;\n    }\n\n    setSelectedFile(file);\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!selectedFile) return;\n\n    setIsUploading(true);\n    const formData = new FormData();\n    formData.append(\"file\", selectedFile);\n    formData.append(\"propertyId\", propertyId);\n\n    try {\n      const result = await uploadVerificationDoc(formData);\n\n      if (result.error) {\n        toast.error(\"Erreur d'envoi\", { description: result.error });\n      } else {\n        toast.success(\"Document envoy√© !\", {\n          description: \"Votre demande de certification est en cours d'examen.\"\n        });\n        setIsOpen(false);\n        setSelectedFile(null);\n        onSuccess?.();\n      }\n    } catch (error) {\n      console.error(error);\n      toast.error(\"Une erreur inconnue est survenue.\");\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button\n          variant={variant}\n          size=\"sm\"\n          className=\"h-8 border-[#F4C430]/50 text-[#F4C430] hover:bg-[#F4C430]/10 hover:text-[#F4C430]\"\n        >\n          <ShieldCheck className=\"mr-2 h-4 w-4\" />\n          Certifier ce bien\n        </Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-md bg-zinc-950 border-white/10 text-white\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 text-[#F4C430]\">\n            <ShieldCheck className=\"h-5 w-5\" />\n            Certification du bien\n          </DialogTitle>\n          <DialogDescription className=\"text-white/60\">\n            T√©l√©chargez votre titre de propri√©t√© ou tout document officiel prouvant que vous √™tes le propri√©taire.\n            Ce document restera confidentiel.\n          </DialogDescription>\n        </DialogHeader>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6 mt-4\">\n          <div\n            className={`relative flex flex-col items-center justify-center rounded-xl border-2 border-dashed transition-all p-8\n              ${isDragOver\n                ? \"border-[#F4C430] bg-[#F4C430]/5\"\n                : \"border-white/10 bg-white/5 hover:bg-white/10\"\n              }\n              ${selectedFile ? \"border-[#F4C430]/50\" : \"\"}\n            `}\n            onDragOver={handleDragOver}\n            onDragLeave={handleDragLeave}\n            onDrop={handleDrop}\n          >\n            <input\n              type=\"file\"\n              id=\"verification-file\"\n              accept=\".pdf,.jpg,.jpeg,.png,.webp\"\n              className=\"absolute inset-0 cursor-pointer opacity-0\"\n              onChange={handleFileChange}\n              disabled={isUploading}\n            />\n\n            {selectedFile ? (\n              <div className=\"flex flex-col items-center gap-2 text-center\">\n                <div className=\"rounded-full bg-[#F4C430]/10 p-3\">\n                  <FileText className=\"h-8 w-8 text-[#F4C430]\" />\n                </div>\n                <div>\n                  <p className=\"font-medium text-white\">{selectedFile.name}</p>\n                  <p className=\"text-xs text-white/50\">\n                    {(selectedFile.size / 1024 / 1024).toFixed(2)} MB\n                  </p>\n                </div>\n                <Button\n                  type=\"button\"\n                  size=\"sm\"\n                  variant=\"ghost\"\n                  className=\"mt-2 h-8 text-red-400 hover:text-red-300 hover:bg-red-400/10\"\n                  onClick={(e) => {\n                    e.stopPropagation(); // Prevent clicking input again\n                    setSelectedFile(null);\n                  }}\n                >\n                  <X className=\"mr-2 h-3.5 w-3.5\" />\n                  Changer de fichier\n                </Button>\n              </div>\n            ) : (\n              <div className=\"flex flex-col items-center gap-2 text-center\">\n                <div className=\"rounded-full bg-white/5 p-3\">\n                  <Upload className=\"h-6 w-6 text-white/40\" />\n                </div>\n                <div>\n                  <p className=\"font-medium text-white\">\n                    Glissez votre document ici\n                  </p>\n                  <p className=\"text-xs text-white/50 mt-1\">\n                    ou cliquez pour parcourir\n                  </p>\n                </div>\n                <p className=\"text-[10px] text-white/30 uppercase tracking-widest mt-2\">\n                  PDF, JPG, PNG (Max 5MB)\n                </p>\n              </div>\n            )}\n          </div>\n\n          <div className=\"flex justify-end gap-3\">\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              onClick={() => setIsOpen(false)}\n              disabled={isUploading}\n              className=\"text-white/60 hover:text-white\"\n            >\n              Annuler\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={!selectedFile || isUploading}\n              className=\"bg-[#F4C430] text-black hover:bg-[#F4C430]/90 font-semibold\"\n            >\n              {isUploading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Envoi...\n                </>\n              ) : (\n                \"Envoyer pour certification\"\n              )}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\document\\document-selector.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadDocuments'. Either include it or remove the dependency array.","line":78,"column":8,"nodeType":"ArrayExpression","endLine":78,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [loadDocuments]","fix":{"range":[2539,2541],"text":"[loadDocuments]"}}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":439,"column":37,"nodeType":"JSXOpeningElement","endLine":443,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { FileText, Upload, Check, Loader2, Image as ImageIcon, FileIcon, Eye } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogHeader,\n    DialogTitle,\n    DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n    Select,\n    SelectContent,\n    SelectItem,\n    SelectTrigger,\n    SelectValue,\n} from \"@/components/ui/select\";\nimport { getMyDocuments, uploadDocument } from \"@/app/(workspace)/compte/mes-documents/actions\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\n\ntype Document = {\n    id: string;\n    name: string;\n    type: string;\n    size: number;\n    url: string;\n    uploaded_at: string;\n    source: \"manual\" | \"verification\";\n};\n\ninterface DocumentSelectorProps {\n    onSelect: (document: { id: string; url: string; name: string; file_path?: string } | null) => void;\n    selectedDocumentId?: string;\n    documentType?: string;\n    label?: string;\n    description?: string;\n    className?: string;\n}\n\nconst documentTypes = [\n    { value: \"titre_propriete\", label: \"Titre de Propri√©t√©\" },\n    { value: \"bail\", label: \"Bail\" },\n    { value: \"cni\", label: \"CNI / Pi√®ce d'identit√©\" },\n    { value: \"facture\", label: \"Facture\" },\n    { value: \"attestation\", label: \"Attestation\" },\n    { value: \"autre\", label: \"Autre document\" },\n];\n\nexport function DocumentSelector({\n    onSelect,\n    selectedDocumentId,\n    documentType,\n    label = \"Document justificatif\",\n    description = \"S√©lectionnez un document depuis votre coffre-fort ou uploadez-en un nouveau\",\n    className = \"\",\n}: DocumentSelectorProps) {\n    const [documents, setDocuments] = useState<Document[]>([]);\n    const [loading, setLoading] = useState(true);\n    const [selectedId, setSelectedId] = useState<string | undefined>(selectedDocumentId);\n    const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);\n    const [uploading, setUploading] = useState(false);\n    const [uploadForm, setUploadForm] = useState({\n        type: documentType || \"titre_propriete\",\n        file: null as File | null,\n    });\n    const [previewDoc, setPreviewDoc] = useState<Document | null>(null);\n    const [isPreviewOpen, setIsPreviewOpen] = useState(false);\n\n    useEffect(() => {\n        loadDocuments();\n    }, []);\n\n    useEffect(() => {\n        setSelectedId(selectedDocumentId);\n    }, [selectedDocumentId]);\n\n    const loadDocuments = async () => {\n        setLoading(true);\n        try {\n            const result = await getMyDocuments();\n            if (result.success && result.data) {\n                const allDocs = result.data as Document[];\n                // Filtrer seulement les documents manuels, et par type si sp√©cifi√©\n                const filteredDocs = documentType\n                    ? allDocs.filter((doc) => doc.source === \"manual\" && doc.type === documentType)\n                    : allDocs.filter((doc) => doc.source === \"manual\");\n                setDocuments(filteredDocs);\n            } else {\n                toast.error(\"Erreur lors du chargement des documents\");\n            }\n        } catch (error) {\n            console.error(\"Error loading documents:\", error);\n            toast.error(\"Impossible de charger les documents\");\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    const handleSelectDocument = (docId: string) => {\n        setSelectedId(docId);\n        const doc = documents.find((d) => d.id === docId);\n        if (doc) {\n            onSelect({\n                id: doc.id,\n                url: doc.url,\n                name: doc.name,\n            });\n        }\n    };\n\n    const handleDeselectDocument = () => {\n        setSelectedId(undefined);\n        onSelect(null);\n    };\n\n    const handleUpload = async () => {\n        if (!uploadForm.file) {\n            toast.error(\"Veuillez s√©lectionner un fichier\");\n            return;\n        }\n\n        setUploading(true);\n        try {\n            const formData = new FormData();\n            formData.append(\"file\", uploadForm.file);\n            formData.append(\"type\", uploadForm.type);\n\n            const result = await uploadDocument(formData);\n\n            if (result.success && result.data) {\n                toast.success(\"Document upload√© avec succ√®s\");\n                setIsUploadDialogOpen(false);\n                setUploadForm({ type: documentType || \"titre_propriete\", file: null });\n                // Recharger la liste\n                await loadDocuments();\n                // Auto-s√©lectionner le nouveau document\n                const newDoc = result.data as { id?: string };\n                if (newDoc.id) {\n                    handleSelectDocument(newDoc.id);\n                }\n            } else {\n                toast.error(result.error || \"Erreur lors de l'upload\");\n            }\n        } catch (error) {\n            console.error(\"Upload error:\", error);\n            toast.error(\"Erreur lors de l'upload du document\");\n        } finally {\n            setUploading(false);\n        }\n    };\n\n    const getFileIcon = (fileName: string) => {\n        const ext = fileName.split(\".\").pop()?.toLowerCase();\n        if (ext === \"pdf\") return <FileText className=\"h-5 w-5 text-red-500\" />;\n        if ([\"jpg\", \"jpeg\", \"png\", \"webp\"].includes(ext || \"\"))\n            return <ImageIcon className=\"h-5 w-5 text-blue-500\" />;\n        return <FileIcon className=\"h-5 w-5 text-gray-500\" />;\n    };\n\n    const formatFileSize = (bytes: number) => {\n        if (bytes < 1024) return bytes + \" B\";\n        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + \" KB\";\n        return (bytes / (1024 * 1024)).toFixed(1) + \" MB\";\n    };\n\n    return (\n        <div className={`space-y-4 ${className}`}>\n            <div>\n                <Label className=\"text-white\">{label}</Label>\n                {description && <p className=\"text-sm text-white/60 mt-1\">{description}</p>}\n            </div>\n\n            {loading ? (\n                <Card className=\"p-6 bg-white/5 border-white/10\">\n                    <div className=\"flex items-center justify-center gap-2 text-white/60\">\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\n                        <span>Chargement des documents...</span>\n                    </div>\n                </Card>\n            ) : documents.length === 0 ? (\n                <Card className=\"p-6 bg-white/5 border-white/10 text-center\">\n                    <FileText className=\"h-12 w-12 text-white/30 mx-auto mb-3\" />\n                    <p className=\"text-white/60 mb-4\">Aucun document dans votre coffre-fort</p>\n                    <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\n                        <DialogTrigger asChild>\n                            <Button variant=\"outline\" className=\"mx-auto\">\n                                <Upload className=\"h-4 w-4 mr-2\" />\n                                Uploader un document\n                            </Button>\n                        </DialogTrigger>\n                        <DialogContent className=\"bg-[#0a0118] border-white/10\">\n                            <DialogHeader>\n                                <DialogTitle className=\"text-white\">Uploader un nouveau document</DialogTitle>\n                                <DialogDescription className=\"text-white/60\">\n                                    Ajoutez un document √† votre coffre-fort (PDF, JPG, PNG, max 5 MB)\n                                </DialogDescription>\n                            </DialogHeader>\n                            <div className=\"space-y-4 pt-4\">\n                                <div>\n                                    <Label htmlFor=\"doc-type\" className=\"text-white\">\n                                        Type de document\n                                    </Label>\n                                    <Select\n                                        value={uploadForm.type}\n                                        onValueChange={(value) => setUploadForm({ ...uploadForm, type: value })}\n                                        disabled={!!documentType}\n                                    >\n                                        <SelectTrigger className=\"bg-white/5 border-white/10 text-white\">\n                                            <SelectValue />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                            {documentTypes.map((type) => (\n                                                <SelectItem key={type.value} value={type.value}>\n                                                    {type.label}\n                                                </SelectItem>\n                                            ))}\n                                        </SelectContent>\n                                    </Select>\n                                </div>\n\n                                <div>\n                                    <Label htmlFor=\"doc-file\" className=\"text-white\">\n                                        Fichier\n                                    </Label>\n                                    <Input\n                                        id=\"doc-file\"\n                                        type=\"file\"\n                                        accept=\".pdf,.jpg,.jpeg,.png\"\n                                        onChange={(e) =>\n                                            setUploadForm({ ...uploadForm, file: e.target.files?.[0] || null })\n                                        }\n                                        className=\"bg-white/5 border-white/10 text-white cursor-pointer file:cursor-pointer\"\n                                    />\n                                    {uploadForm.file && (\n                                        <p className=\"text-sm text-white/60 mt-1\">\n                                            {uploadForm.file.name} ({formatFileSize(uploadForm.file.size)})\n                                        </p>\n                                    )}\n                                </div>\n\n                                <Button\n                                    onClick={handleUpload}\n                                    disabled={!uploadForm.file || uploading}\n                                    className=\"w-full\"\n                                >\n                                    {uploading ? (\n                                        <>\n                                            <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                                            Upload en cours...\n                                        </>\n                                    ) : (\n                                        <>\n                                            <Upload className=\"h-4 w-4 mr-2\" />\n                                            Uploader\n                                        </>\n                                    )}\n                                </Button>\n                            </div>\n                        </DialogContent>\n                    </Dialog>\n                </Card>\n            ) : (\n                <div className=\"space-y-3\">\n                    <RadioGroup value={selectedId} onValueChange={handleSelectDocument}>\n                        <div className=\"grid gap-2\">\n                            {documents.map((doc) => (\n                                <Card\n                                    key={doc.id}\n                                    className={`p-4 cursor-pointer transition-all ${selectedId === doc.id\n                                        ? \"bg-primary/20 border-primary\"\n                                        : \"bg-white/5 border-white/10 hover:bg-white/10\"\n                                        }`}\n                                    onClick={() => handleSelectDocument(doc.id)}\n                                >\n                                    <div className=\"flex items-center gap-3\">\n                                        <RadioGroupItem value={doc.id} id={doc.id} />\n                                        {getFileIcon(doc.name)}\n                                        <div className=\"flex-1 min-w-0\">\n                                            <p className=\"text-white font-medium truncate\">{doc.name}</p>\n                                            <p className=\"text-xs text-white/50\">\n                                                {formatFileSize(doc.size)} ‚Ä¢ {new Date(doc.uploaded_at).toLocaleDateString()}\n                                            </p>\n                                        </div>\n\n                                        {/* Preview button */}\n                                        <Button\n                                            variant=\"ghost\"\n                                            size=\"icon\"\n                                            type=\"button\"\n                                            onClick={(e) => {\n                                                e.stopPropagation();\n                                                if (doc.url) {\n                                                    setPreviewDoc(doc);\n                                                    setIsPreviewOpen(true);\n                                                } else {\n                                                    toast.error(\"Lien expir√©, veuillez rafra√Æchir la page\");\n                                                }\n                                            }}\n                                            className=\"hover:bg-blue-500/20 text-blue-400 shrink-0\"\n                                            title=\"Pr√©visualiser le document\"\n                                        >\n                                            <Eye className=\"h-4 w-4\" />\n                                        </Button>\n\n                                        {selectedId === doc.id && (\n                                            <Check className=\"h-5 w-5 text-primary shrink-0\" />\n                                        )}\n                                    </div>\n                                </Card>\n                            ))}\n                        </div>\n                    </RadioGroup>\n\n                    <div className=\"flex gap-2\">\n                        <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\n                            <DialogTrigger asChild>\n                                <Button variant=\"outline\" className=\"flex-1\">\n                                    <Upload className=\"h-4 w-4 mr-2\" />\n                                    Uploader un nouveau\n                                </Button>\n                            </DialogTrigger>\n                            <DialogContent className=\"bg-[#0a0118] border-white/10\">\n                                <DialogHeader>\n                                    <DialogTitle className=\"text-white\">Uploader un nouveau document</DialogTitle>\n                                    <DialogDescription className=\"text-white/60\">\n                                        Ajoutez un document √† votre coffre-fort (PDF, JPG, PNG, max 5 MB)\n                                    </DialogDescription>\n                                </DialogHeader>\n                                <div className=\"space-y-4 pt-4\">\n                                    <div>\n                                        <Label htmlFor=\"doc-type\" className=\"text-white\">\n                                            Type de document\n                                        </Label>\n                                        <Select\n                                            value={uploadForm.type}\n                                            onValueChange={(value) => setUploadForm({ ...uploadForm, type: value })}\n                                            disabled={!!documentType}\n                                        >\n                                            <SelectTrigger className=\"bg-white/5 border-white/10 text-white\">\n                                                <SelectValue />\n                                            </SelectTrigger>\n                                            <SelectContent>\n                                                {documentTypes.map((type) => (\n                                                    <SelectItem key={type.value} value={type.value}>\n                                                        {type.label}\n                                                    </SelectItem>\n                                                ))}\n                                            </SelectContent>\n                                        </Select>\n                                    </div>\n\n                                    <div>\n                                        <Label htmlFor=\"doc-file\" className=\"text-white\">\n                                            Fichier\n                                        </Label>\n                                        <Input\n                                            id=\"doc-file\"\n                                            type=\"file\"\n                                            accept=\".pdf,.jpg,.jpeg,.png\"\n                                            onChange={(e) =>\n                                                setUploadForm({ ...uploadForm, file: e.target.files?.[0] || null })\n                                            }\n                                            className=\"bg-white/5 border-white/10 text-white cursor-pointer file:cursor-pointer\"\n                                        />\n                                        {uploadForm.file && (\n                                            <p className=\"text-sm text-white/60 mt-1\">\n                                                {uploadForm.file.name} ({formatFileSize(uploadForm.file.size)})\n                                            </p>\n                                        )}\n                                    </div>\n\n                                    <Button\n                                        onClick={handleUpload}\n                                        disabled={!uploadForm.file || uploading}\n                                        className=\"w-full\"\n                                    >\n                                        {uploading ? (\n                                            <>\n                                                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                                                Upload en cours...\n                                            </>\n                                        ) : (\n                                            <>\n                                                <Upload className=\"h-4 w-4 mr-2\" />\n                                                Uploader\n                                            </>\n                                        )}\n                                    </Button>\n                                </div>\n                            </DialogContent>\n                        </Dialog>\n\n                        {selectedId && (\n                            <Button variant=\"ghost\" onClick={handleDeselectDocument} className=\"flex-1\">\n                                D√©s√©lectionner\n                            </Button>\n                        )}\n                    </div>\n                </div>\n            )}\n\n            {/* Preview Modal */}\n            <Dialog open={isPreviewOpen} onOpenChange={setIsPreviewOpen}>\n                <DialogContent className=\"bg-[#0a0118] border-white/10 max-w-4xl max-h-[90vh] overflow-auto\">\n                    <DialogHeader>\n                        <DialogTitle className=\"text-white\">{previewDoc?.name}</DialogTitle>\n                        <DialogDescription className=\"text-white/60\">\n                            {previewDoc && formatFileSize(previewDoc.size)} ‚Ä¢ {previewDoc && new Date(previewDoc.uploaded_at).toLocaleDateString()}\n                        </DialogDescription>\n                    </DialogHeader>\n                    <div className=\"mt-4\">\n                        {previewDoc && (\n                            <div className=\"w-full\">\n                                {previewDoc.name.toLowerCase().endsWith('.pdf') ? (\n                                    <div className=\"flex flex-col items-center justify-center gap-4 p-8 border-2 border-dashed border-white/20 rounded-lg bg-white/5\">\n                                        <FileText className=\"h-16 w-16 text-blue-400\" />\n                                        <p className=\"text-white text-center\">\n                                            Les PDFs ne peuvent pas √™tre affich√©s dans le modal pour des raisons de s√©curit√©.\n                                        </p>\n                                        <Button\n                                            onClick={() => {\n                                                window.open(previewDoc.url, '_blank');\n                                                setIsPreviewOpen(false);\n                                            }}\n                                            className=\"bg-blue-500 hover:bg-blue-600 text-white\"\n                                        >\n                                            Ouvrir le PDF dans un nouvel onglet\n                                        </Button>\n                                    </div>\n                                ) : (\n                                    // eslint-disable-next-line @next/next/no-img-element\n                                    <img\n                                        src={previewDoc.url}\n                                        alt={previewDoc.name}\n                                        className=\"w-full h-auto rounded-lg border border-white/10\"\n                                    />\n                                )}\n                            </div>\n                        )}\n                    </div>\n                </DialogContent>\n            </Dialog>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\forms\\address-autocomplete.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1171,1174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1171,1174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport * as React from \"react\";\r\nimport { MapPin, Loader2 } from \"lucide-react\";\r\nimport { Command as _CommandPrimitive } from \"cmdk\";\r\nimport { _useDebounce } from \"@/hooks/use-debounce\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n    _Command,\r\n    _CommandEmpty,\r\n    _CommandGroup,\r\n    _CommandItem,\r\n    _CommandList,\r\n} from \"@/components/ui/command\";\r\n\r\ninterface AddressAutocompleteProps {\r\n    onAddressSelect: (address: {\r\n        display_name: string;\r\n        road?: string;\r\n        suburb?: string;\r\n        city?: string;\r\n        state?: string;\r\n        lat?: string;\r\n        lon?: string;\r\n    }) => void;\r\n    defaultValue?: string;\r\n    className?: string;\r\n}\r\n\r\ninterface NominatimResult {\r\n    place_id: number;\r\n    lat: string;\r\n    lon: string;\r\n    display_name: string;\r\n    address: {\r\n        road?: string;\r\n        suburb?: string;\r\n        city?: string;\r\n        town?: string;\r\n        village?: string;\r\n        municipality?: string;\r\n        state?: string;\r\n        state_district?: string;\r\n        country?: string;\r\n    };\r\n}\r\n\r\nconst getPlaceName = (address: any) => {\r\n    return (\r\n        address.city ||        // Grandes villes (ex: Dakar)\r\n        address.town ||        // Villes moyennes (ex: Gu√©diawaye, Pikine)\r\n        address.village ||     // Villages\r\n        address.hamlet ||      // Hameaux\r\n        address.suburb ||      // Quartiers / Banlieues\r\n        address.county ||      // D√©partements\r\n        address.neighbourhood  // Quartier pr√©cis\r\n    );\r\n};\r\n\r\nimport {\r\n    Popover,\r\n    PopoverContent,\r\n    PopoverTrigger,\r\n} from \"@/components/ui/popover\";\r\n\r\nexport function AddressAutocomplete({\r\n\r\n    onAddressSelect,\r\n    defaultValue = \"\",\r\n    className,\r\n}: AddressAutocompleteProps) {\r\n    const [open, setOpen] = React.useState(false);\r\n    const [query, setQuery] = React.useState(defaultValue);\r\n    const [results, setResults] = React.useState<NominatimResult[]>([]);\r\n    const [loading, setLoading] = React.useState(false);\r\n    const ignoreNextQueryChange = React.useRef(false);\r\n\r\n    React.useEffect(() => {\r\n        if (ignoreNextQueryChange.current) {\r\n            ignoreNextQueryChange.current = false;\r\n            return;\r\n        }\r\n\r\n        const timer = setTimeout(() => {\r\n            if (query && query.length >= 3) {\r\n                fetchSuggestions(query);\r\n            } else {\r\n                setResults([]);\r\n            }\r\n        }, 1000); // 1000ms debounce as requested\r\n\r\n        return () => clearTimeout(timer);\r\n    }, [query]);\r\n\r\n    const fetchSuggestions = async (searchQuery: string) => {\r\n        setLoading(true);\r\n        try {\r\n            const params = new URLSearchParams({\r\n                q: searchQuery,\r\n                format: \"json\",\r\n                addressdetails: \"1\",\r\n                limit: \"5\",\r\n                countrycodes: \"sn\", // Restricted to Senegal\r\n                \"accept-language\": \"fr\",\r\n            });\r\n\r\n            const response = await fetch(\r\n                `https://nominatim.openstreetmap.org/search?${params.toString()}`,\r\n                {\r\n                    headers: {\r\n                        'User-Agent': 'DousellImmo/1.0 (https://dousell.com)',\r\n                    },\r\n                }\r\n            );\r\n\r\n            if (!response.ok) throw new Error(\"Network response was not ok\");\r\n\r\n            const data = await response.json();\r\n            setResults(data);\r\n            setOpen(true);\r\n        } catch (error) {\r\n            console.error(\"Error fetching address:\", error);\r\n            setResults([]);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleSelect = (item: NominatimResult) => {\r\n        // 1. Extraire les composants de base\r\n        const city = item.address.city || item.address.town || item.address.village || item.address.municipality;\r\n        const mainName = getPlaceName(item.address);\r\n        const region = item.address.state; // R√©gion au S√©n√©gal\r\n\r\n        // 2. Construire le label d'affichage : R√©gion, Ville/Quartier\r\n        const labelParts = [];\r\n        if (region) labelParts.push(region);\r\n        if (mainName && mainName !== region) labelParts.push(mainName);\r\n\r\n        // Si on n'a rien trouv√© de pr√©cis, on garde le display_name de Nominatim\r\n        const displayLabel = labelParts.length > 0 ? labelParts.join(\", \") : item.display_name;\r\n\r\n        // 3. Construire l'adresse compl√®te (pour le stockage et la recherche)\r\n        // On s'assure que \"S√©n√©gal\" est √† la fin pour la coh√©rence\r\n        let fullAddress = displayLabel;\r\n        if (!fullAddress.toLowerCase().includes(\"s√©n√©gal\")) {\r\n            fullAddress += \", S√©n√©gal\";\r\n        }\r\n\r\n        ignoreNextQueryChange.current = true;\r\n        setQuery(fullAddress);\r\n        setOpen(false);\r\n        setResults([]);\r\n\r\n        onAddressSelect({\r\n            display_name: fullAddress,\r\n            road: item.address.road,\r\n            suburb: item.address.suburb,\r\n            city: mainName || city,\r\n            state: region,\r\n            lat: item.lat,\r\n            lon: item.lon\r\n        });\r\n    };\r\n\r\n    return (\r\n        <Popover open={open && results.length > 0} onOpenChange={setOpen}>\r\n            <PopoverTrigger asChild>\r\n                <div className={cn(\"relative\", className)}>\r\n                    <Input\r\n                        value={query}\r\n                        onChange={(e) => {\r\n                            setQuery(e.target.value);\r\n                            setOpen(true);\r\n                        }}\r\n                        onFocus={() => {\r\n                            if (results.length > 0) setOpen(true);\r\n                        }}\r\n                        placeholder=\"Ex: 15 Avenue Lamine Gueye...\"\r\n                        className=\"pr-10\"\r\n                    />\r\n                    {loading && (\r\n                        <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\r\n                            <Loader2 className=\"h-4 w-4 animate-spin text-muted-foreground\" />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </PopoverTrigger>\r\n            <PopoverContent\r\n                className=\"p-0 w-[calc(100vw-32px)] md:w-[350px]\"\r\n                align=\"start\"\r\n                onOpenAutoFocus={(e: Event) => e.preventDefault()}\r\n            >\r\n                <div className=\"max-h-[300px] overflow-y-auto p-1\">\r\n                    {results.map((item) => {\r\n                        const mainName = getPlaceName(item.address);\r\n                        const region = item.address.state; // R√©gion au S√©n√©gal\r\n\r\n                        const labelParts = [];\r\n                        if (region) labelParts.push(region);\r\n                        if (mainName && mainName !== region) labelParts.push(mainName);\r\n\r\n                        // Si on n'a rien trouv√© de pr√©cis, on garde le display_name de Nominatim\r\n                        const displayLabel = labelParts.length > 0 ? labelParts.join(\", \") : item.display_name;\r\n\r\n                        return (\r\n                            <div\r\n                                key={item.place_id}\r\n                                onMouseDown={(e) => {\r\n                                    e.preventDefault();\r\n                                    handleSelect(item);\r\n                                }}\r\n                                className=\"flex flex-col items-start gap-1 py-3 px-4 cursor-pointer rounded-sm hover:bg-muted/50 text-sm\"\r\n                            >\r\n                                <div className=\"flex items-start gap-2 w-full\">\r\n                                    <MapPin className=\"h-4 w-4 mt-0.5 text-muted-foreground shrink-0\" />\r\n                                    <div className=\"flex flex-col\">\r\n                                        <span className=\"font-medium text-foreground\">\r\n                                            {displayLabel}\r\n                                        </span>\r\n                                        <span className=\"text-xs text-muted-foreground line-clamp-1\">\r\n                                            {item.display_name}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </PopoverContent>\r\n        </Popover>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\forms\\address-input-with-map.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[969,972],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[969,972],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\AssociateTenantDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\FeatureLockedState.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\GestionTour.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\GestionTour.tsx:17:9\n  15 |     // Attendre que le composant soit mont√© c√¥t√© client\n  16 |     useEffect(() => {\n> 17 |         setMounted(true);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  18 |\n  19 |         // D√©tecter si mobile\n  20 |         const checkMobile = () => {","line":17,"column":9,"nodeType":null,"endLine":17,"endColumn":19},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\GestionTour.tsx:33:13\n  31 |     useEffect(() => {\n  32 |         if (!isMobile) {\n> 33 |             setIsBottomNavVisible(false);\n     |             ^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  34 |             return;\n  35 |         }\n  36 |","line":33,"column":13,"nodeType":null,"endLine":33,"endColumn":34}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useMemo, useState, useEffect } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport { OnboardingTour, useOnboardingTour, TourStep } from '@/components/onboarding/OnboardingTour';\r\nimport { useTheme } from \"@/components/theme-provider\";\r\n\r\nexport function GestionTour() {\r\n    const { showTour, closeTour, resetTour } = useOnboardingTour('dousell_gestion_tour', 1500);\r\n    const { isDark } = useTheme();\r\n    const [mounted, setMounted] = useState(false);\r\n    const [isBottomNavVisible, setIsBottomNavVisible] = useState(false); // Initialize as false\r\n    const [isMobile, setIsMobile] = useState(false);\r\n\r\n    // Attendre que le composant soit mont√© c√¥t√© client\r\n    useEffect(() => {\r\n        setMounted(true);\r\n\r\n        // D√©tecter si mobile\r\n        const checkMobile = () => {\r\n            setIsMobile(window.innerWidth < 1024); // lg breakpoint\r\n        };\r\n\r\n        checkMobile();\r\n        window.addEventListener('resize', checkMobile);\r\n\r\n        return () => window.removeEventListener('resize', checkMobile);\r\n    }, []);\r\n\r\n    // D√©tecter la visibilit√© de la bottom nav (sur mobile uniquement)\r\n    useEffect(() => {\r\n        if (!isMobile) {\r\n            setIsBottomNavVisible(false);\r\n            return;\r\n        }\r\n\r\n        const scrollContainer = document.querySelector(\"main.overflow-y-auto\");\r\n        if (!scrollContainer) return;\r\n\r\n        let lastScrollY = scrollContainer.scrollTop;\r\n\r\n        // Initialisation imm√©diate\r\n        const initVisibility = () => {\r\n            if (scrollContainer.scrollTop > 100) {\r\n                setIsBottomNavVisible(false);\r\n            } else {\r\n                setIsBottomNavVisible(true);\r\n            }\r\n            // On met √† jour lastScrollY pour √©viter des sauts\r\n            lastScrollY = scrollContainer.scrollTop;\r\n        };\r\n\r\n        // 1. Check imm√©diat\r\n        initVisibility();\r\n\r\n        // 2. Check retard√© pour la restauration du scroll navigateur\r\n        const _timeoutId = setTimeout(initVisibility, 100);\r\n\r\n        let ticking = false;\r\n\r\n        const handleScroll = () => {\r\n            if (!ticking) {\r\n                window.requestAnimationFrame(() => {\r\n                    const currentScrollY = scrollContainer.scrollTop;\r\n                    const scrollDelta = currentScrollY - lastScrollY;\r\n\r\n                    // Seuil de 10px pour √©viter les micro-mouvements\r\n                    if (Math.abs(scrollDelta) > 10) {\r\n                        if (scrollDelta > 0 && currentScrollY > 100) {\r\n                            // Scroll vers le bas -> bottom nav cach√©e\r\n                            setIsBottomNavVisible(false);\r\n                        } else if (scrollDelta < 0) {\r\n                            // Scroll vers le haut -> bottom nav visible\r\n                            setIsBottomNavVisible(true);\r\n                        }\r\n                        lastScrollY = currentScrollY;\r\n                    }\r\n\r\n                    ticking = false;\r\n                });\r\n                ticking = true;\r\n            }\r\n        };\r\n\r\n        scrollContainer.addEventListener('scroll', handleScroll, { passive: true });\r\n\r\n        return () => {\r\n            scrollContainer.removeEventListener('scroll', handleScroll);\r\n        };\r\n    }, [isMobile]);\r\n\r\n    // √âtapes du tour pour la page Gestion Locative\r\n    const tourSteps: TourStep[] = useMemo(() => [\r\n        {\r\n            targetId: 'tour-gestion-table',\r\n            title: 'Gestion des baux',\r\n            description: 'Visualisez tous vos baux actifs, suivez les paiements, envoyez des relances et g√©rez vos locataires.',\r\n            imageSrc: 'https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?auto=format&fit=crop&q=80&w=600',\r\n            imageAlt: 'Tableau de gestion'\r\n        },\r\n        {\r\n            targetId: 'tour-gestion-actions',\r\n            title: 'Actions rapides',\r\n            description: 'G√©n√©rez vos documents (contrats, quittances, √©tats des lieux) et ajoutez de nouveaux locataires en quelques clics.',\r\n            imageSrc: 'https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?auto=format&fit=crop&q=80&w=600',\r\n            imageAlt: 'Actions de gestion'\r\n        },\r\n        {\r\n            targetId: 'tour-gestion-kpi-cards',\r\n            title: 'Statistiques en temps r√©el',\r\n            description: 'Suivez vos indicateurs cl√©s : taux d\\'occupation, d√©lais de paiement, taux d\\'impay√©s et revenu moyen par bien.',\r\n            imageSrc: 'https://images.unsplash.com/photo-1543286386-713df548e617?auto=format&fit=crop&q=80&w=600',\r\n            imageAlt: 'Statistiques de gestion'\r\n        },\r\n        {\r\n            targetId: 'tour-gestion-revenue-chart',\r\n            title: 'Historique des revenus',\r\n            description: 'Analysez vos revenus collect√©s et attendus sur les 12 derniers mois pour mieux piloter votre activit√©.',\r\n            imageSrc: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&q=80&w=600',\r\n            imageAlt: 'Graphique des revenus'\r\n        }\r\n    ], []);\r\n\r\n    // Position intelligente selon le contexte\r\n    const getButtonPosition = () => {\r\n        if (!isMobile) {\r\n            return 'bottom-6'; // Desktop : position normale\r\n        }\r\n        return isBottomNavVisible ? 'bottom-20' : 'bottom-6'; // Mobile : adaptatif\r\n    };\r\n\r\n    // Couleur accent adaptative : Dor√© en dark, Bleu nuit gris√© en light\r\n    const accentColor = isDark ? '#F4C430' : '#7891A8';\r\n\r\n    // Bouton flottant √† rendre dans un Portal - adaptatif light/dark\r\n    const floatingButton = mounted ? createPortal(\r\n        <button\r\n            onClick={resetTour}\r\n            className=\"fixed right-6 z-[100000] p-3 rounded-full shadow-lg backdrop-blur-sm\"\r\n            style={{\r\n                bottom: getButtonPosition() === 'bottom-20' ? '5rem' : '1.5rem',\r\n                backgroundColor: isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.9)',\r\n                borderColor: `${accentColor}33`, // 20% opacity\r\n                borderWidth: '1px',\r\n                borderStyle: 'solid',\r\n                color: `${accentColor}99`, // 60% opacity\r\n                transition: 'bottom 0.3s ease-out, background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease'\r\n            }}\r\n            title=\"Relancer le tutoriel\"\r\n            aria-label=\"Relancer le tutoriel de la page gestion\"\r\n        >\r\n            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                <circle cx=\"12\" cy=\"12\" r=\"10\" />\r\n                <path d=\"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3\" />\r\n                <path d=\"M12 17h.01\" />\r\n            </svg>\r\n        </button>,\r\n        document.body\r\n    ) : null;\r\n\r\n    // Callback pour changer de tab selon l'√©tape du tour\r\n    const handleStepChange = (index: number) => {\r\n        const step = tourSteps[index];\r\n        if (!step) return;\r\n\r\n        // Switch de tab bas√© sur le targetId\r\n        if (step.targetId === 'tour-gestion-kpi-cards' || step.targetId === 'tour-gestion-revenue-chart') {\r\n            window.dispatchEvent(new CustomEvent('dousell-tour-switch-tab', { detail: 'performance' }));\r\n        } else if (step.targetId === 'tour-gestion-table' || step.targetId === 'tour-gestion-actions') {\r\n            window.dispatchEvent(new CustomEvent('dousell-tour-switch-tab', { detail: 'overview' }));\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            <OnboardingTour\r\n                steps={tourSteps}\r\n                isOpen={showTour}\r\n                onClose={closeTour}\r\n                onComplete={closeTour}\r\n                storageKey=\"dousell_gestion_tour\"\r\n                isDark={isDark}\r\n                onStepChange={handleStepChange}\r\n            />\r\n\r\n            {/* Bouton flottant mont√© directement dans le body via Portal, cach√© pendant le tour */}\r\n            {!showTour && floatingButton}\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\OwnerSelector.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\OwnerSelector.tsx:42:7\n  40 |   useEffect(() => {\n  41 |     if (isOpen) {\n> 42 |       handleSearch(\"\");\n     |       ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  43 |     }\n  44 |   }, [isOpen, handleSearch]);\n  45 |","line":42,"column":7,"nodeType":null,"endLine":42,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { Search, Plus, User, Phone, Mail, Check, X } from \"lucide-react\";\nimport { searchOwners, createOwner } from \"@/app/(workspace)/gestion/biens/actions\";\n\ntype Owner = {\n  id: string;\n  full_name: string | null;\n  phone: string | null;\n  email?: string | null;\n  avatar_url?: string | null;\n};\n\ntype OwnerSelectorProps = {\n  value?: string;\n  onChange: (ownerId: string | undefined, ownerData?: Owner) => void;\n  className?: string;\n};\n\nexport function OwnerSelector({ value, onChange, className = \"\" }: OwnerSelectorProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [owners, setOwners] = useState<Owner[]>([]);\n  const [selectedOwner, setSelectedOwner] = useState<Owner | null>(null);\n  const [isSearching, setIsSearching] = useState(false);\n  const [showCreateForm, setShowCreateForm] = useState(false);\n  const [newOwner, setNewOwner] = useState({ full_name: \"\", phone: \"\", email: \"\" });\n  const [isCreating, setIsCreating] = useState(false);\n\n  // Recherche de propri√©taires\n  const handleSearch = useCallback(async (query: string) => {\n    setIsSearching(true);\n    const result = await searchOwners(query);\n    setOwners(result.owners);\n    setIsSearching(false);\n  }, []);\n\n  // Charger la liste initiale √† l'ouverture\n  useEffect(() => {\n    if (isOpen) {\n      handleSearch(\"\");\n    }\n  }, [isOpen, handleSearch]);\n\n  // Debounce de la recherche\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      // Ne pas relancer la recherche vide car d√©j√† faite au chargement\n      if (searchQuery.trim().length > 0) {\n        handleSearch(searchQuery);\n      } else if (searchQuery === \"\" && isOpen) {\n        // Optionnel : recharger la liste vide si on efface tout\n        handleSearch(\"\");\n      }\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [searchQuery, handleSearch, isOpen]);\n\n  // S√©lection d'un propri√©taire\n  const handleSelect = (owner: Owner) => {\n    setSelectedOwner(owner);\n    onChange(owner.id, owner);\n    setIsOpen(false);\n    setSearchQuery(\"\");\n  };\n\n  // Cr√©er un nouveau propri√©taire\n  const handleCreate = async () => {\n    if (!newOwner.full_name || !newOwner.phone) return;\n\n    setIsCreating(true);\n    const result = await createOwner(newOwner);\n    setIsCreating(false);\n\n    if (result.success && result.owner) {\n      setSelectedOwner(result.owner);\n      onChange(result.owner.id, result.owner);\n      setShowCreateForm(false);\n      setNewOwner({ full_name: \"\", phone: \"\", email: \"\" });\n      setIsOpen(false);\n    }\n  };\n\n  // Retirer le propri√©taire s√©lectionn√©\n  const handleClear = () => {\n    setSelectedOwner(null);\n    onChange(undefined);\n  };\n\n  return (\n    <div className={`relative ${className}`}>\n      <label className=\"block text-sm font-medium text-muted-foreground mb-2\">\n        Propri√©taire du bien\n      </label>\n\n      {/* Propri√©taire s√©lectionn√© */}\n      {selectedOwner ? (\n        <div className=\"flex items-center justify-between bg-card border border-border rounded-lg p-3 shadow-sm\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center text-muted-foreground\">\n              <User className=\"w-5 h-5\" />\n            </div>\n            <div>\n              <p className=\"font-medium text-foreground\">{selectedOwner.full_name}</p>\n              <p className=\"text-sm text-muted-foreground\">{selectedOwner.phone}</p>\n            </div>\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleClear}\n            className=\"p-2 hover:bg-muted rounded-lg transition-colors text-muted-foreground hover:text-foreground\"\n          >\n            <X className=\"w-4 h-4\" />\n          </button>\n        </div>\n      ) : (\n        <>\n          {/* Bouton d'ouverture */}\n          <button\n            type=\"button\"\n            onClick={() => setIsOpen(true)}\n            className=\"w-full flex items-center gap-3 bg-background border border-border rounded-lg p-3 hover:bg-muted/50 transition-colors text-left\"\n          >\n            <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center text-muted-foreground\">\n              <User className=\"w-5 h-5\" />\n            </div>\n            <span className=\"text-muted-foreground\">S√©lectionner un propri√©taire...</span>\n          </button>\n        </>\n      )}\n\n      {/* Modal de s√©lection */}\n      {isOpen && (\n        <div className=\"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm\">\n          <div className=\"bg-background border border-border rounded-xl w-full max-w-md max-h-[80vh] overflow-hidden shadow-2xl\">\n            {/* Header */}\n            <div className=\"p-4 border-b border-border\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  {showCreateForm ? \"Nouveau propri√©taire\" : \"S√©lectionner un propri√©taire\"}\n                </h3>\n                <button\n                  onClick={() => {\n                    setIsOpen(false);\n                    setShowCreateForm(false);\n                  }}\n                  className=\"p-2 hover:bg-muted rounded-lg transition-colors text-muted-foreground hover:text-foreground\"\n                >\n                  <X className=\"w-5 h-5\" />\n                </button>\n              </div>\n\n              {!showCreateForm && (\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground\" />\n                  <input\n                    type=\"text\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    placeholder=\"Rechercher par nom, t√©l√©phone...\"\n                    className=\"w-full bg-muted border border-transparent focus:bg-background focus:border-primary rounded-lg pl-10 pr-4 py-2 text-foreground placeholder:text-muted-foreground focus:outline-none transition-colors\"\n                    autoFocus\n                  />\n                </div>\n              )}\n            </div>\n\n            {/* Content */}\n            <div className=\"p-4 overflow-y-auto max-h-[50vh]\">\n              {showCreateForm ? (\n                <div className=\"space-y-4\">\n                  <div>\n                    <label htmlFor=\"owner_fullname\" className=\"block text-sm text-muted-foreground mb-1\">Nom complet *</label>\n                    <input\n                      id=\"owner_fullname\"\n                      type=\"text\"\n                      value={newOwner.full_name}\n                      onChange={(e) => setNewOwner({ ...newOwner, full_name: e.target.value })}\n                      className=\"w-full bg-background border border-border rounded-lg px-4 py-2 text-foreground focus:outline-none focus:ring-1 focus:ring-primary\"\n                      placeholder=\"Ex: Mamadou Diallo\"\n                    />\n                  </div>\n                  <div>\n                    <label htmlFor=\"owner_phone\" className=\"block text-sm text-muted-foreground mb-1\">T√©l√©phone *</label>\n                    <input\n                      id=\"owner_phone\"\n                      type=\"tel\"\n                      value={newOwner.phone}\n                      onChange={(e) => setNewOwner({ ...newOwner, phone: e.target.value })}\n                      className=\"w-full bg-background border border-border rounded-lg px-4 py-2 text-foreground focus:outline-none focus:ring-1 focus:ring-primary\"\n                      placeholder=\"Ex: 77 123 45 67\"\n                    />\n                  </div>\n                  <div>\n                    <label htmlFor=\"owner_email\" className=\"block text-sm text-muted-foreground mb-1\">Email (optionnel)</label>\n                    <input\n                      id=\"owner_email\"\n                      type=\"email\"\n                      value={newOwner.email}\n                      onChange={(e) => setNewOwner({ ...newOwner, email: e.target.value })}\n                      className=\"w-full bg-background border border-border rounded-lg px-4 py-2 text-foreground focus:outline-none focus:ring-1 focus:ring-primary\"\n                      placeholder=\"Ex: mamadou@email.com\"\n                    />\n                  </div>\n                </div>\n              ) : (\n                <>\n                  {isSearching ? (\n                    <div className=\"text-center py-8 text-muted-foreground\">Recherche...</div>\n                  ) : owners.length > 0 ? (\n                    <div className=\"space-y-2\">\n                      {owners.map((owner) => (\n                        <button\n                          key={owner.id}\n                          type=\"button\"\n                          onClick={() => handleSelect(owner)}\n                          className=\"w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted transition-colors text-left group\"\n                        >\n                          <div className=\"w-10 h-10 rounded-full bg-muted group-hover:bg-background border border-transparent group-hover:border-border flex items-center justify-center transition-colors\">\n                            <User className=\"w-5 h-5 text-muted-foreground\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"font-medium text-foreground truncate\">{owner.full_name}</p>\n                            <div className=\"flex items-center gap-3 text-sm text-muted-foreground\">\n                              {owner.phone && (\n                                <span className=\"flex items-center gap-1\">\n                                  <Phone className=\"w-3 h-3\" /> {owner.phone}\n                                </span>\n                              )}\n                              {owner.email && (\n                                <span className=\"flex items-center gap-1\">\n                                  <Mail className=\"w-3 h-3\" /> {owner.email}\n                                </span>\n                              )}\n                            </div>\n                          </div>\n                          {value === owner.id && (\n                            <Check className=\"w-5 h-5 text-primary\" />\n                          )}\n                        </button>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      Aucun propri√©taire trouv√©. Cr√©ez-en un nouveau.\n                    </div>\n                  )}\n                </>\n              )}\n            </div>\n\n            {/* Footer */}\n            <div className=\"p-4 border-t border-border bg-muted/20\">\n              {showCreateForm ? (\n                <div className=\"flex gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowCreateForm(false)}\n                    className=\"flex-1 px-4 py-2 border border-border rounded-lg text-foreground hover:bg-muted transition-colors\"\n                  >\n                    Retour\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={handleCreate}\n                    disabled={!newOwner.full_name || !newOwner.phone || isCreating}\n                    className=\"flex-1 px-4 py-2 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                  >\n                    {isCreating ? \"Cr√©ation...\" : \"Cr√©er\"}\n                  </button>\n                </div>\n              ) : (\n                <button\n                  type=\"button\"\n                  onClick={() => setShowCreateForm(true)}\n                  className=\"w-full flex items-center justify-center gap-2 px-4 py-2 border border-dashed border-border rounded-lg text-muted-foreground hover:border-primary hover:text-primary hover:bg-primary/5 transition-all\"\n                >\n                  <Plus className=\"w-5 h-5\" />\n                  Cr√©er un nouveau propri√©taire\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\SubscriptionManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6594,6597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6594,6597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\nimport {\r\n    CreditCard,\r\n    Check,\r\n    Warning,\r\n    _Buildings,\r\n    Clock,\r\n    Sparkle,\r\n    Crown,\r\n    Rocket,\r\n    Receipt,\r\n} from \"@phosphor-icons/react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { toast } from \"sonner\";\r\nimport { getAllPlans, formatPrice, getAnnualSavings, TRIAL_DURATION_DAYS, type BillingCycle } from \"@/lib/subscription/plans-config\";\r\nimport { reactivateSubscription } from \"@/app/(workspace)/gestion/abonnement/actions\";\r\n\r\nexport function SubscriptionManager() {\r\n    const router = useRouter();\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [proStatus, setProStatus] = useState<string | null>(null);\r\n    const [subscriptionTier, setSubscriptionTier] = useState<string | null>(null);\r\n    const [trialEndsAt, setTrialEndsAt] = useState<Date | null>(null);\r\n    const [stats, setStats] = useState({ properties: 0, leases: 0 });\r\n    const [hasStripeCustomer, setHasStripeCustomer] = useState(false);\r\n    const [billingCycle, setBillingCycle] = useState<BillingCycle>('monthly');\r\n    const [canReactivateTrial, setCanReactivateTrial] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const loadData = async () => {\r\n          try {\r\n            const supabase = createClient();\r\n            const { data: { user } } = await supabase.auth.getUser();\r\n\r\n            if (!user) return;\r\n\r\n            const { data: teamMemberships } = await supabase\r\n                .from(\"team_members\")\r\n                .select(\"team_id, team:teams(*)\")\r\n                .eq(\"user_id\", user.id)\r\n                .eq(\"status\", \"active\");\r\n\r\n            const teamMembership = teamMemberships && teamMemberships.length > 0 ? teamMemberships[0] : null;\r\n            const team = teamMembership?.team as {\r\n                subscription_status?: string;\r\n                subscription_tier?: string;\r\n                subscription_trial_ends_at?: string;\r\n                stripe_customer_id?: string;\r\n                trial_reactivation_count?: number;\r\n            } | null;\r\n            const tId = teamMembership?.team_id;\r\n\r\n            if (team) {\r\n                let effectiveStatus = team.subscription_status || null;\r\n                let effectiveTier = team.subscription_tier || 'starter';\r\n\r\n                // Normaliser : si trialing mais date expir√©e, traiter comme expir√©\r\n                if (effectiveStatus === 'trialing' && team.subscription_trial_ends_at) {\r\n                    const trialEnd = new Date(team.subscription_trial_ends_at);\r\n                    if (trialEnd < new Date()) {\r\n                        effectiveStatus = 'past_due';\r\n                        effectiveTier = 'starter';\r\n                    }\r\n                }\r\n\r\n                setProStatus(effectiveStatus);\r\n                setSubscriptionTier(effectiveTier);\r\n                setHasStripeCustomer(!!team.stripe_customer_id);\r\n\r\n                // Peut r√©activer l'essai si expir√© et pas encore utilis√© la r√©activation\r\n                const MAX_REACTIVATIONS = 1;\r\n                const isExpiredStatus = effectiveStatus === 'past_due' || effectiveStatus === 'canceled';\r\n                const reactivationsUsed = team.trial_reactivation_count ?? 0;\r\n                setCanReactivateTrial(isExpiredStatus && reactivationsUsed < MAX_REACTIVATIONS);\r\n                if (team.subscription_trial_ends_at) {\r\n                    setTrialEndsAt(new Date(team.subscription_trial_ends_at));\r\n                }\r\n            }\r\n\r\n            if (tId) {\r\n                const { count: propertiesCount } = await supabase\r\n                    .from(\"properties\")\r\n                    .select(\"*\", { count: \"exact\", head: true })\r\n                    .eq(\"team_id\", tId);\r\n\r\n                const { count: leasesCount } = await supabase\r\n                    .from(\"leases\")\r\n                    .select(\"*\", { count: \"exact\", head: true })\r\n                    .eq(\"team_id\", tId)\r\n                    .eq(\"status\", \"active\");\r\n\r\n                setStats({\r\n                    properties: propertiesCount || 0,\r\n                    leases: leasesCount || 0,\r\n                });\r\n            }\r\n          } catch (err) {\r\n            console.error(\"[SubscriptionManager] Failed to load data:\", err);\r\n          } finally {\r\n            setIsLoading(false);\r\n          }\r\n        };\r\n\r\n        loadData();\r\n    }, []);\r\n\r\n    const handleUpgrade = async (planId: string) => {\r\n        setIsSubmitting(true);\r\n        try {\r\n            const response = await fetch(\"/api/subscription/checkout\", {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify({\r\n                    planId,\r\n                    interval: billingCycle,\r\n                    currency: 'xof',\r\n                }),\r\n            });\r\n\r\n            const data = await response.json();\r\n            if (data.url) {\r\n                window.location.href = data.url;\r\n            } else {\r\n                toast.error(data.error || \"Erreur lors de l'initialisation du paiement\");\r\n            }\r\n        } catch {\r\n            toast.error(\"Une erreur est survenue.\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    const handleOpenPortal = async () => {\r\n        setIsSubmitting(true);\r\n        try {\r\n            const response = await fetch(\"/api/subscription/portal\", {\r\n                method: \"POST\",\r\n            });\r\n            const data = await response.json();\r\n            if (data.url) {\r\n                window.location.href = data.url;\r\n            } else {\r\n                toast.error(data.error || \"Impossible d'acc√©der au portail de facturation\");\r\n            }\r\n        } catch {\r\n            toast.error(\"Une erreur est survenue.\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    const handleReactivateTrial = async () => {\r\n        setIsSubmitting(true);\r\n        try {\r\n            const result = await reactivateSubscription();\r\n            if (result?.data?.success) {\r\n                toast.success(\"Essai gratuit r√©activ√© ! Vous avez 14 jours suppl√©mentaires.\");\r\n                window.location.reload();\r\n                return;\r\n            } else {\r\n                toast.error(result?.error || \"Erreur lors de la r√©activation.\");\r\n            }\r\n        } catch (err: any) {\r\n            toast.error(err.message || \"Une erreur est survenue.\");\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"p-12 flex flex-col items-center justify-center bg-white dark:bg-gray-900/40 rounded-3xl border border-slate-200 dark:border-gray-800\">\r\n                <div className=\"w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin\" />\r\n                <p className=\"mt-4 text-sm text-gray-500\">Chargement de votre abonnement...</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const isExpired = proStatus === \"canceled\" || proStatus === \"past_due\" || proStatus === \"unpaid\" || proStatus === \"incomplete\";\r\n    const isTrial = proStatus === \"trialing\";\r\n    const isActive = proStatus === \"active\";\r\n    const daysLeft = trialEndsAt\r\n        ? Math.max(0, Math.ceil((trialEndsAt.getTime() - Date.now()) / (1000 * 60 * 60 * 24)))\r\n        : 0;\r\n\r\n    // Nom du plan actuel pour l'affichage\r\n    const currentPlanName = getAllPlans().find(p => p.id === subscriptionTier)?.name || 'Starter';\r\n\r\n    return (\r\n        <section className=\"p-6 md:p-8 bg-white dark:bg-gray-900/40 rounded-3xl border border-slate-200 dark:border-gray-800 space-y-8 shadow-sm dark:shadow-none\">\r\n            {/* Header */}\r\n            <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n                <div>\r\n                    <h2 className=\"text-xl font-bold flex items-center gap-2 text-slate-900 dark:text-white\">\r\n                        <CreditCard className=\"w-6 h-6 text-primary\" />\r\n                        Mon Abonnement\r\n                    </h2>\r\n                    <p className=\"text-gray-500 text-sm mt-1\">G√©rez votre formule et vos factures</p>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3\">\r\n                    {/* Stripe Portal Button - for active subscribers */}\r\n                    {isActive && hasStripeCustomer && (\r\n                        <Button\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            onClick={handleOpenPortal}\r\n                            disabled={isSubmitting}\r\n                            className=\"gap-2 text-xs\"\r\n                        >\r\n                            <Receipt size={14} />\r\n                            G√©rer la facturation\r\n                        </Button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Current Plan Summary - toujours visible */}\r\n            <div className={`rounded-2xl p-5 border ${isExpired\r\n                ? 'bg-red-500/5 border-red-500/20'\r\n                : isTrial\r\n                    ? 'bg-primary/5 border-primary/20'\r\n                    : isActive\r\n                        ? 'bg-emerald-500/5 border-emerald-500/20'\r\n                        : 'bg-slate-50 dark:bg-white/5 border-slate-200 dark:border-white/10'\r\n                }`}>\r\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-3\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${isExpired ? 'bg-red-500/10' : isTrial ? 'bg-primary/10' : isActive ? 'bg-emerald-500/10' : 'bg-slate-100 dark:bg-white/10'\r\n                            }`}>\r\n                            {isExpired ? <Warning size={20} className=\"text-red-400\" /> :\r\n                                isTrial ? <Clock size={20} className=\"text-primary\" /> :\r\n                                    isActive ? <Sparkle size={20} className=\"text-emerald-400\" /> :\r\n                                        <Rocket size={20} className=\"text-gray-400\" />}\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-sm font-semibold text-slate-900 dark:text-white\">\r\n                                Plan {currentPlanName}\r\n                                {isTrial && <span className=\"ml-2 text-xs font-medium text-primary bg-primary/10 px-2 py-0.5 rounded-full\">Essai gratuit</span>}\r\n                                {isActive && <span className=\"ml-2 text-xs font-medium text-emerald-500 bg-emerald-500/10 px-2 py-0.5 rounded-full\">Actif</span>}\r\n                                {isExpired && <span className=\"ml-2 text-xs font-medium text-red-400 bg-red-500/10 px-2 py-0.5 rounded-full\">Expir√©</span>}\r\n                            </p>\r\n                            <p className=\"text-xs text-gray-500 mt-0.5\">\r\n                                {isExpired && \"Votre abonnement a expir√©. R√©activez pour retrouver l'acc√®s.\"}\r\n                                {isTrial && trialEndsAt && `${daysLeft} jour${daysLeft > 1 ? 's' : ''} restant${daysLeft > 1 ? 's' : ''} ‚Äî expire le ${trialEndsAt.toLocaleDateString('fr-FR')}`}\r\n                                {isTrial && !trialEndsAt && \"Essai gratuit en cours\"}\r\n                                {isActive && \"Votre abonnement est actif et √† jour.\"}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                    {stats.properties > 0 && (\r\n                        <div className=\"flex items-center gap-4 text-xs text-gray-500\">\r\n                            <span>{stats.properties} bien{stats.properties > 1 ? 's' : ''}</span>\r\n                            <span>{stats.leases} bail{stats.leases > 1 ? 'x' : ''} actif{stats.leases > 1 ? 's' : ''}</span>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Trial Progress Bar - Integrated */}\r\n                {isTrial && trialEndsAt && (\r\n                    <div className=\"mt-6 pt-6 border-t border-primary/10\">\r\n                        <div className=\"flex justify-between items-center mb-2\">\r\n                            <span className=\"text-xs font-medium text-primary\">Progression de l&apos;essai gratuit</span>\r\n                            <span className=\"text-xs text-gray-500\">{Math.round(((TRIAL_DURATION_DAYS - daysLeft) / TRIAL_DURATION_DAYS) * 100)}% compl√©t√©</span>\r\n                        </div>\r\n                        <div className=\"h-2 w-full bg-slate-100 dark:bg-gray-800 rounded-full overflow-hidden\">\r\n                            <div\r\n                                className=\"h-full bg-primary transition-all duration-1000 shadow-[0_0_10px_rgba(var(--primary),0.3)]\"\r\n                                style={{ width: `${Math.min(100, Math.round(((TRIAL_DURATION_DAYS - daysLeft) / TRIAL_DURATION_DAYS) * 100))}%` }}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Reactivation CTA */}\r\n                {isExpired && canReactivateTrial && (\r\n                    <div className=\"mt-6 pt-6 border-t border-red-500/10\">\r\n                        <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-3\">\r\n                            <div>\r\n                                <p className=\"text-sm font-medium text-slate-900 dark:text-white\">R√©activer l&apos;essai gratuit</p>\r\n                                <p className=\"text-xs text-gray-500\">Profitez de 14 jours suppl√©mentaires avec toutes les fonctionnalit√©s Pro.</p>\r\n                            </div>\r\n                            <Button\r\n                                onClick={handleReactivateTrial}\r\n                                disabled={isSubmitting}\r\n                                className=\"bg-primary text-primary-foreground hover:bg-primary/90 font-bold shrink-0\"\r\n                            >\r\n                                <Clock size={16} className=\"mr-2\" />\r\n                                {isSubmitting ? \"R√©activation...\" : \"R√©activer (14 jours)\"}\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Billing Cycle Toggle */}\r\n            {(!isActive || isTrial || isExpired) && (\r\n                <div className=\"flex items-center justify-center gap-3\">\r\n                    <button\r\n                        onClick={() => setBillingCycle('monthly')}\r\n                        className={`px-4 py-2 rounded-xl text-sm font-medium transition-all ${billingCycle === 'monthly'\r\n                            ? 'bg-primary text-primary-foreground shadow-md'\r\n                            : 'bg-slate-100 dark:bg-white/5 text-gray-500 hover:text-gray-700 dark:hover:text-white'\r\n                            }`}\r\n                    >\r\n                        Mensuel\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setBillingCycle('annual')}\r\n                        className={`px-4 py-2 rounded-xl text-sm font-medium transition-all flex items-center gap-2 ${billingCycle === 'annual'\r\n                            ? 'bg-primary text-primary-foreground shadow-md'\r\n                            : 'bg-slate-100 dark:bg-white/5 text-gray-500 hover:text-gray-700 dark:hover:text-white'\r\n                            }`}\r\n                    >\r\n                        Annuel\r\n                        <span className=\"text-[10px] bg-emerald-500 text-white px-1.5 py-0.5 rounded-full font-bold\">-20%</span>\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n            {/* Pricing Cards */}\r\n            <div className=\"grid md:grid-cols-2 gap-6\">\r\n                {getAllPlans()\r\n                    .filter(plan => plan.id !== 'enterprise')\r\n                    .map((plan) => {\r\n                        const isCurrentTier = subscriptionTier === plan.id;\r\n                        const Icon = plan.id === 'starter' ? Rocket : Crown;\r\n                        const price = billingCycle === 'annual'\r\n                            ? plan.pricing.xof.annual.amount\r\n                            : plan.pricing.xof.monthly.amount;\r\n                        const monthlyEquivalent = billingCycle === 'annual'\r\n                            ? Math.round(plan.pricing.xof.annual.amount / 12)\r\n                            : null;\r\n                        const savings = billingCycle === 'annual'\r\n                            ? getAnnualSavings(plan.id, 'xof')\r\n                            : 0;\r\n\r\n                        return (\r\n                            <div\r\n                                key={plan.id}\r\n                                className={`rounded-2xl border ${isCurrentTier\r\n                                    ? 'border-primary bg-primary/5'\r\n                                    : 'border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5'\r\n                                    } p-6 flex flex-col relative`}\r\n                            >\r\n                                {plan.popular && !isCurrentTier && (\r\n                                    <div className=\"absolute top-4 right-4 bg-primary text-primary-foreground text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider\">\r\n                                        Recommand√©\r\n                                    </div>\r\n                                )}\r\n\r\n                                {isCurrentTier && (\r\n                                    <div className={`absolute top-4 right-4 text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider ${isExpired ? 'bg-red-500 text-white' : isTrial ? 'bg-amber-500 text-white' : 'bg-emerald-500 text-white'}`}>\r\n                                        {isExpired ? 'Expir√©' : isTrial ? 'Essai en cours' : 'Plan Actuel'}\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div className=\"flex items-center gap-2 mb-4\">\r\n                                    <Icon size={24} className=\"text-primary\" />\r\n                                    <h3 className=\"text-lg font-bold text-slate-900 dark:text-white\">\r\n                                        {plan.name}\r\n                                    </h3>\r\n                                </div>\r\n\r\n                                <div className=\"mb-6\">\r\n                                    {billingCycle === 'annual' ? (\r\n                                        <>\r\n                                            <span className=\"text-2xl font-bold text-slate-900 dark:text-white\">\r\n                                                {formatPrice(monthlyEquivalent!)}\r\n                                            </span>\r\n                                            <span className=\"text-gray-500 text-xs ml-1\">/ mois</span>\r\n                                            <p className=\"text-xs text-emerald-600 mt-1\">\r\n                                                {formatPrice(price)} / an &middot; √âconomie de {formatPrice(savings)}\r\n                                            </p>\r\n                                        </>\r\n                                    ) : (\r\n                                        <>\r\n                                            <span className=\"text-2xl font-bold text-slate-900 dark:text-white\">\r\n                                                {formatPrice(price)}\r\n                                            </span>\r\n                                            <span className=\"text-gray-500 text-xs ml-1\">/ mois</span>\r\n                                        </>\r\n                                    )}\r\n                                    {plan.id === 'starter' && isCurrentTier && isTrial && (\r\n                                        <p className=\"text-xs text-amber-600 mt-1\">\r\n                                            Plan par d√©faut apr√®s l&apos;essai\r\n                                        </p>\r\n                                    )}\r\n                                </div>\r\n\r\n                                <ul className=\"space-y-3 mb-8 flex-1\">\r\n                                    {plan.highlightedFeatures.slice(0, 4).map((feature, idx) => (\r\n                                        <li key={idx} className=\"flex items-center gap-2 text-xs text-gray-600 dark:text-white/70\">\r\n                                            <Check size={14} className=\"text-primary\" /> {feature}\r\n                                        </li>\r\n                                    ))}\r\n                                </ul>\r\n\r\n                                <Button\r\n                                    onClick={() => handleUpgrade(plan.id)}\r\n                                    disabled={isSubmitting || (isCurrentTier && isActive)}\r\n                                    className={`w-full h-10 text-sm ${isCurrentTier && isActive\r\n                                        ? 'bg-zinc-800 text-white/50 cursor-not-allowed'\r\n                                        : 'bg-primary text-primary-foreground hover:bg-primary/90 font-bold shadow-lg shadow-primary/20'\r\n                                        }`}\r\n                                >\r\n                                    {isCurrentTier && isActive\r\n                                        ? \"Plan actuel\"\r\n                                        : isTrial\r\n                                            ? `Activer ${plan.name}`\r\n                                            : subscriptionTier === 'pro' && plan.id === 'starter'\r\n                                                ? \"R√©trograder\"\r\n                                                : plan.id === 'starter'\r\n                                                    ? \"Choisir Starter\"\r\n                                                    : plan.ctaText\r\n                                    }\r\n                                </Button>\r\n                            </div>\r\n                        );\r\n                    })}\r\n            </div>\r\n\r\n            {/* Enterprise CTA */}\r\n            <div className=\"bg-slate-900/50 dark:bg-black rounded-2xl p-6 text-center border border-slate-200 dark:border-white/5\">\r\n                <h3 className=\"text-md font-bold text-slate-900 dark:text-white mb-1 uppercase tracking-tight\">Besoin de plus ?</h3>\r\n                <p className=\"text-gray-500 text-xs mb-4\">Solutions sur mesure pour agences immobili√®res.</p>\r\n                <Button\r\n                    size=\"sm\"\r\n                    className=\"h-9 px-6 border border-slate-300 dark:border-white/20 text-slate-700 dark:text-white bg-transparent hover:bg-slate-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-primary transition-colors\"\r\n                    onClick={() => router.push(\"/contact?subject=enterprise\")}\r\n                >\r\n                    Contacter les ventes\r\n                </Button>\r\n            </div>\r\n        </section>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\TeamPropertyCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\TenantSelector.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\TenantSelector.tsx:44:9\n  42 |     // Initial load\n  43 |     useEffect(() => {\n> 44 |         handleSearch(\"\");\n     |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  45 |     }, [handleSearch]);\n  46 |\n  47 |     // Debounce de la recherche","line":44,"column":9,"nodeType":null,"endLine":44,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback } from \"react\";\r\nimport { Search, Plus, User, Phone, Check, X } from \"lucide-react\";\r\nimport { searchTenants } from \"@/app/(workspace)/gestion/biens/actions\";\r\nimport { AddTenantButton } from \"@/app/(workspace)/gestion/components/AddTenantButton\";\r\n\r\n// On r√©utilise le type Owner car c'est la m√™me structure (Profile)\r\ntype Tenant = {\r\n    id: string;\r\n    full_name: string | null;\r\n    phone: string | null;\r\n    email?: string | null;\r\n    avatar_url?: string | null;\r\n};\r\n\r\ntype TenantSelectorProps = {\r\n    value?: string;\r\n    onChange: (tenantId: string | undefined, tenantData?: Tenant) => void;\r\n    className?: string;\r\n    propertyId: string;\r\n    ownerId: string;\r\n    propertyAddress?: string;\r\n    propertyPrice?: number;\r\n};\r\n\r\nexport function TenantSelector({ value, onChange, className = \"\", _propertyId, ownerId, propertyAddress, propertyPrice }: TenantSelectorProps) {\r\n\r\n    const [searchQuery, setSearchQuery] = useState(\"\");\r\n    const [tenants, setTenants] = useState<Tenant[]>([]);\r\n    const [selectedTenant, setSelectedTenant] = useState<Tenant | null>(null);\r\n    const [isSearching, setIsSearching] = useState(false);\r\n\r\n    // Recherche de locataires\r\n    const handleSearch = useCallback(async (query: string) => {\r\n        setIsSearching(true);\r\n        const result = await searchTenants(query);\r\n        setTenants(result.owners);\r\n        setIsSearching(false);\r\n    }, []);\r\n\r\n    // Initial load\r\n    useEffect(() => {\r\n        handleSearch(\"\");\r\n    }, [handleSearch]);\r\n\r\n    // Debounce de la recherche\r\n    useEffect(() => {\r\n        const timer = setTimeout(() => {\r\n            if (searchQuery) handleSearch(searchQuery);\r\n            else handleSearch(\"\");\r\n        }, 300);\r\n        return () => clearTimeout(timer);\r\n    }, [searchQuery, handleSearch]);\r\n\r\n    // S√©lection d'un locataire\r\n    const handleSelect = (tenant: Tenant) => {\r\n        setSelectedTenant(tenant);\r\n        onChange(tenant.id, tenant);\r\n\r\n        setSearchQuery(\"\");\r\n    };\r\n\r\n    // Retirer le locataire s√©lectionn√©\r\n    const handleClear = () => {\r\n        setSelectedTenant(null);\r\n        onChange(undefined);\r\n    };\r\n\r\n    return (\r\n        <div className={`relative ${className}`}>\r\n            <label className=\"block text-sm font-medium text-foreground mb-2\">\r\n                Locataire\r\n            </label>\r\n\r\n            {/* Locataire s√©lectionn√© */}\r\n            {selectedTenant ? (\r\n                <div className=\"flex items-center justify-between bg-muted border border-border rounded-lg p-3\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-10 h-10 rounded-full bg-background flex items-center justify-center\">\r\n                            <User className=\"w-5 h-5 text-muted-foreground\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"font-medium text-foreground\">{selectedTenant.full_name}</p>\r\n                            <p className=\"text-sm text-muted-foreground\">{selectedTenant.phone}</p>\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        type=\"button\"\r\n                        onClick={handleClear}\r\n                        className=\"p-2 hover:bg-background/50 rounded-lg transition-colors\"\r\n                    >\r\n                        <X className=\"w-4 h-4 text-muted-foreground\" />\r\n                    </button>\r\n                </div>\r\n            ) : (\r\n                <div className=\"bg-background border border-border rounded-lg overflow-hidden\">\r\n                    {/* Inline Search Header */}\r\n                    <div className=\"mt-1 relative px-3 pt-3 pb-2 border-b border-border/50\">\r\n                        <Search className=\"absolute left-6 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                            placeholder=\"Rechercher par nom ou t√©l√©phone...\"\r\n                            className=\"w-full bg-muted/30 border border-input rounded-md pl-9 pr-4 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary transition-all\"\r\n                            autoFocus\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Inline List */}\r\n                    <div className=\"max-h-[200px] overflow-y-auto p-2 space-y-1\">\r\n                        {isSearching ? (\r\n                            <div className=\"text-center py-4 text-muted-foreground text-sm\">Recherche...</div>\r\n                        ) : tenants.length > 0 ? (\r\n                            tenants.map((tenant) => (\r\n                                <button\r\n                                    key={tenant.id}\r\n                                    type=\"button\"\r\n                                    onClick={() => handleSelect(tenant)}\r\n                                    className=\"w-full flex items-center gap-3 p-2 rounded-md hover:bg-muted transition-colors text-left group\"\r\n                                >\r\n                                    <div className=\"w-8 h-8 rounded-full bg-muted flex items-center justify-center group-hover:bg-background transition-colors shadow-sm\">\r\n                                        <User className=\"w-4 h-4 text-muted-foreground\" />\r\n                                    </div>\r\n                                    <div className=\"flex-1 min-w-0\">\r\n                                        <p className=\"text-sm font-medium text-foreground group-hover:text-primary truncate transition-colors\">{tenant.full_name}</p>\r\n                                        <div className=\"flex items-center gap-3 text-xs text-muted-foreground\">\r\n                                            {tenant.phone && (\r\n                                                <span className=\"flex items-center gap-1\">\r\n                                                    <Phone className=\"w-3 h-3\" /> {tenant.phone}\r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                    {value === tenant.id && (\r\n                                        <Check className=\"w-4 h-4 text-primary\" />\r\n                                    )}\r\n                                </button>\r\n                            ))\r\n                        ) : (\r\n                            <div className=\"text-center py-6 text-muted-foreground text-sm\">\r\n                                {searchQuery ? \"Aucun locataire trouv√©\" : \"Aucun locataire enregistr√©\"}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Footer with Create Button */}\r\n                    <div className=\"p-2 border-t border-border bg-muted/30\">\r\n                        <AddTenantButton\r\n                            ownerId={ownerId}\r\n                            initialData={{\r\n                                address: propertyAddress,\r\n                                amount: propertyPrice\r\n                            }}\r\n                            trigger={\r\n                                <button\r\n                                    type=\"button\"\r\n                                    className=\"w-full flex items-center justify-center gap-2 px-3 py-2 border border-dashed border-input rounded-md text-muted-foreground hover:border-primary hover:text-primary hover:bg-background/50 transition-all text-sm font-medium\"\r\n                                >\r\n                                    <Plus className=\"w-4 h-4\" />\r\n                                    Cr√©er un nouveau locataire\r\n                                </button>\r\n                            }\r\n                        />\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\UpgradeCTA.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\UpgradeModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\BiensTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\ComptabiliteTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\ConfigTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\DocumentsTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\EquipeTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\EtatsLieuxTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\InterventionsTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\LegalTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\gestion\\tours\\MessagesTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\home\\HomeTour.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\home\\SocialProof.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\home\\SocialProof.tsx:17:7\n  15 |   useEffect(() => {\n  16 |     if (inView) {\n> 17 |       setStartCount(true);\n     |       ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  18 |     }\n  19 |   }, [inView]);\n  20 |","line":17,"column":7,"nodeType":null,"endLine":17,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport CountUp from \"react-countup\";\nimport { useInView } from \"react-intersection-observer\";\n\nexport default function SocialProof() {\n  const { ref, inView } = useInView({\n    threshold: 0.3,\n    triggerOnce: true,\n  });\n\n  const [startCount, setStartCount] = useState(false);\n\n  useEffect(() => {\n    if (inView) {\n      setStartCount(true);\n    }\n  }, [inView]);\n\n  const stats = [\n    {\n      value: 350000000,\n      suffix: \" FCFA\",\n      label: \"de loyers s√©curis√©s ce mois\",\n      format: true,\n    },\n    {\n      value: 1250,\n      suffix: \"+\",\n      label: \"propri√©t√©s g√©r√©es\",\n      format: false,\n    },\n    {\n      value: 98,\n      suffix: \"%\",\n      label: \"de satisfaction client\",\n      format: false,\n    },\n  ];\n\n  return (\n    <div ref={ref} className=\"py-16 bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl border border-amber-500/20 shadow-2xl\">\n      <div className=\"max-w-6xl mx-auto px-6\">\n        <div className=\"text-center mb-12\">\n          <span className=\"text-amber-500 font-bold tracking-widest uppercase text-sm\">\n            R√©sultats Concrets\n          </span>\n          <h2 className=\"text-4xl md:text-5xl font-bold text-white mt-4\">\n            Des chiffres qui parlent\n          </h2>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-8\">\n          {stats.map((stat, index) => (\n            <div\n              key={index}\n              className=\"text-center p-6 rounded-2xl bg-white/5 backdrop-blur-sm border border-white/10 hover:border-amber-500/50 transition-all duration-300\"\n            >\n              <div className=\"text-5xl md:text-6xl font-bold bg-gradient-to-br from-amber-500 to-yellow-600 bg-clip-text text-transparent mb-4\">\n                {startCount ? (\n                  <CountUp\n                    end={stat.value}\n                    duration={2.5}\n                    separator=\" \"\n                    suffix={stat.suffix}\n                  />\n                ) : (\n                  \"0\"\n                )}\n              </div>\n              <p className=\"text-slate-300 text-lg\">{stat.label}</p>\n            </div>\n          ))}\n        </div>\n\n        <div className=\"mt-12 text-center\">\n          <p className=\"text-slate-400 italic\">\n            Mis √† jour en temps r√©el ‚Ä¢ Donn√©es certifi√©es\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\CompareSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\ComparisonTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\DousellNavbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\DousellNavbarClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\FeaturesBento.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\HeroIllustration.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\HeroOwnerIllustration.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\Landing3DOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\MagicTransformation.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\MagicTransformation.tsx:27:7\n  25 |     // On mobile, skip the animation loop entirely for performance\n  26 |     if (isMobile) {\n> 27 |       setDisplayedText(fullText);\n     |       ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  28 |       return;\n  29 |     }\n  30 |","line":27,"column":7,"nodeType":null,"endLine":27,"endColumn":23},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":155,"column":19,"nodeType":"JSXOpeningElement","endLine":159,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { motion } from \"framer-motion\";\nimport { Sparkles, Upload, Home, Ruler, Wand2, ArrowRight } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nexport default function MagicTransformation() {\n  const [isFlipped, setIsFlipped] = useState(false);\n  const [displayedText, setDisplayedText] = useState(\"\");\n\n  const fullText = \"Saisissez vos donn√©es une fois. Sublimez vos biens partout.\";\n\n  // Check if we're on mobile to disable performance-heavy animation\n  const [isMobile, setIsMobile] = useState(false);\n\n  useEffect(() => {\n    const checkMobile = () => setIsMobile(window.innerWidth < 768);\n    checkMobile();\n    window.addEventListener('resize', checkMobile);\n    return () => window.removeEventListener('resize', checkMobile);\n  }, []);\n\n  useEffect(() => {\n    // On mobile, skip the animation loop entirely for performance\n    if (isMobile) {\n      setDisplayedText(fullText);\n      return;\n    }\n\n    const typeSpeed = 50; // Vitesse de saisie (ms)\n    const pauseBeforeRestart = 2000; // Pause avant de recommencer (ms)\n\n    let timeout: NodeJS.Timeout;\n\n    if (displayedText === fullText) {\n      // Texte complet - pause puis recommencer\n      timeout = setTimeout(() => setDisplayedText(\"\"), pauseBeforeRestart);\n    } else {\n      // Saisie en cours\n      timeout = setTimeout(() => {\n        setDisplayedText(fullText.substring(0, displayedText.length + 1));\n      }, typeSpeed);\n    }\n\n    return () => clearTimeout(timeout);\n  }, [displayedText, fullText, isMobile]);\n\n  const handleFlip = () => {\n    setIsFlipped(!isFlipped);\n  };\n\n  return (\n    <section className=\"py-4 bg-zinc-950 overflow-hidden relative\">\n      {/* Background Glow */}\n      <div className=\"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-[#F4C430]/5 rounded-full blur-[120px]\" />\n\n      <div className=\"container mx-auto px-4 relative z-10\">\n        {/* Header */}\n        <div className=\"text-center mb-10\">\n          <span className=\"inline-block text-[#F4C430] text-sm font-medium tracking-widest uppercase mb-4\">\n            De la donn√©e √† la vitrine\n          </span>\n          <h2 className=\"font-display text-[clamp(1.875rem,5vw,3.75rem)] text-white mb-6\">\n            Remplissez un formulaire,<br />\n            <span className=\"gradient-text-animated\">obtenez une annonce premium</span>\n          </h2>\n          <p className=\"text-gray-400 text-lg max-w-2xl mx-auto\">\n            <span>{displayedText}</span>\n            <span className=\"animate-pulse text-[#F4C430]\">|</span>\n          </p>\n        </div>\n\n        {/* Card Container */}\n        <div className=\"w-full max-w-4xl mx-auto p-4 perspective-1000 mt-8 md:-mt-20\">\n          <div className=\"relative h-[450px] md:h-[520px] w-full\">\n\n            {/* CONTENEUR ANIM√â (La carte qui tourne) */}\n            <motion.div\n              className=\"w-full h-full relative preserve-3d\"\n              animate={{ rotateY: isFlipped ? 180 : 0 }}\n              transition={{\n                duration: 0.8,\n                type: \"spring\",\n                stiffness: 260,\n                damping: 20,\n              }}\n              style={{ transformStyle: \"preserve-3d\" }}\n            >\n\n              {/* ========================================================\n                  FACE 1 : C√îT√â ADMIN (SAISIE)\n                 ======================================================== */}\n              <div className=\"absolute inset-0 backface-hidden\">\n                <div className=\"h-full w-full bg-[#0a0a0a] border border-white/10 rounded-2xl p-4 md:p-8 flex flex-col gap-4 md:gap-6 shadow-2xl relative overflow-hidden\">\n\n                  {/* En-t√™te style \"Code\" */}\n                  <div className=\"flex gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-red-500/20\" />\n                    <div className=\"w-3 h-3 rounded-full bg-yellow-500/20\" />\n                    <div className=\"w-3 h-3 rounded-full bg-green-500/20\" />\n                    <span className=\"ml-4 text-xs font-mono text-slate-500\">app.dousell.immo/add-property</span>\n                  </div>\n\n                  {/* Formulaire simul√© */}\n                  <div className=\"space-y-4 font-mono text-sm\">\n                    <div>\n                      <label className=\"text-slate-500 block mb-1.5\">Titre de l&apos;annonce</label>\n                      <div className=\"bg-white/5 border border-white/10 rounded-md p-3 text-white\">\n                        Villa Saly Portudal\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4 items-end\">\n                      <div className=\"flex flex-col h-full\">\n                        <label className=\"text-slate-500 block mb-1.5 text-xs md:text-sm\">Prix / Mois (FCFA)</label>\n                        <div className=\"bg-white/5 border border-white/10 rounded-md p-3 text-white mt-auto\">\n                          1.500.000\n                        </div>\n                      </div>\n                      <div className=\"flex flex-col h-full\">\n                        <label className=\"text-slate-500 block mb-1.5 text-xs md:text-sm\">Surface (m2)</label>\n                        <div className=\"bg-white/5 border border-white/10 rounded-md p-3 text-white mt-auto\">\n                          350\n                        </div>\n                      </div>\n                    </div>\n\n                    <div>\n                      <label className=\"text-slate-500 block mb-1.5\">Photos (Upload)</label>\n                      <div className=\"border-2 border-dashed border-white/10 rounded-lg p-8 flex flex-col items-center text-center justify-center text-slate-500 bg-white/5\">\n                        <Upload className=\"w-8 h-8 mb-2 opacity-50\" />\n                        <span>Glisser-d√©poser les fichiers</span>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Badge Admin en bas √† droite */}\n                  <div className=\"absolute bottom-4 right-4 bg-white/10 px-3 py-1 rounded-full text-xs text-white/50 font-mono\">\n                    Vue Admin\n                  </div>\n                </div>\n              </div>\n\n              {/* ========================================================\n                  FACE 2 : C√îT√â CLIENT (VITRINE)\n                  (Rotation 180deg pour √™tre visible au dos)\n                 ======================================================== */}\n              <div\n                className=\"absolute inset-0 backface-hidden rounded-2xl overflow-hidden shadow-2xl shadow-[#F4C430]/20 border border-[#F4C430]/30\"\n                style={{ transform: \"rotateY(180deg)\" }}\n              >\n                {/* Image de fond (La Villa) */}\n                <div className=\"absolute inset-0\">\n                  <img\n                    src=\"https://images.unsplash.com/photo-1613490493576-7fde63acd811?q=80&w=1600&auto=format&fit=crop\"\n                    alt=\"Villa Saly\"\n                    className=\"w-full h-full object-cover\"\n                  />\n                  <div className=\"absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent\" />\n                </div>\n\n                {/* Contenu de la carte Vitrine */}\n                <div className=\"absolute bottom-0 left-0 right-0 p-4 md:p-8\">\n                  <div className=\"flex flex-col md:flex-row md:justify-between md:items-start gap-1 md:gap-0 mb-2\">\n                    <h3 className=\"text-xl md:text-3xl font-bold text-white\">Villa Saly Portudal</h3>\n                    <span className=\"bg-black/60 backdrop-blur-md text-[#F4C430] px-2 py-0.5 md:px-3 md:py-1 rounded-full font-bold border border-[#F4C430]/30 text-xs md:text-sm w-fit\">\n                      √Ä Louer\n                    </span>\n                  </div>\n\n                  <p className=\"text-slate-300 mb-3 md:mb-6 flex items-center gap-1 md:gap-2 text-sm md:text-base\">\n                    <Home size={14} className=\"md:hidden\" /><Home size={16} className=\"hidden md:block\" /> Saly, S√©n√©gal ‚Ä¢ <Ruler size={14} className=\"md:hidden\" /><Ruler size={16} className=\"hidden md:block\" /> 350 m¬≤\n                  </p>\n\n                  <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-2 md:gap-0\">\n                    <div className=\"flex flex-wrap gap-1 md:gap-2\">\n                      {[\"4 Ch.\", \"Piscine\", \"Meubl√©\"].map(tag => (\n                        <span key={tag} className=\"text-[10px] md:text-xs bg-white/10 backdrop-blur text-white px-1.5 py-0.5 md:px-2 md:py-1 rounded-md border border-white/10\">\n                          {tag}\n                        </span>\n                      ))}\n                    </div>\n                    <div className=\"text-left md:text-right\">\n                      <span className=\"text-xl md:text-2xl font-bold text-[#F4C430]\">1.5M</span>\n                      <span className=\"text-xs md:text-sm text-slate-400\"> /mois</span>\n                    </div>\n                  </div>\n\n                  <button className=\"w-full mt-3 md:mt-6 bg-white text-black font-bold py-2 md:py-3 rounded-full hover:bg-slate-200 transition-colors flex items-center justify-center gap-2 text-sm md:text-base\">\n                    Demander une visite <ArrowRight size={14} className=\"md:hidden\" /><ArrowRight size={16} className=\"hidden md:block\" />\n                  </button>\n                </div>\n\n                {/* Glow Effect Dor√© autour de la carte */}\n                <div className=\"absolute inset-0 border-2 border-[#F4C430]/50 rounded-2xl pointer-events-none shadow-[inset_0_0_50px_rgba(244,196,48,0.2)]\" />\n              </div>\n\n            </motion.div>\n          </div>\n\n          {/* ========================================================\n              LE BOUTON MAGIQUE (TRIGGER) - Style MagicSection\n             ======================================================== */}\n          <div className=\"flex flex-col items-center justify-center gap-3 mt-4\">\n            <motion.button\n              onClick={handleFlip}\n              whileHover={{ scale: 1.08 }}\n              whileTap={{ scale: 0.95 }}\n              className=\"relative group cursor-pointer\"\n            >\n              {/* √âtoiles orbitales autour du bouton */}\n              <div className=\"absolute inset-0 w-20 h-20 -top-3 -left-3\">\n                {/* √âtoile 1 - orbite rapide */}\n                <div\n                  className=\"absolute w-2 h-2 transition-all duration-300 group-hover:scale-150\"\n                  style={{\n                    animation: 'orbit 3s linear infinite',\n                    top: '50%',\n                    left: '50%',\n                  }}\n                >\n                  <svg viewBox=\"0 0 24 24\" fill=\"#F4C430\" className=\"w-full h-full drop-shadow-[0_0_4px_rgba(244,196,48,0.8)]\">\n                    <path d=\"M12 0L14.59 8.41L23 11L14.59 13.59L12 22L9.41 13.59L1 11L9.41 8.41L12 0Z\" />\n                  </svg>\n                </div>\n\n                {/* √âtoile 2 - orbite moyenne */}\n                <div\n                  className=\"absolute w-1.5 h-1.5 transition-all duration-300 group-hover:scale-150\"\n                  style={{\n                    animation: 'orbit 4s linear infinite reverse',\n                    animationDelay: '-1s',\n                    top: '50%',\n                    left: '50%',\n                  }}\n                >\n                  <svg viewBox=\"0 0 24 24\" fill=\"#FFD700\" className=\"w-full h-full drop-shadow-[0_0_3px_rgba(255,215,0,0.8)]\">\n                    <path d=\"M12 0L14.59 8.41L23 11L14.59 13.59L12 22L9.41 13.59L1 11L9.41 8.41L12 0Z\" />\n                  </svg>\n                </div>\n\n                {/* √âtoile 3 - petite orbite */}\n                <div\n                  className=\"absolute w-1 h-1 transition-all duration-300 group-hover:scale-200\"\n                  style={{\n                    animation: 'orbit-small 2.5s linear infinite',\n                    animationDelay: '-0.5s',\n                    top: '50%',\n                    left: '50%',\n                  }}\n                >\n                  <svg viewBox=\"0 0 24 24\" fill=\"#FFFFFF\" className=\"w-full h-full drop-shadow-[0_0_2px_rgba(255,255,255,0.8)]\">\n                    <path d=\"M12 0L14.59 8.41L23 11L14.59 13.59L12 22L9.41 13.59L1 11L9.41 8.41L12 0Z\" />\n                  </svg>\n                </div>\n\n                {/* √âtoile 4 - hover reveal */}\n                <div\n                  className=\"absolute w-1.5 h-1.5 opacity-0 group-hover:opacity-100 transition-all duration-500\"\n                  style={{\n                    animation: 'orbit 5s linear infinite',\n                    animationDelay: '-2s',\n                    top: '50%',\n                    left: '50%',\n                  }}\n                >\n                  <svg viewBox=\"0 0 24 24\" fill=\"#F4C430\" className=\"w-full h-full drop-shadow-[0_0_4px_rgba(244,196,48,0.9)]\">\n                    <path d=\"M12 0L14.59 8.41L23 11L14.59 13.59L12 22L9.41 13.59L1 11L9.41 8.41L12 0Z\" />\n                  </svg>\n                </div>\n              </div>\n\n              {/* Glow pulsant - plus intense au hover */}\n              <div className={cn(\n                \"absolute inset-0 bg-[#F4C430] blur-xl transition-all duration-500\",\n                isFlipped ? \"opacity-50 scale-125\" : \"opacity-20 animate-pulse group-hover:opacity-40 group-hover:scale-110\"\n              )} />\n\n              {/* Cercle externe anim√© (ring) */}\n              <div className={cn(\n                \"absolute -inset-1 rounded-full border-2 border-[#F4C430]/30 transition-all duration-500\",\n                \"group-hover:border-[#F4C430]/60 group-hover:scale-110\",\n                isFlipped && \"border-[#F4C430]/60 scale-110 animate-ping\"\n              )} style={{ animationDuration: '2s' }} />\n\n              {/* Cercle principal */}\n              <div className={cn(\n                \"relative w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-all duration-500\",\n                \"border-2\",\n                isFlipped\n                  ? \"bg-[#F4C430] border-[#F4C430] shadow-[0_0_30px_rgba(244,196,48,0.6)] scale-110\"\n                  : \"bg-zinc-900 border-[#F4C430]/60 group-hover:border-[#F4C430] group-hover:shadow-[0_0_20px_rgba(244,196,48,0.4)]\"\n              )}>\n                {isFlipped ? (\n                  <Sparkles className=\"w-6 h-6 text-black\" style={{ animation: 'spin 3s linear infinite' }} />\n                ) : (\n                  <Wand2 className=\"w-6 h-6 text-[#F4C430] group-hover:rotate-12 group-hover:scale-110 transition-all duration-300\" />\n                )}\n              </div>\n\n              {/* Particules √©clatantes lors du flip */}\n              {isFlipped && (\n                <>\n                  <div className=\"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-[#F4C430] rounded-full animate-ping\" style={{ animationDuration: '1s' }} />\n                  <div className=\"absolute -top-2 -right-2 w-2 h-2 bg-[#F4C430] rounded-full animate-bounce\" />\n                  <div className=\"absolute -bottom-2 -left-2 w-2 h-2 bg-yellow-300 rounded-full animate-bounce\" style={{ animationDelay: '0.15s' }} />\n                  <div className=\"absolute -top-2 -left-2 w-1.5 h-1.5 bg-white rounded-full animate-bounce\" style={{ animationDelay: '0.3s' }} />\n                  <div className=\"absolute -bottom-2 -right-2 w-1.5 h-1.5 bg-[#FFD700] rounded-full animate-bounce\" style={{ animationDelay: '0.25s' }} />\n                </>\n              )}\n\n              {/* CSS pour les animations d'orbite */}\n              <style jsx>{`\n                @keyframes orbit {\n                  from {\n                    transform: rotate(0deg) translateX(32px) rotate(0deg);\n                  }\n                  to {\n                    transform: rotate(360deg) translateX(32px) rotate(-360deg);\n                  }\n                }\n                @keyframes orbit-small {\n                  from {\n                    transform: rotate(0deg) translateX(24px) rotate(0deg);\n                  }\n                  to {\n                    transform: rotate(360deg) translateX(24px) rotate(-360deg);\n                  }\n                }\n              `}</style>\n            </motion.button>\n\n            {/* Label */}\n            <span className={cn(\n              \"text-xs font-medium transition-all duration-300 mt-2\",\n              isFlipped ? \"text-[#F4C430]\" : \"text-zinc-500 group-hover:text-zinc-300\"\n            )}>\n              {isFlipped ? \"Magie op√©r√©e\" : \"Cliquez pour transformer\"}\n            </span>\n\n            {/* Subtitle / Callout - Styled like the main H2 title */}\n            <motion.h3\n\n              className=\"mt-8 font-display text-2xl md:text-3xl lg:text-4xl text-white text-center max-w-3xl mx-auto leading-tight\"\n            >\n              B√©n√©ficiez d&apos;une vitrine visible sur Google. <br className=\"hidden md:block\" />\n              <span className=\"text-[#F4C430]\">Recevez des demandes de visite qualifi√©es.</span>\n            </motion.h3>\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\PricingCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\PricingSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\VideoTestimonials.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\sections\\cta-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\sections\\faq-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\sections\\features-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\sections\\hero-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\sections\\pricing-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\sections\\testimonials-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\FeaturedProperties.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\FeaturedPropertiesHero.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\PropertyCategories.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\SearchDropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\TenantBentoGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\TenantHeroSearch.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\TenantHeroSearch.tsx:46:13\n  44 |     useEffect(() => {\n  45 |         if (debouncedLocation && debouncedLocation.length >= 2) {\n> 46 |             setIsLoadingSuggestions(true);\n     |             ^^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  47 |             getSearchSuggestions(debouncedLocation)\n  48 |                 .then((results) => {\n  49 |                     setSuggestions(results);","line":46,"column":13,"nodeType":null,"endLine":46,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Search, MapPin, Home, Banknote, Loader2 } from \"lucide-react\";\nimport { useRouter } from \"next/navigation\";\nimport SearchDropdown from \"./SearchDropdown\";\nimport { getSearchSuggestions } from \"@/services/propertyService\";\nimport { useDebounce } from \"@/hooks/use-debounce\";\n\nconst typeOptions = [\n    { value: \"appartement\", label: \"Appartement\" },\n    { value: \"villa\", label: \"Villa\" },\n    { value: \"studio\", label: \"Studio\" },\n    { value: \"terrain\", label: \"Terrain\" },\n    { value: \"lofts\", label: \"Lofts\" },\n];\n\nconst budgetOptions = [\n    { value: \"100000\", label: \"100k FCFA\" },\n    { value: \"250000\", label: \"250k FCFA\" },\n    { value: \"500000\", label: \"500k FCFA\" },\n    { value: \"1000000\", label: \"1M+ FCFA\" },\n    { value: \"2000000\", label: \"2M+ FCFA\" },\n];\n\nexport default function TenantHeroSearch() {\n    const router = useRouter();\n    const [location, setLocation] = useState(\"\");\n    const [type, setType] = useState(\"\");\n    const [budget, setBudget] = useState(\"\");\n\n    // Autocomplete state\n    const [suggestions, setSuggestions] = useState<string[]>([]);\n    const [showSuggestions, setShowSuggestions] = useState(false);\n    const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);\n    const [selectedIndex, setSelectedIndex] = useState(-1);\n    const inputRef = useRef<HTMLInputElement>(null);\n\n    // Debounce the search query\n    const debouncedLocation = useDebounce(location, 300);\n\n    // Fetch suggestions when debounced location changes\n    useEffect(() => {\n        if (debouncedLocation && debouncedLocation.length >= 2) {\n            setIsLoadingSuggestions(true);\n            getSearchSuggestions(debouncedLocation)\n                .then((results) => {\n                    setSuggestions(results);\n                    setSelectedIndex(-1);\n                })\n                .finally(() => setIsLoadingSuggestions(false));\n        } else {\n            setSuggestions([]);\n        }\n    }, [debouncedLocation]);\n\n    const handleSearch = () => {\n        const params = new URLSearchParams();\n        if (location) params.append(\"q\", location);\n        if (type) params.append(\"type\", type);\n        if (budget) params.append(\"maxPrice\", budget);\n        router.push(`/recherche?${params.toString()}`);\n    };\n\n    const handleSelectSuggestion = (suggestion: string) => {\n        setLocation(suggestion);\n        setShowSuggestions(false);\n        setSuggestions([]);\n    };\n\n    const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n        if (!showSuggestions || suggestions.length === 0) return;\n\n        switch (e.key) {\n            case \"ArrowDown\":\n                e.preventDefault();\n                setSelectedIndex((prev) =>\n                    prev < suggestions.length - 1 ? prev + 1 : prev\n                );\n                break;\n            case \"ArrowUp\":\n                e.preventDefault();\n                setSelectedIndex((prev) => (prev > 0 ? prev - 1 : -1));\n                break;\n            case \"Enter\":\n                if (selectedIndex >= 0 && suggestions[selectedIndex]) {\n                    e.preventDefault();\n                    handleSelectSuggestion(suggestions[selectedIndex]);\n                } else {\n                    handleSearch();\n                }\n                break;\n            case \"Escape\":\n                setShowSuggestions(false);\n                break;\n        }\n    };\n\n    return (\n        <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.5, delay: 0.2 }}\n            className=\"w-full max-w-4xl mx-auto mt-4 md:mt-8 relative z-20\"\n        >\n            {/* Container Principal */}\n            <form\n                onSubmit={(e) => {\n                    e.preventDefault();\n                    handleSearch();\n                }}\n                className=\"bg-zinc-900/80 backdrop-blur-xl border border-white/10 p-1.5 rounded-2xl md:rounded-full flex flex-col md:flex-row shadow-2xl ring-1 ring-white/5 overflow-visible\"\n            >\n\n                {/* Localisation avec Autocomplete */}\n                <div className=\"flex-1 relative group border-b md:border-b-0 md:border-r border-white/5\">\n                    <div className=\"absolute inset-y-0 left-4 flex items-center pointer-events-none z-10\">\n                        {isLoadingSuggestions ? (\n                            <Loader2 className=\"w-4 h-4 md:w-5 md:h-5 text-[#F4C430] animate-spin\" />\n                        ) : (\n                            <MapPin className=\"w-4 h-4 md:w-5 md:h-5 text-[#F4C430]\" />\n                        )}\n                    </div>\n                    <input\n                        ref={inputRef}\n                        type=\"search\"\n                        enterKeyHint=\"search\"\n                        placeholder=\"Ville, Quartier...\"\n                        className=\"w-full h-12 md:h-16 pl-10 md:pl-14 pr-4 bg-transparent border-none text-white text-sm md:text-base placeholder-gray-400 focus:ring-0 transition-all font-medium rounded-full outline-none\"\n                        value={location}\n                        onChange={(e) => {\n                            setLocation(e.target.value);\n                            setShowSuggestions(true);\n                        }}\n                        onFocus={() => setShowSuggestions(true)}\n                        onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}\n                        onKeyDown={handleKeyDown}\n                        autoComplete=\"off\"\n                    />\n\n                    {/* Suggestions Dropdown */}\n                    <AnimatePresence>\n                        {showSuggestions && (suggestions.length > 0 || isLoadingSuggestions) && (\n                            <motion.div\n                                initial={{ opacity: 0, y: -10, scale: 0.95 }}\n                                animate={{ opacity: 1, y: 0, scale: 1 }}\n                                exit={{ opacity: 0, y: -10, scale: 0.95 }}\n                                transition={{ type: \"spring\", stiffness: 300, damping: 25 }}\n                                className=\"absolute top-full left-0 right-0 mt-2 z-50 rounded-2xl border border-white/10 bg-black/95 backdrop-blur-xl shadow-2xl shadow-black/50 overflow-hidden\"\n                            >\n                                {isLoadingSuggestions && suggestions.length === 0 ? (\n                                    <div className=\"flex items-center justify-center py-4 text-gray-400\">\n                                        <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                                        <span className=\"text-sm\">Recherche...</span>\n                                    </div>\n                                ) : (\n                                    <div className=\"p-2\">\n                                        {suggestions.map((suggestion, index) => (\n                                            <button\n                                                key={suggestion}\n                                                type=\"button\"\n                                                className={`w-full flex items-center gap-3 px-4 py-3 text-left text-sm rounded-xl transition-all cursor-pointer ${index === selectedIndex\n                                                    ? \"bg-[#F4C430] text-black font-semibold\"\n                                                    : \"text-gray-200 hover:bg-white/10 hover:text-white\"\n                                                    }`}\n                                                onMouseDown={(e) => {\n                                                    e.preventDefault();\n                                                    handleSelectSuggestion(suggestion);\n                                                }}\n                                                onMouseEnter={() => setSelectedIndex(index)}\n                                            >\n                                                <MapPin className={`h-4 w-4 shrink-0 ${index === selectedIndex ? \"text-black\" : \"text-[#F4C430]\"}`} />\n                                                <span className=\"truncate\">{suggestion}</span>\n                                            </button>\n                                        ))}\n                                    </div>\n                                )}\n                            </motion.div>\n                        )}\n                    </AnimatePresence>\n                </div>\n\n                {/* Type de bien - Custom Dropdown */}\n                <div className=\"flex-1 border-b md:border-b-0 md:border-r border-white/5 overflow-visible\">\n                    <SearchDropdown\n                        options={typeOptions}\n                        placeholder=\"Type de bien\"\n                        value={type}\n                        onValueChange={setType}\n                        icon={<Home className=\"w-4 h-4 md:w-5 md:h-5 text-[#F4C430]\" />}\n                    />\n                </div>\n\n                {/* Budget - Custom Dropdown */}\n                <div className=\"flex-1 hidden md:block border-r border-white/5 overflow-visible\">\n                    <SearchDropdown\n                        options={budgetOptions}\n                        placeholder=\"Budget Max\"\n                        value={budget}\n                        onValueChange={setBudget}\n                        icon={<Banknote className=\"w-5 h-5 text-[#F4C430]\" />}\n                    />\n                </div>\n\n                {/* Bouton Rechercher */}\n                <div className=\"p-1\">\n                    <button\n                        onClick={handleSearch}\n                        className=\"w-full md:w-14 h-11 md:h-14 bg-[#F4C430] hover:bg-[#ffde59] text-black rounded-xl md:rounded-full transition-all duration-300 shadow-[0_0_15px_rgba(244,196,48,0.3)] hover:shadow-[0_0_25px_rgba(244,196,48,0.5)] flex items-center justify-center group active:scale-[0.98]\"\n                        aria-label=\"Lancer la recherche\"\n                    >\n                        <Search className=\"w-5 h-5 md:w-6 md:h-6 transition-transform duration-300 group-hover:scale-110\" strokeWidth={2} />\n                    </button>\n                </div>\n            </form>\n        </motion.div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\TenantSteps.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\TenantTestimonials.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\landing\\tenant\\TrustSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\app-shell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\footer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\notification-bell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\scroll-to-top.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\layout\\user-nav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\maps\\location-picker-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":20,"column":43,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":20,"endColumn":61},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\maps\\location-picker-dialog.tsx:87:5\n  85 |\n  86 |   useEffect(() => {\n> 87 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  88 |   }, []);\n  89 |\n  90 |   useEffect(() => {","line":87,"column":5,"nodeType":null,"endLine":87,"endColumn":15},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\maps\\location-picker-dialog.tsx:92:7\n  90 |   useEffect(() => {\n  91 |     if (initialPosition) {\n> 92 |       setSelectedPosition([initialPosition.lat, initialPosition.lng]);\n     |       ^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  93 |     } else if (open && initialAddress && !initialPosition) {\n  94 |       // Si pas de position initiale mais une adresse, on essaie de g√©ocoder\n  95 |       const geocodeAddress = async () => {","line":92,"column":7,"nodeType":null,"endLine":92,"endColumn":26}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport \"leaflet/dist/leaflet.css\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { MapContainer, TileLayer, Marker, useMapEvents, useMap } from \"react-leaflet\";\nimport type { LatLngExpression } from \"leaflet\";\nimport { MapPin } from \"lucide-react\";\n\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\n\n// Import dynamique pour √©viter les erreurs SSR\nconst L = typeof window !== \"undefined\" ? require(\"leaflet\") : null;\n\n// Fix pour les ic√¥nes Leaflet avec Next.js\nif (typeof window !== \"undefined\" && L) {\n  delete (L.Icon.Default.prototype as Record<string, unknown>)._getIconUrl;\n  L.Icon.Default.mergeOptions({\n    iconRetinaUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png\",\n    iconUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png\",\n    shadowUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png\",\n  });\n}\n\n// Coordonn√©es de Dakar par d√©faut\nconst DAKAR_CENTER: LatLngExpression = [14.7167, -17.4677];\nconst DEFAULT_ZOOM = 12;\n\ninterface LocationPickerDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onLocationSelect: (lat: number, lng: number) => void;\n  initialPosition?: { lat: number; lng: number } | null;\n  initialAddress?: string;\n  isLoading?: boolean;\n}\n\n/**\n * Composant interne pour g√©rer les clics sur la carte\n */\nfunction MapClickHandler({\n  onMapClick,\n}: {\n  onMapClick: (lat: number, lng: number) => void;\n}) {\n  useMapEvents({\n    click: (e) => {\n      const { lat, lng } = e.latlng;\n      onMapClick(lat, lng);\n    },\n  });\n  return null;\n}\n\n/**\n * Composant interne pour centrer la carte sur une position\n */\nfunction MapCenter({ center, zoom }: { center: LatLngExpression; zoom: number }) {\n  const map = useMap();\n  useEffect(() => {\n    map.setView(center, zoom);\n  }, [map, center, zoom]);\n  return null;\n}\n\nexport function LocationPickerDialog({\n  open,\n  onOpenChange,\n  onLocationSelect,\n  initialPosition,\n  initialAddress,\n  isLoading = false,\n}: LocationPickerDialogProps) {\n  const [mounted, setMounted] = useState(false);\n  const [selectedPosition, setSelectedPosition] = useState<LatLngExpression>(\n    initialPosition ? [initialPosition.lat, initialPosition.lng] : DAKAR_CENTER\n  );\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  useEffect(() => {\n    if (initialPosition) {\n      setSelectedPosition([initialPosition.lat, initialPosition.lng]);\n    } else if (open && initialAddress && !initialPosition) {\n      // Si pas de position initiale mais une adresse, on essaie de g√©ocoder\n      const geocodeAddress = async () => {\n        try {\n          const response = await fetch(\n            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(\n              initialAddress\n            )}&limit=1`,\n            {\n              headers: {\n                \"User-Agent\": \"Doussel-Immo-App/1.0\",\n              },\n            }\n          );\n          if (response.ok) {\n            const data = await response.json();\n            if (data && data.length > 0) {\n              const lat = parseFloat(data[0].lat);\n              const lon = parseFloat(data[0].lon);\n              setSelectedPosition([lat, lon]);\n            }\n          }\n        } catch (error) {\n          console.warn(\"Geocoding failed for initial address:\", error);\n        }\n      };\n      geocodeAddress();\n    }\n  }, [initialPosition, initialAddress, open]);\n\n  const handleMapClick = useCallback((lat: number, lng: number) => {\n    setSelectedPosition([lat, lng]);\n  }, []);\n\n  const handleConfirm = useCallback(() => {\n    const [lat, lng] = selectedPosition as [number, number];\n    onLocationSelect(lat, lng);\n    // On ne ferme plus le dialog ici, c'est le parent qui le fera apr√®s le chargement\n    // onOpenChange(false); \n  }, [selectedPosition, onLocationSelect]);\n\n  if (!mounted) {\n    return null;\n  }\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-4xl w-[95vw] h-[85vh] flex flex-col p-0 gap-0 bg-[#0b0f18] border-white/10\">\n        <DialogHeader className=\"px-6 pt-6 pb-4\">\n          <DialogTitle className=\"text-white text-xl font-semibold\">\n            Choisir la localisation sur la carte\n          </DialogTitle>\n          <DialogDescription className=\"text-white/70\">\n            Cliquez sur la carte pour placer le marqueur, puis confirmez votre choix\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"flex-1 relative min-h-0\">\n          {mounted && (\n            <MapContainer\n              center={selectedPosition}\n              zoom={DEFAULT_ZOOM}\n              scrollWheelZoom={true}\n              className=\"h-full w-full z-0\"\n              zoomControl={true}\n              attributionControl={true}\n            >\n              <TileLayer\n                url=\"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png\"\n                attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors &copy; <a href=\"https://carto.com/attributions\">CARTO</a>'\n                subdomains=\"abcd\"\n                maxZoom={19}\n              />\n              <MapCenter center={selectedPosition} zoom={DEFAULT_ZOOM} />\n              <MapClickHandler onMapClick={handleMapClick} />\n              <Marker position={selectedPosition} />\n            </MapContainer>\n          )}\n        </div>\n\n        <div className=\"px-6 py-4 border-t border-white/10 flex items-center justify-between\">\n          <div className=\"flex items-center gap-2 text-white/70 text-sm\">\n            <MapPin className=\"h-4 w-4\" />\n            <span>\n              {Array.isArray(selectedPosition) &&\n                typeof selectedPosition[0] === \"number\" &&\n                typeof selectedPosition[1] === \"number\"\n                ? `${selectedPosition[0].toFixed(6)}, ${selectedPosition[1].toFixed(6)}`\n                : \"Position non d√©finie\"}\n            </span>\n          </div>\n          <div className=\"flex gap-3\">\n            <Button\n              type=\"button\"\n              variant=\"secondary\"\n              onClick={() => onOpenChange(false)}\n              className=\"bg-white/5 text-white border-white/10 hover:bg-white/10\"\n            >\n              Annuler\n            </Button>\n            <Button\n              type=\"button\"\n              onClick={handleConfirm}\n              disabled={isLoading}\n              className=\"bg-amber-500 text-black hover:bg-amber-400\"\n            >\n              {isLoading ? (\n                <>\n                  <span className=\"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-black border-t-transparent\" />\n                  Chargement...\n                </>\n              ) : (\n                \"Confirmer la position\"\n              )}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\modals\\AccessRequestModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":78,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2225,2228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2225,2228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\n/**\r\n * AccessRequestModal - Modal pour demander un acc√®s temporaire\r\n *\r\n * Utilis√© quand un utilisateur n'a pas la permission n√©cessaire\r\n * pour effectuer une action mais peut demander un acc√®s temporaire.\r\n */\r\n\r\nimport { useState } from \"react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { LockKey, Check, X, ClockCounterClockwise } from \"@phosphor-icons/react\";\r\nimport { submitAccessRequest } from \"@/app/(workspace)/gestion/access-control/actions\";\r\nimport type { TeamPermissionKey } from \"@/lib/team-permissions\";\r\n\r\ninterface AccessRequestModalProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  teamId: string;\r\n  permission: TeamPermissionKey;\r\n  permissionLabel?: string;\r\n  permissionDescription?: string;\r\n}\r\n\r\n/**\r\n * Modal pour demander un acc√®s temporaire √† une fonctionnalit√©\r\n */\r\nexport function AccessRequestModal({\r\n  open,\r\n  onOpenChange,\r\n  teamId,\r\n  permission,\r\n  permissionLabel,\r\n  permissionDescription,\r\n}: AccessRequestModalProps) {\r\n  const [reason, setReason] = useState(\"\");\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [status, setStatus] = useState<'idle' | 'success' | 'error'>('idle');\r\n  const [errorMessage, setErrorMessage] = useState(\"\");\r\n\r\n  const handleSubmit = async () => {\r\n    if (!reason.trim()) {\r\n      setErrorMessage(\"Veuillez indiquer une raison pour cette demande\");\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n    setErrorMessage(\"\");\r\n\r\n    try {\r\n      const { data: result, error } = await submitAccessRequest({\r\n        teamId,\r\n        permission,\r\n        reason: reason.trim(),\r\n      });\r\n\r\n      if (result?.success) {\r\n        setStatus('success');\r\n        setTimeout(() => {\r\n          onOpenChange(false);\r\n          setReason(\"\");\r\n          setStatus('idle');\r\n        }, 2000);\r\n      } else {\r\n        setStatus('error');\r\n        setErrorMessage(error || \"Erreur lors de la demande\");\r\n      }\r\n    } catch (error: any) {\r\n      setStatus('error');\r\n      setErrorMessage(error.message || \"Erreur inattendue\");\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const handleClose = () => {\r\n    if (!isSubmitting && status !== 'success') {\r\n      onOpenChange(false);\r\n      setReason(\"\");\r\n      setStatus('idle');\r\n      setErrorMessage(\"\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleClose}>\r\n      <DialogContent className=\"sm:max-w-lg\">\r\n        <DialogHeader>\r\n          <div className=\"mx-auto mb-4 w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center\">\r\n            {status === 'success' ? (\r\n              <Check size={32} className=\"text-green-500\" />\r\n            ) : status === 'error' ? (\r\n              <X size={32} className=\"text-red-500\" />\r\n            ) : (\r\n              <LockKey size={32} className=\"text-primary\" />\r\n            )}\r\n          </div>\r\n          <DialogTitle className=\"text-xl text-center\">\r\n            {status === 'success'\r\n              ? \"Demande envoy√©e !\"\r\n              : status === 'error'\r\n                ? \"Erreur\"\r\n                : \"Demander un acc√®s temporaire\"}\r\n          </DialogTitle>\r\n          <DialogDescription className=\"text-center text-muted-foreground\">\r\n            {status === 'success' ? (\r\n              \"Votre demande a √©t√© envoy√©e aux responsables de l'√©quipe.\"\r\n            ) : status === 'error' ? (\r\n              errorMessage\r\n            ) : (\r\n              <>\r\n                Vous n&apos;avez pas la permission{\" \"}\r\n                <span className=\"font-semibold text-foreground\">\r\n                  {permissionLabel || permission}\r\n                </span>\r\n                .{\" \"}\r\n                {permissionDescription && (\r\n                  <span className=\"block mt-2\">{permissionDescription}</span>\r\n                )}\r\n                <span className=\"block mt-2\">\r\n                  Expliquez pourquoi vous avez besoin de cet acc√®s temporaire.\r\n                </span>\r\n              </>\r\n            )}\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {status === 'idle' && (\r\n          <>\r\n            <div className=\"space-y-4 py-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"reason\">\r\n                  Raison de la demande *\r\n                </Label>\r\n                <Textarea\r\n                  id=\"reason\"\r\n                  value={reason}\r\n                  onChange={(e) => setReason(e.target.value)}\r\n                  placeholder=\"Ex: Je dois √©diter ce bail pour corriger une erreur de saisie...\"\r\n                  className=\"min-h-[120px]\"\r\n                  disabled={isSubmitting}\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  Cette demande sera envoy√©e aux responsables de votre √©quipe (owner/manager)\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"flex items-start gap-3 p-3 rounded-lg bg-muted/50 border border-border/50\">\r\n                <ClockCounterClockwise size={20} className=\"text-primary flex-shrink-0 mt-0.5\" />\r\n                <div className=\"text-sm\">\r\n                  <p className=\"font-medium\">Acc√®s temporaire</p>\r\n                  <p className=\"text-muted-foreground text-xs mt-1\">\r\n                    Si votre demande est approuv√©e, vous recevrez un acc√®s temporaire\r\n                    √† cette fonctionnalit√© (dur√©e d√©finie par le responsable).\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <DialogFooter className=\"flex-row gap-2 sm:gap-2\">\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"outline\"\r\n                onClick={handleClose}\r\n                disabled={isSubmitting}\r\n                className=\"flex-1 border-border text-foreground hover:bg-accent hover:text-accent-foreground\"\r\n              >\r\n                Annuler\r\n              </Button>\r\n              <Button\r\n                type=\"button\"\r\n                onClick={handleSubmit}\r\n                disabled={isSubmitting || !reason.trim()}\r\n                className=\"flex-1\"\r\n              >\r\n                {isSubmitting ? \"Envoi...\" : \"Envoyer la demande\"}\r\n              </Button>\r\n            </DialogFooter>\r\n          </>\r\n        )}\r\n\r\n        {status === 'success' && (\r\n          <div className=\"py-4 text-center\">\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              Vous serez notifi√© lorsque votre demande sera trait√©e.\r\n            </p>\r\n          </div>\r\n        )}\r\n\r\n        {status === 'error' && (\r\n          <DialogFooter>\r\n            <Button\r\n              type=\"button\"\r\n              onClick={handleClose}\r\n              className=\"w-full\"\r\n            >\r\n              Fermer\r\n            </Button>\r\n          </DialogFooter>\r\n        )}\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n\r\n/**\r\n * Hook pour g√©rer le modal d'acc√®s\r\n */\r\nexport function useAccessRequestModal() {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [config, setConfig] = useState<{\r\n    teamId: string;\r\n    permission: TeamPermissionKey;\r\n    permissionLabel?: string;\r\n    permissionDescription?: string;\r\n  } | null>(null);\r\n\r\n  const open = (params: {\r\n    teamId: string;\r\n    permission: TeamPermissionKey;\r\n    permissionLabel?: string;\r\n    permissionDescription?: string;\r\n  }) => {\r\n    setConfig(params);\r\n    setIsOpen(true);\r\n  };\r\n\r\n  const close = () => {\r\n    setIsOpen(false);\r\n    setTimeout(() => setConfig(null), 300);\r\n  };\r\n\r\n  const Modal = config\r\n    ? () => (\r\n      <AccessRequestModal\r\n        open={isOpen}\r\n        onOpenChange={setIsOpen}\r\n        teamId={config.teamId}\r\n        permission={config.permission}\r\n        permissionLabel={config.permissionLabel}\r\n        permissionDescription={config.permissionDescription}\r\n      />\r\n    )\r\n    : () => null;\r\n\r\n  return { open, close, Modal, isOpen };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\navigation\\bottom-nav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\navigation\\header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\onboarding\\OnboardingTour.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'targetRect'. Either include it or remove the dependency array.","line":339,"column":6,"nodeType":"ArrayExpression","endLine":339,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [targetRect]","fix":{"range":[12633,12648],"text":"[targetRect]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'onStepChange' and 'updateTargetPosition'. Either include them or remove the dependency array. If 'onStepChange' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":158,"column":6,"nodeType":"ArrayExpression","endLine":158,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [currentStepIndex, isOpen, onStepChange, updateTargetPosition]","fix":{"range":[5538,5564],"text":"[currentStepIndex, isOpen, onStepChange, updateTargetPosition]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'steps', 'targetRect', and 'updateTargetPosition'. Either include them or remove the dependency array.","line":216,"column":6,"nodeType":"ArrayExpression","endLine":216,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [isPositioned, currentStepIndex, targetRect, steps, updateTargetPosition]","fix":{"range":[7534,7566],"text":"[isPositioned, currentStepIndex, targetRect, steps, updateTargetPosition]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect, useMemo, useCallback } from 'react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport { createPortal } from 'react-dom';\r\nimport Image from 'next/image';\r\nimport { X, ChevronRight } from 'lucide-react';\r\nimport { _cn } from '@/lib/utils';\r\n\r\n// --- TYPES ---\r\nexport interface TourStep {\r\n  targetId: string;\r\n  title: string;\r\n  description: string;\r\n  imageSrc: string;\r\n  imageAlt?: string;\r\n}\r\n\r\ninterface OnboardingTourProps {\r\n  steps: TourStep[];\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onComplete: () => void;\r\n  storageKey?: string;\r\n  isDark?: boolean; // Support mode light/dark\r\n  onStepChange?: (index: number) => void;\r\n}\r\n\r\n// --- COMPOSANT PRINCIPAL ---\r\nexport function OnboardingTour({\r\n  steps,\r\n  isOpen,\r\n  onClose,\r\n  onComplete,\r\n  storageKey = 'dousell_tour',\r\n  isDark = true,\r\n  onStepChange\r\n}: OnboardingTourProps) {\r\n  const [currentStepIndex, setCurrentStepIndex] = useState(0);\r\n  const [targetRect, setTargetRect] = useState<DOMRect | null>(null);\r\n  const [mounted, setMounted] = useState(false);\r\n  const [isPositioned, setIsPositioned] = useState(false);\r\n\r\n  // Variables de th√®me adaptatif (light/dark)\r\n  // Couleur accent : Dor√© en dark, Bleu nuit gris√© en light\r\n  const accentColor = isDark ? '#F4C430' : '#7891A8';\r\n\r\n  const theme = {\r\n    // Tooltip background\r\n    bgGradient: isDark\r\n      ? 'linear-gradient(180deg, #1a1b1e 0%, #0f1012 100%)'\r\n      : 'linear-gradient(180deg, #ffffff 0%, #f9fafb 100%)',\r\n    // Overlay gradient sur l'image\r\n    overlayGradient: isDark\r\n      ? 'from-[#0f1012] via-[#0f1012]/50'\r\n      : 'from-white via-white/50',\r\n    // Arrow background\r\n    arrowBg: isDark ? '#1a1b1e' : '#ffffff',\r\n    arrowGradient: isDark\r\n      ? 'linear-gradient(135deg, #1a1b1e 0%, #0f1012 100%)'\r\n      : 'linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)',\r\n    // Textes\r\n    titleText: isDark ? 'text-white' : 'text-gray-900',\r\n    descText: isDark ? 'text-[#a1a1aa]' : 'text-gray-600',\r\n    // Boutons\r\n    closeBtn: isDark\r\n      ? 'bg-black/30 text-white/40 hover:text-white hover:bg-black/50'\r\n      : 'bg-gray-100/80 text-gray-500 hover:text-gray-900 hover:bg-gray-200',\r\n    backBtn: isDark\r\n      ? 'text-[#a1a1aa] hover:text-white border-[#3f3f46] hover:border-[#52525b] hover:bg-[#27272a]'\r\n      : 'text-gray-600 hover:text-gray-900 border-gray-300 hover:border-gray-400 hover:bg-gray-100',\r\n    ignoreBtn: isDark\r\n      ? 'text-[#52525b] hover:text-[#a1a1aa]'\r\n      : 'text-gray-400 hover:text-gray-600',\r\n    // Progress dots\r\n    dotActive: accentColor,\r\n    dotInactive: isDark ? '#3f3f46' : '#e5e7eb',\r\n    // Couleur accent pour bordures et badges\r\n    accent: accentColor\r\n  };\r\n\r\n  // Stabiliser targetRect avec un objet s√©rialis√© pour √©viter re-renders inutiles\r\n  const targetRectKey = targetRect\r\n    ? `${targetRect.top}-${targetRect.left}-${targetRect.width}-${targetRect.height}`\r\n    : null;\r\n\r\n  // SSR Safety\r\n  useEffect(() => {\r\n    setMounted(true);\r\n  }, []);\r\n\r\n  // Bloquer le scroll quand le tour est ouvert\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      document.body.style.overflow = 'hidden';\r\n    } else {\r\n      document.body.style.overflow = '';\r\n    }\r\n    return () => {\r\n      document.body.style.overflow = '';\r\n    };\r\n  }, [isOpen]);\r\n\r\n  // Position de l'√©l√©ment cible - useCallback avec d√©pendances stables\r\n  const updateTargetPosition = useCallback((retryCount = 0) => {\r\n    if (!isOpen || steps.length === 0) return;\r\n\r\n    const step = steps[currentStepIndex];\r\n    if (!step) return;\r\n\r\n    const element = document.getElementById(step.targetId);\r\n\r\n    if (element) {\r\n      if (retryCount === 0) {\r\n        setIsPositioned(false);\r\n      }\r\n\r\n      // Scroll vers l'√©l√©ment avec marge pour √©viter les d√©bordements (seulement au premier essai)\r\n      if (retryCount === 0) {\r\n        element.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });\r\n      }\r\n\r\n      // D√©lai pour laisser le scroll finir et recalculer pr√©cis√©ment\r\n      setTimeout(() => {\r\n        const rect = element.getBoundingClientRect();\r\n\r\n        // S'assurer que le rect est valide et visible\r\n        if (rect.width > 0 && rect.height > 0) {\r\n          setTargetRect(rect);\r\n          setIsPositioned(true);\r\n        } else if (retryCount < 5) {\r\n          // R√©essayer si l'√©l√©ment est dans le DOM mais pas encore de dimensions (cas de montage async)\r\n          updateTargetPosition(retryCount + 1);\r\n        } else {\r\n          // Fallback apr√®s retries : afficher au centre\r\n          console.warn('[OnboardingTour] Element has no dimensions after retries:', step.targetId);\r\n          setTargetRect(null);\r\n          setIsPositioned(true);\r\n        }\r\n      }, retryCount === 0 ? 500 : 200);\r\n    } else if (retryCount < 8) {\r\n      // R√©essayer plusieurs fois si l'√©l√©ment n'est pas encore dans le DOM (cas de switch de tab)\r\n      setTimeout(() => updateTargetPosition(retryCount + 1), 250);\r\n    } else {\r\n      console.warn(`[OnboardingTour] Element with id \"${step.targetId}\" not found after retries`);\r\n      setTargetRect(null);\r\n      setIsPositioned(true); // Toujours afficher pour permettre de continuer (centr√©)\r\n    }\r\n  }, [currentStepIndex, isOpen, steps]);\r\n\r\n  // Effet pour mettre √† jour la position - NE PAS d√©pendre de updateTargetPosition\r\n  useEffect(() => {\r\n    updateTargetPosition();\r\n    if (onStepChange) {\r\n      onStepChange(currentStepIndex);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [currentStepIndex, isOpen]); // Seulement quand l'√©tape change\r\n\r\n  // Effet s√©par√© pour les √©v√©nements resize/scroll\r\n  useEffect(() => {\r\n    let rafId: number | null = null;\r\n\r\n    // Mise √† jour fluide pendant le scroll avec requestAnimationFrame\r\n    const handleScroll = () => {\r\n      if (rafId !== null) return; // D√©j√† une mise √† jour en cours\r\n\r\n      rafId = requestAnimationFrame(() => {\r\n        if (isPositioned && targetRect) {\r\n          const step = steps[currentStepIndex];\r\n          if (step) {\r\n            const element = document.getElementById(step.targetId);\r\n            if (element) {\r\n              const rect = element.getBoundingClientRect();\r\n              // Mettre √† jour si le rect a chang√© (m√™me l√©g√®rement)\r\n              if (\r\n                Math.abs(rect.top - targetRect.top) > 1 ||\r\n                Math.abs(rect.left - targetRect.left) > 1\r\n              ) {\r\n                setTargetRect(rect);\r\n              }\r\n            }\r\n          }\r\n        }\r\n        rafId = null;\r\n      });\r\n    };\r\n\r\n    const handleResize = () => {\r\n      updateTargetPosition();\r\n    };\r\n\r\n    // √âcouter le scroll sur le conteneur scrollable principal\r\n    const scrollContainer = document.querySelector('main.overflow-y-auto');\r\n\r\n    window.addEventListener('resize', handleResize);\r\n    if (scrollContainer) {\r\n      scrollContainer.addEventListener('scroll', handleScroll, { passive: true });\r\n    } else {\r\n      // Fallback sur window si le conteneur n'existe pas\r\n      window.addEventListener('scroll', handleScroll, { passive: true });\r\n    }\r\n\r\n    return () => {\r\n      window.removeEventListener('resize', handleResize);\r\n      if (scrollContainer) {\r\n        scrollContainer.removeEventListener('scroll', handleScroll);\r\n      } else {\r\n        window.removeEventListener('scroll', handleScroll);\r\n      }\r\n      if (rafId !== null) {\r\n        cancelAnimationFrame(rafId);\r\n      }\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [isPositioned, currentStepIndex]); // Pas de d√©pendance sur targetRect pour √©viter boucle\r\n\r\n  // Navigation\r\n  const handleNext = () => {\r\n    if (currentStepIndex < steps.length - 1) {\r\n      setCurrentStepIndex((prev) => prev + 1);\r\n    } else {\r\n      handleComplete();\r\n    }\r\n  };\r\n\r\n  const handlePrev = () => {\r\n    if (currentStepIndex > 0) {\r\n      setCurrentStepIndex((prev) => prev - 1);\r\n    }\r\n  };\r\n\r\n  const handleComplete = () => {\r\n    if (storageKey) {\r\n      localStorage.setItem(storageKey, 'true');\r\n    }\r\n    onComplete();\r\n  };\r\n\r\n  const handleIgnore = () => {\r\n    if (storageKey) {\r\n      localStorage.setItem(storageKey, 'true');\r\n    }\r\n    onClose();\r\n  };\r\n\r\n  // Calcul intelligent de la position du Tooltip\r\n  const tooltipStyle = useMemo(() => {\r\n    if (!targetRect) {\r\n      return { top: '50%', left: '50%', transform: 'translate(-50%, -50%)', placement: 'center' as const };\r\n    }\r\n\r\n    const viewportWidth = typeof window !== 'undefined' ? window.innerWidth : 1200;\r\n    const viewportHeight = typeof window !== 'undefined' ? window.innerHeight : 800;\r\n\r\n    // Responsive: adapter les dimensions selon l'appareil\r\n    const isMobile = viewportWidth < 768;\r\n    const isTablet = viewportWidth >= 768 && viewportWidth < 1024;\r\n\r\n    const spacing = isMobile ? 12 : 16; // Espace entre target et tooltip\r\n    const tooltipWidth = isMobile ? Math.min(320, viewportWidth - 24) : (isTablet ? 340 : 360);\r\n    const tooltipHeight = isMobile ? 360 : 380;\r\n    const margin = isMobile ? 8 : 12; // Marge par rapport aux bords de l'√©cran\r\n\r\n    // Espace disponible de chaque c√¥t√© de l'√©l√©ment cible\r\n    const spaceRight = viewportWidth - targetRect.right - margin;\r\n    const spaceLeft = targetRect.left - margin;\r\n    const spaceBottom = viewportHeight - targetRect.bottom - margin;\r\n    const spaceTop = targetRect.top - margin;\r\n\r\n    let top = 0;\r\n    let left = 0;\r\n    let placement: 'right' | 'left' | 'bottom' | 'top' | 'center' = 'right';\r\n\r\n    // Pr√©f√©rence: droite > gauche > bas > haut\r\n\r\n    // 1. Essayer √† DROITE (align√© verticalement avec la cible)\r\n    if (spaceRight >= tooltipWidth + spacing) {\r\n      left = targetRect.right + spacing;\r\n      top = Math.max(margin, Math.min(targetRect.top, viewportHeight - tooltipHeight - margin));\r\n      placement = 'right';\r\n      return { top, left, placement };\r\n    }\r\n\r\n    // 2. Essayer √† GAUCHE\r\n    if (spaceLeft >= tooltipWidth + spacing) {\r\n      left = targetRect.left - tooltipWidth - spacing;\r\n      top = Math.max(margin, Math.min(targetRect.top, viewportHeight - tooltipHeight - margin));\r\n      placement = 'left';\r\n      return { top, left, placement };\r\n    }\r\n\r\n    // 3. Essayer en BAS (centr√© horizontalement par rapport √† la cible)\r\n    if (spaceBottom >= tooltipHeight + spacing) {\r\n      top = targetRect.bottom + spacing;\r\n      // Centrer le tooltip par rapport √† l'√©l√©ment cible\r\n      const targetCenter = targetRect.left + targetRect.width / 2;\r\n      const tooltipLeft = targetCenter - tooltipWidth / 2;\r\n      left = Math.max(margin, Math.min(tooltipLeft, viewportWidth - tooltipWidth - margin));\r\n      placement = 'bottom';\r\n      return { top, left, placement };\r\n    }\r\n\r\n    // 4. Essayer en HAUT (centr√© horizontalement par rapport √† la cible)\r\n    if (spaceTop >= tooltipHeight + spacing) {\r\n      top = targetRect.top - tooltipHeight - spacing;\r\n      // Centrer le tooltip par rapport √† l'√©l√©ment cible\r\n      const targetCenter = targetRect.left + targetRect.width / 2;\r\n      const tooltipLeft = targetCenter - tooltipWidth / 2;\r\n      left = Math.max(margin, Math.min(tooltipLeft, viewportWidth - tooltipWidth - margin));\r\n      placement = 'top';\r\n      return { top, left, placement };\r\n    }\r\n\r\n    // 5. FALLBACK: Forcer le tooltip √† √™tre visible (centr√© sur l'√©cran si besoin)\r\n    // On garantit que le tooltip reste TOUJOURS dans le viewport\r\n    if (spaceBottom >= tooltipHeight / 2) {\r\n      // Assez d'espace en bas, positionner sous l'√©l√©ment (centr√©)\r\n      top = Math.max(margin, Math.min(targetRect.bottom + spacing, viewportHeight - tooltipHeight - margin));\r\n      const targetCenter = targetRect.left + targetRect.width / 2;\r\n      const tooltipLeft = targetCenter - tooltipWidth / 2;\r\n      left = Math.max(margin, Math.min(tooltipLeft, viewportWidth - tooltipWidth - margin));\r\n      placement = 'bottom';\r\n    } else if (spaceTop >= tooltipHeight / 2) {\r\n      // Assez d'espace en haut, positionner au-dessus (centr√©)\r\n      top = Math.max(margin, targetRect.top - tooltipHeight - spacing);\r\n      const targetCenter = targetRect.left + targetRect.width / 2;\r\n      const tooltipLeft = targetCenter - tooltipWidth / 2;\r\n      left = Math.max(margin, Math.min(tooltipLeft, viewportWidth - tooltipWidth - margin));\r\n      placement = 'top';\r\n    } else {\r\n      // Pas assez d'espace vertical, centrer le tooltip sur l'√©cran\r\n      top = Math.max(margin, (viewportHeight - tooltipHeight) / 2);\r\n      left = Math.max(margin, (viewportWidth - tooltipWidth) / 2);\r\n      placement = 'center';\r\n    }\r\n\r\n    return { top, left, placement };\r\n  }, [targetRectKey]); // Utiliser targetRectKey au lieu de targetRect pour √©viter re-renders\r\n\r\n  if (!mounted || !isOpen || steps.length === 0) return null;\r\n\r\n  const currentStep = steps[currentStepIndex];\r\n  const isLastStep = currentStepIndex === steps.length - 1;\r\n  const isFirstStep = currentStepIndex === 0;\r\n\r\n  // Arrow position helper\r\n  const getArrowStyle = (placement: string) => {\r\n    if (!targetRect) return { display: 'none' };\r\n\r\n    const tooltipTop = typeof tooltipStyle.top === 'number' ? tooltipStyle.top : 0;\r\n    const tooltipLeft = typeof tooltipStyle.left === 'number' ? tooltipStyle.left : 0;\r\n\r\n    const targetCenterY = (targetRect?.top || 0) + (targetRect?.height || 0) / 2;\r\n    const targetCenterX = (targetRect?.left || 0) + (targetRect?.width || 0) / 2;\r\n\r\n    // Calculer la largeur r√©elle du tooltip selon le viewport\r\n    const viewportWidth = window.innerWidth;\r\n    const isMobile = viewportWidth < 768;\r\n    const isTablet = viewportWidth >= 768 && viewportWidth < 1024;\r\n    const actualTooltipWidth = isMobile ? Math.min(320, viewportWidth - 24) : (isTablet ? 340 : 360);\r\n    const actualTooltipHeight = isMobile ? 360 : 380;\r\n\r\n    switch (placement) {\r\n      case 'right': {\r\n        const arrowTop = Math.max(16, Math.min(targetCenterY - tooltipTop, actualTooltipHeight - 20));\r\n        return { top: arrowTop, left: -6, borderLeft: '1px solid rgba(244, 196, 48, 0.2)', borderBottom: '1px solid rgba(244, 196, 48, 0.2)' };\r\n      }\r\n      case 'left': {\r\n        const arrowTop = Math.max(16, Math.min(targetCenterY - tooltipTop, actualTooltipHeight - 20));\r\n        return { top: arrowTop, right: -6, borderRight: '1px solid rgba(244, 196, 48, 0.2)', borderTop: '1px solid rgba(244, 196, 48, 0.2)' };\r\n      }\r\n      case 'bottom': {\r\n        const arrowLeft = Math.max(16, Math.min(targetCenterX - tooltipLeft, actualTooltipWidth - 20));\r\n        return { top: -6, left: arrowLeft, borderTop: '1px solid rgba(244, 196, 48, 0.2)', borderLeft: '1px solid rgba(244, 196, 48, 0.2)' };\r\n      }\r\n      case 'top': {\r\n        const arrowLeft = Math.max(16, Math.min(targetCenterX - tooltipLeft, actualTooltipWidth - 20));\r\n        return { bottom: -6, left: arrowLeft, borderRight: '1px solid rgba(244, 196, 48, 0.2)', borderBottom: '1px solid rgba(244, 196, 48, 0.2)' };\r\n      }\r\n      default: return { display: 'none' };\r\n    }\r\n  };\r\n\r\n  return createPortal(\r\n    <div className=\"fixed inset-0 z-[99999] pointer-events-none\">\r\n      {/* OVERLAY SOMBRE avec effet Spotlight */}\r\n      <motion.div\r\n        initial={{ opacity: 0 }}\r\n        animate={{ opacity: 1 }}\r\n        exit={{ opacity: 0 }}\r\n        transition={{ duration: 0.3 }}\r\n        className=\"absolute inset-0 pointer-events-auto\"\r\n        onClick={handleIgnore}\r\n        style={{\r\n          background: targetRect\r\n            ? (() => {\r\n              // Calculer le rayon du spotlight en fonction de la taille de l'√©l√©ment\r\n              const elementSize = Math.max(targetRect.width, targetRect.height);\r\n              const innerRadius = Math.max(elementSize / 1.6, 50); // Minimum 50px\r\n              const outerRadius = Math.max(elementSize / 1.1, 100); // Minimum 100px\r\n              const centerX = (targetRect?.left || 0) + (targetRect?.width || 0) / 2;\r\n              const centerY = (targetRect?.top || 0) + (targetRect?.height || 0) / 2;\r\n\r\n              const overlayColor = isDark ? 'rgba(0,0,0,0.65)' : 'rgba(0,0,0,0.45)';\r\n              return `radial-gradient(circle at ${centerX}px ${centerY}px, transparent ${innerRadius}px, ${overlayColor} ${outerRadius}px)`;\r\n            })()\r\n            : isDark ? 'rgba(0,0,0,0.65)' : 'rgba(0,0,0,0.45)',\r\n          transition: 'background 0.3s ease'\r\n        }}\r\n      />\r\n\r\n      {/* CADRE AUTOUR DE L'√âL√âMENT (Highlight avec shimmer or) */}\r\n      <AnimatePresence mode=\"wait\">\r\n        {targetRect && (() => {\r\n          // Calcul des dimensions du cadre avec contraintes viewport\r\n          const padding = 6;\r\n          const viewportWidth = window.innerWidth;\r\n          const viewportHeight = window.innerHeight;\r\n\r\n          // Position et taille du cadre, contraintes au viewport\r\n          const highlightTop = Math.max(0, targetRect.top - padding);\r\n          const highlightLeft = Math.max(0, targetRect.left - padding);\r\n          const highlightWidth = Math.min(\r\n            targetRect.width + padding * 2,\r\n            viewportWidth - highlightLeft - 4\r\n          );\r\n          const highlightHeight = Math.min(\r\n            targetRect.height + padding * 2,\r\n            viewportHeight - highlightTop - 4\r\n          );\r\n\r\n          return (\r\n            <motion.div\r\n              key={`highlight-${currentStepIndex}`}\r\n              initial={{ opacity: 0, scale: 0.95 }}\r\n              animate={{ opacity: 1, scale: 1 }}\r\n              exit={{ opacity: 0, scale: 0.95 }}\r\n              transition={{ type: 'spring', stiffness: 300, damping: 25 }}\r\n              className=\"absolute pointer-events-none rounded-lg\"\r\n              style={{\r\n                top: highlightTop,\r\n                left: highlightLeft,\r\n                width: highlightWidth,\r\n                height: highlightHeight,\r\n                borderRadius: 12,\r\n                border: `2.5px solid ${accentColor}`,\r\n                boxShadow: isDark\r\n                  ? '0 0 0 4px rgba(244, 196, 48, 0.15), 0 0 20px rgba(244, 196, 48, 0.4), 0 0 40px rgba(244, 196, 48, 0.2)'\r\n                  : '0 0 0 4px rgba(120, 145, 168, 0.15), 0 0 20px rgba(120, 145, 168, 0.4), 0 0 40px rgba(120, 145, 168, 0.2)',\r\n                // Transition seulement pour border-color et box-shadow (pas top/left/width/height car g√©r√©s par Framer Motion)\r\n                transitionProperty: 'border-color, box-shadow',\r\n                transitionDuration: '0.3s',\r\n                transitionTimingFunction: 'ease'\r\n              }}\r\n            >\r\n              {/* Shimmer effect */}\r\n              <div\r\n                className=\"absolute inset-0 overflow-hidden rounded-[10px]\"\r\n                style={{\r\n                  background: isDark\r\n                    ? 'linear-gradient(90deg, transparent, rgba(244,196,48,0.2), transparent)'\r\n                    : 'linear-gradient(90deg, transparent, rgba(120,145,168,0.2), transparent)',\r\n                  animation: 'shimmer 2s infinite',\r\n                  transition: 'background 0.3s ease'\r\n                }}\r\n              />\r\n            </motion.div>\r\n          );\r\n        })()}\r\n      </AnimatePresence>\r\n\r\n      {/* LE TOOLTIP CARD (Style Premium) */}\r\n      <AnimatePresence mode=\"wait\">\r\n        {isPositioned && (\r\n          <motion.div\r\n            key={currentStepIndex}\r\n            initial={{ opacity: 0, y: 20, scale: 0.95 }}\r\n            animate={{ opacity: 1, y: 0, scale: 1 }}\r\n            exit={{ opacity: 0, y: -20, scale: 0.95 }}\r\n            transition={{ duration: 0.35, ease: [0.4, 0, 0.2, 1] }}\r\n            className=\"absolute pointer-events-auto w-[calc(100vw-32px)] md:w-[340px] lg:w-[360px]\"\r\n            style={{\r\n              top: tooltipStyle.top,\r\n              left: tooltipStyle.left,\r\n            }}\r\n          >\r\n            <div className=\"relative\">\r\n              {/* Arrow */}\r\n              {tooltipStyle.placement !== 'center' && (\r\n                <div\r\n                  className=\"absolute w-3 h-3 rotate-45 z-0\"\r\n                  style={{\r\n                    ...getArrowStyle(tooltipStyle.placement),\r\n                    background: theme.arrowGradient,\r\n                  }}\r\n                />\r\n              )}\r\n\r\n              {/* Inner Card Content */}\r\n              <div\r\n                className=\"relative z-10 overflow-hidden\"\r\n                style={{\r\n                  background: theme.bgGradient,\r\n                  border: `1px solid ${accentColor}33`, // 20% opacity\r\n                  borderRadius: '16px',\r\n                  boxShadow: isDark\r\n                    ? '0 25px 50px -12px rgba(0, 0, 0, 0.7), 0 0 30px rgba(244, 196, 48, 0.1)'\r\n                    : '0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 30px rgba(120, 145, 168, 0.15)',\r\n                  transition: 'background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease'\r\n                }}\r\n              >\r\n                {/* Bouton Fermer */}\r\n                <button\r\n                  onClick={handleIgnore}\r\n                  className={`absolute top-3 right-3 z-20 p-1.5 rounded-full transition-all duration-200 backdrop-blur-sm ${theme.closeBtn}`}\r\n                >\r\n                  <X size={14} />\r\n                </button>\r\n\r\n                {/* Num√©ro d'√©tape (Badge premium) */}\r\n                <div\r\n                  className=\"absolute top-3 left-3 z-20 flex items-center gap-1.5 px-2.5 py-1 rounded-full\"\r\n                  style={{\r\n                    backgroundColor: `${accentColor}1A`, // 10% opacity\r\n                    borderColor: `${accentColor}33`, // 20% opacity\r\n                    borderWidth: '1px',\r\n                    borderStyle: 'solid',\r\n                    transition: 'background-color 0.3s ease, border-color 0.3s ease'\r\n                  }}\r\n                >\r\n                  <span className=\"text-[11px] font-semibold\" style={{ color: accentColor, transition: 'color 0.3s ease' }}>\r\n                    {currentStepIndex + 1} / {steps.length}\r\n                  </span>\r\n                </div>\r\n\r\n                {/* Image (Haut) avec gradient overlay */}\r\n                <div className=\"relative h-36 w-full overflow-hidden\">\r\n                  <Image\r\n                    src={currentStep.imageSrc}\r\n                    alt={currentStep.imageAlt || currentStep.title}\r\n                    fill\r\n                    className=\"object-cover\"\r\n                    unoptimized={currentStep.imageSrc.startsWith('http')}\r\n                  />\r\n                  {/* Gradient overlay pour fusion avec le contenu */}\r\n                  <div className={`absolute inset-0 bg-gradient-to-t ${theme.overlayGradient} to-transparent`} />\r\n                  {/* Accent line (couleur adaptative) */}\r\n                  <div\r\n                    className=\"absolute bottom-0 left-0 right-0 h-[2px]\"\r\n                    style={{\r\n                      background: `linear-gradient(to right, transparent, ${accentColor}80, transparent)`,\r\n                      transition: 'background 0.3s ease'\r\n                    }}\r\n                  />\r\n                </div>\r\n\r\n                {/* Contenu (Bas) */}\r\n                <div className=\"p-5 pt-3\">\r\n                  {/* Titre */}\r\n                  <h3 className={`${theme.titleText} font-bold text-lg leading-tight mb-2`}>\r\n                    {currentStep.title}\r\n                  </h3>\r\n\r\n                  {/* Description */}\r\n                  <p className={`${theme.descText} text-sm leading-relaxed mb-5`}>\r\n                    {currentStep.description}\r\n                  </p>\r\n\r\n                  {/* Footer: Dots + Boutons */}\r\n                  <div className=\"flex items-center justify-between\">\r\n                    {/* Progress Dots */}\r\n                    <div className=\"flex gap-1.5\">\r\n                      {steps.map((_, i) => (\r\n                        <motion.div\r\n                          key={i}\r\n                          initial={false}\r\n                          animate={{\r\n                            width: i === currentStepIndex ? 20 : 8,\r\n                            backgroundColor: i === currentStepIndex ? theme.dotActive : theme.dotInactive,\r\n                            opacity: i <= currentStepIndex ? 1 : 0.5\r\n                          }}\r\n                          transition={{ duration: 0.2 }}\r\n                          className=\"h-2 rounded-full\"\r\n                        />\r\n                      ))}\r\n                    </div>\r\n\r\n                    {/* Boutons */}\r\n                    <div className=\"flex items-center gap-2\">\r\n                      {/* Bouton Retour */}\r\n                      {!isFirstStep && (\r\n                        <button\r\n                          onClick={handlePrev}\r\n                          className={`px-3 py-1.5 text-xs font-medium transition-colors rounded-lg border ${theme.backBtn}`}\r\n                        >\r\n                          Retour\r\n                        </button>\r\n                      )}\r\n\r\n                      {/* Bouton Ignorer (seulement sur premi√®re √©tape) */}\r\n                      {isFirstStep && (\r\n                        <button\r\n                          onClick={handleIgnore}\r\n                          className={`px-3 py-1.5 text-xs font-medium transition-colors ${theme.ignoreBtn}`}\r\n                        >\r\n                          Ignorer\r\n                        </button>\r\n                      )}\r\n\r\n                      {/* Bouton Suivant / Terminer */}\r\n                      <motion.button\r\n                        onClick={handleNext}\r\n                        whileHover={{ scale: 1.02 }}\r\n                        whileTap={{ scale: 0.98 }}\r\n                        className=\"flex items-center gap-1.5 px-4 py-2 text-xs font-bold rounded-lg\"\r\n                        style={{\r\n                          backgroundColor: accentColor,\r\n                          color: isDark ? '#000000' : '#ffffff',\r\n                          boxShadow: isDark\r\n                            ? '0 0 15px rgba(244, 196, 48, 0.3)'\r\n                            : '0 0 15px rgba(120, 145, 168, 0.3)',\r\n                          transition: 'background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease'\r\n                        }}\r\n                      >\r\n                        {isLastStep ? 'Terminer' : 'Suivant'}\r\n                        {!isLastStep && <ChevronRight className=\"w-3.5 h-3.5\" />}\r\n                      </motion.button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n\r\n      {/* CSS pour l'animation shimmer */}\r\n      <style jsx global>{`\r\n        @keyframes shimmer {\r\n          0% {\r\n            transform: translateX(-100%);\r\n          }\r\n          100% {\r\n            transform: translateX(100%);\r\n          }\r\n        }\r\n      `}</style>\r\n    </div>,\r\n    document.body\r\n  );\r\n}\r\n\r\n// --- HOOK POUR G√âRER L'√âTAT DU TOUR ---\r\nexport function useOnboardingTour(storageKey: string, delay: number = 1000) {\r\n  const [showTour, setShowTour] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const hasSeenTour = localStorage.getItem(storageKey);\r\n    if (!hasSeenTour) {\r\n      const timer = setTimeout(() => setShowTour(true), delay);\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [storageKey, delay]);\r\n\r\n  const closeTour = useCallback(() => {\r\n    setShowTour(false);\r\n    localStorage.setItem(storageKey, 'true');\r\n  }, [storageKey]);\r\n\r\n  const resetTour = useCallback(() => {\r\n    localStorage.removeItem(storageKey);\r\n    setShowTour(true);\r\n  }, [storageKey]);\r\n\r\n  return { showTour, setShowTour, closeTour, resetTour };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\onboarding\\WizardForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5137,5140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5137,5140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":288,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12067,12070],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12067,12070],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":364,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":364,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15886,15889],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15886,15889],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":468,"column":9,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":468,"endColumn":71},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":484,"column":13,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":484,"endColumn":77},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":534,"column":37,"nodeType":"JSXOpeningElement","endLine":534,"endColumn":110},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":570,"column":41,"nodeType":"JSXOpeningElement","endLine":570,"endColumn":124},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":612,"column":49,"nodeType":"JSXOpeningElement","endLine":612,"endColumn":117},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":625,"column":50,"nodeType":"JSXOpeningElement","endLine":625,"endColumn":129},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":635,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":635,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32297,32300],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32297,32300],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport { User, Building2, Target, Check, ArrowRight, ArrowLeft, Upload, PenTool, Trash2, Loader2 } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { _Textarea } from \"@/components/ui/textarea\";\r\nimport { toast } from \"sonner\";\r\nimport { PhoneInput } from \"@/components/ui/phone-input\";\r\nimport { submitOnboarding } from \"@/app/pro/start/actions\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\n\r\ntype _Step = \"user\" | \"agency\" | \"goals\" | \"confirmation\";\r\n\r\ninterface WizardData {\r\n    // User Step\r\n    fullName: string;\r\n    email: string;\r\n    phone: string;\r\n    password: string;\r\n\r\n    // Agency Step\r\n    companyName: string;\r\n    companyAddress: string;\r\n    companyPhone: string;\r\n    companyNinea: string;\r\n    companyEmail: string;\r\n    logoUrl: string;\r\n    signatureUrl: string;\r\n\r\n    // Goals Step\r\n    propertyTypes: string[];\r\n    teamSize: string;\r\n}\r\n\r\nconst STEPS = [\r\n    { id: \"user\", label: \"Vous\", icon: User },\r\n    { id: \"agency\", label: \"Agence\", icon: Building2 },\r\n    { id: \"goals\", label: \"Besoins\", icon: Target },\r\n    { id: \"confirmation\", label: \"Fin\", icon: Check },\r\n];\r\n\r\nexport function WizardForm() {\r\n    const router = useRouter();\r\n    const [currentStep, setCurrentStep] = useState<number>(0);\r\n    const [direction, setDirection] = useState<number>(0);\r\n    const [isPending, setIsPending] = useState(false);\r\n    const [isLoggedIn, setIsLoggedIn] = useState(false);\r\n    const [loggedInUserId, setLoggedInUserId] = useState<string | null>(null);\r\n    const [data, setData] = useState<WizardData>({\r\n        fullName: \"\",\r\n        email: \"\",\r\n        phone: \"\",\r\n        password: \"\",\r\n        companyName: \"\",\r\n        companyAddress: \"\",\r\n        companyPhone: \"\",\r\n        companyNinea: \"\",\r\n        companyEmail: \"\",\r\n        logoUrl: \"\",\r\n        signatureUrl: \"\",\r\n        propertyTypes: [],\r\n        teamSize: \"\",\r\n    });\r\n\r\n    // Detecter si l'utilisateur est deja connecte et pre-remplir\r\n    useEffect(() => {\r\n        const checkAuth = async () => {\r\n            const supabase = createClient();\r\n            const { data: { user } } = await supabase.auth.getUser();\r\n\r\n            if (user) {\r\n                // Verifier si l'utilisateur a d√©j√† une √©quipe active\r\n                // Si oui, on le redirige directement vers le dashboard gestion\r\n                const { data: memberships } = await supabase\r\n                    .from(\"team_members\")\r\n                    .select(\"id\")\r\n                    .eq(\"user_id\", user.id)\r\n                    .eq(\"status\", \"active\")\r\n                    .limit(1);\r\n\r\n                if (memberships && memberships.length > 0) {\r\n                    console.log(\"Onboarding: Utilisateur a d√©j√† une √©quipe, redirection...\");\r\n                    router.push(\"/gestion\");\r\n                    return;\r\n                }\r\n\r\n                setIsLoggedIn(true);\r\n                setLoggedInUserId(user.id);\r\n\r\n                // Pre-remplir depuis le profil et les metadonnees\r\n                const { data: profile } = await supabase\r\n                    .from(\"profiles\")\r\n                    .select(\"full_name, phone\")\r\n                    .eq(\"id\", user.id)\r\n                    .single();\r\n\r\n                setData(prev => ({\r\n                    ...prev,\r\n                    fullName: profile?.full_name || user.user_metadata?.full_name || prev.fullName,\r\n                    email: user.email || prev.email,\r\n                    phone: profile?.phone || user.user_metadata?.phone || prev.phone,\r\n                }));\r\n            }\r\n        };\r\n        checkAuth();\r\n    }, [router]);\r\n\r\n    const handleSubmit = async () => {\r\n        setIsPending(true);\r\n        try {\r\n            const result = await submitOnboarding(data, loggedInUserId);\r\n\r\n            if (result.error) {\r\n                toast.error(result.error);\r\n                return;\r\n            }\r\n\r\n            if (result.success) {\r\n                toast.success(isLoggedIn ? \"Espace de gestion activ√© !\" : \"Compte cr√©√© avec succ√®s !\");\r\n                router.push(\"/gestion\");\r\n            }\r\n        } catch (error) {\r\n            toast.error(\"Une erreur inattendue est survenue.\");\r\n            console.error(error);\r\n        } finally {\r\n            setIsPending(false);\r\n        }\r\n    };\r\n\r\n    const nextStep = () => {\r\n        if (currentStep < STEPS.length - 1) {\r\n            setDirection(1);\r\n            setCurrentStep(prev => prev + 1);\r\n        }\r\n    };\r\n\r\n    const prevStep = () => {\r\n        if (currentStep > 0) {\r\n            setDirection(-1);\r\n            setCurrentStep(prev => prev - 1);\r\n        }\r\n    };\r\n\r\n    const skipToConfirmation = () => {\r\n        setDirection(1);\r\n        setCurrentStep(STEPS.length - 1); // Aller directement √† la confirmation\r\n    };\r\n\r\n    const updateData = (field: keyof WizardData, value: any) => {\r\n        setData(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    const variants = {\r\n        enter: (direction: number) => ({\r\n            x: direction > 0 ? 50 : -50,\r\n            opacity: 0,\r\n        }),\r\n        center: {\r\n            x: 0,\r\n            opacity: 1,\r\n        },\r\n        exit: (direction: number) => ({\r\n            x: direction < 0 ? 50 : -50,\r\n            opacity: 0,\r\n        }),\r\n    };\r\n\r\n    return (\r\n        <div className=\"w-full max-w-4xl mx-auto p-4 md:p-8\">\r\n            {/* Progress Bar */}\r\n            <div className=\"mb-8 md:mb-12\">\r\n                <div className=\"flex items-center justify-between relative px-4\">\r\n                    {/* Background line */}\r\n                    <div className=\"absolute left-4 right-4 top-5 h-0.5 bg-gray-700/50 rounded-full\" />\r\n                    {/* Active progress line */}\r\n                    <div\r\n                        className=\"absolute left-4 top-5 h-0.5 bg-gradient-to-r from-primary via-amber-400 to-amber-300 transition-all duration-500 rounded-full shadow-[0_0_10px_rgba(244,196,48,0.5)]\"\r\n                        style={{ width: `calc(${(currentStep / (STEPS.length - 1)) * 100}% - 2rem)` }}\r\n                    />\r\n                    {STEPS.map((step, index) => {\r\n                        const Icon = step.icon;\r\n                        const isActive = index <= currentStep;\r\n                        const isCurrent = index === currentStep;\r\n                        const isCompleted = index < currentStep;\r\n\r\n                        return (\r\n                            <div key={step.id} className=\"flex flex-col items-center gap-3 relative z-10\">\r\n                                <div\r\n                                    className={`w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center border-2 transition-all duration-300 ${isCompleted\r\n                                        ? \"bg-primary border-primary text-black\"\r\n                                        : isActive\r\n                                            ? \"bg-gray-900 border-primary text-primary shadow-[0_0_15px_rgba(244,196,48,0.4)]\"\r\n                                            : \"bg-gray-900 border-gray-700 text-gray-500\"\r\n                                        } ${isCurrent ? \"scale-110\" : \"\"}`}\r\n                                >\r\n                                    <Icon className=\"w-5 h-5 md:w-6 md:h-6\" />\r\n                                </div>\r\n                                <span className={`text-xs md:text-sm font-medium transition-colors ${isActive ? \"text-primary\" : \"text-gray-500\"\r\n                                    }`}>\r\n                                    {step.label}\r\n                                </span>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"bg-white dark:bg-gray-900/50 rounded-3xl border border-slate-200 dark:border-gray-800 shadow-xl overflow-hidden min-h-[500px] flex flex-col\">\r\n                <div className=\"flex-1 p-6 md:p-10 relative\">\r\n                    <AnimatePresence initial={false} custom={direction} mode=\"wait\">\r\n                        <motion.div\r\n                            key={currentStep}\r\n                            custom={direction}\r\n                            variants={variants}\r\n                            initial=\"enter\"\r\n                            animate=\"center\"\r\n                            exit=\"exit\"\r\n                            transition={{ type: \"spring\", stiffness: 300, damping: 30 }}\r\n                            className=\"h-full\"\r\n                        >\r\n                            {currentStep === 0 && (\r\n                                <StepUser data={data} updateData={updateData} isLoggedIn={isLoggedIn} />\r\n                            )}\r\n                            {currentStep === 1 && (\r\n                                <StepAgency data={data} updateData={updateData} />\r\n                            )}\r\n                            {currentStep === 2 && (\r\n                                <StepGoals data={data} updateData={updateData} />\r\n                            )}\r\n                            {currentStep === 3 && (\r\n                                <StepConfirmation data={data} isLoggedIn={isLoggedIn} />\r\n                            )}\r\n                        </motion.div>\r\n                    </AnimatePresence>\r\n                </div>\r\n\r\n                <div className=\"p-6 md:px-10 md:py-8 border-t border-slate-100 dark:border-gray-800 bg-slate-50/50 dark:bg-gray-900/30 flex justify-between items-center\">\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        onClick={prevStep}\r\n                        disabled={currentStep === 0 || isPending}\r\n                        className={`text-slate-500 hover:text-slate-900 dark:text-gray-400 dark:hover:text-white ${currentStep === 0 ? 'invisible' : ''}`}\r\n                    >\r\n                        <ArrowLeft className=\"w-4 h-4 mr-2\" /> Retour\r\n                    </Button>\r\n\r\n                    <div className=\"flex items-center gap-3\">\r\n                        {/* Bouton Passer - visible sur √©tapes Agency (1) et Goals (2) */}\r\n                        {(currentStep === 1 || currentStep === 2) && (\r\n                            <Button\r\n                                variant=\"ghost\"\r\n                                onClick={skipToConfirmation}\r\n                                className=\"text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-gray-300\"\r\n                            >\r\n                                Passer\r\n                            </Button>\r\n                        )}\r\n\r\n                        {currentStep === STEPS.length - 1 ? (\r\n                            <Button\r\n                                size=\"lg\"\r\n                                className=\"bg-primary hover:bg-primary/90 text-black rounded-xl px-8\"\r\n                                onClick={handleSubmit}\r\n                                disabled={isPending}\r\n                            >\r\n                                {isPending ? \"Cr√©ation...\" : \"Commencer l'essai\"} <Check className=\"w-5 h-5 ml-2\" />\r\n                            </Button>\r\n                        ) : (\r\n                            <Button\r\n                                size=\"lg\"\r\n                                className=\"bg-primary hover:bg-primary/90 text-black rounded-xl px-8\"\r\n                                onClick={nextStep}\r\n                            >\r\n                                Suivant <ArrowRight className=\"w-5 h-5 ml-2\" />\r\n                            </Button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction StepUser({ data, updateData, isLoggedIn }: { data: WizardData, updateData: any, isLoggedIn: boolean }) {\r\n    return (\r\n        <div className=\"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500\">\r\n            <div className=\"text-center mb-8\">\r\n                <h2 className=\"text-2xl font-bold text-slate-900 dark:text-white\">\r\n                    {isLoggedIn ? \"Vos informations\" : \"Cr√©ez votre compte administrateur\"}\r\n                </h2>\r\n                <p className=\"text-slate-500 dark:text-gray-400\">\r\n                    {isLoggedIn\r\n                        ? \"V√©rifiez vos informations avant de continuer. Vous pouvez les modifier si n√©cessaire.\"\r\n                        : \"Ces identifiants vous serviront √† acc√©der √† votre espace de gestion.\"}\r\n                </p>\r\n            </div>\r\n\r\n            {isLoggedIn && (\r\n                <div className=\"flex items-center gap-2 rounded-xl border border-emerald-500/30 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-400\">\r\n                    <Check className=\"h-4 w-4 shrink-0\" />\r\n                    <span>Vous √™tes d√©j√† connect√©. Ces champs sont pr√©-remplis depuis votre compte.</span>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"grid gap-6\">\r\n                <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"fullName\">Nom complet du r√©f√©rent</Label>\r\n                    <Input\r\n                        id=\"fullName\"\r\n                        placeholder=\"Ex: Babacar Diop\"\r\n                        value={data.fullName}\r\n                        onChange={(e) => updateData(\"fullName\", e.target.value)}\r\n                        className=\"h-12 bg-slate-50 border-slate-200 dark:bg-gray-800 dark:border-gray-700\"\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"grid md:grid-cols-2 gap-6\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"email\">Email professionnel</Label>\r\n                        <Input\r\n                            id=\"email\"\r\n                            type=\"email\"\r\n                            placeholder=\"contact@monagence.sn\"\r\n                            value={data.email}\r\n                            onChange={(e) => updateData(\"email\", e.target.value)}\r\n                            disabled={isLoggedIn}\r\n                            className={`h-12 bg-slate-50 border-slate-200 dark:bg-gray-800 dark:border-gray-700 ${isLoggedIn ? \"opacity-60 cursor-not-allowed\" : \"\"}`}\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label>T√©l√©phone mobile</Label>\r\n                        <PhoneInput\r\n                            placeholder=\"77 000 00 00\"\r\n                            value={data.phone}\r\n                            onChange={(val) => updateData(\"phone\", val)}\r\n                            className=\"bg-slate-50 border-slate-200 dark:bg-gray-800 dark:border-gray-700\"\r\n                            defaultCountry=\"SN\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {!isLoggedIn && (\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"password\">Mot de passe</Label>\r\n                        <Input\r\n                            id=\"password\"\r\n                            type=\"password\"\r\n                            placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                            value={data.password}\r\n                            onChange={(e) => updateData(\"password\", e.target.value)}\r\n                            className=\"h-12 bg-slate-50 border-slate-200 dark:bg-gray-800 dark:border-gray-700\"\r\n                        />\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction StepAgency({ data, updateData }: { data: WizardData; updateData: any }) {\r\n    const [uploadingLogo, setUploadingLogo] = useState(false);\r\n    const [uploadingSignature, setUploadingSignature] = useState(false);\r\n    const [signatureMode, setSignatureMode] = useState<\"upload\" | \"draw\">(\"upload\");\r\n    const canvasRef = useRef<HTMLCanvasElement>(null);\r\n    const [isDrawing, setIsDrawing] = useState(false);\r\n    const [hasDrawn, setHasDrawn] = useState(false);\r\n\r\n    // Initialize canvas\r\n    useEffect(() => {\r\n        if (signatureMode === \"draw\" && canvasRef.current) {\r\n            const canvas = canvasRef.current;\r\n            const ctx = canvas.getContext(\"2d\");\r\n            if (!ctx) return;\r\n            const rect = canvas.getBoundingClientRect();\r\n            canvas.width = rect.width * 2;\r\n            canvas.height = rect.height * 2;\r\n            ctx.scale(2, 2);\r\n            ctx.strokeStyle = \"#000000\";\r\n            ctx.lineWidth = 2;\r\n            ctx.lineCap = \"round\";\r\n            ctx.lineJoin = \"round\";\r\n            ctx.fillStyle = \"white\";\r\n            ctx.fillRect(0, 0, rect.width, rect.height);\r\n        }\r\n    }, [signatureMode]);\r\n\r\n    const getCoordinates = (e: React.MouseEvent | React.TouchEvent) => {\r\n        const canvas = canvasRef.current;\r\n        if (!canvas) return { x: 0, y: 0 };\r\n        const rect = canvas.getBoundingClientRect();\r\n        if (\"touches\" in e) {\r\n            return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };\r\n        }\r\n        return { x: e.clientX - rect.left, y: e.clientY - rect.top };\r\n    };\r\n\r\n    const startDrawing = (e: React.MouseEvent | React.TouchEvent) => {\r\n        e.preventDefault();\r\n        const ctx = canvasRef.current?.getContext(\"2d\");\r\n        if (!ctx) return;\r\n        const { x, y } = getCoordinates(e);\r\n        ctx.beginPath();\r\n        ctx.moveTo(x, y);\r\n        setIsDrawing(true);\r\n    };\r\n\r\n    const draw = (e: React.MouseEvent | React.TouchEvent) => {\r\n        if (!isDrawing) return;\r\n        e.preventDefault();\r\n        const ctx = canvasRef.current?.getContext(\"2d\");\r\n        if (!ctx) return;\r\n        const { x, y } = getCoordinates(e);\r\n        ctx.lineTo(x, y);\r\n        ctx.stroke();\r\n        setHasDrawn(true);\r\n    };\r\n\r\n    const stopDrawing = () => setIsDrawing(false);\r\n\r\n    const clearCanvas = () => {\r\n        const canvas = canvasRef.current;\r\n        const ctx = canvas?.getContext(\"2d\");\r\n        if (!ctx || !canvas) return;\r\n        const rect = canvas.getBoundingClientRect();\r\n        ctx.fillStyle = \"white\";\r\n        ctx.fillRect(0, 0, rect.width, rect.height);\r\n        setHasDrawn(false);\r\n        updateData(\"signatureUrl\", \"\");\r\n    };\r\n\r\n    const saveDrawnSignature = async () => {\r\n        const canvas = canvasRef.current;\r\n        if (!canvas) return;\r\n        setUploadingSignature(true);\r\n        canvas.toBlob(async (blob) => {\r\n            if (!blob) {\r\n                toast.error(\"Erreur lors de la cr√©ation de l'image\");\r\n                setUploadingSignature(false);\r\n                return;\r\n            }\r\n            try {\r\n                const file = new File([blob], \"signature.png\", { type: \"image/png\" });\r\n                const formData = new FormData();\r\n                formData.append(\"file\", file);\r\n                formData.append(\"type\", \"signature\");\r\n                const response = await fetch(\"/api/branding/upload\", { method: \"POST\", body: formData });\r\n                const result = await response.json();\r\n                if (result.success) {\r\n                    updateData(\"signatureUrl\", result.url);\r\n                    toast.success(\"Signature enregistr√©e!\");\r\n                } else {\r\n                    toast.error(result.error || \"Erreur lors de l'upload\");\r\n                }\r\n            } catch {\r\n                toast.error(\"Erreur lors de l'upload de la signature\");\r\n            } finally {\r\n                setUploadingSignature(false);\r\n            }\r\n        }, \"image/png\");\r\n    };\r\n\r\n    const handleFileUpload = async (file: File, type: \"logo\" | \"signature\") => {\r\n        const isLogo = type === \"logo\";\r\n        isLogo ? setUploadingLogo(true) : setUploadingSignature(true);\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append(\"file\", file);\r\n            formData.append(\"type\", type);\r\n            const response = await fetch(\"/api/branding/upload\", { method: \"POST\", body: formData });\r\n            const result = await response.json();\r\n            if (result.success) {\r\n                updateData(isLogo ? \"logoUrl\" : \"signatureUrl\", result.url);\r\n                toast.success(`${isLogo ? \"Logo\" : \"Signature\"} enregistr√©!`);\r\n            } else {\r\n                toast.error(result.error || \"Erreur lors de l'upload\");\r\n            }\r\n        } catch {\r\n            toast.error(\"Erreur lors de l'upload du fichier\");\r\n        } finally {\r\n            isLogo ? setUploadingLogo(false) : setUploadingSignature(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"text-center mb-6\">\r\n                <h2 className=\"text-2xl font-bold text-slate-900 dark:text-white\">Configurez votre Agence</h2>\r\n                <p className=\"text-slate-500 dark:text-gray-400\">Ces informations appara√Ætront sur vos contrats et quittances.</p>\r\n            </div>\r\n\r\n            {/* Info de base */}\r\n            <div className=\"grid gap-4\">\r\n                <div className=\"grid md:grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"companyName\">Nom de l&apos;agence</Label>\r\n                        <Input id=\"companyName\" placeholder=\"Ex: Immobili√®re du Sud\" value={data.companyName} onChange={(e) => updateData(\"companyName\", e.target.value)} className=\"h-11 bg-slate-50 dark:bg-gray-800\" />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"companyAddress\">Adresse du si√®ge</Label>\r\n                        <Input id=\"companyAddress\" placeholder=\"Ex: 123 Rue de la R√©publique\" value={data.companyAddress} onChange={(e) => updateData(\"companyAddress\", e.target.value)} className=\"h-11 bg-slate-50 dark:bg-gray-800\" />\r\n                    </div>\r\n                </div>\r\n                <div className=\"grid md:grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label>T√©l√©phone de l&apos;agence</Label>\r\n                        <PhoneInput placeholder=\"33 800 00 00\" value={data.companyPhone} onChange={(val) => updateData(\"companyPhone\", val)} className=\"bg-slate-50 dark:bg-gray-800\" defaultCountry=\"SN\" />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"companyNinea\">NINEA (optionnel)</Label>\r\n                        <Input id=\"companyNinea\" placeholder=\"Ex: 0000000 0 00\" value={data.companyNinea} onChange={(e) => updateData(\"companyNinea\", e.target.value)} className=\"h-11 bg-slate-50 dark:bg-gray-800\" />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Logo & Signature - Optionnel */}\r\n            <div className=\"border-t border-slate-200 dark:border-gray-700 pt-6\">\r\n                <p className=\"text-sm text-slate-500 dark:text-gray-400 mb-4 flex items-center gap-2\">\r\n                    <span className=\"text-xs bg-primary/10 dark:bg-primary/20 text-primary px-2 py-0.5 rounded-full\">Optionnel</span>\r\n                    Ajoutez votre logo et signature pour personnaliser vos documents\r\n                </p>\r\n                <div className=\"grid md:grid-cols-2 gap-4\">\r\n                    {/* Logo Upload */}\r\n                    <div className=\"p-4 bg-slate-50 dark:bg-gray-800/50 rounded-2xl border border-slate-200 dark:border-gray-700\">\r\n                        <div className=\"flex items-center gap-2 text-primary font-medium text-sm mb-3\">\r\n                            <Building2 className=\"w-4 h-4\" /> Logo de l&apos;Agence\r\n                        </div>\r\n                        <label className=\"block cursor-pointer\">\r\n                            <div className={`h-28 border-2 border-dashed rounded-xl flex flex-col items-center justify-center transition-all ${data.logoUrl ? \"border-primary/50 bg-primary/5\" : \"border-slate-300 dark:border-gray-600 hover:border-primary/50\"} ${uploadingLogo ? \"opacity-50\" : \"\"}`}>\r\n                                {data.logoUrl ? (\r\n                                    <img src={data.logoUrl} alt=\"Logo\" className=\"max-h-20 object-contain\" />\r\n                                ) : uploadingLogo ? (\r\n                                    <Loader2 className=\"w-6 h-6 animate-spin text-primary\" />\r\n                                ) : (\r\n                                    <>\r\n                                        <Upload className=\"w-6 h-6 text-gray-500 mb-1\" />\r\n                                        <p className=\"text-xs text-gray-500\">Cliquez pour ajouter</p>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                            <input type=\"file\" accept=\"image/*\" className=\"hidden\" onChange={(e) => e.target.files?.[0] && handleFileUpload(e.target.files[0], \"logo\")} disabled={uploadingLogo} />\r\n                        </label>\r\n                        {data.logoUrl && (\r\n                            <Button variant=\"ghost\" size=\"sm\" className=\"mt-2 text-red-400 text-xs\" onClick={() => updateData(\"logoUrl\", \"\")}>\r\n                                <Trash2 className=\"w-3 h-3 mr-1\" /> Supprimer\r\n                            </Button>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Signature Upload */}\r\n                    <div className=\"p-4 bg-slate-50 dark:bg-gray-800/50 rounded-2xl border border-slate-200 dark:border-gray-700\">\r\n                        <div className=\"flex items-center gap-2 text-purple-500 font-medium text-sm mb-3\">\r\n                            <PenTool className=\"w-4 h-4\" /> Signature Num√©rique\r\n                        </div>\r\n                        <div className=\"flex gap-1 p-0.5 bg-slate-200 dark:bg-gray-700 rounded-lg mb-3\">\r\n                            <button onClick={() => setSignatureMode(\"upload\")} className={`flex-1 py-1.5 px-2 rounded-md text-xs font-medium transition-all ${signatureMode === \"upload\" ? \"bg-purple-600 text-white\" : \"text-gray-500\"}`}>\r\n                                <Upload className=\"w-3 h-3 inline mr-1\" /> Importer\r\n                            </button>\r\n                            <button onClick={() => setSignatureMode(\"draw\")} className={`flex-1 py-1.5 px-2 rounded-md text-xs font-medium transition-all ${signatureMode === \"draw\" ? \"bg-purple-600 text-white\" : \"text-gray-500\"}`}>\r\n                                <PenTool className=\"w-3 h-3 inline mr-1\" /> Dessiner\r\n                            </button>\r\n                        </div>\r\n                        {signatureMode === \"upload\" ? (\r\n                            <label className=\"block cursor-pointer\">\r\n                                <div className={`h-24 border-2 border-dashed rounded-xl flex flex-col items-center justify-center transition-all ${data.signatureUrl ? \"border-purple-500/50 bg-purple-500/5\" : \"border-slate-300 dark:border-gray-600 hover:border-purple-500/50\"}`}>\r\n                                    {data.signatureUrl ? (\r\n                                        <img src={data.signatureUrl} alt=\"Signature\" className=\"max-h-16 object-contain\" />\r\n                                    ) : uploadingSignature ? (\r\n                                        <Loader2 className=\"w-6 h-6 animate-spin text-purple-500\" />\r\n                                    ) : (\r\n                                        <>\r\n                                            <Upload className=\"w-6 h-6 text-gray-500 mb-1\" />\r\n                                            <p className=\"text-xs text-gray-500\">Importez votre signature</p>\r\n                                        </>\r\n                                    )}\r\n                                </div>\r\n                                <input type=\"file\" accept=\"image/*\" className=\"hidden\" onChange={(e) => e.target.files?.[0] && handleFileUpload(e.target.files[0], \"signature\")} disabled={uploadingSignature} />\r\n                            </label>\r\n                        ) : (\r\n                            <div className=\"space-y-2\">\r\n                                <div className=\"relative\">\r\n                                    <canvas ref={canvasRef} className=\"w-full h-24 bg-white border rounded-xl cursor-crosshair touch-none\" onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={stopDrawing} onMouseLeave={stopDrawing} onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={stopDrawing} />\r\n                                    {!hasDrawn && <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\"><p className=\"text-gray-400 text-xs\">Signez ici</p></div>}\r\n                                </div>\r\n                                <div className=\"flex gap-2\">\r\n                                    <Button variant=\"outline\" size=\"sm\" onClick={clearCanvas} className=\"flex-1 text-xs h-8\">Effacer</Button>\r\n                                    <Button size=\"sm\" onClick={saveDrawnSignature} disabled={!hasDrawn || uploadingSignature} className=\"flex-1 bg-purple-600 hover:bg-purple-700 text-xs h-8\">\r\n                                        {uploadingSignature ? <Loader2 className=\"w-3 h-3 animate-spin\" /> : \"Valider\"}\r\n                                    </Button>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                        {data.signatureUrl && signatureMode === \"upload\" && (\r\n                            <Button variant=\"ghost\" size=\"sm\" className=\"mt-2 text-red-400 text-xs\" onClick={() => updateData(\"signatureUrl\", \"\")}>\r\n                                <Trash2 className=\"w-3 h-3 mr-1\" /> Supprimer\r\n                            </Button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Aper√ßu Document */}\r\n            {(data.logoUrl || data.signatureUrl || data.companyName) && (\r\n                <div className=\"p-4 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-gray-800/60 dark:to-gray-700/40 rounded-2xl\">\r\n                    <p className=\"text-sm font-medium text-slate-700 dark:text-gray-300 mb-3\">Aper√ßu sur vos documents</p>\r\n                    <div className=\"bg-white text-black rounded-xl p-4 text-sm\">\r\n                        <div className=\"flex items-center justify-between border-b border-gray-200 pb-3 mb-3\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                {data.logoUrl ? <img src={data.logoUrl} alt=\"Logo\" className=\"h-8 object-contain\" /> : <div className=\"w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-[8px] text-gray-400\">Logo</div>}\r\n                                <div>\r\n                                    <p className=\"font-bold text-xs\">{data.companyName || \"Votre agence\"}</p>\r\n                                    <p className=\"text-[9px] text-gray-500\">{data.companyAddress || \"Adresse\"} | {data.companyPhone || \"T√©l√©phone\"}</p>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"text-right\">\r\n                                <p className=\"text-[8px] text-gray-400\">QUITTANCE DE LOYER</p>\r\n                                <p className=\"text-xs font-bold text-green-600\">PAY√â ‚úì</p>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"text-center py-2 text-gray-400 text-xs\">[Contenu du document...]</div>\r\n                        <div className=\"flex justify-end pt-3 border-t border-gray-200\">\r\n                            {data.signatureUrl ? <img src={data.signatureUrl} alt=\"Signature\" className=\"h-10 object-contain\" /> : <div className=\"w-16 h-10 border-b-2 border-gray-300 flex items-end justify-center text-[8px] text-gray-400 pb-1\">Signature</div>}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n\r\nfunction StepGoals({ data, updateData }: { data: WizardData, updateData: any }) {\r\n    const teamSizes = [\r\n        { value: \"solo\", label: \"Solo\", description: \"Je travaille seul(e)\" },\r\n        { value: \"2-5\", label: \"2-5 personnes\", description: \"Petite √©quipe\" },\r\n        { value: \"5+\", label: \"5+ personnes\", description: \"Grande agence\" }\r\n    ];\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"text-center mb-8\">\r\n                <h2 className=\"text-2xl font-bold text-slate-900 dark:text-white\">Votre √âquipe</h2>\r\n                <p className=\"text-slate-500 dark:text-gray-400\">Combien de personnes travailleront sur ce compte ?</p>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                {teamSizes.map((size) => (\r\n                    <div\r\n                        key={size.value}\r\n                        onClick={() => updateData(\"teamSize\", size.value)}\r\n                        className={`relative p-6 rounded-xl border-2 cursor-pointer transition-all flex flex-col items-center justify-center gap-3 text-center h-32 ${data.teamSize === size.value\r\n                            ? \"border-primary bg-primary/10 dark:bg-primary/20\"\r\n                            : \"border-slate-200 dark:border-gray-800 hover:border-primary/50\"\r\n                            }`}\r\n                    >\r\n                        <span className=\"font-bold text-slate-900 dark:text-white text-lg\">{size.label}</span>\r\n                        <span className=\"text-xs text-slate-500 dark:text-gray-400\">{size.description}</span>\r\n                        {data.teamSize === size.value && (\r\n                            <div className=\"absolute top-2 right-2 w-5 h-5 bg-primary rounded-full flex items-center justify-center text-black\">\r\n                                <Check className=\"w-3 h-3\" strokeWidth={3} />\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                ))}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction StepConfirmation({ data, isLoggedIn }: { data: WizardData, isLoggedIn: boolean }) {\r\n    return (\r\n        <div className=\"space-y-6 text-center\">\r\n            <div className=\"w-20 h-20 bg-primary/10 dark:bg-primary/20 rounded-full flex items-center justify-center mx-auto text-primary mb-6\">\r\n                <Check className=\"w-10 h-10\" />\r\n            </div>\r\n\r\n            <h2 className=\"text-3xl font-bold text-slate-900 dark:text-white\">Tout est pr√™t !</h2>\r\n            <p className=\"text-lg text-slate-600 dark:text-gray-300 max-w-lg mx-auto\">\r\n                C&apos;est parti, {data.fullName.split(' ')[0]} ! <br />\r\n                En cliquant sur &quot;Commencer&quot;, nous allons cr√©er votre espace pour <strong>{data.companyName || \"votre agence\"}</strong>.\r\n            </p>\r\n\r\n            <div className=\"bg-slate-50 dark:bg-gray-800/50 p-6 rounded-2xl text-left max-w-sm mx-auto border border-slate-100 dark:border-gray-800\">\r\n                <div className=\"space-y-2 text-sm\">\r\n                    <div className=\"flex justify-between\">\r\n                        <span className=\"text-slate-500\">Email compte</span>\r\n                        <span className=\"font-medium\">{data.email}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between\">\r\n                        <span className=\"text-slate-500\">Formule</span>\r\n                        <span className=\"font-medium text-primary\">Essai Gratuit 14 jours</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            {!isLoggedIn && (\r\n                <p className=\"text-xs text-slate-400 dark:text-gray-500 mt-4\">\r\n                    En cr√©ant ce compte, vous acceptez nos conditions d&apos;utilisation et notre politique de confidentialit√©.\r\n                </p>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\payment\\KKiaPayWidget.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[476,479],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[476,479],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[614,617],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[614,617],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\payment\\PayDunyaRentButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\payment\\StripeRentButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\payment\\paydunya-iframe-payment.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\payment\\paydunya-onsite-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\payment\\paydunya-popup-payment.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\payment\\paydunya-psr-button.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1296,1299],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1296,1299],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1389,1392],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1389,1392],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\payment\\paydunya-sdk-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pdf\\DepositReceiptPDF.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":211,"column":29,"nodeType":"JSXOpeningElement","endLine":211,"endColumn":79},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":305,"column":25,"nodeType":"JSXOpeningElement","endLine":305,"endColumn":85}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';\n\n// Types\ninterface DepositReceiptData {\n    tenantName: string;\n    tenantEmail?: string;\n    tenantPhone?: string;\n    depositAmount: number;\n    depositMonths: number;\n    monthlyRent: number;\n    receiptNumber: string;\n    ownerName: string;\n    ownerAddress: string;\n    ownerNinea?: string;\n    ownerLogo?: string;\n    ownerSignature?: string;\n    propertyAddress: string;\n    leaseStartDate: string;\n}\n\n// Styles similaires √† QuittancePDF_v2 avec couleur dor√©e pour la caution\nconst styles = StyleSheet.create({\n    page: {\n        padding: 25,\n        fontSize: 9,\n        fontFamily: 'Helvetica',\n        lineHeight: 1.3,\n    },\n    header: {\n        flexDirection: 'row',\n        justifyContent: 'space-between',\n        marginBottom: 10,\n        paddingBottom: 8,\n        borderBottomWidth: 2,\n        borderBottomColor: '#B8860B', // Or fonc√© pour la caution\n    },\n    logo: {\n        width: 70,\n        height: 45,\n        objectFit: 'contain',\n    },\n    headerRight: {\n        textAlign: 'right',\n    },\n    companyName: {\n        fontSize: 13,\n        fontWeight: 'bold',\n        marginBottom: 3,\n    },\n    companyInfo: {\n        fontSize: 7,\n        color: '#666',\n    },\n    title: {\n        fontSize: 14,\n        fontWeight: 'bold',\n        textAlign: 'center',\n        marginBottom: 8,\n        textTransform: 'uppercase',\n        letterSpacing: 1.2,\n        backgroundColor: '#FFF8E1', // Fond or clair\n        padding: 6,\n        border: '1px solid #B8860B',\n        color: '#8B6914',\n    },\n    infoBlock: {\n        flexDirection: 'row',\n        justifyContent: 'space-between',\n        marginBottom: 8,\n    },\n    box: {\n        width: '48%',\n        padding: 8,\n        border: '1px solid #ddd',\n        borderRadius: 4,\n    },\n    boxHighlight: {\n        width: '48%',\n        padding: 8,\n        borderWidth: 1,\n        borderColor: '#B8860B',\n        borderRadius: 4,\n        backgroundColor: '#fffdf5',\n    },\n    boxTitle: {\n        fontSize: 7,\n        color: '#999',\n        textTransform: 'uppercase',\n        marginBottom: 5,\n        fontWeight: 'bold',\n    },\n    boxName: {\n        fontSize: 10,\n        fontWeight: 'bold',\n        marginBottom: 3,\n    },\n    boxText: {\n        fontSize: 8,\n        color: '#555',\n        marginBottom: 2,\n    },\n    propertyInfo: {\n        backgroundColor: '#f5f5f5',\n        padding: 6,\n        borderRadius: 4,\n        marginBottom: 8,\n        fontSize: 8,\n    },\n    legalText: {\n        fontSize: 8,\n        lineHeight: 1.4,\n        marginBottom: 10,\n        textAlign: 'justify',\n    },\n    amountBlock: {\n        backgroundColor: '#FFF8E1',\n        border: '2px solid #B8860B',\n        borderRadius: 6,\n        padding: 15,\n        marginVertical: 12,\n        alignItems: 'center',\n    },\n    amountLabel: {\n        fontSize: 9,\n        color: '#8B6914',\n        textTransform: 'uppercase',\n        marginBottom: 5,\n        fontWeight: 'bold',\n    },\n    amountValue: {\n        fontSize: 18,\n        fontWeight: 'bold',\n        color: '#8B6914',\n        marginBottom: 5,\n    },\n    amountDetail: {\n        fontSize: 8,\n        color: '#666',\n    },\n    legalNotice: {\n        backgroundColor: '#f9f9f9',\n        border: '1px solid #ddd',\n        borderRadius: 4,\n        padding: 10,\n        marginTop: 10,\n    },\n    legalNoticeTitle: {\n        fontSize: 8,\n        fontWeight: 'bold',\n        color: '#666',\n        marginBottom: 5,\n        textTransform: 'uppercase',\n    },\n    legalNoticeText: {\n        fontSize: 7,\n        color: '#555',\n        lineHeight: 1.4,\n        textAlign: 'justify',\n    },\n    signatureBlock: {\n        marginTop: 15,\n        alignItems: 'flex-end',\n    },\n    signatureLabel: {\n        fontSize: 8,\n        fontWeight: 'bold',\n        marginBottom: 5,\n    },\n    signature: {\n        width: 90,\n        height: 40,\n        objectFit: 'contain',\n    },\n    signaturePlaceholder: {\n        fontSize: 7,\n        color: '#ccc',\n        fontStyle: 'italic',\n        marginTop: 5,\n    },\n    footer: {\n        position: 'absolute',\n        bottom: 20,\n        left: 25,\n        right: 25,\n        textAlign: 'center',\n        fontSize: 6,\n        color: '#999',\n        borderTopWidth: 1,\n        borderTopColor: '#eee',\n        paddingTop: 10,\n    },\n});\n\n// Helper pour formater les montants\nconst formatAmount = (amount: number) => {\n    return new Intl.NumberFormat('fr-FR').format(amount);\n};\n\n// Fonction pour g√©n√©rer le Document PDF\nexport const createDepositReceiptDocument = (data: DepositReceiptData) => {\n    const today = new Date().toLocaleDateString('fr-FR');\n\n    return (\n        <Document>\n            <Page size=\"A4\" style={styles.page}>\n                {/* En-t√™te */}\n                <View style={styles.header}>\n                    <View>\n                        {data.ownerLogo && (\n                            <Image src={data.ownerLogo} style={styles.logo} />\n                        )}\n                        <Text style={styles.companyName}>{data.ownerName}</Text>\n                        {data.ownerAddress && (\n                            <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n                        )}\n                        {data.ownerNinea && (\n                            <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>\n                        )}\n                    </View>\n                    <View style={styles.headerRight}>\n                        <Text style={styles.companyInfo}>Re√ßu N¬∞</Text>\n                        <Text style={{ fontSize: 11, fontWeight: 'bold', marginBottom: 3, color: '#B8860B' }}>\n                            {data.receiptNumber}\n                        </Text>\n                        <Text style={styles.companyInfo}>Date d&apos;√©mission</Text>\n                        <Text style={{ fontSize: 9, fontWeight: 'bold' }}>{today}</Text>\n                    </View>\n                </View>\n\n                {/* Titre */}\n                <Text style={styles.title}>RE√áU DE D√âP√îT DE GARANTIE (CAUTION)</Text>\n\n                {/* Blocs d'infos */}\n                <View style={styles.infoBlock}>\n                    <View style={styles.box}>\n                        <Text style={styles.boxTitle}>Bailleur / Mandataire</Text>\n                        <Text style={styles.boxName}>{data.ownerName}</Text>\n                        {data.ownerAddress && (\n                            <Text style={styles.boxText}>{data.ownerAddress}</Text>\n                        )}\n                    </View>\n                    <View style={styles.boxHighlight}>\n                        <Text style={[styles.boxTitle, { color: '#B8860B' }]}>Locataire</Text>\n                        <Text style={styles.boxName}>{data.tenantName}</Text>\n                        {data.tenantEmail && (\n                            <Text style={styles.boxText}>{data.tenantEmail}</Text>\n                        )}\n                        {data.tenantPhone && (\n                            <Text style={styles.boxText}>{data.tenantPhone}</Text>\n                        )}\n                    </View>\n                </View>\n\n                {/* Adresse du bien */}\n                {data.propertyAddress && (\n                    <View style={styles.propertyInfo}>\n                        <Text>\n                            <Text style={{ fontWeight: 'bold' }}>Bien concern√© : </Text>\n                            {data.propertyAddress}\n                        </Text>\n                        <Text style={{ marginTop: 3 }}>\n                            <Text style={{ fontWeight: 'bold' }}>D√©but du bail : </Text>\n                            {data.leaseStartDate}\n                        </Text>\n                    </View>\n                )}\n\n                {/* Texte de reconnaissance */}\n                <Text style={styles.legalText}>\n                    Je soussign√©(e) <Text style={{ fontWeight: 'bold' }}>{data.ownerName}</Text>, propri√©taire ou mandataire\n                    du bien situ√© au <Text style={{ fontWeight: 'bold' }}>{data.propertyAddress}</Text>, reconnais avoir re√ßu de{' '}\n                    <Text style={{ fontWeight: 'bold' }}>{data.tenantName}</Text> la somme ci-dessous √† titre de d√©p√¥t de garantie\n                    (caution) conform√©ment au contrat de bail.\n                </Text>\n\n                {/* Bloc montant principal */}\n                <View style={styles.amountBlock}>\n                    <Text style={styles.amountLabel}>Montant du d√©p√¥t de garantie</Text>\n                    <Text style={styles.amountValue}>{formatAmount(data.depositAmount)} FCFA</Text>\n                    <Text style={styles.amountDetail}>\n                        ({data.depositMonths} mois √ó {formatAmount(data.monthlyRent)} FCFA de loyer mensuel)\n                    </Text>\n                </View>\n\n                {/* Mentions l√©gales */}\n                <View style={styles.legalNotice}>\n                    <Text style={styles.legalNoticeTitle}>Conditions de restitution</Text>\n                    <Text style={styles.legalNoticeText}>\n                        Ce d√©p√¥t de garantie sera restitu√© au locataire √† la fin du bail, dans un d√©lai maximum de deux mois\n                        suivant la remise des cl√©s, d√©duction faite, le cas √©ch√©ant, des sommes restant dues au bailleur et des\n                        sommes dont celui-ci pourrait √™tre tenu en lieu et place du locataire, sous r√©serve qu&apos;elles soient\n                        d√ªment justifi√©es (r√©parations locatives, loyers impay√©s, charges...).\n                    </Text>\n                    <Text style={[styles.legalNoticeText, { marginTop: 5 }]}>\n                        L&apos;√©tat des lieux de sortie servira de base √† la comparaison avec l&apos;√©tat des lieux d&apos;entr√©e\n                        pour d√©terminer les √©ventuelles retenues.\n                    </Text>\n                </View>\n\n                {/* Signature */}\n                <View style={styles.signatureBlock}>\n                    <Text style={styles.signatureLabel}>Le Bailleur (Signature)</Text>\n                    {data.ownerSignature ? (\n                        <Image src={data.ownerSignature} style={styles.signature} />\n                    ) : (\n                        <Text style={styles.signaturePlaceholder}>(Sign√© √©lectroniquement)</Text>\n                    )}\n                </View>\n\n                {/* Footer */}\n                <Text style={styles.footer}>\n                    Document g√©n√©r√© automatiquement par Dousell Immo pour {data.ownerName}.{'\\n'}\n                    Ce re√ßu fait foi de la r√©ception du d√©p√¥t de garantie pour le bien mentionn√© ci-dessus.\n                </Text>\n            </Page>\n        </Document>\n    );\n};\n\n// Export du type\nexport type { DepositReceiptData };\n\n// Composant React pour compatibilit√©\nexport const DepositReceiptPDF: React.FC<{ data: DepositReceiptData }> = ({ data }) => {\n    return createDepositReceiptDocument(data);\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pdf\\PaymentHistoryPDF.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":197,"column":29,"nodeType":"JSXOpeningElement","endLine":197,"endColumn":79}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';\n\n// Types\ninterface PaymentHistoryData {\n    tenantName: string;\n    tenantEmail?: string;\n    tenantPhone?: string;\n    propertyAddress: string;\n    ownerName: string;\n    ownerAddress: string;\n    ownerNinea?: string;\n    ownerLogo?: string;\n    transactions: {\n        id: string;\n        period: string;\n        amount: number;\n        amountPaid: number;\n        status: string;\n        paidAt?: string | null;\n    }[];\n}\n\n// Styles compacts pour tenir sur une page (bas√©s sur QuittancePDF_v2)\nconst styles = StyleSheet.create({\n    page: {\n        padding: 25,\n        fontSize: 9,\n        fontFamily: 'Helvetica',\n        lineHeight: 1.3,\n    },\n    header: {\n        flexDirection: 'row',\n        justifyContent: 'space-between',\n        marginBottom: 10,\n        paddingBottom: 8,\n        borderBottomWidth: 2,\n        borderBottomColor: '#F4C430',\n    },\n    logo: {\n        width: 70,\n        height: 45,\n        objectFit: 'contain',\n    },\n    headerRight: {\n        textAlign: 'right',\n    },\n    companyName: {\n        fontSize: 13,\n        fontWeight: 'bold',\n        marginBottom: 3,\n    },\n    companyInfo: {\n        fontSize: 7,\n        color: '#666',\n    },\n    title: {\n        fontSize: 14,\n        fontWeight: 'bold',\n        textAlign: 'center',\n        marginBottom: 15,\n        textTransform: 'uppercase',\n        letterSpacing: 1.2,\n        backgroundColor: '#f9f9f9',\n        padding: 6,\n        border: '1px solid #eee',\n    },\n    infoBlock: {\n        flexDirection: 'row',\n        justifyContent: 'space-between',\n        marginBottom: 20,\n    },\n    box: {\n        width: '48%',\n        padding: 8,\n        border: '1px solid #ddd',\n        borderRadius: 4,\n    },\n    boxHighlight: {\n        width: '48%',\n        padding: 8,\n        borderWidth: 1,\n        borderColor: '#F4C430',\n        borderRadius: 4,\n        backgroundColor: '#fffdf5',\n    },\n    boxTitle: {\n        fontSize: 7,\n        color: '#999',\n        textTransform: 'uppercase',\n        marginBottom: 5,\n        fontWeight: 'bold',\n    },\n    boxName: {\n        fontSize: 10,\n        fontWeight: 'bold',\n        marginBottom: 3,\n    },\n    boxText: {\n        fontSize: 8,\n        color: '#555',\n        marginBottom: 2,\n    },\n    table: {\n        marginTop: 8,\n        marginBottom: 10,\n    },\n    tableHeader: {\n        flexDirection: 'row',\n        backgroundColor: '#f9f9f9',\n        borderBottomWidth: 2,\n        borderBottomColor: '#F4C430',\n        paddingVertical: 5,\n        paddingHorizontal: 4,\n    },\n    tableRow: {\n        flexDirection: 'row',\n        borderBottomWidth: 1,\n        borderBottomColor: '#eee',\n        paddingVertical: 6,\n        paddingHorizontal: 4,\n    },\n    colPeriod: { width: '25%', fontSize: 8 },\n    colAmount: { width: '15%', fontSize: 8, textAlign: 'right' },\n    colPaid: { width: '15%', fontSize: 8, textAlign: 'right' },\n    colDate: { width: '25%', fontSize: 8, textAlign: 'right' },\n    colStatus: { width: '20%', fontSize: 8, textAlign: 'center' },\n\n    tableHeaderText: {\n        fontSize: 7,\n        color: '#666',\n        fontWeight: 'bold',\n        textTransform: 'uppercase',\n    },\n    footer: {\n        position: 'absolute',\n        bottom: 20,\n        left: 25,\n        right: 25,\n        textAlign: 'center',\n        fontSize: 6,\n        color: '#999',\n        borderTopWidth: 1,\n        borderTopColor: '#eee',\n        paddingTop: 10,\n    },\n    statusBadge: {\n        padding: '2 6',\n        borderRadius: 8,\n        fontSize: 7,\n        textTransform: 'uppercase',\n    },\n});\n\n// Helper pour formater les montants\nconst formatAmount = (amount: number) => {\n    return new Intl.NumberFormat('fr-FR').format(amount);\n};\n\nexport const createPaymentHistoryDocument = (data: PaymentHistoryData) => {\n    const today = new Date().toLocaleDateString('fr-FR');\n\n    const getStatusColor = (status: string) => {\n        switch (status) {\n            case 'paid': return '#e6fffa'; // Light green bg\n            case 'pending': return '#fffaf0'; // Light orange bg\n            case 'overdue': return '#fff5f5'; // Light red bg\n            default: return '#f7fafc';\n        }\n    };\n\n    const getStatusTextColor = (status: string) => {\n        switch (status) {\n            case 'paid': return '#2c7a7b'; // Dark green text\n            case 'pending': return '#dd6b20'; // Dark orange text\n            case 'overdue': return '#c53030'; // Dark red text\n            default: return '#718096';\n        }\n    };\n\n    const getStatusLabel = (status: string) => {\n        switch (status) {\n            case 'paid': return 'PAY√â';\n            case 'pending': return 'EN ATTENTE';\n            case 'overdue': return 'RETARD';\n            default: return status;\n        }\n    };\n\n    return (\n        <Document>\n            <Page size=\"A4\" style={styles.page}>\n                {/* En-t√™te (Copie de QuittancePDF) */}\n                <View style={styles.header}>\n                    <View>\n                        {data.ownerLogo && (\n                            <Image src={data.ownerLogo} style={styles.logo} />\n                        )}\n                        <Text style={styles.companyName}>{data.ownerName}</Text>\n                        {data.ownerAddress && (\n                            <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n                        )}\n                        {data.ownerNinea && (\n                            <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>\n                        )}\n                    </View>\n                    <View style={styles.headerRight}>\n                        <Text style={styles.companyInfo}>Date d&apos;√©mission</Text>\n                        <Text style={{ fontSize: 9, fontWeight: 'bold' }}>{today}</Text>\n                    </View>\n                </View>\n\n                {/* Titre */}\n                <Text style={styles.title}>HISTORIQUE DES PAIEMENTS</Text>\n\n                {/* Blocs d'infos */}\n                <View style={styles.infoBlock}>\n                    <View style={styles.box}>\n                        <Text style={styles.boxTitle}>Bailleur / Mandataire</Text>\n                        <Text style={styles.boxName}>{data.ownerName}</Text>\n                        {data.ownerAddress && (\n                            <Text style={styles.boxText}>{data.ownerAddress}</Text>\n                        )}\n                    </View>\n                    <View style={styles.boxHighlight}>\n                        <Text style={[styles.boxTitle, { color: '#B8860B' }]}>Locataire</Text>\n                        <Text style={styles.boxName}>{data.tenantName}</Text>\n                        {data.propertyAddress && (\n                            <Text style={styles.boxText}>{data.propertyAddress}</Text>\n                        )}\n                        {data.tenantEmail && (\n                            <Text style={styles.boxText}>{data.tenantEmail}</Text>\n                        )}\n                        {data.tenantPhone && (\n                            <Text style={styles.boxText}>{data.tenantPhone}</Text>\n                        )}\n                    </View>\n                </View>\n\n                {/* Tableau */}\n                <View style={styles.table}>\n                    <View style={styles.tableHeader}>\n                        <Text style={[styles.colPeriod, styles.tableHeaderText]}>P√©riode</Text>\n                        <Text style={[styles.colAmount, styles.tableHeaderText]}>Montant D√ª</Text>\n                        <Text style={[styles.colPaid, styles.tableHeaderText]}>Pay√©</Text>\n                        <Text style={[styles.colDate, styles.tableHeaderText]}>Date Paiement</Text>\n                        <Text style={[styles.colStatus, styles.tableHeaderText]}>Statut</Text>\n                    </View>\n\n                    {data.transactions.map((tx, index) => (\n                        <View key={index} style={styles.tableRow}>\n                            <Text style={styles.colPeriod}>{tx.period}</Text>\n                            <Text style={styles.colAmount}>{formatAmount(tx.amount)}</Text>\n                            <Text style={styles.colPaid}>{formatAmount(tx.amountPaid)}</Text>\n                            <Text style={styles.colDate}>{tx.paidAt ? new Date(tx.paidAt).toLocaleDateString('fr-FR') : '-'}</Text>\n                            <View style={[styles.colStatus, {\n                                backgroundColor: getStatusColor(tx.status),\n                                borderRadius: 4,\n                                paddingVertical: 1\n                            }]}>\n                                <Text style={{\n                                    color: getStatusTextColor(tx.status),\n                                    fontSize: 7,\n                                    fontWeight: 'bold',\n                                    textAlign: 'center'\n                                }}>\n                                    {getStatusLabel(tx.status)}\n                                </Text>\n                            </View>\n                        </View>\n                    ))}\n                </View>\n\n                {/* Footer */}\n                <Text style={styles.footer}>\n                    Document g√©n√©r√© automatiquement par Dousell Immo pour {data.ownerName}.{'\\n'}\n                    Pour faire valoir ce que de droit.\n                </Text>\n            </Page>\n        </Document>\n    );\n};\n\n// Composant React pour compatibilit√©\nexport const PaymentHistoryPDF: React.FC<{ data: PaymentHistoryData }> = ({ data }) => {\n    return createPaymentHistoryDocument(data);\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pdf\\PreavisPDF.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":231,"column":15,"nodeType":"JSXOpeningElement","endLine":231,"endColumn":65},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":315,"column":15,"nodeType":"JSXOpeningElement","endLine":315,"endColumn":80}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';\n\n// Types\ninterface PreaviseData {\n  // Informations bail\n  tenantName: string;\n  tenantEmail?: string;\n  tenantPhone?: string;\n  tenantAddress?: string;\n  propertyAddress: string;\n  monthlyAmount: number;\n  startDate: string;\n  endDate: string;\n\n  // Type de pr√©avis\n  noticeType: 'J-180' | 'J-90'; // 6 mois ou 3 mois\n  noticeDate: string; // Date d'√©mission du pr√©avis\n\n  // Informations propri√©taire\n  ownerName: string;\n  ownerAddress: string;\n  ownerEmail?: string;\n  ownerPhone?: string;\n  ownerNinea?: string;\n  ownerLogo?: string;\n  ownerSignature?: string;\n\n  // Num√©ro unique\n  noticeNumber: string;\n}\n\n// Styles professionnels pour document juridique\nconst styles = StyleSheet.create({\n  page: {\n    padding: 25,\n    fontSize: 9,\n    fontFamily: 'Helvetica',\n    lineHeight: 1.3,\n  },\n  header: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 12,\n    paddingBottom: 10,\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n  },\n  logo: {\n    width: 60,\n    height: 40,\n    objectFit: 'contain',\n  },\n  headerRight: {\n    textAlign: 'right',\n  },\n  companyName: {\n    fontSize: 11,\n    fontWeight: 'bold',\n    marginBottom: 2,\n  },\n  companyInfo: {\n    fontSize: 7,\n    color: '#666',\n    marginBottom: 1,\n  },\n  title: {\n    fontSize: 13,\n    fontWeight: 'bold',\n    textAlign: 'center',\n    marginTop: 15,\n    marginBottom: 12,\n    textTransform: 'uppercase',\n    textDecoration: 'underline',\n  },\n  subtitle: {\n    fontSize: 9,\n    textAlign: 'center',\n    color: '#666',\n    marginBottom: 15,\n  },\n  section: {\n    marginBottom: 12,\n  },\n  sectionTitle: {\n    fontSize: 10,\n    fontWeight: 'bold',\n    marginBottom: 6,\n    textTransform: 'uppercase',\n    color: '#333',\n  },\n  paragraph: {\n    fontSize: 9,\n    textAlign: 'justify',\n    marginBottom: 8,\n    lineHeight: 1.4,\n  },\n  infoBox: {\n    backgroundColor: '#f9f9f9',\n    padding: 8,\n    borderRadius: 4,\n    marginBottom: 10,\n    borderLeftWidth: 3,\n    borderLeftColor: '#F4C430',\n  },\n  infoRow: {\n    flexDirection: 'row',\n    marginBottom: 3,\n  },\n  infoLabel: {\n    fontSize: 8,\n    fontWeight: 'bold',\n    width: '35%',\n  },\n  infoValue: {\n    fontSize: 8,\n    width: '65%',\n  },\n  warningBox: {\n    backgroundColor: '#fff3cd',\n    padding: 8,\n    borderRadius: 4,\n    marginTop: 10,\n    marginBottom: 10,\n    borderWidth: 1,\n    borderColor: '#ffc107',\n  },\n  warningTitle: {\n    fontSize: 9,\n    fontWeight: 'bold',\n    color: '#856404',\n    marginBottom: 5,\n  },\n  warningText: {\n    fontSize: 8,\n    color: '#856404',\n    lineHeight: 1.3,\n  },\n  legalText: {\n    fontSize: 7,\n    color: '#666',\n    fontStyle: 'italic',\n    marginTop: 6,\n    marginBottom: 6,\n  },\n  signatureSection: {\n    marginTop: 20,\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n  },\n  signatureBox: {\n    width: '45%',\n  },\n  signatureLabel: {\n    fontSize: 9,\n    fontWeight: 'bold',\n    marginBottom: 3,\n  },\n  signatureText: {\n    fontSize: 8,\n    marginBottom: 2,\n  },\n  signatureImage: {\n    width: 100,\n    height: 45,\n    marginTop: 8,\n    objectFit: 'contain',\n  },\n  footer: {\n    position: 'absolute',\n    bottom: 20,\n    left: 25,\n    right: 25,\n    textAlign: 'center',\n    fontSize: 6,\n    color: '#999',\n    borderTopWidth: 1,\n    borderTopColor: '#eee',\n    paddingTop: 6,\n  },\n});\n\n// Contenu des pr√©avis selon le type\nconst getNoticeContent = (data: PreaviseData) => {\n  const isJ180 = data.noticeType === 'J-180';\n\n  return {\n    title: isJ180\n      ? 'PR√âAVIS DE CONG√â POUR REPRISE'\n      : 'NOTIFICATION DE RECONDUCTION TACITE',\n\n    subject: isJ180\n      ? 'Notification de Cong√© - 6 mois avant √©ch√©ance'\n      : 'Reconduction du bail - 3 mois avant √©ch√©ance',\n\n    mainText: isJ180\n      ? `Par la pr√©sente, je vous notifie mon intention de ne pas renouveler le bail de location concernant le bien situ√© ${data.propertyAddress}, dont le contrat arrivera √† √©ch√©ance le ${new Date(data.endDate).toLocaleDateString('fr-FR')}.\n\nConform√©ment aux dispositions de la loi s√©n√©galaise n¬∞ 2014-22 du 24 f√©vrier 2014 portant loi d'orientation sur l'habitat social et aux articles du Code des Obligations Civiles et Commerciales (COCC), je vous informe par la pr√©sente de ma d√©cision de reprendre les lieux lou√©s.\n\nCe pr√©avis respecte le d√©lai l√©gal de SIX (6) MOIS avant l'√©ch√©ance du bail, comme l'exige la l√©gislation en vigueur.`\n\n      : `Je vous informe que le bail de location concernant le bien situ√© ${data.propertyAddress} arrivera √† √©ch√©ance le ${new Date(data.endDate).toLocaleDateString('fr-FR')}.\n\nConform√©ment aux dispositions de la loi s√©n√©galaise n¬∞ 2014-22 du 24 f√©vrier 2014 et aux articles du Code des Obligations Civiles et Commerciales (COCC), en l'absence de cong√© signifi√© dans les d√©lais l√©gaux, le bail sera automatiquement reconduit aux m√™mes conditions.\n\nNous sommes dans le d√©lai de TROIS (3) MOIS avant l'√©ch√©ance, p√©riode durant laquelle vous pouvez encore manifester votre intention concernant le renouvellement du bail.`,\n\n    actionRequired: isJ180\n      ? `Vous √™tes pri√©(e) de lib√©rer les lieux au plus tard √† la date d'√©ch√©ance mentionn√©e ci-dessus, soit le ${new Date(data.endDate).toLocaleDateString('fr-FR')}.`\n      : `Si vous souhaitez donner cong√© ou n√©gocier de nouvelles conditions, veuillez me contacter dans les meilleurs d√©lais. √Ä d√©faut, le bail sera renouvel√© tacitement pour la m√™me dur√©e.`,\n\n    legalReference: isJ180\n      ? 'Article relatif au pr√©avis de cong√© - Loi n¬∞ 2014-22 du 24 f√©vrier 2014 & COCC S√©n√©gal'\n      : 'Article relatif √† la reconduction tacite - Loi n¬∞ 2014-22 du 24 f√©vrier 2014 & COCC S√©n√©gal'\n  };\n};\n\n// Document PDF\nconst PreaviseDocument = ({ data }: { data: PreaviseData }) => {\n  const content = getNoticeContent(data);\n  const formattedAmount = new Intl.NumberFormat('fr-FR').format(data.monthlyAmount);\n\n  return (\n    <Document>\n      <Page size=\"A4\" style={styles.page}>\n        {/* En-t√™te avec logo */}\n        <View style={styles.header}>\n          <View>\n            {data.ownerLogo ? (\n              <Image src={data.ownerLogo} style={styles.logo} />\n            ) : (\n              <Text style={styles.companyName}>{data.ownerName}</Text>\n            )}\n          </View>\n          <View style={styles.headerRight}>\n            <Text style={styles.companyName}>{data.ownerName}</Text>\n            <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n            {data.ownerEmail && <Text style={styles.companyInfo}>{data.ownerEmail}</Text>}\n            {data.ownerPhone && <Text style={styles.companyInfo}>{data.ownerPhone}</Text>}\n            {data.ownerNinea && <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>}\n          </View>\n        </View>\n\n        {/* Num√©ro et date */}\n        <View style={{ marginBottom: 20 }}>\n          <Text style={{ fontSize: 9, textAlign: 'right', color: '#666' }}>\n            Pr√©avis N¬∞ {data.noticeNumber}\n          </Text>\n          <Text style={{ fontSize: 9, textAlign: 'right', color: '#666' }}>\n            √âmis le {new Date(data.noticeDate).toLocaleDateString('fr-FR')}\n          </Text>\n        </View>\n\n        {/* Destinataire */}\n        <View style={styles.section}>\n          <Text style={{ fontSize: 10, marginBottom: 5 }}>√Ä l&apos;attention de :</Text>\n          <Text style={{ fontSize: 11, fontWeight: 'bold', marginBottom: 3 }}>{data.tenantName}</Text>\n          {data.tenantAddress && <Text style={{ fontSize: 9 }}>{data.tenantAddress}</Text>}\n        </View>\n\n        {/* Titre */}\n        <Text style={styles.title}>{content.title}</Text>\n        <Text style={styles.subtitle}>{content.subject}</Text>\n\n        {/* Informations du bail */}\n        <View style={styles.infoBox}>\n          <View style={styles.infoRow}>\n            <Text style={styles.infoLabel}>Bien lou√© :</Text>\n            <Text style={styles.infoValue}>{data.propertyAddress}</Text>\n          </View>\n          <View style={styles.infoRow}>\n            <Text style={styles.infoLabel}>Loyer mensuel :</Text>\n            <Text style={styles.infoValue}>{formattedAmount} FCFA</Text>\n          </View>\n          <View style={styles.infoRow}>\n            <Text style={styles.infoLabel}>Date de d√©but :</Text>\n            <Text style={styles.infoValue}>{new Date(data.startDate).toLocaleDateString('fr-FR')}</Text>\n          </View>\n          <View style={styles.infoRow}>\n            <Text style={styles.infoLabel}>Date d&apos;√©ch√©ance :</Text>\n            <Text style={styles.infoValue}>{new Date(data.endDate).toLocaleDateString('fr-FR')}</Text>\n          </View>\n          <View style={styles.infoRow}>\n            <Text style={styles.infoLabel}>Type de pr√©avis :</Text>\n            <Text style={styles.infoValue}>{data.noticeType === 'J-180' ? '6 mois (Cong√© pour reprise)' : '3 mois (Reconduction tacite)'}</Text>\n          </View>\n        </View>\n\n        {/* Corps du pr√©avis */}\n        <Text style={styles.paragraph}>{content.mainText}</Text>\n\n        {/* Action requise */}\n        <View style={styles.warningBox}>\n          <Text style={styles.warningTitle}>‚ö†Ô∏è ACTION REQUISE</Text>\n          <Text style={styles.warningText}>{content.actionRequired}</Text>\n        </View>\n\n        {/* R√©f√©rence l√©gale */}\n        <Text style={styles.legalText}>\n          {content.legalReference}\n        </Text>\n\n        {/* Formule de politesse */}\n        <Text style={styles.paragraph}>\n          Je vous prie d&apos;agr√©er, Madame, Monsieur, l&apos;expression de mes salutations distingu√©es.\n        </Text>\n\n        {/* Signatures */}\n        <View style={styles.signatureSection}>\n          <View style={styles.signatureBox}>\n            <Text style={styles.signatureLabel}>Le Propri√©taire</Text>\n            <Text style={styles.signatureText}>{data.ownerName}</Text>\n            {data.ownerSignature && (\n              <Image src={data.ownerSignature} style={styles.signatureImage} />\n            )}\n          </View>\n\n          <View style={styles.signatureBox}>\n            <Text style={styles.signatureLabel}>Le Locataire (pour r√©ception)</Text>\n            <Text style={styles.signatureText}>{data.tenantName}</Text>\n            <View style={{ height: 60, borderBottomWidth: 1, borderBottomColor: '#ddd', marginTop: 15 }} />\n            <Text style={{ fontSize: 8, color: '#999', marginTop: 5 }}>Signature et date</Text>\n          </View>\n        </View>\n\n        {/* Pied de page */}\n        <View style={styles.footer}>\n          <Text>Document g√©n√©r√© automatiquement par Dousell Immo</Text>\n          <Text>Conforme √† la loi n¬∞ 2014-22 du 24 f√©vrier 2014 & Code des Obligations Civiles et Commerciales du S√©n√©gal</Text>\n        </View>\n      </Page>\n    </Document>\n  );\n};\n\n// Export de la fonction de cr√©ation\nexport const createPreavisDocument = (data: PreaviseData) => {\n  return <PreaviseDocument data={data} />;\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pdf\\QuittancePDF.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":231,"column":15,"nodeType":"JSXOpeningElement","endLine":231,"endColumn":65},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":315,"column":13,"nodeType":"JSXOpeningElement","endLine":315,"endColumn":73},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":346,"column":15,"nodeType":"JSXOpeningElement","endLine":346,"endColumn":65},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":430,"column":13,"nodeType":"JSXOpeningElement","endLine":430,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';\n\n// Types\ninterface QuittanceData {\n  // Locataire\n  tenantName: string;\n  tenantEmail?: string;\n  tenantPhone?: string;\n  tenantAddress?: string;\n\n  // Montants\n  amount: number;\n\n  // P√©riode\n  periodMonth: string;\n  periodStart: string;\n  periodEnd: string;\n\n  // R√©f√©rence\n  receiptNumber: string;\n\n  // Propri√©taire\n  ownerName: string;\n  ownerAddress: string;\n  ownerNinea?: string;\n  ownerLogo?: string;\n  ownerSignature?: string;\n\n  // Propri√©t√©\n  propertyAddress: string;\n}\n\n// Styles\nconst styles = StyleSheet.create({\n  page: {\n    padding: 40,\n    fontSize: 11,\n    fontFamily: 'Helvetica',\n    lineHeight: 1.5,\n  },\n\n  // En-t√™te\n  header: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 30,\n    paddingBottom: 20,\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n  },\n  logo: {\n    width: 100,\n    height: 60,\n    objectFit: 'contain',\n  },\n  headerRight: {\n    textAlign: 'right',\n  },\n  companyName: {\n    fontSize: 16,\n    fontWeight: 'bold',\n    marginBottom: 5,\n  },\n  companyInfo: {\n    fontSize: 9,\n    color: '#666',\n  },\n\n  // Titre\n  title: {\n    fontSize: 20,\n    fontWeight: 'bold',\n    textAlign: 'center',\n    marginBottom: 30,\n    textTransform: 'uppercase',\n    letterSpacing: 2,\n    backgroundColor: '#f9f9f9',\n    padding: 15,\n    border: '1px solid #eee',\n  },\n\n  // Blocs d'infos\n  infoBlock: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 30,\n  },\n  box: {\n    width: '48%',\n    padding: 15,\n    border: '1px solid #ddd',\n    borderRadius: 4,\n  },\n  boxHighlight: {\n    width: '48%',\n    padding: 15,\n    borderWidth: 1,\n    borderColor: '#F4C430',\n    borderRadius: 4,\n    backgroundColor: '#fffdf5',\n  },\n  boxTitle: {\n    fontSize: 9,\n    color: '#999',\n    textTransform: 'uppercase',\n    marginBottom: 8,\n    fontWeight: 'bold',\n  },\n  boxName: {\n    fontSize: 12,\n    fontWeight: 'bold',\n    marginBottom: 5,\n  },\n  boxText: {\n    fontSize: 10,\n    color: '#555',\n    marginBottom: 3,\n  },\n\n  // Propri√©t√©\n  propertyInfo: {\n    backgroundColor: '#f5f5f5',\n    padding: 10,\n    borderRadius: 4,\n    marginBottom: 20,\n    fontSize: 10,\n  },\n\n  // Tableau\n  table: {\n    marginTop: 20,\n    marginBottom: 30,\n  },\n  tableHeader: {\n    flexDirection: 'row',\n    backgroundColor: '#f9f9f9',\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n    paddingVertical: 10,\n    paddingHorizontal: 10,\n  },\n  tableRow: {\n    flexDirection: 'row',\n    borderBottomWidth: 1,\n    borderBottomColor: '#eee',\n    paddingVertical: 12,\n    paddingHorizontal: 10,\n  },\n  tableTotalRow: {\n    flexDirection: 'row',\n    backgroundColor: '#FFF8E1',\n    paddingVertical: 12,\n    paddingHorizontal: 10,\n    fontWeight: 'bold',\n  },\n  col1: { width: '40%', fontSize: 10 },\n  col2: { width: '30%', fontSize: 10, textAlign: 'right' },\n  col3: { width: '30%', fontSize: 10, textAlign: 'right' },\n  tableHeaderText: {\n    fontSize: 9,\n    color: '#666',\n    fontWeight: 'bold',\n    textTransform: 'uppercase',\n  },\n\n  // Texte l√©gal\n  legalText: {\n    fontSize: 10,\n    lineHeight: 1.6,\n    marginBottom: 30,\n    textAlign: 'justify',\n  },\n\n  // Signature\n  signatureBlock: {\n    marginTop: 40,\n    alignItems: 'flex-end',\n  },\n  signatureLabel: {\n    fontSize: 10,\n    fontWeight: 'bold',\n    marginBottom: 10,\n  },\n  signature: {\n    width: 120,\n    height: 60,\n    objectFit: 'contain',\n  },\n  signaturePlaceholder: {\n    fontSize: 9,\n    color: '#ccc',\n    fontStyle: 'italic',\n    marginTop: 10,\n  },\n\n  // Footer\n  footer: {\n    position: 'absolute',\n    bottom: 30,\n    left: 40,\n    right: 40,\n    textAlign: 'center',\n    fontSize: 8,\n    color: '#999',\n    borderTopWidth: 1,\n    borderTopColor: '#eee',\n    paddingTop: 15,\n  },\n});\n\n// Export du type pour pouvoir l'utiliser ailleurs\nexport type { QuittanceData };\n\n// Fonction helper pour formater les montants\nconst formatAmount = (amount: number) => {\n  return new Intl.NumberFormat('fr-FR').format(amount);\n};\n\n// Fonction pour g√©n√©rer le Document PDF (pour l'API)\nexport const createQuittanceDocument = (data: QuittanceData) => {\n  const today = new Date().toLocaleDateString('fr-FR');\n\n  return (\n    <Document>\n      <Page size=\"A4\" style={styles.page}>\n        {/* En-t√™te */}\n        <View style={styles.header}>\n          <View>\n            {data.ownerLogo && (\n              <Image src={data.ownerLogo} style={styles.logo} />\n            )}\n            <Text style={styles.companyName}>{data.ownerName}</Text>\n            <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n            {data.ownerNinea && (\n              <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>\n            )}\n          </View>\n          <View style={styles.headerRight}>\n            <Text style={styles.companyInfo}>Quittance N¬∞</Text>\n            <Text style={{ fontSize: 12, fontWeight: 'bold', marginBottom: 5 }}>\n              {data.receiptNumber}\n            </Text>\n            <Text style={styles.companyInfo}>Date d&apos;√©mission</Text>\n            <Text style={{ fontSize: 10, fontWeight: 'bold' }}>{today}</Text>\n          </View>\n        </View>\n\n        {/* Titre */}\n        <Text style={styles.title}>QUITTANCE DE LOYER</Text>\n\n        {/* Blocs d'infos */}\n        <View style={styles.infoBlock}>\n          <View style={styles.box}>\n            <Text style={styles.boxTitle}>Bailleur / Mandataire</Text>\n            <Text style={styles.boxName}>{data.ownerName}</Text>\n            <Text style={styles.boxText}>{data.ownerAddress}</Text>\n          </View>\n          <View style={styles.boxHighlight}>\n            <Text style={[styles.boxTitle, { color: '#B8860B' }]}>Locataire</Text>\n            <Text style={styles.boxName}>{data.tenantName}</Text>\n            {data.tenantAddress && (\n              <Text style={styles.boxText}>{data.tenantAddress}</Text>\n            )}\n            {data.tenantEmail && (\n              <Text style={styles.boxText}>{data.tenantEmail}</Text>\n            )}\n            {data.tenantPhone && (\n              <Text style={styles.boxText}>{data.tenantPhone}</Text>\n            )}\n          </View>\n        </View>\n\n        {/* Adresse du bien */}\n        <View style={styles.propertyInfo}>\n          <Text>\n            <Text style={{ fontWeight: 'bold' }}>Adresse du bien lou√© : </Text>\n            {data.propertyAddress}\n          </Text>\n        </View>\n\n        {/* Texte l√©gal */}\n        <Text style={styles.legalText}>\n          Je soussign√©(e) <Text style={{ fontWeight: 'bold' }}>{data.ownerName}</Text>, propri√©taire ou mandataire du bien\n          situ√© au <Text style={{ fontWeight: 'bold' }}>{data.propertyAddress}</Text>, reconnais avoir re√ßu de{' '}\n          <Text style={{ fontWeight: 'bold' }}>{data.tenantName}</Text>, locataire dudit bien, la somme d√©taill√©e\n          ci-dessous au titre du loyer et des charges pour la p√©riode concern√©e.\n        </Text>\n\n        {/* Tableau */}\n        <View style={styles.table}>\n          <View style={styles.tableHeader}>\n            <Text style={[styles.col1, styles.tableHeaderText]}>D√©signation</Text>\n            <Text style={[styles.col2, styles.tableHeaderText]}>P√©riode</Text>\n            <Text style={[styles.col3, styles.tableHeaderText]}>Montant</Text>\n          </View>\n          <View style={styles.tableRow}>\n            <Text style={styles.col1}>Loyer et charges</Text>\n            <Text style={styles.col2}>Du {data.periodStart} au {data.periodEnd}</Text>\n            <Text style={styles.col3}>{formatAmount(data.amount)} FCFA</Text>\n          </View>\n          <View style={styles.tableTotalRow}>\n            <Text style={[styles.col1, { fontWeight: 'bold' }]}>TOTAL ACQUITT√â</Text>\n            <Text style={styles.col2}></Text>\n            <Text style={[styles.col3, { fontWeight: 'bold', fontSize: 12 }]}>\n              {formatAmount(data.amount)} FCFA\n            </Text>\n          </View>\n        </View>\n\n        {/* Signature */}\n        <View style={styles.signatureBlock}>\n          <Text style={styles.signatureLabel}>Le Bailleur (Signature)</Text>\n          {data.ownerSignature ? (\n            <Image src={data.ownerSignature} style={styles.signature} />\n          ) : (\n            <Text style={styles.signaturePlaceholder}>(Sign√© √©lectroniquement)</Text>\n          )}\n        </View>\n\n        {/* Footer */}\n        <Text style={styles.footer}>\n          Document g√©n√©r√© automatiquement par Dousell Immo pour {data.ownerName}.{'\\n'}\n          Pour faire valoir ce que de droit.\n        </Text>\n      </Page>\n    </Document>\n  );\n};\n\nexport const QuittancePDF: React.FC<{ data: QuittanceData }> = ({ data }) => {\n  return createQuittanceDocument(data);\n};\n\n// Ancienne version (gard√©e pour compatibilit√©)\nconst _QuittancePDFOld: React.FC<{ data: QuittanceData }> = ({ data }) => {\n  const today = new Date().toLocaleDateString('fr-FR');\n\n  return (\n    <Document>\n      <Page size=\"A4\" style={styles.page}>\n        {/* En-t√™te */}\n        <View style={styles.header}>\n          <View>\n            {data.ownerLogo && (\n              <Image src={data.ownerLogo} style={styles.logo} />\n            )}\n            <Text style={styles.companyName}>{data.ownerName}</Text>\n            <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n            {data.ownerNinea && (\n              <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>\n            )}\n          </View>\n          <View style={styles.headerRight}>\n            <Text style={styles.companyInfo}>Quittance N¬∞</Text>\n            <Text style={{ fontSize: 12, fontWeight: 'bold', marginBottom: 5 }}>\n              {data.receiptNumber}\n            </Text>\n            <Text style={styles.companyInfo}>Date d&apos;√©mission</Text>\n            <Text style={{ fontSize: 10, fontWeight: 'bold' }}>{today}</Text>\n          </View>\n        </View>\n\n        {/* Titre */}\n        <Text style={styles.title}>QUITTANCE DE LOYER</Text>\n\n        {/* Blocs d'infos */}\n        <View style={styles.infoBlock}>\n          <View style={styles.box}>\n            <Text style={styles.boxTitle}>Bailleur / Mandataire</Text>\n            <Text style={styles.boxName}>{data.ownerName}</Text>\n            <Text style={styles.boxText}>{data.ownerAddress}</Text>\n          </View>\n          <View style={styles.boxHighlight}>\n            <Text style={[styles.boxTitle, { color: '#B8860B' }]}>Locataire</Text>\n            <Text style={styles.boxName}>{data.tenantName}</Text>\n            {data.tenantAddress && (\n              <Text style={styles.boxText}>{data.tenantAddress}</Text>\n            )}\n            {data.tenantEmail && (\n              <Text style={styles.boxText}>{data.tenantEmail}</Text>\n            )}\n            {data.tenantPhone && (\n              <Text style={styles.boxText}>{data.tenantPhone}</Text>\n            )}\n          </View>\n        </View>\n\n        {/* Adresse du bien */}\n        <View style={styles.propertyInfo}>\n          <Text>\n            <Text style={{ fontWeight: 'bold' }}>Adresse du bien lou√© : </Text>\n            {data.propertyAddress}\n          </Text>\n        </View>\n\n        {/* Texte l√©gal */}\n        <Text style={styles.legalText}>\n          Je soussign√©(e) <Text style={{ fontWeight: 'bold' }}>{data.ownerName}</Text>, propri√©taire ou mandataire du bien\n          situ√© au <Text style={{ fontWeight: 'bold' }}>{data.propertyAddress}</Text>, reconnais avoir re√ßu de{' '}\n          <Text style={{ fontWeight: 'bold' }}>{data.tenantName}</Text>, locataire dudit bien, la somme d√©taill√©e\n          ci-dessous au titre du loyer et des charges pour la p√©riode concern√©e.\n        </Text>\n\n        {/* Tableau */}\n        <View style={styles.table}>\n          <View style={styles.tableHeader}>\n            <Text style={[styles.col1, styles.tableHeaderText]}>D√©signation</Text>\n            <Text style={[styles.col2, styles.tableHeaderText]}>P√©riode</Text>\n            <Text style={[styles.col3, styles.tableHeaderText]}>Montant</Text>\n          </View>\n          <View style={styles.tableRow}>\n            <Text style={styles.col1}>Loyer et charges</Text>\n            <Text style={styles.col2}>Du {data.periodStart} au {data.periodEnd}</Text>\n            <Text style={styles.col3}>{formatAmount(data.amount)} FCFA</Text>\n          </View>\n          <View style={styles.tableTotalRow}>\n            <Text style={[styles.col1, { fontWeight: 'bold' }]}>TOTAL ACQUITT√â</Text>\n            <Text style={styles.col2}></Text>\n            <Text style={[styles.col3, { fontWeight: 'bold', fontSize: 12 }]}>\n              {formatAmount(data.amount)} FCFA\n            </Text>\n          </View>\n        </View>\n\n        {/* Signature */}\n        <View style={styles.signatureBlock}>\n          <Text style={styles.signatureLabel}>Le Bailleur (Signature)</Text>\n          {data.ownerSignature ? (\n            <Image src={data.ownerSignature} style={styles.signature} />\n          ) : (\n            <Text style={styles.signaturePlaceholder}>(Sign√© √©lectroniquement)</Text>\n          )}\n        </View>\n\n        {/* Footer */}\n        <Text style={styles.footer}>\n          Document g√©n√©r√© automatiquement par Dousell Immo pour {data.ownerName}.{'\\n'}\n          Pour faire valoir ce que de droit.\n        </Text>\n      </Page>\n    </Document>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pdf\\QuittancePDF_v2.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":203,"column":15,"nodeType":"JSXOpeningElement","endLine":203,"endColumn":65},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":302,"column":13,"nodeType":"JSXOpeningElement","endLine":302,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport { Document, Page, Text, View, StyleSheet, Image } from '@react-pdf/renderer';\n\n// Types\ninterface QuittanceData {\n  tenantName: string;\n  tenantEmail?: string;\n  tenantPhone?: string;\n  tenantAddress?: string;\n  amount: number;\n  periodMonth: string;\n  periodStart: string;\n  periodEnd: string;\n  receiptNumber: string;\n  ownerName: string;\n  ownerAddress: string;\n  ownerNinea?: string;\n  ownerLogo?: string;\n  ownerSignature?: string;\n  propertyAddress: string;\n  /** If true, this is a guarantee/deposit payment, not rent */\n  isGuarantee?: boolean;\n}\n\n// Styles compacts pour tenir sur une page\nconst styles = StyleSheet.create({\n  page: {\n    padding: 25,\n    fontSize: 9,\n    fontFamily: 'Helvetica',\n    lineHeight: 1.3,\n  },\n  header: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 10,\n    paddingBottom: 8,\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n  },\n  logo: {\n    width: 70,\n    height: 45,\n    objectFit: 'contain',\n  },\n  headerRight: {\n    textAlign: 'right',\n  },\n  companyName: {\n    fontSize: 13,\n    fontWeight: 'bold',\n    marginBottom: 3,\n  },\n  companyInfo: {\n    fontSize: 7,\n    color: '#666',\n  },\n  title: {\n    fontSize: 14,\n    fontWeight: 'bold',\n    textAlign: 'center',\n    marginBottom: 8,\n    textTransform: 'uppercase',\n    letterSpacing: 1.2,\n    backgroundColor: '#f9f9f9',\n    padding: 6,\n    border: '1px solid #eee',\n  },\n  infoBlock: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 8,\n  },\n  box: {\n    width: '48%',\n    padding: 8,\n    border: '1px solid #ddd',\n    borderRadius: 4,\n  },\n  boxHighlight: {\n    width: '48%',\n    padding: 8,\n    borderWidth: 1,\n    borderColor: '#F4C430',\n    borderRadius: 4,\n    backgroundColor: '#fffdf5',\n  },\n  boxTitle: {\n    fontSize: 7,\n    color: '#999',\n    textTransform: 'uppercase',\n    marginBottom: 5,\n    fontWeight: 'bold',\n  },\n  boxName: {\n    fontSize: 10,\n    fontWeight: 'bold',\n    marginBottom: 3,\n  },\n  boxText: {\n    fontSize: 8,\n    color: '#555',\n    marginBottom: 2,\n  },\n  propertyInfo: {\n    backgroundColor: '#f5f5f5',\n    padding: 6,\n    borderRadius: 4,\n    marginBottom: 8,\n    fontSize: 8,\n  },\n  legalText: {\n    fontSize: 8,\n    lineHeight: 1.4,\n    marginBottom: 10,\n    textAlign: 'justify',\n  },\n  table: {\n    marginTop: 8,\n    marginBottom: 10,\n  },\n  tableHeader: {\n    flexDirection: 'row',\n    backgroundColor: '#f9f9f9',\n    borderBottomWidth: 2,\n    borderBottomColor: '#F4C430',\n    paddingVertical: 5,\n    paddingHorizontal: 8,\n  },\n  tableRow: {\n    flexDirection: 'row',\n    borderBottomWidth: 1,\n    borderBottomColor: '#eee',\n    paddingVertical: 6,\n    paddingHorizontal: 8,\n  },\n  tableTotalRow: {\n    flexDirection: 'row',\n    backgroundColor: '#FFF8E1',\n    paddingVertical: 6,\n    paddingHorizontal: 8,\n    fontWeight: 'bold',\n  },\n  col1: { width: '40%', fontSize: 8 },\n  col2: { width: '30%', fontSize: 8, textAlign: 'right' },\n  col3: { width: '30%', fontSize: 8, textAlign: 'right' },\n  tableHeaderText: {\n    fontSize: 7,\n    color: '#666',\n    fontWeight: 'bold',\n    textTransform: 'uppercase',\n  },\n  signatureBlock: {\n    marginTop: 12,\n    alignItems: 'flex-end',\n  },\n  signatureLabel: {\n    fontSize: 8,\n    fontWeight: 'bold',\n    marginBottom: 5,\n  },\n  signature: {\n    width: 90,\n    height: 40,\n    objectFit: 'contain',\n  },\n  signaturePlaceholder: {\n    fontSize: 7,\n    color: '#ccc',\n    fontStyle: 'italic',\n    marginTop: 5,\n  },\n  footer: {\n    position: 'absolute',\n    bottom: 20,\n    left: 25,\n    right: 25,\n    textAlign: 'center',\n    fontSize: 6,\n    color: '#999',\n    borderTopWidth: 1,\n    borderTopColor: '#eee',\n    paddingTop: 10,\n  },\n});\n\n// Helper pour formater les montants\nconst formatAmount = (amount: number) => {\n  return new Intl.NumberFormat('fr-FR').format(amount);\n};\n\n// Fonction pour g√©n√©rer le Document PDF\nexport const createQuittanceDocument = (data: QuittanceData) => {\n  const today = new Date().toLocaleDateString('fr-FR');\n\n  return (\n    <Document>\n      <Page size=\"A4\" style={styles.page}>\n        {/* En-t√™te */}\n        <View style={styles.header}>\n          <View>\n            {data.ownerLogo && (\n              <Image src={data.ownerLogo} style={styles.logo} />\n            )}\n            <Text style={styles.companyName}>{data.ownerName}</Text>\n            {data.ownerAddress && (\n              <Text style={styles.companyInfo}>{data.ownerAddress}</Text>\n            )}\n            {data.ownerNinea && (\n              <Text style={styles.companyInfo}>NINEA: {data.ownerNinea}</Text>\n            )}\n          </View>\n          <View style={styles.headerRight}>\n            <Text style={styles.companyInfo}>Quittance N¬∞</Text>\n            <Text style={{ fontSize: 11, fontWeight: 'bold', marginBottom: 3 }}>\n              {data.receiptNumber}\n            </Text>\n            <Text style={styles.companyInfo}>Date d&apos;√©mission</Text>\n            <Text style={{ fontSize: 9, fontWeight: 'bold' }}>{today}</Text>\n          </View>\n        </View>\n\n        {/* Titre */}\n        <Text style={styles.title}>\n          {data.isGuarantee ? 'ATTESTATION DE D√âP√îT DE GARANTIE' : 'QUITTANCE DE LOYER'}\n        </Text>\n\n        {/* Blocs d'infos */}\n        <View style={styles.infoBlock}>\n          <View style={styles.box}>\n            <Text style={styles.boxTitle}>Bailleur / Mandataire</Text>\n            <Text style={styles.boxName}>{data.ownerName}</Text>\n            {data.ownerAddress && (\n              <Text style={styles.boxText}>{data.ownerAddress}</Text>\n            )}\n          </View>\n          <View style={styles.boxHighlight}>\n            <Text style={[styles.boxTitle, { color: '#B8860B' }]}>Locataire</Text>\n            <Text style={styles.boxName}>{data.tenantName}</Text>\n            {data.tenantAddress && data.tenantAddress !== 'Adresse non renseign√©e' && (\n              <Text style={styles.boxText}>{data.tenantAddress}</Text>\n            )}\n            {data.tenantEmail && (\n              <Text style={styles.boxText}>{data.tenantEmail}</Text>\n            )}\n            {data.tenantPhone && (\n              <Text style={styles.boxText}>{data.tenantPhone}</Text>\n            )}\n          </View>\n        </View>\n\n        {/* Adresse du bien - Seulement si renseign√©e */}\n        {data.propertyAddress && data.propertyAddress !== 'Adresse non renseign√©e' && (\n          <View style={styles.propertyInfo}>\n            <Text>\n              <Text style={{ fontWeight: 'bold' }}>Adresse du bien lou√© : </Text>\n              {data.propertyAddress}\n            </Text>\n          </View>\n        )}\n\n        {/* Texte l√©gal */}\n        <Text style={styles.legalText}>\n          Je soussign√©(e) <Text style={{ fontWeight: 'bold' }}>{data.ownerName}</Text>, propri√©taire ou mandataire\n          {data.propertyAddress && data.propertyAddress !== 'Adresse non renseign√©e' ? (\n            <> du bien situ√© au <Text style={{ fontWeight: 'bold' }}>{data.propertyAddress}</Text></>\n          ) : ''}, reconnais avoir re√ßu de{' '}\n          <Text style={{ fontWeight: 'bold' }}>{data.tenantName}</Text>, locataire dudit bien, la somme d√©taill√©e\n          ci-dessous {data.isGuarantee\n            ? 'au titre du d√©p√¥t de garantie.'\n            : 'au titre du loyer et des charges pour la p√©riode concern√©e.'\n          }\n        </Text>\n\n        {/* Tableau */}\n        <View style={styles.table}>\n          <View style={styles.tableHeader}>\n            <Text style={[styles.col1, styles.tableHeaderText]}>D√©signation</Text>\n            <Text style={[styles.col2, styles.tableHeaderText]}>P√©riode</Text>\n            <Text style={[styles.col3, styles.tableHeaderText]}>Montant</Text>\n          </View>\n          <View style={styles.tableRow}>\n            <Text style={styles.col1}>{data.isGuarantee ? 'D√©p√¥t de garantie' : 'Loyer et charges'}</Text>\n            <Text style={styles.col2}>\n              {data.isGuarantee ? data.periodMonth : `Du ${data.periodStart} au ${data.periodEnd}`}\n            </Text>\n            <Text style={styles.col3}>{formatAmount(data.amount)} FCFA</Text>\n          </View>\n          <View style={styles.tableTotalRow}>\n            <Text style={[styles.col1, { fontWeight: 'bold' }]}>TOTAL ACQUITT√â</Text>\n            <Text style={styles.col2}></Text>\n            <Text style={[styles.col3, { fontWeight: 'bold', fontSize: 10 }]}>\n              {formatAmount(data.amount)} FCFA\n            </Text>\n          </View>\n        </View>\n\n        {/* Signature */}\n        <View style={styles.signatureBlock}>\n          <Text style={styles.signatureLabel}>Le Bailleur (Signature)</Text>\n          {data.ownerSignature ? (\n            <Image src={data.ownerSignature} style={styles.signature} />\n          ) : (\n            <Text style={styles.signaturePlaceholder}>(Sign√© √©lectroniquement)</Text>\n          )}\n        </View>\n\n        {/* Footer */}\n        <Text style={styles.footer}>\n          Document g√©n√©r√© automatiquement par Dousell Immo pour {data.ownerName}.{'\\n'}\n          Pour faire valoir ce que de droit.\n        </Text>\n      </Page>\n    </Document>\n  );\n};\n\n// Export du type\nexport type { QuittanceData };\n\n// Composant React pour compatibilit√©\nexport const QuittancePDF: React.FC<{ data: QuittanceData }> = ({ data }) => {\n  return createQuittanceDocument(data);\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\OwnerCTA.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\agent-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\booking-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\contact-bar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\cost-simulator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\external-property-teaser.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\gallery-grid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\listing-image-carousel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\management-promo-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-card-unified.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-detail-view.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-gallery.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-info.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\property-lightbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\proximities-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\review-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\review-item.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\share-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\similar-properties.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\static-map.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\property\\static-map.tsx:37:7\n  35 |   useEffect(() => {\n  36 |     if (!hasValidCoords) {\n> 37 |       setMapUrl(null);\n     |       ^^^^^^^^^ Avoid calling setState() directly within an effect\n  38 |       return;\n  39 |     }\n  40 |","line":37,"column":7,"nodeType":null,"endLine":37,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Image from \"next/image\";\nimport { _ExternalLink, MapPin, Navigation } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\nimport { useState, useEffect, useMemo } from \"react\";\n\nimport { Button } from \"@/components/ui/button\";\n\ntype StaticMapProps = {\n  coords: { lat: number; lng: number };\n  city: string;\n  address?: string;\n  landmark?: string;\n};\n\nexport const StaticMap = ({ coords, city, address, landmark }: StaticMapProps) => {\n  const [mapUrl, setMapUrl] = useState<string | null>(null);\n  const [mapError, setMapError] = useState(false);\n\n  // V√©rifier si les coordonn√©es sont valides\n  const hasValidCoords = useMemo(() => {\n    if (!coords) return false;\n    return coords.lat !== 0 && coords.lng !== 0 &&\n      !isNaN(coords.lat) && !isNaN(coords.lng) &&\n      coords.lat >= -90 && coords.lat <= 90 &&\n      coords.lng >= -180 && coords.lng <= 180;\n  }, [coords]);\n\n  const mapsLink = hasValidCoords && coords\n    ? `https://www.google.com/maps?q=${coords.lat},${coords.lng}`\n    : `https://www.google.com/maps/search/${encodeURIComponent(city + (address ? `, ${address}` : \"\"))}`;\n\n  // Construire l'URL de la carte avec CartoDB Dark Matter (comme la carte principale)\n  useEffect(() => {\n    if (!hasValidCoords) {\n      setMapUrl(null);\n      return;\n    }\n\n    const mapboxToken = process.env.NEXT_PUBLIC_MAPBOX_TOKEN;\n    const googleApiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_KEY;\n\n    if (mapboxToken && coords) {\n      // Utiliser Mapbox avec style dark (comme la carte principale)\n      const mapboxMapUrl = `https://api.mapbox.com/styles/v1/mapbox/dark-v11/static/pin-s+3B82F6(${coords.lng},${coords.lat})/${coords.lng},${coords.lat},15/800x400@2x?access_token=${mapboxToken}`;\n      setMapUrl(mapboxMapUrl);\n    } else if (googleApiKey && coords) {\n      // Utiliser Google Maps Static API avec un style sombre\n      const googleMapUrl = new URL(\"https://maps.googleapis.com/maps/api/staticmap\");\n      googleMapUrl.searchParams.set(\"center\", `${coords.lat},${coords.lng}`);\n      googleMapUrl.searchParams.set(\"zoom\", \"15\");\n      googleMapUrl.searchParams.set(\"size\", \"800x400\");\n      googleMapUrl.searchParams.set(\"scale\", \"2\");\n      googleMapUrl.searchParams.set(\"format\", \"jpg\");\n      googleMapUrl.searchParams.set(\"maptype\", \"roadmap\");\n\n      // Style sombre pour correspondre au th√®me\n      googleMapUrl.searchParams.set(\n        \"style\",\n        \"feature:all|element:labels|visibility:simplified|feature:poi|visibility:off|feature:road|element:labels|visibility:off|feature:water|color:0x1a1a2e|feature:landscape|color:0x16213e\"\n      );\n\n      // Marqueur personnalis√©\n      googleMapUrl.searchParams.set(\n        \"markers\",\n        `color:0x3B82F6|size:mid|${coords.lat},${coords.lng}`\n      );\n\n      googleMapUrl.searchParams.set(\"key\", googleApiKey);\n      setMapUrl(googleMapUrl.toString());\n    }\n  }, [hasValidCoords, coords]);\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      whileInView={{ opacity: 1, y: 0 }}\n      viewport={{ once: true, amount: 0.4 }}\n      className=\"space-y-4 rounded-3xl border border-gray-100 bg-gray-50 p-6 dark:border-white/10 dark:bg-white/5\"\n    >\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n        <div className=\"flex-1\">\n          <p className=\"text-xs uppercase tracking-[0.3em] text-gray-500 dark:text-white/50\">\n            LOCALISATION\n          </p>\n          <h3 className=\"mt-1 text-2xl font-semibold text-gray-900 dark:text-white\">\n            {city}\n          </h3>\n          {address && (\n            <p className=\"mt-1 flex items-center gap-2 text-sm text-gray-600 dark:text-white/70\">\n              <MapPin className=\"h-4 w-4 shrink-0\" />\n              <span>{address}</span>\n            </p>\n          )}\n          {landmark && (\n            <p className=\"mt-1 text-sm text-gray-500 dark:text-white/60\">\n              {landmark}\n            </p>\n          )}\n        </div>\n        <Button\n          variant=\"secondary\"\n          className=\"shrink-0 rounded-2xl border border-gray-200 bg-white text-sm font-medium text-gray-900 hover:bg-gray-100 dark:border-white/20 dark:bg-transparent dark:text-white dark:hover:bg-white/10\"\n          asChild\n        >\n          <a href={mapsLink} target=\"_blank\" rel=\"noreferrer\" className=\"flex items-center gap-2\">\n            <Navigation className=\"h-4 w-4\" />\n            Ouvrir Maps\n          </a>\n        </Button>\n      </div>\n\n      <div className=\"relative h-64 w-full overflow-hidden rounded-2xl border border-gray-200 bg-gray-100 dark:border-white/10 dark:bg-gray-900\">\n        {hasValidCoords && mapUrl && !mapError ? (\n          <>\n            <Image\n              src={mapUrl}\n              alt={`Carte de ${city}`}\n              fill\n              className=\"object-cover\"\n              sizes=\"(max-width: 768px) 100vw, 800px\"\n              quality={90}\n              onError={() => setMapError(true)}\n              priority={false}\n            />\n            {/* Marqueur personnalis√© au centre */}\n            <div className=\"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2\">\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 animate-ping rounded-full bg-blue-500/30\" />\n                <div className=\"relative h-8 w-8 rounded-full bg-blue-500 shadow-lg ring-2 ring-white dark:ring-gray-900\" />\n                <div className=\"absolute left-1/2 top-1/2 h-3 w-3 -translate-x-1/2 -translate-y-1/2 rounded-full bg-white\" />\n              </div>\n            </div>\n            {/* Coordonn√©es en bas √† droite */}\n            <div className=\"absolute bottom-3 right-3 rounded-lg bg-black/70 px-3 py-1.5 text-xs font-mono text-white/90 backdrop-blur-sm\">\n              {coords.lat.toFixed(6)}, {coords.lng.toFixed(6)}\n            </div>\n          </>\n        ) : (\n          <div className=\"flex h-full w-full flex-col items-center justify-center bg-gradient-to-br from-gray-100 via-gray-50 to-gray-100 p-6 dark:from-gray-800 dark:via-gray-900 dark:to-gray-800\">\n            <div className=\"mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-gray-200 dark:bg-white/10\">\n              <MapPin className=\"h-8 w-8 text-gray-400 dark:text-white/30\" />\n            </div>\n            <div className=\"text-center\">\n              <p className=\"text-sm font-medium text-gray-600 dark:text-white/60\">\n                {hasValidCoords ? \"Carte non disponible\" : \"Coordonn√©es non disponibles\"}\n              </p>\n              <p className=\"mt-1 text-xs text-gray-500 dark:text-white/40\">\n                {hasValidCoords\n                  ? 'Cliquez sur \"Ouvrir Maps\" pour voir la localisation'\n                  : 'Les coordonn√©es GPS ne sont pas configur√©es pour ce bien'}\n              </p>\n            </div>\n          </div>\n        )}\n      </div>\n    </motion.div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\providers\\onesignal-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\providers\\splash-provider.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\providers\\splash-provider.tsx:87:5\n  85 |\n  86 |     // PWA + premi√®re visite ‚Üí activer le splash\n> 87 |     setShowSplash(true);\n     |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  88 |     setIsPWASplashActive(true);\n  89 |     document.body.style.overflow = \"hidden\";\n  90 |","line":87,"column":5,"nodeType":null,"endLine":87,"endColumn":18},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\providers\\splash-provider.tsx:111:7\n  109 |   useEffect(() => {\n  110 |     if (isPWASplashActive && !authLoading && minDurationPassed) {\n> 111 |       setShowSplash(false);\n      |       ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  112 |       setIsPWASplashActive(false);\n  113 |       removeSplashBlocker();\n  114 |       document.body.style.overflow = \"\";","line":111,"column":7,"nodeType":null,"endLine":111,"endColumn":20}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { AnimatePresence } from \"framer-motion\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { SplashScreen } from \"@/components/ui/splash-screen\";\n\nconst MIN_SPLASH_DURATION = 1600; // ms - Toujours montrer au moins 1.6s\nconst MAX_SPLASH_TIMEOUT = 5000; // ms - S√©curit√© pour ne pas bloquer l'utilisateur\nconst SESSION_KEY = \"doussel_splash_shown\";\n\ninterface SplashProviderProps {\n  children: React.ReactNode | React.ReactNode[];\n  /** Si true, affiche le splash √† chaque visite (pas seulement la premi√®re) */\n  showEveryVisit?: boolean;\n  /** Dur√©e personnalis√©e en ms */\n  duration?: number;\n}\n\n/**\n * Supprime le blocker HTML cr√©√© par le script inline dans layout.tsx\n */\nconst removeSplashBlocker = () => {\n  if (typeof document === 'undefined') return;\n\n  const blocker = document.getElementById(\"splash-blocker\");\n  if (blocker) {\n    blocker.remove();\n  }\n\n  const styleBlocker = document.getElementById(\"splash-style-blocker\");\n  if (styleBlocker) {\n    styleBlocker.remove();\n  }\n\n  document.documentElement.style.overflow = \"\";\n};\n\n/**\n * D√©tecte si l'app tourne en mode PWA standalone\n * (install√©e sur l'√©cran d'accueil)\n */\nconst checkIsPWA = (): boolean => {\n  if (typeof window === \"undefined\") return false;\n  return (\n    window.matchMedia(\"(display-mode: standalone)\").matches ||\n    (window.navigator as Navigator & { standalone?: boolean }).standalone === true\n  );\n};\n\n/**\n * SplashProvider - G√®re l'affichage du splash screen au chargement\n * \n * En mode navigateur classique : le splash est totalement d√©sactiv√©.\n * En mode PWA (app install√©e) : le splash s'affiche une fois par session.\n */\nexport const SplashProvider = ({\n  children,\n  showEveryVisit = false,\n  duration = MIN_SPLASH_DURATION,\n}: SplashProviderProps) => {\n  const { loading: authLoading } = useAuth();\n  // Commencer avec splash d√©sactiv√© ‚Üí pas de flash en mode navigateur\n  const [showSplash, setShowSplash] = useState(false);\n  const [isPWASplashActive, setIsPWASplashActive] = useState(false);\n  const [minDurationPassed, setMinDurationPassed] = useState(false);\n\n  useEffect(() => {\n    const isPWA = checkIsPWA();\n\n    // Navigateur classique ‚Üí rien √† faire, children rendus normalement\n    if (!isPWA) {\n      removeSplashBlocker();\n      return;\n    }\n\n    // PWA: v√©rifier si d√©j√† montr√© cette session\n    if (!showEveryVisit) {\n      const hasShown = sessionStorage.getItem(SESSION_KEY);\n      if (hasShown) {\n        removeSplashBlocker();\n        return;\n      }\n    }\n\n    // PWA + premi√®re visite ‚Üí activer le splash\n    setShowSplash(true);\n    setIsPWASplashActive(true);\n    document.body.style.overflow = \"hidden\";\n\n    // Timer pour la dur√©e minimale (effet visuel)\n    const minTimer = setTimeout(() => {\n      setMinDurationPassed(true);\n    }, duration);\n\n    // S√©curit√© (Max Timeout) pour √©viter de bloquer sur une erreur auth\n    const maxTimer = setTimeout(() => {\n      setMinDurationPassed(true);\n    }, MAX_SPLASH_TIMEOUT);\n\n    return () => {\n      clearTimeout(minTimer);\n      clearTimeout(maxTimer);\n      document.body.style.overflow = \"\";\n    };\n  }, [duration, showEveryVisit]);\n\n  // Sortie du splash synchronis√©e (PWA uniquement)\n  useEffect(() => {\n    if (isPWASplashActive && !authLoading && minDurationPassed) {\n      setShowSplash(false);\n      setIsPWASplashActive(false);\n      removeSplashBlocker();\n      document.body.style.overflow = \"\";\n\n      if (!showEveryVisit) {\n        sessionStorage.setItem(SESSION_KEY, \"true\");\n      }\n    }\n  }, [isPWASplashActive, authLoading, minDurationPassed, showEveryVisit]);\n\n  // Fallback de s√©curit√© absolu (PWA uniquement)\n  useEffect(() => {\n    if (!isPWASplashActive) return;\n\n    const forceExitTimer = setTimeout(() => {\n      if (showSplash) {\n        console.warn(\"[SplashProvider] Force exit apr√®s timeout de s√©curit√©\");\n        setShowSplash(false);\n        setIsPWASplashActive(false);\n        removeSplashBlocker();\n        document.body.style.overflow = \"\";\n        if (!showEveryVisit) {\n          sessionStorage.setItem(SESSION_KEY, \"true\");\n        }\n      }\n    }, MAX_SPLASH_TIMEOUT + 1000);\n\n    return () => clearTimeout(forceExitTimer);\n  }, [showSplash, isPWASplashActive, showEveryVisit]);\n\n  // En mode navigateur : rendu direct sans wrapper de masquage\n  if (!showSplash && !isPWASplashActive) {\n    return <>{children}</>;\n  }\n\n  // En mode PWA avec splash actif : wrapper avec masquage + animation\n  return (\n    <>\n      {showSplash && (\n        <AnimatePresence mode=\"wait\">\n          <SplashScreen key=\"splash-screen\" />\n        </AnimatePresence>\n      )}\n\n      <div\n        key=\"main-content\"\n        className=\"will-change-[opacity]\"\n        style={{\n          opacity: showSplash ? 0 : 1,\n          pointerEvents: showSplash ? \"none\" : \"auto\",\n          transition: \"opacity 1s cubic-bezier(0.22, 1, 0.36, 1)\",\n          visibility: showSplash ? \"hidden\" : \"visible\",\n          backgroundColor: \"#05080c\",\n          position: \"relative\",\n          zIndex: 1,\n        }}\n      >\n        {children}\n      </div>\n    </>\n  );\n};\n\nexport default SplashProvider;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\providers\\suppress-hydration-warning.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\install-prompt.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\install-prompt.tsx:49:5\n  47 |   useEffect(() => {\n  48 |     // Check if already installed\n> 49 |     setIsInstalled(isStandalone());\n     |     ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  50 |\n  51 |     // Detect platform\n  52 |     setPlatform(detectPlatform());","line":49,"column":5,"nodeType":null,"endLine":49,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'deferredPrompt'. Either include it or remove the dependency array.","line":113,"column":6,"nodeType":"ArrayExpression","endLine":113,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [deferredPrompt, platform]","fix":{"range":[3531,3541],"text":"[deferredPrompt, platform]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { Download, X, Share2 } from \"lucide-react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { toast } from \"sonner\";\n\nimport { Button } from \"@/components/ui/button\";\n\ntype BeforeInstallPromptEvent = Event & {\n  prompt: () => Promise<void>;\n  userChoice: Promise<{ outcome: \"accepted\" | \"dismissed\" }>;\n};\n\ntype Platform = \"ios\" | \"android\" | \"other\";\n\nfunction detectPlatform(): Platform {\n  if (typeof window === \"undefined\") return \"other\";\n\n  const userAgent = window.navigator.userAgent.toLowerCase();\n  const isIOS = /iphone|ipad|ipod/.test(userAgent);\n  const isAndroid = /android/.test(userAgent);\n\n  if (isIOS) return \"ios\";\n  if (isAndroid) return \"android\";\n  return \"other\";\n}\n\nfunction isStandalone(): boolean {\n  if (typeof window === \"undefined\") return false;\n  const nav = window.navigator as { standalone?: boolean };\n  return (\n    window.matchMedia(\"(display-mode: standalone)\").matches ||\n    nav.standalone === true ||\n    document.referrer.includes(\"android-app://\")\n  );\n}\n\nexport function InstallPrompt() {\n  const [deferredPrompt, setDeferredPrompt] =\n    useState<BeforeInstallPromptEvent | null>(null);\n  const [isVisible, setIsVisible] = useState(false);\n  const [isInstalled, setIsInstalled] = useState(false);\n  const [platform, setPlatform] = useState<Platform>(\"other\");\n  const [showIOSInstructions, setShowIOSInstructions] = useState(false);\n\n  useEffect(() => {\n    // Check if already installed\n    setIsInstalled(isStandalone());\n\n    // Detect platform\n    setPlatform(detectPlatform());\n\n    // Check if user dismissed recently\n    const checkDismissed = () => {\n      const dismissed = localStorage.getItem(\"pwa-install-dismissed\");\n      if (dismissed) {\n        const dismissedDate = new Date(dismissed);\n        const daysSinceDismissed =\n          (Date.now() - dismissedDate.getTime()) / (1000 * 60 * 60 * 24);\n        // Show again after 1 day instead of 7 days\n        if (daysSinceDismissed < 1) {\n          return false;\n        }\n      }\n      return true;\n    };\n\n    // Handle beforeinstallprompt (Android/Chrome)\n    const handleBeforeInstallPrompt = (e: Event) => {\n      e.preventDefault();\n      if (checkDismissed() && !isStandalone()) {\n        setDeferredPrompt(e as BeforeInstallPromptEvent);\n        setIsVisible(true);\n      }\n    };\n\n    // For iOS, show prompt after a delay if not installed\n    if (platform === \"ios\" && !isStandalone() && checkDismissed()) {\n      // Show iOS prompt after 3 seconds on mobile\n      const timer = setTimeout(() => {\n        if (window.innerWidth <= 768) {\n          setIsVisible(true);\n        }\n      }, 3000);\n      return () => clearTimeout(timer);\n    }\n\n    // For Android/Chrome, listen for beforeinstallprompt\n    if (platform !== \"ios\") {\n      window.addEventListener(\"beforeinstallprompt\", handleBeforeInstallPrompt);\n\n      // Fallback: Show prompt on mobile Android after delay if no beforeinstallprompt\n      const fallbackTimer = setTimeout(() => {\n        if (\n          platform === \"android\" &&\n          window.innerWidth <= 768 &&\n          !isStandalone() &&\n          checkDismissed()\n        ) {\n          // Check if deferredPrompt was set in the meantime\n          if (!deferredPrompt) {\n            setIsVisible(true);\n          }\n        }\n      }, 5000);\n\n      return () => {\n        window.removeEventListener(\"beforeinstallprompt\", handleBeforeInstallPrompt);\n        clearTimeout(fallbackTimer);\n      };\n    }\n  }, [platform]);\n\n  const handleInstall = async () => {\n    if (platform === \"ios\") {\n      setShowIOSInstructions(true);\n      return;\n    }\n\n    // Android/Chrome: Use native prompt if available\n    if (deferredPrompt) {\n      try {\n        deferredPrompt.prompt();\n        const { outcome } = await deferredPrompt.userChoice;\n\n        if (outcome === \"accepted\") {\n          toast.success(\"Installation en cours...\");\n          setIsVisible(false);\n          setDeferredPrompt(null);\n        } else {\n          toast.info(\"Installation annul√©e\");\n        }\n      } catch (error) {\n        console.error(\"Error during install:\", error);\n        toast.error(\"Erreur lors de l'installation\");\n      }\n      return;\n    }\n\n    // Fallback: Show instructions for manual installation\n    if (platform === \"android\") {\n      toast.info(\"Utilisez le menu de votre navigateur pour installer l'app\");\n      handleDismiss();\n    }\n  };\n\n  const handleDismiss = () => {\n    setIsVisible(false);\n    setShowIOSInstructions(false);\n    // Store dismissal in localStorage to avoid showing again for 1 day\n    localStorage.setItem(\n      \"pwa-install-dismissed\",\n      new Date().toISOString()\n    );\n  };\n\n  if (isInstalled) {\n    return null;\n  }\n\n  // iOS Instructions Modal\n  if (showIOSInstructions) {\n    return (\n      <AnimatePresence>\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm\"\n          onClick={handleDismiss}\n        >\n          <motion.div\n            initial={{ scale: 0.9, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            exit={{ scale: 0.9, opacity: 0 }}\n            onClick={(e) => e.stopPropagation()}\n            className=\"w-full max-w-md rounded-3xl border border-white/10 bg-[#0b0f18] p-6 shadow-2xl\"\n          >\n            <div className=\"mb-4 flex items-center justify-between\">\n              <h3 className=\"text-lg font-semibold text-white\">\n                Installer sur iOS\n              </h3>\n              <button\n                onClick={handleDismiss}\n                className=\"text-white/50 hover:text-white\"\n                aria-label=\"Fermer\"\n              >\n                <X className=\"h-5 w-5\" />\n              </button>\n            </div>\n            <div className=\"space-y-4 text-sm text-white/80\">\n              <div className=\"flex gap-3\">\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-white/10 text-lg font-bold text-white\">\n                  1\n                </div>\n                <div>\n                  <p className=\"font-semibold text-white\">Appuyez sur le bouton Partager</p>\n                  <p className=\"text-xs text-white/60\">En bas de l&apos;√©cran (ic√¥ne carr√©e avec fl√®che)</p>\n                </div>\n              </div>\n              <div className=\"flex gap-3\">\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-white/10 text-lg font-bold text-white\">\n                  2\n                </div>\n                <div>\n                  <p className=\"font-semibold text-white\">S√©lectionnez &quot;Sur l&apos;√©cran d&apos;accueil&quot;</p>\n                  <p className=\"text-xs text-white/60\">Faites d√©filer si n√©cessaire</p>\n                </div>\n              </div>\n              <div className=\"flex gap-3\">\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-white/10 text-lg font-bold text-white\">\n                  3\n                </div>\n                <div>\n                  <p className=\"font-semibold text-white\">Confirmez l&apos;installation</p>\n                  <p className=\"text-xs text-white/60\">L&apos;app appara√Ætra sur votre √©cran d&apos;accueil</p>\n                </div>\n              </div>\n            </div>\n            <Button\n              className=\"mt-6 w-full rounded-full\"\n              onClick={handleDismiss}\n            >\n              J&apos;ai compris\n            </Button>\n          </motion.div>\n        </motion.div>\n      </AnimatePresence>\n    );\n  }\n\n  // Main install prompt\n  if (!isVisible) {\n    return null;\n  }\n\n  return (\n    <AnimatePresence>\n      <motion.div\n        key=\"install-prompt-banner\"\n        initial={{ y: 100, opacity: 0 }}\n        animate={{ y: 0, opacity: 1 }}\n        exit={{ y: 100, opacity: 0 }}\n        className=\"fixed inset-x-4 bottom-20 z-[45] md:bottom-4 md:left-auto md:right-4 md:w-96\"\n      >\n        <div className=\"rounded-2xl border border-white/10 bg-[#0b0f18]/95 p-4 shadow-2xl backdrop-blur-xl\">\n          <div className=\"flex items-start gap-3\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-semibold text-white\">\n                Installer Dousell Immo\n              </h3>\n              <p className=\"mt-1 text-xs text-white/70\">\n                Ajoutez l&apos;app √† votre √©cran d&apos;accueil pour un acc√®s\n                rapide\n              </p>\n            </div>\n            <button\n              onClick={handleDismiss}\n              className=\"text-white/50 hover:text-white\"\n              aria-label=\"Fermer\"\n            >\n              <X className=\"h-4 w-4\" />\n            </button>\n          </div>\n          <div className=\"mt-4 flex gap-2\">\n            <Button\n              variant=\"secondary\"\n              size=\"sm\"\n              className=\"flex-1 rounded-full border border-white/10 bg-white/5 text-white\"\n              onClick={handleDismiss}\n            >\n              Plus tard\n            </Button>\n            <Button\n              size=\"sm\"\n              className=\"flex-1 rounded-full\"\n              onClick={handleInstall}\n            >\n              {platform === \"ios\" ? (\n                <>\n                  <Share2 className=\"mr-2 h-4 w-4\" />\n                  Installer\n                </>\n              ) : (\n                <>\n                  <Download className=\"mr-2 h-4 w-4\" />\n                  Installer\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </motion.div>\n    </AnimatePresence>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\push-notifications.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\push-notifications.tsx:16:7\n  14 |   useEffect(() => {\n  15 |     if (typeof window !== \"undefined\") {\n> 16 |       setIsSupported(true); // OneSignal handles compatibility check internally usually\n     |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  17 |\n  18 |       // Check initial subscription state\n  19 |       // Note: OneSignal.User.PushSubscription.optedIn is available in v16+","line":16,"column":7,"nodeType":null,"endLine":16,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { Bell, BellOff } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport OneSignal from \"react-onesignal\";\n\nimport { Button } from \"@/components/ui/button\";\n\nexport function PushNotifications() {\n  const [isSupported, setIsSupported] = useState(false);\n  const [isSubscribed, setIsSubscribed] = useState(false);\n\n  useEffect(() => {\n    if (typeof window !== \"undefined\") {\n      setIsSupported(true); // OneSignal handles compatibility check internally usually\n\n      // Check initial subscription state\n      // Note: OneSignal.User.PushSubscription.optedIn is available in v16+\n      // But react-onesignal wrapper might vary. \n      // Safe fallback check:\n      const checkSubscription = async () => {\n        try {\n          const state = await OneSignal.User.PushSubscription.optedIn;\n          setIsSubscribed(!!state);\n        } catch (_e) {\n          console.log(\"OneSignal not ready yet\");\n        }\n      };\n\n      checkSubscription();\n\n      // Listen for subscription changes if possible or polling\n      // OneSignal.User.PushSubscription.addEventListener(\"change\", ...)\n    }\n  }, []);\n\n  const handleTogglePush = async () => {\n    try {\n      if (isSubscribed) {\n        await OneSignal.User.PushSubscription.optOut();\n        setIsSubscribed(false);\n        toast.info(\"Notifications d√©sactiv√©es\");\n      } else {\n        await OneSignal.User.PushSubscription.optIn();\n        setIsSubscribed(true);\n        toast.success(\"Notifications activ√©es !\");\n      }\n    } catch (error) {\n      console.error(\"OneSignal error:\", error);\n      // Fallback: show prompt\n      try {\n        await OneSignal.Slidedown.promptPush();\n      } catch (_e) {\n        toast.error(\"Impossible de modifier les param√®tres de notification\");\n      }\n    }\n  };\n\n  if (!isSupported) {\n    return null;\n  }\n\n  if (isSubscribed) {\n    return (\n      <Button\n        variant=\"secondary\"\n        size=\"sm\"\n        className=\"rounded-full border border-white/10 bg-white/5 text-white\"\n        onClick={handleTogglePush}\n      >\n        <Bell className=\"mr-2 h-4 w-4\" />\n        Notifications activ√©es\n      </Button>\n    );\n  }\n\n  return (\n    <Button\n      variant=\"secondary\"\n      size=\"sm\"\n      className=\"rounded-full border border-white/10 bg-white/5 text-white\"\n      onClick={handleTogglePush}\n    >\n      <BellOff className=\"mr-2 h-4 w-4\" />\n      Activer les notifications\n    </Button>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\service-worker-register.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\pwa\\tenant-push-notifications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\SaasableSectionWrapper.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\SaasableSectionWrapper.tsx:48:9\n  46 |\n  47 |     useEffect(() => {\n> 48 |         setMounted(true);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  49 |     }, []);\n  50 |\n  51 |     if (!mounted) {","line":48,"column":9,"nodeType":null,"endLine":48,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { _Suspense, useEffect, useState } from 'react';\n\n// @mui - Using a minimal approach to avoid global style pollution\nimport { ThemeProvider as MuiThemeProvider, createTheme } from '@mui/material/styles';\n\n// Inline minimal dark theme to avoid the complex theme with global effects\nconst minimalDarkTheme = createTheme({\n    palette: {\n        mode: 'dark',\n        primary: {\n            main: '#F4C430',\n        },\n        background: {\n            default: '#000000',\n            paper: '#1a1a1a',\n        },\n        grey: {\n            100: '#1a1a1a',\n            200: '#2a2a2a',\n            300: '#3a3a3a',\n            400: '#4a4a4a',\n            900: '#0a0a0a',\n        },\n        text: {\n            primary: '#ffffff',\n            secondary: '#a0a0a0',\n        }\n    },\n    typography: {\n        fontFamily: '\"Inter\", \"Roboto\", \"Helvetica\", \"Arial\", sans-serif',\n    },\n    components: {\n        // Disable MUI's global CSSBaseline effects\n        MuiCssBaseline: {\n            styleOverrides: {\n                // Don't inject any global styles\n            }\n        }\n    }\n});\n\nfunction ThemeWrapper({ children }: { children: React.ReactNode }) {\n    const [mounted, setMounted] = useState(false);\n\n    useEffect(() => {\n        setMounted(true);\n    }, []);\n\n    if (!mounted) {\n        return <div style={{ minHeight: '400px' }} />;\n    }\n\n    // Note: Removed AppRouterCacheProvider as it injects global Emotion styles\n    // Using a minimal MUI theme provider that doesn't pollute global CSS\n    return (\n        <MuiThemeProvider theme={minimalDarkTheme}>\n            {/* Scoped container to isolate MUI styles */}\n            <div className=\"saasable-scope\" style={{ isolation: 'isolate' }}>\n                {children}\n            </div>\n        </MuiThemeProvider>\n    );\n}\n\nexport default function SaasableSectionWrapper({ children }: { children: React.ReactNode }) {\n    return (\n        <ThemeWrapper>{children}</ThemeWrapper>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\blocks\\Feature18.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1180,1183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1180,1183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1390,1393],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1390,1393],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1405,1408],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1405,1408],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2688,2691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2688,2691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5394,5397],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5394,5397],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":189,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":189,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11889,11892],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11889,11892],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState } from 'react';\r\n\r\n// @mui\r\nimport Button from '@mui/material/Button';\r\nimport Grid from '@mui/material/Grid';\r\nimport Stack from '@mui/material/Stack';\r\nimport Tab from '@mui/material/Tab';\r\nimport TabContext from '@mui/lab/TabContext';\r\nimport TabList from '@mui/lab/TabList';\r\nimport TabPanel from '@mui/lab/TabPanel';\r\nimport Typography from '@mui/material/Typography';\r\nimport Box from '@mui/material/Box';\r\n\r\n// @third-party\r\nimport { motion } from 'framer-motion';\r\n\r\n// @project\r\nimport ContainerWrapper from '@/components/saasable/ui/ContainerWrapper';\r\nimport GraphicsCard from '@/components/saasable/ui/cards/GraphicsCard';\r\nimport SvgIcon from '@/components/saasable/ui/SvgIcon';\r\nimport Typeset from '@/components/saasable/components/Typeset';\r\nimport { SECTION_COMMON_PY } from '@/components/saasable/utils/constant';\r\n\r\n// @assets\r\nimport ButtonAnimationWrapper from '@/components/saasable/ui/ButtonAnimationWrapper';\r\nimport GraphicsImage from '@/components/saasable/ui/GraphicsImage';\r\n\r\n/***************************  FEATURE - 18  ***************************/\r\n\r\nexport default function Feature18({ heading, caption, topics }: any) {\r\n    const boxPadding = { xs: 3, md: 5 };\r\n    const imagePadding = { xs: 3, sm: 4, md: 5 };\r\n\r\n    const [value, setValue] = useState('1');\r\n\r\n    // Handle tab change\r\n    const handleChange = (event: any, newValue: any) => {\r\n        setValue(newValue);\r\n    };\r\n\r\n    return (\r\n        <ContainerWrapper sx={{ py: SECTION_COMMON_PY }}>\r\n            <Stack sx={{ gap: { xs: 3, sm: 4 } }}>\r\n                <Typeset\r\n                    {...{\r\n                        heading,\r\n                        caption,\r\n                        stackProps: { sx: { alignItems: 'center', textAlign: 'center', maxWidth: { sm: 470, md: 615 }, mx: 'auto' } }\r\n                    }}\r\n                />\r\n                <Stack sx={{ gap: 1.5, alignItems: 'center' }}>\r\n                    <TabContext value={value}>\r\n                        <GraphicsCard sx={{ width: { xs: 1, sm: 'unset' } }}>\r\n                            <Box sx={{ p: 0.25 }}>\r\n                                <TabList\r\n                                    onChange={handleChange}\r\n                                    sx={{ minHeight: 'unset', p: 0.25 }}\r\n                                    // slotProps={{ indicator: { sx: { display: 'none' } } }}\r\n                                    TabIndicatorProps={{ sx: { display: 'none' } }}\r\n                                    variant=\"scrollable\"\r\n                                    scrollButtons={false}\r\n                                >\r\n                                    {topics.map((item: any, index: number) => (\r\n                                        <Tab\r\n                                            label={item.title}\r\n                                            disableFocusRipple\r\n                                            {...(item.icon && {\r\n                                                icon: (\r\n                                                    <SvgIcon\r\n                                                        {...(typeof item.icon === 'string' ? { name: item.icon } : { ...item.icon })}\r\n                                                        size={16}\r\n                                                        stroke={2}\r\n                                                        color=\"text.secondary\"\r\n                                                    />\r\n                                                )\r\n                                            })}\r\n                                            value={String(index + 1)}\r\n                                            key={index}\r\n                                            iconPosition=\"start\"\r\n                                            tabIndex={0}\r\n                                            sx={{\r\n                                                minHeight: 44,\r\n                                                minWidth: { xs: 112, md: 160, sm: 156 },\r\n                                                borderRadius: 10,\r\n                                                borderWidth: 1,\r\n                                                borderStyle: 'solid',\r\n                                                borderColor: 'transparent',\r\n                                                '& svg ': { mr: 1 },\r\n                                                '&.Mui-selected': {\r\n                                                    bgcolor: 'grey.200',\r\n                                                    borderColor: 'grey.400',\r\n                                                    minWidth: { xs: 112, md: 160, sm: 156 },\r\n                                                    color: 'text.primary',\r\n                                                    '& svg': { stroke: 'text.primary' }\r\n                                                },\r\n                                                '&.Mui-focusVisible': { bgcolor: 'grey.300' },\r\n                                                '&:hover': { bgcolor: 'grey.200' }\r\n                                            }}\r\n                                        />\r\n                                    ))}\r\n                                </TabList>\r\n                            </Box>\r\n                        </GraphicsCard>\r\n                        {topics.map((item: any, index: number) => (\r\n                            <TabPanel value={String(index + 1)} key={index} sx={{ p: 0, width: 1 }}>\r\n                                {/* Using Grid v5 syntax and removing padding left */}\r\n                                <Grid container spacing={1.5} sx={{ justifyContent: 'center' }}>\r\n\r\n                                    {/* Left Side: GIF/Image */}\r\n                                    <Grid size={{ xs: 12, sm: 6 }}>\r\n                                        <GraphicsCard>\r\n                                            <motion.div\r\n                                                initial={{ opacity: 0, x: -50, y: 0 }}\r\n                                                whileInView={{ opacity: 1, x: 0, y: 0 }}\r\n                                                viewport={{ once: true }}\r\n                                                transition={{ duration: 0.6 }}\r\n                                            >\r\n                                                <Box\r\n                                                    sx={{\r\n                                                        pl: item.isCoverImage ? 0 : imagePadding,\r\n                                                        pt: item.isCoverImage ? 0 : imagePadding,\r\n                                                        height: { xs: 260, sm: 396, md: 434 },\r\n                                                        display: 'flex',\r\n                                                        alignItems: 'center',\r\n                                                        justifyContent: 'center'\r\n                                                    }}\r\n                                                >\r\n                                                    {/* Force img tag for GIF support */}\r\n                                                    <GraphicsImage\r\n                                                        cardMediaProps={{ component: 'img' }}\r\n                                                        sx={{\r\n                                                            width: 1,\r\n                                                            height: 1,\r\n                                                            objectFit: 'contain',\r\n                                                            ...(item.isImageBorder && { borderTop: '5px solid', borderLeft: '5px solid', borderColor: 'grey.200' }),\r\n                                                            // Removed background props which contest with img tag usage\r\n                                                            borderTopLeftRadius: { xs: 12 },\r\n                                                            borderBottomRightRadius: { xs: 20, sm: 32, md: 40 }\r\n                                                        }}\r\n                                                        image={item.image}\r\n                                                    />\r\n                                                </Box>\r\n                                            </motion.div>\r\n                                        </GraphicsCard>\r\n                                    </Grid>\r\n\r\n                                    {/* Right Side: Text & Features List */}\r\n                                    <Grid size={{ xs: 12, sm: 6 }} sx={{ display: 'flex' }}>\r\n                                        <GraphicsCard overLay={true}> {/* No bgImage prop here */}\r\n                                            <Stack\r\n                                                sx={{\r\n                                                    justifyContent: 'space-between',\r\n                                                    gap: 5,\r\n                                                    height: item.actionBtn || item.actionBtn2 ? { sm: 'calc(100% - 98px)', md: 'calc(100%  - 114px)' } : 1,\r\n                                                    pt: boxPadding,\r\n                                                    px: boxPadding\r\n                                                }}\r\n                                            >\r\n                                                <motion.div\r\n                                                    key={index}\r\n                                                    initial={{ opacity: 0, x: 30 }}\r\n                                                    animate={{ opacity: 1, x: 0 }}\r\n                                                    exit={{ opacity: 0, x: 30 }}\r\n                                                    transition={{ duration: 0.2, ease: 'linear', delay: index * 0.1 }}\r\n                                                >\r\n                                                    <Stack direction=\"row\" sx={{ gap: 1 }}>\r\n                                                        {item.icon && (\r\n                                                            <SvgIcon\r\n                                                                {...(typeof item.icon === 'string' ? { name: item.icon } : { ...item.icon })}\r\n                                                                size={16}\r\n                                                                stroke={2}\r\n                                                                color=\"text.primary\"\r\n                                                            />\r\n                                                        )}\r\n                                                        <Typography variant=\"subtitle2\" sx={{ color: 'text.secondary' }}>\r\n                                                            {item.title}\r\n                                                        </Typography>\r\n                                                    </Stack>\r\n                                                </motion.div>\r\n                                                <Stack sx={{ gap: { xs: 2, md: 3 }, pb: boxPadding }}>\r\n                                                    <Stack sx={{ gap: 0.5 }}>\r\n                                                        <Typography variant=\"h4\">{item.title2}</Typography>\r\n                                                        {item.description && <Typography sx={{ color: 'text.secondary' }}>{item.description}</Typography>}\r\n                                                    </Stack>\r\n                                                    {item.list && (\r\n                                                        <Stack spacing={2} sx={{ mt: 1 }}>\r\n                                                            {item.list.map((list: any, index: number) => (\r\n                                                                <motion.div\r\n                                                                    key={index}\r\n                                                                    initial={{ opacity: 0, x: 30 }}\r\n                                                                    animate={{ opacity: 1, x: 0 }}\r\n                                                                    exit={{ opacity: 0, x: 30 }}\r\n                                                                    transition={{ duration: 0.2, ease: 'linear', delay: index * 0.1 }}\r\n                                                                >\r\n                                                                    <Stack\r\n                                                                        direction=\"row\"\r\n                                                                        spacing={2}\r\n                                                                        sx={{\r\n                                                                            alignItems: 'center',\r\n                                                                        }}\r\n                                                                    >\r\n                                                                        {/* Gold Check Icon Background */}\r\n                                                                        <Box\r\n                                                                            sx={{\r\n                                                                                width: 32,\r\n                                                                                height: 32,\r\n                                                                                borderRadius: '50%',\r\n                                                                                bgcolor: 'rgba(244, 196, 48, 0.1)',\r\n                                                                                display: 'flex',\r\n                                                                                alignItems: 'center',\r\n                                                                                justifyContent: 'center',\r\n                                                                                flexShrink: 0\r\n                                                                            }}\r\n                                                                        >\r\n                                                                            <SvgIcon name=\"tabler-check\" size={18} stroke={3} color=\"#F4C430\" />\r\n                                                                        </Box>\r\n                                                                        <Typography variant=\"body1\" sx={{ color: 'text.secondary', fontWeight: 500 }}>\r\n                                                                            {list.primary}\r\n                                                                        </Typography>\r\n                                                                    </Stack>\r\n                                                                </motion.div>\r\n                                                            ))}\r\n                                                        </Stack>\r\n                                                    )}\r\n                                                </Stack>\r\n                                            </Stack>\r\n                                            {(item.actionBtn || item.actionBtn2) && (\r\n                                                <GraphicsCard sx={{ bgcolor: 'grey.200' }}>\r\n                                                    <Stack direction=\"row\" sx={{ alignItems: 'flex-start', gap: 1.5, p: { xs: 2, sm: 3, md: 4 } }}>\r\n                                                        {item.actionBtn2 && (\r\n                                                            <Box>\r\n                                                                <ButtonAnimationWrapper>\r\n                                                                    <Button\r\n                                                                        variant=\"outlined\"\r\n                                                                        color=\"primary\"\r\n                                                                        startIcon={<SvgIcon name=\"tabler-help\" size={16} stroke={3} />}\r\n                                                                        {...item.actionBtn2}\r\n                                                                    />\r\n                                                                </ButtonAnimationWrapper>\r\n                                                            </Box>\r\n                                                        )}\r\n                                                        {item.actionBtn && (\r\n                                                            <Box>\r\n                                                                <ButtonAnimationWrapper>\r\n                                                                    <Button\r\n                                                                        variant=\"contained\"\r\n                                                                        color=\"primary\"\r\n                                                                        startIcon={<SvgIcon name=\"tabler-link\" size={16} stroke={3} color=\"background.default\" />}\r\n                                                                        {...item.actionBtn}\r\n                                                                    />\r\n                                                                </ButtonAnimationWrapper>\r\n                                                            </Box>\r\n                                                        )}\r\n                                                    </Stack>\r\n                                                </GraphicsCard>\r\n                                            )}\r\n                                        </GraphicsCard>\r\n                                    </Grid>\r\n                                </Grid>\r\n                            </TabPanel>\r\n                        ))}\r\n                    </TabContext>\r\n                </Stack>\r\n            </Stack>\r\n        </ContainerWrapper>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\components\\Typeset.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[271,274],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[271,274],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\n// @mui\r\nimport Stack from '@mui/material/Stack';\r\nimport Typography from '@mui/material/Typography';\r\n\r\n/***************************  COMPONENT - TYPESET  ***************************/\r\n\r\nexport default function Typeset({ heading, caption, stackProps }: any) {\r\n    return (\r\n        <Stack spacing={1} {...stackProps}>\r\n            {heading && (\r\n                <Typography variant=\"h2\" sx={{ fontWeight: 700 }}>\r\n                    {heading}\r\n                </Typography>\r\n            )}\r\n            {caption && (\r\n                <Typography variant=\"body1\" sx={{ color: 'text.secondary' }}>\r\n                    {caption}\r\n                </Typography>\r\n            )}\r\n        </Stack>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\enum.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\ui\\ButtonAnimationWrapper.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":6,"column":106,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":109,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[247,250],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[247,250],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\nimport { motion } from 'framer-motion';\n\n/***************************  COMMON - BUTTON ANIMATION  ***************************/\n\nexport default function ButtonAnimationWrapper({ children, style }: { children: React.ReactNode, style?: any }) {\n    return (\n        <motion.div\n            whileHover={{ scale: 1 }}\n            whileTap={{ scale: 0.95 }}\n            transition={{ type: 'spring', stiffness: 400, damping: 25 }}\n            tabIndex={-1}\n            style={style}\n        >\n            {children}\n        </motion.div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\ui\\ContainerWrapper.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":94,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":97,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[350,353],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[350,353],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n// @mui\nimport { useTheme } from '@mui/material/styles';\nimport useMediaQuery from '@mui/material/useMediaQuery';\nimport Container from '@mui/material/Container';\n\n/***************************  MAIN - CONTAINER  ***************************/\n\nexport default function ContainerWrapper({ children, sx }: { children: React.ReactNode, sx?: any }) {\n    const theme = useTheme();\n    const upMD = useMediaQuery(theme.breakpoints.up('md'));\n    const upXL = useMediaQuery(theme.breakpoints.up('xl'));\n    const downMD = useMediaQuery(theme.breakpoints.down('md'));\n\n    const isDesktop = (upMD || upXL) && !downMD;\n\n    return (\n        <Container {...(isDesktop && { maxWidth: upXL ? 'xl' : 'lg' })} sx={{ ...(downMD && { px: { xs: 2, sm: 4, md: 0 } }), ...sx }}>\n            {children}\n        </Container>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\ui\\GraphicsImage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[361,364],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[361,364],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { isValidElement } from 'react';\n\n// @mui\nimport CardMedia from '@mui/material/CardMedia';\n\n// @project\nimport GetImagePath from '@/components/saasable/utils/GetImagePath';\n\n/***************************  DYNAMIC GRAPHICS - IMAGE  ***************************/\n\nexport default function GraphicsImage({ children, image, sx, cardMediaProps }: any) {\n    if (isValidElement(image)) return image;\n\n    // Simplified: only support string images (paths) or image objects with src\n    if (typeof image === 'string') {\n        return (\n            <CardMedia\n                {...(cardMediaProps?.component == 'img'\n                    ? { src: GetImagePath(image), alt: 'Graphics', loading: 'lazy' }\n                    : { image: GetImagePath(image), title: 'Graphics', loading: 'lazy' })}\n                sx={{ width: 'auto', ...sx }}\n                {...cardMediaProps}\n            >\n                {children}\n            </CardMedia>\n        );\n    }\n\n    return image;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\ui\\SvgIcon.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[275,278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[275,278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n// @mui\nimport { useTheme } from '@mui/material/styles';\nimport Box from '@mui/material/Box';\nimport { IconSparkles, IconX, IconCheck } from '@tabler/icons-react';\n\n//@project\nimport { IconType } from '@/components/saasable/enum';\n\nconst icons: Record<string, any> = {\n    'tabler-sparkles': IconSparkles,\n    'tabler-x': IconX,\n    'tabler-check': IconCheck,\n};\n\nexport default function SvgIcon({ name, size = 24, type = IconType.STROKE, color, stroke, _twoToneColor }: { name: string, size?: number, type?: IconType, color?: string, stroke?: number, twoToneColor?: string }) {\n    const _theme = useTheme();\n\n    const Icon = icons[name];\n\n    if (!Icon) return null;\n\n    return (\n        <Box\n            role=\"none\"\n            sx={{\n                '& svg': {\n                    verticalAlign: 'middle',\n                    display: 'block',\n                    color: color || (type === IconType.CUSTOM ? 'text.primary' : 'primary.main'),\n                }\n            }}\n        >\n            <Icon size={size} stroke={stroke || 1.5} color={color} />\n        </Box>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\ui\\cards\\GraphicsCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[464,467],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[464,467],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[488,491],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[488,491],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n// @mui\nimport { useTheme } from '@mui/material/styles';\nimport Card from '@mui/material/Card';\nimport Box from '@mui/material/Box';\n\n// @project\nimport { withAlpha } from '@/components/saasable/utils/colorUtils';\nimport GetImagePath from '@/components/saasable/utils/GetImagePath';\n\n/***************************  GRAPHICS CARD  ***************************/\n\nexport default function GraphicsCard({ sx, children, overLay = false, bgImage, ...rest }: any) {\n    const theme: any = useTheme();\n\n    return (\n        <Card\n            role=\"img\"\n            rel=\"noopener noreferrer\"\n            aria-label=\"graphics card\"\n            elevation={0}\n            sx={{\n                bgcolor: 'grey.100',\n                borderRadius: { xs: 6, sm: 8, md: 10 },\n                ...(bgImage && {\n                    backgroundImage: `url(${GetImagePath(bgImage)})`,\n                    backgroundSize: 'cover',\n                    backgroundPosition: 'center'\n                }),\n\n                ...(overLay && {\n                    position: 'relative',\n                    '&:before': {\n                        content: `' '`,\n                        position: 'absolute',\n                        width: 1,\n                        height: 1,\n                        top: 0,\n                        left: 0,\n                        background: typeof overLay === 'string' ? overLay : withAlpha(theme.palette.grey[100], 0.75)\n                    }\n                }),\n                ...sx\n            }}\n            {...rest}\n        >\n            {overLay ? <Box sx={{ position: 'relative', height: 1 }}>{children}</Box> : children}\n        </Card>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\utils\\GetImagePath.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\utils\\colorUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\saasable\\utils\\constant.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\GlobalSearch.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[586,589],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[586,589],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport * as React from \"react\";\r\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\r\nimport { Search, Loader2, User, Home, Building, FileText, Wrench, MessageSquare, Wallet, Scale, FolderOpen, Users, Settings, LayoutDashboard } from \"lucide-react\";\r\nimport { useDebounce } from \"@/hooks/use-debounce\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { _cn } from \"@/lib/utils\";\r\n\r\ninterface Suggestion {\r\n    id: string;\r\n    label: string;\r\n    subLabel?: string;\r\n    type: \"tenant\" | \"property\" | \"nav\";\r\n    url: string;\r\n    icon?: any;\r\n}\r\n\r\nconst GESTION_NAV_ITEMS = [\r\n    { label: \"Dashboard\", url: \"/gestion\", icon: LayoutDashboard },\r\n    { label: \"Biens\", url: \"/gestion/biens\", icon: Home },\r\n    { label: \"√âtats des Lieux\", url: \"/gestion/etats-lieux\", icon: FileText },\r\n    { label: \"Interventions\", url: \"/gestion/interventions\", icon: Wrench },\r\n    { label: \"Documents\", url: \"/gestion/documents\", icon: FolderOpen },\r\n    { label: \"Messagerie\", url: \"/gestion/messages\", icon: MessageSquare },\r\n    { label: \"Juridique\", url: \"/gestion/documents-legaux\", icon: Scale },\r\n    { label: \"Comptabilit√©\", url: \"/gestion/comptabilite\", icon: Wallet },\r\n    { label: \"√âquipe\", url: \"/gestion/equipe\", icon: Users },\r\n    { label: \"Configuration\", url: \"/gestion/config\", icon: Settings },\r\n];\r\n\r\nexport function GlobalSearch() {\r\n    const router = useRouter();\r\n    const pathname = usePathname();\r\n    const searchParams = useSearchParams();\r\n\r\n    const initialQuery = searchParams?.get(\"q\") || \"\";\r\n    const [query, setQuery] = React.useState(initialQuery);\r\n\r\n    React.useEffect(() => {\r\n        setQuery(searchParams?.get(\"q\") || \"\");\r\n    }, [searchParams]);\r\n\r\n    const debouncedQuery = useDebounce(query, 300);\r\n    const [suggestions, setSuggestions] = React.useState<Suggestion[]>([]);\r\n    const [loading, setLoading] = React.useState(false);\r\n    const [isOpen, setIsOpen] = React.useState(false);\r\n    const wrapperRef = React.useRef<HTMLDivElement>(null);\r\n\r\n    React.useEffect(() => {\r\n        const handleClickOutside = (event: MouseEvent) => {\r\n            if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {\r\n                setIsOpen(false);\r\n            }\r\n        };\r\n        document.addEventListener(\"mousedown\", handleClickOutside);\r\n        return () => document.removeEventListener(\"mousedown\", handleClickOutside);\r\n    }, []);\r\n\r\n    React.useEffect(() => {\r\n        if (debouncedQuery.length < 2) {\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        const fetchSuggestions = async () => {\r\n            setLoading(true);\r\n            const allResults: Suggestion[] = [];\r\n            const searchTerm = debouncedQuery.toLowerCase();\r\n\r\n            // 1. Static Navigation Suggestions\r\n            if (pathname?.startsWith(\"/gestion\")) {\r\n                const navMatches = GESTION_NAV_ITEMS.filter(item =>\r\n                    item.label.toLowerCase().includes(searchTerm)\r\n                ).map(item => ({\r\n                    id: `nav-${item.label}`,\r\n                    label: item.label,\r\n                    subLabel: \"Navigation\",\r\n                    type: \"nav\" as const,\r\n                    url: item.url,\r\n                    icon: item.icon\r\n                }));\r\n                allResults.push(...navMatches);\r\n            }\r\n\r\n            try {\r\n                const res = await fetch(`/api/search/suggestions?q=${encodeURIComponent(debouncedQuery)}`);\r\n                if (res.ok) {\r\n                    const data = await res.json();\r\n                    allResults.push(...data);\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Search error:\", error);\r\n            } finally {\r\n                setSuggestions(allResults);\r\n                setIsOpen(true);\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchSuggestions();\r\n    }, [debouncedQuery, pathname]);\r\n\r\n    const handleSelect = (url: string) => {\r\n        setIsOpen(false);\r\n        router.push(url);\r\n    };\r\n\r\n    const handleSearchSubmit = (e?: React.FormEvent) => {\r\n        e?.preventDefault();\r\n        setIsOpen(false);\r\n\r\n        if (!query.trim()) return;\r\n\r\n        const trimmedQuery = query.trim();\r\n\r\n        if (pathname?.startsWith(\"/gestion\") || pathname?.startsWith(\"/admin\")) {\r\n            const params = new URLSearchParams(searchParams?.toString());\r\n            params.set(\"q\", trimmedQuery);\r\n            router.push(`${pathname}?${params.toString()}`);\r\n        } else {\r\n            router.push(`/recherche?q=${encodeURIComponent(trimmedQuery)}`);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div ref={wrapperRef} className=\"relative w-full\">\r\n            <form onSubmit={handleSearchSubmit} className=\"relative w-full\">\r\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                    type=\"search\"\r\n                    enterKeyHint=\"search\"\r\n                    placeholder=\"Rechercher un bien, une ville...\"\r\n                    className=\"pl-9 bg-white/5 border-white/10 focus-visible:ring-primary/50 focus-visible:ring-offset-0 focus-visible:bg-white/10 transition-all w-full rounded-2xl placeholder:text-white/40\"\r\n                    value={query}\r\n                    onChange={(e) => {\r\n                        setQuery(e.target.value);\r\n                        if (e.target.value.length < 2) setIsOpen(false);\r\n                    }}\r\n                    onFocus={() => {\r\n                        if (suggestions.length > 0) setIsOpen(true);\r\n                    }}\r\n                />\r\n            </form>\r\n\r\n            {isOpen && (query.length >= 2) && (\r\n                <div className=\"absolute top-full left-0 right-0 mt-2 rounded-xl border bg-popover p-1 text-popover-foreground shadow-xl outline-none animate-in fade-in-0 zoom-in-95 z-[100] max-h-[250px] sm:max-h-[400px] overflow-y-auto\">\r\n                    {loading ? (\r\n                        <div className=\"flex items-center justify-center p-4 text-sm text-muted-foreground\">\r\n                            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                            Recherche...\r\n                        </div>\r\n                    ) : suggestions.length > 0 ? (\r\n                        <div className=\"flex flex-col gap-1\">\r\n                            <p className=\"px-2 py-1.5 text-xs font-medium text-muted-foreground\">Suggestions</p>\r\n                            {suggestions.map((item) => (\r\n                                <button\r\n                                    key={`${item.type}-${item.id}`}\r\n                                    onClick={() => handleSelect(item.url)}\r\n                                    className=\"relative flex w-full cursor-pointer select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-accent hover:text-accent-foreground\"\r\n                                >\r\n                                    {item.type === 'nav' ? (\r\n                                        <div className=\"mr-2 flex items-center justify-center w-4 h-4\">\r\n                                            {item.icon ? <item.icon className=\"h-4 w-4 text-orange-500\" /> : <LayoutDashboard className=\"h-4 w-4 text-orange-500\" />}\r\n                                        </div>\r\n                                    ) : item.type === 'tenant' ? (\r\n                                        <User className=\"mr-2 h-4 w-4 text-blue-500 shrink-0\" />\r\n                                    ) : (\r\n                                        <Building className=\"mr-2 h-4 w-4 text-green-500 shrink-0\" />\r\n                                    )}\r\n                                    <div className=\"flex flex-col items-start truncate\">\r\n                                        <span className=\"font-medium truncate w-full text-left\">{item.label}</span>\r\n                                        {item.subLabel && <span className=\"text-xs text-muted-foreground truncate w-full text-left\">{item.subLabel}</span>}\r\n                                    </div>\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"p-4 text-sm text-muted-foreground text-center\">\r\n                            Aucun r√©sultat trouv√©.\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\create-alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\filter-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\map-view.tsx","messages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useMap\" is called in function \"_MarkerCluster\" that is neither a React function component nor a custom React Hook function. React component names must start with an uppercase letter. React Hook names must start with the word \"use\".","line":73,"column":17,"nodeType":"Identifier","endLine":73,"endColumn":23},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called in function \"_MarkerCluster\" that is neither a React function component nor a custom React Hook function. React component names must start with an uppercase letter. React Hook names must start with the word \"use\".","line":75,"column":5,"nodeType":"Identifier","endLine":75,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'size' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":91,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":25},{"ruleId":"react/display-name","severity":2,"message":"Component definition is missing display name","line":118,"column":21,"nodeType":"CallExpression","messageId":"noDisplayName","endLine":228,"endColumn":3},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\map-view.tsx:297:13\n  295 |         // Initial check\n  296 |         if (media.matches) {\n> 297 |             setZoomLevel(MOBILE_ZOOM);\n      |             ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  298 |             setLongitudeOffset(0.5); // Moins de d√©calage sur mobile\n  299 |         } else {\n  300 |             setZoomLevel(DEFAULT_ZOOM);","line":297,"column":13,"nodeType":null,"endLine":297,"endColumn":25},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `propertiesWithCoords`, but the source dependencies were []. Inferred dependency not present in source.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\map-view.tsx:337:43\n  335 |     }, [mounted, activeId]);\n  336 |\n> 337 |     const handleMarkerClick = useCallback((propertyId: string) => {\n      |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 338 |         setActiveId(propertyId);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 339 |\n      ‚Ä¶\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 352 |         }, 100);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 353 |     }, []);\n      | ^^^^^^ Could not preserve existing manual memoization\n  354 |\n  355 |     const handleMarkerRedirect = useCallback((property: Property) => {\n  356 |         // Pour les annonces externes, naviguer vers la page teaser interne","line":337,"column":43,"nodeType":null,"endLine":353,"endColumn":6},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `visibleCount`, but the source dependencies were []. Inferred dependency not present in source.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\map-view.tsx:337:43\n  335 |     }, [mounted, activeId]);\n  336 |\n> 337 |     const handleMarkerClick = useCallback((propertyId: string) => {\n      |                                           ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 338 |         setActiveId(propertyId);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 339 |\n      ‚Ä¶\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 352 |         }, 100);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 353 |     }, []);\n      | ^^^^^^ Could not preserve existing manual memoization\n  354 |\n  355 |     const handleMarkerRedirect = useCallback((property: Property) => {\n  356 |         // Pour les annonces externes, naviguer vers la page teaser interne","line":337,"column":43,"nodeType":null,"endLine":353,"endColumn":6},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'propertiesWithCoords' and 'visibleCount'. Either include them or remove the dependency array.","line":353,"column":8,"nodeType":"ArrayExpression","endLine":353,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [propertiesWithCoords, visibleCount]","fix":{"range":[14310,14312],"text":"[propertiesWithCoords, visibleCount]"}}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":18,"column":43,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":18,"endColumn":61,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":20,"column":60,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":20,"endColumn":92,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":6,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport \"leaflet/dist/leaflet.css\";\nimport \"leaflet.markercluster/dist/MarkerCluster.css\";\nimport \"leaflet.markercluster/dist/MarkerCluster.Default.css\";\n\nimport { useEffect, useMemo, useState, useCallback, memo, useRef } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { MapContainer, TileLayer, Marker, useMap, ZoomControl } from \"react-leaflet\";\nimport type { LatLngExpression, DivIcon } from \"leaflet\";\n\nimport { PropertyCard } from \"@/components/property/property-card\";\nimport { Button } from \"@/components/ui/button\";\nimport type { Property } from \"@/types/property\";\n\n// Import dynamique pour √©viter les erreurs SSR\n// eslint-disable-next-line @typescript-eslint/no-require-imports\nconst L = typeof window !== \"undefined\" ? require(\"leaflet\") : null;\n// eslint-disable-next-line @typescript-eslint/no-require-imports\nconst MarkerClusterGroup = typeof window !== \"undefined\" ? require(\"leaflet.markercluster\") : null;\n\n// Offset vertical pour remonter les marqueurs au-dessus du carousel\nconst LATITUDE_OFFSET = -0.6; // D√©calage vers le sud\n\n// Fix pour les ic√¥nes Leaflet avec Next.js\nif (typeof window !== \"undefined\" && L) {\n    delete (L.Icon.Default.prototype as Record<string, unknown>)._getIconUrl;\n    L.Icon.Default.mergeOptions({\n        iconRetinaUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png\",\n        iconUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png\",\n        shadowUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png\",\n    });\n}\n\ntype MapViewProps = {\n    properties: Property[];\n    showCarousel?: boolean;\n    onClose?: () => void;\n    searchQuery?: string;\n    onSearchChange?: (value: string) => void;\n    embedded?: boolean;\n};\n\n// Coordonn√©es de Dakar par d√©faut\nconst DAKAR_CENTER: LatLngExpression = [14.5, -10];\nconst DEFAULT_ZOOM = 7.6;\nconst MOBILE_ZOOM = 7; // Zoom plus recul√© sur mobile\n\n// Formatage du prix en format court (ex: \"1.5M\", \"500k\")\nconst formatPrice = (price: number): string => {\n    if (price >= 1_000_000) {\n        const millions = price / 1_000_000;\n        return `${millions % 1 === 0 ? millions : millions.toFixed(1)}M`;\n    }\n    if (price >= 1_000) {\n        const thousands = price / 1_000;\n        return `${thousands % 1 === 0 ? thousands : thousands.toFixed(1)}k`;\n    }\n    return price.toString();\n};\n\n// Composant pour centrer la carte automatiquement\nconst MapCenter = ({ center, zoom }: { center: LatLngExpression; zoom: number }) => {\n    const map = useMap();\n    useEffect(() => {\n        map.setView(center, zoom);\n    }, [map, center, zoom]);\n    return null;\n};\n\n// Composant de clustering pour les marqueurs\nconst _MarkerCluster = ({ _children }: { children: React.ReactNode }) => {\n    const map = useMap();\n\n    useEffect(() => {\n        if (!L || !MarkerClusterGroup) return;\n\n        // Cr√©er un groupe de clusters avec une configuration optimis√©e\n        const cluster = new L.MarkerClusterGroup({\n            maxClusterRadius: 60, // Rayon de clustering r√©duit pour plus de pr√©cision\n            spiderfyOnMaxZoom: true,\n            showCoverageOnHover: false,\n            zoomToBoundsOnClick: true,\n            disableClusteringAtZoom: 17, // D√©sactiver le clustering en tr√®s gros zoom\n            iconCreateFunction: (cluster: { getChildCount: () => number }) => {\n                const count = cluster.getChildCount();\n                let size = \"small\";\n                let className = \"marker-cluster-small\";\n\n                if (count > 10) {\n                    size = \"medium\";\n                    className = \"marker-cluster-medium\";\n                }\n                if (count > 20) {\n                    _size = \"large\";\n                    className = \"marker-cluster-large\";\n                }\n\n                return L.divIcon({\n                    html: `<div class=\"cluster-pill ${className}\"><span>${count}</span></div>`,\n                    className: \"custom-cluster-icon\",\n                    iconSize: L.point(50, 50),\n                });\n            },\n        });\n\n        map.addLayer(cluster);\n\n        return () => {\n            map.removeLayer(cluster);\n        };\n    }, [map]);\n\n    return null;\n};\n\n// Composant de marqueur personnalis√© avec prix - Optimis√© avec memo\nconst PriceMarker = memo(({\n    property,\n    isActive,\n    onClick,\n    _onRedirect,\n}: {\n    property: Property;\n    isActive: boolean;\n    onClick: () => void;\n    onRedirect: () => void;\n}) => {\n    const position: LatLngExpression = useMemo(() => [\n        property.location.coords.lat,\n        property.location.coords.lng,\n    ], [property.location.coords.lat, property.location.coords.lng]);\n\n    // Cr√©er une ic√¥ne HTML personnalis√©e pour le prix\n    const icon = useMemo(() => {\n        if (typeof window === \"undefined\" || !L) return undefined;\n\n        const priceText = formatPrice(property.price);\n        const isVerified = property.verification_status === \"verified\";\n\n        // Style dor√© pour les biens v√©rifi√©s\n        const verifiedClass = isVerified\n            ? \"bg-[#F4C430] text-black border-2 border-white shadow-[0_0_15px_rgba(244,196,48,0.5)]\"\n            : \"bg-primary text-primary-foreground\";\n\n        // Style actif (cliqu√©) - sans scale CSS, on g√®re la taille via iconSize\n        const activeClass = isActive\n            ? \"bg-white text-black z-50 border-white border-2 animate-bounce-subtle\"\n            : verifiedClass;\n\n        // Z-index sup√©rieur pour les biens v√©rifi√©s\n        const zIndex = isActive ? 1000 : (isVerified ? 100 : 1);\n\n        // Tailles adapt√©es : actif + v√©rifi√© = encore plus large pour le badge\n        const iconWidth = isActive\n            ? (isVerified ? 160 : 100)  // Actif: v√©rifi√© 160px, normal 100px\n            : (isVerified ? 90 : 80);   // Inactif: v√©rifi√© 90px, normal 80px\n        const iconHeight = isActive ? 36 : 28;\n        const fontSize = isActive ? 14 : 12;\n\n        return L.divIcon({\n            className: \"custom-price-marker\",\n            html: `\n        <div class=\"price-pill ${activeClass} inline-flex items-center justify-center rounded-full px-3 py-1.5 font-bold shadow-md transition-all duration-200 cursor-pointer\" style=\"font-size: ${fontSize}px; min-width: 50px; white-space: nowrap; z-index: ${zIndex};\">\n          ${isVerified ? `\n            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"#F4C430\" stroke=\"black\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"min-width: 14px; margin-right: 4px;\">\n              <path d=\"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.78Z\"/>\n              <path d=\"m9 12 2 2 4-4\"/>\n            </svg>\n          ` : ''}${priceText}\n        </div>\n      `,\n            iconSize: [iconWidth, iconHeight],\n            iconAnchor: [iconWidth / 2, iconHeight / 2],\n            popupAnchor: [0, -iconHeight / 2],\n        }) as DivIcon;\n    }, [property.price, property.verification_status, isActive]);\n\n    if (!icon) return null;\n\n    return (\n        <Marker\n            position={position}\n            icon={icon}\n            zIndexOffset={isActive ? 1000 : (property.verification_status === \"verified\" ? 100 : 0)}\n            eventHandlers={{\n                click: () => {\n                    onClick();\n                },\n                mouseover: (e) => {\n                    const target = e.target;\n                    const element = target?.getElement();\n                    if (element) {\n                        const pill = element.querySelector(\".price-pill\");\n                        if (pill && !isActive) {\n                            const currentBg = property.verification_status === \"verified\" ? \"bg-[#F4C430]\" : \"bg-primary\";\n                            const currentText = property.verification_status === \"verified\" ? \"text-black\" : \"text-primary-foreground\";\n                            pill.classList.remove(currentBg, currentText);\n                            pill.classList.add(\"bg-white\", \"text-black\", \"scale-105\");\n                        }\n                    }\n                },\n                mouseout: (e) => {\n                    const target = e.target;\n                    const element = target?.getElement();\n                    if (element) {\n                        const pill = element.querySelector(\".price-pill\");\n                        if (pill && !isActive) {\n                            pill.classList.remove(\"bg-white\", \"text-black\", \"scale-105\");\n                            if (property.verification_status === \"verified\") {\n                                pill.classList.add(\"bg-[#F4C430]\", \"text-black\");\n                            } else {\n                                pill.classList.add(\"bg-primary\", \"text-primary-foreground\");\n                            }\n                        }\n                    }\n                },\n            }}\n        />\n    );\n}, (prevProps, nextProps) => {\n    return (\n        prevProps.property.id === nextProps.property.id &&\n        prevProps.isActive === nextProps.isActive &&\n        prevProps.property.price === nextProps.property.price &&\n        prevProps.property.verification_status === nextProps.property.verification_status\n    );\n});\n\nexport const MapView = ({ properties, showCarousel = true, onClose, searchQuery = \"\", onSearchChange, embedded = false }: MapViewProps) => {\n    const router = useRouter();\n    const [activeId, setActiveId] = useState<string | undefined>(properties[0]?.id);\n    const [mapEnabled, setMapEnabled] = useState(true);\n    const [mounted, setMounted] = useState(false); // Fix hydration mismatch\n    const [visibleCount, setVisibleCount] = useState(15); // Pagination du carousel\n    const [zoomLevel, setZoomLevel] = useState(DEFAULT_ZOOM);\n    const [longitudeOffset, setLongitudeOffset] = useState(2);\n    const carouselRef = useRef<HTMLDivElement>(null); // Ref pour le scroll detection\n    const initialCenterDone = useRef(false); // Ref pour le centrage initial\n\n    // Filtrer les propri√©t√©s qui ont des coordonn√©es valides\n    const propertiesWithCoords = useMemo(\n        () => {\n            const valid = properties.filter(\n                (p) =>\n                    p.location?.coords &&\n                    p.location.coords.lat !== 0 &&\n                    p.location.coords.lng !== 0\n            );\n            return valid;\n        },\n        [properties]\n    );\n\n    // Calculer le centre de la carte (moyenne des coordonn√©es ou Dakar par d√©faut)\n    // Offset vertical d√©plac√© en dehors du composant\n    const mapCenter = useMemo<LatLngExpression>(() => {\n        if (propertiesWithCoords.length === 0) return DAKAR_CENTER;\n\n        const center = propertiesWithCoords.reduce(\n            (acc, property) => {\n                acc.lat += property.location.coords.lat;\n                acc.lng += property.location.coords.lng;\n                return acc;\n            },\n            { lat: 0, lng: 0 }\n        );\n        center.lat /= propertiesWithCoords.length;\n        center.lng /= propertiesWithCoords.length;\n\n        // Appliquer les offsets\n        return [center.lat + LATITUDE_OFFSET, center.lng + longitudeOffset];\n    }, [propertiesWithCoords, longitudeOffset]);\n\n    // Gestion de l'activation de la carte selon le contexte\n    // Gestion de l'activation de la carte selon le contexte\n    useEffect(() => {\n        if (typeof window === \"undefined\") return;\n\n        const enableBasedOnContext = () => {\n            const isMobile = window.matchMedia(\"(max-width: 768px)\").matches;\n            const saveData =\n                typeof navigator !== \"undefined\"\n                    ? (navigator as Navigator & {\n                        connection?: { saveData?: boolean };\n                    }).connection?.saveData\n                    : undefined;\n            // Sur desktop, activer par d√©faut. Sur mobile, permettre l'activation manuelle\n            setMapEnabled(!isMobile && !saveData);\n        };\n\n        enableBasedOnContext();\n\n        const media = window.matchMedia(\"(max-width: 768px)\");\n        // Initial check\n        if (media.matches) {\n            setZoomLevel(MOBILE_ZOOM);\n            setLongitudeOffset(0.5); // Moins de d√©calage sur mobile\n        } else {\n            setZoomLevel(DEFAULT_ZOOM);\n            setLongitudeOffset(2);\n        }\n\n        const handler = () => {\n            enableBasedOnContext();\n            if (media.matches) {\n                setZoomLevel(MOBILE_ZOOM);\n                setLongitudeOffset(0.5);\n            } else {\n                setZoomLevel(DEFAULT_ZOOM);\n                setLongitudeOffset(2);\n            }\n        };\n\n        media.addEventListener(\"change\", handler);\n        return () => media.removeEventListener(\"change\", handler);\n    }, []);\n\n    useEffect(() => {\n        setTimeout(() => setMounted(true), 0);\n    }, []);\n\n    // Effet pour centrer la carte active au chargement\n    useEffect(() => {\n        if (mounted && activeId && !initialCenterDone.current && carouselRef.current) {\n            // Petit d√©lai pour laisser le temps au rendu\n            setTimeout(() => {\n                const element = document.getElementById(`property-${activeId}`);\n                if (element) {\n                    element.scrollIntoView({ behavior: \"auto\", block: \"nearest\", inline: \"start\" });\n                    initialCenterDone.current = true;\n                }\n            }, 100);\n        }\n    }, [mounted, activeId]);\n\n    const handleMarkerClick = useCallback((propertyId: string) => {\n        setActiveId(propertyId);\n\n        // Si la propri√©t√© n'est pas encore visible dans le carousel, augmenter la limite pour l'inclure\n        const index = propertiesWithCoords.findIndex(p => p.id === propertyId);\n        if (index >= visibleCount) {\n            setVisibleCount(prev => Math.max(prev, index + 5)); // +5 de marge\n        }\n\n        // Scroll vers la carte correspondante dans le carousel\n        setTimeout(() => {\n            const element = document.getElementById(`property-${propertyId}`);\n            if (element) {\n                element.scrollIntoView({ behavior: \"smooth\", block: \"nearest\", inline: \"start\" });\n            }\n        }, 100);\n    }, []);\n\n    const handleMarkerRedirect = useCallback((property: Property) => {\n        // Pour les annonces externes, naviguer vers la page teaser interne\n        if (property.isExternal) {\n            router.push(`/biens/ext/${property.id}`);\n        } else {\n            // Rediriger vers la page de d√©tail du bien\n            router.push(`/biens/${property.id}`);\n        }\n    }, [router]);\n\n    if (!mounted) {\n        return (\n            <div className=\"flex h-[70vh] items-center justify-center rounded-[32px] border border-white/10 bg-white/5 text-white/70\">\n                Chargement de la carte‚Ä¶\n            </div>\n        );\n    }\n\n    if (properties.length === 0) {\n        return (\n            <div className=\"flex h-[70vh] items-center justify-center rounded-[32px] border border-white/10 bg-white/5 text-white/70\">\n                Aucun bien ne correspond √† ta recherche.\n            </div>\n        );\n    }\n\n    if (propertiesWithCoords.length === 0) {\n        return (\n            <div className=\"flex h-[70vh] items-center justify-center rounded-[32px] border border-white/10 bg-white/5 text-white/70\">\n                <div className=\"text-center\">\n                    <p className=\"mb-2\">Aucune coordonn√©e disponible pour afficher la carte.</p>\n                    <p className=\"text-sm text-white/50\">\n                        Les biens n&apos;ont pas de localisation g√©ographique.\n                    </p>\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <div className={embedded\n            ? \"relative w-full h-[300px] overflow-hidden bg-zinc-900 rounded-[28px]\"\n            : \"fixed inset-0 z-[9999] w-full overflow-hidden bg-black\"\n        }>\n            {/* Barre de recherche discr√®te + bouton fermer sur mobile - Uniquement si non embedded */}\n            {!embedded && onClose && (\n                <div className=\"absolute top-[calc(1rem+env(safe-area-inset-top))] left-14 right-4 z-50 flex items-center gap-2\">\n                    {/* ... (search bar content) ... */}\n                    <div className=\"flex-1 flex items-center gap-2 px-4 py-2 rounded-full bg-black/80 backdrop-blur-sm border border-white/20\">\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4 text-white/50\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n                        </svg>\n                        <input\n                            type=\"text\"\n                            placeholder=\"Ville ou code postal\"\n                            value={searchQuery}\n                            onChange={(e) => onSearchChange?.(e.target.value)}\n                            className=\"flex-1 bg-transparent text-white text-sm placeholder:text-white/50 border-none outline-none\"\n                        />\n                    </div>\n                    <button\n                        onClick={onClose}\n                        className=\"flex items-center justify-center w-10 h-10 rounded-full bg-black/80 backdrop-blur-sm border border-white/20 text-white shadow-lg hover:bg-black transition-colors\"\n                        aria-label=\"Fermer la carte\"\n                    >\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                    </button>\n                </div>\n            )}\n            {mapEnabled ? (\n                <MapContainer\n                    center={mapCenter}\n                    zoom={zoomLevel}\n                    scrollWheelZoom={false} // D√©sactiver le zoom molette pour ne pas g√™ner le scroll page\n                    className=\"h-full w-full rounded-[32px] z-0\"\n                    style={{ height: \"100%\", width: \"100%\", zIndex: 0 }}\n                    zoomControl={false}\n                    attributionControl={false}\n                >\n                    <ZoomControl position=\"topleft\" />\n                    {/* TileLayer CartoDB Dark Matter */}\n                    <TileLayer\n                        url=\"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png\"\n                        attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors &copy; <a href=\"https://carto.com/attributions\">CARTO</a>'\n                        subdomains=\"abcd\"\n                        maxZoom={19}\n                    />\n\n                    {/* Centrer la carte */}\n                    <MapCenter center={mapCenter} zoom={zoomLevel} />\n\n                    {/* Marqueurs avec prix */}\n                    {propertiesWithCoords.map((property) => (\n                        <PriceMarker\n                            key={property.id}\n                            property={property}\n                            isActive={property.id === activeId}\n                            onClick={() => handleMarkerClick(property.id)}\n                            onRedirect={() => handleMarkerRedirect(property)}\n                        />\n                    ))}\n                </MapContainer>\n            ) : (\n                <div className=\"flex h-full flex-col items-center justify-center gap-3 text-center text-white/70\">\n                    <p>Mode √©conomie de donn√©es activ√© sur mobile.</p>\n                    <Button\n                        className=\"rounded-full px-4 py-2 hover:bg-primary/90\"\n                        onClick={() => {\n                            console.log(\"üîÑ Activation manuelle de la carte\");\n                            setMapEnabled(true);\n                        }}\n                    >\n                        Charger la carte\n                    </Button>\n                </div>\n            )}\n\n            {/* Carousel des biens en bas - Optimis√©: affiche seulement les 10 premiers + actif */}\n            {showCarousel && propertiesWithCoords.length > 0 && (\n                <div className=\"pointer-events-none absolute inset-x-0 bottom-4 px-4 z-10\">\n                    <div\n                        ref={carouselRef}\n                        onScroll={(e) => {\n                            const container = e.currentTarget;\n                            // Point de focalisation √† gauche (avec une marge)\n                            const focusPoint = container.scrollLeft + 50;\n\n                            // Trouver la carte la plus proche du d√©but (gauche)\n                            const cards = Array.from(container.children);\n                            let closestId = null;\n                            let minDistance = Infinity;\n\n                            cards.forEach((card) => {\n                                if (card.id.startsWith(\"property-\")) {\n                                    // Distance entre le d√©but de la carte et le point focal\n                                    const cardStart = (card as HTMLElement).offsetLeft;\n                                    const distance = Math.abs(cardStart - focusPoint);\n                                    if (distance < minDistance) {\n                                        minDistance = distance;\n                                        closestId = card.id.replace(\"property-\", \"\");\n                                    }\n                                }\n                            });\n\n                            if (closestId && closestId !== activeId) {\n                                // Mettre √† jour l'ID actif sans scroller (car on scrolle d√©j√†)\n                                setActiveId(closestId);\n                            }\n                        }}\n                        className=\"pointer-events-auto scrollbar-hide flex gap-3 overflow-x-auto pb-2 relative snap-x snap-mandatory scroll-smooth\"\n                    >\n                        {propertiesWithCoords.slice(0, visibleCount).map((property) => (\n                            <div\n                                key={`mini-${property.id}`}\n                                id={`property-${property.id}`}\n                                onClick={() => {\n                                    handleMarkerRedirect(property);\n                                }}\n                                className=\"min-w-[280px] cursor-pointer flex-shrink-0 snap-start\"\n                            >\n                                <PropertyCard\n                                    property={property}\n                                    variant=\"horizontal\"\n                                    className={\n                                        property.id === activeId\n                                            ? \"bg-[#F4C430]/15 border-[#F4C430] shadow-[0_0_15px_rgba(244,196,48,0.15)] transition-all duration-300\"\n                                            : \"bg-neutral-900/60 backdrop-blur-md border border-white/10 hover:bg-neutral-900/80 transition-all duration-300\"\n                                    }\n                                />\n                            </div>\n                        ))}\n                        {propertiesWithCoords.length > visibleCount && (\n                            <div\n                                onClick={() => setVisibleCount(prev => prev + 15)}\n                                className=\"min-w-[280px] flex-shrink-0 flex flex-col items-center justify-center rounded-[28px] border border-white/10 bg-white/5 p-6 text-center text-white/70 cursor-pointer hover:bg-white/10 transition-colors snap-center\"\n                            >\n                                <p className=\"text-lg font-bold mb-1\">Voir plus</p>\n                                <p className=\"text-sm\">+{propertiesWithCoords.length - visibleCount} autres biens</p>\n                            </div>\n                        )}\n                    </div>\n                </div>\n            )}\n\n            {/* Styles CSS pour la carte Leaflet */}\n            <style jsx global>{`\n        .leaflet-container {\n          background: #1a1a1a;\n        }\n        \n        @keyframes bounce-subtle {\n          0%, 100% { transform: translateY(0) scale(1.25); }\n          50% { transform: translateY(-10px) scale(1.25); }\n        }\n        \n        .animate-bounce-subtle {\n          animation: bounce-subtle 2s infinite;\n        }\n        .custom-price-marker {\n          background: transparent !important;\n          border: none !important;\n          overflow: visible !important;\n          display: flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n        }\n        .leaflet-marker-icon {\n          overflow: visible !important;\n          display: flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n        }\n        .price-pill {\n          user-select: none;\n          pointer-events: none;\n        }\n        .leaflet-control-zoom {\n          border: none;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n          margin-top: calc(4rem + env(safe-area-inset-top, 0px) + 8px) !important; /* Sous le header + status bar PWA */\n          margin-left: calc(12px + env(safe-area-inset-left, 0px)) !important; /* Marge gauche safe */\n        }\n        .leaflet-control-zoom a {\n          background-color: rgba(20, 20, 20, 0.9); /* Fond plus sombre pour le contraste */\n          color: white;\n          border: 1px solid rgba(255, 255, 255, 0.1);\n          backdrop-filter: blur(8px);\n        }\n        .leaflet-control-zoom a:hover {\n          background-color: rgba(40, 40, 40, 0.9);\n        }\n        .leaflet-control-attribution {\n          background-color: rgba(0, 0, 0, 0.5);\n          color: rgba(255, 255, 255, 0.7);\n          font-size: 10px;\n        }\n        .leaflet-control-attribution a {\n          color: rgba(255, 255, 255, 0.8);\n        }\n        /* Styles pour les clusters */\n        .custom-cluster-icon {\n          background: transparent !important;\n          border: none !important;\n        }\n        .cluster-pill {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          width: 50px;\n          height: 50px;\n          border-radius: 50%;\n          font-weight: bold;\n          color: white;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n          transition: all 0.2s ease;\n        }\n        .cluster-pill:hover {\n          transform: scale(1.1);\n        }\n        .marker-cluster-small {\n          background: linear-gradient(135deg, #F4C430 0%, #D4A028 100%);\n          border: 2px solid rgba(255, 255, 255, 0.3);\n        }\n        .marker-cluster-medium {\n          background: linear-gradient(135deg, #D4A028 0%, #B48820 100%);\n          border: 2px solid rgba(255, 255, 255, 0.4);\n          width: 60px;\n          height: 60px;\n        }\n        .marker-cluster-large {\n          background: linear-gradient(135deg, #B48820 0%, #947018 100%);\n          border: 2px solid rgba(255, 255, 255, 0.5);\n          width: 70px;\n          height: 70px;\n          font-size: 18px;\n        }\n      `}</style>\n        </div>\n    );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\quick-search.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\quick-search.tsx:37:7\n  35 |   useEffect(() => {\n  36 |     if (debouncedLocation && debouncedLocation.length >= 2) {\n> 37 |       setIsLoadingSuggestions(true);\n     |       ^^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  38 |       getSearchSuggestions(debouncedLocation)\n  39 |         .then((results) => {\n  40 |           setSuggestions(results);","line":37,"column":7,"nodeType":null,"endLine":37,"endColumn":30}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect, useRef } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { SlidersHorizontal, ChevronDown, Search, MapPin, Loader2 } from \"lucide-react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { FilterDrawer } from \"@/components/search/filter-drawer\";\nimport type { PropertyFilters } from \"@/services/propertyService\";\nimport { getSearchSuggestions } from \"@/services/propertyService\";\nimport { useDebounce } from \"@/hooks/use-debounce\";\n\nexport const QuickSearch = () => {\n  const router = useRouter();\n  const [filtersOpen, setFiltersOpen] = useState(false);\n  const [mobileFiltersExpanded, setMobileFiltersExpanded] = useState(false);\n  const [filters, setFilters] = useState<PropertyFilters>({});\n  const [location, setLocation] = useState<string>(\"\");\n  const [maxPrice, setMaxPrice] = useState<string>(\"\");\n  const [minSurface, setMinSurface] = useState<string>(\"\");\n\n  // Autocomplete state\n  const [suggestions, setSuggestions] = useState<string[]>([]);\n  const [showSuggestions, setShowSuggestions] = useState(false);\n  const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);\n  const [selectedIndex, setSelectedIndex] = useState(-1);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  // Debounce the search query\n  const debouncedLocation = useDebounce(location, 300);\n\n  // Fetch suggestions when debounced location changes\n  useEffect(() => {\n    if (debouncedLocation && debouncedLocation.length >= 2) {\n      setIsLoadingSuggestions(true);\n      getSearchSuggestions(debouncedLocation)\n        .then((results) => {\n          setSuggestions(results);\n          setSelectedIndex(-1);\n        })\n        .finally(() => setIsLoadingSuggestions(false));\n    } else {\n      setSuggestions([]);\n    }\n  }, [debouncedLocation]);\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n\n    // Construire les param√®tres URL\n    const params = new URLSearchParams();\n\n    if (location.trim()) {\n      params.set(\"q\", location.trim());\n    }\n    if (maxPrice.trim()) {\n      params.set(\"maxPrice\", maxPrice.trim());\n    }\n    if (minSurface.trim()) {\n      params.set(\"minSurface\", minSurface.trim());\n    }\n\n    // Rediriger vers la page de recherche avec les filtres\n    router.push(`/recherche?${params.toString()}`);\n  };\n\n  const handleApplyFilters = (appliedFilters: PropertyFilters) => {\n    setFilters(appliedFilters);\n    // Construire les param√®tres URL\n    const params = new URLSearchParams();\n    if (appliedFilters.minPrice) {\n      params.set(\"minPrice\", appliedFilters.minPrice.toString());\n    }\n    if (appliedFilters.maxPrice) {\n      params.set(\"maxPrice\", appliedFilters.maxPrice.toString());\n    }\n    if (appliedFilters.category) {\n      params.set(\"type\", appliedFilters.category);\n    }\n    if (appliedFilters.rooms) {\n      params.set(\"rooms\", appliedFilters.rooms.toString());\n    }\n    if (appliedFilters.bedrooms) {\n      params.set(\"bedrooms\", appliedFilters.bedrooms.toString());\n    }\n    if (appliedFilters.hasBackupGenerator) {\n      params.set(\"hasBackupGenerator\", \"true\");\n    }\n    if (appliedFilters.hasWaterTank) {\n      params.set(\"hasWaterTank\", \"true\");\n    }\n    if (appliedFilters.location) {\n      params.set(\"q\", appliedFilters.location);\n    }\n\n    // Rediriger vers la page de recherche avec les filtres\n    router.push(`/recherche?${params.toString()}`);\n  };\n\n  const handleSelectSuggestion = (suggestion: string) => {\n    setLocation(suggestion);\n    setShowSuggestions(false);\n    setSuggestions([]);\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n    if (!showSuggestions || suggestions.length === 0) return;\n\n    switch (e.key) {\n      case \"ArrowDown\":\n        e.preventDefault();\n        setSelectedIndex((prev) =>\n          prev < suggestions.length - 1 ? prev + 1 : prev\n        );\n        break;\n      case \"ArrowUp\":\n        e.preventDefault();\n        setSelectedIndex((prev) => (prev > 0 ? prev - 1 : -1));\n        break;\n      case \"Enter\":\n        if (selectedIndex >= 0 && suggestions[selectedIndex]) {\n          e.preventDefault();\n          handleSelectSuggestion(suggestions[selectedIndex]);\n        }\n        break;\n      case \"Escape\":\n        setShowSuggestions(false);\n        break;\n    }\n  };\n\n  // Compteur de filtres actifs pour le badge\n  const activeFilterCount = [location, maxPrice, minSurface].filter(Boolean).length;\n\n  return (\n    <>\n      <motion.section\n        initial={{ opacity: 0, y: 16 }}\n        whileInView={{ opacity: 1, y: 0 }}\n        viewport={{ once: true, amount: 0.5 }}\n        transition={{ duration: 0.5 }}\n        className=\"mt-0 mb-0 md:mt-0 md:mb-0 rounded-[32px] border border-white/10 bg-white/5 px-4 py-6 text-white md:px-6 md:py-8 min-h-[152px]\"\n      >\n        <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n          <div>\n            <p className=\"text-xs uppercase tracking-[0.3em] text-white/50\">\n              Recherche rapide\n            </p>\n            <h2 className=\"text-2xl font-semibold\">Trouve ton prochain bien</h2>\n          </div>\n\n          {/* Bouton Filtres - Mobile: toggle accord√©on */}\n          <Button\n            variant=\"secondary\"\n            className=\"relative rounded-2xl border border-white/20 bg-transparent text-white hover:bg-white/10 md:hidden\"\n            onClick={() => setMobileFiltersExpanded(!mobileFiltersExpanded)}\n          >\n            <SlidersHorizontal className=\"mr-2 h-4 w-4\" />\n            Filtres\n            {activeFilterCount > 0 && (\n              <span className=\"ml-2 inline-flex h-5 w-5 items-center justify-center rounded-full bg-primary text-xs font-bold text-primary-foreground\">\n                {activeFilterCount}\n              </span>\n            )}\n            <ChevronDown\n              className={`ml-2 h-4 w-4 transition-transform duration-200 ${mobileFiltersExpanded ? \"rotate-180\" : \"\"\n                }`}\n            />\n          </Button>\n\n          {/* Bouton desktop - ouvre le drawer complet */}\n          <Button\n            variant=\"secondary\"\n            className=\"hidden rounded-2xl border border-white/20 bg-transparent text-white hover:bg-white/10 md:flex\"\n            onClick={() => setFiltersOpen(true)}\n          >\n            <SlidersHorizontal className=\"mr-2 h-4 w-4\" /> Filtres avanc√©s\n          </Button>\n        </div>\n\n        {/* Mobile: Filtres en accord√©on */}\n        <AnimatePresence>\n          {mobileFiltersExpanded && (\n            <motion.div\n              initial={{ height: 0, opacity: 0 }}\n              animate={{ height: \"auto\", opacity: 1 }}\n              exit={{ height: 0, opacity: 0 }}\n              transition={{ duration: 0.2, ease: \"easeInOut\" }}\n              className=\"overflow-hidden md:hidden\"\n            >\n              <form onSubmit={handleSubmit} className=\"mt-4 flex flex-col gap-3\">\n                <div className=\"relative\">\n                  <Input\n                    ref={inputRef}\n                    placeholder=\"Ville, quartier\"\n                    value={location}\n                    onChange={(e) => {\n                      setLocation(e.target.value);\n                      setShowSuggestions(true);\n                    }}\n                    onFocus={() => setShowSuggestions(true)}\n                    onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}\n                    onKeyDown={handleKeyDown}\n                    autoComplete=\"off\"\n                  />\n                  <SuggestionsDropdown\n                    showSuggestions={showSuggestions}\n                    suggestions={suggestions}\n                    isLoadingSuggestions={isLoadingSuggestions}\n                    selectedIndex={selectedIndex}\n                    handleSelectSuggestion={handleSelectSuggestion}\n                    setSelectedIndex={setSelectedIndex}\n                  />\n                </div>\n                <Input\n                  placeholder=\"Budget max (FCFA)\"\n                  type=\"number\"\n                  value={maxPrice}\n                  onChange={(e) => setMaxPrice(e.target.value)}\n                />\n                <Input\n                  placeholder=\"Surface min (m¬≤)\"\n                  type=\"number\"\n                  value={minSurface}\n                  onChange={(e) => setMinSurface(e.target.value)}\n                />\n                <div className=\"flex gap-2\">\n                  <Button\n                    type=\"submit\"\n                    className=\"flex-1 rounded-2xl\"\n                  >\n                    <Search className=\"mr-2 h-4 w-4\" />\n                    Rechercher\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    className=\"rounded-2xl text-white/60 hover:text-white\"\n                    onClick={() => setFiltersOpen(true)}\n                  >\n                    + de filtres\n                  </Button>\n                </div>\n              </form>\n            </motion.div>\n          )}\n        </AnimatePresence>\n\n        {/* Desktop: Formulaire toujours visible */}\n        <form onSubmit={handleSubmit} className=\"mt-6 hidden gap-3 md:grid md:grid-cols-4\">\n          <div className=\"relative\">\n            <Input\n              placeholder=\"Ville, quartier\"\n              value={location}\n              onChange={(e) => {\n                setLocation(e.target.value);\n                setShowSuggestions(true);\n              }}\n              onFocus={() => setShowSuggestions(true)}\n              onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}\n              onKeyDown={handleKeyDown}\n              autoComplete=\"off\"\n            />\n            <SuggestionsDropdown\n              showSuggestions={showSuggestions}\n              suggestions={suggestions}\n              isLoadingSuggestions={isLoadingSuggestions}\n              selectedIndex={selectedIndex}\n              handleSelectSuggestion={handleSelectSuggestion}\n              setSelectedIndex={setSelectedIndex}\n            />\n          </div>\n          <Input\n            placeholder=\"Budget max (FCFA)\"\n            type=\"number\"\n            value={maxPrice}\n            onChange={(e) => setMaxPrice(e.target.value)}\n          />\n          <Input\n            placeholder=\"Surface min (m¬≤)\"\n            type=\"number\"\n            value={minSurface}\n            onChange={(e) => setMinSurface(e.target.value)}\n          />\n          <Button\n            type=\"submit\"\n            className=\"rounded-2xl\"\n          >\n            Rechercher\n          </Button>\n        </form>\n\n      </motion.section>\n\n      <FilterDrawer\n        open={filtersOpen}\n        onOpenChange={setFiltersOpen}\n        filters={filters}\n        onApply={handleApplyFilters}\n      />\n    </>\n  );\n};\n\n// Composant de suggestions r√©utilisable (d√©clar√© √† l'ext√©rieur pour √©viter le re-render lint error)\ntype SuggestionsDropdownProps = {\n  showSuggestions: boolean;\n  suggestions: string[];\n  isLoadingSuggestions: boolean;\n  selectedIndex: number;\n  handleSelectSuggestion: (s: string) => void;\n  setSelectedIndex: (i: number) => void;\n};\n\nconst SuggestionsDropdown = ({\n  showSuggestions,\n  suggestions,\n  isLoadingSuggestions,\n  selectedIndex,\n  handleSelectSuggestion,\n  setSelectedIndex,\n}: SuggestionsDropdownProps) => (\n  <AnimatePresence>\n    {showSuggestions && (suggestions.length > 0 || isLoadingSuggestions) && (\n      <motion.div\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        exit={{ opacity: 0, y: -10 }}\n        className=\"absolute top-full left-0 right-0 mt-2 z-50 rounded-xl border border-white/10 bg-[#0F172A] shadow-2xl shadow-black/50 overflow-hidden\"\n      >\n        {isLoadingSuggestions ? (\n          <div className=\"flex items-center justify-center py-4 text-white/50\">\n            <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n            <span className=\"text-sm\">Recherche...</span>\n          </div>\n        ) : (\n          <div className=\"p-1\">\n            {suggestions.map((suggestion, index) => (\n              <button\n                key={suggestion}\n                type=\"button\"\n                className={`w-full flex items-center gap-2 px-4 py-3 text-left text-sm rounded-lg transition-colors cursor-pointer ${index === selectedIndex\n                  ? \"bg-primary/20 text-white\"\n                  : \"text-white/80 hover:bg-white/10 hover:text-white\"\n                  }`}\n                onMouseDown={(e) => {\n                  e.preventDefault();\n                  handleSelectSuggestion(suggestion);\n                }}\n                onMouseEnter={() => setSelectedIndex(index)}\n              >\n                <MapPin className=\"h-4 w-4 text-primary shrink-0\" />\n                <span className=\"truncate\">{suggestion}</span>\n              </button>\n            ))}\n          </div>\n        )}\n      </motion.div>\n    )}\n  </AnimatePresence>\n);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\search\\search-experience.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'searchQuery'. Either include it or remove the dependency array.","line":99,"column":6,"nodeType":"ArrayExpression","endLine":99,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [filters.q, searchQuery]","fix":{"range":[3858,3869],"text":"[filters.q, searchQuery]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport * as React from \"react\";\r\nimport { useState, useEffect, useCallback, useMemo } from \"react\";\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport dynamic from \"next/dynamic\";\r\nimport { Filter, Map, Search as SearchIcon, Bell, MapPin } from \"lucide-react\";\r\n\r\nimport { PropertyCardUnified } from \"@/components/property/property-card-unified\";\r\nimport { ManagementPromoCard } from \"@/components/property/management-promo-card\";\r\nimport { FilterDrawer } from \"@/components/search/filter-drawer\";\r\nimport { CreateAlertDialog } from \"@/components/search/create-alert-dialog\";\r\nimport { EmptyState } from \"@/components/ui/empty-state\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { useAuth } from \"@/hooks/use-auth\";\r\nimport { useDebounce } from \"@/hooks/use-debounce\";\r\nimport type { Property } from \"@/types/property\";\r\nimport { hasActiveFilters } from \"@/lib/search-filters\";\r\nimport { useSearchFilters } from \"@/hooks/use-search-filters\";\r\nimport { getUnifiedListings } from \"@/services/gatewayService\";\r\nimport { type PropertyFilters, getSearchSuggestions } from \"@/services/propertyService\";\r\nimport {\r\n  Pagination,\r\n  PaginationContent,\r\n  PaginationEllipsis,\r\n  PaginationItem,\r\n  PaginationLink,\r\n  PaginationNext,\r\n  PaginationPrevious,\r\n} from \"@/components/ui/pagination\";\r\n\r\nconst ITEMS_PER_PAGE = 12;\r\n\r\nconst MapView = dynamic(\r\n  () => import(\"@/components/search/map-view\").then((mod) => mod.MapView),\r\n  {\r\n    ssr: false,\r\n    loading: () => (\r\n      <div className=\"flex h-[70vh] items-center justify-center rounded-[32px] border border-white/10 bg-white/5 text-white/70\">\r\n        Chargement de la carte‚Ä¶\r\n      </div>\r\n    ),\r\n  }\r\n);\r\n\r\ntype SearchExperienceProps = {\r\n  initialFilters: PropertyFilters;\r\n  initialResults: Property[];\r\n};\r\n\r\nexport const SearchExperience = ({\r\n  initialFilters,\r\n  initialResults,\r\n}: SearchExperienceProps) => {\r\n  const searchParams = useSearchParams();\r\n  const { user } = useAuth();\r\n  const { filters, setFilters } = useSearchFilters(initialFilters);\r\n  const [view, setView] = useState<\"list\" | \"map\">(\"list\");\r\n  const [drawerOpen, setDrawerOpen] = useState(false);\r\n  const [alertDialogOpen, setAlertDialogOpen] = useState(false);\r\n  const [results, setResults] = useState<Property[]>(initialResults);\r\n  const [isSearching, setIsSearching] = useState(false);\r\n  const [searchQuery, setSearchQuery] = useState(filters.q ?? \"\");\r\n  const [suggestions, setSuggestions] = useState<string[]>([]);\r\n  const [showSuggestions, setShowSuggestions] = useState(false);\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n\r\n  // Debounce de la recherche textuelle (500ms)\r\n  const debouncedSearchQuery = useDebounce(searchQuery, 300);\r\n\r\n  // Fetch suggestions\r\n  useEffect(() => {\r\n    if (debouncedSearchQuery && debouncedSearchQuery.length >= 2) {\r\n      getSearchSuggestions(debouncedSearchQuery).then(setSuggestions);\r\n    } else {\r\n      setTimeout(() => setSuggestions([]), 0);\r\n    }\r\n  }, [debouncedSearchQuery]);\r\n\r\n  const activeFilters = hasActiveFilters(filters);\r\n\r\n  // Ouvrir le dialog de cr√©ation d'alerte si ?alert=create est pr√©sent\r\n  useEffect(() => {\r\n    const shouldOpenAlert = searchParams.get(\"alert\") === \"create\" && !!user;\r\n    if (shouldOpenAlert) {\r\n      // Utiliser setTimeout pour √©viter setState synchrone dans useEffect\r\n      setTimeout(() => setAlertDialogOpen(true), 0);\r\n    }\r\n  }, [searchParams, user]);\r\n\r\n  // Effet pour appliquer la recherche debounc√©e\r\n  useEffect(() => {\r\n    // Synchroniser searchQuery avec filters.q lors d'un changement d'URL (ex: retour arri√®re)\r\n    if (filters.q !== undefined && filters.q !== searchQuery) {\r\n      console.log(\"[SearchExperience] Sync searchQuery from filters.q:\", filters.q);\r\n      setSearchQuery(filters.q);\r\n    }\r\n  }, [filters.q]);\r\n\r\n  useEffect(() => {\r\n    let ignoreResult = false;\r\n\r\n    if (debouncedSearchQuery !== (filters.q ?? \"\")) {\r\n      const searchFilters = async () => {\r\n        console.log(\"[SearchExperience] Triggering search for:\", debouncedSearchQuery);\r\n        setIsSearching(true);\r\n        const nextFilters = { ...filters, q: debouncedSearchQuery || undefined };\r\n\r\n        console.log(\"[SearchExperience] Updating URL with filters:\", nextFilters);\r\n        setFilters(nextFilters);\r\n\r\n        try {\r\n          console.log(\"[SearchExperience] Fetching listings for:\", debouncedSearchQuery);\r\n          const data = await getUnifiedListings(nextFilters);\r\n\r\n          if (!ignoreResult) {\r\n            console.log(\"[SearchExperience] Search results received:\", data.length);\r\n            setResults(data);\r\n            setCurrentPage(1);\r\n          } else {\r\n            console.log(\"[SearchExperience] Result ignored (stale call)\");\r\n          }\r\n        } catch (error) {\r\n          console.error(\"[SearchExperience] Search error:\", error);\r\n        } finally {\r\n          if (!ignoreResult) {\r\n            setIsSearching(false);\r\n          }\r\n        }\r\n      };\r\n      searchFilters();\r\n    }\r\n\r\n    return () => {\r\n      ignoreResult = true;\r\n    };\r\n  }, [debouncedSearchQuery, filters, setFilters]);\r\n\r\n  const applyFilters = useCallback(async (nextFilters: PropertyFilters) => {\r\n    console.log(\"[SearchExperience] Applying filters:\", nextFilters);\r\n    setIsSearching(true);\r\n    setFilters(nextFilters);\r\n    try {\r\n      const data = await getUnifiedListings(nextFilters);\r\n      console.log(\"[SearchExperience] Filtered results received:\", data.length);\r\n      setResults(data);\r\n      setCurrentPage(1);\r\n    } catch (error) {\r\n      console.error(\"[SearchExperience] Filter application error:\", error);\r\n    } finally {\r\n      setIsSearching(false);\r\n    }\r\n  }, [setFilters]);\r\n\r\n  // M√©moiser le nombre de r√©sultats et les r√©sultats pagin√©s\r\n  const resultCount = useMemo(() => results.length, [results.length]);\r\n\r\n  const paginatedResults = useMemo(() => {\r\n    const start = (currentPage - 1) * ITEMS_PER_PAGE;\r\n    return results.slice(start, start + ITEMS_PER_PAGE);\r\n  }, [results, currentPage]);\r\n\r\n  const totalPages = Math.ceil(resultCount / ITEMS_PER_PAGE);\r\n\r\n  // Effet pour d√©filer vers le haut des r√©sultats lors d'un changement de page\r\n  useEffect(() => {\r\n    if (currentPage > 1) {\r\n      const resultsElement = document.getElementById(\"search-results-top\");\r\n      if (resultsElement) {\r\n        resultsElement.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\r\n      }\r\n    }\r\n  }, [currentPage]);\r\n\r\n  return (\r\n    <div className=\"relative space-y-6 pb-32\">\r\n      <div className=\"relative z-50 rounded-[28px] border border-white/5 bg-black/40 p-4 backdrop-blur-xl\">\r\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\r\n          <form\r\n            onSubmit={(e) => {\r\n              e.preventDefault();\r\n              // On peut aussi forcer un blur ici pour fermer le clavier\r\n              (document.activeElement as HTMLElement)?.blur();\r\n            }}\r\n            className=\"flex flex-1 items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-2\"\r\n          >\r\n            <SearchIcon className={`h-5 w-5 ${isSearching ? \"text-primary animate-pulse\" : \"text-white/50\"}`} />\r\n            <div className=\"relative flex-1\">\r\n              <Input\r\n                type=\"search\"\r\n                enterKeyHint=\"search\"\r\n                value={searchQuery}\r\n                onChange={(event) => {\r\n                  setSearchQuery(event.target.value);\r\n                  setShowSuggestions(true);\r\n                }}\r\n                onFocus={() => setShowSuggestions(true)}\r\n                onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}\r\n                placeholder=\"Ville ou code postal\"\r\n                className=\"border-none bg-transparent p-0 text-white placeholder:text-white/50 focus-visible:ring-0\"\r\n              />\r\n              {showSuggestions && suggestions.length > 0 && (\r\n                <div className=\"absolute top-full left-0 mt-2 w-full origin-top-left rounded-xl border border-white/10 bg-[#0F172A] p-1 shadow-2xl shadow-black/50 z-[60] overflow-y-auto max-h-[40vh] pb-safe\">\r\n                  {suggestions.map((suggestion, index) => (\r\n                    <button\r\n                      key={index}\r\n                      type=\"button\"\r\n                      className=\"w-full rounded-lg px-4 py-3 text-left text-sm text-white/90 hover:bg-white/10 hover:text-white transition-colors cursor-pointer flex items-center gap-2\"\r\n                      onMouseDown={(e) => {\r\n                        e.preventDefault(); // Emp√™che la perte de focus de l'input\r\n                        setSearchQuery(suggestion);\r\n                        setShowSuggestions(false);\r\n                      }}\r\n                    >\r\n                      <MapPin className=\"h-4 w-4 text-white/40 shrink-0\" />\r\n                      <span className=\"truncate\">{suggestion}</span>\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          </form>\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"secondary\"\r\n            className=\"rounded-2xl border border-white/10 bg-white/10 text-white\"\r\n            onClick={() => setDrawerOpen(true)}\r\n          >\r\n            <Filter className=\"mr-2 h-4 w-4\" />\r\n            Filtres\r\n            {activeFilters && (\r\n              <span className=\"ml-2 rounded-full bg-primary px-2 py-0.5 text-xs font-semibold text-primary-foreground\">\r\n                ‚óè\r\n              </span>\r\n            )}\r\n          </Button>\r\n          {user && (\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"secondary\"\r\n              className=\"rounded-2xl border border-white/10 bg-white/10 text-white\"\r\n              onClick={() => setAlertDialogOpen(true)}\r\n            >\r\n              <Bell className=\"mr-2 h-4 w-4\" />\r\n              Cr√©er une alerte\r\n            </Button>\r\n          )}\r\n        </div>\r\n        <p className=\"mt-3 text-sm text-white/60\">\r\n          {isSearching ? (\r\n            <span className=\"animate-pulse\">Recherche en cours...</span>\r\n          ) : (\r\n            <>{resultCount} bien{resultCount > 1 ? \"s\" : \"\"} trouv√©{resultCount > 1 ? \"s\" : \"\"}</>\r\n          )}\r\n        </p>\r\n      </div>\r\n\r\n      {view === \"list\" ? (\r\n        results.length === 0 ? (\r\n          <EmptyState\r\n            title=\"Aucun bien ne correspond √† vos crit√®res.\"\r\n            description={\r\n              activeFilters\r\n                ? \"Essayez de modifier vos crit√®res de recherche ou de r√©initialiser les filtres pour voir plus de r√©sultats.\"\r\n                : \"Nous ajoutons r√©guli√®rement de nouveaux biens. Revenez bient√¥t pour d√©couvrir les derni√®res offres !\"\r\n            }\r\n            actionLabel={activeFilters ? \"R√©initialiser les filtres\" : undefined}\r\n            onAction={\r\n              activeFilters\r\n                ? () => {\r\n                  console.log(\"[SearchExperience] Clearing all filters\");\r\n                  const clearedFilters: PropertyFilters = {};\r\n                  setSearchQuery(\"\");\r\n                  setFilters(clearedFilters);\r\n                  applyFilters(clearedFilters);\r\n                }\r\n                : undefined\r\n            }\r\n          />\r\n        ) : (\r\n          <div id=\"search-results-top\" className=\"scroll-mt-24\">\r\n            <div className=\"grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 [&>*]:w-full\">\r\n              {paginatedResults.map((property) => (\r\n                <PropertyCardUnified key={property.id} property={property} />\r\n              ))}\r\n            </div>\r\n\r\n            {totalPages > 1 && (\r\n              <div className=\"mt-12 flex justify-center\">\r\n                <Pagination>\r\n                  <PaginationContent>\r\n                    <PaginationItem>\r\n                      {currentPage > 1 ? (\r\n                        <PaginationPrevious\r\n                          onClick={() => setCurrentPage(prev => prev - 1)}\r\n                        />\r\n                      ) : (\r\n                        <div className=\"pointer-events-none opacity-30\">\r\n                          <PaginationPrevious />\r\n                        </div>\r\n                      )}\r\n                    </PaginationItem>\r\n\r\n                    {/* Logic to show page numbers with ellipsis */}\r\n                    {Array.from({ length: totalPages }, (_, i) => i + 1)\r\n                      .filter(page => {\r\n                        // All√©ger la pagination sur mobile\r\n                        if (totalPages <= 5) return true;\r\n                        if (page === 1 || page === totalPages) return true;\r\n                        if (Math.abs(page - currentPage) <= 1) return true;\r\n                        return false;\r\n                      })\r\n                      .map((page, index, array) => (\r\n                        <React.Fragment key={page}>\r\n                          {index > 0 && array[index - 1] !== page - 1 && (\r\n                            <PaginationItem>\r\n                              <PaginationEllipsis />\r\n                            </PaginationItem>\r\n                          )}\r\n                          <PaginationItem>\r\n                            <PaginationLink\r\n                              isActive={currentPage === page}\r\n                              onClick={() => setCurrentPage(page)}\r\n                            >\r\n                              {page}\r\n                            </PaginationLink>\r\n                          </PaginationItem>\r\n                        </React.Fragment>\r\n                      ))}\r\n\r\n                    <PaginationItem>\r\n                      {currentPage < totalPages ? (\r\n                        <PaginationNext\r\n                          onClick={() => setCurrentPage(prev => prev + 1)}\r\n                        />\r\n                      ) : (\r\n                        <div className=\"pointer-events-none opacity-30\">\r\n                          <PaginationNext />\r\n                        </div>\r\n                      )}\r\n                    </PaginationItem>\r\n                  </PaginationContent>\r\n                </Pagination>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )\r\n      ) : (\r\n        <MapView\r\n          properties={results}\r\n          onClose={() => setView(\"list\")}\r\n          searchQuery={searchQuery}\r\n          onSearchChange={setSearchQuery}\r\n        />\r\n      )}\r\n\r\n      <Button\r\n        type=\"button\"\r\n        className=\"fixed bottom-28 right-6 z-30 rounded-full px-5 py-3 shadow-xl md:bottom-8\"\r\n        onClick={() => setView((prev) => (prev === \"list\" ? \"map\" : \"list\"))}\r\n      >\r\n        {view === \"list\" ? (\r\n          <>\r\n            <Map className=\"mr-2 h-4 w-4\" /> Vue carte\r\n          </>\r\n        ) : (\r\n          <>\r\n            <SearchIcon className=\"mr-2 h-4 w-4\" /> Vue liste\r\n          </>\r\n        )}\r\n      </Button>\r\n\r\n      <FilterDrawer\r\n        open={drawerOpen}\r\n        onOpenChange={setDrawerOpen}\r\n        filters={filters}\r\n        onApply={applyFilters}\r\n      />\r\n\r\n      {user && (\r\n        <CreateAlertDialog\r\n          open={alertDialogOpen}\r\n          onOpenChange={setAlertDialogOpen}\r\n          filters={filters}\r\n        />\r\n      )}\r\n\r\n      <ManagementPromoCard />\r\n    </div>\r\n  );\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\sections\\hero.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\sections\\home-seo-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\sections\\new-properties.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\sections\\property-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\seo\\JsonLd.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\seo\\ProgrammaticPageTemplate.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\seo\\ProgrammaticSectionFAQ.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\seo\\SimilarListingsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\seo\\json-ld.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\team\\MemberQuotaProgress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\theme-provider.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\theme-provider.tsx:31:9\n  29 |\n  30 |     useEffect(() => {\n> 31 |         setMounted(true);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  32 |     }, []);\n  33 |\n  34 |     const toggleTheme = () => {","line":31,"column":9,"nodeType":null,"endLine":31,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport * as React from \"react\";\r\nimport { ThemeProvider as NextThemesProvider, useTheme as useNextTheme } from \"next-themes\";\r\nimport { _createContext, _useContext, useEffect, useState } from \"react\";\r\n\r\n/**\r\n * Unified Theme Provider\r\n * Handles hydration stabilization and provides a stable useTheme hook\r\n */\r\nexport function ThemeProvider({\r\n    children,\r\n    ...props\r\n}: React.ComponentProps<typeof NextThemesProvider>) {\r\n    return (\r\n        <NextThemesProvider {...props}>\r\n            {children}\r\n        </NextThemesProvider>\r\n    );\r\n}\r\n\r\n/**\r\n * Enhanced useTheme hook\r\n * Provides 'mounted' state and 'isDark' helper to avoid hydration mismatches\r\n */\r\nexport function useTheme() {\r\n    const { theme, setTheme, resolvedTheme } = useNextTheme();\r\n    const [mounted, setMounted] = useState(false);\r\n\r\n    useEffect(() => {\r\n        setMounted(true);\r\n    }, []);\r\n\r\n    const toggleTheme = () => {\r\n        setTheme(resolvedTheme === \"dark\" ? \"light\" : \"dark\");\r\n    };\r\n\r\n    // Stable defaults during hydration\r\n    if (!mounted) {\r\n        return {\r\n            theme: \"dark\" as const,\r\n            setTheme,\r\n            resolvedTheme: \"dark\" as const,\r\n            toggleTheme,\r\n            isDark: true,\r\n            mounted: false\r\n        };\r\n    }\r\n\r\n    return {\r\n        theme: (theme || \"dark\") as string,\r\n        setTheme,\r\n        resolvedTheme: (resolvedTheme || \"dark\") as string,\r\n        toggleTheme,\r\n        isDark: resolvedTheme === \"dark\",\r\n        mounted: true\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\ace-compare.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\ace-navbar.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[249,252],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[249,252],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useState } from \"react\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport Link, { LinkProps } from \"next/link\";\r\nimport Image from \"next/image\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nconst transition: any = {\r\n  type: \"spring\",\r\n  mass: 0.5,\r\n  damping: 11.5,\r\n  stiffness: 100,\r\n  restDelta: 0.001,\r\n  restSpeed: 0.001,\r\n};\r\n\r\nexport const MenuItem = ({\r\n  setActive,\r\n  active,\r\n  item,\r\n  children,\r\n}: {\r\n  setActive: (item: string) => void;\r\n  active: string | null;\r\n  item: string;\r\n  children?: React.ReactNode;\r\n}) => {\r\n  return (\r\n    <div onMouseEnter={() => setActive(item)} className=\"relative\">\r\n      <motion.p\r\n        transition={{ duration: 0.3 }}\r\n        className=\"cursor-pointer text-gray-300 hover:text-[#F4C430] text-sm font-medium transition-colors\"\r\n      >\r\n        {item}\r\n      </motion.p>\r\n      {active !== null && (\r\n        <motion.div\r\n          initial={{ opacity: 0, scale: 0.85, y: 10 }}\r\n          animate={{ opacity: 1, scale: 1, y: 0 }}\r\n          transition={transition}\r\n        >\r\n          {active === item && (\r\n            <div className=\"absolute top-full left-1/2 transform -translate-x-1/2\">\r\n              {/* Invisible bridge to prevent hover gap - covers the space between trigger and dropdown */}\r\n              <div className=\"h-4 w-full\" />\r\n              <motion.div\r\n                transition={transition}\r\n                layoutId=\"active\"\r\n                className=\"bg-black/80 backdrop-blur-md rounded-2xl overflow-hidden border border-[#F4C430]/20 shadow-2xl\"\r\n              >\r\n                <motion.div layout className=\"w-max h-full p-4\">\r\n                  {children}\r\n                </motion.div>\r\n              </motion.div>\r\n            </div>\r\n          )}\r\n        </motion.div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport type NavItem = {\r\n  title: string;\r\n  href: string;\r\n};\r\n\r\nexport type ProductItemType = {\r\n  title: string;\r\n  href: string;\r\n  src: string;\r\n  description: string;\r\n};\r\n\r\nexport type LogoConfig = {\r\n  src?: string;\r\n  alt: string;\r\n  href: string;\r\n  width?: number;\r\n  height?: number;\r\n  text?: string;\r\n};\r\n\r\nexport type NavbarConfig = {\r\n  logo: LogoConfig;\r\n  mainNav: {\r\n    firstGroup: {\r\n      title: string;\r\n      items: NavItem[];\r\n    };\r\n    products: {\r\n      title: string;\r\n      items: ProductItemType[];\r\n    };\r\n    lastGroup: {\r\n      title: string;\r\n      items: NavItem[];\r\n    };\r\n  };\r\n  cta?: {\r\n    text: string;\r\n    href: string;\r\n  };\r\n};\r\n\r\nexport default function AceNavbar({\r\n  className,\r\n  config,\r\n}: {\r\n  className?: string;\r\n  config: NavbarConfig;\r\n}) {\r\n  const [active, setActive] = useState<string | null>(null);\r\n  const [mobileOpen, setMobileOpen] = useState(false);\r\n\r\n  return (\r\n    <>\r\n      <div\r\n        className={cn(\r\n          \"fixed inset-x-0 max-w-3xl mx-auto z-50 px-4 md:px-0\",\r\n          className\r\n        )}\r\n        style={{ top: \"calc(env(safe-area-inset-top, 0px) + 1.5rem)\" }}\r\n      >\r\n        <Menu setActive={setActive}>\r\n          <div className=\"flex items-center w-full justify-between\">\r\n            {/* Logo */}\r\n            <div className=\"shrink-0\">\r\n              <Link href={config.logo.href} className=\"flex items-center gap-2\">\r\n                {config.logo.src ? (\r\n                  <Image\r\n                    src={config.logo.src}\r\n                    alt={config.logo.alt}\r\n                    width={config.logo.width || 32}\r\n                    height={config.logo.height || 32}\r\n                    className=\"h-8 w-auto rounded-md\"\r\n                  />\r\n                ) : null}\r\n                {config.logo.text && (\r\n                  <span className=\"font-bold text-lg gradient-text-animated\">\r\n                    {config.logo.text}\r\n                  </span>\r\n                )}\r\n              </Link>\r\n            </div>\r\n\r\n            {/* Navigation Desktop */}\r\n            <div className=\"hidden md:flex flex-1 items-center justify-center space-x-6\">\r\n              <MenuItem\r\n                setActive={setActive}\r\n                active={active}\r\n                item={config.mainNav.firstGroup.title}\r\n              >\r\n                <div className=\"flex flex-col space-y-4 text-sm\">\r\n                  {config.mainNav.firstGroup.items.map((item) => (\r\n                    <HoveredLink key={item.href} href={item.href}>\r\n                      {item.title}\r\n                    </HoveredLink>\r\n                  ))}\r\n                </div>\r\n              </MenuItem>\r\n              <MenuItem\r\n                setActive={setActive}\r\n                active={active}\r\n                item={config.mainNav.products.title}\r\n              >\r\n                <div className=\"text-sm grid grid-cols-2 gap-6 p-2\">\r\n                  {config.mainNav.products.items.map((product) => (\r\n                    <ProductItem key={product.href} {...product} />\r\n                  ))}\r\n                </div>\r\n              </MenuItem>\r\n              <MenuItem\r\n                setActive={setActive}\r\n                active={active}\r\n                item={config.mainNav.lastGroup.title}\r\n              >\r\n                <div className=\"flex flex-col space-y-4 text-sm\">\r\n                  {config.mainNav.lastGroup.items.map((item) => (\r\n                    <HoveredLink key={item.href} href={item.href}>\r\n                      {item.title}\r\n                    </HoveredLink>\r\n                  ))}\r\n                </div>\r\n              </MenuItem>\r\n            </div>\r\n\r\n            {/* CTA Button */}\r\n            {config.cta && (\r\n              <div className=\"hidden md:block shrink-0\">\r\n                <Link\r\n                  href={config.cta.href}\r\n                  className=\"btn-shimmer text-black text-sm font-semibold px-5 py-2 rounded-full\"\r\n                >\r\n                  {config.cta.text}\r\n                </Link>\r\n              </div>\r\n            )}\r\n\r\n            {/* Bouton Mobile (Menu Hamburger) */}\r\n            <div className=\"shrink-0 md:hidden ml-auto\">\r\n              <button\r\n                onClick={() => setMobileOpen(true)}\r\n                className=\"text-white p-2\"\r\n              >\r\n                <svg\r\n                  xmlns=\"http://www.w3.org/2000/svg\"\r\n                  fill=\"none\"\r\n                  viewBox=\"0 0 24 24\"\r\n                  strokeWidth={1.5}\r\n                  stroke=\"currentColor\"\r\n                  className=\"w-6 h-6\"\r\n                >\r\n                  <path\r\n                    strokeLinecap=\"round\"\r\n                    strokeLinejoin=\"round\"\r\n                    d=\"M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5\"\r\n                  />\r\n                </svg>\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </Menu>\r\n      </div>\r\n\r\n      {/* Mobile Menu Overlay - Full Screen */}\r\n      <AnimatePresence>\r\n        {mobileOpen && (\r\n          <motion.div\r\n            initial={{ opacity: 0, scale: 0.95 }}\r\n            animate={{ opacity: 1, scale: 1 }}\r\n            exit={{ opacity: 0, scale: 0.95 }}\r\n            transition={{ duration: 0.2 }}\r\n            className=\"fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl md:hidden overflow-y-auto\"\r\n          >\r\n            <div className=\"flex flex-col min-h-screen p-6\">\r\n              <div className=\"flex items-center justify-between mb-8\">\r\n                <Link href={config.logo.href} className=\"flex items-center gap-2\" onClick={() => setMobileOpen(false)}>\r\n                  {config.logo.src && (\r\n                    <Image\r\n                      src={config.logo.src}\r\n                      alt={config.logo.alt}\r\n                      width={config.logo.width || 32}\r\n                      height={config.logo.height || 32}\r\n                      className=\"h-8 w-auto rounded-md\"\r\n                    />\r\n                  )}\r\n                  {config.logo.text && (\r\n                    <span className=\"font-bold text-lg text-white\">\r\n                      {config.logo.text}\r\n                    </span>\r\n                  )}\r\n                </Link>\r\n                <button\r\n                  onClick={() => setMobileOpen(false)}\r\n                  className=\"p-2 text-white/70 hover:text-white bg-white/5 rounded-full\"\r\n                >\r\n                  <svg\r\n                    xmlns=\"http://www.w3.org/2000/svg\"\r\n                    fill=\"none\"\r\n                    viewBox=\"0 0 24 24\"\r\n                    strokeWidth={1.5}\r\n                    stroke=\"currentColor\"\r\n                    className=\"w-6 h-6\"\r\n                  >\r\n                    <path\r\n                      strokeLinecap=\"round\"\r\n                      strokeLinejoin=\"round\"\r\n                      d=\"M6 18L18 6M6 6l12 12\"\r\n                    />\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n\r\n              <div className=\"flex flex-col space-y-8 flex-1\">\r\n                <div className=\"space-y-4\">\r\n                  <p className=\"text-[#F4C430] text-xs font-bold uppercase tracking-widest border-b border-white/10 pb-2\">\r\n                    {config.mainNav.firstGroup.title}\r\n                  </p>\r\n                  <div className=\"flex flex-col space-y-3 pl-2\">\r\n                    {config.mainNav.firstGroup.items.map((item) => (\r\n                      <Link\r\n                        key={item.href}\r\n                        href={item.href}\r\n                        className=\"text-xl font-medium text-white/90 hover:text-[#F4C430] transition-colors\"\r\n                        onClick={() => setMobileOpen(false)}\r\n                      >\r\n                        {item.title}\r\n                      </Link>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-4\">\r\n                  <p className=\"text-[#F4C430] text-xs font-bold uppercase tracking-widest border-b border-white/10 pb-2\">\r\n                    {config.mainNav.products.title}\r\n                  </p>\r\n                  <div className=\"flex flex-col space-y-3 pl-2\">\r\n                    {config.mainNav.products.items.map((item) => (\r\n                      <Link\r\n                        key={item.href}\r\n                        href={item.href}\r\n                        className=\"text-xl font-medium text-white/90 hover:text-[#F4C430] transition-colors\"\r\n                        onClick={() => setMobileOpen(false)}\r\n                      >\r\n                        {item.title}\r\n                      </Link>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-4\">\r\n                  <p className=\"text-[#F4C430] text-xs font-bold uppercase tracking-widest border-b border-white/10 pb-2\">\r\n                    {config.mainNav.lastGroup.title}\r\n                  </p>\r\n                  <div className=\"flex flex-col space-y-3 pl-2\">\r\n                    {config.mainNav.lastGroup.items.map((item) => (\r\n                      <Link\r\n                        key={item.href}\r\n                        href={item.href}\r\n                        className=\"text-xl font-medium text-white/90 hover:text-[#F4C430] transition-colors\"\r\n                        onClick={() => setMobileOpen(false)}\r\n                      >\r\n                        {item.title}\r\n                      </Link>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {config.cta && (\r\n                <div className=\"mt-8 pb-8\">\r\n                  <Link\r\n                    href={config.cta.href}\r\n                    className=\"block w-full btn-shimmer text-black text-lg font-bold px-6 py-4 rounded-xl text-center shadow-lg shadow-[#F4C430]/20\"\r\n                    onClick={() => setMobileOpen(false)}\r\n                  >\r\n                    {config.cta.text}\r\n                  </Link>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n    </>\r\n  );\r\n}\r\n\r\nexport function Menu({\r\n  setActive,\r\n  children,\r\n}: {\r\n  setActive: (item: string | null) => void;\r\n  children: React.ReactNode;\r\n}) {\r\n  return (\r\n    <nav\r\n      onMouseLeave={() => setActive(null)}\r\n      className=\"relative rounded-full border border-[#F4C430]/20 bg-black/80 backdrop-blur-md shadow-2xl px-4 py-3 md:px-6 md:py-3\"\r\n    >\r\n      {children}\r\n    </nav>\r\n  );\r\n}\r\n\r\nexport const ProductItem = ({\r\n  title,\r\n  description,\r\n  href,\r\n  src,\r\n}: {\r\n  title: string;\r\n  description: string;\r\n  href: string;\r\n  src: string;\r\n}) => {\r\n  return (\r\n    <Link href={href} className=\"flex space-x-4 group\">\r\n      <Image\r\n        src={src}\r\n        width={120}\r\n        height={60}\r\n        alt={title}\r\n        className=\"shrink-0 rounded-md shadow-lg group-hover:scale-105 transition-transform duration-200 object-cover\"\r\n      />\r\n      <div>\r\n        <h4 className=\"text-base font-bold mb-1 text-white group-hover:text-[#F4C430] transition-colors\">\r\n          {title}\r\n        </h4>\r\n        <p className=\"text-gray-400 text-xs max-w-[10rem] leading-relaxed\">\r\n          {description}\r\n        </p>\r\n      </div>\r\n    </Link>\r\n  );\r\n};\r\n\r\nexport const HoveredLink = ({\r\n  children,\r\n  ...rest\r\n}: React.AnchorHTMLAttributes<HTMLAnchorElement> & {\r\n  children: React.ReactNode;\r\n}) => {\r\n  return (\r\n    <Link\r\n      {...(rest as LinkProps)}\r\n      className=\"text-gray-400 hover:text-[#F4C430] transition-colors\"\r\n    >\r\n      {children}\r\n    </Link>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\animated-counter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\appointment-scheduler.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\breadcrumbs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\captcha.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\combobox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\command.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":26,"column":11,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":26,"endColumn":29,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[715,767],"text":"type CommandDialogProps = DialogProps"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\ninterface CommandDialogProps extends DialogProps { }\n\nconst CommandDialog = ({ children, ...props }: CommandDialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b border-white/10 px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50 text-white\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      enterKeyHint=\"search\"\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm text-white outline-none placeholder:text-white/50 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm text-white/50\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 aria-selected:bg-accent aria-selected:text-accent-foreground aria-selected:[&_*]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"flex w-full items-center min-w-0 overflow-hidden text-ellipsis whitespace-nowrap\">\n      {props.children}\n    </div>\n  </CommandPrimitive.Item>\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\container-scroll-animation.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1579,1582],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1579,1582],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\nimport React, { useRef } from \"react\";\nimport { useScroll, useTransform, motion, MotionValue } from \"framer-motion\";\n\nexport const ContainerScroll = ({\n  titleComponent,\n  children,\n}: {\n  titleComponent: string | React.ReactNode;\n  children: React.ReactNode;\n}) => {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const { scrollYProgress } = useScroll({\n    target: containerRef,\n  });\n  const [isMobile, setIsMobile] = React.useState(false);\n\n  React.useEffect(() => {\n    const checkMobile = () => {\n      setIsMobile(window.innerWidth <= 768);\n    };\n    checkMobile();\n    window.addEventListener(\"resize\", checkMobile);\n    return () => {\n      window.removeEventListener(\"resize\", checkMobile);\n    };\n  }, []);\n\n  const scaleDimensions = () => {\n    return isMobile ? [0.7, 0.9] : [1.05, 1];\n  };\n\n  const rotate = useTransform(scrollYProgress, [0, 1], [20, 0]);\n  const scale = useTransform(scrollYProgress, [0, 1], scaleDimensions());\n  const translate = useTransform(scrollYProgress, [0, 1], [0, -100]);\n\n  return (\n    <div\n      className=\"h-[45rem] md:h-[60rem] flex items-center justify-center relative p-2 md:p-20\"\n      ref={containerRef}\n    >\n      <div\n        className=\"py-10 md:py-40 w-full relative\"\n        style={{\n          perspective: \"1000px\",\n        }}\n      >\n        <Header translate={translate} titleComponent={titleComponent} />\n        <Card rotate={rotate} translate={translate} scale={scale}>\n          {children}\n        </Card>\n      </div>\n    </div>\n  );\n};\n\nexport const Header = ({ translate, titleComponent }: any) => {\n  return (\n    <motion.div\n      style={{\n        translateY: translate,\n      }}\n      className=\"div max-w-5xl mx-auto text-center\"\n    >\n      {titleComponent}\n    </motion.div>\n  );\n};\n\nexport const Card = ({\n  rotate,\n  scale,\n  children,\n}: {\n  rotate: MotionValue<number>;\n  scale: MotionValue<number>;\n  translate: MotionValue<number>;\n  children: React.ReactNode;\n}) => {\n  const [isAnimationComplete, setIsAnimationComplete] = React.useState(false);\n  const contentRef = React.useRef<HTMLDivElement>(null);\n  const cardRef = React.useRef<HTMLDivElement>(null);\n\n  // D√©tecter quand l'animation est termin√©e\n  React.useEffect(() => {\n    const unsubscribe = rotate.on(\"change\", (latest) => {\n      if (latest <= 1 && !isAnimationComplete) {\n        setIsAnimationComplete(true);\n      } else if (latest > 1 && isAnimationComplete) {\n        setIsAnimationComplete(false);\n      }\n    });\n\n    return () => unsubscribe();\n  }, [rotate, isAnimationComplete]);\n\n  // Gestion du scroll dans la tablette - TOUJOURS actif\n  React.useEffect(() => {\n    const card = cardRef.current;\n    const content = contentRef.current;\n\n    if (!card || !content) return;\n\n    const handleWheel = (e: WheelEvent) => {\n      const isAtTop = content.scrollTop <= 0;\n      const isAtBottom =\n        content.scrollHeight - content.scrollTop - content.clientHeight < 5;\n\n      const canScrollDown = !isAtBottom && e.deltaY > 0;\n      const canScrollUp = !isAtTop && e.deltaY < 0;\n\n      if (canScrollDown || canScrollUp) {\n        e.preventDefault();\n        e.stopPropagation();\n        content.scrollTop += e.deltaY;\n      }\n    };\n\n    card.addEventListener(\"wheel\", handleWheel, { passive: false });\n\n    return () => {\n      card.removeEventListener(\"wheel\", handleWheel);\n    };\n  }, []);\n\n  return (\n    <motion.div\n      ref={cardRef}\n      style={{\n        rotateX: rotate,\n        scale,\n        boxShadow:\n          \"0 0 #0000004d, 0 9px 20px #0000004a, 0 37px 37px #00000042, 0 84px 50px #00000026, 0 149px 60px #0000000a, 0 233px 65px #00000003\",\n      }}\n      className=\"max-w-5xl -mt-12 mx-auto h-[30rem] md:h-[40rem] w-full border-4 border-[#6C6C6C] p-2 md:p-6 bg-[#222222] rounded-[30px] shadow-2xl\"\n    >\n      <div\n        ref={contentRef}\n        className={`h-full w-full rounded-2xl bg-gray-100 dark:bg-zinc-900 md:rounded-2xl transition-all duration-300 ${isAnimationComplete ? \"overflow-y-scroll overflow-x-hidden\" : \"overflow-hidden\"\n          }`}\n        style={{\n          scrollbarWidth: \"thin\",\n          scrollbarColor: \"#F4C430 #222222\",\n          WebkitOverflowScrolling: \"touch\",\n          padding: 0,\n        }}\n      >\n        {children}\n      </div>\n    </motion.div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\cookie-consent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\cta-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\display-cards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\empty-state.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\fade-in.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\faq-accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\feature-grid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\floating-help-button.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\floating-help-button.tsx:16:5\n  14 |\n  15 |   useEffect(() => {\n> 16 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  17 |   }, []);\n  18 |\n  19 |   const button = (","line":16,"column":5,"nodeType":null,"endLine":16,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { createPortal } from \"react-dom\";\nimport { useEffect, useState } from \"react\";\nimport { useTheme } from \"@/components/theme-provider\";\n\ninterface FloatingHelpButtonProps {\n  onClick: () => void;\n}\n\nexport function FloatingHelpButton({ onClick }: FloatingHelpButtonProps) {\n  const { isDark } = useTheme();\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const button = (\n    <button\n      onClick={onClick}\n      className={`fixed bottom-20 lg:bottom-4 right-4 z-[9999] p-2.5 rounded-full transition-all duration-200 shadow-lg ${isDark\n          ? \"bg-slate-900 border border-slate-700 text-slate-400 hover:text-white hover:border-slate-600\"\n          : \"bg-white border border-gray-200 text-gray-400 hover:text-gray-600 hover:border-gray-300\"\n        }`}\n      title=\"Relancer le tutoriel\"\n    >\n      <svg\n        xmlns=\"http://www.w3.org/2000/svg\"\n        width=\"18\"\n        height=\"18\"\n        viewBox=\"0 0 24 24\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n      >\n        <circle cx=\"12\" cy=\"12\" r=\"10\" />\n        <path d=\"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3\" />\n        <path d=\"M12 17h.01\" />\n      </svg>\n    </button>\n  );\n\n  if (!mounted) return null;\n\n  return createPortal(button, document.body);\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\glow-effect.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\gold-particles.tsx","messages":[{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\gold-particles.tsx:51:25\n  49 |     <div className={`absolute inset-0 overflow-hidden pointer-events-none ${className}`}>\n  50 |       {particles.map((i) => {\n> 51 |         const randomX = Math.random() * 100;\n     |                         ^^^^^^^^^^^^^ Cannot call impure function\n  52 |         const randomY = Math.random() * 100;\n  53 |         const randomEndY = Math.random() * 100;\n  54 |         const duration = Math.random() * (speedConfig.max - speedConfig.min) + speedConfig.min;","line":51,"column":25,"nodeType":null,"endLine":51,"endColumn":38},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\gold-particles.tsx:52:25\n  50 |       {particles.map((i) => {\n  51 |         const randomX = Math.random() * 100;\n> 52 |         const randomY = Math.random() * 100;\n     |                         ^^^^^^^^^^^^^ Cannot call impure function\n  53 |         const randomEndY = Math.random() * 100;\n  54 |         const duration = Math.random() * (speedConfig.max - speedConfig.min) + speedConfig.min;\n  55 |         const delay = Math.random() * 3;","line":52,"column":25,"nodeType":null,"endLine":52,"endColumn":38},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\gold-particles.tsx:53:28\n  51 |         const randomX = Math.random() * 100;\n  52 |         const randomY = Math.random() * 100;\n> 53 |         const randomEndY = Math.random() * 100;\n     |                            ^^^^^^^^^^^^^ Cannot call impure function\n  54 |         const duration = Math.random() * (speedConfig.max - speedConfig.min) + speedConfig.min;\n  55 |         const delay = Math.random() * 3;\n  56 |","line":53,"column":28,"nodeType":null,"endLine":53,"endColumn":41},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\gold-particles.tsx:54:26\n  52 |         const randomY = Math.random() * 100;\n  53 |         const randomEndY = Math.random() * 100;\n> 54 |         const duration = Math.random() * (speedConfig.max - speedConfig.min) + speedConfig.min;\n     |                          ^^^^^^^^^^^^^ Cannot call impure function\n  55 |         const delay = Math.random() * 3;\n  56 |\n  57 |         return (","line":54,"column":26,"nodeType":null,"endLine":54,"endColumn":39},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\gold-particles.tsx:55:23\n  53 |         const randomEndY = Math.random() * 100;\n  54 |         const duration = Math.random() * (speedConfig.max - speedConfig.min) + speedConfig.min;\n> 55 |         const delay = Math.random() * 3;\n     |                       ^^^^^^^^^^^^^ Cannot call impure function\n  56 |\n  57 |         return (\n  58 |           <motion.div","line":55,"column":23,"nodeType":null,"endLine":55,"endColumn":36}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { motion } from \"framer-motion\";\n\ninterface GoldParticlesProps {\n  count?: number;\n  className?: string;\n  size?: \"sm\" | \"md\" | \"lg\";\n  opacity?: number;\n  speed?: \"slow\" | \"medium\" | \"fast\";\n}\n\nconst sizeMap = {\n  sm: \"w-0.5 h-0.5\",\n  md: \"w-1 h-1\",\n  lg: \"w-1.5 h-1.5\",\n};\n\nconst speedMap = {\n  slow: { min: 8, max: 12 },\n  medium: { min: 5, max: 8 },\n  fast: { min: 3, max: 5 },\n};\n\n/**\n * Composant d'effets de particules or anim√©es\n * Design System: Luxe & Teranga - Couleur primaire #F4C430\n *\n * @example\n * ```tsx\n * // Particules l√©g√®res en arri√®re-plan\n * <GoldParticles count={8} size=\"sm\" opacity={0.3} speed=\"slow\" />\n *\n * // Effet intense pour sections premium\n * <GoldParticles count={20} size=\"md\" opacity={0.6} speed=\"medium\" />\n * ```\n */\nexport const GoldParticles = ({\n  count = 12,\n  className = \"\",\n  size = \"md\",\n  opacity = 0.4,\n  speed = \"medium\",\n}: GoldParticlesProps) => {\n  const particles = Array.from({ length: count }, (_, i) => i);\n  const speedConfig = speedMap[speed];\n\n  return (\n    <div className={`absolute inset-0 overflow-hidden pointer-events-none ${className}`}>\n      {particles.map((i) => {\n        const randomX = Math.random() * 100;\n        const randomY = Math.random() * 100;\n        const randomEndY = Math.random() * 100;\n        const duration = Math.random() * (speedConfig.max - speedConfig.min) + speedConfig.min;\n        const delay = Math.random() * 3;\n\n        return (\n          <motion.div\n            key={i}\n            className={`absolute rounded-full bg-[#F4C430] ${sizeMap[size]}`}\n            initial={{\n              x: `${randomX}%`,\n              y: `${randomY}%`,\n              opacity: 0,\n            }}\n            animate={{\n              y: [`${randomY}%`, `${randomEndY}%`],\n              opacity: [0, opacity, 0],\n            }}\n            transition={{\n              duration,\n              repeat: Infinity,\n              delay,\n              ease: \"easeInOut\",\n            }}\n          />\n        );\n      })}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\hero-1.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\info-tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\input-otp.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\input.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[261,264],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[261,264],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport * as React from \"react\";\nimport { motion } from \"framer-motion\";\n\nimport { cn } from \"@/lib/utils\";\n\nexport type InputProps = Omit<\n  React.InputHTMLAttributes<HTMLInputElement>,\n  \"onDrag\" | \"onDragStart\" | \"onDragEnd\"\n> & { whileFocus?: any };\n\nexport const Input = React.forwardRef<HTMLInputElement, InputProps>(\n  ({ className, type = \"text\", ...props }, ref) => {\n    return (\n      <motion.input\n        type={type}\n        className={cn(\n          \"flex h-12 w-full rounded-2xl border border-input bg-background px-4 text-[16px] text-foreground transition-all duration-200 placeholder:text-muted-foreground focus-visible:outline-none focus-visible:border-slate-400 dark:focus-visible:border-slate-500\",\n          className\n        )}\n        ref={ref}\n        {...(props as React.ComponentPropsWithoutRef<typeof motion.input>)}\n      />\n    );\n  }\n);\nInput.displayName = \"Input\";\n\n\n\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\loader-blueprint.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\motion-wrapper.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\motion-wrapper.tsx:23:19\n  21 | }: FadeInProps) {\n  22 |   const [mounted, setMounted] = useState(false);\n> 23 |   useEffect(() => setMounted(true), []);\n     |                   ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  24 |\n  25 |   const yOffset = direction === \"up\" ? 20 : direction === \"down\" ? -20 : 0;\n  26 |","line":23,"column":19,"nodeType":null,"endLine":23,"endColumn":29},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\motion-wrapper.tsx:55:19\n  53 | }: StaggerContainerProps) {\n  54 |   const [mounted, setMounted] = useState(false);\n> 55 |   useEffect(() => setMounted(true), []);\n     |                   ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  56 |\n  57 |   return (\n  58 |     <motion.div","line":55,"column":19,"nodeType":null,"endLine":55,"endColumn":29},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\motion-wrapper.tsx:111:19\n  109 | }: ScaleOnHoverProps) {\n  110 |   const [mounted, setMounted] = useState(false);\n> 111 |   useEffect(() => setMounted(true), []);\n      |                   ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  112 |\n  113 |   return (\n  114 |     <motion.div","line":111,"column":19,"nodeType":null,"endLine":111,"endColumn":29}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { motion } from \"framer-motion\";\nimport { type ReactNode, useState, useEffect } from \"react\";\n\ntype FadeInProps = {\n  children: ReactNode;\n  delay?: number;\n  direction?: \"up\" | \"down\" | \"none\";\n  className?: string;\n};\n\n/**\n * Composant pour faire appara√Ætre du contenu au scroll avec un effet de fade\n */\nexport function FadeIn({\n  children,\n  delay = 0,\n  direction = \"up\",\n  className,\n}: FadeInProps) {\n  const [mounted, setMounted] = useState(false);\n  useEffect(() => setMounted(true), []);\n\n  const yOffset = direction === \"up\" ? 20 : direction === \"down\" ? -20 : 0;\n\n  return (\n    <motion.div\n      initial={mounted ? { opacity: 0, y: yOffset } : undefined}\n      whileInView={mounted ? { opacity: 1, y: 0 } : undefined}\n      viewport={{ once: true, margin: \"-50px\" }}\n      transition={{ duration: 0.5, delay, ease: \"easeOut\" as const }}\n      className={className}\n    >\n      {children}\n    </motion.div>\n  );\n}\n\ntype StaggerContainerProps = {\n  children: ReactNode;\n  className?: string;\n  staggerDelay?: number;\n};\n\n/**\n * Wrapper pour les listes/grids qui permet aux enfants d'appara√Ætre en cascade\n */\nexport function StaggerContainer({\n  children,\n  className,\n  staggerDelay = 0.1,\n}: StaggerContainerProps) {\n  const [mounted, setMounted] = useState(false);\n  useEffect(() => setMounted(true), []);\n\n  return (\n    <motion.div\n      initial={mounted ? \"hidden\" : undefined}\n      whileInView={mounted ? \"visible\" : undefined}\n      viewport={{ once: true, margin: \"-50px\" }}\n      variants={{\n        hidden: { opacity: 0 },\n        visible: {\n          opacity: 1,\n          transition: {\n            staggerChildren: staggerDelay,\n          },\n        },\n      }}\n      className={className}\n    >\n      {children}\n    </motion.div>\n  );\n}\n\n/**\n * Variante pour les enfants du StaggerContainer\n */\nexport const staggerItem = {\n  hidden: { opacity: 0, y: 20 },\n  visible: {\n    opacity: 1,\n    y: 0,\n    transition: {\n      duration: 0.5,\n      ease: \"easeOut\" as const,\n    },\n  },\n};\n\ntype ScaleOnHoverProps = {\n  children: ReactNode;\n  className?: string;\n  scale?: number;\n  tapScale?: number;\n};\n\n/**\n * Composant pour les cartes et boutons avec effet de scale au survol\n * @deprecated Utilisez `Touchable` pour un comportement plus natif\n */\nexport function ScaleOnHover({\n  children,\n  className,\n  scale = 1.02,\n  tapScale = 0.98,\n}: ScaleOnHoverProps) {\n  const [mounted, setMounted] = useState(false);\n  useEffect(() => setMounted(true), []);\n\n  return (\n    <motion.div\n      whileHover={mounted ? { scale } : undefined}\n      whileTap={mounted ? { scale: tapScale } : undefined}\n      transition={{\n        type: \"spring\",\n        stiffness: 400,\n        damping: 17,\n      }}\n      className={className}\n    >\n      {children}\n    </motion.div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\optimized-image.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\otp-input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\pagination.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\parallax-video.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\phone-input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\shimmer-effect.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\shooting-stars.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\software-icon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\splash-screen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\stagger-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\testimonial-cards.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":62,"column":7,"nodeType":"JSXOpeningElement","endLine":66,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport * as React from 'react';\nimport { motion, _PanInfo } from 'framer-motion';\n\ninterface Testimonial {\n  id: number;\n  testimonial: string;\n  author: string;\n  role: string;\n  avatarUrl: string;\n}\n\ninterface TestimonialCardProps extends Testimonial {\n  handleShuffle: () => void;\n  position: \"front\" | \"middle\" | \"back\";\n}\n\nexport function TestimonialCard({\n  handleShuffle,\n  testimonial,\n  position,\n  author,\n  role,\n  avatarUrl,\n}: TestimonialCardProps) {\n  const dragRef = React.useRef(0);\n  const isFront = position === \"front\";\n\n  return (\n    <motion.div\n      style={{\n        zIndex: position === \"front\" ? \"2\" : position === \"middle\" ? \"1\" : \"0\",\n      }}\n      animate={{\n        rotate: position === \"front\" ? \"-6deg\" : position === \"middle\" ? \"0deg\" : \"6deg\",\n        x: position === \"front\" ? \"0%\" : position === \"middle\" ? \"33%\" : \"66%\",\n        scale: position === \"front\" ? 1 : position === \"middle\" ? 0.96 : 0.92,\n      }}\n      drag={true}\n      dragElastic={0.35}\n      dragListener={isFront}\n      dragConstraints={{\n        top: 0,\n        left: 0,\n        right: 0,\n        bottom: 0,\n      }}\n      onDragStart={(event, info) => {\n        dragRef.current = info.point.x;\n      }}\n      onDragEnd={(event, info) => {\n        if (dragRef.current - info.point.x > 150) {\n          handleShuffle();\n        }\n        dragRef.current = 0;\n      }}\n      transition={{ duration: 0.35 }}\n      className={`absolute left-0 top-0 grid h-[450px] w-[350px] select-none place-content-center space-y-6 rounded-2xl border-2 border-white/10 bg-zinc-900/80 p-6 shadow-2xl backdrop-blur-xl ${isFront ? \"cursor-grab active:cursor-grabbing hover:border-[#F4C430]/50 transition-colors\" : \"\"\n        }`}\n    >\n      <img\n        src={avatarUrl}\n        alt={`Avatar of ${author}`}\n        className=\"pointer-events-none mx-auto h-24 w-24 rounded-full border-2 border-[#F4C430] object-cover shadow-lg shadow-[#F4C430]/20\"\n      />\n      <span className=\"text-center text-lg italic text-white/80 leading-relaxed\">&quot;{testimonial}&quot;</span>\n      <div className=\"flex flex-col items-center\">\n        <span className=\"text-center text-base font-bold text-white\">{author}</span>\n        <span className=\"text-center text-sm font-medium text-[#F4C430]\">{role}</span>\n      </div>\n    </motion.div>\n  );\n}\n\n// Donn√©es pour les PROPRI√âTAIRES\nconst ownerTestimonials: Testimonial[] = [\n  {\n    id: 1,\n    testimonial: \"Dousell a compl√®tement transform√© ma gestion locative. Les paiements automatiques sont une b√©n√©diction.\",\n    author: \"Aminata Diallo\",\n    role: \"Propri√©taire √† Dakar\",\n    avatarUrl: \"https://images.unsplash.com/photo-1507152832244-10d45c7eda57?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\" // Professional Black Woman\n  },\n  {\n    id: 2,\n    testimonial: \"Depuis que j'utilise Dousell, je n'ai plus aucun retard de paiement. Tout est clair et net.\",\n    author: \"Pape Modou Ndiaye\",\n    role: \"Propri√©taire √† Saly\",\n    avatarUrl: \"https://images.unsplash.com/photo-1522529599102-193c0d76b5b6?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\" // Professional Black Man\n  },\n  {\n    id: 3,\n    testimonial: \"Enfin un outil s√©rieux pour l'immobilier au S√©n√©gal. La transparence des quittances rassure tout le monde.\",\n    author: \"Fatou Ndiaye\",\n    role: \"Investisseuse √† Mermoz\",\n    avatarUrl: \"https://images.unsplash.com/photo-1531123897727-8f129e1688ce?q=80&w=250&auto=format&fit=crop\" // Elegant Black Woman\n  }\n];\n\n// Donn√©es pour les LOCATAIRES\nconst tenantTestimonials: Testimonial[] = [\n  {\n    id: 1,\n    testimonial: \"Trouver un appartement √† Dakar n'a jamais √©t√© aussi simple. Le processus de visite virtuelle m'a fait gagner un temps pr√©cieux !\",\n    author: \"Sophie Diop\",\n    role: \"Locataire √† Mermoz\",\n    avatarUrl: \"https://prod.cdn-medias.jeuneafrique.com/cdn-cgi/image/q=auto,f=auto,metadata=none,width=1215,fit=cover/https://prod.cdn-medias.jeuneafrique.com/medias/2015/01/02/002012015174541000000folorunso.jpg\" // Young Black Woman\n  },\n  {\n    id: 2,\n    testimonial: \"Une transparence totale sur les frais et un √©tat des lieux num√©rique tr√®s rassurant. Je recommande vivement.\",\n    author: \"Cheikh Anta\",\n    role: \"Locataire √† Saly\",\n    avatarUrl: \"https://images.unsplash.com/photo-1531384441138-2736e62e0919?q=80&w=250&auto=format&fit=crop\" // Young Black Man\n  },\n  {\n    id: 3,\n    testimonial: \"Le paiement du loyer par Wave int√©gr√© est un vrai plus. Plus besoin de courir apr√®s les re√ßus.\",\n    author: \"Aminata Faye\",\n    role: \"Locataire au Plateau\",\n    avatarUrl: \"https://images.unsplash.com/photo-1507152832244-10d45c7eda57?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\" // Friendly Black Woman\n  }\n];\n\ninterface ShuffleCardsProps {\n  mode?: \"owner\" | \"tenant\";\n}\n\nexport function ShuffleCards({ mode = \"owner\" }: ShuffleCardsProps) {\n  const [positions, setPositions] = React.useState<(\"front\" | \"middle\" | \"back\")[]>([\"front\", \"middle\", \"back\"]);\n\n  const testimonials = mode === \"owner\" ? ownerTestimonials : tenantTestimonials;\n\n  const handleShuffle = () => {\n    setPositions((prev) => {\n      const newPositions = [...prev];\n      const last = newPositions.pop();\n      if (last) newPositions.unshift(last);\n      return newPositions;\n    });\n  };\n\n  return (\n    <div className=\"grid place-content-center overflow-hidden bg-black px-8 py-24 text-slate-50 w-full relative\">\n      <div className=\"absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-[#F4C430]/10 via-black to-black opacity-50 pointer-events-none\" />\n\n      <div className=\"relative z-10 mb-12 text-center space-y-4\">\n        <h2 className=\"text-3xl md:text-5xl font-bold font-display text-white\">\n          {mode === \"owner\" ? (\n            <>Ils nous font <span className=\"text-[#F4C430]\">confiance</span></>\n          ) : (\n            <>Ils ont trouv√© leur <span className=\"text-[#F4C430]\">bonheur</span></>\n          )}\n        </h2>\n        <p className=\"text-white/60 max-w-lg mx-auto\">\n          {mode === \"owner\"\n            ? \"D√©couvrez les retours de propri√©taires qui automatisent leur gestion avec Dousell.\"\n            : \"D√©couvrez les exp√©riences de locataires qui ont choisi Dousell pour leur logement.\"\n          }\n        </p>\n      </div>\n\n      <div className=\"relative -ml-[100px] h-[450px] w-[350px] md:-ml-[175px] z-10\">\n        {testimonials.map((testimonial, index) => (\n          <TestimonialCard\n            key={testimonial.id}\n            {...testimonial}\n            handleShuffle={handleShuffle}\n            position={positions[index]}\n          />\n        ))}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\testimonial-masonry.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\toggle-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\touchable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\verified-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\ui\\workspace-switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\welcome-modal-client.tsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`cleanUrl` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\welcome-modal-client.tsx:34:9\n  32 |       if (!user) {\n  33 |         // Pas connecte, retirer le param\n> 34 |         cleanUrl();\n     |         ^^^^^^^^ `cleanUrl` accessed before it is declared\n  35 |         return;\n  36 |       }\n  37 |\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\welcome-modal-client.tsx:71:3\n  69 |   }, [welcomeParam, router]);\n  70 |\n> 71 |   const cleanUrl = () => {\n     |   ^^^^^^^^^^^^^^^^^^^^^^^^\n> 72 |     // Retirer ?welcome=true de l'URL sans rechargement\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 73 |     const params = new URLSearchParams(searchParams.toString());\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 74 |     params.delete(\"welcome\");\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 75 |     const newUrl = params.toString() ? `${pathname}?${params.toString()}` : pathname;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 76 |     router.replace(newUrl, { scroll: false });\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 77 |   };\n     | ^^^^^ `cleanUrl` is declared here\n  78 |\n  79 |   const handleClose = () => {\n  80 |     setIsOpen(false);","line":34,"column":9,"nodeType":null,"endLine":34,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'cleanUrl'. Either include it or remove the dependency array.","line":69,"column":6,"nodeType":"ArrayExpression","endLine":69,"endColumn":28,"suggestions":[{"desc":"Update the dependencies array to be: [welcomeParam, router, cleanUrl]","fix":{"range":[1977,1999],"text":"[welcomeParam, router, cleanUrl]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\nimport { Buildings, MagnifyingGlass, ArrowRight, Sparkle, X } from \"@phosphor-icons/react\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\n\r\n/**\r\n * Modal de bienvenue affich√© au-dessus de la page d'accueil\r\n * D√©clench√© par ?welcome=true dans l'URL\r\n * Fermer = rester sur la vitrine (chercher un bien)\r\n */\r\nexport function WelcomeModalContent() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const pathname = usePathname();\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [userName, setUserName] = useState(\"\");\r\n  const welcomeParam = searchParams.get(\"welcome\");\r\n\r\n  useEffect(() => {\r\n    if (welcomeParam !== \"true\") {\r\n      setIsOpen(false);\r\n      return;\r\n    }\r\n\r\n    const loadUser = async () => {\r\n      const supabase = createClient();\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n\r\n      if (!user) {\r\n        // Pas connecte, retirer le param\r\n        cleanUrl();\r\n        return;\r\n      }\r\n\r\n      // Verifier si l'utilisateur a deja une equipe\r\n      const { data: membership } = await supabase\r\n        .from(\"team_members\")\r\n        .select(\"id\")\r\n        .eq(\"user_id\", user.id)\r\n        .eq(\"status\", \"active\")\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (membership) {\r\n        // Deja une equipe, rediriger vers gestion\r\n        router.replace(\"/gestion\");\r\n        return;\r\n      }\r\n\r\n      // Recuperer le nom\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"full_name\")\r\n        .eq(\"id\", user.id)\r\n        .single();\r\n\r\n      setUserName(\r\n        profile?.full_name?.split(\" \")[0] ||\r\n        user.user_metadata?.full_name?.split(\" \")[0] ||\r\n        \"\"\r\n      );\r\n      setIsOpen(true);\r\n    };\r\n\r\n    loadUser();\r\n  }, [welcomeParam, router]);\r\n\r\n  const cleanUrl = () => {\r\n    // Retirer ?welcome=true de l'URL sans rechargement\r\n    const params = new URLSearchParams(searchParams.toString());\r\n    params.delete(\"welcome\");\r\n    const newUrl = params.toString() ? `${pathname}?${params.toString()}` : pathname;\r\n    router.replace(newUrl, { scroll: false });\r\n  };\r\n\r\n  const handleClose = () => {\r\n    setIsOpen(false);\r\n    cleanUrl();\r\n  };\r\n\r\n  const handleActivateGestion = () => {\r\n    setIsOpen(false);\r\n    cleanUrl();\r\n    router.push(\"/pro/start\");\r\n  };\r\n\r\n  return (\r\n    <AnimatePresence>\r\n      {isOpen && (\r\n        <motion.div\r\n          initial={{ opacity: 0 }}\r\n          animate={{ opacity: 1 }}\r\n          exit={{ opacity: 0 }}\r\n          transition={{ duration: 0.2 }}\r\n          className=\"fixed inset-0 z-[100] flex items-center justify-center p-4\"\r\n        >\r\n          {/* Backdrop */}\r\n          <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"absolute inset-0 bg-black/70 backdrop-blur-sm\"\r\n            onClick={handleClose}\r\n          />\r\n\r\n          {/* Modal */}\r\n          <motion.div\r\n            initial={{ opacity: 0, scale: 0.9, y: 20 }}\r\n            animate={{ opacity: 1, scale: 1, y: 0 }}\r\n            exit={{ opacity: 0, scale: 0.95, y: 10 }}\r\n            transition={{ type: \"spring\", damping: 25, stiffness: 300 }}\r\n            className=\"relative z-10 w-full max-w-lg rounded-3xl border border-white/10 bg-[#0a0e17] p-8 shadow-2xl shadow-black/50\"\r\n          >\r\n            {/* Close button */}\r\n            <button\r\n              onClick={handleClose}\r\n              className=\"absolute right-4 top-4 rounded-full p-2 text-white/40 transition-colors hover:bg-white/10 hover:text-white\"\r\n              aria-label=\"Fermer\"\r\n            >\r\n              <X size={20} weight=\"bold\" />\r\n            </button>\r\n\r\n            {/* Success icon */}\r\n            <div className=\"mb-6 flex justify-center\">\r\n              <div className=\"relative\">\r\n                <div className=\"flex h-16 w-16 items-center justify-center rounded-full bg-[#F4C430]/20\">\r\n                  <Sparkle size={32} weight=\"fill\" className=\"text-[#F4C430]\" />\r\n                </div>\r\n                <div className=\"absolute -right-1 -top-1 flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500\">\r\n                  <svg className=\"h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\r\n                  </svg>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Welcome text */}\r\n            <h2 className=\"mb-2 text-center text-2xl font-bold text-white\">\r\n              Bienvenue{userName ? `, ${userName}` : \"\"} !\r\n            </h2>\r\n            <p className=\"mb-8 text-center text-white/50\">\r\n              Que souhaitez-vous faire ?\r\n            </p>\r\n\r\n            {/* Action cards */}\r\n            <div className=\"grid gap-3 sm:grid-cols-2\">\r\n              {/* Chercher un bien */}\r\n              <button\r\n                onClick={handleClose}\r\n                className=\"group rounded-2xl border border-white/10 bg-white/5 p-5 text-left transition-all duration-200 hover:border-white/20 hover:bg-white/10\"\r\n              >\r\n                <div className=\"mb-3 flex h-10 w-10 items-center justify-center rounded-xl bg-white/10 transition-colors group-hover:bg-white/15\">\r\n                  <MagnifyingGlass size={20} className=\"text-white\" />\r\n                </div>\r\n                <h3 className=\"mb-1 text-sm font-semibold text-white\">Chercher un bien</h3>\r\n                <p className=\"mb-3 text-xs text-white/40\">\r\n                  Explorez les annonces immobilieres\r\n                </p>\r\n                <span className=\"flex items-center gap-1 text-xs font-medium text-[#F4C430] transition-all group-hover:gap-2\">\r\n                  Voir les annonces\r\n                  <ArrowRight size={14} />\r\n                </span>\r\n              </button>\r\n\r\n              {/* Gerer mes biens */}\r\n              <button\r\n                onClick={handleActivateGestion}\r\n                className=\"group rounded-2xl border border-[#F4C430]/30 bg-gradient-to-br from-[#F4C430]/10 to-[#F4C430]/5 p-5 text-left transition-all duration-200 hover:border-[#F4C430]/50\"\r\n              >\r\n                <div className=\"mb-3 flex h-10 w-10 items-center justify-center rounded-xl bg-[#F4C430]/20 transition-colors group-hover:bg-[#F4C430]/30\">\r\n                  <Buildings size={20} className=\"text-[#F4C430]\" />\r\n                </div>\r\n                <h3 className=\"mb-1 text-sm font-semibold text-white\">Gerer mes biens</h3>\r\n                <p className=\"mb-3 text-xs text-white/40\">\r\n                  Gestion locative professionnelle\r\n                </p>\r\n                <span className=\"flex items-center gap-1 text-xs font-medium text-[#F4C430] transition-all group-hover:gap-2\">\r\n                  Essai gratuit 14 jours\r\n                  <ArrowRight size={14} />\r\n                </span>\r\n              </button>\r\n            </div>\r\n\r\n            {/* Bottom note */}\r\n            <p className=\"mt-6 text-center text-[11px] text-white/30\">\r\n              Vous pouvez changer d&apos;avis a tout moment depuis votre compte.\r\n            </p>\r\n          </motion.div>\r\n        </motion.div>\r\n      )}\r\n    </AnimatePresence>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\welcome-modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\wizard\\estimation-wizard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\LockedSidebarItem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\OwnerRoleSwitcher.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\TeamSwitcher.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\TemporaryAccessWidget.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\TemporaryAccessWidget.tsx:209:5\n  207 |   // Mettre √† jour le countdown chaque seconde\n  208 |   useEffect(() => {\n> 209 |     calculateTimeRemaining();\n      |     ^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  210 |     const interval = setInterval(calculateTimeRemaining, 1000);\n  211 |     return () => clearInterval(interval);\n  212 |   }, [calculateTimeRemaining]);","line":209,"column":5,"nodeType":null,"endLine":209,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\n/**\n * TemporaryAccessWidget - Widget pour afficher les permissions temporaires actives\n *\n * Affiche dans la sidebar:\n * - Badge avec nombre de permissions actives\n * - Liste d√©roulante des permissions avec temps restant (hh:mm)\n * - Lien vers l'onglet Acc√®s Temporaire de la page √âquipe\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { _useRouter } from \"next/navigation\";\nimport { createClient } from \"@/utils/supabase/client\";\nimport {\n  KeyRound,\n  Clock,\n  ChevronDown,\n  ChevronUp,\n  _ExternalLink,\n  Lock,\n  MousePointerClick,\n  ArrowRight,\n} from \"lucide-react\";\nimport Link from \"next/link\";\nimport { cn } from \"@/lib/utils\";\n\ninterface TemporaryPermission {\n  id: string;\n  permission: string;\n  expires_at: string;\n  granted_by: string;\n  reason?: string;\n}\n\n/**\n * Widget des permissions temporaires pour la sidebar\n */\nexport function TemporaryAccessWidget({ collapsed = false }: { collapsed?: boolean }) {\n  const [permissions, setPermissions] = useState<TemporaryPermission[]>([]);\n  const [isExpanded, setIsExpanded] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    const loadPermissions = async () => {\n      try {\n        const supabase = createClient();\n\n        // R√©cup√©rer l'utilisateur connect√©\n        const { data: { user } } = await supabase.auth.getUser();\n        if (!user) {\n          setIsLoading(false);\n          return;\n        }\n\n        // R√©cup√©rer le team_id de l'utilisateur\n        const { data: teamMember } = await supabase\n          .from(\"team_members\")\n          .select(\"team_id\")\n          .eq(\"user_id\", user.id)\n          .eq(\"status\", \"active\")\n          .maybeSingle();\n\n        if (!teamMember?.team_id) {\n          setIsLoading(false);\n          return;\n        }\n\n        // R√©cup√©rer les permissions temporaires\n        const { data } = await supabase.rpc(\"get_active_temporary_permissions\", {\n          p_team_id: teamMember.team_id,\n          p_user_id: user.id,\n        });\n\n        setPermissions(data || []);\n      } catch (error) {\n        console.error(\"[TemporaryAccessWidget] Error loading permissions:\", error);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    loadPermissions();\n\n    // Rafra√Æchir toutes les 30 secondes\n    const interval = setInterval(loadPermissions, 30000);\n\n    return () => clearInterval(interval);\n  }, []);\n\n  if (isLoading) return null;\n  if (permissions.length === 0) return null;\n\n  // Mode collapsed (sidebar r√©tract√©e)\n  if (collapsed) {\n    return (\n      <div className=\"px-2 py-2\">\n        <div\n          className=\"relative flex items-center justify-center w-full h-10 rounded-lg bg-amber-100 hover:bg-amber-200 dark:bg-amber-500/10 dark:hover:bg-amber-500/20 transition-colors cursor-pointer\"\n          title={`${permissions.length} permission(s) temporaire(s)`}\n        >\n          <KeyRound size={20} className=\"text-amber-700 dark:text-amber-400\" />\n          <span className=\"absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-amber-600 dark:bg-amber-500 rounded-full shadow-sm border border-white dark:border-transparent\">\n            {permissions.length}\n          </span>\n        </div>\n      </div>\n    );\n  }\n\n  // Mode √©tendu\n  return (\n    <div className=\"px-3 py-2\">\n      <button\n        onClick={() => setIsExpanded(!isExpanded)}\n        className=\"w-full flex items-center justify-between p-2 rounded-lg bg-amber-100 hover:bg-amber-200 dark:bg-amber-500/10 dark:hover:bg-amber-500/20 transition-colors\"\n      >\n        <div className=\"flex items-center gap-2\">\n          <KeyRound size={18} className=\"text-amber-700 dark:text-amber-400\" />\n          <span className=\"text-sm font-bold text-zinc-900 dark:text-zinc-200\">\n            Acc√®s temporaires\n          </span>\n          <span className=\"flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-amber-600 dark:bg-amber-500 rounded-full\">\n            {permissions.length}\n          </span>\n        </div>\n        {isExpanded ? (\n          <ChevronUp size={16} className=\"text-zinc-600 dark:text-zinc-400\" />\n        ) : (\n          <ChevronDown size={16} className=\"text-zinc-600 dark:text-zinc-400\" />\n        )}\n      </button>\n\n      {isExpanded && (\n        <div className=\"mt-2 space-y-2\">\n          {permissions.map((perm) => (\n            <PermissionItem key={perm.id} permission={perm} />\n          ))}\n\n          {/* Indice pour demander un acc√®s */}\n          <div className=\"flex items-start gap-2 p-2 rounded-lg bg-zinc-100 dark:bg-zinc-800/30 border border-zinc-200 dark:border-zinc-700/30\">\n            <MousePointerClick size={14} className=\"text-zinc-500 mt-0.5 shrink-0\" />\n            <p className=\"text-[10px] text-zinc-600 dark:text-zinc-500 leading-tight\">\n              Cliquez sur un acc√®s ci-dessus pour y acc√©der, ou sur une section <Lock size={10} className=\"inline text-amber-500\" /> pour en demander un nouveau\n            </p>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n/**\n * Retourne l'URL de la section correspondant √† la permission\n */\nfunction getPermissionUrl(permission: string): string {\n  const prefix = permission.split(\".\")[0];\n  const urlMap: Record<string, string> = {\n    properties: \"/gestion/biens\",\n    leases: \"/gestion\", // Baux dans le dashboard principal\n    tenants: \"/gestion\", // Locataires dans le dashboard principal\n    payments: \"/gestion/comptabilite\",\n    expenses: \"/gestion/comptabilite\",\n    maintenance: \"/gestion/interventions\",\n    documents: \"/gestion/documents\",\n    inventory: \"/gestion/etats-lieux\",\n    team: \"/gestion/equipe\",\n    reports: \"/gestion/comptabilite\",\n  };\n  return urlMap[prefix] || \"/gestion\";\n}\n\n/**\n * √âl√©ment de permission individuel avec countdown en temps r√©el\n */\nfunction PermissionItem({ permission }: { permission: TemporaryPermission }) {\n  const [timeRemaining, setTimeRemaining] = useState(\"\");\n  const [isExpiringSoon, setIsExpiringSoon] = useState(false);\n\n  // Calculer le temps restant\n  const calculateTimeRemaining = useCallback(() => {\n    const expiresAt = new Date(permission.expires_at);\n    const now = new Date();\n    const diffMs = expiresAt.getTime() - now.getTime();\n\n    if (diffMs <= 0) {\n      setTimeRemaining(\"Expir√©\");\n      setIsExpiringSoon(true);\n      return;\n    }\n\n    const hours = Math.floor(diffMs / (1000 * 60 * 60));\n    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));\n    const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);\n\n    // Format hh:mm:ss ou mm:ss si moins d'une heure\n    if (hours > 0) {\n      setTimeRemaining(`${hours.toString().padStart(2, \"0\")}:${minutes.toString().padStart(2, \"0\")}:${seconds.toString().padStart(2, \"0\")}`);\n    } else {\n      setTimeRemaining(`${minutes.toString().padStart(2, \"0\")}:${seconds.toString().padStart(2, \"0\")}`);\n    }\n\n    // Expire bient√¥t si moins de 30 minutes\n    setIsExpiringSoon(diffMs < 30 * 60 * 1000);\n  }, [permission.expires_at]);\n\n  // Mettre √† jour le countdown chaque seconde\n  useEffect(() => {\n    calculateTimeRemaining();\n    const interval = setInterval(calculateTimeRemaining, 1000);\n    return () => clearInterval(interval);\n  }, [calculateTimeRemaining]);\n\n  const targetUrl = getPermissionUrl(permission.permission);\n\n  return (\n    <Link\n      href={targetUrl}\n      className={cn(\n        \"block p-2 rounded-lg border shadow-sm transition-all hover:scale-[1.02] hover:shadow-md\",\n        isExpiringSoon\n          ? \"bg-red-50 dark:bg-red-500/10 border-red-200 dark:border-red-500/30\"\n          : \"bg-white dark:bg-zinc-800/50 border-zinc-200 dark:border-zinc-700/50 hover:border-amber-300 dark:hover:border-amber-500/50\"\n      )}\n    >\n      <div className=\"flex items-start justify-between gap-2\">\n        <div className=\"flex-1 min-w-0\">\n          <p className=\"text-xs font-medium text-zinc-900 dark:text-zinc-200 truncate\">\n            {getPermissionLabel(permission.permission)}\n          </p>\n          <div className=\"flex items-center gap-1.5 mt-1\">\n            <Clock\n              size={12}\n              className={isExpiringSoon ? \"text-red-500 dark:text-red-400 animate-pulse\" : \"text-amber-600 dark:text-amber-400\"}\n            />\n            <span\n              className={cn(\n                \"text-xs font-mono tabular-nums\",\n                isExpiringSoon ? \"text-red-600 dark:text-red-400 font-semibold\" : \"text-zinc-500 dark:text-zinc-400\"\n              )}\n            >\n              {timeRemaining}\n            </span>\n          </div>\n        </div>\n        <ArrowRight size={14} className=\"text-amber-500 shrink-0 mt-0.5\" />\n      </div>\n      {permission.reason && (\n        <p className=\"mt-1 text-xs text-zinc-500 line-clamp-1\">\n          {permission.reason}\n        </p>\n      )}\n    </Link>\n  );\n}\n\n/**\n * Convertit une cl√© de permission en label lisible\n */\nfunction getPermissionLabel(permission: string): string {\n  const labels: Record<string, string> = {\n    \"leases.view\": \"Voir baux\",\n    \"leases.create\": \"Cr√©er baux\",\n    \"leases.edit\": \"√âditer baux\",\n    \"leases.delete\": \"Supprimer baux\",\n    \"leases.terminate\": \"R√©silier baux\",\n    \"tenants.view\": \"Voir locataires\",\n    \"tenants.edit\": \"√âditer locataires\",\n    \"tenants.contact\": \"Contacter locataires\",\n    \"payments.view\": \"Voir paiements\",\n    \"payments.confirm\": \"Confirmer paiements\",\n    \"payments.void\": \"Annuler paiements\",\n    \"payments.receipts\": \"Quittances\",\n    \"expenses.view\": \"Voir d√©penses\",\n    \"expenses.create\": \"Cr√©er d√©penses\",\n    \"expenses.approve\": \"Approuver d√©penses\",\n    \"expenses.delete\": \"Supprimer d√©penses\",\n    \"maintenance.view\": \"Voir maintenance\",\n    \"maintenance.create\": \"Cr√©er maintenance\",\n    \"maintenance.approve_quote\": \"Approuver devis\",\n    \"maintenance.complete\": \"Terminer maintenance\",\n    \"documents.view\": \"Voir documents\",\n    \"documents.generate\": \"G√©n√©rer documents\",\n    \"documents.delete\": \"Supprimer documents\",\n    \"properties.view\": \"Voir biens\",\n    \"properties.create\": \"Cr√©er biens\",\n    \"properties.edit\": \"√âditer biens\",\n    \"properties.publish\": \"Publier biens\",\n    \"properties.delete\": \"Supprimer biens\",\n    \"reports.view\": \"Voir rapports\",\n    \"reports.export\": \"Exporter rapports\",\n    \"team.members.view\": \"Voir membres\",\n    \"team.members.invite\": \"Inviter membres\",\n    \"team.members.edit_role\": \"Modifier r√¥les\",\n    \"team.members.remove\": \"Supprimer membres\",\n    \"team.settings.view\": \"Voir param√®tres\",\n    \"team.settings.edit\": \"√âditer param√®tres\",\n    \"team.audit.view\": \"Voir audit\",\n  };\n\n  return labels[permission] || permission;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\TemporaryPermissionsWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\workspace-bottom-nav.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\workspace-bottom-nav.tsx:75:5\n  73 |\n  74 |   useEffect(() => {\n> 75 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  76 |     // Get user and team for badge counts\n  77 |     const supabase = createClient();\n  78 |     supabase.auth.getUser().then(({ data: { user } }) => {","line":75,"column":5,"nodeType":null,"endLine":75,"endColumn":15},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\workspace-bottom-nav.tsx:168:5\n  166 |   // Toujours visible au changement de page\n  167 |   useEffect(() => {\n> 168 |     setIsVisible(true);\n      |     ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  169 |     lastScrollY.current = 0;\n  170 |   }, [pathname]);\n  171 |","line":168,"column":5,"nodeType":null,"endLine":168,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Link from \"next/link\";\r\nimport { usePathname } from \"next/navigation\";\r\nimport { useMemo, useState, useEffect, useRef, _useCallback } from \"react\";\r\nimport { useOwnerUnreadCounts } from \"@/hooks/use-unread-counts\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\nimport {\r\n  Building2,\r\n  Home,\r\n  Wrench,\r\n  Wallet,\r\n  User,\r\n  FileText,\r\n  CreditCard,\r\n  BarChart3,\r\n  Users,\r\n  Shield,\r\n  Heart,\r\n  Settings,\r\n} from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport type { LucideIcon } from \"lucide-react\";\r\n\r\ninterface NavItem {\r\n  href: string;\r\n  icon: LucideIcon;\r\n  label: string;\r\n}\r\n\r\n// Navigation pour propri√©taires (/gestion) - 4 items principaux\r\nconst gestionNavItems: NavItem[] = [\r\n  { href: \"/gestion\", icon: BarChart3, label: \"Dashboard\" },\r\n  { href: \"/gestion/biens\", icon: Building2, label: \"Biens\" },\r\n  { href: \"/gestion/interventions\", icon: Wrench, label: \"Travaux\" },\r\n  { href: \"/gestion/comptabilite\", icon: Wallet, label: \"Compta\" },\r\n];\r\n\r\n// Navigation pour locataires (/locataire)\r\nconst locataireNavItems: NavItem[] = [\r\n  { href: \"/locataire\", icon: Home, label: \"Accueil\" },\r\n  { href: \"/locataire/documents\", icon: FileText, label: \"Documents\" },\r\n  { href: \"/locataire/paiements\", icon: CreditCard, label: \"Paiements\" },\r\n  { href: \"/locataire/maintenance\", icon: Wrench, label: \"Demandes\" },\r\n];\r\n\r\n// Navigation pour admin (/admin)\r\nconst adminNavItems: NavItem[] = [\r\n  { href: \"/admin\", icon: BarChart3, label: \"Dashboard\" },\r\n  { href: \"/admin/users\", icon: Users, label: \"Users\" },\r\n  { href: \"/admin/verifications\", icon: Shield, label: \"V√©rifs\" },\r\n  { href: \"/admin/moderation\", icon: Settings, label: \"Mod√©ration\" },\r\n];\r\n\r\n// Navigation pour compte (/compte)\r\nconst compteNavItems: NavItem[] = [\r\n  { href: \"/compte\", icon: User, label: \"Profil\" },\r\n  { href: \"/compte/mes-biens\", icon: Building2, label: \"Mes Biens\" },\r\n  { href: \"/compte/favoris\", icon: Heart, label: \"Favoris\" },\r\n  { href: \"/compte/parametres\", icon: Settings, label: \"Param√®tres\" },\r\n];\r\n\r\nexport function WorkspaceBottomNav() {\r\n  const pathname = usePathname();\r\n  const [isVisible, setIsVisible] = useState(true);\r\n  const [mounted, setMounted] = useState(false);\r\n  const lastScrollY = useRef(0);\r\n  const ticking = useRef(false);\r\n  const scrollContainerRef = useRef<Element | null>(null);\r\n  const scrollHandlerRef = useRef<(() => void) | null>(null);\r\n  const [userId, setUserId] = useState<string | null>(null);\r\n  const [teamId, setTeamId] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    setMounted(true);\r\n    // Get user and team for badge counts\r\n    const supabase = createClient();\r\n    supabase.auth.getUser().then(({ data: { user } }) => {\r\n      if (user) {\r\n        setUserId(user.id);\r\n        // Get active team from cookie or team_members\r\n        const savedTeam = document.cookie\r\n          .split(\"; \")\r\n          .find((c) => c.startsWith(\"current_team_id=\"))\r\n          ?.split(\"=\")[1];\r\n        if (savedTeam) setTeamId(savedTeam);\r\n      }\r\n    });\r\n  }, []);\r\n\r\n  const badgeCounts = useOwnerUnreadCounts(\r\n    pathname?.startsWith(\"/gestion\") ? userId : null,\r\n    teamId\r\n  );\r\n\r\n\r\n  // D√©terminer le contexte et les items de navigation\r\n  const navItems = useMemo(() => {\r\n    if (pathname?.startsWith(\"/gestion\")) return gestionNavItems;\r\n    if (pathname?.startsWith(\"/locataire\")) return locataireNavItems;\r\n    if (pathname?.startsWith(\"/admin\")) return adminNavItems;\r\n    return compteNavItems;\r\n  }, [pathname]);\r\n\r\n  useEffect(() => {\r\n    // Attendre que le DOM soit stable avant de chercher le conteneur\r\n    // (√©vite les race conditions sur mobile lors de la navigation)\r\n    const timeoutId = setTimeout(() => {\r\n      try {\r\n        const scrollContainer = document.querySelector(\"main.overflow-y-auto\");\r\n        if (!scrollContainer) return;\r\n\r\n        // Initialisation\r\n        const initVisibility = () => {\r\n          if (scrollContainer.scrollTop > 100) {\r\n            setIsVisible(false);\r\n          } else {\r\n            setIsVisible(true);\r\n          }\r\n          lastScrollY.current = scrollContainer.scrollTop;\r\n        };\r\n\r\n        initVisibility();\r\n\r\n        const handleScroll = () => {\r\n          if (!ticking.current) {\r\n            requestAnimationFrame(() => {\r\n              const currentScrollY = scrollContainer.scrollTop;\r\n              const scrollDelta = currentScrollY - lastScrollY.current;\r\n\r\n              if (Math.abs(scrollDelta) > 10) {\r\n                if (scrollDelta > 0 && currentScrollY > 100) {\r\n                  setIsVisible(false);\r\n                } else if (scrollDelta < 0) {\r\n                  setIsVisible(true);\r\n                }\r\n                lastScrollY.current = currentScrollY;\r\n              }\r\n\r\n              ticking.current = false;\r\n            });\r\n            ticking.current = true;\r\n          }\r\n        };\r\n\r\n        scrollContainer.addEventListener(\"scroll\", handleScroll, { passive: true });\r\n\r\n        // Stocker la ref pour le cleanup\r\n        scrollContainerRef.current = scrollContainer;\r\n        scrollHandlerRef.current = handleScroll;\r\n      } catch (_err) {\r\n        // Silently ignore DOM errors on mobile navigation\r\n      }\r\n    }, 150);\r\n\r\n    return () => {\r\n      clearTimeout(timeoutId);\r\n      const container = scrollContainerRef.current;\r\n      const handler = scrollHandlerRef.current;\r\n      if (container && handler) {\r\n        container.removeEventListener(\"scroll\", handler);\r\n      }\r\n    };\r\n  }, [pathname]);\r\n\r\n  // Toujours visible au changement de page\r\n  useEffect(() => {\r\n    setIsVisible(true);\r\n    lastScrollY.current = 0;\r\n  }, [pathname]);\r\n\r\n  if (!mounted) return null;\r\n\r\n  return (\r\n    <nav\r\n\r\n      className={cn(\r\n        \"fixed inset-x-0 bottom-0 z-40 border-t border-border bg-background/80 backdrop-blur-lg lg:hidden print:hidden\",\r\n        \"transition-transform duration-300 ease-out\",\r\n        !isVisible && \"translate-y-full\"\r\n      )}\r\n      style={{\r\n        paddingBottom: \"env(safe-area-inset-bottom)\",\r\n      }}\r\n    >\r\n      <div className=\"flex h-16 items-center justify-between px-4\">\r\n        {navItems.map((item) => {\r\n          const isActive =\r\n            pathname === item.href ||\r\n            (item.href !== \"/gestion\" &&\r\n              item.href !== \"/locataire\" &&\r\n              item.href !== \"/admin\" &&\r\n              item.href !== \"/compte\" &&\r\n              pathname?.startsWith(`${item.href}/`));\r\n\r\n          const Icon = item.icon;\r\n\r\n          // Badge count for this item\r\n          const badgeCount = item.href === \"/gestion/interventions\"\r\n            ? badgeCounts.pendingMaintenance\r\n            : item.href === \"/gestion/comptabilite\"\r\n              ? 0\r\n              : 0;\r\n\r\n          return (\r\n            <Link\r\n              key={item.href}\r\n              href={item.href}\r\n              prefetch={false} // Disable prefetch to prevent stale RSC cache\r\n              className=\"flex flex-1 flex-col items-center justify-center gap-1 min-w-0\"\r\n            >\r\n              <span\r\n                className={cn(\r\n                  \"relative inline-flex h-6 w-6 shrink-0 items-center justify-center rounded-lg transition-all duration-200\",\r\n                  isActive\r\n                    ? \"text-[#F4C430] bg-[#F4C430]/10\"\r\n                    : \"text-muted-foreground\"\r\n                )}\r\n              >\r\n                <Icon\r\n                  className=\"h-5 w-5\"\r\n                  strokeWidth={isActive ? 2.5 : 1.5}\r\n                />\r\n                {badgeCount > 0 && (\r\n                  <span className=\"absolute -top-1.5 -right-2.5 flex h-4 min-w-4 items-center justify-center rounded-full bg-red-500 px-0.5 text-[9px] font-bold text-white\">\r\n                    {badgeCount > 9 ? \"9+\" : badgeCount}\r\n                  </span>\r\n                )}\r\n              </span>\r\n              <span\r\n                className={cn(\r\n                  \"truncate w-full text-center text-[10px] font-medium transition-colors duration-200\",\r\n                  isActive ? \"text-[#F4C430] font-semibold\" : \"text-muted-foreground\"\r\n                )}\r\n              >\r\n                {item.label}\r\n              </span>\r\n            </Link>\r\n          );\r\n        })}\r\n      </div>\r\n    </nav>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\workspace-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\components\\workspace\\workspace-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\config\\roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\constants\\coordinates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\constants\\senegal.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\data\\landing-data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\data\\properties.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\AccessApproved.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\AccessExpiring.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\AccessRejected.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\AccessRequestNotification.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\appointment-confirmation-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\listing-approved-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\listing-rejected-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\listing-submitted-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\password-reset-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\verification-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\emails\\visit-request-email.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\fix_entities.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst lintJsonPath = path.join(__dirname, 'lint_errors.json');\r\nconst data = JSON.parse(fs.readFileSync(lintJsonPath, 'utf8'));\r\n\r\nconst entitiesMap = {\r\n    \"'\": \"&apos;\",\r\n    '\"': \"&quot;\",\r\n    '>': \"&gt;\",\r\n    '}': \"&#125;\"\r\n};\r\n\r\nconst fileFixes = {};\r\n\r\ndata.forEach(fileResult => {\r\n    const filePath = fileResult.filePath;\r\n    const errors = fileResult.messages.filter(m => m.ruleId === 'react/no-unescaped-entities');\r\n\r\n    if (errors.length > 0) {\r\n        if (!fileFixes[filePath]) fileFixes[filePath] = [];\r\n        fileFixes[filePath].push(...errors);\r\n    }\r\n});\r\n\r\nObject.keys(fileFixes).forEach(filePath => {\r\n    if (!fs.existsSync(filePath)) return;\r\n\r\n    let content = fs.readFileSync(filePath, 'utf8');\r\n    let lines = content.split('\\n');\r\n\r\n    // Sort errors for this file in descending order (line and then column)\r\n    // to avoid index shifting problems.\r\n    const errors = fileFixes[filePath].sort((a, b) => {\r\n        if (a.line !== b.line) return b.line - a.line;\r\n        return b.column - a.column;\r\n    });\r\n\r\n    errors.forEach(error => {\r\n        const lineIdx = error.line - 1;\r\n        const colIdx = error.column - 1;\r\n        const line = lines[lineIdx];\r\n\r\n        if (!line) return;\r\n\r\n        const charToReplace = line[colIdx];\r\n        const replacement = entitiesMap[charToReplace];\r\n\r\n        if (replacement) {\r\n            const newLine = line.substring(0, colIdx) + replacement + line.substring(colIdx + 1);\r\n            lines[lineIdx] = newLine;\r\n        } else {\r\n            console.warn(`No replacement for char \"${charToReplace}\" at ${filePath}:${error.line}:${error.column}`);\r\n        }\r\n    });\r\n\r\n    fs.writeFileSync(filePath, lines.join('\\n'), 'utf8');\r\n    console.log(`Fixed ${errors.length} entities in ${filePath}`);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\fix_hooks_tours.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst toursDir = path.join(__dirname, 'components', 'gestion', 'tours');\r\nconst files = fs.readdirSync(toursDir).filter(f => f.endsWith('.tsx'));\r\n\r\nfiles.forEach(file => {\r\n    const filePath = path.join(toursDir, file);\r\n    let content = fs.readFileSync(filePath, 'utf8');\r\n    let changed = false;\r\n\r\n    // 1. Fix checkMobile() -> setTimeout(checkMobile, 0)\r\n    const checkMobileRegex = /        checkMobile\\(\\);/g;\r\n    if (checkMobileRegex.test(content)) {\r\n        content = content.replace(checkMobileRegex, '        // Use setTimeout to avoid synchronous setState in effect\\n        setTimeout(checkMobile, 0);');\r\n        changed = true;\r\n    }\r\n\r\n    // 2. Fix setIsBottomNavVisible(false) -> setTimeout(() => setIsBottomNavVisible(false), 0)\r\n    const bottomNavRegex = /            setIsBottomNavVisible\\(false\\);/g;\r\n    if (bottomNavRegex.test(content)) {\r\n        content = content.replace(bottomNavRegex, '            // Use setTimeout to avoid synchronous setState in effect\\n            setTimeout(() => setIsBottomNavVisible(false), 0);');\r\n        changed = true;\r\n    }\r\n\r\n    // 3. Fix setMounted(true) -> setTimeout(() => setMounted(true), 0)\r\n    // Only if it's within a useEffect likely to trigger the warning\r\n    const mountedRegex = /        setMounted\\(true\\);/g;\r\n    if (mountedRegex.test(content)) {\r\n        content = content.replace(mountedRegex, '        // Use setTimeout to avoid synchronous setState in effect\\n        setTimeout(() => setMounted(true), 0);');\r\n        changed = true;\r\n    }\r\n\r\n    if (changed) {\r\n        fs.writeFileSync(filePath, content);\r\n        console.log(`Fixed hooks in ${file}`);\r\n    }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\fix_unused.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst lintJsonPath = path.join(__dirname, 'lint_errors_v2.json');\r\nconst data = JSON.parse(fs.readFileSync(lintJsonPath, 'utf8'));\r\n\r\nconst fileFixes = {};\r\n\r\ndata.forEach(fileResult => {\r\n    const filePath = fileResult.filePath;\r\n    const errors = fileResult.messages.filter(m => m.ruleId === '@typescript-eslint/no-unused-vars');\r\n\r\n    if (errors.length > 0) {\r\n        if (!fileFixes[filePath]) fileFixes[filePath] = [];\r\n        fileFixes[filePath].push(...errors);\r\n    }\r\n});\r\n\r\nObject.keys(fileFixes).forEach(filePath => {\r\n    if (!fs.existsSync(filePath)) return;\r\n\r\n    let content = fs.readFileSync(filePath, 'utf8');\r\n    let lines = content.split('\\n');\r\n\r\n    // Sort errors for this file in descending order (line and then column)\r\n    const errors = fileFixes[filePath].sort((a, b) => {\r\n        if (a.line !== b.line) return b.line - a.line;\r\n        return b.column - a.column;\r\n    });\r\n\r\n    errors.forEach(error => {\r\n        const lineIdx = error.line - 1;\r\n        const colIdx = error.column - 1;\r\n        const line = lines[lineIdx];\r\n\r\n        if (!line) return;\r\n\r\n        // Match the variable name from the message: \"'varName' is defined but never used.\"\r\n        const match = error.message.match(/'([^']+)'/);\r\n        if (!match) return;\r\n\r\n        const varName = match[1];\r\n\r\n        // Find the variable in the line at or near colIdx\r\n        const textAtCol = line.substring(colIdx);\r\n        if (textAtCol.startsWith(varName)) {\r\n            const newLine = line.substring(0, colIdx) + '_' + line.substring(colIdx);\r\n            lines[lineIdx] = newLine;\r\n        } else {\r\n            // Some variables might be slightly off in column or inside a destructive assignment\r\n            // We search for the first occurrence of varName after colIdx-5\r\n            const searchStart = Math.max(0, colIdx - 2);\r\n            const relativeIdx = line.substring(searchStart).indexOf(varName);\r\n            if (relativeIdx !== -1) {\r\n                const absoluteIdx = searchStart + relativeIdx;\r\n                const newLine = line.substring(0, absoluteIdx) + '_' + line.substring(absoluteIdx);\r\n                lines[lineIdx] = newLine;\r\n            } else {\r\n                console.warn(`Could not find \"${varName}\" at ${filePath}:${error.line}:${error.column}`);\r\n            }\r\n        }\r\n    });\r\n\r\n    fs.writeFileSync(filePath, lines.join('\\n'), 'utf8');\r\n    console.log(`Prefixed ${errors.length} variables in ${filePath}`);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-cookie-consent.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-debounce.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-mounted.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-mounted.ts:13:9\n  11 |\n  12 |     useEffect(() => {\n> 13 |         setMounted(true);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  14 |     }, []);\n  15 |\n  16 |     return mounted;","line":13,"column":9,"nodeType":null,"endLine":13,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\n\r\n/**\r\n * Hook to detect when a component has mounted on the client.\r\n * Useful for preventing hydration mismatches when using client-only state (like localStorage).\r\n */\r\nexport function useMounted() {\r\n    const [mounted, setMounted] = useState(false);\r\n\r\n    useEffect(() => {\r\n        setMounted(true);\r\n    }, []);\r\n\r\n    return mounted;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-reduced-motion.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-reduced-motion.ts:22:9\n  20 |\n  21 |         // Set initial value\n> 22 |         setPrefersReducedMotion(mediaQuery.matches);\n     |         ^^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  23 |\n  24 |         // Listen for changes\n  25 |         const handleChange = (event: MediaQueryListEvent) => {","line":22,"column":9,"nodeType":null,"endLine":22,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\n\n/**\n * Hook to detect if the user prefers reduced motion\n * Respects the `prefers-reduced-motion` CSS media query\n * \n * @returns true if the user prefers reduced motion, false otherwise\n */\nexport function useReducedMotion(): boolean {\n    const [prefersReducedMotion, setPrefersReducedMotion] = useState(false);\n\n    useEffect(() => {\n        // Check if we're in the browser\n        if (typeof window === \"undefined\") return;\n\n        // Get the media query\n        const mediaQuery = window.matchMedia(\"(prefers-reduced-motion: reduce)\");\n\n        // Set initial value\n        setPrefersReducedMotion(mediaQuery.matches);\n\n        // Listen for changes\n        const handleChange = (event: MediaQueryListEvent) => {\n            setPrefersReducedMotion(event.matches);\n        };\n\n        // Modern browsers\n        mediaQuery.addEventListener(\"change\", handleChange);\n\n        // Cleanup\n        return () => {\n            mediaQuery.removeEventListener(\"change\", handleChange);\n        };\n    }, []);\n\n    return prefersReducedMotion;\n}\n\n/**\n * Check if user prefers reduced motion (non-hook version for GSAP)\n * Use this inside GSAP callbacks where hooks can't be used\n */\nexport function prefersReducedMotion(): boolean {\n    if (typeof window === \"undefined\") return false;\n    return window.matchMedia(\"(prefers-reduced-motion: reduce)\").matches;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-scroll-position.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-search-filters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-unread-counts.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-unread-counts.ts:97:5\n   95 |\n   96 |   useEffect(() => {\n>  97 |     fetchCounts();\n      |     ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n   98 |\n   99 |     // Poll every 30s for tenants (no realtime since no auth)\n  100 |     const interval = setInterval(fetchCounts, 30000);","line":97,"column":5,"nodeType":null,"endLine":97,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState, useCallback, useRef } from \"react\";\r\nimport { createClient } from \"@/utils/supabase/client\";\r\nimport type { RealtimeChannel } from \"@supabase/supabase-js\";\r\n\r\ninterface UnreadCounts {\r\n  unreadMessages: number;\r\n  pendingMaintenance: number;\r\n}\r\n\r\n/**\r\n * Hook for owner/gestion unread counts with Supabase Realtime.\r\n * Listens for changes on messages and maintenance_requests tables.\r\n */\r\nexport function useOwnerUnreadCounts(userId: string | null, teamId: string | null) {\r\n  const [counts, setCounts] = useState<UnreadCounts>({ unreadMessages: 0, pendingMaintenance: 0 });\r\n  const channelsRef = useRef<RealtimeChannel[]>([]);\r\n\r\n  const fetchCounts = useCallback(async () => {\r\n    if (!userId || !teamId) return;\r\n\r\n    try {\r\n      const { getOwnerUnreadCounts } = await import(\"@/lib/unread-counts\");\r\n      const result = await getOwnerUnreadCounts();\r\n      setCounts(result);\r\n    } catch (error) {\r\n      console.error(\"Error fetching owner unread counts:\", error);\r\n    }\r\n  }, [userId, teamId]);\r\n\r\n  useEffect(() => {\r\n    if (!userId || !teamId) return;\r\n\r\n    fetchCounts();\r\n\r\n    const supabase = createClient();\r\n\r\n    // Listen for message changes\r\n    const messagesChannel = supabase\r\n      .channel(`owner-messages-badge:${teamId}`)\r\n      .on(\r\n        \"postgres_changes\",\r\n        { event: \"*\", schema: \"public\", table: \"messages\" },\r\n        () => { fetchCounts(); }\r\n      )\r\n      .subscribe();\r\n\r\n    // Listen for maintenance changes\r\n    const maintenanceChannel = supabase\r\n      .channel(`owner-maintenance-badge:${teamId}`)\r\n      .on(\r\n        \"postgres_changes\",\r\n        { event: \"*\", schema: \"public\", table: \"maintenance_requests\" },\r\n        () => { fetchCounts(); }\r\n      )\r\n      .subscribe();\r\n\r\n    channelsRef.current = [messagesChannel, maintenanceChannel];\r\n\r\n    // Fallback polling every 60s\r\n    const pollingInterval = setInterval(fetchCounts, 60000);\r\n\r\n    return () => {\r\n      channelsRef.current.forEach((ch) => supabase.removeChannel(ch));\r\n      channelsRef.current = [];\r\n      clearInterval(pollingInterval);\r\n    };\r\n  }, [userId, teamId, fetchCounts]);\r\n\r\n  return { ...counts, refetch: fetchCounts };\r\n}\r\n\r\n/**\r\n * Hook for tenant unread counts with polling.\r\n * Tenants don't have Supabase auth, so we use API polling.\r\n */\r\nexport function useTenantUnreadCounts() {\r\n  const [counts, setCounts] = useState<UnreadCounts>({ unreadMessages: 0, pendingMaintenance: 0 });\r\n\r\n  const fetchCounts = useCallback(async () => {\r\n    try {\r\n      const res = await fetch(\"/api/tenant/unread-counts\", { credentials: \"include\" });\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        setCounts({\r\n          unreadMessages: data.unreadMessages || 0,\r\n          pendingMaintenance: data.pendingMaintenance || 0,\r\n        });\r\n      }\r\n    } catch {\r\n      // Silently ignore - counts will stay at 0\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    fetchCounts();\r\n\r\n    // Poll every 30s for tenants (no realtime since no auth)\r\n    const interval = setInterval(fetchCounts, 30000);\r\n    return () => clearInterval(interval);\r\n  }, [fetchCounts]);\r\n\r\n  return { ...counts, refetch: fetchCounts };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\hooks\\use-user-roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\actions\\contract-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":166,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5965,5968],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5965,5968],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":166,"column":113,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":116,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6013,6016],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6013,6016],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6083,6086],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6083,6086],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6125,6128],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6125,6128],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6199,6202],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6199,6202],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6222,6225],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6222,6225],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":279,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":279,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":288,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":288,"endColumn":33},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":309,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11845,11848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11845,11848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":309,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11865,11868],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11865,11868],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":519,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":519,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18559,18562],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18559,18562],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":519,"column":113,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":519,"endColumn":116,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18607,18610],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18607,18610],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":520,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":520,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18671,18674],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18671,18674],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":521,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":521,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18816,18819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18816,18819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":521,"column":153,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":521,"endColumn":156,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18925,18928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18925,18928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":15,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\n/**\n * Server Actions pour la g√©n√©ration de contrats de bail\n * Conforme aux r√®gles Doussel Immo (CLAUDE.md)\n */\n\nimport { createClient as createServerClient } from '@/utils/supabase/server';\n// import { getCurrentUser } from '@/lib/auth'; // Deprecated in Server Actions\nimport { generateLeasePDF, uploadPDFToStorage } from '@/lib/pdf-generator';\nimport { ContractData } from '@/lib/contract-template';\nimport { _ContractCustomTexts } from '@/lib/contract-defaults';\nimport { z, ZodError } from 'zod'; // Import ZodError\nimport { revalidatePath } from 'next/cache';\nimport { differenceInMonths, addDays } from 'date-fns';\n\n// Sch√©ma de validation Zod pour la g√©n√©ration de contrat\nconst GenerateContractSchema = z.object({\n  leaseId: z.string().uuid('ID de bail invalide'),\n  includeWatermark: z.boolean().optional(),\n  watermarkText: z.string().optional(),\n  customTexts: z.any().optional(),\n  preview: z.boolean().optional(),\n});\n\ntype GenerateContractInput = z.infer<typeof GenerateContractSchema>;\n\ninterface GenerateContractResult {\n  success: boolean;\n  contractUrl?: string;\n  pdfBase64?: string;\n  error?: string;\n}\n\n/**\n * G√©n√®re un contrat de bail PDF √† partir d'un lease ID\n */\nexport async function generateLeaseContract(\n  input: GenerateContractInput\n): Promise<GenerateContractResult> {\n  try {\n    // 1. Validation des donn√©es\n    const validated = GenerateContractSchema.parse(input);\n    const { leaseId, includeWatermark = false, watermarkText = 'BROUILLON', customTexts = {}, preview = false } = validated;\n\n    // 2. V√©rification de l'utilisateur\n    const supabase = await createServerClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n      return { success: false, error: 'Non authentifi√©' };\n    }\n\n    // 3. R√©cup√©rer les team_ids de l'utilisateur\n    const { data: teamMemberships } = await supabase\n      .from(\"team_members\")\n      .select(\"team_id\")\n      .eq(\"user_id\", user.id);\n\n    const userTeamIds = teamMemberships?.map(tm => tm.team_id) || [];\n\n    // 4. R√©cup√©rer les donn√©es du bail et profil propri√©taire\n    const { data: lease, error: leaseError } = await supabase\n      .from('leases')\n      .select(`\n        id,\n        owner_id,\n        team_id,\n        property_id,\n        tenant_name,\n        tenant_email,\n        tenant_phone,\n        monthly_amount,\n        start_date,\n        end_date,\n        billing_day,\n        property_address,\n        properties (\n          id,\n          title,\n          location,\n          description,\n          property_type\n        )\n      `)\n      .eq('id', leaseId)\n      .single();\n\n    if (leaseError || !lease) {\n      console.error(\"Erreur r√©cup√©ration bail:\", leaseError);\n      return {\n        success: false,\n        error: leaseError ? `Erreur technique: ${leaseError.message}` : 'Bail introuvable (ID inconnu)'\n      };\n    }\n\n    // 5. V√©rifier que l'utilisateur est autoris√© (Propri√©taire ou Membre de l'√©quipe)\n    const isOwner = lease.owner_id === user.id;\n    const isTeamMember = lease.team_id && userTeamIds.includes(lease.team_id);\n\n    if (!isOwner && !isTeamMember) {\n      return { success: false, error: 'Non autoris√©: vous n\\'√™tes pas le propri√©taire de ce bail' };\n    }\n\n    // 6. R√©cup√©rer les informations du propri√©taire (TEAM > PROFILE)\n    // 6a. Team / Agence (Priorit√© au team_id du bail)\n    let teamData = null;\n    const teamIdToUse = lease.team_id || (userTeamIds.length > 0 ? userTeamIds[0] : null);\n\n    if (teamIdToUse) {\n      const { data: t } = await supabase.from('teams').select('*').eq('id', teamIdToUse).single();\n      teamData = t;\n    } else {\n      // Fallback: √©quipe cr√©√©e par l'utilisateur\n      const { data: t } = await supabase.from('teams').select('*').eq('created_by', user.id).limit(1).single();\n      teamData = t;\n    }\n\n    // 6b. Profil Perso\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('full_name, phone, company_name, company_address, company_phone, company_email, company_ninea, logo_url, signature_url')\n      .eq('id', lease.owner_id) // Utiliser l'owner_id du bail (peut √™tre diff√©rent de user.id si membre d'√©quipe)\n      .single();\n\n    // 6c. Merge data (Team overrides Profile for branding)\n    const branding = {\n      full_name: profile?.full_name,\n      phone: profile?.phone,\n      company_name: teamData?.name || profile?.company_name,\n      address: teamData?.company_address || profile?.company_address,\n      company_phone: teamData?.company_phone || profile?.company_phone,\n      email: teamData?.company_email || profile?.company_email,\n      ninea: teamData?.company_ninea || profile?.company_ninea,\n      logo_url: teamData?.logo_url || profile?.logo_url,\n      signature_url: teamData?.signature_url || profile?.signature_url\n    };\n\n    if (!profile && !teamData) {\n      return { success: false, error: 'Profil ou √âquipe introuvable' };\n    }\n\n    // Extraction nom/pr√©nom depuis full_name\n    const fullName = branding.full_name || '';\n    const firstName = fullName.split(' ')[0] || '';\n    const lastName = fullName.split(' ').slice(1).join(' ') || '';\n\n    // 6. Mapper les donn√©es vers le format ContractData\n    const contractData: ContractData = {\n      landlord: {\n        firstName: firstName,\n        lastName: lastName,\n        address: branding.address || 'Adresse non sp√©cifi√©e',\n        phone: branding.company_phone || branding.phone || '', // Priorit√© tel pro\n        email: branding.email || user.email || '', // Priorit√© email pro\n        companyName: branding.company_name || undefined,\n        ninea: branding.ninea || undefined,\n      },\n      tenant: {\n        firstName: lease.tenant_name?.split(' ')[0] || 'Pr√©nom',\n        lastName: lease.tenant_name?.split(' ').slice(1).join(' ') || 'Nom',\n        phone: lease.tenant_phone || '',\n        email: lease.tenant_email || undefined,\n      },\n      property: {\n        address: lease.property_address || (lease.properties as any)?.location?.address || (lease.properties as any)?.location?.city || '',\n        description: (lease.properties as any)?.description || (lease.properties as any)?.title || 'Non sp√©cifi√©',\n        propertyType: (lease.properties as any)?.property_type as any || undefined,\n      },\n      lease: {\n        monthlyRent: Number(lease.monthly_amount),\n        securityDeposit: Number(lease.monthly_amount) * 2, // Par d√©faut 2 mois (max l√©gal)\n        depositMonths: 2,\n        startDate: new Date(lease.start_date),\n        duration: (lease.end_date && lease.start_date)\n          ? Math.max(1, differenceInMonths(addDays(new Date(lease.end_date), 1), new Date(lease.start_date)))\n          : 12, // D√©faut 12 mois si pas de dates valides\n        billingDay: lease.billing_day || 5,\n      },\n      signatures: {\n        landlordSignatureUrl: branding.signature_url || undefined,\n        signatureDate: new Date(),\n        signatureCity: 'Dakar', // √Ä rendre configurable\n      },\n    };\n\n    // 7. G√©n√©rer le PDF\n    const pdfResult = await generateLeasePDF(contractData, customTexts, {\n      includeWatermark,\n      watermarkText: includeWatermark ? watermarkText : undefined,\n      logoUrl: branding.logo_url || undefined,\n    });\n\n    if (!pdfResult.success || !pdfResult.pdfBytes) {\n      return { success: false, error: pdfResult.error || 'Erreur g√©n√©ration PDF' };\n    }\n\n    // SI MODE PREVIEW: Retourner le base64 sans uploader\n    if (preview) {\n      const base64 = Buffer.from(pdfResult.pdfBytes).toString('base64');\n      return {\n        success: true,\n        pdfBase64: base64\n      };\n    }\n\n    // 8. Upload vers Supabase Storage\n    // IMPORTANT: Le chemin DOIT commencer par user.id pour passer la RLS\n    const filename = `${user.id}/contract-${leaseId}.pdf`;\n    const uploadResult = await uploadPDFToStorage(pdfResult.pdfBytes, filename, supabase);\n\n    if (!uploadResult.success) {\n      return { success: false, error: uploadResult.error || 'Erreur upload PDF' };\n    }\n\n    // 9. Mettre √† jour le lease avec l'URL du contrat\n    const { error: updateError } = await supabase\n      .from('leases')\n      .update({ lease_pdf_url: uploadResult.url })\n      .eq('id', leaseId);\n\n    if (updateError) {\n      console.error('Erreur mise √† jour lease:', updateError);\n      // On continue quand m√™me, le PDF est g√©n√©r√©\n    }\n\n    // 9.5 NOUVEAU: Enregistrer dans user_documents pour la GED\n    // Tentative d'insertion avec logs d√©taill√©s\n    // 9.5 NOUVEAU: Enregistrer dans user_documents pour la GED\n    // Tentative d'insertion avec logs d√©taill√©s\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n    const fileName = `Contrat_Bail_${lease.tenant_name || 'Locataire'}_${timestamp}.pdf`;\n    const filePath = filename; // Chemin dans Storage (user.id/contract-leaseId.pdf - inchang√© pour le storage mais le nom fichier DB change)\n    // NOTE: filePath dans DB devrait matcher le storage path si possible, mais ici on garde le storage path du point 8\n\n    // Pour √©viter confusion: le file_path DB est celui utilis√© pour le download.\n    // Le point 8 utilise `filename` (user.id/contract-leaseId.pdf).\n    // Si on veut permettre plusieurs versions, il faudrait changer le storage path aussi.\n    // Mais ici on veut juste que la DB accepte l'insertion.\n    // LE PROBLEME: file_path est unique ?\n    // Check migration: ADD CONSTRAINT user_documents_file_path_key UNIQUE (file_path);\n    // Donc si on garde le meme file_path (contract-leaseId.pdf), on ne peut pas ins√©rer une ligne duplicate.\n\n    // SOLUTION: On ne change PAS le chemin storage (on √©crase le fichier PDF), \n    // MAIS on ne peut pas ins√©rer une NOUVELLE ligne si le file_path existe d√©j√†.\n\n    // On doit faire un UPSERT au lieu de INSERT si le fichier existe d√©j√†.\n\n    const pdfBuffer = pdfResult.pdfBytes;\n\n    const docData = {\n      user_id: user.id,\n      file_name: fileName,\n      file_path: filePath,\n      file_type: 'bail',\n      mime_type: 'application/pdf',\n      file_size: pdfBuffer.length,\n      category: 'lease_contract',\n      entity_type: 'lease',\n      entity_id: lease.id,\n      property_id: lease.property_id,  // CRITICAL: Required for GED property grouping\n      description: `Contrat de bail - ${lease.tenant_name}`,\n      source: 'generated', // Important: distinguish from manual uploads\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n      lease_id: lease.id\n    };\n\n    console.log('üìÑ Tentative upsert user_documents:', JSON.stringify(docData, null, 2));\n\n    const { error: docError } = await supabase\n      .from('user_documents')\n      .upsert(docData, { onConflict: 'file_path' }); // Utiliser Upsert sur file_path\n\n    if (docError) {\n      console.error('‚ùå Erreur insertion user_documents:', docError);\n      // Log to file for easier access\n      try {\n        const fs = require('fs');\n        const logMessage = `[${new Date().toISOString()}] ERROR: ${JSON.stringify(docError)}\\nDATA: ${JSON.stringify(docData)}\\n\\n`;\n        fs.appendFileSync('debug-log.txt', logMessage);\n      } catch (e) {\n        console.error('Failed to write to debug log', e);\n      }\n    } else {\n      console.log('‚úÖ Contrat enregistr√© dans la GED');\n      try {\n        const fs = require('fs');\n        const logMessage = `[${new Date().toISOString()}] SUCCESS: Contract saved to user_documents\\n`;\n        fs.appendFileSync('debug-log.txt', logMessage);\n      } catch (_e) { }\n    }\n\n    // 10. Revalidation\n    revalidatePath('/compte/(gestion)/locataires');\n    revalidatePath(`/compte/(gestion)/locataires/${leaseId}`);\n\n    return {\n      success: true,\n      contractUrl: uploadResult.url,\n    };\n\n  } catch (error) {\n    console.error('Erreur generateLeaseContract:', error);\n\n    if (error instanceof ZodError) {\n      return {\n        success: false,\n        error: `Validation √©chou√©e: ${(error as any).issues.map((e: any) => e.message).join(', ')}`\n      };\n    }\n\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n\n/**\n * T√©l√©charge le contrat existant d'un bail\n */\nexport async function downloadLeaseContract(leaseId: string): Promise<{\n  success: boolean;\n  url?: string;\n  error?: string;\n}> {\n  try {\n    // 1. V√©rification de l'utilisateur\n    const supabase = await createServerClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n      return { success: false, error: 'Non authentifi√©' };\n    }\n\n    // 2. R√©cup√©rer les team_ids de l'utilisateur\n    const { data: teamMemberships } = await supabase\n      .from(\"team_members\")\n      .select(\"team_id\")\n      .eq(\"user_id\", user.id);\n\n    const userTeamIds = teamMemberships?.map(tm => tm.team_id) || [];\n\n    // 3. R√©cup√©rer le bail\n    const { data: lease, error } = await supabase\n      .from('leases')\n      .select('id, owner_id, team_id, lease_pdf_url')\n      .eq('id', leaseId)\n      .single();\n\n    if (error || !lease) {\n      return { success: false, error: 'Bail introuvable' };\n    }\n\n    // 4. V√©rifier les permissions (Propri√©taire ou Membre de l'√©quipe)\n    const isOwner = lease.owner_id === user.id;\n    const isTeamMember = lease.team_id && userTeamIds.includes(lease.team_id);\n\n    if (!isOwner && !isTeamMember) {\n      return { success: false, error: 'Non autoris√©' };\n    }\n\n    // 4. V√©rifier qu'un contrat existe\n    if (!lease.lease_pdf_url) {\n      return { success: false, error: 'Aucun contrat g√©n√©r√© pour ce bail' };\n    }\n\n    // Extraction du chemin du fichier depuis l'URL ou reconstruction\n    const filePath = `${user.id}/contract-${leaseId}.pdf`;\n\n    // G√©n√©rer une URL sign√©e temporaire (valide 60 secondes)\n    const { data: signedData, error: signedError } = await supabase\n      .storage\n      .from('lease-contracts')\n      .createSignedUrl(filePath, 60);\n\n    if (signedError || !signedData) {\n      console.error('Erreur signed URL:', signedError);\n      return { success: false, error: 'Erreur lors de la g√©n√©ration du lien s√©curis√©' };\n    }\n\n    return {\n      success: true,\n      url: signedData.signedUrl,\n    };\n\n  } catch (error) {\n    console.error('Erreur downloadLeaseContract:', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n\n/**\n * R√©cup√®re les donn√©es d'un bail pour pr√©visualisation avant g√©n√©ration\n */\nexport async function getLeaseDataForContract(leaseId: string): Promise<{\n  success: boolean;\n  data?: ContractData;\n  error?: string;\n}> {\n  try {\n    const supabase = await createServerClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n      return { success: false, error: 'Non authentifi√©' };\n    }\n\n    // const supabase = await createServerClient(); // D√©j√† cr√©√©\n\n    // 2. R√©cup√©rer les team_ids de l'utilisateur\n    const { data: teamMemberships } = await supabase\n      .from(\"team_members\")\n      .select(\"team_id\")\n      .eq(\"user_id\", user.id);\n\n    const userTeamIds = teamMemberships?.map(tm => tm.team_id) || [];\n\n    const { data: lease, error: leaseError } = await supabase\n      .from('leases')\n      .select(`\n        id,\n        owner_id,\n        team_id,\n        tenant_name,\n        tenant_email,\n        tenant_phone,\n        monthly_amount,\n        start_date,\n        end_date,\n        billing_day,\n        property_address,\n        properties (\n          title,\n          location,\n          description,\n          property_type\n        )\n      `)\n      .eq('id', leaseId)\n      .single();\n\n    if (leaseError || !lease) {\n      return { success: false, error: 'Bail introuvable' };\n    }\n\n    // 3. V√©rifier les permissions (Propri√©taire ou Membre de l'√©quipe)\n    const isOwner = lease.owner_id === user.id;\n    const isTeamMember = lease.team_id && userTeamIds.includes(lease.team_id);\n\n    if (!isOwner && !isTeamMember) {\n      return { success: false, error: 'Acc√®s non autoris√©' };\n    }\n\n    // 5. R√©cup√©rer les informations du propri√©taire (TEAM > PROFILE)\n    // 5a. Team / Agence (Priorit√© au team_id du bail)\n    let teamData = null;\n    const teamIdToUse = lease.team_id || (userTeamIds.length > 0 ? userTeamIds[0] : null);\n\n    if (teamIdToUse) {\n      const { data: t } = await supabase.from('teams').select('*').eq('id', teamIdToUse).single();\n      teamData = t;\n    } else {\n      // Fallback\n      const { data: t } = await supabase.from('teams').select('*').eq('created_by', user.id).limit(1).single();\n      teamData = t;\n    }\n\n    // 5b. Profil Perso (Propri√©taire du bail)\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('full_name, phone, company_name, company_address, company_phone, company_email, company_ninea, logo_url, signature_url')\n      .eq('id', lease.owner_id)\n      .single();\n\n    const branding = {\n      full_name: profile?.full_name,\n      phone: profile?.phone,\n      company_name: teamData?.name || profile?.company_name,\n      address: teamData?.company_address || profile?.company_address,\n      company_phone: teamData?.company_phone || profile?.company_phone,\n      email: teamData?.company_email || profile?.company_email,\n      ninea: teamData?.company_ninea || profile?.company_ninea,\n      logo_url: teamData?.logo_url || profile?.logo_url,\n      signature_url: teamData?.signature_url || profile?.signature_url\n    };\n\n    // Note: si erreur profil, on continue peut-√™tre avec defaults? Pour l'instant on garde la logique stricte mais avec message clair.\n    if (!profile && !teamData) {\n      // On peut retourner success:false ou juste des donn√©es vides pour le landlord\n      console.error(\"Erreur warning: Profil et √âquipe introuvables\");\n    }\n\n    const fullName = branding.full_name || '';\n    const firstName = fullName.split(' ')[0] || '';\n    const lastName = fullName.split(' ').slice(1).join(' ') || '';\n\n    const contractData: ContractData = {\n      landlord: {\n        firstName: firstName,\n        lastName: lastName,\n        address: branding.address || 'Adresse non sp√©cifi√©e',\n        phone: branding.company_phone || branding.phone || '',\n        email: branding.email || user.email || '',\n        companyName: branding.company_name || undefined,\n        ninea: branding.ninea || undefined,\n      },\n      tenant: {\n        firstName: lease.tenant_name?.split(' ')[0] || '',\n        lastName: lease.tenant_name?.split(' ').slice(1).join(' ') || '',\n        phone: lease.tenant_phone || '',\n        email: lease.tenant_email || undefined,\n      },\n      property: {\n        address: lease.property_address || (lease.properties as any)?.location?.address || (lease.properties as any)?.location || '',\n        description: (lease.properties as any)?.description || (Array.isArray(lease.properties) ? lease.properties[0]?.description : '') || '',\n        propertyType: (lease.properties as any)?.property_type || (Array.isArray(lease.properties) ? lease.properties[0]?.property_type : undefined) as any,\n      },\n      lease: {\n        monthlyRent: Number(lease.monthly_amount),\n        securityDeposit: Number(lease.monthly_amount) * 2,\n        depositMonths: 2,\n        startDate: new Date(lease.start_date),\n        duration: 12,\n        billingDay: lease.billing_day || 5,\n      },\n      signatures: {\n        signatureDate: new Date(),\n        signatureCity: 'Dakar',\n      },\n    };\n\n    return {\n      success: true,\n      data: contractData,\n    };\n\n  } catch (error) {\n    console.error('Erreur getLeaseDataForContract:', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\admin-auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\analytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\auth-redirect.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\cache\\advanced-patterns.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\cache\\cache-aside.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\cache\\distributed-locks.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":142,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":142,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3475,3478],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3475,3478],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Verrous Distribu√©s (Distributed Locks) pour Dousell Immo\n *\n * Cas d'usage :\n * - Paiement de loyer (√©viter double paiement)\n * - R√©servation de visite (√©viter double booking)\n * - G√©n√©ration de contrat (√©viter doublons)\n *\n * Impl√©mentation simplifi√©e de Redlock :\n * @see https://redis.io/docs/latest/develop/use/patterns/distributed-locks/\n */\n\nimport { redis } from './redis-client';\n\nexport interface LockOptions {\n  /**\n   * Dur√©e max du verrou en secondes\n   * @default 10\n   */\n  expireSeconds?: number;\n\n  /**\n   * Nombre de tentatives si verrou occup√©\n   * @default 3\n   */\n  retries?: number;\n\n  /**\n   * D√©lai entre chaque tentative (ms)\n   * @default 100\n   */\n  retryDelay?: number;\n}\n\n/**\n * üîí Acqu√©rir un verrou distribu√©\n *\n * Utilisation :\n * ```ts\n * const hasLock = await acquireLock('payment:lease123', { expireSeconds: 30 });\n * if (!hasLock) {\n *   return { error: \"Paiement d√©j√† en cours\" };\n * }\n * ```\n *\n * @returns true si verrou acquis, false si d√©j√† pris\n */\nexport async function acquireLock(\n  key: string,\n  options: LockOptions = {}\n): Promise<boolean> {\n  const { expireSeconds = 10, retries = 3, retryDelay = 100 } = options;\n\n  const lockKey = `lock:${key}`;\n  const lockValue = `${Date.now()}-${Math.random()}`; // Token unique\n\n  for (let attempt = 0; attempt < retries; attempt++) {\n    try {\n      // SETNX atomique : Set If Not Exists\n      // Cette op√©ration est atomique, donc thread-safe\n      const acquired = await redis.setnx(lockKey, lockValue, expireSeconds);\n\n      if (acquired) {\n        console.log(`üîí LOCK ACQUIRED: ${lockKey} (expire in ${expireSeconds}s)`);\n        return true;\n      }\n\n      // Verrou occup√©, on attend avant de r√©essayer\n      if (attempt < retries - 1) {\n        console.log(`‚è≥ Lock busy: ${lockKey}, retry ${attempt + 1}/${retries}`);\n        await sleep(retryDelay);\n      }\n    } catch (error) {\n      console.error(`Lock acquire error for ${lockKey}:`, error);\n      return false;\n    }\n  }\n\n  console.warn(`‚ùå LOCK FAILED: ${lockKey} (max retries reached)`);\n  return false;\n}\n\n/**\n * üîì Rel√¢cher un verrou distribu√©\n *\n * IMPORTANT : Toujours appeler dans un bloc finally\n * ```ts\n * try {\n *   // ... traitement ...\n * } finally {\n *   await releaseLock('payment:lease123');\n * }\n * ```\n */\nexport async function releaseLock(key: string): Promise<void> {\n  const lockKey = `lock:${key}`;\n\n  try {\n    await redis.del(lockKey);\n    console.log(`üîì LOCK RELEASED: ${lockKey}`);\n  } catch (error) {\n    console.error(`Lock release error for ${lockKey}:`, error);\n  }\n}\n\n/**\n * üõ°Ô∏è Wrapper avec auto-release (Pattern \"Safe Lock\")\n *\n * G√®re automatiquement l'acquisition et la lib√©ration du verrou.\n * Recommand√© pour √©viter les oublis.\n *\n * Utilisation :\n * ```ts\n * const result = await withLock('payment:lease123', async () => {\n *   // Code prot√©g√© par verrou\n *   await processPayment(leaseId);\n *   return { success: true };\n * }, { expireSeconds: 30 });\n *\n * if (!result.success) {\n *   return { error: result.error };\n * }\n * ```\n */\nexport async function withLock<T>(\n  key: string,\n  handler: () => Promise<T>,\n  options: LockOptions = {}\n): Promise<{ success: boolean; data?: T; error?: string }> {\n  const hasLock = await acquireLock(key, options);\n\n  if (!hasLock) {\n    return {\n      success: false,\n      error: 'Op√©ration d√©j√† en cours. Veuillez patienter.',\n    };\n  }\n\n  try {\n    const data = await handler();\n    return { success: true, data };\n  } catch (error: any) {\n    console.error(`Lock handler error for ${key}:`, error);\n    return {\n      success: false,\n      error: error.message || 'Une erreur est survenue',\n    };\n  } finally {\n    // TOUJOURS rel√¢cher le verrou, m√™me si √ßa plante\n    await releaseLock(key);\n  }\n}\n\n/**\n * üîç V√©rifier si un verrou existe (debug)\n */\nexport async function isLocked(key: string): Promise<boolean> {\n  const lockKey = `lock:${key}`;\n\n  try {\n    return await redis.exists(lockKey);\n  } catch (error) {\n    console.error(`Lock check error for ${lockKey}:`, error);\n    return false;\n  }\n}\n\n// --- Helpers ---\nfunction sleep(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\cache\\examples.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":137,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3873,3876],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3873,3876],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * üìö Exemples d'utilisation du Cache pour Dousell Immo\n *\n * Ce fichier contient des exemples CONCRETS pour :\n * 1. Liste des propri√©t√©s (lecture fr√©quente)\n * 2. D√©tail d'une propri√©t√© (lecture fr√©quente)\n * 3. Mise √† jour de propri√©t√© (invalidation)\n * 4. Paiement de loyer (verrou distribu√©)\n */\n\nimport { getOrSetCache, invalidateCache, invalidateCacheBatch } from './cache-aside';\nimport { withLock } from './distributed-locks';\nimport { createClient } from '@/utils/supabase/server';\n\n// ============================================================================\n// EXEMPLE 1 : Liste des Propri√©t√©s Publiques (Homepage)\n// ============================================================================\n\n/**\n * üè† R√©cup√©rer toutes les propri√©t√©s publiques avec cache\n *\n * Sc√©nario :\n * - 1000 visiteurs/jour sur la homepage\n * - Les annonces changent 10 fois/jour max\n * - TTL : 5 minutes (bon √©quilibre)\n *\n * Performance :\n * - Sans cache : 300ms par requ√™te = 300s/jour pour 1000 users\n * - Avec cache : 5ms par requ√™te = 5s/jour pour 1000 users\n * - Gain : 295s/jour = 98% de r√©duction\n */\nexport async function getAllPropertiesPublic() {\n  return getOrSetCache(\n    'all_properties_public',\n    async () => {\n      const supabase = await createClient();\n      const { data, error } = await supabase\n        .from('properties')\n        .select('*')\n        .eq('status', 'published')\n        .order('created_at', { ascending: false });\n\n      if (error) throw error;\n      return data || [];\n    },\n    {\n      ttl: 300, // 5 minutes\n      namespace: 'properties',\n      debug: true,\n    }\n  );\n}\n\n// ============================================================================\n// EXEMPLE 2 : D√©tail d'une Propri√©t√© (Page Bien)\n// ============================================================================\n\n/**\n * üè° R√©cup√©rer une propri√©t√© sp√©cifique avec cache\n *\n * Sc√©nario :\n * - Page produit vue 500 fois/jour\n * - Propri√©t√© modifi√©e 1 fois/semaine\n * - TTL : 1 heure (pas de probl√®me si l√©ger d√©lai)\n */\nexport async function getPropertyById(id: string) {\n  return getOrSetCache(\n    `detail:${id}`,\n    async () => {\n      const supabase = await createClient();\n      const { data, error } = await supabase\n        .from('properties')\n        .select(\n          `\n          *,\n          profiles:owner_id (\n            first_name,\n            last_name,\n            avatar_url\n          )\n        `\n        )\n        .eq('id', id)\n        .single();\n\n      if (error) throw error;\n      return data;\n    },\n    {\n      ttl: 3600, // 1 heure\n      namespace: 'properties',\n    }\n  );\n}\n\n// ============================================================================\n// EXEMPLE 3 : Recherche par Ville (Filtres)\n// ============================================================================\n\n/**\n * üîç Propri√©t√©s par ville avec cache\n *\n * Cl√©s dynamiques : properties:city:Dakar, properties:city:Thies, etc.\n */\nexport async function getPropertiesByCity(city: string) {\n  return getOrSetCache(\n    `city:${city}`,\n    async () => {\n      const supabase = await createClient();\n      const { data, error } = await supabase\n        .from('properties')\n        .select('*')\n        .eq('city', city)\n        .eq('status', 'published');\n\n      if (error) throw error;\n      return data || [];\n    },\n    {\n      ttl: 600, // 10 minutes\n      namespace: 'properties',\n    }\n  );\n}\n\n// ============================================================================\n// EXEMPLE 4 : Invalidation Intelligente (Server Action)\n// ============================================================================\n\n/**\n * üîÑ Mise √† jour d'une propri√©t√© avec invalidation\n *\n * CRUCIAL : Quand un propri√©taire modifie son bien, on doit :\n * 1. Mettre √† jour la DB\n * 2. Invalider TOUS les caches concern√©s\n */\nexport async function updateProperty(id: string, newData: any) {\n  const supabase = await createClient();\n\n  // 1. Mise √† jour DB (Supabase)\n  const { error } = await supabase.from('properties').update(newData).eq('id', id);\n\n  if (error) throw error;\n\n  // 2. INVALIDATION IMM√âDIATE (Le \"Chef crie\" üì¢)\n\n  const keysToInvalidate = [\n    'all_properties_public', // Liste globale\n    `detail:${id}`, // D√©tail de ce bien\n  ];\n\n  // Si la ville a chang√©, invalider les deux villes\n  if (newData.city) {\n    keysToInvalidate.push(`city:${newData.city}`);\n  }\n\n  // Si le statut a chang√© (published/draft), invalider liste\n  if (newData.status) {\n    keysToInvalidate.push('all_properties_public');\n  }\n\n  await invalidateCacheBatch(keysToInvalidate, 'properties');\n\n  console.log(`‚úÖ Property ${id} updated and cache invalidated`);\n  return { success: true };\n}\n\n// ============================================================================\n// EXEMPLE 5 : Paiement de Loyer avec Verrou Distribu√©\n// ============================================================================\n\n/**\n * üí∞ Paiement de loyer avec protection contre double paiement\n *\n * Sc√©nario :\n * - User clique 2 fois vite sur \"Payer\"\n * - Sans verrou : 2 paiements cr√©√©s ‚ùå\n * - Avec verrou : 2√®me clic rejet√© ‚úÖ\n */\nexport async function payRent(leaseId: string, amount: number) {\n  // On utilise withLock pour auto-gestion du verrou\n  return withLock(\n    `payment:${leaseId}`,\n    async () => {\n      const supabase = await createClient();\n\n      // 1. V√©rifier que le bail existe et n'est pas d√©j√† pay√© ce mois\n      const { data: lease } = await supabase\n        .from('leases')\n        .select('*')\n        .eq('id', leaseId)\n        .single();\n\n      if (!lease) {\n        throw new Error('Bail introuvable');\n      }\n\n      // 2. Cr√©er le paiement dans PayDunya\n      // ... (votre logique existante)\n\n      // 3. Enregistrer dans la DB\n      const { data: payment, error } = await supabase\n        .from('rental_payments')\n        .insert({\n          lease_id: leaseId,\n          amount,\n          status: 'pending',\n          payment_date: new Date().toISOString(),\n        })\n        .select()\n        .single();\n\n      if (error) throw error;\n\n      // 4. Invalider le cache des paiements du locataire\n      await invalidateCache(`payments:lease:${leaseId}`, 'rentals');\n\n      return { paymentId: payment.id };\n    },\n    {\n      expireSeconds: 30, // Max 30s pour traiter le paiement\n      retries: 1, // Ne pas r√©essayer (c'est volontaire)\n    }\n  );\n}\n\n// ============================================================================\n// EXEMPLE 6 : R√©servation de Visite avec Verrou\n// ============================================================================\n\n/**\n * üìÖ R√©servation de visite avec protection contre double booking\n */\nexport async function bookVisit(propertyId: string, slot: string, userId: string) {\n  return withLock(\n    `visit:${propertyId}:${slot}`,\n    async () => {\n      const supabase = await createClient();\n\n      // 1. V√©rifier que le cr√©neau est encore disponible\n      const { data: existingBooking } = await supabase\n        .from('visit_bookings')\n        .select('*')\n        .eq('property_id', propertyId)\n        .eq('slot', slot)\n        .maybeSingle();\n\n      if (existingBooking) {\n        throw new Error('Ce cr√©neau est d√©j√† r√©serv√©');\n      }\n\n      // 2. Cr√©er la r√©servation\n      const { data: booking, error } = await supabase\n        .from('visit_bookings')\n        .insert({\n          property_id: propertyId,\n          user_id: userId,\n          slot,\n          status: 'confirmed',\n        })\n        .select()\n        .single();\n\n      if (error) throw error;\n\n      // 3. Invalider le cache des cr√©neaux disponibles\n      await invalidateCache(`available_slots:${propertyId}`, 'visits');\n\n      return { bookingId: booking.id };\n    },\n    {\n      expireSeconds: 10, // Tr√®s rapide pour la r√©servation\n      retries: 3, // On peut r√©essayer\n    }\n  );\n}\n\n// ============================================================================\n// EXEMPLE 7 : Dashboard Stats avec Cache Agressif\n// ============================================================================\n\n/**\n * üìä Stats du Dashboard Propri√©taire\n *\n * Ces donn√©es changent rarement, on peut cacher longtemps\n */\nexport async function getOwnerDashboardStats(ownerId: string) {\n  return getOrSetCache(\n    `dashboard:${ownerId}`,\n    async () => {\n      const supabase = await createClient();\n\n      // Requ√™tes parall√®les pour performance\n      const [properties, leases, payments] = await Promise.all([\n        supabase\n          .from('properties')\n          .select('id', { count: 'exact', head: true })\n          .eq('owner_id', ownerId),\n\n        supabase\n          .from('leases')\n          .select('id', { count: 'exact', head: true })\n          .eq('property_id', ownerId)\n          .eq('status', 'active'),\n\n        supabase\n          .from('rental_payments')\n          .select('amount')\n          .eq('owner_id', ownerId)\n          .gte(\n            'payment_date',\n            new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString()\n          ),\n      ]);\n\n      return {\n        totalProperties: properties.count || 0,\n        activeLeases: leases.count || 0,\n        monthlyRevenue: payments.data?.reduce((sum, p) => sum + p.amount, 0) || 0,\n      };\n    },\n    {\n      ttl: 1800, // 30 minutes (stats pas en temps r√©el)\n      namespace: 'dashboard',\n    }\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\cache\\invalidation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\cache\\redis-client.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[371,374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[371,374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":39,"column":23,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":39,"endColumn":48,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":52,"column":21,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":52,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":67,"column":21,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":67,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\cityImages.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\config\\stripe-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\context.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\contract-defaults.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\contract-template.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\email-confirmation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\favorites-sync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\finance-service.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1510,1513],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1510,1513],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2528,2531],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2528,2531],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4445,4448],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4445,4448],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":159,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":159,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5839,5842],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5839,5842],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":164,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6066,6069],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6066,6069],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":172,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":172,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6431,6434],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6431,6434],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nimport { supabase } from '@/lib/supabase';\r\nimport {\r\n    calculateFinancials,\r\n    type FinancialKPIs,\r\n    type MonthlyFinancialSummary,\r\n    type LeaseInput,\r\n    type TransactionInput,\r\n    type ExpenseInput,\r\n} from '@/lib/finance';\r\nimport { getOrSetCache } from '@/lib/cache/cache-aside';\r\n\r\n/**\r\n * R√©cup√®re les stats financi√®res pour un PROPRI√âTAIRE (ann√©e compl√®te).\r\n * Source : Cache Redis + DB si cache miss.\r\n */\r\nexport async function getFinancialStatsForOwner(\r\n    ownerId: string,\r\n    year: number\r\n): Promise<FinancialKPIs> {\r\n    const cacheKey = `financial-stats:v2:owner:${ownerId}:${year}`;\r\n\r\n    return getOrSetCache(\r\n        cacheKey,\r\n        async () => {\r\n            // 1. R√©cup√©rer les baux\r\n            const { data: leases, error: leasesError } = await supabase\r\n                .from('leases')\r\n                .select('id, monthly_amount, status, start_date, billing_day')\r\n                .eq('owner_id', ownerId);\r\n\r\n            if (leasesError) throw leasesError;\r\n\r\n            // 2. R√©cup√©rer les transactions\r\n            // Note: rental_transactions n'a pas toujours owner_id direct, il faut parfois join.\r\n            // Mais si la vue ou table a owner_id c'est mieux.\r\n            // TODO: V√©rifier si rental_transactions a owner_id.\r\n            // Si non, on filtre par les lease_ids de l'owner.\r\n\r\n            // Strat√©gie s√ªre : Filtrer par lease_ids\r\n            const leaseIds = (leases || []).map(l => l.id);\r\n            let transactions: any[] = [];\r\n\r\n            if (leaseIds.length > 0) {\r\n                const { data: txs, error: transactionsError } = await supabase\r\n                    .from('rental_transactions')\r\n                    .select('id, lease_id, amount_due, amount_paid, status, period_start')\r\n                    .in('lease_id', leaseIds);\r\n\r\n                if (transactionsError) throw transactionsError;\r\n                transactions = txs || [];\r\n            }\r\n\r\n            // 3. R√©cup√©rer les d√©penses\r\n            const { data: expenses, error: expensesError } = await supabase\r\n                .from('expenses')\r\n                .select('id, amount, expense_date, lease_id')\r\n                .eq('owner_id', ownerId);\r\n\r\n            if (expensesError) throw expensesError;\r\n\r\n            // 4. Calculer les KPIs (ann√©e compl√®te)\r\n            const targetDate = new Date(year, 0, 1);\r\n            const kpis = calculateFinancials(\r\n                (leases || []) as LeaseInput[],\r\n                (transactions || []).map((t: any) => ({ ...t, period_date: t.period_start })) as TransactionInput[],\r\n                (expenses || []) as ExpenseInput[],\r\n                targetDate\r\n            );\r\n\r\n            return kpis;\r\n        },\r\n        { ttl: 300, namespace: 'financials' } // Cache 5 min\r\n    );\r\n}\r\n\r\n/**\r\n * R√©cup√®re les stats financi√®res pour une √âQUIPE (ann√©e compl√®te).\r\n * Source : Cache Redis + DB si cache miss.\r\n */\r\nexport async function getFinancialStatsForTeam(\r\n    teamId: string,\r\n    year: number\r\n): Promise<FinancialKPIs> {\r\n    const cacheKey = `financial-stats:v2:team:${teamId}:${year}`;\r\n\r\n    return getOrSetCache(\r\n        cacheKey,\r\n        async () => {\r\n            // 1. R√©cup√©rer les baux\r\n            const { data: leases, error: leasesError } = await supabase\r\n                .from('leases')\r\n                .select('id, monthly_amount, status, start_date, billing_day')\r\n                .eq('team_id', teamId);\r\n\r\n            if (leasesError) throw leasesError;\r\n\r\n            // 2. R√©cup√©rer les transactions\r\n            const { data: transactions, error: transactionsError } = await supabase\r\n                .from('rental_transactions')\r\n                .select('id, lease_id, amount_due, amount_paid, status, period_start')\r\n                .eq('team_id', teamId);\r\n\r\n            if (transactionsError) throw transactionsError;\r\n\r\n            // 3. R√©cup√©rer les d√©penses\r\n            const { data: expenses, error: expensesError } = await supabase\r\n                .from('expenses')\r\n                .select('id, amount, expense_date, lease_id')\r\n                .eq('team_id', teamId);\r\n\r\n            if (expensesError) throw expensesError;\r\n\r\n            // 4. Calculer les KPIs (ann√©e compl√®te)\r\n            const targetDate = new Date(year, 0, 1);\r\n            const kpis = calculateFinancials(\r\n                (leases || []) as LeaseInput[],\r\n                (transactions || []).map((t: any) => ({ ...t, period_date: t.period_start })) as TransactionInput[],\r\n                (expenses || []) as ExpenseInput[],\r\n                targetDate\r\n            );\r\n\r\n            return kpis;\r\n        },\r\n        { ttl: 300, namespace: 'financials' } // Cache 5 min\r\n    );\r\n}\r\n\r\n/**\r\n * R√©cup√®re les stats pour un mois sp√©cifique (avec breakdown).\r\n */\r\nexport async function getMonthlyFinancialSummary(\r\n    teamId: string,\r\n    year: number,\r\n    month: number\r\n): Promise<MonthlyFinancialSummary> {\r\n    const cacheKey = `financial-stats:${teamId}:${year}:${month}`;\r\n\r\n    return getOrSetCache(\r\n        cacheKey,\r\n        async () => {\r\n            const { data: leases } = await supabase\r\n                .from('leases')\r\n                .select('id, monthly_amount, status, start_date, billing_day')\r\n                .eq('team_id', teamId);\r\n\r\n            const { data: transactions } = await supabase\r\n                .from('rental_transactions')\r\n                .select('id, lease_id, amount_due, amount_paid, status, period_start')\r\n                .eq('team_id', teamId);\r\n\r\n            const { data: expenses } = await supabase\r\n                .from('expenses')\r\n                .select('id, amount, expense_date, lease_id')\r\n                .eq('team_id', teamId);\r\n\r\n            // Filtrer par mois\r\n            const monthlyTransactions = (transactions || []).filter((t: any) => {\r\n                const d = new Date(t.period_start);\r\n                return d.getMonth() + 1 === month && d.getFullYear() === year;\r\n            });\r\n\r\n            const monthlyExpenses = (expenses || []).filter((e: any) => {\r\n                const d = new Date(e.expense_date);\r\n                return d.getMonth() + 1 === month && d.getFullYear() === year;\r\n            });\r\n\r\n            const targetDate = new Date(year, month - 1, 1);\r\n            const kpis = calculateFinancials(\r\n                (leases || []) as LeaseInput[],\r\n                monthlyTransactions.map((t: any) => ({ ...t, period_date: t.period_start })) as TransactionInput[],\r\n                monthlyExpenses as ExpenseInput[],\r\n                targetDate\r\n            );\r\n\r\n            return {\r\n                ...kpis,\r\n                month,\r\n                year,\r\n                future: 0,\r\n            };\r\n        },\r\n        { ttl: 300, namespace: 'financials' }\r\n    );\r\n}\r\n\r\n/**\r\n * Invalide le cache financier apr√®s une mutation (cr√©er d√©pense, payer loyer, etc).\r\n */\r\nexport async function invalidateFinancialCache(teamId: string) {\r\n    console.log(`üßπ Invalidating cache for team ${teamId}`);\r\n    // L'invalidation d√©pendra de l'impl√©mentation de getOrSetCache\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\finance.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":295,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":295,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11427,11430],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11427,11430],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":295,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":295,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11464,11467],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11464,11467],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n * ‚ïë                        FINANCE GUARD - KPI ENGINE                         ‚ïë\n * ‚ïë                       Moteur de calcul financier                          ‚ïë\n * ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n *\n * RESPONSABILIT√âS :\n * 1. Calcul des KPIs financiers (Attendu, Encaiss√©, Taux de recouvrement)\n * 2. Comptage des statuts (Pay√©, En attente, En retard)\n * 3. Validation des donn√©es (doublon email, coh√©rence)\n *\n * R√àGLES M√âTIER :\n * - Source de v√©rit√© pour \"Attendu\" : Table LEASES (baux actifs)\n * - Source de v√©rit√© pour \"Encaiss√©\" : Table RENTAL_TRANSACTIONS (amount_paid)\n * - Statut \"En retard\" : D√©termin√© par billing_day (synchronis√© avec UI)\n *\n * SYNCHRONISATION UI ‚Üî BACKEND ‚Üî KPIs :\n * ‚úì UI affiche \"Retard\" si currentDay > billing_day\n * ‚úì KPIs comptent \"overdue\" si currentDay > billing_day\n * ‚úì Relances envoy√©es si daysOverdue >= 5\n *\n * CR√âATION AUTOMATIQUE DE TRANSACTIONS (MAJ: 2025-12-28) :\n * ‚úì Lors de l'ajout d'un nouveau locataire via createNewLease()\n * ‚úì Transaction cr√©√©e automatiquement pour le mois EN COURS (dynamique)\n * ‚úì Champs: period_month (actuel), period_year (actuel), reminder_sent: false\n * ‚úì Exemple: Locataire ajout√© le 28/12/2025 ‚Üí Transaction D√©cembre 2025 cr√©√©e\n * ‚úì Impact: Cron peut traiter ce locataire d√®s le lendemain\n *\n * COMPATIBILIT√â :\n * - G√®re l'absence de la colonne amount_paid (fallback sur amount_due)\n * - Supporte les paiements partiels (amount_paid < amount_due)\n * - G√®re les lignes virtuelles (baux sans transaction)\n *\n * @version 2.1 - Cr√©ation auto transactions + Documentation\n * @date 2025-12-28\n */\n\nimport { _isSameMonth, _isWithinInterval, startOfMonth, endOfMonth, _parseISO, isAfter } from 'date-fns';\n\nexport interface FinancialKPIs {\n    totalExpected: number;  // Bas√© sur les baux actifs (monthly_amount)\n    totalCollected: number; // Bas√© sur les versements r√©els (amount_paid ou amount_due si paid)\n    totalExpenses: number;  // Somme des d√©penses (expenses)\n    actualNetProfit: number; // Cashflow r√©el (Collected - Expenses)\n    projectedNetProfit: number; // Performance projet√©e (Expected - Expenses)\n    hasTemporaryDebt: boolean; // True si Expenses > Collected\n    collectionRate: number; // Taux de recouvrement en % (Collected / Expected * 100)\n    occupancyRate: number;  // Taux d'occupation financier\n    pendingCount: number;   // Nombre de loyers en attente\n    overdueCount: number;   // Nombre de loyers en retard\n    paidCount: number;      // Nombre de loyers pay√©s\n    pendingAmount: number;  // Montant en attente (FCFA)\n    overdueAmount: number;  // Montant en retard (FCFA)\n    avgDelayDays: number;   // Retard moyen (jours)\n}\n\nexport interface MonthlyFinancialSummary extends FinancialKPIs {\n    month: number;\n    year: number;\n    future: number;         // Loyers √† venir\n}\n\n// Interfaces minimales pour d√©couplage\nexport interface LeaseInput {\n    id: string;\n    monthly_amount: number;\n    status: string; // 'active' | 'terminated' | 'pending' usually (string from DB)\n    start_date: string | null;\n    billing_day: number; // Used for overdue calculation\n}\n\nexport interface TransactionInput {\n    id: string; // Pour unicit√©\n    lease_id: string | null;\n    amount_due: number;\n    amount_paid?: number | null; // La cl√© du correctif\n    status: string; // 'pending' | 'paid' | 'overdue' etc.\n    period_date?: string | Date; // Date de r√©f√©rence \"due_date\" ou p√©riode\n    created_at?: string;\n    paid_at?: string | Date; // Date du paiement effectif\n}\n\nexport interface ExpenseInput {\n    id: string;\n    amount: number;\n    expense_date: string;\n    lease_id?: string | null;\n}\n\n/**\n * Calcule les KPI financiers pour un mois donn√©\n * Source de v√©rit√© : Lease (Bail) pour le d√ª, Transaction pour l'encaiss√©.\n */\nexport function calculateFinancials(\n    leases: LeaseInput[],\n    transactions: TransactionInput[],\n    expenses: ExpenseInput[],\n    targetDate: Date\n): FinancialKPIs {\n\n    let totalExpected = 0;\n    let totalCollected = 0;\n    let totalExpenses = 0;\n\n    let paidCount = 0;\n    let pendingCount = 0;\n    let overdueCount = 0;\n\n    let pendingAmount = 0;\n    let overdueAmount = 0;\n\n    const GRACE_PERIOD_DAYS = 5; // Tol√©rance avant de marquer \"Overdue\"\n\n    let totalDelayDays = 0;\n    let delaySamples = 0;\n\n    // Pour v√©rifier si le mois cible est le mois courant\n    const now = new Date();\n    // Comparaison stricte mois/ann√©e\n    const _isTargetMonthCurrent = (\n        targetDate.getMonth() === now.getMonth() &&\n        targetDate.getFullYear() === now.getFullYear()\n    );\n\n    // 1. It√©ration sur les BAUX (Source de v√©rit√© pour l'Attendu)\n    leases.forEach(lease => {\n        if (lease.status === 'active') {\n\n            // R√®gle 1 : L'attendu vient du bail\n            const monthlyRent = Number(lease.monthly_amount) || 0;\n            totalExpected += monthlyRent;\n\n            // 2. Chercher la transaction correspondante\n            const leaseTransaction = transactions.find(t => t.lease_id === lease.id);\n            const billingDay = lease.billing_day || 5;\n\n            // Dates cl√©s\n            const dueDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), billingDay);\n            const graceDate = new Date(dueDate);\n            graceDate.setDate(dueDate.getDate() + GRACE_PERIOD_DAYS);\n\n            // Pour le calcul de retard courant (\"maintenant\")\n            const checkDate = new Date();\n\n            if (leaseTransaction) {\n                // R√®gle 2 : On prend ce qui a √©t√© R√âELLEMENT pay√©\n                let paidAmount = 0;\n                // Support partiel : si status 'paid', on suppose tout pay√© sauf si amount_paid d√©fini\n                if (leaseTransaction.amount_paid !== undefined && leaseTransaction.amount_paid !== null) {\n                    paidAmount = Number(leaseTransaction.amount_paid);\n                } else if (leaseTransaction.status === 'paid') {\n                    paidAmount = Number(leaseTransaction.amount_due) || monthlyRent;\n                }\n\n                totalCollected += paidAmount;\n                const remainingDue = Math.max(0, monthlyRent - paidAmount);\n\n                // --- LOGIQUE DE STATUT STRICT ---\n                const isPaidFull = remainingDue <= 0;\n\n                if (isPaidFull) {\n                    paidCount++;\n                    // Calcul d√©lai (si pay√©)\n                    if (leaseTransaction.paid_at) {\n                        const paidDate = new Date(leaseTransaction.paid_at);\n                        // On ne compte que les RETARDS (diff > 0)\n                        if (paidDate > dueDate) {\n                            const diffTime = paidDate.getTime() - dueDate.getTime();\n                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n                            const safeDelay = Math.max(0, diffDays);\n\n                            if (safeDelay > 0) {\n                                totalDelayDays += safeDelay;\n                                delaySamples++;\n                            }\n                        } else {\n                            // Pay√© √† l'heure ou en avance : On NE COMPTE PAS dans la moyenne des RETARDS\n                            // (Selon feedback user : ne pas fausser la moyenne avec des 0)\n                        }\n                    } else if (leaseTransaction.status === 'paid') {\n                        // Pay√© sans date ? On suppose √† l'heure => 0 retard\n                        delaySamples++;\n                    }\n                } else {\n                    // Partiel ou Pas pay√©\n                    // Overdue ?\n                    let isOverdue = false;\n\n                    if (isAfter(new Date(), graceDate)) {\n                        // Grace period d√©pass√©e -> Overdue\n                        isOverdue = true;\n                    }\n                    // Si futur -> Pas overdue\n                    if (isAfter(startOfMonth(targetDate), endOfMonth(checkDate))) {\n                        isOverdue = false;\n                    }\n\n                    if (isOverdue) {\n                        overdueCount++;\n                        overdueAmount += remainingDue;\n\n                        // Retard en cours\n                        const diffTime = checkDate.getTime() - dueDate.getTime();\n                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n                        totalDelayDays += diffDays;\n                        delaySamples++;\n                    } else {\n                        pendingCount++;\n                        pendingAmount += remainingDue;\n                    }\n                }\n            } else {\n                // Pas de transaction\n                const isActiveDelay = isAfter(new Date(), graceDate);\n                const isFuture = isAfter(startOfMonth(targetDate), endOfMonth(checkDate));\n\n                if (isActiveDelay && !isFuture) {\n                    overdueCount++;\n                    overdueAmount += monthlyRent;\n                    // Retard en cours\n                    const diffTime = checkDate.getTime() - dueDate.getTime();\n                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n                    totalDelayDays += diffDays;\n                    delaySamples++;\n                } else {\n                    pendingCount++;\n                    pendingAmount += monthlyRent;\n                }\n            }\n        }\n    });\n\n    // 4. Calcul des D√âPENSES\n    expenses.forEach(expense => {\n        totalExpenses += Number(expense.amount) || 0;\n    });\n\n    // Calcul des ratios et profits\n    const collectionRate = totalExpected > 0\n        ? Math.round((totalCollected / totalExpected) * 100)\n        : 0;\n\n    const actualNetProfit = totalCollected - totalExpenses;\n    const projectedNetProfit = totalExpected - totalExpenses;\n    const hasTemporaryDebt = totalExpenses > totalCollected;\n\n    // Calcul D√©lai Moyen\n    const avgDelayDays = delaySamples > 0\n        ? Math.round(totalDelayDays / delaySamples)\n        : 0;\n\n    return {\n        totalExpected,\n        totalCollected,\n        totalExpenses,\n        actualNetProfit,\n        projectedNetProfit,\n        hasTemporaryDebt,\n        collectionRate,\n        occupancyRate: 0,\n        pendingCount,\n        overdueCount,\n        paidCount,\n        pendingAmount,\n        overdueAmount,\n        avgDelayDays\n    };\n}\n\n/**\n * Calcule les KPI pour toute une ann√©e (breakdown mensuel)\n */\nexport function calculateYearlyFinancials(\n    leases: LeaseInput[],\n    transactions: TransactionInput[],\n    expenses: ExpenseInput[],\n    year: number\n): MonthlyFinancialSummary[] {\n    const months: MonthlyFinancialSummary[] = [];\n    const today = new Date();\n    const currentMonth = today.getMonth() + 1;\n    const currentYear = today.getFullYear();\n\n    for (let month = 1; month <= 12; month++) {\n        const targetDate = new Date(year, month - 1, 1);\n\n        // Filtrer les transactions pour ce mois sp√©cifique\n        const monthlyTransactions = transactions.filter(t => {\n            if (t.period_date) {\n                const d = typeof t.period_date === 'string' ? new Date(t.period_date) : t.period_date;\n                return d.getMonth() + 1 === month && d.getFullYear() === year;\n            }\n            return (t as any).period_month === month && (t as any).period_year === year;\n        });\n\n        // Filtrer les d√©penses pour ce mois sp√©cifique\n        const monthlyExpenses = (expenses || []).filter(e => {\n            const d = new Date(e.expense_date);\n            return d.getMonth() + 1 === month && d.getFullYear() === year;\n        });\n\n        const financials = calculateFinancials(leases, monthlyTransactions, monthlyExpenses, targetDate);\n\n        // Gestion sp√©cifique du \"Futur\"\n        let future = 0;\n        const isFuture = year > currentYear || (year === currentYear && month > currentMonth);\n\n        if (isFuture) {\n            // Dans le futur, tout ce qui est \"attendu\" est consid√©r√© comme \"future\"\n            // et on remet √† z√©ro les autres compteurs pour la clart√© visuelle\n            future = financials.totalExpected;\n            financials.pendingCount = 0;\n            financials.overdueCount = 0;\n            financials.pendingAmount = 0;\n            financials.overdueAmount = 0;\n        }\n\n        months.push({\n            ...financials,\n            month,\n            year,\n            future\n        });\n    }\n\n    return months;\n}\n\n/**\n * Calcule le statut d'affichage d'une transaction (synchronis√© avec l'UI)\n *\n * @param transactionStatus - Statut en base de donn√©es\n * @param billingDay - Jour de facturation (d√©faut: 5)\n * @param isCurrentMonth - Si on regarde le mois en cours\n * @returns 'paid' | 'pending' | 'overdue'\n */\nexport function calculateDisplayStatus(\n    transactionStatus: string,\n    billingDay: number = 5,\n    isCurrentMonth: boolean = true\n): 'paid' | 'pending' | 'overdue' {\n    if (transactionStatus === 'paid') {\n        return 'paid';\n    }\n\n    // Pour les transactions non pay√©es, v√©rifier si en retard\n    const currentDay = new Date().getDate();\n    if (isCurrentMonth && currentDay > billingDay) {\n        return 'overdue';\n    }\n\n    return 'pending';\n}\n\n/**\n * PILIER 2 : Le Gardien (Write-Security)\n * V√©rifie strictement si un email est d√©j√† utilis√© pour un bail ACTIF\n */\nexport async function validateTenantCreation(\n    email: string,\n    supabaseClient: SupabaseClient,\n    ownerId: string\n): Promise<{ valid: boolean; error?: string }> {\n    if (!email) return { valid: true }; // Pas d'email, pas de conflit\n\n    const { data: existingLeases, error } = await supabaseClient\n        .from('leases')\n        .select('id, tenant_name')\n        .eq('owner_id', ownerId)\n        .ilike('tenant_email', email.trim())\n        .neq('status', 'terminated') // On ignore les anciens baux r√©sili√©s\n        .limit(1);\n\n    if (error) {\n        console.error(\"FinanceGuard Error:\", error);\n        return { valid: false, error: \"Erreur de v√©rification des doublons\" };\n    }\n\n    if (existingLeases && existingLeases.length > 0) {\n        return {\n            valid: false,\n            error: `L'adresse email choisie est d√©j√† utilis√©e par \"${existingLeases[0].tenant_name}\". Veuillez en choisir une autre.`\n        };\n    }\n\n    return { valid: true };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\ged-utils.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[942,945],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[942,945],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { createClient } from '@/utils/supabase/server';\r\n\r\ntype DocumentType = 'titre_propriete' | 'bail' | 'cni' | 'facture' | 'attestation' | 'autre' | 'quittance' | 'etat_lieux' | 'facture_travaux' | 'maintenance';\r\n\r\ninterface StoreDocumentParams {\r\n    userId: string; // Propri√©taire ou Locataire principal\r\n    teamId?: string;\r\n    fileBuffer: Uint8Array;\r\n    fileName: string;\r\n    bucketName: 'lease-contracts' | 'receipts' | 'user-documents' | 'properties';\r\n    documentType: DocumentType;\r\n    metadata: {\r\n        leaseId?: string;\r\n        propertyId?: string;\r\n        tenantName?: string;\r\n        transactionId?: string; // Pour les quittances\r\n        requestId?: string; // Pour les maintenance\r\n        description?: string;\r\n    }\r\n}\r\n\r\n/**\r\n * Upload un fichier buffer vers Supabase Storage et cr√©e l'entr√©e user_documents\r\n */\r\nexport async function storeDocumentInGED(params: StoreDocumentParams, supabaseClient?: any) {\r\n    // Si un client est pass√© (ex: avec service role), on l'utilise, sinon on en cr√©e un nouveau\r\n    const supabase = supabaseClient || await createClient();\r\n    const {\r\n        userId, _teamId, fileBuffer, fileName, bucketName, documentType, metadata\r\n    } = params;\r\n\r\n    try {\r\n        // 1. Upload vers Storage\r\n        // On assainit le nom de fichier\r\n        const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9-_\\.]/g, '_');\r\n        const filePath = `${userId}/${Date.now()}_${sanitizedFileName}`;\r\n\r\n        let { data: uploadData, error: uploadError } = await supabase.storage\r\n            .from(bucketName)\r\n            .upload(filePath, fileBuffer, {\r\n                contentType: 'application/pdf',\r\n                upsert: true\r\n            });\r\n\r\n        // Retry: Auto-create bucket if missing (requires admin/service_role client)\r\n        if (uploadError && uploadError.message.includes(\"Bucket not found\")) {\r\n            console.log(`‚ö†Ô∏è Bucket '${bucketName}' introuvable. Tentative de cr√©ation...`);\r\n            const { error: createError } = await supabase.storage.createBucket(bucketName, {\r\n                public: false,\r\n                fileSizeLimit: 52428800, // 50MB\r\n                allowedMimeTypes: ['application/pdf', 'image/png', 'image/jpeg']\r\n            });\r\n\r\n            if (createError) {\r\n                console.error(\"‚ùå √âchec cr√©ation bucket:\", createError);\r\n                return { success: false, error: \"Bucket introuvable et impossible √† cr√©er: \" + createError.message };\r\n            }\r\n\r\n            // Retry upload\r\n            const retry = await supabase.storage\r\n                .from(bucketName)\r\n                .upload(filePath, fileBuffer, {\r\n                    contentType: 'application/pdf',\r\n                    upsert: true\r\n                });\r\n\r\n            uploadData = retry.data;\r\n            uploadError = retry.error;\r\n        }\r\n\r\n        if (uploadError) {\r\n            console.error(\"Erreur Upload Storage:\", uploadError);\r\n            return { success: false, error: uploadError.message };\r\n        }\r\n\r\n        // 2. G√©n√©rer l'URL publique ou sign√©e (selon le bucket)\r\n        // Pour 'properties' c'est public, pour 'lease-contracts' priv√©\r\n        let fileUrl = \"\";\r\n\r\n        if (bucketName === 'properties') {\r\n            const { data: publicUrlData } = supabase.storage\r\n                .from(bucketName)\r\n                .getPublicUrl(filePath);\r\n            fileUrl = publicUrlData.publicUrl;\r\n        } else {\r\n            // Pour les buckets priv√©s, on stocke le chemin interne et on g√©n√©rera des URLs sign√©es √† la vol√©e\r\n            // OU on g√©n√®re une URL sign√©e longue dur√©e (mais risqu√©).\r\n            // Mieux : Stocker le chemin relatif ou l'URL interne qui sera trait√©e par le client/serveur\r\n            // Ici on va stocker le path complet pour r√©f√©rence\r\n            fileUrl = uploadData.path;\r\n        }\r\n\r\n        // 3. Cr√©er l'entr√©e dans user_documents\r\n        let { data: doc, error: dbError } = await supabase\r\n            .from('user_documents')\r\n            .insert([{\r\n                user_id: userId,\r\n                description: metadata.description || fileName,\r\n                file_name: fileName,\r\n                file_type: documentType, // Utilise la colonne file_type d√©finie dans la migration\r\n                file_path: uploadData.path,\r\n                file_size: fileBuffer.length,\r\n                mime_type: 'application/pdf',\r\n                entity_type: documentType === 'bail' ? 'lease' : documentType === 'quittance' ? 'payment' : documentType === 'maintenance' ? 'maintenance_request' : 'other',\r\n                entity_id: documentType === 'quittance' ? metadata.transactionId : documentType === 'maintenance' ? metadata.requestId : (metadata.leaseId || metadata.transactionId),\r\n                property_id: metadata.propertyId,\r\n                lease_id: metadata.leaseId,\r\n                category: documentType, // On utilise documentType comme cat√©gorie par d√©faut\r\n                source: 'manual',\r\n                created_at: new Date().toISOString()\r\n            }])\r\n            .select()\r\n            .single();\r\n\r\n        // 3b. Fallback automatique agressif si l'insertion √©choue pour N'IMPORTE quelle raison (contrainte, colonne manquante, etc.)\r\n        if (dbError) {\r\n            console.warn(\"‚ö†Ô∏è Fallback GED: √âchec insertion standard, tentative en mode compatibilit√© minimale.\", dbError.message);\r\n\r\n            // On tente une insertion avec UNIQUEMENT les champs pr√©sents dans la version de base (20251224)\r\n            // file_type doit √™tre 'autre' (car 'maintenance' peut ne pas exister)\r\n            // source doit √™tre 'manual' (car 'generated' peut ne pas exister)\r\n            // Pas de description, category, entity_type, etc.\r\n            const { data: retryDoc, error: retryError } = await supabase\r\n                .from('user_documents')\r\n                .insert([{\r\n                    user_id: userId,\r\n                    // description: metadata.description || fileName, // On retire description au cas o√π\r\n                    file_name: fileName,\r\n                    file_type: 'autre',\r\n                    file_path: uploadData.path,\r\n                    file_size: fileBuffer.length,\r\n                    mime_type: 'application/pdf',\r\n                    // source: 'generated', // On retire generated au cas o√π\r\n                    source: 'manual',\r\n                    created_at: new Date().toISOString()\r\n                }])\r\n                .select()\r\n                .single();\r\n\r\n            // Si le fallback r√©ussit, on √©crase l'erreur et le doc\r\n            if (!retryError) {\r\n                console.log(\"‚úÖ Fallback GED r√©ussi (mode compatibilit√©).\");\r\n                doc = retryDoc;\r\n                dbError = null;\r\n            } else {\r\n                console.error(\"‚ùå Echec total GED (m√™me en fallback):\", retryError);\r\n            }\r\n        }\r\n\r\n        if (dbError) {\r\n            console.error(\"Erreur Insert DB user_documents:\", dbError);\r\n            // On pourrait delete le fichier upload√©, mais bon...\r\n            return { success: false, error: dbError.message };\r\n        }\r\n\r\n        return { success: true, document: doc, filePath: uploadData.path, fileUrl };\r\n\r\n    } catch (error) {\r\n        console.error(\"Exception storeDocumentInGED:\", error);\r\n        return { success: false, error: error instanceof Error ? error.message : \"Erreur inconnue\" };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\geocoding.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\google-calendar.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\gtm.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\haptic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hibp-client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hibp.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hooks\\use-favorites-sync.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hooks\\useAccessModal.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1556,1559],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1556,1559],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { create } from \"zustand\";\nimport { submitAccessRequest } from \"@/app/(workspace)/gestion/access-control/actions\";\n\ninterface AccessModalState {\n  isOpen: boolean;\n  featureName: string;\n  permissionKey: string;\n  isSubmitting: boolean;\n  reason: string;\n\n  // Actions\n  openRequestModal: (featureName: string, permissionKey: string) => void;\n  close: () => void;\n  setReason: (reason: string) => void;\n  submitRequest: (teamId: string) => Promise<{ success: boolean; error?: string }>;\n}\n\nexport const useAccessModal = create<AccessModalState>((set, get) => ({\n  isOpen: false,\n  featureName: \"\",\n  permissionKey: \"\",\n  isSubmitting: false,\n  reason: \"\",\n\n  openRequestModal: (featureName: string, permissionKey: string) => {\n    set({\n      isOpen: true,\n      featureName,\n      permissionKey,\n      reason: \"\",\n    });\n  },\n\n  close: () => {\n    set({\n      isOpen: false,\n      featureName: \"\",\n      permissionKey: \"\",\n      reason: \"\",\n      isSubmitting: false,\n    });\n  },\n\n  setReason: (reason: string) => {\n    set({ reason });\n  },\n\n  submitRequest: async (teamId: string) => {\n    const { permissionKey, reason } = get();\n\n    set({ isSubmitting: true });\n\n    try {\n      const result = await submitAccessRequest({\n        teamId,\n        permission: permissionKey,\n        reason: reason || undefined,\n      });\n\n      if (result.data?.success) {\n        get().close();\n        return { success: true };\n      }\n\n      return { success: false, error: result.error || \"Erreur lors de la demande\" };\n    } catch (error: any) {\n      return { success: false, error: error.message };\n    } finally {\n      set({ isSubmitting: false });\n    }\n  },\n}));\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hooks\\useFinancialStatsRealTime.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hooks\\useOptimisticUpdate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hooks\\usePermission.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":128,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3916,3919],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3916,3919],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4651,4654],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4651,4654],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5650,5653],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5650,5653],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"usePermission\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":213,"column":53,"nodeType":"Identifier","endLine":213,"endColumn":66}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\n/**\r\n * Hook usePermission\r\n *\r\n * V√©rifie si l'utilisateur a une permission (via r√¥le ou permission temporaire)\r\n * et fournit une interface pour demander l'acc√®s si n√©cessaire.\r\n */\r\n\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport type { TeamPermissionKey } from '@/lib/team-permissions';\r\nimport { useTeam } from '@/lib/hooks/useTeam';\r\nimport { createClient } from '@/utils/supabase/client';\r\nimport { submitAccessRequest } from '@/app/(workspace)/gestion/access-control/actions';\r\n\r\nexport interface UsePermissionResult {\r\n    /**\r\n     * Si l'utilisateur a la permission (via r√¥le ou temporaire)\r\n     */\r\n    hasPermission: boolean;\r\n\r\n    /**\r\n     * Si la v√©rification est en cours\r\n     */\r\n    isLoading: boolean;\r\n\r\n    /**\r\n     * Erreur lors de la v√©rification\r\n     */\r\n    error: string | null;\r\n\r\n    /**\r\n     * Si une permission temporaire est active\r\n     */\r\n    hasTemporaryAccess: boolean;\r\n\r\n    /**\r\n     * Date d'expiration de la permission temporaire (si applicable)\r\n     */\r\n    temporaryAccessExpiresAt: Date | null;\r\n\r\n    /**\r\n     * Demander l'acc√®s temporaire\r\n     */\r\n    requestAccess: (reason?: string) => Promise<{ success: boolean; error?: string }>;\r\n\r\n    /**\r\n     * Rafra√Æchir le statut de la permission\r\n     */\r\n    refresh: () => Promise<void>;\r\n}\r\n\r\n/**\r\n * Hook pour v√©rifier et g√©rer les permissions\r\n *\r\n * @param permission - La permission √† v√©rifier\r\n * @param options - Options optionnelles\r\n * @returns UsePermissionResult\r\n *\r\n * @example\r\n * ```tsx\r\n * const { hasPermission, requestAccess, isLoading } = usePermission('leases.edit');\r\n *\r\n * if (isLoading) return <Spinner />;\r\n *\r\n * if (!hasPermission) {\r\n *   return <Button onClick={() => requestAccess('J\\'ai besoin d\\'√©diter ce bail')}>\r\n *     Demander l'acc√®s\r\n *   </Button>;\r\n * }\r\n *\r\n * return <LeaseEditForm />;\r\n * ```\r\n */\r\nexport function usePermission(\r\n    permission: TeamPermissionKey,\r\n    options?: {\r\n        /**\r\n         * Si true, ne v√©rifie pas automatiquement au montage\r\n         */\r\n        manual?: boolean;\r\n    }\r\n): UsePermissionResult {\r\n    const { team_id: teamId, user_id, _user } = useTeam();\r\n    const [hasPermission, setHasPermission] = useState(false);\r\n    const [isLoading, setIsLoading] = useState(!options?.manual);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [hasTemporaryAccess, setHasTemporaryAccess] = useState(false);\r\n    const [temporaryAccessExpiresAt, setTemporaryAccessExpiresAt] = useState<Date | null>(null);\r\n\r\n    /**\r\n     * V√©rifie la permission (r√¥le + temporaire)\r\n     */\r\n    const checkPermission = useCallback(async () => {\r\n        if (!teamId || !user_id || !permission) {\r\n            setHasPermission(false);\r\n            setIsLoading(false);\r\n            return;\r\n        }\r\n\r\n        setIsLoading(true);\r\n        setError(null);\r\n\r\n        try {\r\n            const supabase = createClient();\r\n\r\n            // 1. V√©rifier la permission du r√¥le (c√¥t√© client, simple check)\r\n            // Note: Le vrai check est c√¥t√© serveur, mais on peut optimiser l'UX\r\n            // en affichant directement si le r√¥le a la permission\r\n\r\n            // 2. V√©rifier les permissions temporaires actives\r\n            const { data: tempPermissions, error: tempError } = await supabase.rpc(\r\n                'get_active_temporary_permissions',\r\n                {\r\n                    p_team_id: teamId,\r\n                    p_user_id: user_id,\r\n                }\r\n            );\r\n\r\n            if (tempError) {\r\n                console.error('[usePermission] Error fetching temporary permissions:', tempError);\r\n                setError(tempError.message);\r\n                setHasPermission(false);\r\n                return;\r\n            }\r\n\r\n            // Chercher si la permission demand√©e est dans les permissions temporaires\r\n            const tempPerm = tempPermissions?.find((p: any) => p.permission === permission);\r\n\r\n            if (tempPerm) {\r\n                setHasTemporaryAccess(true);\r\n                setTemporaryAccessExpiresAt(new Date(tempPerm.expires_at));\r\n                setHasPermission(true);\r\n            } else {\r\n                setHasTemporaryAccess(false);\r\n                setTemporaryAccessExpiresAt(null);\r\n\r\n                // Si pas de permission temporaire, v√©rifier via le r√¥le\r\n                // (On fait confiance au backend pour la vraie v√©rification)\r\n                // Pour l'instant on assume que le user n'a pas la permission\r\n                // √Ä am√©liorer avec un appel serveur si n√©cessaire\r\n                setHasPermission(false);\r\n            }\r\n        } catch (err: any) {\r\n            console.error('[usePermission] Unexpected error:', err);\r\n            setError(err.message || 'Erreur inattendue');\r\n            setHasPermission(false);\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    }, [teamId, user_id, permission]);\r\n\r\n    /**\r\n     * Demander l'acc√®s temporaire\r\n     */\r\n    const requestAccess = useCallback(async (reason?: string) => {\r\n        if (!teamId || !permission) {\r\n            return { success: false, error: 'Contexte invalide' };\r\n        }\r\n\r\n        try {\r\n            const result = await submitAccessRequest({\r\n                teamId,\r\n                permission,\r\n                reason,\r\n            });\r\n\r\n            if (result.data?.success) {\r\n                // Rafra√Æchir apr√®s la demande\r\n                await checkPermission();\r\n                return { success: true };\r\n            }\r\n\r\n            return { success: false, error: result.error || \"Erreur lors de la demande\" };\r\n        } catch (err: any) {\r\n            console.error('[usePermission] Request access error:', err);\r\n            return {\r\n                success: false,\r\n                error: err.message || 'Erreur lors de la demande d\\'acc√®s',\r\n            };\r\n        }\r\n    }, [teamId, permission, checkPermission]);\r\n\r\n    /**\r\n     * Rafra√Æchir le statut\r\n     */\r\n    const refresh = useCallback(async () => {\r\n        await checkPermission();\r\n    }, [checkPermission]);\r\n\r\n    // V√©rifier au montage (sauf si manual)\r\n    useEffect(() => {\r\n        if (!options?.manual) {\r\n            checkPermission();\r\n        }\r\n    }, [checkPermission, options?.manual]);\r\n\r\n    return {\r\n        hasPermission,\r\n        isLoading,\r\n        error,\r\n        hasTemporaryAccess,\r\n        temporaryAccessExpiresAt,\r\n        requestAccess,\r\n        refresh,\r\n    };\r\n}\r\n\r\n/**\r\n * Hook simplifi√© pour v√©rifier plusieurs permissions\r\n */\r\nexport function usePermissions(permissions: TeamPermissionKey[]) {\r\n    const results = permissions.map((permission) => usePermission(permission));\r\n\r\n    return {\r\n        hasAll: results.every((r) => r.hasPermission),\r\n        hasAny: results.some((r) => r.hasPermission),\r\n        isLoading: results.some((r) => r.isLoading),\r\n        permissions: results,\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\hooks\\useTeam.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[265,268],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[265,268],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useQuery } from '@tanstack/react-query';\r\nimport { createClient } from '@/utils/supabase/client';\r\nimport { useAuth } from '@/hooks/use-auth';\r\n\r\ninterface TeamContext {\r\n    team_id: string | null;\r\n    user_id: string | null;\r\n    user: any;\r\n    loading: boolean;\r\n}\r\n\r\n/**\r\n * Hook pour r√©cup√©rer l'ID de l'√©quipe de l'utilisateur actuel\r\n */\r\nexport function useTeam(): TeamContext {\r\n    const { user, loading: authLoading } = useAuth();\r\n    const supabase = createClient();\r\n\r\n    const { data: teamMember, isLoading: teamLoading } = useQuery({\r\n        queryKey: ['user-team', user?.id],\r\n        queryFn: async () => {\r\n            if (!user) return null;\r\n            const { data, error } = await supabase\r\n                .from('team_members')\r\n                .select('team_id')\r\n                .eq('user_id', user.id)\r\n                .maybeSingle();\r\n\r\n            if (error) throw error;\r\n            return data;\r\n        },\r\n        enabled: !!user,\r\n    });\r\n\r\n    return {\r\n        team_id: teamMember?.team_id || null,\r\n        user_id: user?.id || null,\r\n        user,\r\n        loading: authLoading || teamLoading,\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\import-service.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[278,281],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[278,281],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1400,1403],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1400,1403],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1895,1898],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1895,1898],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2131,2134],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2131,2134],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2148,2151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2148,2151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2180,2183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2180,2183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2216,2219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2216,2219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2617,2620],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2617,2620],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2855,2858],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2855,2858],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3417,3420],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3417,3420],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":109,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3660,3663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3660,3663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":109,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3677,3680],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3677,3680],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4044,4047],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4044,4047],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4684,4687],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4684,4687],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":143,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5076,5079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5076,5079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":143,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5102,5105],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5102,5105],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":152,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5404,5407],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5404,5407],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5849,5852],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5849,5852],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":180,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6374,6377],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6374,6377],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":184,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6539,6542],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6539,6542],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":190,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6735,6738],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6735,6738],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":193,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6872,6875],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6872,6875],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":215,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":215,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7677,7680],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7677,7680],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":223,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7889,7892],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7889,7892],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":223,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7903,7906],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7903,7906],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":25,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js';\r\nimport { Database } from '@/types/supabase';\r\nimport crypto from 'crypto';\r\nimport Fuse from 'fuse.js';\r\n\r\nexport type ResourceType = 'expense' | 'lease' | 'transaction';\r\n\r\nexport interface ImportRow {\r\n    [key: string]: any;\r\n}\r\n\r\nexport class ImportService {\r\n    constructor(private supabase: ReturnType<typeof createClient<Database>>) { }\r\n\r\n    /**\r\n     * G√©n√®re un hash SHA256 unique pour une ligne de donn√©es afin d'√©viter les doublons.\r\n     */\r\n    generateImportHash(data: ImportRow, teamId: string): string {\r\n        const rawString = JSON.stringify(data) + teamId;\r\n        return crypto.createHash('sha256').update(rawString).digest('hex');\r\n    }\r\n\r\n    /**\r\n     * Envoie les donn√©es dans la table de staging pour validation.\r\n     */\r\n    async stageData({\r\n        teamId,\r\n        userId,\r\n        resourceType,\r\n        rows\r\n    }: {\r\n        teamId: string;\r\n        userId: string;\r\n        resourceType: ResourceType;\r\n        rows: ImportRow[];\r\n    }) {\r\n        const stagingEntries = rows.map(row => ({\r\n            team_id: teamId,\r\n            imported_by: userId,\r\n            resource_type: resourceType,\r\n            raw_data: row,\r\n            import_hash: this.generateImportHash(row, teamId),\r\n            status: 'pending' as const\r\n        }));\r\n\r\n        const { data, error } = await (this.supabase as any)\r\n            .from('imports_staging')\r\n            .upsert(stagingEntries, { onConflict: 'team_id, import_hash' })\r\n            .select();\r\n\r\n        if (error) throw error;\r\n        return data;\r\n    }\r\n\r\n    /**\r\n     * Normalise les donn√©es brutes selon le sch√©ma cible.\r\n     * Note: Cette fonction sera enrichie avec la logique de fuzzy matching en Phase 2.\r\n     */\r\n    async standardizeData(id: string) {\r\n        const { data: staged, error: fetchError } = await (this.supabase as any)\r\n            .from('imports_staging')\r\n            .select('*')\r\n            .eq('id', id)\r\n            .single();\r\n\r\n        if (fetchError || !staged) throw fetchError || new Error('Not found');\r\n\r\n        const raw = (staged as any).raw_data as any;\r\n        let standardized: any = {};\r\n\r\n        if ((staged as any).resource_type === 'expense') {\r\n            standardized = {\r\n                amount: parseFloat(raw.montant || raw.amount || 0),\r\n                description: raw.description || raw.libelle || 'Import sans description',\r\n                expense_date: raw.date || new Date().toISOString(),\r\n                category: raw.categorie || raw.category || 'other',\r\n                team_id: (staged as any).team_id,\r\n                meta: {\r\n                    import_source: 'staging',\r\n                    original_data: raw\r\n                }\r\n            };\r\n        }\r\n\r\n        const { error: updateError } = await (this.supabase as any)\r\n            .from('imports_staging')\r\n            .update({\r\n                standardized_data: standardized,\r\n                status: 'validated'\r\n            })\r\n            .eq('id', id);\r\n\r\n        if (updateError) throw updateError;\r\n    }\r\n\r\n    /**\r\n     * Effectue un rapprochement flou (Fuzzy Match) pour trouver le bail ou le bien le plus probable.\r\n     * Thresholds: > 0.95 (Auto-match), > 0.75 (Suggestion)\r\n     */\r\n    async performFuzzyMatch(stagingId: string) {\r\n        const { data: staged, error: fetchError } = await (this.supabase as any)\r\n            .from('imports_staging')\r\n            .select('*')\r\n            .eq('id', stagingId)\r\n            .single();\r\n\r\n        if (fetchError || !staged) throw fetchError || new Error('Not found');\r\n\r\n        const raw = (staged as any).raw_data as any;\r\n        const searchText = `${raw.description || ''} ${raw.property_name || ''} ${raw.tenant_name || ''}`;\r\n\r\n        // 1. R√©cup√©rer les baux et biens de l'√©quipe pour le matching\r\n        const { data: leases } = await this.supabase\r\n            .from('leases')\r\n            .select('id, tenant_name, property_address')\r\n            .eq('team_id', (staged as any).team_id);\r\n\r\n        if (!leases || leases.length === 0) return null;\r\n\r\n        // 2. Configurer Fuse.js\r\n        const fuse = new Fuse(leases, {\r\n            keys: ['tenant_name', 'property_address'],\r\n            includeScore: true,\r\n            threshold: 0.4 // 1 - 0.4 = 0.6 match minimum pour Fuse (on affinera apr√®s)\r\n        });\r\n\r\n        const results = fuse.search(searchText);\r\n\r\n        if (results.length > 0) {\r\n            const bestMatch = results[0];\r\n            const matchScore = 1 - (bestMatch.score || 1); // Normaliser 0-1\r\n\r\n            // 3. Mise √† jour avec le meilleur match\r\n            const updateData: any = {\r\n                match_score: matchScore,\r\n                matched_resource_id: bestMatch.item.id\r\n            };\r\n\r\n            // Auto-validation si score > 0.95\r\n            if (matchScore > 0.95) {\r\n                updateData.status = 'validated';\r\n                // Mettre √† jour standardized_data avec le lease_id match√©\r\n                const currentStandardized = (staged as any).standardized_data as any;\r\n                if (currentStandardized) {\r\n                    updateData.standardized_data = {\r\n                        ...currentStandardized,\r\n                        lease_id: bestMatch.item.id\r\n                    };\r\n                }\r\n            }\r\n\r\n            await (this.supabase as any)\r\n                .from('imports_staging')\r\n                .update(updateData)\r\n                .eq('id', stagingId);\r\n\r\n            return bestMatch;\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Transf√®re les donn√©es valid√©es du staging vers la production.\r\n     */\r\n    async commitImport(teamId: string, resourceType: ResourceType) {\r\n        const { data: validatedEntries, error: fetchError } = await (this.supabase as any)\r\n            .from('imports_staging')\r\n            .select('*')\r\n            .eq('team_id', teamId)\r\n            .eq('resource_type', resourceType)\r\n            .eq('status', 'validated');\r\n\r\n        if (fetchError) throw fetchError;\r\n        if (!validatedEntries || validatedEntries.length === 0) return { count: 0 };\r\n\r\n        const table = resourceType === 'expense' ? 'expenses' :\r\n            resourceType === 'lease' ? 'leases' : 'rental_transactions';\r\n\r\n        const productionData = validatedEntries.map((e: any) => e.standardized_data);\r\n\r\n        // Insertion atomique en production\r\n        const { error: insertError } = await this.supabase\r\n            .from(table as any)\r\n            .insert(productionData);\r\n\r\n        if (insertError) throw insertError;\r\n\r\n        // Marquer comme 'committed'\r\n        const { error: finalizeError } = await (this.supabase as any)\r\n            .from('imports_staging')\r\n            .update({ status: 'committed' })\r\n            .in('id', validatedEntries.map((e: any) => e.id));\r\n\r\n        if (finalizeError) throw finalizeError;\r\n\r\n        return { count: validatedEntries.length };\r\n    }\r\n\r\n    /**\r\n     * Action manuelle : Lie une d√©pense orpheline √† un bail sp√©cifique.\r\n     * Ajoute une trace dans les metadata.\r\n     */\r\n    async linkExpenseToLease(expenseId: string, leaseId: string, userId: string) {\r\n        // 1. R√©cup√©rer les infos du bail pour le team_id\r\n        const { data: lease, error: leaseError } = await this.supabase\r\n            .from('leases')\r\n            .select('team_id')\r\n            .eq('id', leaseId)\r\n            .single();\r\n\r\n        if (leaseError || !lease) throw leaseError || new Error('Lease not found');\r\n\r\n        // 2. Mettre √† jour la d√©pense\r\n        const { data: expense, error: fetchError } = await (this.supabase as any)\r\n            .from('expenses')\r\n            .select('meta')\r\n            .eq('id', expenseId)\r\n            .single();\r\n\r\n        if (fetchError) throw fetchError;\r\n\r\n        const currentMeta = ((expense as any)?.meta as any) || {};\r\n        const correction = {\r\n            type: 'manual_link',\r\n            lease_id: leaseId,\r\n            user_id: userId,\r\n            timestamp: new Date().toISOString()\r\n        };\r\n\r\n        const newMeta = {\r\n            ...currentMeta,\r\n            user_corrections: [...(currentMeta.user_corrections || []), correction]\r\n        };\r\n\r\n        const { error: updateError } = await this.supabase\r\n            .from('expenses')\r\n            .update({\r\n                lease_id: leaseId,\r\n                team_id: lease.team_id,\r\n                meta: newMeta\r\n            })\r\n            .eq('id', expenseId);\r\n\r\n        if (updateError) throw updateError;\r\n        return { success: true };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\invoice.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\kkiapay.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":107,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":107,"endColumn":37,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\lease-expiration-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\logo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\mail-gmail.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\mail-supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\mail.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\maintenance-pdf-generator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\notifications-helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\notifications\\access-control-notifications.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[981,984],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[981,984],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":95,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2621,2624],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2621,2624],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3647,3650],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3647,3650],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":169,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":169,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4558,4561],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4558,4561],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":207,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":207,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5554,5557],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5554,5557],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\n/**\n * Notifications pour le syst√®me de contr√¥le d'acc√®s temporaire\n */\n\nimport { sendEmail } from \"@/lib/mail\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { AccessRequestNotification } from \"@/emails/AccessRequestNotification\";\nimport { AccessApproved } from \"@/emails/AccessApproved\";\nimport { AccessRejected } from \"@/emails/AccessRejected\";\nimport { AccessExpiring } from \"@/emails/AccessExpiring\";\n\nconst BASE_URL = process.env.NEXT_PUBLIC_APP_URL || \"https://dousell.com\";\n\n// R√©cup√®re les emails des owners et managers d'une √©quipe\nasync function getTeamManagersEmails(teamId: string): Promise<string[]> {\n  const supabase = await createClient();\n\n  const { data: managers } = await supabase\n    .from(\"team_members\")\n    .select(`\n      user_id,\n      profiles:user_id(email)\n    `)\n    .eq(\"team_id\", teamId)\n    .in(\"role\", [\"owner\", \"manager\"])\n    .eq(\"status\", \"active\");\n\n  if (!managers) return [];\n\n  return managers\n    .map((m: any) => m.profiles?.email)\n    .filter(Boolean);\n}\n\nasync function getTeamName(teamId: string): Promise<string> {\n  const supabase = await createClient();\n  const { data: team } = await supabase\n    .from(\"teams\")\n    .select(\"name\")\n    .eq(\"id\", teamId)\n    .single();\n\n  return team?.name || \"Votre √©quipe\";\n}\n\nasync function getUserInfo(userId: string): Promise<{ email: string; name: string }> {\n  const supabase = await createClient();\n  const { data: profile } = await supabase\n    .from(\"profiles\")\n    .select(\"email, full_name\")\n    .eq(\"id\", userId)\n    .single();\n\n  return {\n    email: profile?.email || \"\",\n    name: profile?.full_name || profile?.email || \"Utilisateur\",\n  };\n}\n\nexport async function notifyAccessRequest(data: {\n  teamId: string;\n  requesterId: string;\n  permission: string;\n  reason?: string;\n}) {\n  try {\n    const { teamId, requesterId, permission, reason } = data;\n    const [managersEmails, teamName, requesterInfo] = await Promise.all([\n      getTeamManagersEmails(teamId),\n      getTeamName(teamId),\n      getUserInfo(requesterId),\n    ]);\n\n    if (managersEmails.length === 0) {\n      console.warn(\"[Access Request] No managers found\");\n      return { success: false };\n    }\n\n    await sendEmail({\n      to: managersEmails,\n      subject: `Nouvelle demande d'acc√®s de ${requesterInfo.name}`,\n      react: AccessRequestNotification({\n        requesterName: requesterInfo.name,\n        requesterEmail: requesterInfo.email,\n        permission,\n        reason,\n        teamName,\n        reviewUrl: `${BASE_URL}/gestion/access-control`,\n      }),\n    });\n\n    return { success: true };\n  } catch (error: any) {\n    console.error(\"[Access Request] Error:\", error);\n    return { success: false };\n  }\n}\n\nexport async function notifyAccessApproved(data: {\n  teamId: string;\n  requesterId: string;\n  permission: string;\n  expiresAt: string;\n  durationHours: number;\n  reviewerId: string;\n  reviewNotes?: string;\n}) {\n  try {\n    const { teamId, requesterId, permission, expiresAt, durationHours, reviewerId, reviewNotes } = data;\n    const [requesterInfo, reviewerInfo, teamName] = await Promise.all([\n      getUserInfo(requesterId),\n      getUserInfo(reviewerId),\n      getTeamName(teamId),\n    ]);\n\n    await sendEmail({\n      to: requesterInfo.email,\n      subject: \"‚úÖ Votre demande d'acc√®s a √©t√© approuv√©e\",\n      react: AccessApproved({\n        userName: requesterInfo.name,\n        permission,\n        expiresAt,\n        durationHours,\n        reviewerName: reviewerInfo.name,\n        reviewNotes,\n        teamName,\n        dashboardUrl: `${BASE_URL}/gestion`,\n      }),\n    });\n\n    return { success: true };\n  } catch (error: any) {\n    console.error(\"[Access Approved] Error:\", error);\n    return { success: false };\n  }\n}\n\nexport async function notifyAccessRejected(data: {\n  teamId: string;\n  requesterId: string;\n  permission: string;\n  reviewerId: string;\n  reviewNotes?: string;\n}) {\n  try {\n    const { teamId, requesterId, permission, reviewerId, reviewNotes } = data;\n    const [requesterInfo, reviewerInfo, teamName] = await Promise.all([\n      getUserInfo(requesterId),\n      getUserInfo(reviewerId),\n      getTeamName(teamId),\n    ]);\n\n    await sendEmail({\n      to: requesterInfo.email,\n      subject: \"Votre demande d'acc√®s temporaire\",\n      react: AccessRejected({\n        userName: requesterInfo.name,\n        permission,\n        reviewerName: reviewerInfo.name,\n        reviewNotes,\n        teamName,\n        contactUrl: `${BASE_URL}/gestion/equipe`,\n      }),\n    });\n\n    return { success: true };\n  } catch (error: any) {\n    console.error(\"[Access Rejected] Error:\", error);\n    return { success: false };\n  }\n}\n\nexport async function notifyAccessExpiring(data: {\n  teamId: string;\n  userId: string;\n  permission: string;\n  expiresAt: string;\n}) {\n  try {\n    const { teamId, userId, permission, expiresAt } = data;\n    const expiresAtDate = new Date(expiresAt);\n    const hoursRemaining = Math.ceil((expiresAtDate.getTime() - Date.now()) / (1000 * 60 * 60));\n\n    if (hoursRemaining <= 0) return { success: false };\n\n    const [userInfo, teamName] = await Promise.all([\n      getUserInfo(userId),\n      getTeamName(teamId),\n    ]);\n\n    await sendEmail({\n      to: userInfo.email,\n      subject: `‚è∞ Votre acc√®s temporaire expire dans ${hoursRemaining}h`,\n      react: AccessExpiring({\n        userName: userInfo.name,\n        permission,\n        expiresAt,\n        hoursRemaining,\n        teamName,\n        requestUrl: `${BASE_URL}/gestion`,\n      }),\n    });\n\n    return { success: true };\n  } catch (error: any) {\n    console.error(\"[Access Expiring] Error:\", error);\n    return { success: false };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\onesignal.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\paydunya.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":545,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":545,"endColumn":37,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\pdf-generator-helper.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[537,540],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[537,540],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[557,560],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[557,560],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[729,732],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[729,732],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { ContractData } from './contract-template';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\n\n/**\n * Remplace les placeholders dans le texte par les valeurs du contrat\n * Format support√©: {{objet.propriete}} ou {{objet.sous_objet.propriete}}\n * Ex: {{tenant.firstName}}, {{lease.monthlyRent}}\n */\nexport function replacePlaceholders(template: string, data: ContractData): string {\n    if (!template) return '';\n\n    // Fonction r√©cursive pour acc√©der aux propri√©t√©s imbriqu√©es\n    const getValue = (obj: any, path: string): any => {\n        return path.split('.').reduce((acc, part) => acc && acc[part], obj);\n    };\n\n    // Formatage sp√©cial pour certains champs\n    const formatValue = (value: any, key: string): string => {\n        if (value instanceof Date) {\n            return format(value, 'dd MMMM yyyy', { locale: fr });\n        }\n\n        if (typeof value === 'number') {\n            // Format mon√©taire pour les champs li√©s √† l'argent\n            if (key.toLowerCase().includes('rent') ||\n                key.toLowerCase().includes('amount') ||\n                key.toLowerCase().includes('price') ||\n                key.toLowerCase().includes('deposit') ||\n                key.toLowerCase().includes('charges')) {\n                return value.toLocaleString('fr-FR');\n            }\n            return value.toString();\n        }\n\n        return value || '';\n    };\n\n    // Remplacement des patterns {{...}}\n    return template.replace(/\\{\\{([^}]+)\\}\\}/g, (match, key) => {\n        const trimmedKey = key.trim();\n        const value = getValue(data, trimmedKey);\n\n        // Si la valeur existe, on la formate, sinon on laisse une chaine vide (ou le placeholder pour debug)\n        if (value !== undefined && value !== null) {\n            return formatValue(value, trimmedKey);\n        }\n\n        // Cas sp√©ciaux calcul√©s\n        if (trimmedKey === 'lease.totalRent') {\n            const rent = data.lease.monthlyRent || 0;\n            const charges = data.lease.charges || 0;\n            return formatValue(rent + charges, 'totalRent');\n        }\n\n        if (trimmedKey === 'landlord.fullName') {\n            if (data.landlord.companyName) return data.landlord.companyName;\n            return `${data.landlord.firstName} ${data.landlord.lastName}`;\n        }\n\n        if (trimmedKey === 'tenant.fullName') {\n            return `${data.tenant.firstName} ${data.tenant.lastName}`;\n        }\n\n        // Mappings sp√©cifiques pour les templates fran√ßais (contract-defaults.ts uses French keys)\n        const frenchMappings: Record<string, string> = {\n            'montant_caution': 'lease.securityDeposit',\n            'montant_loyer': 'lease.monthlyRent',\n            'duree_bail': 'lease.duration',\n            'date_debut': 'lease.startDate',\n            'jour_paiement': 'lease.billingDay',\n            'adresse_bien': 'property.address',\n            'description_bien': 'property.description',\n            'r√©partition_frais': 'lease.frais' // Pas standard, mais au cas o√π\n        };\n\n        if (frenchMappings[trimmedKey]) {\n            const mappedPath = frenchMappings[trimmedKey];\n            const mappedValue = getValue(data, mappedPath);\n            if (mappedValue !== undefined && mappedValue !== null) {\n                return formatValue(mappedValue, mappedPath);\n            }\n        }\n\n        return ''; // Ou `[${trimmedKey}]` pour voir les manquants\n    });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\pdf-generator.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":585,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":585,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18884,18887],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18884,18887],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":587,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":587,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19057,19060],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19057,19060],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":608,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":608,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19633,19636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19633,19636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":624,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":624,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20015,20018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20015,20018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * G√©n√©rateur de PDF pour Contrats de Bail\n * Utilise pdf-lib pour cr√©er des PDFs professionnels\n *\n * Features:\n * - Mise en page professionnelle avec marges\n * - Support des signatures num√©riques (images)\n * - Logo du propri√©taire\n * - Conformit√© visuelle S√©n√©gal\n */\n\nimport { PDFDocument, rgb, StandardFonts, PDFFont, PDFPage, degrees } from 'pdf-lib';\nimport { _generateContractText, ContractData, validateContractData } from './contract-template';\nimport { DEFAULT_CONTRACT_TEXTS, ContractCustomTexts } from './contract-defaults';\nimport { replacePlaceholders } from './pdf-generator-helper';\nimport { _format } from 'date-fns';\nimport { _fr } from 'date-fns/locale';\n\nconst COLORS = {\n  primary: rgb(0.2, 0.2, 0.6),\n  secondary: rgb(0.4, 0.4, 0.4),\n  text: rgb(0, 0, 0),\n  lightGray: rgb(0.95, 0.95, 0.95),\n  mediumGray: rgb(0.8, 0.8, 0.8),\n};\n\ninterface PDFGenerationOptions {\n  includeWatermark?: boolean;\n  watermarkText?: string;\n  logoUrl?: string;\n}\n\ninterface PDFGenerationResult {\n  success: boolean;\n  pdfBytes?: Uint8Array;\n  error?: string;\n}\n\n/**\n * G√©n√®re un PDF de contrat de bail √† partir des donn√©es\n */\n/**\n * G√©n√®re un PDF de contrat de bail √† partir des donn√©es\n */\nexport async function generateLeasePDF(\n  data: ContractData,\n  customTexts: ContractCustomTexts = {},\n  options: PDFGenerationOptions = {}\n): Promise<PDFGenerationResult> {\n  try {\n    // 1. Validation des donn√©es\n    const validation = validateContractData(data);\n    if (!validation.valid) {\n      return {\n        success: false,\n        error: `Donn√©es invalides: ${validation.errors.join(', ')}`\n      };\n    }\n\n    // 2. Cr√©er un nouveau document PDF\n    const pdfDoc = await PDFDocument.create();\n\n    // 3. Charger les polices\n    const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);\n    const fontRegular = await pdfDoc.embedFont(StandardFonts.Helvetica);\n\n    // 4. Contenu du contrat (Header, Parties, Articles via CMS)\n    await addContractContent(pdfDoc, data, customTexts, fontRegular, fontBold, options);\n\n    // 6. Signatures int√©gr√©es dans addContractContent\n\n    // 7. Ajouter le watermark si demand√© (brouillon, etc.)\n    if (options.includeWatermark && options.watermarkText) {\n      await addWatermark(pdfDoc, options.watermarkText);\n    }\n\n    // 8. Sauvegarder et retourner\n    const pdfBytes = await pdfDoc.save();\n\n    return {\n      success: true,\n      pdfBytes\n    };\n\n  } catch (error) {\n    console.error('Erreur g√©n√©ration PDF:', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n\n/**\n * Ajoute le contenu structur√© du contrat : Header, Grille Parties, Articles\n */\nasync function addContractContent(\n  pdfDoc: PDFDocument,\n  data: ContractData,\n  customTexts: ContractCustomTexts,\n  fontRegular: PDFFont,\n  fontBold: PDFFont,\n  options: PDFGenerationOptions\n): Promise<void> {\n  const pageWidth = 595.28; // A4 width\n  const pageHeight = 841.89; // A4 height\n  const margin = 50;\n\n  // Cr√©ation de la premi√®re page\n  let currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n  let currentY = pageHeight - margin;\n\n  // --- 1. HEADER (Logo + Titre) ---\n  currentY = await drawHeader(pdfDoc, currentPage, data, options, currentY, pageWidth, margin, fontBold);\n\n  // --- 2. PARTIES (Grille Bailleur / Locataire) ---\n  currentY = drawPartiesGrid(currentPage, data, currentY, pageWidth, margin, fontRegular, fontBold);\n\n  // Espace apr√®s la grille\n  currentY -= 30;\n\n  // --- 3. CORPS (Articles CMS) ---\n  const lineSpacing = 14;\n  const maxWidth = pageWidth - (2 * margin);\n\n  // Fusion des textes\n  const finalTexts = { ...DEFAULT_CONTRACT_TEXTS, ...customTexts };\n\n  const articles = [\n    { title: \"ARTICLE 1 : OBJET DU BAIL ET DESCRIPTION DU BIEN\", content: finalTexts.article_1_objet },\n    { title: \"ARTICLE 2 : DESTINATION DES LIEUX\", content: finalTexts.article_2_destination },\n    { title: \"ARTICLE 3 : DUR√âE DU BAIL\", content: finalTexts.article_3_duree },\n    { title: \"ARTICLE 4 : LOYER\", content: finalTexts.article_4_loyer },\n    { title: \"ARTICLE 5 : CHARGES ET CONSOMMATIONS\", content: finalTexts.article_5_charges },\n    { title: \"ARTICLE 6 : D√âP√îT DE GARANTIE (CAUTION)\", content: finalTexts.article_6_caution },\n    { title: \"ARTICLE 7 : OBLIGATIONS DU PRENEUR\", content: finalTexts.article_7_obligations_preneur },\n    { title: \"ARTICLE 8 : OBLIGATIONS DU BAILLEUR\", content: finalTexts.article_8_obligations_bailleur },\n    { title: \"ARTICLE 9 : R√âSILIATION ET PR√âAVIS\", content: finalTexts.article_9_resiliation },\n    { title: \"ARTICLE 10 : CLAUSE R√âSOLUTOIRE\", content: finalTexts.article_10_clause_resolutoire },\n    { title: \"ARTICLE 11 : √âLECTION DE DOMICILE ET JURIDICTION COMP√âTENTE\", content: finalTexts.article_11_election_domicile },\n    { title: \"ARTICLE 12 : FRAIS ET EXEMPLAIRES\", content: finalTexts.article_12_frais },\n  ];\n\n  // Titre introductif\n  currentPage.drawText(\"IL A ETE CONVENU ET ARRETE CE QUI SUIT :\", {\n    x: margin,\n    y: currentY,\n    size: 10,\n    font: fontBold,\n    color: COLORS.text,\n  });\n  currentY -= (lineSpacing * 2);\n\n  // Boucle de rendu des articles\n  for (const art of articles) {\n    // V√©rif nouvelle page (avec marge de s√©curit√©)\n    if (currentY < 100) {\n      drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n      currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n      currentY = pageHeight - margin;\n    }\n\n    // Titre de l'article\n    currentPage.drawText(art.title, { x: margin, y: currentY, size: 11, font: fontBold, color: COLORS.text });\n\n    // Soulignage du titre\n    const titleWidth = fontBold.widthOfTextAtSize(art.title, 11);\n    currentPage.drawLine({\n      start: { x: margin, y: currentY - 2 },\n      end: { x: margin + titleWidth, y: currentY - 2 },\n      thickness: 1,\n      color: COLORS.text,\n    });\n\n    currentY -= 15;\n\n    // Remplacement des variables\n    const contentWithVars = replacePlaceholders(art.content || \"\", data);\n\n    // Contenu (Wrapp√©)\n    const lines = wrapText(contentWithVars, fontRegular, 10, maxWidth);\n    for (const line of lines) {\n      // V√©rif saut de page intra-article\n      if (currentY < margin + 20) {\n        drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n        currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n        currentY = pageHeight - margin;\n      }\n\n      currentPage.drawText(line, { x: margin, y: currentY, size: 10, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });\n      currentY -= lineSpacing;\n    }\n    currentY -= 15; // Espace entre articles\n  }\n\n  // --- CLAUSES PARTICULI√àRES (AJOUT) ---\n  if (customTexts.custom_clauses && customTexts.custom_clauses.trim() !== \"\") {\n    if (currentY < 100) {\n      drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n      currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n      currentY = pageHeight - margin;\n    }\n\n    const customTitle = \"CONDITIONS PARTICULI√àRES\";\n    currentPage.drawText(customTitle, { x: margin, y: currentY, size: 11, font: fontBold, color: COLORS.text });\n\n    const cw = fontBold.widthOfTextAtSize(customTitle, 11);\n    currentPage.drawLine({\n      start: { x: margin, y: currentY - 2 },\n      end: { x: margin + cw, y: currentY - 2 },\n      thickness: 1,\n      color: COLORS.text,\n    });\n\n    currentY -= 15;\n\n    const lines = wrapText(customTexts.custom_clauses, fontRegular, 10, maxWidth);\n    for (const line of lines) {\n      if (currentY < margin + 20) {\n        drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n        currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n        currentY = pageHeight - margin;\n      }\n      currentPage.drawText(line, { x: margin, y: currentY, size: 10, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });\n      currentY -= lineSpacing;\n    }\n    currentY -= 20;\n  }\n\n  // --- SECTION SIGNATURES ---\n  // On s'assure d'avoir assez de place (150px min), sinon nouvelle page\n  if (currentY < 150) {\n    drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n    currentPage = pdfDoc.addPage([pageWidth, pageHeight]);\n    currentY = pageHeight - margin;\n  }\n\n  currentY -= 30; // Petit espace avant la zone\n\n  // Titre de section\n  currentPage.drawText(\"SIGNATURES\", { x: margin, y: currentY, size: 12, font: fontBold, color: COLORS.primary });\n  currentPage.drawLine({\n    start: { x: margin, y: currentY - 5 },\n    end: { x: pageWidth - margin, y: currentY - 5 },\n    thickness: 1,\n    color: COLORS.primary // Primary color\n  });\n\n  currentY -= 40; // Espace sous la ligne\n\n  // --- COLONNE GAUCHE : BAILLEUR ---\n  const leftColX = margin;\n  currentPage.drawText(\"LE BAILLEUR (Propri√©taire)\", { x: leftColX, y: currentY, size: 10, font: fontBold, color: COLORS.primary });\n  currentPage.drawText(\"Lu et approuv√©\", { x: leftColX, y: currentY - 15, size: 9, font: fontRegular, color: COLORS.secondary });\n\n  // Signature Bailleur\n  if (data.signatures.landlordSignatureUrl) {\n    try {\n      const sigImage = await fetchAndEmbedImage(pdfDoc, data.signatures.landlordSignatureUrl);\n      if (sigImage) {\n        const sigWidth = 120;\n        const sigHeight = 60;\n        const scaledDims = sigImage.scale(sigWidth / sigImage.width);\n        currentPage.drawImage(sigImage, {\n          x: leftColX,\n          y: currentY - 80,\n          width: Math.min(scaledDims.width, sigWidth),\n          height: Math.min(scaledDims.height, sigHeight),\n        });\n      }\n    } catch (e) { console.warn(\"Erreur signature bailleur\", e); }\n  }\n\n\n  // --- COLONNE DROITE : PRENEUR ---\n  const rightColX = pageWidth / 2 + 20; // On commence apr√®s le milieu\n  currentPage.drawText(\"LE PRENEUR (Locataire)\", { x: rightColX, y: currentY, size: 10, font: fontBold, color: COLORS.primary });\n  currentPage.drawText(\"Lu et approuv√©\", { x: rightColX, y: currentY - 15, size: 9, font: fontRegular, color: COLORS.secondary });\n\n  // Signature Preneur\n  if (data.signatures.tenantSignatureUrl) {\n    try {\n      const sigImage = await fetchAndEmbedImage(pdfDoc, data.signatures.tenantSignatureUrl);\n      if (sigImage) {\n        const sigWidth = 120;\n        const sigHeight = 60;\n        const scaledDims = sigImage.scale(sigWidth / sigImage.width);\n        currentPage.drawImage(sigImage, {\n          x: rightColX,\n          y: currentY - 80,\n          width: Math.min(scaledDims.width, sigWidth),\n          height: Math.min(scaledDims.height, sigHeight),\n        });\n      }\n    } catch (_e) {\n      console.warn(\"Pas de signature locataire charg√©e\");\n    }\n  }\n\n\n  // Footer pour la derni√®re page\n  drawFooter(currentPage, pdfDoc.getPageCount(), pageWidth, fontRegular);\n\n  // Mettre √† jour les num√©ros de page\n  const totalPages = pdfDoc.getPageCount();\n  const pages = pdfDoc.getPages();\n  pages.forEach((page, idx) => {\n    page.drawText(`Page ${idx + 1} sur ${totalPages}`, {\n      x: pageWidth - margin - 80,\n      y: 30,\n      size: 9,\n      font: fontRegular,\n      color: COLORS.secondary,\n    });\n\n    page.drawLine({\n      start: { x: margin, y: 45 },\n      end: { x: pageWidth - margin, y: 45 },\n      thickness: 0.5,\n      color: COLORS.mediumGray,\n    });\n  });\n}\n\n// --- HELPERS VISUELS ---\n\n/** Dessine l'en-t√™te avec Logo et Titre Encadr√© (Empil√©s) */\nasync function drawHeader(\n  pdfDoc: PDFDocument,\n  page: PDFPage,\n  data: ContractData,\n  options: PDFGenerationOptions,\n  startY: number,\n  pageWidth: number,\n  margin: number,\n  fontBold: PDFFont\n): Promise<number> {\n  let currentY = startY;\n\n  // 1. Logo √† Gauche (s'il existe)\n  if (options.logoUrl) {\n    try {\n      const logoImage = await fetchAndEmbedImage(pdfDoc, options.logoUrl);\n      if (logoImage) {\n        const logoHeight = 40;\n        const logoDims = logoImage.scale(logoHeight / logoImage.height);\n        page.drawImage(logoImage, {\n          x: margin, // Gauche\n          y: currentY - logoHeight,\n          width: logoDims.width,\n          height: logoDims.height,\n        });\n\n        // On descend le curseur Y sous le logo + marge\n        currentY -= (logoHeight + 20);\n      }\n    } catch (e) { console.warn(\"Erreur logo\", e); }\n  }\n\n  // 2. Titre Centr√© et Encadr√© (Sous le logo)\n  const title = \"CONTRAT DE BAIL A USAGE D'HABITATION\";\n  const subTitle = \"R√©publique du S√©n√©gal\";\n  const textSize = 14;\n  const titleWidth = fontBold.widthOfTextAtSize(title, textSize);\n  const boxWidth = titleWidth + 40;\n  const boxHeight = 50;\n  const boxX = (pageWidth - boxWidth) / 2;\n  const boxY = currentY - boxHeight; // Positionn√© par rapport au nouveau currentY\n\n  // Fond gris l√©ger\n  page.drawRectangle({\n    x: boxX,\n    y: boxY,\n    width: boxWidth,\n    height: boxHeight,\n    color: COLORS.lightGray,\n    borderColor: COLORS.mediumGray,\n    borderWidth: 1,\n  });\n\n  // Texte Titre\n  page.drawText(title, {\n    x: (pageWidth - titleWidth) / 2,\n    y: boxY + 25,\n    size: textSize,\n    font: fontBold,\n    color: COLORS.primary, // Primary Color\n  });\n\n  // Sous-titre\n  const subSize = 10;\n  const subWidth = fontBold.widthOfTextAtSize(subTitle, subSize);\n  page.drawText(subTitle, {\n    x: (pageWidth - subWidth) / 2,\n    y: boxY + 10,\n    size: subSize,\n    font: fontBold,\n    color: COLORS.secondary,\n  });\n\n  return boxY - 30; // Espace apr√®s header\n}\n\n/** Dessine la Grille des Parties (Bailleur / Preneur) */\nfunction drawPartiesGrid(\n  page: PDFPage,\n  data: ContractData,\n  startY: number,\n  pageWidth: number,\n  margin: number,\n  fontRegular: PDFFont,\n  fontBold: PDFFont\n): number {\n  const { landlord, tenant } = data;\n  const boxHeight = 160;\n  const colWidth = (pageWidth - (2 * margin) - 10) / 2; // -10 pour gap au milieu\n  const col1X = margin;\n  const col2X = margin + colWidth + 10;\n\n  // Fond global gris tr√®s clair pour la zone\n  page.drawRectangle({\n    x: margin,\n    y: startY - boxHeight,\n    width: pageWidth - (2 * margin),\n    height: boxHeight,\n    color: rgb(0.97, 0.97, 0.97),\n    borderColor: rgb(0.9, 0.9, 0.9),\n    borderWidth: 1,\n  }); // Erreur possible si boxHeight trop petit pour le contenu, on assume A4 fixe\n\n  let textY = startY - 20;\n\n  // --- COLONNE 1 : BAILLEUR ---\n  page.drawText(\"LE BAILLEUR\", { x: col1X + 10, y: textY, size: 10, font: fontBold, color: rgb(0.2, 0.2, 0.6) });\n  textY -= 15;\n\n  const lLines = [\n    landlord.companyName ? `Soci√©t√© : ${landlord.companyName}` : `M./Mme : ${landlord.firstName} ${landlord.lastName}`,\n    landlord.companyName && landlord.ninea ? `NINEA : ${landlord.ninea}` : '',\n    `Adresse : ${landlord.address}`,\n    `Tel : ${landlord.phone}`,\n    landlord.email ? `Email : ${landlord.email}` : ''\n  ].filter(l => l);\n\n  let lY = textY;\n  for (const l of lLines) {\n    // Wrap si n√©cessaire (adresse longue)\n    const wrapped = wrapText(l, fontRegular, 9, colWidth - 20);\n    for (const wL of wrapped) {\n      page.drawText(wL, { x: col1X + 10, y: lY, size: 9, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });\n      lY -= 12;\n    }\n  }\n\n  // --- COLONNE 2 : PRENEUR ---\n  textY = startY - 20; // Reset Y pour colonne 2\n  page.drawText(\"LE PRENEUR\", { x: col2X + 10, y: textY, size: 10, font: fontBold, color: rgb(0.2, 0.2, 0.6) });\n  textY -= 15;\n\n  const tLines = [\n    `M./Mme : ${tenant.firstName} ${tenant.lastName}`,\n    tenant.nationalId ? `CNI / Passeport : ${tenant.nationalId}` : '',\n    `Tel : ${tenant.phone}`,\n    tenant.email ? `Email : ${tenant.email}` : ''\n  ].filter(l => l);\n\n  let tY = textY;\n  for (const l of tLines) {\n    const wrapped = wrapText(l, fontRegular, 9, colWidth - 20);\n    for (const wL of wrapped) {\n      page.drawText(wL, { x: col2X + 10, y: tY, size: 9, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });\n      tY -= 12;\n    }\n  }\n\n  // Ligne verticale de s√©paration\n  page.drawLine({\n    start: { x: margin + colWidth + 5, y: startY - 10 },\n    end: { x: margin + colWidth + 5, y: startY - boxHeight + 10 },\n    color: rgb(0.8, 0.8, 0.8),\n    thickness: 1\n  });\n\n  return startY - boxHeight; // Retourne la nouvelle position Y\n}\n\n/** Helper simple pour footer temporaire (avant override final) */\nfunction drawFooter(_page: PDFPage, _pageNum: number, _width: number, _font: PDFFont) {\n  // Vide intentionnellement ou simple placeholder, le vrai est fait √† la fin\n}\n\n\n/**\n * Wrapper le texte pour qu'il tienne dans la largeur maximale, en respectant les sauts de ligne\n */\nfunction wrapText(text: string, font: PDFFont, fontSize: number, maxWidth: number): string[] {\n  // 1. Normaliser les sauts de ligne et ASSAINIR le texte (Char non support√©s par WinAnsi - ex 0x202f)\n  const normalizedText = text\n    .replace(/\\r\\n/g, '\\n')\n    .replace(/\\r/g, '\\n')\n    // Espace inc√©sable √©troit (0x202f) et autres espaces bizarres -> espace simple\n    .replace(/[\\u00A0\\u2000-\\u200B\\u202F\\u205F\\u3000]/g, ' ')\n    // Guillemets et apostrophes\n    .replace(/[¬´¬ª‚Äú‚Äù]/g, '\"')\n    .replace(/[‚Äò‚Äô]/g, \"'\")\n    // Tirets\n    .replace(/[‚Äì‚Äî]/g, '-')\n    // Points de suspension\n    .replace(/‚Ä¶/g, '...');\n\n  // 2. D√©couper en paragraphes\n  const paragraphs = normalizedText.split('\\n');\n  const allLines: string[] = [];\n\n  for (const paragraph of paragraphs) {\n    if (paragraph.trim() === '') {\n      // Conserver les sauts de ligne vides (paragraphes vides)\n      // On ajoute une ligne vide si ce n'est pas la toute premi√®re (√©vite marge top excessive)\n      // mais ici on veut respecter le format user.\n      allLines.push('');\n      continue;\n    }\n\n    const words = paragraph.split(' ');\n    let currentLine = '';\n\n    for (const word of words) {\n      const testLine = currentLine ? `${currentLine} ${word}` : word;\n      const width = font.widthOfTextAtSize(testLine, fontSize);\n\n      if (width <= maxWidth) {\n        currentLine = testLine;\n      } else {\n        if (currentLine) {\n          allLines.push(currentLine);\n        }\n        currentLine = word;\n      }\n    }\n\n    if (currentLine) {\n      allLines.push(currentLine);\n    }\n  }\n\n  return allLines.length > 0 ? allLines : [''];\n}\n\n/**\n * Ajoute les signatures sur la derni√®re page\n */\n\n\n/**\n * Ajoute un watermark (filigrane) sur toutes les pages\n */\nasync function addWatermark(pdfDoc: PDFDocument, text: string): Promise<void> {\n  const pages = pdfDoc.getPages();\n  const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);\n\n  pages.forEach(page => {\n    const { width, height } = page.getSize();\n    page.drawText(text, {\n      x: width / 2 - 100,\n      y: height / 2,\n      size: 60,\n      font: font,\n      color: rgb(0.9, 0.9, 0.9),\n      opacity: 0.3,\n      rotate: degrees(-45), // Utiliser degrees() de pdf-lib\n    });\n  });\n}\n\n/**\n * R√©cup√®re et embed une image depuis une URL\n */\nasync function fetchAndEmbedImage(pdfDoc: PDFDocument, imageUrl: string) {\n  try {\n    const response = await fetch(imageUrl);\n    const imageBytes = await response.arrayBuffer();\n\n    // D√©terminer le type d'image\n    if (imageUrl.toLowerCase().endsWith('.png')) {\n      return await pdfDoc.embedPng(new Uint8Array(imageBytes) as any);\n    } else if (imageUrl.toLowerCase().endsWith('.jpg') || imageUrl.toLowerCase().endsWith('.jpeg')) {\n      return await pdfDoc.embedJpg(new Uint8Array(imageBytes) as any);\n    } else {\n      console.warn('Format d\\'image non support√©:', imageUrl);\n      return null;\n    }\n  } catch (err) {\n    console.error('Erreur chargement image:', err);\n    return null;\n  }\n}\n\n/**\n * Sauvegarde le PDF en fichier (pour Node.js)\n */\nexport async function savePDFToFile(pdfBytes: Uint8Array, filename: string): Promise<void> {\n  if (typeof window === 'undefined') {\n    // Environnement Node.js\n    const fs = await import('fs');\n    fs.writeFileSync(filename, pdfBytes);\n  } else {\n    // Environnement navigateur\n    const blob = new Blob([pdfBytes as any], { type: 'application/pdf' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    link.click();\n    URL.revokeObjectURL(url);\n  }\n}\n\n/**\n * Upload le PDF vers Supabase Storage\n */\nexport async function uploadPDFToStorage(\n  pdfBytes: Uint8Array,\n  filename: string,\n  supabaseClient: any\n): Promise<{ success: boolean; url?: string; error?: string }> {\n  try {\n    const { _data, error } = await supabaseClient.storage\n      .from('lease-contracts') // Bucket priv√©\n      .upload(filename, pdfBytes, {\n        contentType: 'application/pdf',\n        upsert: true\n      });\n\n    if (error) {\n      return { success: false, error: error.message };\n    }\n\n    // Cr√©er une URL sign√©e (valide 1 an = 31536000 secondes) pour bucket priv√©\n    const { data: signedData, error: signedError } = await supabaseClient.storage\n      .from('lease-contracts')\n      .createSignedUrl(filename, 31536000);\n\n    if (signedError) {\n      console.error('Erreur cr√©ation URL sign√©e:', signedError);\n      // Fallback: retourner le chemin du fichier √† la place\n      return {\n        success: true,\n        url: `storage://lease-contracts/${filename}` // URL interne pour r√©f√©rence\n      };\n    }\n\n    return {\n      success: true,\n      url: signedData.signedUrl\n    };\n\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\rate-limit\\__tests__\\ai-limiter.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\rate-limit\\ai-limiter.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":80,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2778,2781],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2778,2781],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * AI Rate Limiter avec Redis ZSET (Atomic Operations)\r\n * \r\n * Impl√©mentation robuste avec:\r\n * - Sliding window algorithm\r\n * - Op√©rations atomiques via ZSET (√©vite race conditions)\r\n * - Fallback String/JSON si ZSET non disponible\r\n * - Fail-open strategy (autoriser si Redis down)\r\n * \r\n * @see implementation_plan.md pour d√©tails techniques\r\n */\r\n\r\nimport { redis, getRedisClient } from '@/lib/cache/redis-client';\r\nimport { AI_RATE_LIMIT_CONFIG, type RateLimitResult } from './types';\r\n\r\nconst REDIS_KEY_PREFIX = 'ratelimit:ai:';\r\n\r\n/**\r\n * V√©rifie si l'√©quipe peut faire un appel IA\r\n * \r\n * @param teamId - ID de l'√©quipe\r\n * @returns RateLimitResult avec allowed, remaining, resetAt\r\n * \r\n * @example\r\n * const result = await checkAIRateLimit('team-123');\r\n * if (!result.allowed) {\r\n *   return { error: `Limite atteinte. ${result.remaining} appels restants.` };\r\n * }\r\n */\r\nexport async function checkAIRateLimit(teamId: string): Promise<RateLimitResult> {\r\n    const key = `${REDIS_KEY_PREFIX}${teamId}`;\r\n    const now = Date.now();\r\n    const windowStart = now - (AI_RATE_LIMIT_CONFIG.windowSeconds * 1000);\r\n    const { maxRequests } = AI_RATE_LIMIT_CONFIG;\r\n\r\n    try {\r\n        const client = getRedisClient();\r\n\r\n        // ‚úÖ Fail-open: Si Redis indisponible, autoriser\r\n        if (!client) {\r\n            console.warn('‚ö†Ô∏è Redis unavailable. AI rate limit bypassed (fail-open).');\r\n            return {\r\n                allowed: true,\r\n                remaining: maxRequests,\r\n                resetAt: new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000),\r\n            };\r\n        }\r\n\r\n        // D√©terminer la strat√©gie (ZSET ou String/JSON)\r\n        const isUpstash = !!process.env.UPSTASH_REDIS_REST_URL;\r\n        const supportsZSET = !isUpstash; // ioredis supporte ZSET nativement\r\n\r\n        if (supportsZSET) {\r\n            return await checkWithZSET(client, key, now, windowStart, maxRequests);\r\n        } else {\r\n            return await checkWithStringFallback(key, now, windowStart, maxRequests);\r\n        }\r\n    } catch (error) {\r\n        // ‚úÖ Fail-open: En cas d'erreur, autoriser mais logger\r\n        console.error('‚ùå AI Rate Limit error (fail-open):', error);\r\n        return {\r\n            allowed: true,\r\n            remaining: maxRequests,\r\n            resetAt: new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000),\r\n            error: 'Rate limit check failed (allowed by default)',\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Strat√©gie ZSET (Atomic) - Recommand√©e pour ioredis\r\n * \r\n * Op√©rations:\r\n * 1. ZREMRANGEBYSCORE - Nettoyer timestamps expir√©s\r\n * 2. ZCARD - Compter appels dans fen√™tre\r\n * 3. ZADD - Ajouter nouveau timestamp si autoris√©\r\n * 4. EXPIRE - Auto-nettoyage apr√®s 1h\r\n */\r\nasync function checkWithZSET(\r\n    client: any,\r\n    key: string,\r\n    now: number,\r\n    windowStart: number,\r\n    maxRequests: number\r\n): Promise<RateLimitResult> {\r\n    // 1. Nettoyer les vieux timestamps (hors fen√™tre)\r\n    await client.zremrangebyscore(key, '-inf', windowStart);\r\n\r\n    // 2. Compter les appels dans la fen√™tre\r\n    const count = await client.zcard(key);\r\n\r\n    // 3. V√©rifier la limite\r\n    if (count >= maxRequests) {\r\n        // Bloquer: limite atteinte\r\n        const oldestTimestamp = await client.zrange(key, 0, 0, 'WITHSCORES');\r\n        const resetAt = oldestTimestamp[1]\r\n            ? new Date(parseInt(oldestTimestamp[1]) + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000)\r\n            : new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000);\r\n\r\n        console.warn(`‚ö†Ô∏è AI Rate limit exceeded for team ${key.replace(REDIS_KEY_PREFIX, '')} (${count}/${maxRequests})`);\r\n\r\n        return {\r\n            allowed: false,\r\n            remaining: 0,\r\n            resetAt,\r\n            error: `Limite d'appels IA atteinte (${count}/${maxRequests})`,\r\n        };\r\n    }\r\n\r\n    // 4. Autoriser: ajouter le timestamp actuel\r\n    const uniqueId = `${now}-${Math.random().toString(36).substring(7)}`;\r\n    await client.zadd(key, now, uniqueId);\r\n\r\n    // 5. D√©finir expiration (auto-cleanup apr√®s 1h)\r\n    await client.expire(key, AI_RATE_LIMIT_CONFIG.windowSeconds);\r\n\r\n    console.log(`‚úÖ AI call allowed (${count + 1}/${maxRequests}) for team ${key.replace(REDIS_KEY_PREFIX, '')}`);\r\n\r\n    return {\r\n        allowed: true,\r\n        remaining: maxRequests - count - 1,\r\n        resetAt: new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000),\r\n    };\r\n}\r\n\r\n/**\r\n * Strat√©gie String/JSON (Fallback) - Pour Upstash ou environnements limit√©s\r\n * \r\n * Note: Pas atomique, potentielle race condition, mais acceptable pour faible volume\r\n */\r\nasync function checkWithStringFallback(\r\n    key: string,\r\n    now: number,\r\n    windowStart: number,\r\n    maxRequests: number\r\n): Promise<RateLimitResult> {\r\n    // 1. R√©cup√©rer les timestamps existants\r\n    const raw = await redis.get(key);\r\n    const timestamps = raw ? JSON.parse(raw) : [];\r\n\r\n    // 2. Filtrer les timestamps dans la fen√™tre\r\n    const validTimestamps = timestamps.filter((ts: number) => ts > windowStart);\r\n\r\n    // 3. V√©rifier la limite\r\n    if (validTimestamps.length >= maxRequests) {\r\n        const resetAt = new Date(Math.min(...validTimestamps) + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000);\r\n\r\n        console.warn(`‚ö†Ô∏è AI Rate limit exceeded (fallback) for ${key.replace(REDIS_KEY_PREFIX, '')} (${validTimestamps.length}/${maxRequests})`);\r\n\r\n        return {\r\n            allowed: false,\r\n            remaining: 0,\r\n            resetAt,\r\n            error: `Limite d'appels IA atteinte (${validTimestamps.length}/${maxRequests})`,\r\n        };\r\n    }\r\n\r\n    // 4. Autoriser: ajouter timestamp actuel\r\n    validTimestamps.push(now);\r\n    await redis.set(key, JSON.stringify(validTimestamps), AI_RATE_LIMIT_CONFIG.windowSeconds);\r\n\r\n    console.log(`‚úÖ AI call allowed (fallback) (${validTimestamps.length}/${maxRequests}) for ${key.replace(REDIS_KEY_PREFIX, '')}`);\r\n\r\n    return {\r\n        allowed: true,\r\n        remaining: maxRequests - validTimestamps.length,\r\n        resetAt: new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000),\r\n    };\r\n}\r\n\r\n/**\r\n * R√©initialise le rate limit pour une √©quipe (utile pour tests ou admin)\r\n */\r\nexport async function resetAIRateLimit(teamId: string): Promise<void> {\r\n    const key = `${REDIS_KEY_PREFIX}${teamId}`;\r\n    await redis.del(key);\r\n    console.log(`üîÑ AI rate limit reset for team ${teamId}`);\r\n}\r\n\r\n/**\r\n * R√©cup√®re le statut actuel du rate limit sans le modifier\r\n */\r\nexport async function getAIRateLimitStatus(teamId: string): Promise<{\r\n    count: number;\r\n    remaining: number;\r\n    resetAt: Date;\r\n}> {\r\n    const key = `${REDIS_KEY_PREFIX}${teamId}`;\r\n    const now = Date.now();\r\n    const windowStart = now - (AI_RATE_LIMIT_CONFIG.windowSeconds * 1000);\r\n    const { maxRequests } = AI_RATE_LIMIT_CONFIG;\r\n\r\n    try {\r\n        const client = getRedisClient();\r\n        if (!client) {\r\n            return {\r\n                count: 0,\r\n                remaining: maxRequests,\r\n                resetAt: new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000),\r\n            };\r\n        }\r\n\r\n        const isUpstash = !!process.env.UPSTASH_REDIS_REST_URL;\r\n\r\n        if (!isUpstash) {\r\n            // ZSET\r\n            await client.zremrangebyscore(key, '-inf', windowStart);\r\n            const count = await client.zcard(key);\r\n            return {\r\n                count,\r\n                remaining: Math.max(0, maxRequests - count),\r\n                resetAt: new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000),\r\n            };\r\n        } else {\r\n            // String/JSON\r\n            const raw = await redis.get(key);\r\n            const timestamps = raw ? JSON.parse(raw) : [];\r\n            const validTimestamps = timestamps.filter((ts: number) => ts > windowStart);\r\n            return {\r\n                count: validTimestamps.length,\r\n                remaining: Math.max(0, maxRequests - validTimestamps.length),\r\n                resetAt: new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000),\r\n            };\r\n        }\r\n    } catch (error) {\r\n        console.error('‚ùå Error getting rate limit status:', error);\r\n        return {\r\n            count: 0,\r\n            remaining: maxRequests,\r\n            resetAt: new Date(now + AI_RATE_LIMIT_CONFIG.windowSeconds * 1000),\r\n        };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\rate-limit\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\rate-limit\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\reminders-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":186,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":186,"endColumn":93,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[7269,7353],"text":"// @ts-expect-error - Le type sendEmail accepte cc mais TypeScript ne le voit pas toujours"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { SupabaseClient } from \"@supabase/supabase-js\";\nimport { differenceInDays } from \"date-fns\";\nimport { sendEmail } from \"@/lib/mail\";\n\n// Types\nexport interface ReminderResult {\n    count: number;\n    message: string;\n    errors?: Error[];\n}\n\n/**\n * Core logic to process reminders.\n * Accepts a Supabase client (either User scoped or Admin scoped).\n */\nexport async function internalProcessReminders(supabase: SupabaseClient): Promise<ReminderResult> {\n    console.log(\"üïµÔ∏è Recherche des impay√©s de +5 jours...\");\n\n    const today = new Date();\n\n    // Fetch ALL unpaid transactions that haven't been reminded yet\n    // We'll calculate the actual due date using billing_day and filter in code\n    // This ensures we respect the billing_day configured in the UI modal\n    const { data: transactions, error } = await supabase\n        .from(\"rental_transactions\")\n        .select(`\n      id,\n      amount_due,\n      status,\n      period_month,\n      period_year,\n      period_start,\n      reminder_sent,\n      leases (\n        id,\n        billing_day,\n        tenant_email,\n        tenant_name,\n        property_id,\n        owner_id\n      )\n    `)\n        .neq(\"status\", \"paid\") // Not paid\n        .eq(\"reminder_sent\", false) // Not reminded\n        // Only fetch recent transactions (current year and previous year)\n        .gte(\"period_year\", today.getFullYear() - 1);\n\n    if (error) {\n        console.error(\"Error fetching transactions:\", error);\n        return { count: 0, message: \"Erreur lors de la r√©cup√©ration des transactions.\", errors: [error] };\n    }\n\n    console.log(`Found ${transactions?.length || 0} candidate transactions from DB.`);\n\n    if (!transactions || transactions.length === 0) {\n        return { count: 0, message: \"Aucun paiement en retard d√©tect√©.\" };\n    }\n\n    let emailsSent = 0;\n    const errors: Error[] = [];\n\n    for (const tx of transactions) {\n        console.log(`Checking transaction ${tx.id}: Status=${tx.status}, Period=${tx.period_month}/${tx.period_year}`);\n\n        const lease = tx.leases;\n        // Handle case where lease might be an array or null\n        // Supabase can return array for relations depending on schema checks/client version\n        const leaseData = Array.isArray(lease) ? lease[0] : lease;\n\n        if (!leaseData) {\n            console.log(`-> Skipped: No lease data found.`);\n            continue;\n        }\n\n        const billingDay = leaseData.billing_day || 5;\n        const periodYear = tx.period_year;\n        const periodMonth = tx.period_month;\n\n        let dueDate: Date;\n        try {\n            // Month in Date constructor is 0-indexed (0=Jan, 11=Dec)\n            dueDate = new Date(periodYear, periodMonth - 1, billingDay);\n        } catch (e) {\n            console.warn(`-> Skipped: Invalid date for tx ${tx.id}`, e);\n            continue;\n        }\n\n        const daysOverdue = differenceInDays(today, dueDate);\n        console.log(`-> Due Date: ${dueDate.toISOString().split('T')[0]}, Days Overdue: ${daysOverdue}`);\n\n        // \"Relance Automatique J+5\": Trigger if 5 or more days have passed since due date.\n        if (daysOverdue >= 5) {\n            if (leaseData.tenant_email) {\n                try {\n                    // R√©cup√©rer l'email du propri√©taire\n                    let ownerEmail: string | undefined;\n                    if (leaseData.owner_id) {\n                        const { data: ownerData } = await supabase.auth.admin.getUserById(leaseData.owner_id);\n                        ownerEmail = ownerData?.user?.email;\n                    }\n\n                    await sendReminderEmail(\n                        leaseData.tenant_email,\n                        leaseData.tenant_name || \"Locataire\",\n                        tx.amount_due,\n                        dueDate,\n                        ownerEmail // Ajout du CC propri√©taire\n                    );\n\n                    const { error: updateError } = await supabase\n                        .from(\"rental_transactions\")\n                        .update({ reminder_sent: true })\n                        .eq(\"id\", tx.id);\n\n                    if (updateError) {\n                        console.error(`Failed to update tx ${tx.id}`, updateError);\n                        errors.push(updateError instanceof Error ? updateError : new Error(JSON.stringify(updateError)));\n                    } else {\n                        emailsSent++;\n                    }\n                } catch (err) {\n                    console.error(`Failed to send email to ${leaseData.tenant_email}`, err);\n                    errors.push(err instanceof Error ? err : new Error(String(err)));\n                }\n            }\n        }\n    }\n\n    return {\n        count: emailsSent,\n        message: `${emailsSent} relances envoy√©es avec succ√®s.`,\n        errors: errors.length > 0 ? errors : undefined\n    };\n}\n\n/**\n * Real Email Sender using project's existing mailer\n */\nasync function sendReminderEmail(email: string, name: string, amount: number, date: Date, ownerEmail?: string) {\n    const formattedDate = date.toLocaleDateString(\"fr-FR\", { year: 'numeric', month: 'long', day: 'numeric' });\n    const formattedAmount = amount.toLocaleString(\"fr-SN\");\n\n    const emailHtml = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <style>\n        body { font-family: sans-serif; line-height: 1.6; color: #333; }\n        .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n        .header { background-color: #f8f9fa; padding: 20px; text-align: center; border-bottom: 3px solid #dc3545; }\n        .content { padding: 30px 20px; }\n        .button { background-color: #dc3545; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-top: 15px; }\n        .footer { font-size: 12px; color: #666; text-align: center; margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px; }\n      </style>\n    </head>\n    <body>\n      <div class=\"container\">\n        <div class=\"header\">\n          <h2>Rappel de paiement</h2>\n        </div>\n        <div class=\"content\">\n          <p>Bonjour <strong>${name}</strong>,</p>\n          <p>Sauf erreur de notre part, nous n'avons pas encore re√ßu le r√®glement de votre loyer d'un montant de <strong>${formattedAmount} FCFA</strong>, dont l'√©ch√©ance √©tait le <strong>${formattedDate}</strong>.</p>\n          <p>Nous vous remercions de bien vouloir r√©gulariser votre situation dans les meilleurs d√©lais.</p>\n          <p>Si vous avez d√©j√† effectu√© ce paiement, merci de ne pas tenir compte de ce message.</p>\n        </div>\n        <div class=\"footer\">\n          <p>Ceci est un message automatique envoy√© par Doussel Immo.</p>\n          ${ownerEmail ? '<p style=\"color: #999; margin-top: 10px;\">Copie envoy√©e au propri√©taire pour information.</p>' : ''}\n        </div>\n      </div>\n    </body>\n    </html>\n  `;\n\n    console.log(`üìß Sending Late Reminder to: ${email}${ownerEmail ? ` (CC: ${ownerEmail})` : ''}`);\n\n    // Pr√©parer les destinataires\n    const recipients: string | string[] = email;\n    const ccRecipients: string[] | undefined = ownerEmail ? [ownerEmail] : undefined;\n\n    await sendEmail({\n        to: recipients,\n        subject: `Rappel : Retard de paiement - Loyer du ${formattedDate}`,\n        html: emailHtml,\n        // @ts-ignore - Le type sendEmail accepte cc mais TypeScript ne le voit pas toujours\n        cc: ccRecipients,\n    });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\safe-action.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2004,2007],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2004,2007],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { logger } from './logger';\r\nimport { contextStorage } from './context';\r\nimport { createClient } from '@/utils/supabase/server';\r\nimport { z } from 'zod';\r\n\r\nexport type ActionState<T> = {\r\n    data?: T;\r\n    error?: string;\r\n};\r\n\r\n/**\r\n * Wrapper for Server Actions to provide automatic logging, error handling, Zod validation, and context injection.\r\n */\r\nexport function safeAction<TIn, TOut>(\r\n    actionName: string,\r\n    schema: z.Schema<TIn>,\r\n    handler: (data: TIn, context: { userId?: string; teamId?: string; requestId: string }) => Promise<TOut>\r\n) {\r\n    return async (rawData: TIn): Promise<ActionState<TOut>> => {\r\n        const store = contextStorage.getStore();\r\n        const requestId = store?.requestId || 'internal-' + Math.random().toString(36).substring(7);\r\n\r\n        return await contextStorage.run({ ...store, requestId, action: actionName }, async () => {\r\n            try {\r\n                // 1. Validation Zod\r\n                const validation = schema.safeParse(rawData);\r\n                if (!validation.success) {\r\n                    const errorMessage = validation.error.issues[0].message;\r\n                    logger.warn({ action: actionName, error: errorMessage, validationErrors: validation.error.issues }, `Validation failed: ${actionName}`);\r\n                    return { error: errorMessage };\r\n                }\r\n                const data = validation.data;\r\n\r\n                const supabase = await createClient();\r\n                const { data: { user } } = await supabase.auth.getUser();\r\n\r\n                const userId = user?.id;\r\n                const teamId = store?.teamId;\r\n\r\n                logger.info({ action: actionName, userId, teamId }, `Action started: ${actionName}`);\r\n\r\n                const result = await handler(data, { userId, teamId, requestId });\r\n\r\n                logger.info({ action: actionName, userId, teamId }, `Action success: ${actionName}`);\r\n\r\n                return { data: result };\r\n            } catch (error: any) {\r\n                logger.error(\r\n                    {\r\n                        action: actionName,\r\n                        error: error.message,\r\n                        stack: process.env.NODE_ENV === 'development' ? error.stack : undefined\r\n                    },\r\n                    `Action failed: ${actionName}`\r\n                );\r\n\r\n                return { error: error.message || 'An unexpected error occurred' };\r\n            }\r\n        });\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\schemas\\propertySchema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\schemas\\visit-request.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\scroll-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\search-filters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\slugs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\store\\use-onboarding-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\stripe-rent.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[279,282],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[279,282],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Stripe from 'stripe';\r\n\r\n// Initialize Stripe\r\nconst stripeKey = process.env.STRIPE_SECRET_KEY;\r\n\r\nif (!stripeKey) {\r\n    console.warn('‚ö†Ô∏è STRIPE_SECRET_KEY is not defined');\r\n}\r\n\r\nexport const stripe = stripeKey ? new Stripe(stripeKey, {\r\n    apiVersion: '2024-06-20' as any,\r\n    typescript: true,\r\n}) : null;\r\n\r\n/**\r\n * Create a Stripe Checkout Session for rent payment\r\n */\r\nexport async function createRentCheckoutSession({\r\n    leaseId,\r\n    amount,\r\n    periodMonth,\r\n    periodYear,\r\n    tenantName,\r\n    tenantEmail,\r\n    propertyAddress,\r\n    successUrl,\r\n    cancelUrl,\r\n}: {\r\n    leaseId: string;\r\n    amount: number; // Amount in FCFA\r\n    periodMonth: number;\r\n    periodYear: number;\r\n    tenantName: string;\r\n    tenantEmail: string;\r\n    propertyAddress?: string;\r\n    successUrl: string;\r\n    cancelUrl: string;\r\n}) {\r\n    if (!stripe) {\r\n        throw new Error('Stripe is not configured');\r\n    }\r\n\r\n    // Convert FCFA to EUR (approximate rate: 1 EUR = 656 FCFA)\r\n    // For production, use a proper exchange rate API\r\n    const FCFA_TO_EUR_RATE = 656;\r\n    const amountInEur = Math.round((amount / FCFA_TO_EUR_RATE) * 100); // Stripe expects cents\r\n\r\n    const monthNames = [\r\n        'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\r\n        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'\r\n    ];\r\n    const periodLabel = `${monthNames[periodMonth - 1]} ${periodYear}`;\r\n\r\n    const session = await stripe.checkout.sessions.create({\r\n        payment_method_types: ['card'],\r\n        mode: 'payment',\r\n        customer_email: tenantEmail,\r\n        line_items: [\r\n            {\r\n                price_data: {\r\n                    currency: 'eur',\r\n                    product_data: {\r\n                        name: `Loyer ${periodLabel}`,\r\n                        description: propertyAddress\r\n                            ? `Paiement loyer - ${propertyAddress}`\r\n                            : `Paiement du loyer pour ${periodLabel}`,\r\n                        metadata: {\r\n                            lease_id: leaseId,\r\n                            period_month: periodMonth.toString(),\r\n                            period_year: periodYear.toString(),\r\n                        },\r\n                    },\r\n                    unit_amount: amountInEur,\r\n                },\r\n                quantity: 1,\r\n            },\r\n        ],\r\n        metadata: {\r\n            type: 'rent_payment',\r\n            lease_id: leaseId,\r\n            period_month: periodMonth.toString(),\r\n            period_year: periodYear.toString(),\r\n            amount_fcfa: amount.toString(),\r\n            tenant_name: tenantName,\r\n        },\r\n        success_url: successUrl,\r\n        cancel_url: cancelUrl,\r\n        locale: 'fr',\r\n    });\r\n\r\n    return {\r\n        sessionId: session.id,\r\n        url: session.url,\r\n    };\r\n}\r\n\r\n/**\r\n * Verify and process a completed Stripe payment\r\n */\r\nexport async function processStripeRentPayment(sessionId: string) {\r\n    if (!stripe) {\r\n        throw new Error('Stripe is not configured');\r\n    }\r\n\r\n    const session = await stripe.checkout.sessions.retrieve(sessionId, {\r\n        expand: ['payment_intent', 'payment_intent.latest_charge'],\r\n    });\r\n\r\n    if (session.payment_status !== 'paid') {\r\n        throw new Error('Payment not completed');\r\n    }\r\n\r\n    const metadata = session.metadata;\r\n    if (!metadata || metadata.type !== 'rent_payment') {\r\n        throw new Error('Invalid payment metadata');\r\n    }\r\n\r\n    // Extract card details from charge for traceability\r\n    const paymentIntent = typeof session.payment_intent === 'string'\r\n        ? null\r\n        : session.payment_intent;\r\n    const charge = paymentIntent?.latest_charge as Stripe.Charge | undefined;\r\n    const cardDetails = charge?.payment_method_details?.card;\r\n\r\n    const amountEurCents = session.amount_total || 0;\r\n    const amountFcfa = parseInt(metadata.amount_fcfa);\r\n\r\n    return {\r\n        leaseId: metadata.lease_id,\r\n        periodMonth: parseInt(metadata.period_month),\r\n        periodYear: parseInt(metadata.period_year),\r\n        amountFcfa,\r\n        tenantName: metadata.tenant_name,\r\n        paymentIntentId: paymentIntent?.id || (typeof session.payment_intent === 'string' ? session.payment_intent : undefined),\r\n        // Rich traceability metadata\r\n        traceMeta: {\r\n            provider: 'stripe',\r\n            stripe_session_id: sessionId,\r\n            stripe_payment_intent_id: paymentIntent?.id || null,\r\n            amount_eur_cents: amountEurCents,\r\n            amount_eur: amountEurCents / 100,\r\n            amount_fcfa: amountFcfa,\r\n            exchange_rate: amountFcfa > 0 && amountEurCents > 0\r\n                ? Math.round(amountFcfa / (amountEurCents / 100))\r\n                : 656,\r\n            card_brand: cardDetails?.brand || null,\r\n            card_last4: cardDetails?.last4 || null,\r\n            card_exp_month: cardDetails?.exp_month || null,\r\n            card_exp_year: cardDetails?.exp_year || null,\r\n            currency: 'eur',\r\n            paid_at: new Date().toISOString(),\r\n        },\r\n    };\r\n}\r\n\r\n/**\r\n * Handle Stripe webhook event for rent payments\r\n */\r\nexport async function handleRentWebhookEvent(event: Stripe.Event) {\r\n    switch (event.type) {\r\n        case 'checkout.session.completed': {\r\n            const session = event.data.object as Stripe.Checkout.Session;\r\n\r\n            // Only process rent payments\r\n            if (session.metadata?.type !== 'rent_payment') {\r\n                return { processed: false, reason: 'Not a rent payment' };\r\n            }\r\n\r\n            const paymentData = {\r\n                leaseId: session.metadata.lease_id,\r\n                periodMonth: parseInt(session.metadata.period_month),\r\n                periodYear: parseInt(session.metadata.period_year),\r\n                amountFcfa: parseInt(session.metadata.amount_fcfa),\r\n                tenantName: session.metadata.tenant_name,\r\n                stripeSessionId: session.id,\r\n                stripePaymentIntentId: typeof session.payment_intent === 'string'\r\n                    ? session.payment_intent\r\n                    : null,\r\n            };\r\n\r\n            return {\r\n                processed: true,\r\n                data: paymentData,\r\n            };\r\n        }\r\n\r\n        case 'payment_intent.payment_failed': {\r\n            const paymentIntent = event.data.object as Stripe.PaymentIntent;\r\n            console.error('Payment failed:', paymentIntent.id, paymentIntent.last_payment_error?.message);\r\n            return { processed: false, reason: 'Payment failed' };\r\n        }\r\n\r\n        default:\r\n            return { processed: false, reason: `Unhandled event type: ${event.type}` };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\subscription\\features.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\subscription\\gating.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\subscription\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\subscription\\plans-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\subscription\\stripe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\subscription\\team-subscription.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\subscription\\usage.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2382,2385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2382,2385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { stripe } from \"@/lib/subscription/stripe\";\r\nimport { supabaseAdmin } from \"@/lib/supabase-admin\"; // Utilise la version Admin !\r\n\r\n/**\r\n * Signale √† Stripe qu'une transaction Mobile Money a eu lieu.\r\n * Stripe ajoutera les frais (ex: 200 FCFA) √† la prochaine facture d'abonnement de l'agence.\r\n * \r\n * Cette fonction utilise le client Admin pour contourner la RLS car elle est g√©n√©ralement appel√©e\r\n * par un webhook ou une t√¢che de fond sans utilisateur connect√©.\r\n */\r\nexport async function reportMobileMoneyUsage(teamId: string, quantity: number = 1) {\r\n    try {\r\n        // 1. R√©cup√©rer l'ID d'abonnement via Supabase Admin (Bypass RLS)\r\n        const { data: team, error } = await supabaseAdmin\r\n            .from('teams')\r\n            .select('stripe_subscription_id')\r\n            .eq('id', teamId)\r\n            .single();\r\n\r\n        if (error || !team || !team.stripe_subscription_id) {\r\n            console.warn(`[Usage Warning] Agence ${teamId} introuvable ou sans abonnement.`);\r\n            return;\r\n        }\r\n\r\n        // 2. ID du prix \"Metered\" (Frais Mobile Money) d√©fini dans ton .env\r\n        const meteredPriceId = process.env.STRIPE_METERED_PRICE_ID;\r\n        if (!meteredPriceId) {\r\n            console.error(\"STRIPE_METERED_PRICE_ID manquant dans .env\");\r\n            return;\r\n        }\r\n\r\n        // 3. R√©cup√©rer l'abonnement Stripe\r\n        const subscription = await stripe.subscriptions.retrieve(team.stripe_subscription_id);\r\n\r\n        // 4. Trouver l'item correspondant au prix \"Metered\"\r\n        let subscriptionItemId = subscription.items.data.find(\r\n            (item) => item.price.id === meteredPriceId\r\n        )?.id;\r\n\r\n        // 5. Si l'item n'existe pas encore dans l'abonnement, on l'ajoute\r\n        if (!subscriptionItemId) {\r\n            try {\r\n                const updatedSubscriptionItem = await stripe.subscriptionItems.create({\r\n                    subscription: team.stripe_subscription_id,\r\n                    price: meteredPriceId,\r\n                });\r\n                subscriptionItemId = updatedSubscriptionItem.id;\r\n            } catch (addError) {\r\n                console.error(`[Usage Error] Impossible d'ajouter l'item metered pour ${teamId}:`, addError);\r\n                return;\r\n            }\r\n        }\r\n\r\n        // 6. Enregistrer l'usage (Incr√©menter le compteur)\r\n        await (stripe.subscriptionItems as any).createUsageRecord(\r\n            subscriptionItemId,\r\n            {\r\n                quantity: quantity,\r\n                timestamp: Math.floor(Date.now() / 1000),\r\n                action: 'increment',\r\n            }\r\n        );\r\n\r\n        console.log(`[Usage Success] +${quantity} transaction(s) factur√©e(s) √† l'agence ${teamId}`);\r\n\r\n    } catch (error) {\r\n        console.error(`[Usage Error] √âchec du report pour ${teamId}:`, error);\r\n        // Note: On ne bloque pas le user, mais on log l'erreur pour la r√©gularisation manuelle si besoin.\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\supabase-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\supabase-client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\team-context.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\team-permissions-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\team-permissions.server.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2570,2573],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2570,2573],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2723,2726],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2723,2726],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":132,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":132,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4572,4575],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4572,4575],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4709,4712],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4709,4712],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5071,5074],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5071,5074],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":146,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5206,5209],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5206,5209],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":212,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":212,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7751,7754],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7751,7754],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":213,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":213,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7821,7824],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7821,7824],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Fonctions serveur pour le syst√®me de permissions d'√©quipe\r\n * Dousell Immo - Gestion Locative SaaS\r\n * \r\n * CE FICHIER NE DOIT √äTRE IMPORT√â QUE DANS DES SERVER COMPONENTS OU SERVER ACTIONS\r\n */\r\n\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport type { TeamRole, UserTeamContext } from \"@/types/team\";\r\nimport { TEAM_PERMISSIONS, TEAM_ROLE_CONFIG, type TeamPermissionKey } from \"./team-permissions\";\r\n\r\n// =====================================================\r\n// FONCTIONS DE R√âCUP√âRATION\r\n// =====================================================\r\n\r\n/**\r\n * R√©cup√®re le contexte d'√©quipe de l'utilisateur connect√©\r\n * Si l'utilisateur n'a pas d'√©quipe, en cr√©e une personnelle automatiquement\r\n */\r\nexport async function getUserTeamContext(preferredTeamId?: string): Promise<UserTeamContext | null> {\r\n    const supabase = await createClient();\r\n\r\n    const {\r\n        data: { user },\r\n    } = await supabase.auth.getUser();\r\n\r\n    if (!user) return null;\r\n\r\n    // üÜï V√©rifier la pr√©f√©rence d'√©quipe active (cookie)\r\n    if (!preferredTeamId) {\r\n        const { getActiveTeamId } = await import(\"@/lib/team-switching\");\r\n        preferredTeamId = await getActiveTeamId() || undefined;\r\n    }\r\n\r\n    // Si une √©quipe pr√©f√©r√©e est d√©finie, la r√©cup√©rer en priorit√©\r\n    if (preferredTeamId) {\r\n        const { data: preferredMembership } = await supabase\r\n            .from(\"team_members\")\r\n            .select(\r\n                `\r\n        team_id,\r\n        role,\r\n        team:teams(\r\n          name, \r\n          slug,\r\n          subscription_status,\r\n          subscription_trial_ends_at,\r\n          subscription_tier\r\n        )\r\n      `\r\n            )\r\n            .eq(\"user_id\", user.id)\r\n            .eq(\"team_id\", preferredTeamId)\r\n            .eq(\"status\", \"active\")\r\n            .maybeSingle();\r\n\r\n        if (preferredMembership?.team) {\r\n            const teamData = preferredMembership.team;\r\n            const team = (Array.isArray(teamData) ? teamData[0] : teamData) as {\r\n                name: string;\r\n                slug: string;\r\n                subscription_status?: string;\r\n                subscription_trial_ends_at?: string;\r\n                subscription_tier?: string;\r\n            };\r\n\r\n            if (team) {\r\n                return {\r\n                    team_id: preferredMembership.team_id,\r\n                    team_name: team.name,\r\n                    team_slug: team.slug,\r\n                    user_role: preferredMembership.role as TeamRole,\r\n                    subscription_status: team.subscription_status as any,\r\n                    subscription_trial_ends_at: team.subscription_trial_ends_at,\r\n                    subscription_tier: team.subscription_tier as any,\r\n                };\r\n            }\r\n        }\r\n    }\r\n\r\n    // Utiliser la fonction RPC pour bypass RLS si n√©cessaire\r\n    const { data, error } = await supabase.rpc(\"get_user_team\", {\r\n        p_user_id: user.id,\r\n    });\r\n\r\n    if (error || !data || data.length === 0) {\r\n        // Fallback: requ√™te directe avec subscription_status\r\n        const { data: membership } = await supabase\r\n            .from(\"team_members\")\r\n            .select(\r\n                `\r\n        team_id,\r\n        role,\r\n        team:teams(\r\n          name, \r\n          slug,\r\n          subscription_status,\r\n          subscription_trial_ends_at,\r\n          subscription_tier\r\n        )\r\n      `\r\n            )\r\n            .eq(\"user_id\", user.id)\r\n            .eq(\"status\", \"active\")\r\n            .maybeSingle();\r\n\r\n        if (!membership?.team) {\r\n            // Pas d'√©quipe trouv√©e - retourner null\r\n            // La cr√©ation d'√©quipe se fait explicitement via createPersonalTeam()\r\n            // appel√© depuis auth-redirect.ts quand l'utilisateur a un selected_plan\r\n            console.log(`[getUserTeamContext] No team for user ${user.id}, returning null`);\r\n            return null;\r\n        }\r\n\r\n        const teamData = membership.team;\r\n        // Handle potential array return from Supabase\r\n        const team = (Array.isArray(teamData) ? teamData[0] : teamData) as {\r\n            name: string;\r\n            slug: string;\r\n            subscription_status?: string;\r\n            subscription_trial_ends_at?: string;\r\n            subscription_tier?: string;\r\n        };\r\n\r\n        if (!team) return null;\r\n\r\n        return {\r\n            team_id: membership.team_id,\r\n            team_name: team.name,\r\n            team_slug: team.slug,\r\n            user_role: membership.role as TeamRole,\r\n            subscription_status: team.subscription_status as any,\r\n            subscription_trial_ends_at: team.subscription_trial_ends_at,\r\n            subscription_tier: team.subscription_tier as any,\r\n        };\r\n    }\r\n\r\n    // ‚úÖ AM√âLIORATION: Inclure subscription dans le contexte (√©vite un appel DB suppl√©mentaire)\r\n    return {\r\n        team_id: data[0].team_id,\r\n        team_name: data[0].team_name,\r\n        team_slug: data[0].team_slug,\r\n        user_role: data[0].user_role as TeamRole,\r\n        subscription_status: data[0].subscription_status as any,\r\n        subscription_trial_ends_at: data[0].subscription_trial_ends_at,\r\n        subscription_tier: data[0].subscription_tier as any,\r\n    };\r\n}\r\n\r\n/**\r\n * Cr√©e une √©quipe personnelle pour un utilisateur qui n'en a pas.\r\n * Appel√© explicitement depuis auth-redirect.ts quand l'utilisateur a un selected_plan,\r\n * ou depuis /pro/start quand l'utilisateur active manuellement son essai.\r\n */\r\nexport async function createPersonalTeam(userId: string, userEmail: string, metadata?: Record<string, unknown>): Promise<UserTeamContext | null> {\r\n    const supabase = await createClient();\r\n\r\n    // G√©n√©rer un slug unique\r\n    const slug = `perso-${userId.substring(0, 8)}`;\r\n    const userName = userEmail.split(\"@\")[0] || \"Utilisateur\";\r\n    const teamName = `Espace de ${userName}`;\r\n\r\n    // Extraire le plan des m√©tadonn√©es (inscrit via signup)\r\n    const selectedPlan = metadata?.selected_plan || \"starter\";\r\n    const trialDays = 14;\r\n    const trialEndsAt = new Date();\r\n    trialEndsAt.setDate(trialEndsAt.getDate() + trialDays);\r\n\r\n    try {\r\n        // Cr√©er l'√©quipe avec le plan initial\r\n        const { data: newTeam, error: teamError } = await supabase\r\n            .from(\"teams\")\r\n            .insert({\r\n                name: teamName,\r\n                slug,\r\n                subscription_tier: selectedPlan,\r\n                subscription_status: 'trial',\r\n                subscription_trial_ends_at: trialEndsAt.toISOString()\r\n            })\r\n            .select(\"id, name, slug, subscription_tier, subscription_status, subscription_trial_ends_at\")\r\n            .single();\r\n\r\n        if (teamError || !newTeam) {\r\n            console.error(\"[Auto-Team] Failed to create team:\", teamError?.message);\r\n            return null;\r\n        }\r\n\r\n        // Ajouter l'utilisateur comme owner\r\n        const { error: memberError } = await supabase\r\n            .from(\"team_members\")\r\n            .insert({\r\n                user_id: userId,\r\n                team_id: newTeam.id,\r\n                role: \"owner\",\r\n                status: \"active\",\r\n            });\r\n\r\n        if (memberError) {\r\n            console.error(\"[Auto-Team] Failed to add member:\", memberError.message);\r\n            // Rollback: supprimer l'√©quipe cr√©√©e\r\n            await supabase.from(\"teams\").delete().eq(\"id\", newTeam.id);\r\n            return null;\r\n        }\r\n\r\n        console.log(`[Auto-Team] Successfully created team \"${teamName}\" for user ${userId}`);\r\n\r\n        return {\r\n            team_id: newTeam.id,\r\n            team_name: newTeam.name,\r\n            team_slug: newTeam.slug,\r\n            user_role: \"owner\" as TeamRole,\r\n            subscription_tier: newTeam.subscription_tier as any,\r\n            subscription_status: newTeam.subscription_status as any,\r\n            subscription_trial_ends_at: newTeam.subscription_trial_ends_at,\r\n        };\r\n    } catch (err) {\r\n        console.error(\"[Auto-Team] Unexpected error:\", err);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * R√©cup√®re le membership d'un utilisateur dans une √©quipe\r\n * Utilise une fonction RPC SECURITY DEFINER pour bypass RLS\r\n */\r\nexport async function getTeamMembership(\r\n    teamId: string,\r\n    userId?: string\r\n): Promise<{\r\n    role: TeamRole;\r\n    permissions: TeamPermissionKey[];\r\n    customPermissions: Record<string, boolean>;\r\n} | null> {\r\n    const supabase = await createClient();\r\n\r\n    if (!userId) {\r\n        const {\r\n            data: { user },\r\n        } = await supabase.auth.getUser();\r\n        if (!user) return null;\r\n        userId = user.id;\r\n    }\r\n\r\n    // Essayer d'abord avec la fonction RPC (bypass RLS)\r\n    const { data: roleData, error: rpcError } = await supabase.rpc(\"get_user_role_in_team\", {\r\n        p_team_id: teamId,\r\n        p_user_id: userId,\r\n    });\r\n\r\n    if (!rpcError && roleData) {\r\n        const role = roleData as TeamRole;\r\n\r\n        // Calculer les permissions effectives\r\n        const permissions = Object.entries(TEAM_PERMISSIONS)\r\n            .filter(([, roles]) => (roles as readonly string[]).includes(role))\r\n            .map(([key]) => key as TeamPermissionKey);\r\n\r\n        return {\r\n            role,\r\n            permissions,\r\n            customPermissions: {},\r\n        };\r\n    }\r\n\r\n    // Fallback: requ√™te directe (peut √©chouer avec RLS strict)\r\n    const { data, error } = await supabase\r\n        .from(\"team_members\")\r\n        .select(\"role, custom_permissions, status\")\r\n        .eq(\"team_id\", teamId)\r\n        .eq(\"user_id\", userId)\r\n        .single();\r\n\r\n    if (error || !data || data.status !== \"active\") {\r\n        console.log(\"getTeamMembership fallback failed:\", error?.message || \"No data\");\r\n        return null;\r\n    }\r\n\r\n    const role = data.role as TeamRole;\r\n\r\n    // Calculer les permissions effectives\r\n    const permissions = Object.entries(TEAM_PERMISSIONS)\r\n        .filter(([, roles]) => (roles as readonly string[]).includes(role))\r\n        .map(([key]) => key as TeamPermissionKey);\r\n\r\n    return {\r\n        role,\r\n        permissions,\r\n        customPermissions: (data.custom_permissions as Record<string, boolean>) || {},\r\n    };\r\n}\r\n\r\n// =====================================================\r\n// FONCTIONS DE V√âRIFICATION\r\n// =====================================================\r\n\r\n/**\r\n * V√©rifie si l'utilisateur a une permission sp√©cifique dans une √©quipe\r\n */\r\nexport async function hasTeamPermission(\r\n    teamId: string,\r\n    permission: TeamPermissionKey\r\n): Promise<boolean> {\r\n    const membership = await getTeamMembership(teamId);\r\n    if (!membership) return false;\r\n\r\n    // V√©rifier permissions custom d'abord\r\n    if (permission in membership.customPermissions) {\r\n        return membership.customPermissions[permission];\r\n    }\r\n\r\n    return membership.permissions.includes(permission);\r\n}\r\n\r\n/**\r\n * V√©rifie si l'utilisateur a un r√¥le sp√©cifique\r\n */\r\nexport async function hasTeamRole(\r\n    teamId: string,\r\n    roles: TeamRole | TeamRole[]\r\n): Promise<boolean> {\r\n    const membership = await getTeamMembership(teamId);\r\n    if (!membership) return false;\r\n\r\n    const allowedRoles = Array.isArray(roles) ? roles : [roles];\r\n    return allowedRoles.includes(membership.role);\r\n}\r\n\r\n/**\r\n * Guard pour Server Actions - v√©rifie permission et retourne erreur format√©e\r\n */\r\nexport async function requireTeamPermission(\r\n    teamId: string,\r\n    permission: TeamPermissionKey\r\n): Promise<\r\n    | { success: false; error: string }\r\n    | {\r\n        success: true;\r\n        membership: NonNullable<Awaited<ReturnType<typeof getTeamMembership>>>;\r\n        userId: string;\r\n    }\r\n> {\r\n    const supabase = await createClient();\r\n    const {\r\n        data: { user },\r\n    } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non connect√©\" };\r\n    }\r\n\r\n    const membership = await getTeamMembership(teamId, user.id);\r\n\r\n    if (!membership) {\r\n        return { success: false, error: \"Vous n'√™tes pas membre de cette √©quipe\" };\r\n    }\r\n\r\n    const hasPermission = await hasTeamPermission(teamId, permission);\r\n\r\n    if (!hasPermission) {\r\n        return {\r\n            success: false,\r\n            error: `Permission refus√©e. Votre r√¥le (${TEAM_ROLE_CONFIG[membership.role].label}) ne permet pas cette action.`,\r\n        };\r\n    }\r\n\r\n    return { success: true, membership, userId: user.id };\r\n}\r\n\r\n/**\r\n * Guard pour v√©rifier un r√¥le minimum\r\n */\r\nexport async function requireTeamRole(\r\n    teamId: string,\r\n    allowedRoles: TeamRole[]\r\n): Promise<\r\n    | { success: false; error: string }\r\n    | { success: true; role: TeamRole; userId: string }\r\n> {\r\n    const supabase = await createClient();\r\n    const {\r\n        data: { user },\r\n    } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return { success: false, error: \"Non connect√©\" };\r\n    }\r\n\r\n    const membership = await getTeamMembership(teamId, user.id);\r\n\r\n    if (!membership) {\r\n        return { success: false, error: \"Vous n'√™tes pas membre de cette √©quipe\" };\r\n    }\r\n\r\n    if (!allowedRoles.includes(membership.role)) {\r\n        const allowedLabels = allowedRoles\r\n            .map((r) => TEAM_ROLE_CONFIG[r].label)\r\n            .join(\", \");\r\n        return {\r\n            success: false,\r\n            error: `Cette action n√©cessite l'un des r√¥les suivants : ${allowedLabels}`,\r\n        };\r\n    }\r\n\r\n    return { success: true, role: membership.role, userId: user.id };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\team-permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\team-switching.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\tenant-magic-link.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\turnstile.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\unread-counts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\my-video\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\my-video\\postcss.config.mjs","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":1,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":5,"endColumn":3}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export default {\n  plugins: {\n    \"@tailwindcss/postcss\": {},\n  },\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\my-video\\remotion.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\my-video\\src\\Composition.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\my-video\\src\\Root.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\my-video\\src\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\next.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\playwright.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\public\\OneSignalSDK.sw.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\public\\OneSignalSDKUpdaterWorker.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\public\\OneSignalSDKWorker.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\public\\sw.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\report_lint.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst lintJsonPath = path.join(__dirname, 'lint_errors_v6.json');\r\nconst data = JSON.parse(fs.readFileSync(lintJsonPath, 'utf8'));\r\n\r\nconst ruleCounts = {};\r\nlet totalErrors = 0;\r\n\r\ndata.forEach(result => {\r\n    result.messages.forEach(msg => {\r\n        const ruleId = msg.ruleId || 'unknown';\r\n        ruleCounts[ruleId] = (ruleCounts[ruleId] || 0) + 1;\r\n        totalErrors++;\r\n    });\r\n});\r\n\r\nconsole.log(`Total Errors: ${totalErrors}`);\r\nconsole.log('Rule Counts:');\r\nObject.entries(ruleCounts)\r\n    .sort((a, b) => b[1] - a[1])\r\n    .forEach(([rule, count]) => {\r\n        console.log(`${rule}: ${count}`);\r\n    });\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\add-amount-paid-column.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\add-end-date-column.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3576,3579],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3576,3579],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script: Ajouter la colonne end_date √† la table leases\n * Requis pour les alertes de fin de bail (J-180 et J-90)\n */\n\nimport { createClient } from '@supabase/supabase-js';\nimport dotenv from 'dotenv';\n\n// Charger les variables d'environnement\ndotenv.config({ path: '.env.local' });\n\nconst SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nasync function addEndDateColumn() {\n    console.log('üîß Ajout de la colonne end_date √† la table leases...');\n\n    const supabase = createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {\n        auth: {\n            autoRefreshToken: false,\n            persistSession: false\n        }\n    });\n\n    try {\n        // 1. Ajouter la colonne end_date\n        const { error: alterError } = await supabase.rpc('exec_sql', {\n            query: `\n                ALTER TABLE leases\n                ADD COLUMN IF NOT EXISTS end_date DATE;\n\n                COMMENT ON COLUMN leases.end_date IS 'Date de fin pr√©vue du bail. Utilis√©e pour les alertes J-180 (6 mois) et J-90 (3 mois) conform√©ment au droit s√©n√©galais.';\n            `\n        });\n\n        if (alterError) {\n            // Si la fonction RPC n'existe pas, on utilise une approche alternative\n            console.log('‚ö†Ô∏è  La fonction RPC exec_sql n\\'existe pas. Utilisation d\\'une approche alternative...');\n\n            // V√©rifier si la colonne existe d√©j√†\n            const { data: _columns, error: checkError } = await supabase\n                .from('leases')\n                .select('*')\n                .limit(1);\n\n            if (checkError) {\n                throw new Error(`Erreur lors de la v√©rification: ${checkError.message}`);\n            }\n\n            console.log('‚úÖ La table leases est accessible.');\n            console.log('‚ÑπÔ∏è  Veuillez ex√©cuter manuellement cette commande SQL dans l\\'√©diteur Supabase:');\n            console.log('\\n--- SQL √† ex√©cuter ---');\n            console.log(`\nALTER TABLE leases\nADD COLUMN IF NOT EXISTS end_date DATE;\n\nCOMMENT ON COLUMN leases.end_date IS 'Date de fin pr√©vue du bail. Utilis√©e pour les alertes J-180 (6 mois) et J-90 (3 mois) conform√©ment au droit s√©n√©galais.';\n\nCREATE INDEX IF NOT EXISTS idx_leases_end_date_status\nON leases(end_date, status)\nWHERE status = 'active' AND end_date IS NOT NULL;\n            `);\n            console.log('----------------------\\n');\n\n            return;\n        }\n\n        // 2. Cr√©er l'index\n        const { error: indexError } = await supabase.rpc('exec_sql', {\n            query: `\n                CREATE INDEX IF NOT EXISTS idx_leases_end_date_status\n                ON leases(end_date, status)\n                WHERE status = 'active' AND end_date IS NOT NULL;\n            `\n        });\n\n        if (indexError) {\n            console.warn('‚ö†Ô∏è  Impossible de cr√©er l\\'index (peut d√©j√† exister)');\n        }\n\n        console.log('‚úÖ Colonne end_date ajout√©e avec succ√®s !');\n\n        // 3. V√©rifier les baux existants\n        const { data: leases, error: leasesError } = await supabase\n            .from('leases')\n            .select('id, tenant_name, end_date')\n            .eq('status', 'active')\n            .limit(5);\n\n        if (leasesError) {\n            console.error('‚ùå Erreur lors de la v√©rification des baux:', leasesError.message);\n        } else {\n            console.log(`\\nüìã ${leases?.length || 0} baux actifs trouv√©s (aper√ßu)`);\n            if (leases && leases.length > 0) {\n                console.log('‚ÑπÔ∏è  Pensez √† d√©finir une end_date pour vos baux actifs.');\n            }\n        }\n\n    } catch (error: any) {\n        console.error('‚ùå Erreur:', error.message);\n        process.exit(1);\n    }\n}\n\naddEndDateColumn();\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\apply-storage-policies.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\archive\\apply-email-verification-migration.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\archive\\apply-migration-end-date.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":93,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3389,3392],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3389,3392],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour appliquer la migration end_date directement\n * Usage: npx tsx scripts/apply-migration-end-date.ts\n */\n\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error('‚ùå Variables d\\'environnement manquantes');\n  console.error('Assurez-vous que NEXT_PUBLIC_SUPABASE_URL et SUPABASE_SERVICE_ROLE_KEY sont d√©finis');\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function applyMigration() {\n  console.log('üîß Application de la migration end_date...\\n');\n\n  try {\n    // 1. Ajouter la colonne end_date\n    console.log('1Ô∏è‚É£ Ajout de la colonne end_date...');\n    const { error: alterError } = await supabase.rpc('exec_sql', {\n      sql: `\n        ALTER TABLE leases\n        ADD COLUMN IF NOT EXISTS end_date DATE;\n\n        COMMENT ON COLUMN leases.end_date IS 'Date de fin pr√©vue du bail. Utilis√©e pour les alertes J-180 (6 mois) et J-90 (3 mois) conform√©ment au droit s√©n√©galais.';\n      `\n    });\n\n    if (alterError && !alterError.message?.includes('already exists')) {\n      throw alterError;\n    }\n    console.log('‚úÖ Colonne end_date ajout√©e\\n');\n\n    // 2. Cr√©er l'index\n    console.log('2Ô∏è‚É£ Cr√©ation de l\\'index...');\n    const { error: indexError } = await supabase.rpc('exec_sql', {\n      sql: `\n        CREATE INDEX IF NOT EXISTS idx_leases_end_date_status\n        ON leases(end_date, status)\n        WHERE status = 'active' AND end_date IS NOT NULL;\n      `\n    });\n\n    if (indexError && !indexError.message?.includes('already exists')) {\n      throw indexError;\n    }\n    console.log('‚úÖ Index cr√©√©\\n');\n\n    // 3. V√©rifier que la colonne existe\n    console.log('3Ô∏è‚É£ V√©rification...');\n    const { data: columns, error: checkError } = await supabase\n      .from('information_schema.columns')\n      .select('column_name, data_type')\n      .eq('table_name', 'leases')\n      .eq('column_name', 'end_date');\n\n    if (checkError) {\n      console.warn('‚ö†Ô∏è  Impossible de v√©rifier (pas grave):', checkError.message);\n    } else if (columns && columns.length > 0) {\n      console.log('‚úÖ Colonne confirm√©e:', columns[0]);\n    }\n\n    // 4. Remplir automatiquement les end_date (dur√©e par d√©faut: 2 ans)\n    console.log('\\n4Ô∏è‚É£ Calcul automatique des dates de fin (2 ans par d√©faut)...');\n    const { data: _updated, error: updateError } = await supabase.rpc('exec_sql', {\n      sql: `\n        UPDATE leases\n        SET end_date = start_date + INTERVAL '2 years'\n        WHERE end_date IS NULL\n          AND start_date IS NOT NULL\n          AND status = 'active';\n      `\n    });\n\n    if (updateError && !updateError.message?.includes('not found')) {\n      console.warn('‚ö†Ô∏è  Mise √† jour automatique √©chou√©e (normal si pas de fonction exec_sql)');\n      console.log('   Vous devrez remplir manuellement via le formulaire ou SQL Editor');\n    } else {\n      console.log('‚úÖ Dates de fin calcul√©es automatiquement\\n');\n    }\n\n    console.log('\\nüéâ Migration termin√©e avec succ√®s!\\n');\n    console.log('üìù Prochaines √©tapes:');\n    console.log('   1. V√©rifier dans Supabase Dashboard ‚Üí Table leases');\n    console.log('   2. Remplir les end_date manquantes via le formulaire');\n    console.log('   3. Tester l\\'Assistant Juridique\\n');\n\n  } catch (error: any) {\n    console.error('\\n‚ùå Erreur lors de la migration:', error.message);\n    console.error('\\nüí° Solution alternative:');\n    console.error('   Ouvrir Supabase Dashboard ‚Üí SQL Editor');\n    console.error('   Copier le contenu de: scripts/apply-end-date-migration.sql');\n    console.error('   Ex√©cuter le script manuellement\\n');\n    process.exit(1);\n  }\n}\n\napplyMigration();\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\archive\\apply-rental-migration.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\archive\\execute-migration-v4-5.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\audit-existing-data.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[831,834],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[831,834],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@supabase/supabase-js\";\r\nimport * as dotenv from \"dotenv\";\r\nimport { format, startOfMonth, endOfMonth, eachMonthOfInterval, subMonths } from \"date-fns\";\r\n\r\ndotenv.config({ path: \".env.local\" });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nif (!supabaseUrl || !supabaseServiceRoleKey) {\r\n    console.error(\"Missing Supabase credentials in environment variables.\");\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceRoleKey, {\r\n    auth: { autoRefreshToken: false, persistSession: false },\r\n});\r\n\r\nasync function audit(teamId?: string) {\r\n    console.log(`üîç D√©marrage de l'audit financier... ${teamId ? `(√âquipe: ${teamId})` : \"(Toutes les √©quipes)\"}`);\r\n\r\n    const report: any = {\r\n        timestamp: new Date().toISOString(),\r\n        team_id: teamId || \"all\",\r\n        readyForMigration: true,\r\n        recommendations: [],\r\n    };\r\n\r\n    try {\r\n        // 1. Comptage global\r\n        const qProps = supabase.from(\"properties\").select(\"*\", { count: \"exact\", head: true });\r\n        const qLeases = supabase.from(\"leases\").select(\"*\", { count: \"exact\", head: true });\r\n        const qExpenses = supabase.from(\"expenses\").select(\"*\", { count: \"exact\", head: true });\r\n        const qTrans = supabase.from(\"rental_transactions\").select(\"*\", { count: \"exact\", head: true });\r\n\r\n        if (teamId) {\r\n            qProps.eq(\"team_id\", teamId);\r\n            qLeases.eq(\"team_id\", teamId);\r\n            // Expenses & Transactions don't have team_id yet (that's why we audit!)\r\n            // But we can filter by owner_id if we have it from team_members\r\n            const { data: members } = await supabase.from(\"team_members\").select(\"user_id\").eq(\"team_id\", teamId);\r\n            const userIds = members?.map(m => m.user_id) || [];\r\n            qExpenses.in(\"owner_id\", userIds);\r\n            // rental_transactions doesn't have owner_id directly, usually linked via lease\r\n        }\r\n\r\n        const [rProps, rLeases, rExpenses, rTrans] = await Promise.all([qProps, qLeases, qExpenses, qTrans]);\r\n\r\n        report.propertiesCount = rProps.count || 0;\r\n        report.leasesCount = rLeases.count || 0;\r\n        report.expensesCount = rExpenses.count || 0;\r\n        report.transactionsCount = rTrans.count || 0;\r\n\r\n        // 2. D√©tection des orphelins (D√©penses sans lease_id)\r\n        const qOrphans = supabase.from(\"expenses\").select(\"id, amount, description, created_at, owner_id\").is(\"lease_id\", null);\r\n        if (teamId) {\r\n            const { data: members } = await supabase.from(\"team_members\").select(\"user_id\").eq(\"team_id\", teamId);\r\n            const userIds = members?.map(m => m.user_id) || [];\r\n            qOrphans.in(\"owner_id\", userIds);\r\n        }\r\n        const { data: orphans } = await qOrphans;\r\n\r\n        report.orphanExpenses = {\r\n            count: orphans?.length || 0,\r\n            details: orphans || [],\r\n        };\r\n\r\n        if (report.orphanExpenses.count > 0) {\r\n            report.recommendations.push(`‚ö†Ô∏è ${report.orphanExpenses.count} d√©penses orphelines d√©tect√©es (√† lier ou envoyer en Caisse G√©n√©rale).`);\r\n        }\r\n\r\n        // 3. D√©tection des devises mixtes\r\n        // On va scanner les baux pour voir les devises\r\n        const { data: currencies } = await supabase.from(\"leases\").select(\"currency\");\r\n        const mix: Record<string, number> = {};\r\n        currencies?.forEach(l => {\r\n            const c = l.currency || \"FCFA\";\r\n            mix[c] = (mix[c] || 0) + 1;\r\n        });\r\n        report.currencyMix = mix;\r\n\r\n        const currencyTypes = Object.keys(mix);\r\n        if (currencyTypes.length > 1) {\r\n            report.recommendations.push(`‚ÑπÔ∏è Devises mixtes d√©tect√©es (${currencyTypes.join(\", \")}). Conversion n√©cessaire lors de la migration.`);\r\n        }\r\n\r\n        // 4. D√©tection des mois d√©ficitaires (Cashflow vs Performance)\r\n        // On analyse les 6 derniers mois\r\n        const now = new Date();\r\n        const interval = eachMonthOfInterval({\r\n            start: subMonths(now, 5),\r\n            end: now\r\n        });\r\n\r\n        const deficitMonths = [];\r\n\r\n        for (const monthDate of interval) {\r\n            const start = startOfMonth(monthDate).toISOString();\r\n            const end = endOfMonth(monthDate).toISOString();\r\n            const monthLabel = format(monthDate, \"yyyy-MM\");\r\n\r\n            // Actual Profit (Cashflow): Somme des transactions 'paid' ce mois-ci\r\n            // Note: rental_transactions a period_month/period_year\r\n            const m = monthDate.getMonth() + 1;\r\n            const y = monthDate.getFullYear();\r\n\r\n            const { data: paidTrans } = await supabase\r\n                .from(\"rental_transactions\")\r\n                .select(\"amount_due\") // Fallback on due if paid amount not clear\r\n                .eq(\"status\", \"paid\")\r\n                .eq(\"period_month\", m)\r\n                .eq(\"period_year\", y);\r\n\r\n            const actualRevenue = paidTrans?.reduce((sum, t) => sum + (t.amount_due || 0), 0) || 0;\r\n\r\n            // Projected Profit: Somme des monthly_amount de baux actifs\r\n            const { data: activeLeases } = await supabase\r\n                .from(\"leases\")\r\n                .select(\"monthly_amount\")\r\n                .eq(\"status\", \"active\")\r\n                .lte(\"start_date\", end);\r\n            // .or(`end_date.is.null,end_date.gte.${start}`); // Simplified filter for audit\r\n\r\n            const projectedRevenue = activeLeases?.reduce((sum, l) => sum + (l.monthly_amount || 0), 0) || 0;\r\n\r\n            // D√©penses du mois\r\n            const { data: monthExpenses } = await supabase\r\n                .from(\"expenses\")\r\n                .select(\"amount\")\r\n                .gte(\"expense_date\", start)\r\n                .lte(\"expense_date\", end);\r\n\r\n            const actualExpenses = monthExpenses?.reduce((sum, e) => sum + (e.amount || 0), 0) || 0;\r\n\r\n            const actualProfit = actualRevenue - actualExpenses;\r\n            const projectedProfit = projectedRevenue - actualExpenses;\r\n\r\n            if (actualProfit < 0) {\r\n                deficitMonths.push({\r\n                    month: monthLabel,\r\n                    actualProfit,\r\n                    projectedProfit,\r\n                    isTemporaryDebt: projectedProfit > 0 && actualProfit < 0\r\n                });\r\n            }\r\n        }\r\n\r\n        report.deficitMonths = deficitMonths;\r\n        if (deficitMonths.some(m => m.isTemporaryDebt)) {\r\n            report.recommendations.push(`‚úÖ Dettes temporaires d√©tect√©es : loyers en attente couvrant les d√©penses.`);\r\n        }\r\n\r\n        console.log(\"\\nüìä RAPPORT D'AUDIT FINANCIER\");\r\n        console.log(\"===========================\");\r\n        console.log(JSON.stringify(report, null, 2));\r\n        console.log(\"===========================\\n\");\r\n\r\n    } catch (err) {\r\n        console.error(\"‚ùå Erreur lors de l'audit:\", err);\r\n        report.readyForMigration = false;\r\n    }\r\n}\r\n\r\n// R√©cup√©rer le teamId depuis les arguments\r\nconst args = process.argv.slice(2);\r\nconst teamIdArg = args.find(a => a.startsWith(\"--team-id=\"))?.split(\"=\")[1];\r\n\r\naudit(teamIdArg);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\audit_db.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":58},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nconst { createClient } = require('@supabase/supabase-js');\r\nrequire('dotenv').config({ path: '.env.local' });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function audit() {\r\n    console.log(\"--- AUDIT USER DOCUMENTS START ---\");\r\n    const { data: docs, error: docsError } = await supabase\r\n        .from('user_documents')\r\n        .select('id, name, type, entity_type, entity_id, lease_id, category')\r\n        .order('created_at', { ascending: false })\r\n        .limit(30);\r\n\r\n    if (docsError) {\r\n        console.error(\"Error fetching docs:\", docsError);\r\n        return;\r\n    }\r\n\r\n    console.log(`Found ${docs?.length || 0} documents.`);\r\n\r\n    for (const doc of docs || []) {\r\n        console.log(`Doc: \"${doc.name}\" | ID: ${doc.id}`);\r\n        console.log(`  Type: ${doc.type} | EntityType: ${doc.entity_type} | Category: ${doc.category}`);\r\n        console.log(`  IDs: lease_id=${doc.lease_id}, entity_id=${doc.entity_id}`);\r\n\r\n        if (doc.lease_id) {\r\n            const { data: lease } = await supabase.from('leases').select('id, tenant_name').eq('id', doc.lease_id).maybeSingle();\r\n            if (!lease) {\r\n                console.log(`  ‚ö†Ô∏è LEASE ID ${doc.lease_id} NOT FOUND IN LEASES TABLE`);\r\n            } else {\r\n                console.log(`  ‚úÖ Lease found: ${lease.tenant_name}`);\r\n            }\r\n        } else {\r\n            console.log(`  ‚ÑπÔ∏è No lease_id`);\r\n        }\r\n\r\n        if (doc.entity_type === 'payment' && doc.entity_id) {\r\n            const { data: tx } = await supabase.from('rental_transactions').select('id, status').eq('id', doc.entity_id).maybeSingle();\r\n            if (!tx) {\r\n                console.log(`  ‚ö†Ô∏è TRANSACTION ID ${doc.entity_id} NOT FOUND`);\r\n            } else {\r\n                console.log(`  ‚úÖ Transaction found: status=${tx.status}`);\r\n            }\r\n        }\r\n        console.log(\"-\".repeat(40));\r\n    }\r\n    console.log(\"--- AUDIT USER DOCUMENTS END ---\");\r\n}\r\n\r\naudit();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-homepage-images.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2580,2583],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2580,2583],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":137,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4035,4038],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4035,4038],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4242,4245],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4242,4245],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour v√©rifier sp√©cifiquement les images des propri√©t√©s affich√©es sur la home page\n * et les remplacer si elles sont cass√©es\n * \n * Usage: npm run check-homepage-images\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport * as dotenv from \"dotenv\";\n\ndotenv.config({ path: \".env.local\" });\n\nconst PEXELS_API_KEY = \"3eFVqLX19mBYTUVCMxhpPH156xmJ8K5ccP5TBwH5R2h90pHMmgb638AS\";\nconst PEXELS_API_URL = \"https://api.pexels.com/v1/search\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseKey) {\n  console.error(\"‚ùå Variables d'environnement manquantes\");\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false,\n    detectSessionInUrl: false,\n  },\n});\n\nconst getSearchQuery = (title: string, description: string, _type?: string): string => {\n  const text = `${title} ${description}`.toLowerCase();\n  \n  if (text.includes(\"terrain\") || text.includes(\"land\")) {\n    return \"empty land plot construction\";\n  }\n  if (text.includes(\"villa\") || text.includes(\"maison\") || text.includes(\"house\")) {\n    return \"modern white villa exterior\";\n  }\n  if (text.includes(\"appartement\") || text.includes(\"apartment\")) {\n    return \"modern apartment interior\";\n  }\n  if (text.includes(\"studio\")) {\n    return \"studio apartment interior design\";\n  }\n  if (text.includes(\"bureau\") || text.includes(\"office\")) {\n    return \"modern office space\";\n  }\n  if (text.includes(\"piscine\") || text.includes(\"pool\")) {\n    return \"luxury house with pool\";\n  }\n  \n  return \"modern real estate property\";\n};\n\nasync function checkImageExists(url: string): Promise<boolean> {\n  try {\n    const response = await fetch(url, {\n      method: \"HEAD\",\n      signal: AbortSignal.timeout(5000),\n    });\n    \n    if (response.ok && response.status === 200) {\n      const contentType = response.headers.get(\"content-type\");\n      if (contentType && !contentType.startsWith(\"image/\")) {\n        return false;\n      }\n      return true;\n    }\n    return false;\n  } catch (_error) {\n    return false;\n  }\n}\n\nasync function fetchPexelsImages(query: string, count: number = 3): Promise<string[]> {\n  try {\n    const response = await fetch(`${PEXELS_API_URL}?query=${encodeURIComponent(query)}&per_page=${count}`, {\n      headers: {\n        Authorization: PEXELS_API_KEY,\n      },\n    });\n\n    if (!response.ok) {\n      return [];\n    }\n\n    const data = await response.json();\n    const images = data.photos?.map((photo: any) => {\n      const url = photo.src?.large || photo.src?.original || photo.src?.medium;\n      if (url && typeof url === \"string\") {\n        return url.startsWith(\"http\") ? url : `https:${url}`;\n      }\n      return null;\n    }).filter((url: string | null): url is string => url !== null && url.length > 0) || [];\n    \n    return images;\n  } catch (_error) {\n    return [];\n  }\n}\n\nasync function checkHomepageImages() {\n  console.log(\"üîç V√©rification des images des propri√©t√©s de la home page...\\n\");\n\n  // R√©cup√©rer les propri√©t√©s comme sur la home page\n  const [locations, ventes, terrains] = await Promise.all([\n    // Locations √† Dakar\n    supabase\n      .from(\"properties\")\n      .select(\"id, title, description, images, details, location\")\n      .eq(\"category\", \"location\")\n      .eq(\"location->>city\", \"Dakar\")\n      .order(\"created_at\", { ascending: false })\n      .limit(8),\n    \n    // Ventes (exclut terrains)\n    supabase\n      .from(\"properties\")\n      .select(\"id, title, description, images, details, location\")\n      .eq(\"category\", \"vente\")\n      .order(\"created_at\", { ascending: false })\n      .limit(20),\n    \n    // Terrains\n    supabase\n      .from(\"properties\")\n      .select(\"id, title, description, images, details, location\")\n      .eq(\"category\", \"vente\")\n      .order(\"created_at\", { ascending: false })\n      .limit(20),\n  ]);\n\n  // Filtrer comme sur la home page\n  const ventesFiltered = (ventes.data || []).filter(\n    (p: any) =>\n      p.details?.type === \"Maison\" ||\n      p.details?.type === \"Appartement\" ||\n      p.details?.type === \"Studio\"\n  ).slice(0, 8);\n\n  const terrainsFiltered = (terrains.data || []).filter(\n    (p: any) =>\n      p.details?.type?.toLowerCase().includes(\"terrain\") ||\n      p.title?.toLowerCase().includes(\"terrain\") ||\n      p.description?.toLowerCase().includes(\"terrain\")\n  ).slice(0, 8);\n\n  const allProperties = [\n    ...(locations.data || []),\n    ...ventesFiltered,\n    ...terrainsFiltered,\n  ];\n\n  console.log(`üì¶ ${allProperties.length} propri√©t√©s trouv√©es sur la home page\\n`);\n\n  let updated = 0;\n  let totalBroken = 0;\n\n  for (const property of allProperties) {\n    const images = property.images as string[] | null;\n    \n    if (!images || !Array.isArray(images) || images.length === 0) {\n      continue;\n    }\n\n    console.log(`üîÑ V√©rification: ${property.title}`);\n    console.log(`   ${images.length} image(s) √† v√©rifier`);\n\n    const brokenIndices: number[] = [];\n    \n    for (let i = 0; i < images.length; i++) {\n      const img = images[i];\n      if (!img || typeof img !== \"string\" || img.length === 0) {\n        brokenIndices.push(i);\n        continue;\n      }\n      \n      const exists = await checkImageExists(img);\n      if (!exists) {\n        brokenIndices.push(i);\n        console.log(`   ‚ùå Image ${i + 1} cass√©e: ${img.substring(0, 60)}...`);\n      }\n    }\n\n    if (brokenIndices.length === 0) {\n      console.log(`   ‚úÖ Toutes les images sont valides\\n`);\n      continue;\n    }\n\n    totalBroken += brokenIndices.length;\n    console.log(`   ‚ö†Ô∏è ${brokenIndices.length} image(s) cass√©e(s) d√©tect√©e(s)`);\n\n    const searchQuery = getSearchQuery(\n      property.title || \"\",\n      property.description || \"\",\n      property.details?.type\n    );\n\n    console.log(`   üîç Recherche Pexels: \"${searchQuery}\"`);\n\n    const newImages = await fetchPexelsImages(searchQuery, brokenIndices.length);\n\n    if (newImages.length === 0) {\n      console.log(`   ‚ö†Ô∏è Aucune image Pexels trouv√©e\\n`);\n      continue;\n    }\n\n    const updatedImages = images.map((img, index) => {\n      if (brokenIndices.includes(index)) {\n        const pexelsImage = newImages[brokenIndices.indexOf(index) % newImages.length];\n        if (pexelsImage) {\n          console.log(`   ‚úÖ Remplacement image ${index + 1} par Pexels`);\n          return pexelsImage;\n        }\n      }\n      return img;\n    }).filter((img) => img && typeof img === \"string\" && img.length > 0);\n\n    const { error: updateError } = await supabase\n      .from(\"properties\")\n      .update({ images: updatedImages })\n      .eq(\"id\", property.id);\n\n    if (updateError) {\n      console.error(`   ‚ùå Erreur lors de la mise √† jour:`, updateError);\n    } else {\n      console.log(`   ‚úÖ ${brokenIndices.length} image(s) remplac√©e(s)\\n`);\n      updated++;\n    }\n\n    await new Promise((resolve) => setTimeout(resolve, 1000));\n  }\n\n  console.log(`\\n‚ú® Termin√©!`);\n  console.log(`   üìä ${updated} propri√©t√©s mises √† jour`);\n  console.log(`   üìä ${totalBroken} image(s) cass√©e(s) remplac√©e(s)`);\n}\n\ncheckHomepageImages()\n  .then(() => {\n    console.log(\"\\nüéâ Script termin√© avec succ√®s\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"\\n‚ùå Erreur fatale:\", error);\n    process.exit(1);\n  });\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check-signup-issues.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\check_quotes.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":58},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nconst { createClient } = require('@supabase/supabase-js');\r\nrequire('dotenv').config({ path: '.env.local' });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n    console.error(\"Missing env vars\");\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function checkQuotes() {\r\n    const { data, error } = await supabase\r\n        .from('maintenance_requests')\r\n        .select('id, description, status, quote_url, created_at')\r\n        .order('created_at', { ascending: false })\r\n        .limit(5);\r\n\r\n    if (error) {\r\n        console.error(error);\r\n    } else {\r\n        console.log(JSON.stringify(data, null, 2));\r\n    }\r\n}\r\n\r\ncheckQuotes();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\clean-test-data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\clean_ged.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":58},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nconst { createClient } = require('@supabase/supabase-js');\r\nrequire('dotenv').config({ path: '.env.local' });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n    console.error(\"Missing env vars\");\r\n    process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nasync function cleanBadDocs() {\r\n    // 1. Lister les documents maintenance suspects dans user_documents\r\n    const { data: docs, error } = await supabase\r\n        .from('user_documents')\r\n        .select('id, file_name, file_path, file_size, entity_type')\r\n        .eq('entity_type', 'maintenance');\r\n\r\n    if (error) {\r\n        console.error(\"Erreur list:\", error);\r\n        return;\r\n    }\r\n\r\n    console.log(`Trouv√© ${docs.length} documents de maintenance dans user_documents.`);\r\n\r\n    // Identifier ceux qui sont \"vides\" ou invalides\r\n    // Crit√®res : file_size = 0 et file_path ne contient pas de nom de fichier valide ou pointant vers un dossier\r\n    const badDocs = docs.filter(d => d.file_size === 0 || d.file_path === 'undefined' || d.file_path === 'null' || !d.file_path);\r\n\r\n    console.log(`${badDocs.length} documents suspects √† supprimer.`);\r\n\r\n    if (badDocs.length > 0) {\r\n        const ids = badDocs.map(d => d.id);\r\n        const { error: delError } = await supabase\r\n            .from('user_documents')\r\n            .delete()\r\n            .in('id', ids);\r\n\r\n        if (delError) console.error(\"Erreur suppression:\", delError);\r\n        else console.log(\"Suppression effectu√©e avec succ√®s.\");\r\n    }\r\n}\r\n\r\ncleanBadDocs();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\configure-stripe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\create-test-late-payment.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":34,"column":5,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":34,"endColumn":18,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[1137,1150],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js';\nimport dotenv from 'dotenv';\n\ndotenv.config({ path: '.env.local' });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n    console.error('‚ùå Erreur: Variables d\\'environnement manquantes.');\n    process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function createTestCase() {\n    console.log('üß™ Cr√©ation d\\'un cas de test pour les relances...');\n\n    // 1. Trouver une transaction de D√©cembre 2025\n    const { data: transactions, error } = await supabase\n        .from('rental_transactions')\n        .select('id, status, period_month, period_year, leases(tenant_name, tenant_email)')\n        .eq('period_month', 12)\n        .eq('period_year', 2025)\n        .limit(1);\n\n    if (error || !transactions || transactions.length === 0) {\n        console.error('‚ùå Aucune transaction trouv√©e pour D√©cembre 2025');\n        return;\n    }\n\n    const testTx = transactions[0];\n    console.log(`üìù Transaction trouv√©e: ${testTx.id}`);\n    // @ts-ignore\n    console.log(`   Locataire: ${testTx.leases?.tenant_name}`);\n    console.log(`   Statut actuel: ${testTx.status}`);\n\n    // 2. Modifier le statut en \"pending\" (en attente) pour simuler un impay√©\n    const { error: updateError } = await supabase\n        .from('rental_transactions')\n        .update({\n            status: 'pending',\n            reminder_sent: false\n        })\n        .eq('id', testTx.id);\n\n    if (updateError) {\n        console.error('‚ùå Erreur lors de la mise √† jour:', updateError);\n        return;\n    }\n\n    console.log('‚úÖ Transaction modifi√©e avec succ√®s !');\n    console.log('   Nouveau statut: pending (en attente)');\n    console.log('   reminder_sent: false');\n    console.log('\\nüöÄ Vous pouvez maintenant lancer:');\n    console.log('   npx tsx scripts/manual-trigger-reminders.ts');\n}\n\ncreateTestCase();\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-categories-api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-categories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-email-verification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-featured.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-paydunya-url.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-property-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-relations.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":69,"column":17,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":69,"endColumn":30,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[2405,2418],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js';\nimport dotenv from 'dotenv';\n\ndotenv.config({ path: '.env.local' });\n\nconst supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nasync function inspectData() {\n    console.log(\"üïµÔ∏è --- D√âBUT DE L'INSPECTION DES RELATIONS ---\\n\");\n\n    // On r√©cup√®re TOUTES les transactions non pay√©es pour voir les liens\n    // Structure adapt√©e √† ton sch√©ma r√©el (leases contient directement tenant_name, tenant_email)\n    const { data: transactions, error } = await supabase\n        .from('rental_transactions')\n        .select(`\n      id,\n      amount_due,\n      status,\n      period_start,\n      period_month,\n      period_year,\n      reminder_sent,\n      lease_id,\n      leases (\n        id,\n        tenant_name,\n        tenant_email,\n        tenant_phone,\n        monthly_amount,\n        billing_day,\n        owner_id,\n        property_id\n      )\n    `)\n        .neq('status', 'paid'); // On regarde ceux qui posent probl√®me (non pay√©s)\n\n    if (error) {\n        console.error(\"‚ùå Erreur SQL:\", error);\n        return;\n    }\n\n    console.log(`üîé ${transactions.length} transactions trouv√©es (Non Pay√©es). Analyse en cours...\\n`);\n\n    if (transactions.length === 0) {\n        console.log(\"‚úÖ Aucune transaction impay√©e trouv√©e. Tout est √† jour !\");\n        return;\n    }\n\n    transactions.forEach((tx, index) => {\n        console.log(`üìù DOSSIER #${index + 1}`);\n        console.log(`   ‚îú‚îÄ Transaction ID : ${tx.id}`);\n        console.log(`   ‚îú‚îÄ Montant        : ${tx.amount_due} FCFA`);\n        console.log(`   ‚îú‚îÄ Statut         : ${tx.status}`);\n        console.log(`   ‚îú‚îÄ P√©riode        : ${tx.period_month}/${tx.period_year}`);\n        console.log(`   ‚îú‚îÄ Date D√©but     : ${tx.period_start || 'NULL ‚ö†Ô∏è'}`);\n        console.log(`   ‚îú‚îÄ Relance envoy√©e: ${tx.reminder_sent ? 'OUI ‚úÖ' : 'NON ‚ùå'}`);\n\n        // V√©rification du BAIL\n        if (!tx.leases) {\n            console.log(`   ‚ùå ERREUR CRITIQUE: Aucun bail li√© (leases est null)`);\n            console.log(`   ‚îî‚îÄ Cette transaction est orpheline !`);\n        } else if (Array.isArray(tx.leases)) {\n            console.log(`   ‚ö†Ô∏è ATTENTION: 'leases' est un TABLEAU (Taille: ${tx.leases.length})`);\n            console.log(`   ‚îî‚îÄ Cause probable: Mauvaise configuration de la relation FK`);\n            if (tx.leases.length > 0) {\n                // @ts-ignore\n                const firstLease = tx.leases[0];\n                console.log(`   ‚îî‚îÄ Premier bail: ${firstLease.tenant_name} (${firstLease.tenant_email})`);\n            }\n        } else {\n            // Cas normal : leases est un objet unique\n            const lease = tx.leases;\n            console.log(`   ‚îú‚îÄ LIEN Bail ID   : ${lease.id}`);\n            console.log(`   ‚îú‚îÄ Montant bail   : ${lease.monthly_amount} FCFA`);\n            console.log(`   ‚îú‚îÄ Jour paiement  : ${lease.billing_day || 5}`);\n            console.log(`   ‚îú‚îÄ Owner ID       : ${lease.owner_id || 'NULL ‚ö†Ô∏è'}`);\n            console.log(`   ‚îî‚îÄ üë§ LOCATAIRE :`);\n            console.log(`       ‚îú‚îÄ Nom   : ${lease.tenant_name}`);\n            console.log(`       ‚îú‚îÄ Email : ${lease.tenant_email || 'Pas d\\'email ‚ö†Ô∏è'}`);\n            console.log(`       ‚îî‚îÄ T√©l   : ${lease.tenant_phone || 'Pas de t√©l√©phone'}`);\n        }\n        console.log(\"-----------------------------------------------------------\\n\");\n    });\n\n    console.log(\"\\nüéØ R√âSUM√â DE L'ANALYSE:\");\n    console.log(`   Total transactions impay√©es : ${transactions.length}`);\n    const withEmail = transactions.filter(t => {\n        const lease = Array.isArray(t.leases) ? t.leases[0] : t.leases;\n        return lease?.tenant_email;\n    }).length;\n    console.log(`   Avec email valide           : ${withEmail}`);\n    console.log(`   Sans email (non relan√ßables): ${transactions.length - withEmail}`);\n\n    const withPeriodStart = transactions.filter(t => t.period_start).length;\n    console.log(`   Avec period_start rempli    : ${withPeriodStart}`);\n    console.log(`   Sans period_start (bug)     : ${transactions.length - withPeriodStart}`);\n}\n\ninspectData();\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-reminders-issue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-seo.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[557,560],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[557,560],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1247,1250],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1247,1250],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport dotenv from 'dotenv';\r\nimport { slugify } from '../lib/slugs';\r\nimport fs from 'fs';\r\nimport _path from 'path';\r\n\r\ndotenv.config({ path: '.env.local' });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n// Try to get service role key for better access if possible, or fall back to Anon\r\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n\r\nconst supabase = createClient(supabaseUrl, serviceRoleKey);\r\n\r\nconst log = (msg: any) => {\r\n    const text = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : String(msg);\r\n    fs.appendFileSync('debug_output.txt', text + '\\n');\r\n    console.log(text);\r\n};\r\n\r\nasync function debug() {\r\n    fs.writeFileSync('debug_output.txt', ''); // Clear file\r\n    log(\"--- DEBUGGING SEO SEARCH ---\");\r\n\r\n    // 1. Check RPC output\r\n    log(\"\\n1. Testing RPC 'get_active_cities_and_types'...\");\r\n    const { data: rpcData, error: rpcError } = await supabase.rpc('get_active_cities_and_types');\r\n\r\n    if (rpcError) {\r\n        log({ error: \"RPC Error\", details: rpcError });\r\n    } else {\r\n        log(`RPC returned ${rpcData?.length} rows.`);\r\n        const cities = rpcData as any[];\r\n        // Log all cities to see what we have\r\n        log(\"All Cities from RPC:\");\r\n        cities.forEach(c => {\r\n            log(`City: \"${c.city}\", Slug: \"${slugify(c.city)}\"`);\r\n        });\r\n    }\r\n\r\n    // 2. Check Raw Properties for Thies\r\n    log(\"\\n2. Checking Raw Properties for 'Thies'...\");\r\n    const { data: props, error: propsError } = await supabase\r\n        .from('properties')\r\n        .select('id, location')\r\n        .ilike('location->>city', '%thies%')\r\n        .limit(5);\r\n\r\n    if (propsError) log({ error: \"Properties Error\", details: propsError });\r\n    else {\r\n        log(\"Found properties matching %thies%:\");\r\n        log(props);\r\n    }\r\n}\r\n\r\ndebug();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-tenant-token.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug-token.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":128,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4443,4446],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4443,4446],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Debug script to verify token generation and storage\r\n *\r\n * Usage:\r\n *   npx tsx scripts/debug-token.ts <lease_id>\r\n *   npx tsx scripts/debug-token.ts --email <email>\r\n */\r\n\r\nimport { config } from \"dotenv\";\r\nimport { resolve } from \"path\";\r\n\r\n// Load environment variables from .env.local\r\nconfig({ path: resolve(process.cwd(), \".env.local\") });\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { createAdminClient } from \"@/utils/supabase/admin\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nif (!supabaseUrl || !supabaseServiceKey) {\r\n  console.error(\"‚ùå Missing Supabase credentials\");\r\n  console.error(\"Make sure NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in .env.local\");\r\n  process.exit(1);\r\n}\r\n\r\nasync function debugLeaseToken(leaseId: string) {\r\n  console.log(`\\nüîç Debugging token for lease: ${leaseId}\\n`);\r\n\r\n  // Test with both clients\r\n  const adminClient = createAdminClient();\r\n  const anonClient = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\n  console.log(\"üìä Testing with Admin Client:\");\r\n  const { data: lease1, error: error1 } = await adminClient\r\n    .from(\"leases\")\r\n    .select(`\r\n      id,\r\n      tenant_name,\r\n      tenant_email,\r\n      status,\r\n      tenant_access_token,\r\n      tenant_token_expires_at,\r\n      tenant_token_verified,\r\n      property_address\r\n    `)\r\n    .eq(\"id\", leaseId)\r\n    .single();\r\n\r\n  if (error1) {\r\n    console.error(\"‚ùå Admin Client Error:\", error1.message);\r\n  } else if (lease1) {\r\n    console.log(\"‚úÖ Admin Client - Lease found:\");\r\n    console.log(`   Tenant: ${lease1.tenant_name} (${lease1.tenant_email})`);\r\n    console.log(`   Status: ${lease1.status}`);\r\n    console.log(`   Property: ${lease1.property_address}`);\r\n    console.log(`   Has token: ${!!lease1.tenant_access_token ? \"‚úÖ Yes\" : \"‚ùå No\"}`);\r\n    if (lease1.tenant_access_token) {\r\n      console.log(`   Token (first 20 chars): ${lease1.tenant_access_token.substring(0, 20)}...`);\r\n      console.log(`   Token verified: ${lease1.tenant_token_verified ? \"‚úÖ Yes\" : \"‚ùå No\"}`);\r\n      console.log(`   Token expires: ${lease1.tenant_token_expires_at || \"N/A\"}`);\r\n\r\n      const isExpired = lease1.tenant_token_expires_at\r\n        ? new Date(lease1.tenant_token_expires_at) < new Date()\r\n        : true;\r\n      console.log(`   Is expired: ${isExpired ? \"‚ö†Ô∏è Yes\" : \"‚úÖ No\"}`);\r\n    }\r\n  } else {\r\n    console.log(\"‚ùå Lease not found\");\r\n  }\r\n\r\n  console.log(\"\\nüìä Testing with Service Role Client:\");\r\n  const { data: lease2, error: error2 } = await anonClient\r\n    .from(\"leases\")\r\n    .select(`\r\n      id,\r\n      tenant_name,\r\n      tenant_email,\r\n      status,\r\n      tenant_access_token,\r\n      tenant_token_expires_at,\r\n      tenant_token_verified\r\n    `)\r\n    .eq(\"id\", leaseId)\r\n    .single();\r\n\r\n  if (error2) {\r\n    console.error(\"‚ùå Service Role Client Error:\", error2.message);\r\n  } else if (lease2) {\r\n    console.log(\"‚úÖ Service Role Client - Lease found\");\r\n    console.log(`   Has token: ${!!lease2.tenant_access_token ? \"‚úÖ Yes\" : \"‚ùå No\"}`);\r\n  } else {\r\n    console.log(\"‚ùå Lease not found\");\r\n  }\r\n\r\n  // Check tenant_access_logs\r\n  console.log(\"\\nüìã Recent token generation logs:\");\r\n  const { data: logs, error: logsError } = await adminClient\r\n    .from(\"tenant_access_logs\")\r\n    .select(\"*\")\r\n    .eq(\"lease_id\", leaseId)\r\n    .eq(\"action\", \"token_generated\")\r\n    .order(\"created_at\", { ascending: false })\r\n    .limit(5);\r\n\r\n  if (logsError) {\r\n    console.error(\"‚ùå Error fetching logs:\", logsError.message);\r\n  } else if (logs && logs.length > 0) {\r\n    console.log(`‚úÖ Found ${logs.length} token generation log(s):`);\r\n    logs.forEach((log, idx) => {\r\n      console.log(`   ${idx + 1}. ${new Date(log.created_at).toLocaleString(\"fr-FR\")} - IP: ${log.ip_address || \"N/A\"}`);\r\n    });\r\n  } else {\r\n    console.log(\"‚ùå No token generation logs found\");\r\n  }\r\n\r\n  // Check RLS policies on leases table\r\n  console.log(\"\\nüîí Checking RLS policies on leases table:\");\r\n  const { data: policies, error: policiesError } = await adminClient\r\n    .from(\"pg_policies\")\r\n    .select(\"*\")\r\n    .eq(\"tablename\", \"leases\");\r\n\r\n  if (policiesError) {\r\n    console.error(\"‚ùå Error fetching policies:\", policiesError.message);\r\n  } else if (policies && policies.length > 0) {\r\n    console.log(`‚úÖ Found ${policies.length} RLS policy/policies on leases table`);\r\n    policies.forEach((policy: any) => {\r\n      console.log(`   - ${policy.policyname} (${policy.cmd})`);\r\n    });\r\n  } else {\r\n    console.log(\"‚ÑπÔ∏è  No RLS policies found (or insufficient permissions to view)\");\r\n  }\r\n}\r\n\r\nasync function debugByEmail(email: string) {\r\n  const normalizedEmail = email.toLowerCase().trim();\r\n  console.log(`\\nüîç Finding leases for email: ${normalizedEmail}\\n`);\r\n\r\n  const adminClient = createAdminClient();\r\n  const { data: leases, error } = await adminClient\r\n    .from(\"leases\")\r\n    .select(\"id, tenant_name, status, property_address\")\r\n    .eq(\"tenant_email\", normalizedEmail)\r\n    .eq(\"status\", \"active\");\r\n\r\n  if (error) {\r\n    console.error(\"‚ùå Error:\", error.message);\r\n    process.exit(1);\r\n  }\r\n\r\n  if (!leases || leases.length === 0) {\r\n    console.log(\"‚ùå No active leases found for this email\");\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(`‚úÖ Found ${leases.length} active lease(s):\\n`);\r\n\r\n  for (let i = 0; i < leases.length; i++) {\r\n    const lease = leases[i];\r\n    console.log(`${\"=\".repeat(60)}`);\r\n    console.log(`Lease ${i + 1}: ${lease.property_address}`);\r\n    console.log(`${\"=\".repeat(60)}`);\r\n    await debugLeaseToken(lease.id);\r\n    console.log();\r\n  }\r\n}\r\n\r\nasync function main() {\r\n  const args = process.argv.slice(2);\r\n\r\n  if (args.length === 0 || args.includes(\"--help\") || args.includes(\"-h\")) {\r\n    console.log(\"Usage:\");\r\n    console.log(\"  By lease ID:    npx tsx scripts/debug-token.ts <lease_id>\");\r\n    console.log(\"  By email:       npx tsx scripts/debug-token.ts --email <email>\\n\");\r\n    console.log(\"Examples:\");\r\n    console.log(\"  npx tsx scripts/debug-token.ts 123e4567-e89b-12d3-a456-426614174000\");\r\n    console.log(\"  npx tsx scripts/debug-token.ts --email tenant@example.com\");\r\n    process.exit(args.length === 0 ? 1 : 0);\r\n  }\r\n\r\n  try {\r\n    if (args[0] === \"--email\" || args[0] === \"-e\") {\r\n      if (!args[1]) {\r\n        console.error(\"‚ùå Email address required\");\r\n        process.exit(1);\r\n      }\r\n      await debugByEmail(args[1]);\r\n    } else {\r\n      await debugLeaseToken(args[0]);\r\n    }\r\n\r\n    console.log(\"\\n‚úÖ Debug complete!\");\r\n  } catch (error) {\r\n    console.error(\"\\n‚ùå Error:\", error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\debug_owner.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":58},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nconst { createClient } = require('@supabase/supabase-js');\r\nrequire('dotenv').config({ path: '.env.local' });\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\nconst ownerId = '8f06546d-18bb-4327-abdf-6a9401f396c8';\r\n\r\nasync function debug() {\r\n    console.log(`--- DEBUG FOR OWNER ${ownerId} ---`);\r\n\r\n    // 1. Leases\r\n    const { data: leases } = await supabase.from('leases').select('id, tenant_name, status').eq('owner_id', ownerId);\r\n    console.log(`\\nLEASES (${leases?.length || 0}):`);\r\n    leases?.forEach(l => console.log(`  - ${l.tenant_name} (ID: ${l.id}) [${l.status}]`));\r\n\r\n    // 2. Transactions\r\n    const { data: txs } = await supabase.from('rental_transactions').select('id, lease_id, status, period_month, period_year')\r\n        .eq('status', 'paid')\r\n        .limit(10);\r\n    console.log(`\\nPAID TRANSACTIONS (Top 10):`);\r\n    txs?.forEach(t => console.log(`  - TX: ${t.id} | Lease: ${t.lease_id} | ${t.period_month}/${t.period_year}`));\r\n\r\n    // 3. User Documents\r\n    const { data: docs } = await supabase.from('user_documents').select('*')\r\n        .or(`user_id.eq.${ownerId},lease_id.in.(${leases?.map(l => l.id).join(',') || ''})`)\r\n        .order('created_at', { ascending: false })\r\n        .limit(20);\r\n\r\n    console.log(`\\nUSER DOCUMENTS (Top 20):`);\r\n    docs?.forEach(d => {\r\n        console.log(`  - Doc: \"${d.name}\" (ID: ${d.id})`);\r\n        console.log(`    Type: ${d.type} | Entity: ${d.entity_type}:${d.entity_id}`);\r\n        console.log(`    Path: ${d.file_path}`);\r\n        console.log(`    LeaseID: ${d.lease_id}`);\r\n    });\r\n}\r\n\r\ndebug();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\delete-future-transactions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\diagnose-digital-safe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\diagnose_ged.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":58},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nconst { createClient } = require('@supabase/supabase-js');\r\nrequire('dotenv').config({ path: '.env.local' });\r\n\r\nconst supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);\r\n\r\nasync function diagnose() {\r\n    console.log(\"--- GED DIAGNOSIS ---\");\r\n\r\n    const { data: docs, error: docsError } = await supabase\r\n        .from('user_documents')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n        .limit(10);\r\n\r\n    if (docsError) {\r\n        console.error(\"Error fetching docs:\", docsError);\r\n        return;\r\n    }\r\n\r\n    console.log(`Found ${docs.length} recent documents:`);\r\n    docs.forEach(d => {\r\n        console.log(`- ID: ${d.id} | Name: ${d.name} | LeaseID: ${d.lease_id} | EntityID: ${d.entity_id} | Type: ${d.file_type} | Cat: ${d.category}`);\r\n    });\r\n\r\n    const leaseId = '15b0d825-778c-461b-ad87-27ce75fbbaae';\r\n    console.log(`\\nChecking specific lease: ${leaseId}`);\r\n    const { data: specificDoc, error: specError } = await supabase\r\n        .from('user_documents')\r\n        .select('*')\r\n        .eq('lease_id', leaseId)\r\n        .maybeSingle();\r\n\r\n    if (specError) console.error(\"Error fetching specific doc:\", specError);\r\n    else if (specificDoc) console.log(\"Found document for lease:\", specificDoc.id);\r\n    else console.log(\"No document found for lease ID in lease_id column.\");\r\n\r\n    const { data: entityDoc } = await supabase\r\n        .from('user_documents')\r\n        .select('*')\r\n        .eq('entity_id', leaseId)\r\n        .maybeSingle();\r\n\r\n    if (entityDoc) console.log(\"Found document for lease ID in entity_id column:\", entityDoc.id);\r\n\r\n}\r\n\r\ndiagnose();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\download-font.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":31},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":29}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const https = require('https');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst urls = [\r\n    'https://github.com/googlefonts/noto-fonts/raw/main/hinted/ttf/NotoEmoji/NotoEmoji-Regular.ttf',\r\n    'https://raw.githubusercontent.com/googlefonts/noto-fonts/main/hinted/ttf/NotoEmoji/NotoEmoji-Regular.ttf',\r\n    'https://github.com/googlefonts/noto-emoji/raw/main/fonts/NotoEmoji-Regular.ttf'\r\n];\r\n\r\nconst dest = path.join(process.cwd(), 'public', 'fonts', 'NotoEmoji-Regular.ttf');\r\nconst file = fs.createWriteStream(dest);\r\n\r\nfunction download(index) {\r\n    if (index >= urls.length) {\r\n        console.error('All URLs failed.');\r\n        fs.unlink(dest, () => { });\r\n        return;\r\n    }\r\n\r\n    const url = urls[index];\r\n    console.log(`Trying ${url}...`);\r\n\r\n    https.get(url, (response) => {\r\n        if (response.statusCode === 200) {\r\n            response.pipe(file);\r\n            file.on('finish', () => {\r\n                file.close(() => {\r\n                    console.log('Download completed successfully.');\r\n                });\r\n            });\r\n        } else if (response.statusCode === 302 || response.statusCode === 301) {\r\n            const newUrl = response.headers.location;\r\n            console.log(`Redirecting to ${newUrl}...`);\r\n            https.get(newUrl, (res2) => {\r\n                if (res2.statusCode === 200) {\r\n                    res2.pipe(file);\r\n                    file.on('finish', () => {\r\n                        file.close(() => {\r\n                            console.log('Download completed successfully (redirect).');\r\n                        });\r\n                    });\r\n                } else {\r\n                    console.log(`Failed with ${res2.statusCode}, trying next...`);\r\n                    download(index + 1);\r\n                }\r\n            }).on('error', (err) => {\r\n                console.error(`Error redirect: ${err.message}, trying next...`);\r\n                download(index + 1);\r\n            });\r\n        } else {\r\n            console.log(`Failed with ${response.statusCode}, trying next...`);\r\n            download(index + 1);\r\n        }\r\n    }).on('error', (err) => {\r\n        console.error(`Error: ${err.message}, trying next...`);\r\n        download(index + 1);\r\n    });\r\n}\r\n\r\ndownload(0);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\extract-logo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fetch-pexels-images.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1704,1707],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1704,1707],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1785,1788],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1785,1788],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from \"fs\";\n\nconst API_KEY = process.env.PEXELS_API_KEY;\nif (!API_KEY) {\n  console.error(\"Missing PEXELS_API_KEY environment variable.\");\n  process.exit(1);\n}\n\nconst targets = [\n  { title: \"Superbe F4 Moderne avec Piscine - Zone Almadies\", query: \"luxury modern living room pool\" },\n  { title: \"Appartement F3 Spacieux et Accessible - Mermoz\", query: \"cozy apartment interior bright\" },\n  { title: \"Villa d'Architecte R+1 avec Rooftop - Les Mamelles\", query: \"modern white villa rooftop\" },\n  { title: \"Studio Chic & Meubl√© Tout Inclus - Dakar Plateau\", query: \"modern studio apartment interior\" },\n  { title: \"Terrain d'Angle 300m¬≤ - P√¥le Urbain Diamniadio\", query: \"empty land plot aerial\" },\n  { title: \"Plateau de Bureaux 150m¬≤ - Fa√ßade VDN\", query: \"modern open space office\" },\n  { title: \"F3 Pieds dans l'eau - Virage\", query: \"ocean view apartment balcony\" },\n  { title: \"Immeuble R+3 √† R√©nover - Sicap Libert√©\", query: \"apartment building facade\" },\n  { title: \"Villa de Charme 3 Chambres avec Piscine Priv√©e - Saly\", query: \"tropical villa pool\" },\n  { title: \"F4 de Prestige - R√©sidence Diplomatique Point E\", query: \"luxury apartment marble\" }\n];\n\nconst headers = { Authorization: API_KEY };\n\nasync function run() {\n  const results: Record<string, string[]> = {};\n\n  for (const target of targets) {\n    const url = new URL(\"https://api.pexels.com/v1/search\");\n    url.searchParams.set(\"query\", target.query);\n    url.searchParams.set(\"per_page\", \"6\");\n    const response = await fetch(url, { headers });\n    if (!response.ok) {\n      console.error(\"Pexels request failed for:\", response.status, response.statusText);\n      continue;\n    }\n    const data = (await response.json()) as any;\n    const urls = (data?.photos ?? [])\n      .slice(0, 3)\n      .map((photo: any) => photo?.src?.large2x || photo?.src?.original)\n      .filter(Boolean);\n    results[target.title] = urls;\n    console.log(\"Fetched photos for\", target.title);\n  }\n\n  fs.mkdirSync(\"scripts/output\", { recursive: true });\n  fs.writeFileSync(\"scripts/output/pexels-images.json\", JSON.stringify(results, null, 2));\n  console.log(\"Saved scripts/output/pexels-images.json\");\n}\n\nrun().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\find-property-by-ref.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-active-transactions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-broken-images.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3979,3982],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3979,3982],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":203,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":203,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6524,6527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6524,6527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour identifier et remplacer les images cass√©es par des images Pexels\n * V√©rifie chaque image et remplace celles qui retournent 404 ou erreur\n * \n * Usage: npm run fix-images\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport * as dotenv from \"dotenv\";\n\n// Charger les variables d'environnement\ndotenv.config({ path: \".env.local\" });\n\nconst PEXELS_API_KEY = \"3eFVqLX19mBYTUVCMxhpPH156xmJ8K5ccP5TBwH5R2h90pHMmgb638AS\";\nconst PEXELS_API_URL = \"https://api.pexels.com/v1/search\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseKey) {\n  console.error(\"‚ùå Variables d'environnement manquantes:\");\n  console.error(\"   NEXT_PUBLIC_SUPABASE_URL:\", supabaseUrl ? \"‚úì\" : \"‚úó\");\n  console.error(\"   SUPABASE_SERVICE_ROLE_KEY:\", supabaseKey ? \"‚úì\" : \"‚úó\");\n  console.error(\"\\nüí° Pour les scripts de maintenance, vous DEVEZ utiliser SUPABASE_SERVICE_ROLE_KEY\");\n  console.error(\"   Cette cl√© se trouve dans votre dashboard Supabase ‚Üí Settings ‚Üí API ‚Üí service_role key\");\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false,\n    detectSessionInUrl: false,\n    storage: undefined,\n  },\n});\n\n// Mots-cl√©s de recherche Pexels bas√©s sur le type de bien\nconst getSearchQuery = (title: string, description: string, _type?: string): string => {\n  const text = `${title} ${description}`.toLowerCase();\n  \n  if (text.includes(\"terrain\") || text.includes(\"land\")) {\n    return \"empty land plot construction\";\n  }\n  if (text.includes(\"villa\") || text.includes(\"maison\") || text.includes(\"house\")) {\n    return \"modern white villa exterior\";\n  }\n  if (text.includes(\"appartement\") || text.includes(\"apartment\")) {\n    return \"modern apartment interior\";\n  }\n  if (text.includes(\"studio\")) {\n    return \"studio apartment interior design\";\n  }\n  if (text.includes(\"bureau\") || text.includes(\"office\")) {\n    return \"modern office space\";\n  }\n  if (text.includes(\"piscine\") || text.includes(\"pool\")) {\n    return \"luxury house with pool\";\n  }\n  \n  return \"modern real estate property\";\n};\n\n// V√©rifier si une image est accessible\nasync function checkImageExists(url: string): Promise<boolean> {\n  try {\n    // Essayer d'abord avec HEAD (plus rapide)\n    const headResponse = await fetch(url, {\n      method: \"HEAD\",\n      signal: AbortSignal.timeout(5000),\n    });\n    \n    if (headResponse.ok && headResponse.status === 200) {\n      // V√©rifier aussi le Content-Type pour s'assurer que c'est bien une image\n      const contentType = headResponse.headers.get(\"content-type\");\n      if (contentType && !contentType.startsWith(\"image/\")) {\n        console.log(`   ‚ö†Ô∏è URL ne pointe pas vers une image: ${contentType}`);\n        return false;\n      }\n      return true;\n    }\n    \n    // Si HEAD √©choue, essayer GET avec un petit chunk pour v√©rifier\n    const getResponse = await fetch(url, {\n      method: \"GET\",\n      signal: AbortSignal.timeout(5000),\n      headers: {\n        Range: \"bytes=0-1024\", // R√©cup√©rer seulement les premiers 1KB\n      },\n    });\n    \n    if (getResponse.ok) {\n      const contentType = getResponse.headers.get(\"content-type\");\n      return contentType ? contentType.startsWith(\"image/\") : true;\n    }\n    \n    return false;\n  } catch (_error) {\n    // Si c'est une erreur de timeout ou r√©seau, consid√©rer comme cass√©\n    return false;\n  }\n}\n\n// R√©cup√©rer des images depuis Pexels\nasync function fetchPexelsImages(query: string, count: number = 3): Promise<string[]> {\n  try {\n    const response = await fetch(`${PEXELS_API_URL}?query=${encodeURIComponent(query)}&per_page=${count}`, {\n      headers: {\n        Authorization: PEXELS_API_KEY,\n      },\n    });\n\n    if (!response.ok) {\n      console.error(`   ‚ö†Ô∏è Erreur Pexels API: ${response.statusText}`);\n      return [];\n    }\n\n    const data = await response.json();\n    const images = data.photos?.map((photo: any) => {\n      const url = photo.src?.large || photo.src?.original || photo.src?.medium;\n      if (url && typeof url === \"string\") {\n        return url.startsWith(\"http\") ? url : `https:${url}`;\n      }\n      return null;\n    }).filter((url: string | null): url is string => url !== null && url.length > 0) || [];\n    \n    if (images.length > 0) {\n      console.log(`   ‚úÖ ${images.length} images Pexels trouv√©es`);\n    }\n    return images;\n  } catch (error) {\n    console.error(`   ‚ùå Erreur lors de la r√©cup√©ration des images Pexels:`, error);\n    return [];\n  }\n}\n\n// Identifier et remplacer les images cass√©es\nasync function fixBrokenImages() {\n  console.log(\"üîç Recherche des propri√©t√©s avec des images...\");\n\n  // R√©cup√©rer toutes les propri√©t√©s\n  const { data: properties, error } = await supabase\n    .from(\"properties\")\n    .select(\"id, title, description, images, details\");\n\n  if (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration des propri√©t√©s:\", error);\n    return;\n  }\n\n  if (!properties || properties.length === 0) {\n    console.log(\"‚ÑπÔ∏è Aucune propri√©t√© trouv√©e\");\n    return;\n  }\n\n  console.log(`üì¶ ${properties.length} propri√©t√©s trouv√©es\\n`);\n\n  let updated = 0;\n  let skipped = 0;\n  let totalBroken = 0;\n\n  for (const property of properties) {\n    const images = property.images as string[] | null;\n    \n    if (!images || !Array.isArray(images) || images.length === 0) {\n      skipped++;\n      continue;\n    }\n\n    console.log(`\\nüîÑ V√©rification: ${property.title}`);\n    console.log(`   ${images.length} image(s) √† v√©rifier`);\n\n    // V√©rifier chaque image\n    const brokenIndices: number[] = [];\n    const _imageChecks = await Promise.all(\n      images.map(async (img, index) => {\n        if (!img || typeof img !== \"string\" || img.length === 0) {\n          brokenIndices.push(index);\n          return false;\n        }\n        const exists = await checkImageExists(img);\n        if (!exists) {\n          brokenIndices.push(index);\n          console.log(`   ‚ùå Image ${index + 1} cass√©e: ${img.substring(0, 60)}...`);\n        }\n        return exists;\n      })\n    );\n\n    if (brokenIndices.length === 0) {\n      console.log(`   ‚úÖ Toutes les images sont valides`);\n      skipped++;\n      continue;\n    }\n\n    totalBroken += brokenIndices.length;\n    console.log(`   ‚ö†Ô∏è ${brokenIndices.length} image(s) cass√©e(s) d√©tect√©e(s)`);\n\n    // G√©n√©rer une requ√™te de recherche bas√©e sur le bien\n    const searchQuery = getSearchQuery(\n      property.title || \"\",\n      property.description || \"\",\n      (property.details as any)?.type\n    );\n\n    console.log(`   üîç Recherche Pexels: \"${searchQuery}\"`);\n\n    // R√©cup√©rer de nouvelles images depuis Pexels\n    const newImages = await fetchPexelsImages(searchQuery, brokenIndices.length);\n\n    if (newImages.length === 0) {\n      console.log(`   ‚ö†Ô∏è Aucune image Pexels trouv√©e, conservation des images existantes`);\n      skipped++;\n      continue;\n    }\n\n    // Remplacer les images cass√©es par les nouvelles images Pexels\n    const updatedImages = images.map((img, index) => {\n      if (brokenIndices.includes(index)) {\n        const pexelsImage = newImages[brokenIndices.indexOf(index) % newImages.length];\n        if (pexelsImage) {\n          console.log(`   ‚úÖ Remplacement image ${index + 1} par Pexels`);\n          return pexelsImage;\n        }\n      }\n      return img;\n    }).filter((img) => img && typeof img === \"string\" && img.length > 0);\n\n    // Mettre √† jour dans Supabase\n    const { error: updateError } = await supabase\n      .from(\"properties\")\n      .update({ images: updatedImages })\n      .eq(\"id\", property.id);\n\n    if (updateError) {\n      console.error(`   ‚ùå Erreur lors de la mise √† jour:`, updateError);\n    } else {\n      console.log(`   ‚úÖ ${brokenIndices.length} image(s) remplac√©e(s)`);\n      updated++;\n    }\n\n    // Attendre un peu pour √©viter de surcharger l'API Pexels\n    await new Promise((resolve) => setTimeout(resolve, 1000));\n  }\n\n  console.log(`\\n‚ú® Termin√©!`);\n  console.log(`   üìä ${updated} propri√©t√©s mises √† jour`);\n  console.log(`   üìä ${totalBroken} image(s) cass√©e(s) remplac√©e(s)`);\n  console.log(`   ‚è≠Ô∏è  ${skipped} propri√©t√©s ignor√©es (pas d'images cass√©es)`);\n}\n\n// Ex√©cuter le script\nfixBrokenImages()\n  .then(() => {\n    console.log(\"\\nüéâ Script termin√© avec succ√®s\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"\\n‚ùå Erreur fatale:\", error);\n    process.exit(1);\n  });\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-guarantee.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-identity-certification-scope.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-missing-teams.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-payment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-properties-from-leases.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-rented-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-touba-coords.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1270,1273],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1270,1273],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour corriger les coordonn√©es de l'annonce de Touba\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport * as dotenv from \"dotenv\";\nimport { resolve } from \"path\";\nimport { smartGeocode } from \"../lib/geocoding\";\n\n// Charger les variables d'environnement\ndotenv.config({ path: resolve(process.cwd(), \".env.local\") });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\nif (!supabaseUrl || !supabaseKey) {\n  console.error(\"‚ùå Variables d'environnement Supabase manquantes\");\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey);\n\nasync function fixTouba() {\n  console.log(\"üîç Recherche et correction de l'annonce de Touba...\\n\");\n\n  // Rechercher l'annonce de Touba\n  const { data, error } = await supabase\n    .from(\"properties\")\n    .select(\"id, title, location\")\n    .or(\"location->>city.ilike.%Touba%,location->>address.ilike.%Touba%\");\n\n  if (error) {\n    console.error(\"‚ùå Erreur Supabase:\", error);\n    return;\n  }\n\n  if (!data || data.length === 0) {\n    console.log(\"‚ÑπÔ∏è Aucune annonce trouv√©e pour Touba\");\n    return;\n  }\n\n  for (const property of data) {\n    const location = property.location as any;\n    const currentCoords = location?.coords || { lat: 0, lng: 0 };\n    const address = location?.address || \"\";\n    const district = location?.district || \"\";\n    const city = location?.city || \"\";\n\n    console.log(`üìã Traitement: ${property.title}`);\n    console.log(`   Adresse actuelle: ${address}`);\n    console.log(`   Quartier: ${district}`);\n    console.log(`   Ville: ${city}`);\n    console.log(`   Coordonn√©es actuelles: ${currentCoords.lat}, ${currentCoords.lng}`);\n\n    // Utiliser smartGeocode pour obtenir les bonnes coordonn√©es\n    // Si la ville est \"Kafrine\" mais l'adresse est \"Touba\", on doit corriger\n    const geocodeAddress = address;\n    const geocodeDistrict = district;\n    let geocodeCity = city;\n\n    // Si l'adresse est \"Touba\" mais la ville est \"Kafrine\", on corrige la ville\n    if (address.toLowerCase().includes(\"touba\") && city.toLowerCase().includes(\"kafrine\")) {\n      console.log(\"   ‚ö†Ô∏è D√©tection: Adresse = Touba mais Ville = Kafrine (incorrect)\");\n      console.log(\"   ‚úÖ Correction: Utilisation de 'Touba' comme ville\");\n      geocodeCity = \"Touba\";\n    }\n\n    console.log(`\\n   üîÑ G√©ocodage avec: address=\"${geocodeAddress}\", district=\"${geocodeDistrict}\", city=\"${geocodeCity}\"`);\n\n    const newCoords = await smartGeocode(geocodeAddress, geocodeDistrict, geocodeCity);\n\n    console.log(`   ‚úÖ Nouvelles coordonn√©es: ${newCoords.lat}, ${newCoords.lng}`);\n\n    // Mettre √† jour dans Supabase\n    const updatedLocation = {\n      ...location,\n      coords: newCoords,\n      // Corriger aussi la ville si n√©cessaire\n      city: geocodeCity !== city ? geocodeCity : city,\n    };\n\n    const { error: updateError } = await supabase\n      .from(\"properties\")\n      .update({\n        location: updatedLocation,\n      })\n      .eq(\"id\", property.id);\n\n    if (updateError) {\n      console.error(`   ‚ùå Erreur lors de la mise √† jour: ${updateError.message}`);\n    } else {\n      console.log(`   ‚úÖ Coordonn√©es mises √† jour avec succ√®s !\\n`);\n    }\n  }\n}\n\nfixTouba()\n  .then(() => {\n    console.log(\"‚úÖ Correction termin√©e\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"‚ùå Erreur:\", error);\n    process.exit(1);\n  });\n\n\n\n\n\n\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\fix-transaction-dates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\force-clear-cache.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\generate-barrel.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\generate-component-map.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\generate-magic-link.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\generate-maskable-icons.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\generate-pwa-icons.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":11,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":11,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":12,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":12,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":29,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":29,"endColumn":31}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour g√©n√©rer les ic√¥nes PWA (PNG) depuis le SVG\r\n * \r\n * Usage:\r\n *   npm run generate-icons\r\n * \r\n * Ou directement:\r\n *   node scripts/generate-pwa-icons.js\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst SVG_PATH = path.join(__dirname, '../public/icons/icon.svg');\r\nconst OUTPUT_DIR = path.join(__dirname, '../public/icons');\r\n\r\n// Fonction pour convertir SVG en PNG (m√©thode simple avec sharp si disponible)\r\nasync function generateIcons() {\r\n  try {\r\n    // V√©rifier si le SVG existe\r\n    if (!fs.existsSync(SVG_PATH)) {\r\n      console.error('‚ùå Erreur: Le fichier icon.svg n\\'existe pas √†:', SVG_PATH);\r\n      process.exit(1);\r\n    }\r\n\r\n    // V√©rifier si sharp est disponible\r\n    let sharp;\r\n    try {\r\n      sharp = require('sharp');\r\n    } catch (_error) {\r\n      console.error('‚ùå Erreur: Le package \"sharp\" n\\'est pas install√©.');\r\n      console.error('\\nüì¶ Installation requise:');\r\n      console.error('   npm install sharp --save-dev');\r\n      console.error('\\nüí° Alternatives:');\r\n      console.error('   1. Utilisez un outil en ligne (CloudConvert, Convertio)');\r\n      console.error('   2. Utilisez ImageMagick: magick convert public/icons/icon.svg -resize 192x192 public/icons/icon-192.png');\r\n      console.error('\\nüìñ Voir docs/GENERER-ICONES-PWA.md pour plus d\\'options');\r\n      process.exit(1);\r\n    }\r\n\r\n    // Lire le SVG\r\n    const svg = fs.readFileSync(SVG_PATH);\r\n\r\n    console.log('üé® G√©n√©ration des ic√¥nes PWA...\\n');\r\n\r\n    // G√©n√©rer icon-192.png\r\n    await sharp(svg)\r\n      .resize(192, 192, {\r\n        fit: 'contain',\r\n        background: { r: 5, g: 8, b: 12, alpha: 1 }, // #05080c\r\n      })\r\n      .png()\r\n      .toFile(path.join(OUTPUT_DIR, 'icon-192.png'));\r\n\r\n    console.log('‚úÖ icon-192.png g√©n√©r√© (192x192 px)');\r\n\r\n    // G√©n√©rer icon-512.png\r\n    await sharp(svg)\r\n      .resize(512, 512, {\r\n        fit: 'contain',\r\n        background: { r: 5, g: 8, b: 12, alpha: 1 }, // #05080c\r\n      })\r\n      .png()\r\n      .toFile(path.join(OUTPUT_DIR, 'icon-512.png'));\r\n\r\n    console.log('‚úÖ icon-512.png g√©n√©r√© (512x512 px)');\r\n\r\n    console.log('\\nüéâ Ic√¥nes PWA g√©n√©r√©es avec succ√®s !');\r\n    console.log('\\nüìã Prochaines √©tapes:');\r\n    console.log('   1. V√©rifiez que les fichiers sont dans public/icons/');\r\n    console.log('   2. Testez dans Chrome DevTools (F12 ‚Üí Application ‚Üí Manifest)');\r\n    console.log('   3. Testez l\\'installation PWA');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Erreur lors de la g√©n√©ration des ic√¥nes:', error.message);\r\n    console.error('\\nüí° Voir docs/GENERER-ICONES-PWA.md pour d\\'autres m√©thodes');\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Ex√©cuter\r\ngenerateIcons();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\link-audit.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\nconst path = require('path');\n\nconst targetDirs = ['app', 'components'];\nconst exts = new Set(['.ts', '.tsx']);\n\nconst listFiles = (dir) => {\n  let results = [];\n  const entries = fs.readdirSync(dir, { withFileTypes: true });\n  for (const entry of entries) {\n    if (entry.name === 'node_modules' || entry.name.startsWith('.')) continue;\n    const fullPath = path.join(dir, entry.name);\n    if (entry.isDirectory()) {\n      results = results.concat(listFiles(fullPath));\n    } else if (exts.has(path.extname(entry.name))) {\n      results.push(fullPath);\n    }\n  }\n  return results;\n};\n\nconst files = targetDirs.flatMap((dir) => (fs.existsSync(dir) ? listFiles(dir) : []));\n\nconst hrefRegex = /href\\s*=\\s*(?:\\{\\s*)?([\"'`])([^\"'`]+)\\1/gm;\nconst hrefTemplateRegex = /href\\s*=\\s*\\{\\s*`([^`]+)`\\s*\\}/gm;\nconst pushRegex = /router\\.push\\(\\s*(?:\\{\\s*)?([\"'`])([^\"'`]+)\\1/gm;\nconst pushTemplateRegex = /router\\.push\\(\\s*`([^`]+)`\\s*\\)/gm;\n\nconst references = new Map();\n\nconst addRef = (file, value, type) => {\n  if (!value.startsWith('/')) return;\n  const clean = value.split(/\\s/)[0];\n  if (!references.has(clean)) {\n    references.set(clean, []);\n  }\n  references.get(clean).push({ file: file.replace(process.cwd() + path.sep, ''), type, raw: value });\n};\n\nfiles.forEach((file) => {\n  const content = fs.readFileSync(file, 'utf8');\n  let match;\n  while ((match = hrefRegex.exec(content)) !== null) {\n    addRef(file, match[2], 'href');\n  }\n  while ((match = hrefTemplateRegex.exec(content)) !== null) {\n    addRef(file, match[1], 'href-template');\n  }\n  while ((match = pushRegex.exec(content)) !== null) {\n    addRef(file, match[2], 'router.push');\n  }\n  while ((match = pushTemplateRegex.exec(content)) !== null) {\n    addRef(file, match[1], 'router.push-template');\n  }\n});\n\nconst listPageFiles = (dir) => {\n  let results = [];\n  const entries = fs.readdirSync(dir, { withFileTypes: true });\n  for (const entry of entries) {\n    if (entry.name === 'node_modules' || entry.name.startsWith('.')) continue;\n    const fullPath = path.join(dir, entry.name);\n    if (entry.isDirectory()) {\n      results = results.concat(listPageFiles(fullPath));\n    } else if (entry.name === 'page.tsx') {\n      results.push(fullPath);\n    }\n  }\n  return results;\n};\n\nconst pageFiles = fs.existsSync('app') ? listPageFiles('app') : [];\nconst routePatterns = pageFiles.map((file) => {\n  const rel = path.relative('app', file).replace(/\\\\/g, '/');\n  const routePath = '/' + rel.replace(/\\/page\\.tsx$/, '').replace(/page\\.tsx$/, '');\n  const normalized = routePath === '/' ? '/' : routePath.replace(/\\/+/, '/');\n  const patternStr = '^' + normalized\n    .replace(/\\(.*?\\)\\//g, '')\n    .replace(/\\[\\.\\.\\.([^\\]]+)\\]/g, '(.+)')\n    .replace(/\\[([^\\]]+)\\]/g, '([^/]+)')\n    .replace(/\\//g, '\\\\/') + '$';\n  return { route: normalized === '' ? '/' : normalized, regex: new RegExp(patternStr) };\n});\n\nconst routeExists = (value) => {\n  const pathWithoutQuery = value.split('?')[0];\n  return routePatterns.some(({ regex }) => regex.test(pathWithoutQuery));\n};\n\nconst unresolved = [];\nfor (const [value, refs] of references.entries()) {\n  const hasTemplate = value.includes('${');\n  let testValue = value;\n  if (hasTemplate) {\n    testValue = value.replace(/\\$\\{[^}]+\\}/g, 'placeholder');\n  }\n  if (!routeExists(testValue)) {\n    unresolved.push({ value, refs });\n  }\n}\n\nfs.writeFileSync('link-audit.json', JSON.stringify({ totalReferences: references.size, unresolved }, null, 2));\nconsole.log('Audit saved to link-audit.json with', unresolved.length, 'unresolved references.');\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\manual-trigger-reminders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\migrate-subscription-to-teams.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\refactor-invoice.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\replace-unsplash-with-pexels.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3125,3128],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3125,3128],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":156,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5270,5273],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5270,5273],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour remplacer les images Unsplash cass√©es par des images Pexels\n * Utilise l'API Pexels pour g√©n√©rer de nouvelles images bas√©es sur le type de bien\n * \n * Usage: npm run replace-images\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport * as dotenv from \"dotenv\";\n\n// Charger les variables d'environnement\ndotenv.config({ path: \".env.local\" });\n\nconst PEXELS_API_KEY = \"3eFVqLX19mBYTUVCMxhpPH156xmJ8K5ccP5TBwH5R2h90pHMmgb638AS\";\nconst PEXELS_API_URL = \"https://api.pexels.com/v1/search\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n// Pour les scripts de maintenance, on DOIT utiliser la service role key pour bypasser RLS\n// L'anon key ne fonctionnera pas car elle n√©cessite une session d'authentification\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl) {\n  console.error(\"‚ùå Variable d'environnement manquante: NEXT_PUBLIC_SUPABASE_URL\");\n  process.exit(1);\n}\n\nif (!supabaseKey) {\n  console.error(\"‚ùå Variable d'environnement manquante: SUPABASE_SERVICE_ROLE_KEY\");\n  console.error(\"\\nüí° Pour les scripts de maintenance, vous DEVEZ utiliser SUPABASE_SERVICE_ROLE_KEY\");\n  console.error(\"   Cette cl√© se trouve dans votre dashboard Supabase ‚Üí Settings ‚Üí API ‚Üí service_role key\");\n  process.exit(1);\n}\n\n// Cr√©er le client avec la service role key pour bypasser RLS\n// Configuration pour un script de maintenance (pas d'auth n√©cessaire)\nconst supabase = createClient(supabaseUrl, supabaseKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false,\n    detectSessionInUrl: false,\n    storage: undefined, // D√©sactiver le stockage de session\n  },\n});\n\n// Mots-cl√©s de recherche Pexels bas√©s sur le type de bien\nconst getSearchQuery = (title: string, description: string, _type?: string): string => {\n  const text = `${title} ${description}`.toLowerCase();\n  \n  if (text.includes(\"terrain\") || text.includes(\"land\")) {\n    return \"empty land plot construction\";\n  }\n  if (text.includes(\"villa\") || text.includes(\"maison\") || text.includes(\"house\")) {\n    return \"modern white villa exterior\";\n  }\n  if (text.includes(\"appartement\") || text.includes(\"apartment\")) {\n    return \"modern apartment interior\";\n  }\n  if (text.includes(\"studio\")) {\n    return \"studio apartment interior design\";\n  }\n  if (text.includes(\"bureau\") || text.includes(\"office\")) {\n    return \"modern office space\";\n  }\n  if (text.includes(\"piscine\") || text.includes(\"pool\")) {\n    return \"luxury house with pool\";\n  }\n  \n  return \"modern real estate property\";\n};\n\n// R√©cup√©rer des images depuis Pexels\nasync function fetchPexelsImages(query: string, count: number = 3): Promise<string[]> {\n  try {\n    const response = await fetch(`${PEXELS_API_URL}?query=${encodeURIComponent(query)}&per_page=${count}`, {\n      headers: {\n        Authorization: PEXELS_API_KEY,\n      },\n    });\n\n    if (!response.ok) {\n      console.error(`Erreur Pexels API: ${response.statusText}`);\n      return [];\n    }\n\n    const data = await response.json();\n    // Utiliser les URLs Pexels directement (format: https://images.pexels.com/photos/...)\n    const images = data.photos?.map((photo: any) => {\n      // Pr√©f√©rer 'large' pour une bonne qualit√© sans √™tre trop lourd\n      // Format attendu: https://images.pexels.com/photos/ID/pexels-photo-ID.jpeg?auto=compress&cs=tinysrgb&w=1260\n      const url = photo.src?.large || photo.src?.original || photo.src?.medium;\n      if (url && typeof url === 'string') {\n        // S'assurer que l'URL est compl√®te\n        return url.startsWith('http') ? url : `https:${url}`;\n      }\n      return null;\n    }).filter((url: string | null): url is string => url !== null && url.length > 0) || [];\n    \n    if (images.length > 0) {\n      console.log(`   ‚úÖ ${images.length} images Pexels trouv√©es`);\n    }\n    return images;\n  } catch (error) {\n    console.error(`Erreur lors de la r√©cup√©ration des images Pexels:`, error);\n    return [];\n  }\n}\n\n// Remplacer les images Unsplash par des images Pexels\nasync function replaceUnsplashImages() {\n  console.log(\"üîç Recherche des propri√©t√©s avec des images Unsplash...\");\n\n  // R√©cup√©rer toutes les propri√©t√©s\n  const { data: properties, error } = await supabase\n    .from(\"properties\")\n    .select(\"id, title, description, images, details\");\n\n  if (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration des propri√©t√©s:\", error);\n    return;\n  }\n\n  if (!properties || properties.length === 0) {\n    console.log(\"‚ÑπÔ∏è Aucune propri√©t√© trouv√©e\");\n    return;\n  }\n\n  console.log(`üì¶ ${properties.length} propri√©t√©s trouv√©es`);\n\n  let updated = 0;\n  let skipped = 0;\n\n  for (const property of properties) {\n    const images = property.images as string[] | null;\n    \n    if (!images || !Array.isArray(images) || images.length === 0) {\n      skipped++;\n      continue;\n    }\n\n    // V√©rifier si des images Unsplash sont pr√©sentes\n    const hasUnsplash = images.some((img) => \n      typeof img === \"string\" && img.includes(\"unsplash.com\")\n    );\n\n    if (!hasUnsplash) {\n      skipped++;\n      continue;\n    }\n\n    console.log(`\\nüîÑ Traitement de: ${property.title}`);\n\n    // G√©n√©rer une requ√™te de recherche bas√©e sur le bien\n    const searchQuery = getSearchQuery(\n      property.title || \"\",\n      property.description || \"\",\n      (property.details as any)?.type\n    );\n\n    console.log(`   Recherche Pexels: \"${searchQuery}\"`);\n\n    // R√©cup√©rer de nouvelles images depuis Pexels\n    const newImages = await fetchPexelsImages(searchQuery, images.length);\n\n    if (newImages.length === 0) {\n      console.log(`   ‚ö†Ô∏è Aucune image Pexels trouv√©e, conservation des images existantes`);\n      skipped++;\n      continue;\n    }\n\n    // Remplacer les images Unsplash par les nouvelles images Pexels\n    const updatedImages = images.map((img, index) => {\n      if (typeof img === \"string\" && img.includes(\"unsplash.com\")) {\n        const pexelsImage = newImages[index % newImages.length];\n        if (pexelsImage && typeof pexelsImage === \"string\" && pexelsImage.length > 0) {\n          return pexelsImage;\n        }\n        // Si pas d'image Pexels disponible, garder l'original (sera remplac√© plus tard)\n        return img;\n      }\n      return img;\n    }).filter((img) => img && typeof img === \"string\" && img.length > 0); // Filtrer les images vides\n\n    // Mettre √† jour dans Supabase\n    const { error: updateError } = await supabase\n      .from(\"properties\")\n      .update({ images: updatedImages })\n      .eq(\"id\", property.id);\n\n    if (updateError) {\n      console.error(`   ‚ùå Erreur lors de la mise √† jour:`, updateError);\n    } else {\n      console.log(`   ‚úÖ ${updatedImages.length} images mises √† jour`);\n      updated++;\n    }\n\n    // Attendre un peu pour √©viter de surcharger l'API Pexels\n    await new Promise((resolve) => setTimeout(resolve, 1000));\n  }\n\n  console.log(`\\n‚ú® Termin√©! ${updated} propri√©t√©s mises √† jour, ${skipped} ignor√©es`);\n}\n\n// Ex√©cuter le script\nreplaceUnsplashImages()\n  .then(() => {\n    console.log(\"\\nüéâ Script termin√© avec succ√®s\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"\\n‚ùå Erreur fatale:\", error);\n    process.exit(1);\n  });\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\repro-real-data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\resend-tenant-magic-link.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2146,2149],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2146,2149],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3068,3071],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3068,3071],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":108,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3183,3186],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3183,3186],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5497,5500],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5497,5500],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script to resend a magic link to a tenant\r\n *\r\n * Usage:\r\n * 1. By lease ID:\r\n *    npx tsx scripts/resend-tenant-magic-link.ts <lease_id>\r\n *\r\n * 2. By tenant email:\r\n *    npx tsx scripts/resend-tenant-magic-link.ts --email <email>\r\n *\r\n * Examples:\r\n *   npx tsx scripts/resend-tenant-magic-link.ts 123e4567-e89b-12d3-a456-426614174000\r\n *   npx tsx scripts/resend-tenant-magic-link.ts --email tenant@example.com\r\n */\r\n\r\nimport { config } from \"dotenv\";\r\nimport { resolve } from \"path\";\r\n\r\n// Load environment variables from .env.local\r\nconfig({ path: resolve(process.cwd(), \".env.local\") });\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { generateTenantAccessToken, getTenantMagicLinkUrl } from \"../lib/tenant-magic-link\";\r\nimport { sendEmail } from \"../lib/mail\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nif (!supabaseUrl || !supabaseServiceKey) {\r\n  console.error(\"‚ùå Missing Supabase credentials\");\r\n  console.error(\"Make sure NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in .env.local\");\r\n  process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\nasync function resendMagicLinkByLeaseId(leaseId: string) {\r\n  console.log(`üîç Looking up lease: ${leaseId}`);\r\n\r\n  const { data: lease, error } = await supabase\r\n    .from(\"leases\")\r\n    .select(`\r\n      id,\r\n      tenant_name,\r\n      tenant_email,\r\n      status,\r\n      property_address,\r\n      property:properties (\r\n        title\r\n      )\r\n    `)\r\n    .eq(\"id\", leaseId)\r\n    .single();\r\n\r\n  if (error || !lease) {\r\n    console.error(\"‚ùå Lease not found:\", error?.message || \"No data returned\");\r\n    process.exit(1);\r\n  }\r\n\r\n  if (lease.status !== \"active\") {\r\n    console.error(`‚ùå Lease status is \"${lease.status}\" (must be \"active\")`);\r\n    process.exit(1);\r\n  }\r\n\r\n  if (!lease.tenant_email) {\r\n    console.error(\"‚ùå No email address for this tenant\");\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(`‚úÖ Found lease for: ${lease.tenant_name} (${lease.tenant_email})`);\r\n  console.log(`   Property: ${(lease.property as any)?.title || lease.property_address}`);\r\n\r\n  return { lease };\r\n}\r\n\r\nasync function resendMagicLinkByEmail(email: string) {\r\n  console.log(`üîç Looking up active leases for: ${email}`);\r\n\r\n  const { data: leases, error } = await supabase\r\n    .from(\"leases\")\r\n    .select(`\r\n      id,\r\n      tenant_name,\r\n      tenant_email,\r\n      status,\r\n      property_address,\r\n      property:properties (\r\n        title\r\n      )\r\n    `)\r\n    .eq(\"tenant_email\", email.toLowerCase().trim())\r\n    .eq(\"status\", \"active\")\r\n    .order(\"created_at\", { ascending: false });\r\n\r\n  if (error || !leases || leases.length === 0) {\r\n    console.error(\"‚ùå No active leases found for this email:\", error?.message || \"No data returned\");\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(`‚úÖ Found ${leases.length} active lease(s) for: ${leases[0].tenant_name}`);\r\n  leases.forEach((lease, idx) => {\r\n    console.log(`   ${idx + 1}. ${(lease.property as any)?.title || lease.property_address}`);\r\n  });\r\n\r\n  return { leases };\r\n}\r\n\r\nasync function sendMagicLink(lease: any) {\r\n  console.log(`\\nüîë Generating magic link token...`);\r\n  const token = await generateTenantAccessToken(lease.id);\r\n  const magicLink = getTenantMagicLinkUrl(token);\r\n\r\n  console.log(`‚úÖ Token generated (expires in 7 days)`);\r\n  console.log(`üîó Magic link: ${magicLink}`);\r\n\r\n  if (!lease.tenant_email) {\r\n    console.log(\"‚ö†Ô∏è  No email - skipping email send\");\r\n    return;\r\n  }\r\n\r\n  console.log(`\\nüìß Sending email to: ${lease.tenant_email}`);\r\n\r\n  await sendEmail({\r\n    to: lease.tenant_email,\r\n    subject: \"Invitation √† votre Espace Locataire - Dousell\",\r\n    html: `\r\n      <!DOCTYPE html>\r\n      <html>\r\n      <head>\r\n        <meta charset=\"utf-8\">\r\n        <style>\r\n          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }\r\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n          .header { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 30px 20px; border-radius: 8px 8px 0 0; }\r\n          .content { background: white; padding: 30px 20px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; }\r\n          .cta-button { display: inline-block; padding: 14px 32px; background-color: #F4C430; color: black; text-decoration: none; border-radius: 8px; font-weight: 600; margin: 20px 0; }\r\n          .cta-button:hover { background-color: #d4a520; }\r\n          .features { background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }\r\n          .features ul { margin: 10px 0; padding-left: 20px; }\r\n          .features li { margin: 8px 0; }\r\n          .footer { text-align: center; color: #6b7280; font-size: 12px; margin-top: 30px; }\r\n        </style>\r\n      </head>\r\n      <body>\r\n        <div class=\"container\">\r\n          <div class=\"header\">\r\n            <h1 style=\"margin: 0; font-size: 24px;\">Bienvenue sur votre Espace Locataire</h1>\r\n          </div>\r\n          <div class=\"content\">\r\n            <p style=\"font-size: 16px;\">Bonjour <strong>${lease.tenant_name}</strong>,</p>\r\n\r\n            <p>Vous avez √©t√© invit√© √† acc√©der √† votre espace locataire personnel pour le bien situ√© √† :</p>\r\n            <p style=\"background: #f3f4f6; padding: 12px; border-radius: 6px; font-weight: 600;\">\r\n              üìç ${(lease.property as any)?.title || lease.property_address || \"Votre logement\"}\r\n            </p>\r\n\r\n            <div class=\"features\">\r\n              <p style=\"font-weight: 600; margin-bottom: 10px;\">Depuis votre espace, vous pourrez :</p>\r\n              <ul>\r\n                <li>üí≥ Payer votre loyer en ligne</li>\r\n                <li>üìÑ T√©l√©charger vos quittances</li>\r\n                <li>üîß Signaler des probl√®mes de maintenance</li>\r\n                <li>üí¨ Communiquer avec votre propri√©taire</li>\r\n                <li>üìã Acc√©der √† vos documents de location</li>\r\n              </ul>\r\n            </div>\r\n\r\n            <div style=\"text-align: center;\">\r\n              <a href=\"${magicLink}\" class=\"cta-button\">Acc√©der √† mon espace locataire</a>\r\n            </div>\r\n\r\n            <p style=\"color: #6b7280; font-size: 13px; text-align: center; margin-top: 15px;\">\r\n              Le lien ne fonctionne pas ? Copiez et collez cette URL dans votre navigateur :<br>\r\n              <code style=\"background: #f3f4f6; padding: 8px; display: inline-block; margin-top: 5px; word-break: break-all; font-size: 11px;\">${magicLink}</code>\r\n            </p>\r\n\r\n            <p style=\"color: #6b7280; font-size: 14px; margin-top: 20px;\">\r\n              ‚è∞ Ce lien d'acc√®s est personnel et valide pour <strong>7 jours</strong>.<br>\r\n              üîí Pour votre s√©curit√©, vous devrez v√©rifier votre identit√© lors de votre premi√®re connexion.\r\n            </p>\r\n\r\n            <p style=\"color: #6b7280; font-size: 14px; border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 30px;\">\r\n              Si vous n'√™tes pas √† l'origine de cette demande, vous pouvez ignorer cet email.\r\n            </p>\r\n          </div>\r\n          <div class=\"footer\">\r\n            <p>¬© ${new Date().getFullYear()} Dousell Immo - Gestion Locative</p>\r\n            <p>Cet email a √©t√© envoy√© automatiquement, merci de ne pas y r√©pondre.</p>\r\n          </div>\r\n        </div>\r\n      </body>\r\n      </html>\r\n    `,\r\n  });\r\n\r\n  console.log(\"‚úÖ Email sent successfully!\");\r\n}\r\n\r\nasync function main() {\r\n  const args = process.argv.slice(2);\r\n\r\n  if (args.length === 0) {\r\n    console.error(\"‚ùå Missing argument\\n\");\r\n    console.log(\"Usage:\");\r\n    console.log(\"  By lease ID:    npx tsx scripts/resend-tenant-magic-link.ts <lease_id>\");\r\n    console.log(\"  By email:       npx tsx scripts/resend-tenant-magic-link.ts --email <email>\\n\");\r\n    console.log(\"Examples:\");\r\n    console.log(\"  npx tsx scripts/resend-tenant-magic-link.ts 123e4567-e89b-12d3-a456-426614174000\");\r\n    console.log(\"  npx tsx scripts/resend-tenant-magic-link.ts --email tenant@example.com\");\r\n    process.exit(1);\r\n  }\r\n\r\n  try {\r\n    if (args[0] === \"--email\" || args[0] === \"-e\") {\r\n      if (!args[1]) {\r\n        console.error(\"‚ùå Email address required\");\r\n        process.exit(1);\r\n      }\r\n\r\n      const { leases } = await resendMagicLinkByEmail(args[1]);\r\n\r\n      // Send magic link for each lease\r\n      for (let i = 0; i < leases.length; i++) {\r\n        console.log(`\\n${\"=\".repeat(60)}`);\r\n        console.log(`Processing lease ${i + 1}/${leases.length}`);\r\n        console.log(\"=\".repeat(60));\r\n        await sendMagicLink(leases[i]);\r\n      }\r\n\r\n      if (leases.length > 1) {\r\n        console.log(`\\n‚úÖ Sent ${leases.length} magic links to ${args[1]}`);\r\n      }\r\n    } else {\r\n      const leaseId = args[0];\r\n      const { lease } = await resendMagicLinkByLeaseId(leaseId);\r\n      await sendMagicLink(lease);\r\n    }\r\n\r\n    console.log(\"\\nüéâ All done!\");\r\n  } catch (error) {\r\n    console.error(\"\\n‚ùå Error:\", error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\reset-reminder-flags.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1339,1342],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1339,1342],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2254,2257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2254,2257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Script pour r√©initialiser les flags reminder_sent\n// Utilise le client admin pour bypasser RLS\n\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseKey) {\n    console.error('‚ùå Variables d\\'environnement manquantes');\n    console.log('Ajoutez dans votre terminal:');\n    console.log('export NEXT_PUBLIC_SUPABASE_URL=\"https://xxx.supabase.co\"');\n    console.log('export SUPABASE_SERVICE_ROLE_KEY=\"eyJxxx...\"');\n    process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey, {\n    auth: {\n        autoRefreshToken: false,\n        persistSession: false\n    }\n});\n\nasync function resetReminderFlags() {\n    console.log('\\n=== RESET REMINDER FLAGS ===\\n');\n\n    // 1. V√©rifier l'√©tat actuel\n    const { data: before, error: beforeError } = await supabase\n        .from('rental_transactions')\n        .select('id, period_month, period_year, status, reminder_sent, leases(tenant_name)')\n        .eq('period_month', 12)\n        .eq('period_year', 2025)\n        .neq('status', 'paid');\n\n    if (beforeError) {\n        console.error('Erreur:', beforeError);\n        return;\n    }\n\n    console.log(`Transactions non pay√©es trouv√©es: ${before.length}\\n`);\n    before.forEach((tx: any) => {\n        console.log(`- ${tx.leases?.tenant_name || 'Inconnu'}: reminder_sent = ${tx.reminder_sent}`);\n    });\n\n    // 2. Reset tous les flags reminder_sent √† false\n    const { error: updateError } = await supabase\n        .from('rental_transactions')\n        .update({ reminder_sent: false })\n        .eq('period_month', 12)\n        .eq('period_year', 2025)\n        .neq('status', 'paid');\n\n    if (updateError) {\n        console.error('\\n‚ùå Erreur lors du reset:', updateError);\n        return;\n    }\n\n    console.log('\\n‚úÖ Flags reminder_sent r√©initialis√©s avec succ√®s!');\n\n    // 3. V√©rifier le r√©sultat\n    const { data: after } = await supabase\n        .from('rental_transactions')\n        .select('id, reminder_sent, leases(tenant_name)')\n        .eq('period_month', 12)\n        .eq('period_year', 2025)\n        .neq('status', 'paid');\n\n    console.log('\\n√âtat apr√®s reset:');\n    after?.forEach((tx: any) => {\n        console.log(`- ${tx.leases?.tenant_name || 'Inconnu'}: reminder_sent = ${tx.reminder_sent}`);\n    });\n\n    console.log('\\n=== TERMIN√â ===\\n');\n}\n\nresetReminderFlags();\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\reset-reminders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\resize-desktop-screenshot.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":12,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":12,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":13,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":13,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":30,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":30,"endColumn":31}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Script pour recadrer le screenshot desktop √† 1879x817px\r\n * \r\n * Ce script utilise Sharp pour recadrer l'image √† la taille correcte\r\n * qui respecte le ratio PWA de 2.3:1\r\n * \r\n * Usage:\r\n *   npm install sharp --save-dev\r\n *   node scripts/resize-desktop-screenshot.js\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst INPUT_PATH = path.join(__dirname, '../public/screenshots/desktop-home.png');\r\nconst OUTPUT_PATH = path.join(__dirname, '../public/screenshots/desktop-home.png');\r\nconst TEMP_PATH = path.join(__dirname, '../public/screenshots/desktop-home-temp.png');\r\n\r\nasync function resizeScreenshot() {\r\n  try {\r\n    // V√©rifier si l'image existe\r\n    if (!fs.existsSync(INPUT_PATH)) {\r\n      console.error('‚ùå Erreur: Le fichier desktop-home.png n\\'existe pas √†:', INPUT_PATH);\r\n      process.exit(1);\r\n    }\r\n\r\n    // V√©rifier si sharp est disponible\r\n    let sharp;\r\n    try {\r\n      sharp = require('sharp');\r\n    } catch (_error) {\r\n      console.error('‚ùå Erreur: Le package \"sharp\" n\\'est pas install√©.');\r\n      console.error('\\nüì¶ Installation requise:');\r\n      console.error('   npm install sharp --save-dev');\r\n      console.error('\\nüí° Alternative manuelle:');\r\n      console.error('   1. Ouvrez desktop-home.png dans un √©diteur d\\'images');\r\n      console.error('   2. Recadrez √† 1879x817px');\r\n      console.error('   3. Sauvegardez');\r\n      process.exit(1);\r\n    }\r\n\r\n    console.log('üñºÔ∏è  Recadrage du screenshot desktop...\\n');\r\n\r\n    // Recadrer l'image √† 1879x817px (utiliser un fichier temporaire)\r\n    await sharp(INPUT_PATH)\r\n      .resize(1879, 817, {\r\n        fit: 'cover', // Couvre la zone (peut couper un peu)\r\n        position: 'center', // Centre l'image\r\n      })\r\n      .png()\r\n      .toFile(TEMP_PATH);\r\n\r\n    // Remplacer l'ancien fichier par le nouveau\r\n    fs.unlinkSync(INPUT_PATH);\r\n    fs.renameSync(TEMP_PATH, OUTPUT_PATH);\r\n\r\n    console.log('‚úÖ Screenshot recadr√© avec succ√®s !');\r\n    console.log('   Taille: 1879x817px');\r\n    console.log('   Ratio: 2.3:1 ‚úÖ');\r\n    console.log('\\nüìã Prochaines √©tapes:');\r\n    console.log('   1. V√©rifiez dans Chrome DevTools ‚Üí Application ‚Üí Manifest');\r\n    console.log('   2. L\\'avertissement de mismatch devrait dispara√Ætre');\r\n    console.log('   3. L\\'erreur de ratio est d√©j√† r√©solue');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Erreur lors du recadrage:', error.message);\r\n    console.error('\\nüí° Voir docs/SOLUTION-SCREENSHOT-DESKTOP.md pour d\\'autres m√©thodes');\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Ex√©cuter\r\nresizeScreenshot();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\revoke-and-resend-tenant-link.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":76,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2433,2436],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2433,2436],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":128,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4206,4209],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4206,4209],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4357,4360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4357,4360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":201,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7493,7496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7493,7496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Revoke existing tenant token and send a fresh magic link\r\n *\r\n * This script is useful when:\r\n * - A tenant lost their previous link\r\n * - A token needs to be invalidated for security reasons\r\n * - You want to ensure a clean state before sending a new invitation\r\n *\r\n * Usage:\r\n *   npx tsx scripts/revoke-and-resend-tenant-link.ts <lease_id>\r\n *   npx tsx scripts/revoke-and-resend-tenant-link.ts --email <email>\r\n *\r\n * Examples:\r\n *   npx tsx scripts/revoke-and-resend-tenant-link.ts 123e4567-e89b-12d3-a456-426614174000\r\n *   npx tsx scripts/revoke-and-resend-tenant-link.ts --email tenant@example.com\r\n */\r\n\r\nimport { config } from \"dotenv\";\r\nimport { resolve } from \"path\";\r\n\r\n// Load environment variables from .env.local\r\nconfig({ path: resolve(process.cwd(), \".env.local\") });\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { generateTenantAccessToken, getTenantMagicLinkUrl, revokeTenantToken } from \"../lib/tenant-magic-link\";\r\nimport { sendEmail } from \"../lib/mail\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nif (!supabaseUrl || !supabaseServiceKey) {\r\n  console.error(\"‚ùå Missing Supabase credentials\");\r\n  console.error(\"Make sure NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in .env.local\");\r\n  process.exit(1);\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n\r\nasync function revokeLease(leaseId: string) {\r\n  console.log(`üîç Looking up lease: ${leaseId}`);\r\n\r\n  const { data: lease, error } = await supabase\r\n    .from(\"leases\")\r\n    .select(`\r\n      id,\r\n      tenant_name,\r\n      tenant_email,\r\n      status,\r\n      property_address,\r\n      tenant_access_token,\r\n      tenant_token_verified,\r\n      tenant_token_expires_at,\r\n      property:properties (\r\n        title\r\n      )\r\n    `)\r\n    .eq(\"id\", leaseId)\r\n    .single();\r\n\r\n  if (error || !lease) {\r\n    console.error(\"‚ùå Lease not found:\", error?.message || \"No data returned\");\r\n    process.exit(1);\r\n  }\r\n\r\n  if (lease.status !== \"active\") {\r\n    console.error(`‚ùå Lease status is \"${lease.status}\" (must be \"active\")`);\r\n    process.exit(1);\r\n  }\r\n\r\n  if (!lease.tenant_email) {\r\n    console.error(\"‚ùå No email address for this tenant\");\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(`‚úÖ Found lease for: ${lease.tenant_name} (${lease.tenant_email})`);\r\n  console.log(`   Property: ${(lease.property as any)?.title || lease.property_address}`);\r\n\r\n  // Show current token status\r\n  if (lease.tenant_access_token) {\r\n    const isExpired = lease.tenant_token_expires_at\r\n      ? new Date(lease.tenant_token_expires_at) < new Date()\r\n      : true;\r\n    const isVerified = lease.tenant_token_verified || false;\r\n\r\n    console.log(`\\nüìä Current token status:`);\r\n    console.log(`   Has token:    ‚úÖ Yes`);\r\n    console.log(`   Verified:     ${isVerified ? \"‚úÖ Yes\" : \"‚ùå No\"}`);\r\n    console.log(`   Status:       ${isExpired ? \"‚ö†Ô∏è  Expired\" : \"‚úÖ Valid\"}`);\r\n    if (lease.tenant_token_expires_at) {\r\n      console.log(`   Expires at:   ${new Date(lease.tenant_token_expires_at).toLocaleString(\"fr-FR\")}`);\r\n    }\r\n  } else {\r\n    console.log(`\\nüìä Current token status: ‚ùå No token exists`);\r\n  }\r\n\r\n  return { lease };\r\n}\r\n\r\nasync function revokeLeasesByEmail(email: string) {\r\n  console.log(`üîç Looking up active leases for: ${email}`);\r\n\r\n  const { data: leases, error } = await supabase\r\n    .from(\"leases\")\r\n    .select(`\r\n      id,\r\n      tenant_name,\r\n      tenant_email,\r\n      status,\r\n      property_address,\r\n      tenant_access_token,\r\n      tenant_token_verified,\r\n      property:properties (\r\n        title\r\n      )\r\n    `)\r\n    .eq(\"tenant_email\", email.toLowerCase().trim())\r\n    .eq(\"status\", \"active\")\r\n    .order(\"created_at\", { ascending: false });\r\n\r\n  if (error || !leases || leases.length === 0) {\r\n    console.error(\"‚ùå No active leases found for this email:\", error?.message || \"No data returned\");\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log(`‚úÖ Found ${leases.length} active lease(s) for: ${leases[0].tenant_name}`);\r\n  leases.forEach((lease, idx) => {\r\n    const hasToken = !!lease.tenant_access_token;\r\n    console.log(`   ${idx + 1}. ${(lease.property as any)?.title || lease.property_address} ${hasToken ? \"üîë\" : \"‚ùå\"}`);\r\n  });\r\n\r\n  return { leases };\r\n}\r\n\r\nasync function revokeAndResendMagicLink(lease: any) {\r\n  const leaseId = lease.id;\r\n\r\n  // Step 1: Revoke existing token (if any)\r\n  if (lease.tenant_access_token) {\r\n    console.log(`\\nüîí Revoking existing token...`);\r\n    await revokeTenantToken(leaseId);\r\n    console.log(`‚úÖ Token revoked successfully`);\r\n  } else {\r\n    console.log(`\\n‚ÑπÔ∏è  No existing token to revoke`);\r\n  }\r\n\r\n  // Step 2: Generate new token\r\n  console.log(`\\nüîë Generating new magic link token...`);\r\n  const token = await generateTenantAccessToken(leaseId);\r\n  const magicLink = getTenantMagicLinkUrl(token);\r\n\r\n  console.log(`‚úÖ New token generated (expires in 7 days)`);\r\n  console.log(`üîó Magic link: ${magicLink}`);\r\n\r\n  if (!lease.tenant_email) {\r\n    console.log(\"‚ö†Ô∏è  No email - skipping email send\");\r\n    return;\r\n  }\r\n\r\n  // Step 3: Send invitation email\r\n  console.log(`\\nüìß Sending invitation email to: ${lease.tenant_email}`);\r\n\r\n  await sendEmail({\r\n    to: lease.tenant_email,\r\n    subject: \"Invitation √† votre Espace Locataire - Dousell\",\r\n    html: `\r\n      <!DOCTYPE html>\r\n      <html>\r\n      <head>\r\n        <meta charset=\"utf-8\">\r\n        <style>\r\n          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }\r\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n          .header { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 30px 20px; border-radius: 8px 8px 0 0; }\r\n          .content { background: white; padding: 30px 20px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; }\r\n          .cta-button { display: inline-block; padding: 14px 32px; background-color: #F4C430; color: black; text-decoration: none; border-radius: 8px; font-weight: 600; margin: 20px 0; }\r\n          .cta-button:hover { background-color: #d4a520; }\r\n          .features { background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }\r\n          .features ul { margin: 10px 0; padding-left: 20px; }\r\n          .features li { margin: 8px 0; }\r\n          .alert { background: #fef3c7; border: 1px solid #fbbf24; padding: 12px; border-radius: 6px; margin: 20px 0; }\r\n          .footer { text-align: center; color: #6b7280; font-size: 12px; margin-top: 30px; }\r\n        </style>\r\n      </head>\r\n      <body>\r\n        <div class=\"container\">\r\n          <div class=\"header\">\r\n            <h1 style=\"margin: 0; font-size: 24px;\">Bienvenue sur votre Espace Locataire</h1>\r\n          </div>\r\n          <div class=\"content\">\r\n            <p style=\"font-size: 16px;\">Bonjour <strong>${lease.tenant_name}</strong>,</p>\r\n\r\n            ${lease.tenant_access_token ? `\r\n            <div class=\"alert\">\r\n              <strong>‚ö†Ô∏è Nouveau lien d'acc√®s</strong><br>\r\n              Votre pr√©c√©dent lien a √©t√© r√©voqu√©. Utilisez ce nouveau lien pour acc√©der √† votre espace.\r\n            </div>\r\n            ` : \"\"}\r\n\r\n            <p>Vous avez √©t√© invit√© √† acc√©der √† votre espace locataire personnel pour le bien situ√© √† :</p>\r\n            <p style=\"background: #f3f4f6; padding: 12px; border-radius: 6px; font-weight: 600;\">\r\n              üìç ${(lease.property as any)?.title || lease.property_address || \"Votre logement\"}\r\n            </p>\r\n\r\n            <div class=\"features\">\r\n              <p style=\"font-weight: 600; margin-bottom: 10px;\">Depuis votre espace, vous pourrez :</p>\r\n              <ul>\r\n                <li>üí≥ Payer votre loyer en ligne</li>\r\n                <li>üìÑ T√©l√©charger vos quittances</li>\r\n                <li>üîß Signaler des probl√®mes de maintenance</li>\r\n                <li>üí¨ Communiquer avec votre propri√©taire</li>\r\n                <li>üìã Acc√©der √† vos documents de location</li>\r\n              </ul>\r\n            </div>\r\n\r\n            <div style=\"text-align: center;\">\r\n              <a href=\"${magicLink}\" class=\"cta-button\">Acc√©der √† mon espace locataire</a>\r\n            </div>\r\n\r\n            <p style=\"color: #6b7280; font-size: 14px; margin-top: 20px;\">\r\n              ‚è∞ Ce lien d'acc√®s est personnel et valide pour <strong>7 jours</strong>.<br>\r\n              üîí Pour votre s√©curit√©, vous devrez v√©rifier votre identit√© lors de votre premi√®re connexion.\r\n            </p>\r\n\r\n            <p style=\"color: #6b7280; font-size: 14px; border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 30px;\">\r\n              Si vous n'√™tes pas √† l'origine de cette demande, vous pouvez ignorer cet email.\r\n            </p>\r\n          </div>\r\n          <div class=\"footer\">\r\n            <p>¬© ${new Date().getFullYear()} Dousell Immo - Gestion Locative</p>\r\n            <p>Cet email a √©t√© envoy√© automatiquement, merci de ne pas y r√©pondre.</p>\r\n          </div>\r\n        </div>\r\n      </body>\r\n      </html>\r\n    `,\r\n  });\r\n\r\n  console.log(\"‚úÖ Email sent successfully!\");\r\n}\r\n\r\nasync function main() {\r\n  const args = process.argv.slice(2);\r\n\r\n  if (args.length === 0 || args.includes(\"--help\") || args.includes(\"-h\")) {\r\n    console.log(\"Usage:\");\r\n    console.log(\"  Revoke and resend by lease ID:\");\r\n    console.log(\"    npx tsx scripts/revoke-and-resend-tenant-link.ts <lease_id>\\n\");\r\n    console.log(\"  Revoke and resend by email:\");\r\n    console.log(\"    npx tsx scripts/revoke-and-resend-tenant-link.ts --email <email>\\n\");\r\n    console.log(\"Examples:\");\r\n    console.log(\"  npx tsx scripts/revoke-and-resend-tenant-link.ts 123e4567-e89b-12d3-a456-426614174000\");\r\n    console.log(\"  npx tsx scripts/revoke-and-resend-tenant-link.ts --email tenant@example.com\\n\");\r\n    console.log(\"What this script does:\");\r\n    console.log(\"  1. Finds the lease(s) for the specified tenant\");\r\n    console.log(\"  2. Revokes any existing magic link token (invalidates it)\");\r\n    console.log(\"  3. Generates a fresh new token (valid for 7 days)\");\r\n    console.log(\"  4. Sends an invitation email with the new magic link\");\r\n    process.exit(args.length === 0 ? 1 : 0);\r\n  }\r\n\r\n  try {\r\n    if (args[0] === \"--email\" || args[0] === \"-e\") {\r\n      if (!args[1]) {\r\n        console.error(\"‚ùå Email address required\");\r\n        process.exit(1);\r\n      }\r\n\r\n      const { leases } = await revokeLeasesByEmail(args[1]);\r\n\r\n      // Process each lease\r\n      for (let i = 0; i < leases.length; i++) {\r\n        console.log(`\\n${\"=\".repeat(60)}`);\r\n        console.log(`Processing lease ${i + 1}/${leases.length}`);\r\n        console.log(\"=\".repeat(60));\r\n        await revokeAndResendMagicLink(leases[i]);\r\n      }\r\n\r\n      if (leases.length > 1) {\r\n        console.log(`\\n‚úÖ Revoked and sent ${leases.length} new magic links to ${args[1]}`);\r\n      }\r\n    } else {\r\n      const leaseId = args[0];\r\n      const { lease } = await revokeLease(leaseId);\r\n      await revokeAndResendMagicLink(lease);\r\n    }\r\n\r\n    console.log(\"\\nüéâ All done!\");\r\n    console.log(\"\\nüí° The tenant will receive an email with a fresh magic link.\");\r\n    console.log(\"   Their previous link (if any) is now invalid.\");\r\n  } catch (error) {\r\n    console.error(\"\\n‚ùå Error:\", error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\run-migration-rental-fields.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\run-migration.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\scan-ui.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\setup-storage-policies.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\setup-stripe-test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[463,466],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[463,466],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2215,2218],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2215,2218],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Stripe from 'stripe';\r\nimport * as dotenv from 'dotenv';\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\n\r\ndotenv.config({ path: '.env.local' });\r\n\r\nconst stripeKey = process.env.STRIPE_SECRET_KEY;\r\n\r\nif (!stripeKey || stripeKey.startsWith('sk_test_placeholder')) {\r\n    console.error('‚ùå STRIPE_SECRET_KEY is missing or invalid in .env.local');\r\n    process.exit(1);\r\n}\r\n\r\nconst stripe = new Stripe(stripeKey, {\r\n    apiVersion: '2024-06-20' as any,\r\n});\r\n\r\nasync function setup() {\r\n    console.log('üöÄ Setting up Stripe test products and prices...');\r\n\r\n    try {\r\n        // 1. Create Starter Product\r\n        const starterProduct = await stripe.products.create({\r\n            name: 'Dousell Starter',\r\n            description: 'Gestion locative jusqu\\'√† 10 biens',\r\n        });\r\n\r\n        const starterPrice = await stripe.prices.create({\r\n            product: starterProduct.id,\r\n            unit_amount: 15000,\r\n            currency: 'xof',\r\n            recurring: { interval: 'month' },\r\n        });\r\n\r\n        console.log(`‚úÖ Starter Price Created: ${starterPrice.id}`);\r\n\r\n        // 2. Create Pro Product\r\n        const proProduct = await stripe.products.create({\r\n            name: 'Dousell Pro',\r\n            description: 'Gestion locative - Biens illimit√©s',\r\n        });\r\n\r\n        const proPrice = await stripe.prices.create({\r\n            product: proProduct.id,\r\n            unit_amount: 35000,\r\n            currency: 'xof',\r\n            recurring: { interval: 'month' },\r\n        });\r\n\r\n        console.log(`‚úÖ Pro Price Created: ${proPrice.id}`);\r\n\r\n        // Update .env.local\r\n        const envPath = path.join(process.cwd(), '.env.local');\r\n        let envContent = fs.readFileSync(envPath, 'utf8');\r\n\r\n        envContent = envContent.replace(\r\n            /NEXT_PUBLIC_STRIPE_PRICE_STARTER=.*/,\r\n            `NEXT_PUBLIC_STRIPE_PRICE_STARTER=${starterPrice.id}`\r\n        );\r\n        envContent = envContent.replace(\r\n            /NEXT_PUBLIC_STRIPE_PRICE_PRO=.*/,\r\n            `NEXT_PUBLIC_STRIPE_PRICE_PRO=${proPrice.id}`\r\n        );\r\n\r\n        fs.writeFileSync(envPath, envContent);\r\n        console.log('‚úÖ .env.local updated with real Price IDs!');\r\n\r\n    } catch (error: any) {\r\n        console.error('‚ùå Error setting up Stripe:', error.message);\r\n    }\r\n}\r\n\r\nsetup();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\setup-stripe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\sync-rented-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-contract-generation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-cron-monthly-rentals.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-email.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-lease-expirations.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[911,914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[911,914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script de test: V√©rifier le syst√®me d'alertes de fin de bail\n * Usage: npx tsx scripts/test-lease-expirations.ts\n */\n\nimport { checkLeaseExpirations } from '@/lib/lease-expiration-service';\nimport dotenv from 'dotenv';\n\n// Charger les variables d'environnement\ndotenv.config({ path: '.env.local' });\n\nasync function testLeaseExpirations() {\n    console.log('üß™ Test du syst√®me d\\'alertes de fin de bail...\\n');\n\n    try {\n        const result = await checkLeaseExpirations();\n\n        console.log('\\nüìä R√©sultats:');\n        console.log(`   - Alertes envoy√©es: ${result.count}`);\n        console.log(`   - Message: ${result.message}`);\n\n        if (result.errors && result.errors.length > 0) {\n            console.log(`   - Erreurs: ${result.errors.length}`);\n            console.error('   D√©tails des erreurs:', result.errors);\n        }\n\n        console.log('\\n‚úÖ Test termin√© !');\n\n    } catch (error: any) {\n        console.error('‚ùå Erreur lors du test:', error.message);\n        console.error(error);\n        process.exit(1);\n    }\n}\n\ntestLeaseExpirations();\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-n8n-webhook.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-onesignal-config.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[482,485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[482,485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { config } from \"dotenv\";\r\nimport { resolve } from \"path\";\r\n\r\n// Load environment variables\r\nconfig({ path: resolve(process.cwd(), \".env.local\") });\r\n\r\nconst ONESIGNAL_APP_ID = process.env.NEXT_PUBLIC_ONESIGNAL_APP_ID;\r\nconst ONESIGNAL_REST_API_KEY = process.env.ONESIGNAL_REST_API_KEY;\r\n\r\nif (!ONESIGNAL_APP_ID || !ONESIGNAL_REST_API_KEY) {\r\n    console.error(\"‚ùå Mising OneSignal Cloud Config\");\r\n    process.exit(1);\r\n}\r\n\r\nasync function testPayload(name: string, payload: any) {\r\n    console.log(`\\nTesting ${name}...`);\r\n    try {\r\n        const response = await fetch(\"https://onesignal.com/api/v1/notifications\", {\r\n            method: \"POST\",\r\n            headers: {\r\n                \"Content-Type\": \"application/json\",\r\n                Authorization: `Basic ${ONESIGNAL_REST_API_KEY}`,\r\n            },\r\n            body: JSON.stringify(payload),\r\n        });\r\n\r\n        const data = await response.json();\r\n        console.log(`[${name}] Status: ${response.status}`);\r\n        console.log(`[${name}] Recipients: ${data.recipients || 0}`);\r\n        console.log(`[${name}] ID: ${data.id || \"N/A\"}`);\r\n        if (data.errors) console.log(`[${name}] Errors:`, data.errors);\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    }\r\n}\r\n\r\nasync function run() {\r\n    const testUserId = \"test-user-id-\" + Date.now();\r\n\r\n    // 1. Legacy Payload\r\n    await testPayload(\"Legacy (include_external_user_ids)\", {\r\n        app_id: ONESIGNAL_APP_ID,\r\n        include_external_user_ids: [testUserId],\r\n        contents: { en: \"Test Legacy\" },\r\n    });\r\n\r\n    // 2. New Payload\r\n    await testPayload(\"New (include_aliases)\", {\r\n        app_id: ONESIGNAL_APP_ID,\r\n        include_aliases: {\r\n            external_id: [testUserId]\r\n        },\r\n        target_channel: \"push\",\r\n        contents: { en: \"Test New\" },\r\n    });\r\n}\r\n\r\nrun();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\test-signup-flow.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\trigger_catch_up_v2.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":30},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nconst https = require('http');\r\nrequire('dotenv').config({ path: '.env.local' });\r\n\r\nconst options = {\r\n    hostname: 'localhost',\r\n    port: 3000,\r\n    path: '/api/admin/catch-up-ged',\r\n    method: 'POST',\r\n    headers: {\r\n        'x-admin-secret': process.env.SUPABASE_SERVICE_ROLE_KEY,\r\n        'Content-Type': 'application/json'\r\n    }\r\n};\r\n\r\nconsole.log(\"Triggering catch-up API...\");\r\n\r\nconst req = https.request(options, (res) => {\r\n    let data = '';\r\n    res.on('data', (chunk) => { data += chunk; });\r\n    res.on('end', () => {\r\n        console.log(\"Response status:\", res.statusCode);\r\n        console.log(\"Response data:\", data);\r\n    });\r\n});\r\n\r\nreq.on('error', (e) => {\r\n    console.error(\"Error triggering API:\", e.message);\r\n});\r\n\r\nreq.end();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\update-coordinates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-current-state.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-kpis-calculation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-otp-fix.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-rpc-anon.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[946,949],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[946,949],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport dotenv from 'dotenv';\r\n\r\ndotenv.config({ path: '.env.local' });\r\n\r\n// FORCE USE OF ANON KEY ONLY\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n\r\nconsole.log(\"Using Anon Key:\", anonKey ? \"YES (Found)\" : \"NO\");\r\n\r\nconst supabase = createClient(supabaseUrl, anonKey);\r\n\r\nasync function testRpc() {\r\n    console.log(\"--- TESTING RPC WITH ANON KEY ---\");\r\n    const { data, error } = await supabase.rpc('get_active_cities_and_types', { min_count: 1 });\r\n\r\n    if (error) {\r\n        console.error(\"RPC FAILED:\", error);\r\n    } else {\r\n        console.log(\"RPC SUCCESS. Rows:\", data?.length);\r\n        if (data && data.length > 0) {\r\n            const first = data[0];\r\n            console.log(\"First City:\", JSON.stringify(first.city));\r\n            console.log(\"First City Codes:\", first.city.split('').map((c: any) => c.charCodeAt(0)));\r\n        }\r\n    }\r\n}\r\n\r\ntestRpc();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\scripts\\verify-storage-policies.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1263,1266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1263,1266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2047,2050],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2047,2050],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Script pour v√©rifier que les Storage Policies sont bien appliqu√©es\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { config } from \"dotenv\";\n\n// Charger les variables d'environnement\nconfig({ path: \".env.local\" });\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  console.error(\"‚ùå Variables d'environnement manquantes\");\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseServiceKey);\n\nasync function main() {\n  console.log(\"üîç V√©rification des Storage Policies pour verification-docs\\n\");\n\n  // Requ√™te pour lister les policies sur storage.objects\n  const { data: policies, error } = await supabase.rpc(\"exec_sql\", {\n    sql: `\n      SELECT\n        polname as policy_name,\n        polcmd as policy_command,\n        CASE polcmd\n          WHEN 'r' THEN 'SELECT'\n          WHEN 'a' THEN 'INSERT'\n          WHEN 'w' THEN 'UPDATE'\n          WHEN 'd' THEN 'DELETE'\n          ELSE 'ALL'\n        END as operation\n      FROM pg_policy\n      WHERE polrelid = 'storage.objects'::regclass\n      AND polname LIKE '%verification-docs%' OR polname LIKE '%Users can%'\n      ORDER BY polname;\n    `,\n  }) as any;\n\n  if (error) {\n    console.log(\"‚ö†Ô∏è  Impossible de lister les policies via RPC\");\n    console.log(\"   V√©rification manuelle requise dans le Dashboard Supabase\\n\");\n\n    console.log(\"üìù Pour v√©rifier manuellement:\");\n    console.log(\"   1. Ouvrir: \" + supabaseUrl.replace(\"/rest/v1\", \"\") + \"/storage/buckets/verification-docs\");\n    console.log(\"   2. Cliquer sur 'Policies'\");\n    console.log(\"   3. V√©rifier que vous voyez ces 3 policies:\\n\");\n\n    console.log(\"   ‚úÖ Policy 1: 'Users can upload to own folder' (INSERT)\");\n    console.log(\"   ‚úÖ Policy 2: 'Users can view own files or admins can view all' (SELECT)\");\n    console.log(\"   ‚úÖ Policy 3: 'Users can delete own files' (DELETE)\\n\");\n\n    return;\n  }\n\n  console.log(\"‚úÖ Policies trouv√©es:\\n\");\n  policies.forEach((policy: any) => {\n    console.log(`   - ${policy.policy_name} (${policy.operation})`);\n  });\n\n  console.log(\"\\nüéØ Prochaine √©tape:\");\n  console.log(\"   Testez l'upload depuis l'interface web:\");\n  console.log(\"   1. Connectez-vous √† Dousell Immo\");\n  console.log(\"   2. Allez dans 'Compte' > 'Mes Documents'\");\n  console.log(\"   3. Cliquez sur 'Ajouter un document'\");\n  console.log(\"   4. Uploadez un PDF ou une image (< 5 MB)\");\n  console.log(\"   5. ‚úÖ Le document devrait appara√Ætre dans la liste\\n\");\n}\n\nmain().catch(console.error);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\gatewayService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\homeService.cached.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\homeService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\propertyService.cached.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\propertyService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":163,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":163,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5135,5138],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5135,5138],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":417,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":417,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13719,13722],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13719,13722],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":418,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":418,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13756,13759],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13756,13759],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":419,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":419,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13790,13793],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13790,13793],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":629,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":629,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20361,20364],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20361,20364],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":648,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":648,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21051,21054],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21051,21054],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from \"@/lib/supabase\";\nimport type { Property } from \"@/types/property\";\nimport { slugify } from \"@/lib/slugs\";\n\nexport type PropertyFilters = {\n  q?: string; // Recherche textuelle\n  category?: Property[\"transaction\"];\n  city?: string; // Exact match (DB value)\n  citySlug?: string; // Slugified match (e.g. \"thies-region\")\n  location?: string;\n  minPrice?: number;\n  maxPrice?: number;\n  status?: Property[\"status\"];\n  rooms?: number;\n  bedrooms?: number;\n  hasBackupGenerator?: boolean;\n  hasWaterTank?: boolean;\n  isVerified?: boolean; // Filtrer par biens certifi√©s/v√©rifi√©s\n  type?: Property[\"details\"][\"type\"];\n  types?: Property[\"details\"][\"type\"][]; // Support pour s√©lection multiple\n  limit?: number;\n};\n\ntype SupabasePropertyRow = {\n  id: string;\n  title: string;\n  description: string;\n  price: number;\n  category: Property[\"transaction\"];\n  transaction?: Property[\"transaction\"];\n  status?: Property[\"status\"];\n  location?: {\n    city?: string;\n    address?: string;\n    landmark?: string;\n    coords?: { lat: number; lng: number };\n  };\n  specs?: {\n    surface?: number;\n    rooms?: number;\n    bedrooms?: number;\n    bathrooms?: number;\n  };\n  features?: {\n    hasGenerator?: boolean;\n    hasWaterTank?: boolean;\n    security?: boolean;\n    [key: string]: unknown;\n  };\n  details?: {\n    type?: Property[\"details\"][\"type\"];\n    year?: number;\n    heating?: string;\n    charges?: number;\n    taxeFonciere?: number;\n    parking?: string;\n  };\n  images?: string[];\n  agent?: {\n    name?: string;\n    photo?: string;\n    phone?: string;\n    whatsapp?: string;\n  };\n  service_type?: \"mandat_confort\" | \"boost_visibilite\";\n  contact_phone?: string;\n  view_count?: number;\n  verification_status?: Property[\"verification_status\"];\n  proof_document_url?: string;\n  virtual_tour_url?: string;\n  verification_requested_at?: string;\n  featured?: boolean;\n  exclusive?: boolean;\n  created_at: string;\n\n  owner?: {\n    id: string;\n    full_name: string;\n    avatar_url: string;\n    role?: \"particulier\" | \"agent\" | \"admin\";\n    phone?: string;\n    is_identity_verified?: boolean;\n    updated_at?: string;\n  } | {\n    id: string;\n    full_name: string;\n    avatar_url: string;\n    role?: \"particulier\" | \"agent\" | \"admin\";\n    phone?: string;\n    is_identity_verified?: boolean;\n    updated_at?: string;\n  }[];\n  disponibilite?: string;\n  proximites?: {\n    transports?: string[];\n    ecoles?: string[];\n    commerces?: string[];\n  };\n};\n\nconst mapProperty = (row: SupabasePropertyRow): Property => {\n  const agent = row.agent || {};\n  const features = row.features || {};\n  const details = row.details || {};\n  const specs = row.specs || {};\n  const location = row.location || {};\n  const proximites = row.proximites;\n\n  // G√©rer le cas o√π owner est un tableau (join) ou un objet\n  const ownerData = Array.isArray(row.owner)\n    ? row.owner[0]\n    : (row.owner || (row as Record<string, unknown>).profiles);\n  const owner = (ownerData ?? {}) as Record<string, unknown>;\n\n  // D√©tection intelligente du type si manquant ou trop g√©n√©rique (ex: Appartement par d√©faut)\n  let detectedType = details.type || \"Appartement\";\n  const titleLower = row.title.toLowerCase();\n  const descLower = row.description.toLowerCase();\n\n  const genericTypes = [\"Appartement\", \"Autre\", \"Bien\", \"Propri√©t√©\"];\n  if (!details.type || genericTypes.includes(detectedType)) {\n    if (titleLower.includes(\"terrain\") || descLower.includes(\"terrain\") || titleLower.includes(\"parcelle\")) {\n      detectedType = \"Terrain\";\n    } else if (titleLower.includes(\"villa\") || descLower.includes(\"villa\") || titleLower.includes(\"maison\")) {\n      detectedType = \"Villa\";\n    } else if (titleLower.includes(\"studio\")) {\n      detectedType = \"Studio\";\n    } else if (titleLower.includes(\"duplex\")) {\n      detectedType = \"Duplex\";\n    } else if (titleLower.includes(\"immeuble\")) {\n      detectedType = \"Immeuble\";\n    } else if (titleLower.includes(\"bureau\") || descLower.includes(\"bureau\")) {\n      detectedType = \"Bureau\";\n    } else if (titleLower.includes(\"hangar\") || titleLower.includes(\"entrep√¥t\") || titleLower.includes(\"entrepot\") || descLower.includes(\"hangar\")) {\n      detectedType = \"Entrep√¥t\";\n    } else if (titleLower.includes(\"magasin\") || titleLower.includes(\"boutique\") || titleLower.includes(\"commerce\") || titleLower.includes(\"local commercial\")) {\n      detectedType = \"Local commercial\";\n    } else if (titleLower.includes(\"chambre\") && !titleLower.includes(\"appartement\")) {\n      detectedType = \"Chambre\";\n    }\n  }\n\n  return {\n    id: row.id,\n    title: row.title,\n    description: row.description,\n    price: row.price,\n    transaction: row.transaction || row.category || \"vente\",\n    status: row.status || \"disponible\",\n    location: {\n      city: location.city ?? \"\",\n      address: location.address ?? \"\",\n      landmark: location.landmark ?? \"\",\n      coords: location.coords ?? { lat: 14.6928, lng: -17.4467 },\n    },\n    specs: {\n      surface: specs.surface ?? 0,\n      rooms: specs.rooms ?? 0,\n      bedrooms: specs.bedrooms ?? 0,\n      bathrooms: specs.bathrooms ?? 0,\n    },\n    details: {\n      type: detectedType as any,\n      year: details.year ?? 0,\n      heating: details.heating ?? \"\",\n      charges: details.charges,\n      taxeFonciere: details.taxeFonciere,\n      parking: details.parking,\n      hasBackupGenerator: features.hasGenerator ?? false,\n      hasWaterTank: features.hasWaterTank ?? false,\n      security: features.security ?? false,\n    },\n    images: row.images ?? [],\n    agent: {\n      name: agent.name ?? \"\",\n      photo: agent.photo ?? \"\",\n      phone: agent.phone ?? \"\",\n      whatsapp: agent.whatsapp,\n    },\n    owner: owner && (owner.phone || owner.full_name || owner.id)\n      ? {\n        id: owner.id as string,\n        full_name: owner.full_name as string,\n        avatar_url: owner.avatar_url as string,\n        role: (owner.role as \"particulier\" | \"agent\" | \"admin\") || \"particulier\",\n        phone: owner.phone as string,\n        is_identity_verified: (owner.is_identity_verified as boolean) || false,\n        updated_at: owner.updated_at as string,\n      }\n      : undefined,\n    disponibilite: row.disponibilite ?? \"Imm√©diate\",\n    proximites: proximites && (\n      proximites.transports?.length ||\n      proximites.ecoles?.length ||\n      proximites.commerces?.length\n    ) ? proximites as Property[\"proximites\"] : undefined,\n    contact_phone: row.contact_phone,\n    view_count: row.view_count,\n    verification_status: row.verification_status,\n    proof_document_url: row.proof_document_url,\n    virtual_tour_url: row.virtual_tour_url,\n    verification_requested_at: row.verification_requested_at,\n    featured: row.featured,\n    exclusive: row.exclusive,\n  };\n};\n\nexport const getProperties = async (filters: PropertyFilters = {}) => {\n  try {\n    // Optimisation : ne s√©lectionner que les colonnes n√©cessaires pour la liste\n    // Cela r√©duit significativement le transfert de donn√©es\n    let query = supabase\n      .from(\"properties\")\n      .select(\n        \"id, title, description, price, category, status, location, specs, details, features, images, agent, created_at, validation_status, verification_status, view_count\"\n      );\n\n    // Filtrer uniquement les propri√©t√©s approuv√©es et disponibles\n    // Ces filtres garantissent que seules les annonces valides sont affich√©es\n    query = query.eq(\"validation_status\", \"approved\");\n    query = query.eq(\"status\", \"disponible\");\n\n    // Recherche textuelle (q) : recherche dans le titre, la description et la ville\n    if (filters.q) {\n      // Nettoyage de la recherche\n      let searchTerm = filters.q.trim();\n\n      // Si la recherche contient une virgule (ex: \"Mermoz, Dakar\"), on prend le premier terme\n      // car c'est g√©n√©ralement le plus sp√©cifique (quartier/ville)\n      if (searchTerm.includes(\",\")) {\n        const parts = searchTerm.split(\",\");\n        if (parts.length > 0) {\n          searchTerm = parts[0].trim();\n        }\n      }\n\n      query = query.or(\n        `title.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%,location->>city.ilike.%${searchTerm}%,location->>address.ilike.%${searchTerm}%`\n      );\n    }\n\n    if (filters.category) {\n      query = query.eq(\"category\", filters.category);\n    }\n    if (filters.city) {\n      query = query.eq(\"location->>city\", filters.city);\n    }\n    // Gestion du citySlug : on r√©sout le slug en vrai nom de ville\n    if (filters.citySlug) {\n      const resolvedCity = await getCityNameFromSlug(filters.citySlug);\n      if (resolvedCity) {\n        // Use wildcards for maximum safety against whitespace/hidden chars\n        query = query.ilike(\"location->>city\", `%${resolvedCity}%`);\n      } else {\n        // Fallback approx\n        const fallback = filters.citySlug.replace(/-/g, ' ');\n        query = query.ilike(\"location->>city\", `%${fallback}%`);\n      }\n    }\n    if (filters.minPrice) {\n      query = query.gte(\"price\", filters.minPrice);\n    }\n    if (filters.maxPrice) {\n      query = query.lte(\"price\", filters.maxPrice);\n    }\n    if (filters.status) {\n      query = query.eq(\"status\", filters.status);\n    }\n    if (filters.location) {\n      query = query.ilike(\"location->>city\", `%${filters.location}%`);\n    } else if (filters.city) {\n      query = query.eq(\"location->>city\", filters.city);\n    }\n    if (filters.rooms) {\n      query = query.gte(\"specs->>rooms\", String(filters.rooms));\n    }\n    if (filters.bedrooms) {\n      query = query.gte(\"specs->>bedrooms\", String(filters.bedrooms));\n    }\n    if (filters.hasBackupGenerator) {\n      query = query.eq(\"features->>hasGenerator\", \"true\");\n    }\n    if (filters.hasWaterTank) {\n      query = query.eq(\"features->>hasWaterTank\", \"true\");\n    }\n    if (filters.isVerified) {\n      query = query.eq(\"verification_status\", \"verified\");\n    }\n    // Support pour un seul type ou plusieurs types (OR)\n    // Support pour types multiples\n    // On cherche uniquement dans details->>type avec des jokers pour la souplesse\n    if (filters.types && filters.types.length > 0) {\n      const orConditions = filters.types\n        .flatMap((type) => [\n          `details->>type.ilike.%${type}%`\n        ])\n        .join(\",\");\n      query = query.or(orConditions);\n    } else if (filters.type) {\n      // Chercher dans details.type (case-insensitive)\n      query = query.or(\n        `details->>type.ilike.%${filters.type}%`\n      );\n    }\n\n    query = query.order(\"created_at\", {\n      ascending: false,\n    });\n\n    if (filters.limit) {\n      query = query.limit(filters.limit);\n    }\n\n    const { data, error } = await query;\n    if (error) {\n      console.error(\"getProperties Supabase error:\", {\n        message: error.message,\n        code: error.code,\n        details: error.details,\n        hint: error.hint,\n      });\n      throw error;\n    }\n    return (data ?? []).map(mapProperty);\n  } catch (error) {\n    console.error(\"getProperties error:\", {\n      error,\n      errorMessage: error instanceof Error ? error.message : String(error),\n      errorStack: error instanceof Error ? error.stack : undefined,\n    });\n    return [];\n  }\n};\n\nexport const getPropertiesCount = async (filters: PropertyFilters = {}) => {\n  try {\n    let query = supabase\n      .from(\"properties\")\n      .select(\"*\", { count: \"exact\", head: true });\n\n    // M√™me logique de filtrage que getProperties\n    query = query.eq(\"validation_status\", \"approved\");\n    query = query.eq(\"status\", \"disponible\");\n\n    if (filters.q) {\n      query = query.or(\n        `title.ilike.%${filters.q}%,description.ilike.%${filters.q}%,location->>city.ilike.%${filters.q}%`\n      );\n    }\n\n    if (filters.category) {\n      query = query.eq(\"category\", filters.category);\n    }\n    if (filters.city) {\n      query = query.eq(\"location->>city\", filters.city);\n    }\n    if (filters.citySlug) {\n      const resolvedCity = await getCityNameFromSlug(filters.citySlug);\n      if (resolvedCity) {\n        query = query.ilike(\"location->>city\", `%${resolvedCity}%`);\n      } else {\n        const fallback = filters.citySlug.replace(/-/g, ' ');\n        query = query.ilike(\"location->>city\", `%${fallback}%`);\n      }\n    }\n    if (filters.minPrice) {\n      query = query.gte(\"price\", filters.minPrice);\n    }\n    if (filters.maxPrice) {\n      query = query.lte(\"price\", filters.maxPrice);\n    }\n    if (filters.status) {\n      query = query.eq(\"status\", filters.status);\n    }\n    if (filters.location) {\n      query = query.ilike(\"location->>city\", `%${filters.location}%`);\n    } else if (filters.city) {\n      query = query.eq(\"location->>city\", filters.city);\n    }\n    if (filters.rooms) {\n      query = query.gte(\"specs->>rooms\", String(filters.rooms));\n    }\n    if (filters.bedrooms) {\n      query = query.gte(\"specs->>bedrooms\", String(filters.bedrooms));\n    }\n    if (filters.hasBackupGenerator) {\n      query = query.eq(\"features->>hasGenerator\", \"true\");\n    }\n    if (filters.hasWaterTank) {\n      query = query.eq(\"features->>hasWaterTank\", \"true\");\n    }\n    if (filters.isVerified) {\n      query = query.eq(\"verification_status\", \"verified\");\n    }\n\n    // Support pour types multiples\n    if (filters.types && filters.types.length > 0) {\n      const orConditions = filters.types\n        .flatMap((type) => [\n          `details->>type.ilike.%${type}%`\n        ])\n        .join(\",\");\n      query = query.or(orConditions);\n    } else if (filters.type) {\n      query = query.or(\n        `details->>type.ilike.%${filters.type}%`\n      );\n    }\n\n    const { count, error } = await query;\n    if (error) throw error;\n\n    return count || 0;\n  } catch (error) {\n    console.error(\"getPropertiesCount error details:\", {\n      message: error instanceof Error ? error.message : String(error),\n      details: (error as any)?.details,\n      hint: (error as any)?.hint,\n      code: (error as any)?.code\n    });\n    return 0;\n  }\n};\n\nexport const getPropertyById = async (id: string) => {\n  try {\n    // Pour l'instant, utiliser directement le fallback (requ√™te s√©par√©e)\n    // car la jointure peut ne pas fonctionner si la table profiles n'existe pas encore\n    // ou si la relation n'est pas configur√©e dans Supabase\n    const { data, error } = await supabase\n      .from(\"properties\")\n      .select(\"*\")\n      .eq(\"id\", id)\n      .single();\n\n    if (error) {\n      // Si c'est une erreur 404 (not found), c'est normal\n      if (error.code === \"PGRST116\") {\n        console.warn(\"getPropertyById: Property not found for id:\", id);\n        return null;\n      }\n      throw error;\n    }\n\n    if (!data) {\n      console.warn(\"getPropertyById: No data returned for id:\", id);\n      return null;\n    }\n\n    // Si on a des donn√©es et un owner_id, r√©cup√©rer le profil s√©par√©ment\n    if (data.owner_id) {\n      try {\n        const { data: profileData, error: profileError } = await supabase\n          .from(\"profiles\")\n          .select(\"id, full_name, avatar_url, role, phone, is_identity_verified, updated_at\")\n          .eq(\"id\", data.owner_id)\n          .single();\n\n        if (!profileError && profileData) {\n          data.owner = profileData;\n        } else if (profileError) {\n          // Si la table profiles n'existe pas encore ou le profil n'existe pas, c'est normal\n          // On ne log que les erreurs inattendues (pas les 404 ou \"does not exist\")\n          if (profileError.code !== \"PGRST116\" && !profileError.message?.includes(\"does not exist\")) {\n            // Seulement logger les vraies erreurs (permissions, etc.)\n            console.warn(\"getPropertyById: Erreur lors de la r√©cup√©ration du profil\", {\n              code: profileError.code,\n              message: profileError.message,\n              owner_id: data.owner_id,\n            });\n          }\n          // Sinon, on ignore silencieusement (profil non trouv√© ou table inexistante)\n        }\n      } catch (profileError) {\n        console.warn(\"getPropertyById: Exception lors de la r√©cup√©ration du profil\", profileError);\n      }\n    }\n\n    try {\n      const mappedProperty = mapProperty(data as SupabasePropertyRow);\n\n      return mappedProperty;\n    } catch (mappingError) {\n      console.error(\"getPropertyById mapping error:\", {\n        error: mappingError,\n        data,\n        id,\n        errorMessage: mappingError instanceof Error ? mappingError.message : String(mappingError),\n        errorStack: mappingError instanceof Error ? mappingError.stack : undefined,\n      });\n      return null;\n    }\n  } catch (error) {\n    console.error(\"getPropertyById error:\", {\n      error,\n      errorType: typeof error,\n      errorMessage: error instanceof Error ? error.message : String(error),\n      errorStack: error instanceof Error ? error.stack : undefined,\n      id,\n    });\n    return null;\n  }\n};\n\nexport const getLatestProperties = async (limit = 6) => {\n  try {\n    const { data, error } = await supabase\n      .from(\"properties\")\n      .select(\"id, title, description, price, category, status, location, specs, details, features, images, agent, created_at, validation_status, view_count\")\n      .eq(\"validation_status\", \"approved\")\n      .eq(\"status\", \"disponible\")\n      .order(\"created_at\", { ascending: false })\n      .limit(limit);\n    if (error) throw error;\n    return (data ?? []).map(mapProperty);\n  } catch (error) {\n    console.error(\"getLatestProperties error\", error);\n    return [];\n  }\n};\n\n/**\n * R√©cup√®re les IDs des biens approuv√©s pour la g√©n√©ration statique\n * Utilis√© dans generateStaticParams pour pr√©-g√©n√©rer les pages\n */\nexport const getApprovedPropertyIds = async (limit = 20) => {\n  try {\n    const { data, error } = await supabase\n      .from(\"properties\")\n      .select(\"id\")\n      .eq(\"validation_status\", \"approved\")\n      .neq(\"status\", \"lou√©\")\n      .order(\"created_at\", { ascending: false })\n      .limit(limit);\n    if (error) throw error;\n    return (data ?? []).map((row) => row.id);\n  } catch (error) {\n    console.error(\"getApprovedPropertyIds error\", error);\n    return [];\n  }\n};\n\nexport const getSimilarProperties = async (\n  category: Property[\"transaction\"],\n  city: string,\n  limit = 4,\n  excludeId?: string\n) => {\n  try {\n    let query = supabase\n      .from(\"properties\")\n      .select(\"id, title, description, price, category, status, location, specs, details, features, images, agent, created_at, validation_status, view_count\")\n      .eq(\"validation_status\", \"approved\")\n      .eq(\"status\", \"disponible\")\n      .eq(\"location->>city\", city)\n      .eq(\"category\", category)\n      .order(\"created_at\", { ascending: false })\n      .limit(limit);\n\n    if (excludeId) {\n      query = query.neq(\"id\", excludeId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw error;\n    return (data ?? []).map(mapProperty);\n  } catch (error) {\n    console.error(\"getSimilarProperties error:\", error); // Improved logging\n    return [];\n  }\n};\n\nexport const deleteProperty = async (id: string) => {\n  try {\n    const { error } = await supabase.from(\"properties\").delete().eq(\"id\", id);\n    if (error) throw error;\n    return true;\n  } catch (error) {\n    console.error(\"deleteProperty error\", error);\n    return false;\n  }\n};\n\n/**\n * Incr√©mente le compteur de vues d'une propri√©t√© de mani√®re atomique\n * Utilise la fonction RPC increment_view_count pour garantir la coh√©rence\n * \n * @param id - ID de la propri√©t√©\n * @returns Le nouveau total de vues, ou null en cas d'erreur\n */\nexport const incrementView = async (id: string): Promise<number | null> => {\n  try {\n    const { data, error } = await supabase.rpc(\"increment_view_count\", {\n      property_id_param: id,\n    });\n\n    if (error) {\n      console.error(\"incrementView error:\", error);\n      return null;\n    }\n\n    return data as number;\n  } catch (error) {\n    console.error(\"incrementView unexpected error:\", error);\n    return null;\n  }\n};\n\n/**\n * R√©cup√®re des suggestions de lieux pour l'autocompl√©tion\n * @param query - D√©but du nom de ville ou quartier\n */\nexport const getSearchSuggestions = async (query: string): Promise<string[]> => {\n  if (!query || query.length < 2) return [];\n\n  const searchTerm = query.trim();\n  const suggestions = new Set<string>();\n\n  try {\n    // 1. Chercher dans les propri√©t√©s internes (location->>city)\n    const { data: internalData } = await supabase\n      .from(\"properties\")\n      .select(\"location\")\n      .ilike(\"location->>city\", `%${searchTerm}%`)\n      .limit(10);\n\n    if (internalData) {\n      internalData.forEach((row: any) => {\n        if (row.location?.city) {\n          suggestions.add(row.location.city);\n          // Si le quartier est dispo et matche aussi\n          if (row.location.district && row.location.district.toLowerCase().includes(searchTerm.toLowerCase())) {\n            suggestions.add(`${row.location.district}, ${row.location.city}`);\n          }\n        }\n      });\n    }\n\n    // 2. Chercher dans les annonces externes (city)\n    const { data: externalData } = await supabase\n      .from(\"external_listings\")\n      .select(\"city, location\")\n      .or(`city.ilike.%${searchTerm}%,location.ilike.%${searchTerm}%`)\n      .limit(10);\n\n    if (externalData) {\n      externalData.forEach((row: any) => {\n        if (row.city) suggestions.add(row.city);\n        // Pour les externes, 'location' est souvent le quartier ou l'adresse compl√®te\n        if (row.location) {\n          // On essaie de nettoyer un peu si c'est tr√®s long\n          const cleanLoc = row.location.split(',')[0].trim();\n          if (cleanLoc.length < 40) {\n            suggestions.add(row.location);\n          }\n        }\n      });\n    }\n\n    // Convertir en tableau, trier et limiter\n    return Array.from(suggestions)\n      .filter(s => s.toLowerCase().includes(searchTerm.toLowerCase()))\n      .sort((a, b) => {\n        // Mettre les matches exacts ou qui commencent par le terme en premier\n        const aStarts = a.toLowerCase().startsWith(searchTerm.toLowerCase());\n        const bStarts = b.toLowerCase().startsWith(searchTerm.toLowerCase());\n        if (aStarts && !bStarts) return -1;\n        if (!aStarts && bStarts) return 1;\n        return a.localeCompare(b);\n      })\n      .slice(0, 8);\n\n  } catch (error) {\n    console.error(\"getSearchSuggestions error:\", error);\n    return [];\n  }\n};\n\n/**\n * R√©sout un slug de ville (ex: \"thies-region\") en son vrai nom (ex: \"Thi√®s Region\")\n * Utilise le cache des villes actives via RPC\n */\nexport const getCityNameFromSlug = async (slug: string): Promise<string | null> => {\n  try {\n    // On r√©cup√®re toutes les villes actives\n    // TODO: Mettre en cache cette r√©ponse si possible pour √©viter trop d'appels\n    const { data, error } = await supabase\n      .rpc('get_active_cities_and_types');\n\n    if (error || !data) return null;\n\n    // On cherche la premi√®re ville dont le slug correspond\n    const match = (data as { city: string }[]).find(item => slugify(item.city) === slug);\n\n    return match ? match.city : null;\n  } catch (err) {\n    console.error(\"getCityNameFromSlug error:\", err);\n    return null;\n  }\n};\n\n\n/**\n * R√©cup√®re la liste des villes actives (ayant au moins une annonce approuv√©e)\n * Utilis√© pour le maillage interne (Villes √† proximit√©)\n */\nexport const getActiveCities = async (): Promise<string[]> => {\n  try {\n    // Utilise la RPC existante qui retourne { city, type }\n    const { data, error } = await supabase.rpc('get_active_cities_and_types');\n\n    if (error || !data) return [];\n\n    // Extraction et d√©duplication des villes\n    const citiesSet = new Set<string>();\n    (data as { city: string }[]).forEach(item => {\n      if (item.city) citiesSet.add(item.city);\n    });\n\n    return Array.from(citiesSet).sort();\n  } catch (error) {\n    console.error(\"getActiveCities error:\", error);\n    return [];\n  }\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\rentalService.cached.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\reviewReactionService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\reviewService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\services\\tenantService.cached.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\store\\use-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\store\\use-temporary-permissions-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\supabase\\functions\\cleanup-access-control\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\supabase\\functions\\cleanup-expired-permissions\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1804,1807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1804,1807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Edge Function: Cleanup des permissions temporaires expir√©es\r\n// Ex√©cut√© automatiquement via CRON (toutes les heures)\r\n\r\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\r\n\r\nconst corsHeaders = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Headers\":\r\n    \"authorization, x-client-info, apikey, content-type\",\r\n};\r\n\r\nDeno.serve(async (req) => {\r\n  // Handle CORS preflight requests\r\n  if (req.method === \"OPTIONS\") {\r\n    return new Response(\"ok\", { headers: corsHeaders });\r\n  }\r\n\r\n  try {\r\n    // Cr√©er le client Supabase avec la cl√© service\r\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\r\n    const supabaseServiceKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\r\n\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false,\r\n      },\r\n    });\r\n\r\n    console.log(\"[Cleanup] Starting cleanup job...\");\r\n\r\n    // Appeler la fonction RPC de cleanup\r\n    const { data, error } = await supabase.rpc(\"cleanup_expired_permissions\");\r\n\r\n    if (error) {\r\n      console.error(\"[Cleanup] Error:\", error);\r\n      throw error;\r\n    }\r\n\r\n    const deletedCount = data as number;\r\n    console.log(`[Cleanup] Successfully deleted ${deletedCount} expired permissions`);\r\n\r\n    // Optionnel: Notifier les utilisateurs dont les permissions ont expir√©\r\n    // (Peut √™tre fait via un trigger PostgreSQL ou ici)\r\n\r\n    return new Response(\r\n      JSON.stringify({\r\n        success: true,\r\n        message: `Cleaned up ${deletedCount} expired permission(s)`,\r\n        deletedCount,\r\n        timestamp: new Date().toISOString(),\r\n      }),\r\n      {\r\n        headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n        status: 200,\r\n      }\r\n    );\r\n  } catch (error: any) {\r\n    console.error(\"[Cleanup] Fatal error:\", error);\r\n\r\n    return new Response(\r\n      JSON.stringify({\r\n        success: false,\r\n        error: error.message || \"Internal server error\",\r\n        timestamp: new Date().toISOString(),\r\n      }),\r\n      {\r\n        headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\r\n        status: 500,\r\n      }\r\n    );\r\n  }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\supabase\\functions\\hibp-password-check\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\types\\dom-to-image-more.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\types\\property.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\types\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\types\\team.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\update_invoice_logo.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst logoBase64 = fs.readFileSync('logo.txt', 'utf8').trim();\r\nconst invoicePath = path.join('lib', 'invoice.ts');\r\nlet content = fs.readFileSync(invoicePath, 'utf8');\r\n\r\nconst newCode = `    // --- LOGO INTEGRATION ---\r\n    try {\r\n      // Embed Base64 Logo directly to avoid file path issues in production/serverless\r\n      const logoBase64 = \"${logoBase64}\";\r\n      const logoImageBytes = Buffer.from(logoBase64, 'base64');\r\n      const logoImage = await pdfDoc.embedPng(logoImageBytes);\r\n      const logoDims = logoImage.scale(0.25);\r\n\r\n      page.drawImage(logoImage, {\r\n        x: margin,\r\n        y: height - 80 - logoDims.height,\r\n        width: logoDims.width,\r\n        height: logoDims.height,\r\n      });\r\n      yPosition = height - 100 - logoDims.height;\r\n    } catch (e) {\r\n      console.warn(\"Logo loading failed:\", e);\r\n      \r\n      // Fallback Text\r\n      const goldColor = rgb(251 / 255, 191 / 255, 36 / 255);\r\n      const blackColor = rgb(0, 0, 0);\r\n      page.drawText(\"DOUSSEL\", { x: margin, y: yPosition, size: 28, font: boldFont, color: blackColor });\r\n      const textWidth = boldFont.widthOfTextAtSize(\"DOUSSEL\", 28);\r\n      page.drawText(\"IMMO\", { x: margin + textWidth + 8, y: yPosition, size: 28, font: boldFont, color: goldColor });\r\n      yPosition -= 30;\r\n    }`;\r\n\r\n// Replace the try-catch block for logo loading\r\n// We look for the start of the try block and the end of the catch block\r\nconst startMarker = '// --- LOGO INTEGRATION ---';\r\nconst endMarker = '    // Separator';\r\n\r\nconst startIndex = content.indexOf(startMarker);\r\nconst endIndex = content.indexOf(endMarker);\r\n\r\nif (startIndex !== -1 && endIndex !== -1) {\r\n    const before = content.substring(0, startIndex);\r\n    const after = content.substring(endIndex);\r\n    const finalContent = before + newCode + '\\n\\n' + after;\r\n    fs.writeFileSync(invoicePath, finalContent);\r\n    console.log('Successfully injected logo base64 into lib/invoice.ts');\r\n} else {\r\n    console.error('Could not find markers to replace content');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\utils\\supabase\\admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\utils\\supabase\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\utils\\supabase\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Barry\\Downloads\\Doussel_immo\\utils\\supabase\\server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]