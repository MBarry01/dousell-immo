{
  "name": "Baraka Immo - Auto Receipt Flow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "auto-receipt-flow",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "auto-receipt-flow"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.body.tenantEmail}}",
              "operation": "isNotEmpty"
            },
            {
              "value1": "={{$json.body.amount}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "validate-data",
      "name": "Validate Data",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming webhook data from Baraka Immo\nconst data = $input.first().json.body;\n\n// Format phone for WhatsApp (remove spaces, add country code if needed)\nconst formatPhone = (phone) => {\n  if (!phone) return null;\n  return phone.replace(/\\s/g, '').replace(/^0/, '221');\n};\n\n// Format amount for display\nconst formatAmount = (amount) => {\n  return new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';\n};\n\n// Format period\nconst formatPeriod = (periodMonth) => {\n  if (!periodMonth) return new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });\n  \n  // Si format \"01/2025\" ou \"1/2025\"\n  const parts = periodMonth.split('/');\n  if (parts.length === 2) {\n    const month = parseInt(parts[0]) - 1;\n    const year = parseInt(parts[1]);\n    return new Date(year, month).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });\n  }\n  \n  return periodMonth;\n};\n\nreturn {\n  json: {\n    // DonnÃ©es PropriÃ©taire\n    ownerName: data.ownerName || 'PropriÃ©taire',\n    ownerAddress: data.ownerAddress || '',\n    ownerNinea: data.ownerNinea || '',\n    ownerLogo: data.ownerLogo || null,\n    ownerSignature: data.ownerSignature || null,\n    ownerEmail: data.ownerEmail || '',\n    \n    // DonnÃ©es Locataire\n    tenantName: data.tenantName || '',\n    tenantPhone: data.tenantPhone || '',\n    tenantEmail: data.tenantEmail || '',\n    tenantAddress: data.tenantAddress || '',\n    \n    // DonnÃ©es Paiement\n    amount: Number(data.amount) || 0,\n    formattedAmount: formatAmount(data.amount),\n    \n    // PropriÃ©tÃ©\n    propertyAddress: data.propertyAddress || data.tenantAddress || '',\n    \n    // PÃ©riode\n    periodStart: data.periodStart || '',\n    periodEnd: data.periodEnd || '',\n    periodMonth: data.periodMonth || '',\n    formattedPeriod: formatPeriod(data.periodMonth),\n    \n    // Quittance\n    receiptNumber: data.receiptNumber || `BARAKA-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,\n    receiptImage: data.receiptImage || null,\n    generatedAt: new Date().toISOString(),\n    \n    // WhatsApp formatting\n    whatsappPhone: formatPhone(data.tenantPhone),\n  }\n};"
      },
      "id": "parse-receipt-data",
      "name": "Parse Receipt Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 200]
    },
    {
      "parameters": {
        "jsCode": "// GÃ©nÃ©rer la quittance PDF si pas d'image fournie\nconst data = $input.first().json;\n\nif (data.receiptImage) {\n  // Image dÃ©jÃ  fournie, on la passe telle quelle\n  const base64Data = data.receiptImage.split(',')[1] || data.receiptImage;\n  const buffer = Buffer.from(base64Data, 'base64');\n  \n  return {\n    json: data,\n    binary: {\n      receipt: {\n        data: buffer.toString('base64'),\n        mimeType: 'image/png',\n        fileName: `quittance_${data.receiptNumber}.png`\n      }\n    }\n  };\n}\n\n// Sinon, gÃ©nÃ©rer une quittance simple en HTML/Text\nconst receiptText = `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n         BARAKA IMMO - QUITTANCE DE LOYER\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nPropriÃ©taire: ${data.ownerName}\nAdresse: ${data.ownerAddress}\n${data.ownerNinea ? `NINEA: ${data.ownerNinea}` : ''}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nLocataire: ${data.tenantName}\nAdresse: ${data.tenantAddress}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nPÃ‰RIODE: ${data.formattedPeriod}\nDu ${data.periodStart} au ${data.periodEnd}\n\nMONTANT PAYÃ‰: ${data.formattedAmount}\n\nNÂ° QUITTANCE: ${data.receiptNumber}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâœ… Paiement confirmÃ© et enregistrÃ©\n\nDate d'Ã©mission: ${new Date(data.generatedAt).toLocaleDateString('fr-FR')}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nGÃ©nÃ©rÃ© automatiquement par Baraka Immo\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;\n\nreturn {\n  json: {\n    ...data,\n    receiptText: receiptText\n  }\n};"
      },
      "id": "prepare-receipt",
      "name": "Prepare Receipt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 200]
    },
    {
      "parameters": {
        "operation": "sendEmail",
        "fromEmail": "={{$env.FROM_EMAIL || 'noreply@doussel.immo'}}",
        "toEmail": "={{$json.tenantEmail}}",
        "ccEmail": "={{$json.ownerEmail}}",
        "subject": "=Quittance de loyer - {{$json.formattedPeriod}}",
        "emailType": "html",
        "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { font-family: 'Outfit', Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; }\n    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\n    .header { background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); padding: 30px; text-align: center; }\n    .logo { max-width: 150px; height: auto; margin-bottom: 10px; }\n    .company-name { color: #F4C430; font-size: 28px; font-weight: 700; margin: 0; }\n    .tagline { color: #F4C430; margin: 5px 0; font-size: 14px; }\n    .content { padding: 30px; }\n    .greeting { color: #000; font-size: 18px; margin-bottom: 20px; }\n    .receipt-box { background: #f8f8f8; border-left: 4px solid #F4C430; padding: 20px; margin: 20px 0; border-radius: 8px; }\n    .label { color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }\n    .value { color: #000; font-size: 16px; font-weight: 600; margin-bottom: 15px; }\n    .amount-box { background: linear-gradient(135deg, #F4C430 0%, #E5B020 100%); padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; }\n    .amount-label { color: #000; font-size: 14px; margin-bottom: 5px; }\n    .amount { font-size: 36px; color: #000; font-weight: 700; margin: 0; }\n    .footer { background: #f8f8f8; padding: 20px; text-align: center; font-size: 12px; color: #666; }\n    .ninea { color: #999; font-size: 11px; margin-top: 5px; }\n    .signature-box { margin-top: 30px; text-align: right; }\n    .signature-img { max-width: 150px; height: auto; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      {{#if $json.ownerLogo}}\n      <img src=\"{{$json.ownerLogo}}\" alt=\"Logo\" class=\"logo\" />\n      {{/if}}\n      <h1 class=\"company-name\">{{$json.ownerName}}</h1>\n      <p class=\"tagline\">Gestion Locative Premium</p>\n    </div>\n    \n    <div class=\"content\">\n      <p class=\"greeting\">Bonjour {{$json.tenantName}},</p>\n      \n      <p style=\"color: #333; line-height: 1.6;\">\n        Votre quittance de loyer pour la pÃ©riode de <strong>{{$json.formattedPeriod}}</strong> est disponible.\n      </p>\n      \n      <div class=\"receipt-box\">\n        <div class=\"label\">PÃ©riode de location</div>\n        <div class=\"value\">Du {{$json.periodStart}} au {{$json.periodEnd}}</div>\n        \n        <div class=\"label\">PropriÃ©tÃ©</div>\n        <div class=\"value\">{{$json.propertyAddress}}</div>\n        \n        <div class=\"label\">NÂ° de quittance</div>\n        <div class=\"value\">{{$json.receiptNumber}}</div>\n        \n        <div class=\"label\">Date d'Ã©mission</div>\n        <div class=\"value\">{{new Date($json.generatedAt).toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' })}}</div>\n      </div>\n      \n      <div class=\"amount-box\">\n        <div class=\"amount-label\">MONTANT RÃ‰GLÃ‰</div>\n        <div class=\"amount\">{{$json.formattedAmount}}</div>\n      </div>\n      \n      <p style=\"color: #333; line-height: 1.6; margin-top: 20px;\">\n        âœ… <strong>Paiement confirmÃ©</strong> - Merci pour votre ponctualitÃ© !\n      </p>\n      \n      <p style=\"color: #666; font-size: 14px; margin-top: 30px;\">\n        Conservez prÃ©cieusement cette quittance comme justificatif de paiement.\n      </p>\n      \n      {{#if $json.ownerSignature}}\n      <div class=\"signature-box\">\n        <img src=\"{{$json.ownerSignature}}\" alt=\"Signature\" class=\"signature-img\" />\n        <p style=\"color: #666; font-size: 12px; margin: 5px 0;\">{{$json.ownerName}}</p>\n      </div>\n      {{/if}}\n    </div>\n    \n    <div class=\"footer\">\n      <p style=\"margin: 5px 0;\"><strong>{{$json.ownerName}}</strong></p>\n      {{#if $json.ownerAddress}}\n      <p style=\"margin: 5px 0;\">{{$json.ownerAddress}}</p>\n      {{/if}}\n      {{#if $json.ownerNinea}}\n      <p class=\"ninea\">NINEA: {{$json.ownerNinea}}</p>\n      {{/if}}\n      <p style=\"margin: 15px 0 5px 0;\">GÃ©rÃ© par Baraka Immo - Doussel Immo</p>\n      <p style=\"margin: 5px 0; color: #999;\">Document gÃ©nÃ©rÃ© automatiquement</p>\n    </div>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "send-email",
      "name": "Send Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1050, 200],
      "credentials": {
        "gmailOAuth2": {
          "id": "1",
          "name": "Gmail Account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/{{$env.WHATSAPP_PHONE_ID}}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.WHATSAPP_TOKEN}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{$json.whatsappPhone}}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"ğŸ“‹ *QUITTANCE DE LOYER*\\n\\nğŸ‘¤ Locataire: {{$json.tenantName}}\\nğŸ“… PÃ©riode: {{$json.formattedPeriod}}\\nğŸ  PropriÃ©tÃ©: {{$json.propertyAddress}}\\n\\nğŸ’° *Montant payÃ©: {{$json.formattedAmount}}*\\n\\nğŸ“ NÂ° Quittance: {{$json.receiptNumber}}\\n\\nâœ… Paiement confirmÃ© et enregistrÃ©\\n\\nMerci pour votre ponctualitÃ© !\\n\\n_GÃ©nÃ©rÃ© par Baraka Immo_\"\n  }\n}",
        "options": {}
      },
      "id": "send-whatsapp",
      "name": "Send WhatsApp (Optional)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 400],
      "notes": "Envoi WhatsApp optionnel si numÃ©ro prÃ©sent",
      "disabled": false
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll"
      },
      "id": "merge-results",
      "name": "Merge Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Log success and prepare response\nconst emailResult = $('Send Email').first();\nconst whatsappResult = $('Send WhatsApp (Optional)').first();\n\nconst results = {\n  success: true,\n  message: 'Quittance envoyÃ©e avec succÃ¨s',\n  sentTo: {\n    email: $json.tenantEmail,\n    whatsapp: $json.whatsappPhone || null\n  },\n  receipt: {\n    number: $json.receiptNumber,\n    tenant: $json.tenantName,\n    amount: $json.formattedAmount,\n    period: $json.formattedPeriod,\n    owner: $json.ownerName\n  },\n  timestamp: new Date().toISOString()\n};\n\nreturn { json: results };"
      },
      "id": "log-success",
      "name": "Log Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "webhook-response-success",
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Log error\nconst errorResponse = {\n  success: false,\n  message: 'DonnÃ©es invalides',\n  error: 'L\\'email du locataire et le montant sont requis',\n  timestamp: new Date().toISOString()\n};\n\nreturn { json: errorResponse };"
      },
      "id": "log-error",
      "name": "Log Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {
          "responseCode": 400,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "webhook-response-error",
      "name": "Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [850, 400]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Validate Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Data": {
      "main": [
        [
          {
            "node": "Parse Receipt Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Receipt Data": {
      "main": [
        [
          {
            "node": "Prepare Receipt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Receipt": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send WhatsApp (Optional)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WhatsApp (Optional)": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Results": {
      "main": [
        [
          {
            "node": "Log Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Success": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Error": {
      "main": [
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-12-26T00:00:00.000Z",
  "versionId": "2"
}
